<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Ruby: win32/file.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>win32/file.c</h1><a href="../../d9/d84/win32_2file_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &quot;<a class="code" href="../../de/de6/ruby_2ruby_8h.html">ruby/ruby.h</a>&quot;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/de3/encoding_8h.html">ruby/encoding.h</a>&quot;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;winbase.h&gt;</span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;wchar.h&gt;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;shlwapi.h&gt;</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">#ifndef INVALID_FILE_ATTRIBUTES</span>
<a name="l00008"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#a5c3e148aed786e7d7edf84c4551ebbb5">00008</a> <span class="preprocessor"></span><span class="preprocessor"># define INVALID_FILE_ATTRIBUTES ((DWORD)-1)</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span>
<a name="l00011"></a>00011 <span class="comment">/* cache &apos;encoding name&apos; =&gt; &apos;code page&apos; into a hash */</span>
<a name="l00012"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#a8af7d8e43f5df3c47db11b0ab7f2ec5d">00012</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d9/d84/win32_2file_8c.html#a8af7d8e43f5df3c47db11b0ab7f2ec5d">rb_code_page</a>;
<a name="l00013"></a>00013 
<a name="l00014"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#a5ed81d4b07f09d7c8cdd488df2db4ed6">00014</a> <span class="preprocessor">#define IS_DIR_SEPARATOR_P(c) (c == L&apos;\\&apos; || c == L&apos;/&apos;)</span>
<a name="l00015"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#ac2d6f5703ea5be17a2d850ed8fa118a0">00015</a> <span class="preprocessor"></span><span class="preprocessor">#define IS_DIR_UNC_P(c) (IS_DIR_SEPARATOR_P(c[0]) &amp;&amp; IS_DIR_SEPARATOR_P(c[1]))</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="comment">/* MultiByteToWideChar() doesn&apos;t work with code page 51932 */</span>
<a name="l00018"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#a55cd0323a84206376eaa69b602a6befb">00018</a> <span class="preprocessor">#define INVALID_CODE_PAGE 51932</span>
<a name="l00019"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#ade4153dce88aad3fea1b577fa825cf23">00019</a> <span class="preprocessor"></span><span class="preprocessor">#define PATH_BUFFER_SIZE MAX_PATH * 2</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span>
<a name="l00021"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#aadba67d6b19f26084dc48a0e858501eb">00021</a> <span class="preprocessor">#define insecure_obj_p(obj, level) ((level) &gt;= 4 || ((level) &gt; 0 &amp;&amp; OBJ_TAINTED(obj)))</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span>
<a name="l00023"></a>00023 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00024"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#ac1f747d0a90966e122353d86742af462">00024</a> <a class="code" href="../../d9/d84/win32_2file_8c.html#ac1f747d0a90966e122353d86742af462">replace_wchar</a>(<span class="keywordtype">wchar_t</span> *s, <span class="keywordtype">int</span> find, <span class="keywordtype">int</span> replace)
<a name="l00025"></a>00025 {
<a name="l00026"></a>00026     <span class="keywordflow">while</span> (*s != 0) {
<a name="l00027"></a>00027         <span class="keywordflow">if</span> (*s == find)
<a name="l00028"></a>00028             *s = replace;
<a name="l00029"></a>00029         s++;
<a name="l00030"></a>00030     }
<a name="l00031"></a>00031 }
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="comment">/* Convert str from multibyte char to wchar with specified code page */</span>
<a name="l00034"></a>00034 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00035"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#ad22eef55bdf0e268e6cfc886a399659a">00035</a> <a class="code" href="../../d9/d84/win32_2file_8c.html#ad22eef55bdf0e268e6cfc886a399659a">convert_mb_to_wchar</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, <span class="keywordtype">wchar_t</span> **wstr, <span class="keywordtype">wchar_t</span> **wstr_pos, <span class="keywordtype">size_t</span> *wstr_len, UINT <a class="code" href="../../d9/d84/win32_2file_8c.html#aaaeae59d9853413e46001a6ad1761dbd">code_page</a>)
<a name="l00036"></a>00036 {
<a name="l00037"></a>00037     <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l00038"></a>00038 
<a name="l00039"></a>00039     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str))
<a name="l00040"></a>00040         <span class="keywordflow">return</span>;
<a name="l00041"></a>00041 
<a name="l00042"></a>00042     len = MultiByteToWideChar(code_page, 0, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), -1, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0) + 1;
<a name="l00043"></a>00043     *wstr = (<span class="keywordtype">wchar_t</span> *)<a class="code" href="../../d8/db0/defines_8h.html#a6af5faec3f9662b20ffc9903f923dec0">xmalloc</a>(len * <span class="keyword">sizeof</span>(<span class="keywordtype">wchar_t</span>));
<a name="l00044"></a>00044     <span class="keywordflow">if</span> (wstr_pos)
<a name="l00045"></a>00045         *wstr_pos = *wstr;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047     MultiByteToWideChar(code_page, 0, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), -1, *wstr, len);
<a name="l00048"></a>00048     *wstr_len = len - 2;
<a name="l00049"></a>00049 }
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00052"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#a3ab96d190a6f47b70cf97779ff25fd68">00052</a> <a class="code" href="../../d9/d84/win32_2file_8c.html#a3ab96d190a6f47b70cf97779ff25fd68">convert_wchar_to_mb</a>(<span class="keyword">const</span> <span class="keywordtype">wchar_t</span> *wstr, <span class="keywordtype">char</span> **str, <span class="keywordtype">size_t</span> *str_len, UINT <a class="code" href="../../d9/d84/win32_2file_8c.html#aaaeae59d9853413e46001a6ad1761dbd">code_page</a>)
<a name="l00053"></a>00053 {
<a name="l00054"></a>00054     <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l00055"></a>00055 
<a name="l00056"></a>00056     len = WideCharToMultiByte(code_page, 0, wstr, -1, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00057"></a>00057     *str = (<span class="keywordtype">char</span> *)<a class="code" href="../../d8/db0/defines_8h.html#a6af5faec3f9662b20ffc9903f923dec0">xmalloc</a>(len * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
<a name="l00058"></a>00058     WideCharToMultiByte(code_page, 0, wstr, -1, *str, len, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00059"></a>00059 
<a name="l00060"></a>00060     <span class="comment">/* do not count terminator as part of the string length */</span>
<a name="l00061"></a>00061     *str_len = len - 1;
<a name="l00062"></a>00062 }
<a name="l00063"></a>00063 
<a name="l00064"></a>00064 <span class="comment">/*</span>
<a name="l00065"></a>00065 <span class="comment">  Return user&apos;s home directory using environment variables combinations.</span>
<a name="l00066"></a>00066 <span class="comment">  Memory allocated by this function should be manually freed afterwards.</span>
<a name="l00067"></a>00067 <span class="comment"></span>
<a name="l00068"></a>00068 <span class="comment">  Try:</span>
<a name="l00069"></a>00069 <span class="comment">  HOME, HOMEDRIVE + HOMEPATH and USERPROFILE environment variables</span>
<a name="l00070"></a>00070 <span class="comment">  TODO: Special Folders - Profile and Personal</span>
<a name="l00071"></a>00071 <span class="comment">*/</span>
<a name="l00072"></a>00072 <span class="keyword">static</span> <span class="keywordtype">wchar_t</span> *
<a name="l00073"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#a191dc832ea7ee7b2669bbcd62bfc6963">00073</a> <a class="code" href="../../d9/d84/win32_2file_8c.html#a191dc832ea7ee7b2669bbcd62bfc6963">home_dir</a>(<span class="keywordtype">void</span>)
<a name="l00074"></a>00074 {
<a name="l00075"></a>00075     <span class="keywordtype">wchar_t</span> *buffer = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00076"></a>00076     <span class="keywordtype">size_t</span> buffer_len = 0, <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = 0;
<a name="l00077"></a>00077     <span class="keywordtype">size_t</span> home_env = 0;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079     <span class="comment">/*</span>
<a name="l00080"></a>00080 <span class="comment">      GetEnvironmentVariableW when used with NULL will return the required</span>
<a name="l00081"></a>00081 <span class="comment">      buffer size and its terminating character.</span>
<a name="l00082"></a>00082 <span class="comment">      http://msdn.microsoft.com/en-us/library/windows/desktop/ms683188(v=vs.85).aspx</span>
<a name="l00083"></a>00083 <span class="comment">    */</span>
<a name="l00084"></a>00084 
<a name="l00085"></a>00085     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = GetEnvironmentVariableW(L<span class="stringliteral">&quot;HOME&quot;</span>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0)) {
<a name="l00086"></a>00086         buffer_len = <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l00087"></a>00087         home_env = 1;
<a name="l00088"></a>00088     }
<a name="l00089"></a>00089     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = GetEnvironmentVariableW(L<span class="stringliteral">&quot;HOMEDRIVE&quot;</span>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0)) {
<a name="l00090"></a>00090         buffer_len = <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l00091"></a>00091         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = GetEnvironmentVariableW(L<span class="stringliteral">&quot;HOMEPATH&quot;</span>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0)) {
<a name="l00092"></a>00092             buffer_len += <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l00093"></a>00093             home_env = 2;
<a name="l00094"></a>00094         }
<a name="l00095"></a>00095         <span class="keywordflow">else</span> {
<a name="l00096"></a>00096             buffer_len = 0;
<a name="l00097"></a>00097         }
<a name="l00098"></a>00098     }
<a name="l00099"></a>00099     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = GetEnvironmentVariableW(L<span class="stringliteral">&quot;USERPROFILE&quot;</span>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0)) {
<a name="l00100"></a>00100         buffer_len = <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l00101"></a>00101         home_env = 3;
<a name="l00102"></a>00102     }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104     <span class="comment">/* allocate buffer */</span>
<a name="l00105"></a>00105     <span class="keywordflow">if</span> (home_env)
<a name="l00106"></a>00106         buffer = (<span class="keywordtype">wchar_t</span> *)<a class="code" href="../../d8/db0/defines_8h.html#a6af5faec3f9662b20ffc9903f923dec0">xmalloc</a>(buffer_len * <span class="keyword">sizeof</span>(<span class="keywordtype">wchar_t</span>));
<a name="l00107"></a>00107 
<a name="l00108"></a>00108     <span class="keywordflow">switch</span> (home_env) {
<a name="l00109"></a>00109       <span class="keywordflow">case</span> 1:
<a name="l00110"></a>00110         <span class="comment">/* HOME */</span>
<a name="l00111"></a>00111         GetEnvironmentVariableW(L<span class="stringliteral">&quot;HOME&quot;</span>, buffer, buffer_len);
<a name="l00112"></a>00112         <span class="keywordflow">break</span>;
<a name="l00113"></a>00113       <span class="keywordflow">case</span> 2:
<a name="l00114"></a>00114         <span class="comment">/* HOMEDRIVE + HOMEPATH */</span>
<a name="l00115"></a>00115         <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = GetEnvironmentVariableW(L<span class="stringliteral">&quot;HOMEDRIVE&quot;</span>, buffer, buffer_len);
<a name="l00116"></a>00116         GetEnvironmentVariableW(L<span class="stringliteral">&quot;HOMEPATH&quot;</span>, buffer + <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, buffer_len - <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>);
<a name="l00117"></a>00117         <span class="keywordflow">break</span>;
<a name="l00118"></a>00118       <span class="keywordflow">case</span> 3:
<a name="l00119"></a>00119         <span class="comment">/* USERPROFILE */</span>
<a name="l00120"></a>00120         GetEnvironmentVariableW(L<span class="stringliteral">&quot;USERPROFILE&quot;</span>, buffer, buffer_len);
<a name="l00121"></a>00121         <span class="keywordflow">break</span>;
<a name="l00122"></a>00122       <span class="keywordflow">default</span>:
<a name="l00123"></a>00123         <span class="keywordflow">break</span>;
<a name="l00124"></a>00124     }
<a name="l00125"></a>00125 
<a name="l00126"></a>00126     <span class="keywordflow">if</span> (home_env) {
<a name="l00127"></a>00127         <span class="comment">/* sanitize backslashes with forwardslashes */</span>
<a name="l00128"></a>00128         <a class="code" href="../../d9/d84/win32_2file_8c.html#ac1f747d0a90966e122353d86742af462">replace_wchar</a>(buffer, L<span class="charliteral">&apos;\\&apos;</span>, L<span class="charliteral">&apos;/&apos;</span>);
<a name="l00129"></a>00129 
<a name="l00130"></a>00130         <span class="keywordflow">return</span> buffer;
<a name="l00131"></a>00131     }
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00134"></a>00134 }
<a name="l00135"></a>00135 
<a name="l00136"></a>00136 <span class="comment">/* Remove trailing invalid &apos;:$DATA&apos; of the path. */</span>
<a name="l00137"></a>00137 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">size_t</span>
<a name="l00138"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#ae5e5a84da25cf756fe46b1d4c8ffc967">00138</a> <a class="code" href="../../d9/d84/win32_2file_8c.html#ae5e5a84da25cf756fe46b1d4c8ffc967">remove_invalid_alternative_data</a>(<span class="keywordtype">wchar_t</span> *wfullpath, <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00139"></a>00139 {
<a name="l00140"></a>00140     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">wchar_t</span> prime[] = L<span class="stringliteral">&quot;:$DATA&quot;</span>;
<a name="l00141"></a>00141     <span class="keyword">enum</span> { prime_len = (<span class="keyword">sizeof</span>(prime) / <span class="keyword">sizeof</span>(<span class="keywordtype">wchar_t</span>)) -1 };
<a name="l00142"></a>00142 
<a name="l00143"></a>00143     <span class="keywordflow">if</span> (size &lt;= prime_len || _wcsnicmp(wfullpath + size - prime_len, prime, prime_len) != 0)
<a name="l00144"></a>00144         <span class="keywordflow">return</span> size;
<a name="l00145"></a>00145 
<a name="l00146"></a>00146     <span class="comment">/* alias of stream */</span>
<a name="l00147"></a>00147     <span class="comment">/* get rid of a bug of x64 VC++ */</span>
<a name="l00148"></a>00148     <span class="keywordflow">if</span> (wfullpath[size - (prime_len + 1)] == <span class="charliteral">&apos;:&apos;</span>) {
<a name="l00149"></a>00149         <span class="comment">/* remove trailing &apos;::$DATA&apos; */</span>
<a name="l00150"></a>00150         size -= prime_len + 1; <span class="comment">/* prime */</span>
<a name="l00151"></a>00151         wfullpath[size] = L<span class="charliteral">&apos;\0&apos;</span>;
<a name="l00152"></a>00152     }
<a name="l00153"></a>00153     <span class="keywordflow">else</span> {
<a name="l00154"></a>00154         <span class="comment">/* remove trailing &apos;:$DATA&apos; of paths like &apos;/aa:a:$DATA&apos; */</span>
<a name="l00155"></a>00155         <span class="keywordtype">wchar_t</span> *pos = wfullpath + size - (prime_len + 1);
<a name="l00156"></a>00156         <span class="keywordflow">while</span> (!<a class="code" href="../../d9/d84/win32_2file_8c.html#a5ed81d4b07f09d7c8cdd488df2db4ed6">IS_DIR_SEPARATOR_P</a>(*pos) &amp;&amp; pos != wfullpath) {
<a name="l00157"></a>00157             <span class="keywordflow">if</span> (*pos == L<span class="charliteral">&apos;:&apos;</span>) {
<a name="l00158"></a>00158                 size -= prime_len; <span class="comment">/* alternative */</span>
<a name="l00159"></a>00159                 wfullpath[size] = L<span class="charliteral">&apos;\0&apos;</span>;
<a name="l00160"></a>00160                 <span class="keywordflow">break</span>;
<a name="l00161"></a>00161             }
<a name="l00162"></a>00162             pos--;
<a name="l00163"></a>00163         }
<a name="l00164"></a>00164     }
<a name="l00165"></a>00165     <span class="keywordflow">return</span> size;
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 <span class="comment">/* Return system code page. */</span>
<a name="l00169"></a>00169 <span class="keyword">static</span> <span class="keyword">inline</span> UINT
<a name="l00170"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#aafb072b05d12f1f416683a7c76e2d5b5">00170</a> <a class="code" href="../../d9/d84/win32_2file_8c.html#aafb072b05d12f1f416683a7c76e2d5b5">system_code_page</a>(<span class="keywordtype">void</span>)
<a name="l00171"></a>00171 {
<a name="l00172"></a>00172     <span class="keywordflow">return</span> AreFileApisANSI() ? CP_ACP : CP_OEMCP;
<a name="l00173"></a>00173 }
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="comment">/*</span>
<a name="l00176"></a>00176 <span class="comment">  Return code page number of the encoding.</span>
<a name="l00177"></a>00177 <span class="comment">  Cache code page into a hash for performance since finding the code page in</span>
<a name="l00178"></a>00178 <span class="comment">  Encoding#names is slow.</span>
<a name="l00179"></a>00179 <span class="comment">*/</span>
<a name="l00180"></a>00180 <span class="keyword">static</span> UINT
<a name="l00181"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#aaaeae59d9853413e46001a6ad1761dbd">00181</a> <a class="code" href="../../d9/d84/win32_2file_8c.html#aaaeae59d9853413e46001a6ad1761dbd">code_page</a>(<a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc)
<a name="l00182"></a>00182 {
<a name="l00183"></a>00183     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> code_page_value, name_key;
<a name="l00184"></a>00184     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> encoding, names_ary = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a>, <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>;
<a name="l00185"></a>00185     <span class="keywordtype">char</span> *<a class="code" href="../../d5/db5/encoding_8c.html#aa020a886cff98ea2edead4231ff72973">enc_name</a>;
<a name="l00186"></a>00186     <span class="keyword">struct </span><a class="code" href="../../dd/d63/struct_r_string.html">RString</a> fake_str;
<a name="l00187"></a>00187     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <a class="code" href="../../d5/db5/encoding_8c.html#a036ebb5768c1e2811cbd07f872a735de">names</a>;
<a name="l00188"></a>00188     <span class="keywordtype">long</span> i;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <span class="keywordflow">if</span> (!enc)
<a name="l00191"></a>00191         <span class="keywordflow">return</span> <a class="code" href="../../d9/d84/win32_2file_8c.html#aafb072b05d12f1f416683a7c76e2d5b5">system_code_page</a>();
<a name="l00192"></a>00192 
<a name="l00193"></a>00193     enc_name = (<span class="keywordtype">char</span> *)<a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(enc);
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     fake_str.<a class="code" href="../../dd/d63/struct_r_string.html#a58c778edd529580e7d821d506d4d30d0">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a22a8c2a4bbaae9b68f65c9bb92fd4e39">T_STRING</a>|<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a38c3130e65fdd7e20a3e3cb2d0f54299">RSTRING_NOEMBED</a>;
<a name="l00196"></a>00196     fake_str.<a class="code" href="../../dd/d63/struct_r_string.html#a58c778edd529580e7d821d506d4d30d0">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a31e86dc428e998786b528fef067424a4">klass</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7d36c9c3e9faa34c27eb7f2eb9c874a8">rb_cString</a>;
<a name="l00197"></a>00197     fake_str.<a class="code" href="../../dd/d63/struct_r_string.html#a49bf8805294a5671d53a5cb3876c2915">as</a>.<a class="code" href="../../dd/d63/struct_r_string.html#a826280fdfc96d05037ffa50a1607ebfe">heap</a>.len = <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(enc_name);
<a name="l00198"></a>00198     fake_str.<a class="code" href="../../dd/d63/struct_r_string.html#a49bf8805294a5671d53a5cb3876c2915">as</a>.<a class="code" href="../../dd/d63/struct_r_string.html#a826280fdfc96d05037ffa50a1607ebfe">heap</a>.ptr = enc_name;
<a name="l00199"></a>00199     fake_str.<a class="code" href="../../dd/d63/struct_r_string.html#a49bf8805294a5671d53a5cb3876c2915">as</a>.<a class="code" href="../../dd/d63/struct_r_string.html#a826280fdfc96d05037ffa50a1607ebfe">heap</a>.aux.capa = fake_str.<a class="code" href="../../dd/d63/struct_r_string.html#a49bf8805294a5671d53a5cb3876c2915">as</a>.<a class="code" href="../../dd/d63/struct_r_string.html#a826280fdfc96d05037ffa50a1607ebfe">heap</a>.len;
<a name="l00200"></a>00200     name_key = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;fake_str;
<a name="l00201"></a>00201     <a class="code" href="../../d5/de3/encoding_8h.html#af06e3f35ff3b6d79190eaf397328e7e6">ENCODING_CODERANGE_SET</a>(name_key, <a class="code" href="../../d5/db5/encoding_8c.html#af8bb373eaa8036994c2e16476458d6f4">rb_usascii_encindex</a>(), <a class="code" href="../../d5/de3/encoding_8h.html#a0a0e73a2d98205044e1ad19432502c5b">ENC_CODERANGE_7BIT</a>);
<a name="l00202"></a>00202 
<a name="l00203"></a>00203     code_page_value = <a class="code" href="../../d5/d9d/tcltklib_8c.html#aa6896905f9ab15ac1ea4ce9aec1df54b">rb_hash_lookup</a>(<a class="code" href="../../d9/d84/win32_2file_8c.html#a8af7d8e43f5df3c47db11b0ab7f2ec5d">rb_code_page</a>, name_key);
<a name="l00204"></a>00204     <span class="keywordflow">if</span> (code_page_value != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>)
<a name="l00205"></a>00205         <span class="keywordflow">return</span> (UINT)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9444c431b3cb1184e7523fc572f2c758">FIX2INT</a>(code_page_value);
<a name="l00206"></a>00206 
<a name="l00207"></a>00207     name_key = <a class="code" href="../../db/d2e/intern_8h.html#a99895fce59be905b7c7f0a88bd32fa1f">rb_usascii_str_new2</a>(enc_name);
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     encoding = <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(enc);
<a name="l00210"></a>00210     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(encoding)) {
<a name="l00211"></a>00211         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa50b9d5bc665eb5545f6857c89232161">CONST_ID</a>(names, <span class="stringliteral">&quot;names&quot;</span>);
<a name="l00212"></a>00212         names_ary = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(encoding, names, 0);
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <span class="comment">/* map US-ASCII and ASCII-8bit as code page 20127 (us-ascii) */</span>
<a name="l00216"></a>00216     <span class="keywordflow">if</span> (enc == <a class="code" href="../../d5/db5/encoding_8c.html#a1e215012f16414c044f6a212973c95a8">rb_usascii_encoding</a>() || enc == <a class="code" href="../../d5/db5/encoding_8c.html#a767d777810f0d48add93857b52057262">rb_ascii8bit_encoding</a>()) {
<a name="l00217"></a>00217         UINT <a class="code" href="../../d9/d84/win32_2file_8c.html#aaaeae59d9853413e46001a6ad1761dbd">code_page</a> = 20127;
<a name="l00218"></a>00218         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(<a class="code" href="../../d9/d84/win32_2file_8c.html#a8af7d8e43f5df3c47db11b0ab7f2ec5d">rb_code_page</a>, name_key, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(code_page));
<a name="l00219"></a>00219         <span class="keywordflow">return</span> code_page;
<a name="l00220"></a>00220     }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222     <span class="keywordflow">if</span> (names_ary != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a>) {
<a name="l00223"></a>00223         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(names_ary); i++) {
<a name="l00224"></a>00224             name = <a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(names_ary)[i];
<a name="l00225"></a>00225             <span class="keywordflow">if</span> (strncmp(<span class="stringliteral">&quot;CP&quot;</span>, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(name), 2) == 0) {
<a name="l00226"></a>00226                 <span class="keywordtype">int</span> <a class="code" href="../../d9/d84/win32_2file_8c.html#aaaeae59d9853413e46001a6ad1761dbd">code_page</a> = atoi(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(name) + 2);
<a name="l00227"></a>00227                 <span class="keywordflow">if</span> (code_page != 0) {
<a name="l00228"></a>00228                     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(<a class="code" href="../../d9/d84/win32_2file_8c.html#a8af7d8e43f5df3c47db11b0ab7f2ec5d">rb_code_page</a>, name_key, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(code_page));
<a name="l00229"></a>00229                     <span class="keywordflow">return</span> (UINT)code_page;
<a name="l00230"></a>00230                 }
<a name="l00231"></a>00231             }
<a name="l00232"></a>00232         }
<a name="l00233"></a>00233     }
<a name="l00234"></a>00234 
<a name="l00235"></a>00235     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(<a class="code" href="../../d9/d84/win32_2file_8c.html#a8af7d8e43f5df3c47db11b0ab7f2ec5d">rb_code_page</a>, name_key, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../d9/d84/win32_2file_8c.html#a55cd0323a84206376eaa69b602a6befb">INVALID_CODE_PAGE</a>));
<a name="l00236"></a>00236     <span class="keywordflow">return</span> <a class="code" href="../../d9/d84/win32_2file_8c.html#a55cd0323a84206376eaa69b602a6befb">INVALID_CODE_PAGE</a>;
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00240"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#a585426125f92febf56cc0344005992cd">00240</a> <a class="code" href="../../d9/d84/win32_2file_8c.html#a585426125f92febf56cc0344005992cd">fix_string_encoding</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *encoding)
<a name="l00241"></a>00241 {
<a name="l00242"></a>00242     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d8/d90/nkf_8c.html#a5ea5ac7abf5cce39283e422add1067d5">result</a>, tmp;
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     tmp = <a class="code" href="../../d5/de3/encoding_8h.html#a6707b730597e0e614213beb11670aca2">rb_enc_str_new</a>(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str), encoding);
<a name="l00245"></a>00245     result = <a class="code" href="../../d5/de3/encoding_8h.html#a92c4c79471eb00ba915287505a118401">rb_str_encode</a>(tmp, <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(<a class="code" href="../../d5/db5/encoding_8c.html#a893004271cf8c790ca40c4712261aa8c">rb_utf8_encoding</a>()), 0, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     <span class="keywordflow">return</span> result;
<a name="l00248"></a>00248 }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 <span class="comment">/*</span>
<a name="l00251"></a>00251 <span class="comment">  Replace the last part of the path to long name.</span>
<a name="l00252"></a>00252 <span class="comment">  We try to avoid to call FindFirstFileW() since it takes long time.</span>
<a name="l00253"></a>00253 <span class="comment">*/</span>
<a name="l00254"></a>00254 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">size_t</span>
<a name="l00255"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#a4a1c2f7db40f86a9a255b7d141d2bf33">00255</a> <a class="code" href="../../d9/d84/win32_2file_8c.html#a4a1c2f7db40f86a9a255b7d141d2bf33">replace_to_long_name</a>(<span class="keywordtype">wchar_t</span> **wfullpath, <span class="keywordtype">size_t</span> size, <span class="keywordtype">int</span> <a class="code" href="../../dd/d63/struct_r_string.html#a826280fdfc96d05037ffa50a1607ebfe">heap</a>)
<a name="l00256"></a>00256 {
<a name="l00257"></a>00257     WIN32_FIND_DATAW find_data;
<a name="l00258"></a>00258     HANDLE find_handle;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     <span class="comment">/*</span>
<a name="l00261"></a>00261 <span class="comment">      Skip long name conversion if the path is already long name.</span>
<a name="l00262"></a>00262 <span class="comment">      Short name is 8.3 format.</span>
<a name="l00263"></a>00263 <span class="comment">      http://en.wikipedia.org/wiki/8.3_filename</span>
<a name="l00264"></a>00264 <span class="comment">      This check can be skipped for directory components that have file</span>
<a name="l00265"></a>00265 <span class="comment">      extensions longer than 3 characters, or total lengths longer than</span>
<a name="l00266"></a>00266 <span class="comment">      12 characters.</span>
<a name="l00267"></a>00267 <span class="comment">      http://msdn.microsoft.com/en-us/library/windows/desktop/aa364980(v=vs.85).aspx</span>
<a name="l00268"></a>00268 <span class="comment">    */</span>
<a name="l00269"></a>00269     <span class="keywordtype">size_t</span> <span class="keyword">const</span> max_short_name_size = 8 + 1 + 3;
<a name="l00270"></a>00270     <span class="keywordtype">size_t</span> <span class="keyword">const</span> max_extension_size = 3;
<a name="l00271"></a>00271     <span class="keywordtype">size_t</span> path_len = 1, extension_len = 0;
<a name="l00272"></a>00272     <span class="keywordtype">wchar_t</span> *pos = *wfullpath;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="keywordflow">if</span> (size == 3 &amp;&amp; pos[1] == L<span class="charliteral">&apos;:&apos;</span> &amp;&amp; pos[2] == L<span class="charliteral">&apos;\\&apos;</span> &amp;&amp; pos[3] == L<span class="charliteral">&apos;\0&apos;</span>) {
<a name="l00275"></a>00275         <span class="comment">/* root path doesn&apos;t need short name expansion */</span>
<a name="l00276"></a>00276         <span class="keywordflow">return</span> size;
<a name="l00277"></a>00277     }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279     pos = *wfullpath + size - 1;
<a name="l00280"></a>00280     <span class="keywordflow">while</span> (!<a class="code" href="../../d9/d84/win32_2file_8c.html#a5ed81d4b07f09d7c8cdd488df2db4ed6">IS_DIR_SEPARATOR_P</a>(*pos) &amp;&amp; pos != *wfullpath) {
<a name="l00281"></a>00281         <span class="keywordflow">if</span> (!extension_len &amp;&amp; *pos == L<span class="charliteral">&apos;.&apos;</span>) {
<a name="l00282"></a>00282             extension_len = path_len - 1;
<a name="l00283"></a>00283         }
<a name="l00284"></a>00284         <span class="keywordflow">if</span> (path_len &gt; max_short_name_size || extension_len &gt; max_extension_size) {
<a name="l00285"></a>00285             <span class="keywordflow">return</span> size;
<a name="l00286"></a>00286         }
<a name="l00287"></a>00287         path_len++;
<a name="l00288"></a>00288         pos--;
<a name="l00289"></a>00289     }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291     find_handle = FindFirstFileW(*wfullpath, &amp;find_data);
<a name="l00292"></a>00292     <span class="keywordflow">if</span> (find_handle != INVALID_HANDLE_VALUE) {
<a name="l00293"></a>00293         <span class="keywordtype">size_t</span> trail_pos = wcslen(*wfullpath);
<a name="l00294"></a>00294         <span class="keywordtype">size_t</span> file_len = wcslen(find_data.cFileName);
<a name="l00295"></a>00295 
<a name="l00296"></a>00296         FindClose(find_handle);
<a name="l00297"></a>00297         <span class="keywordflow">while</span> (trail_pos &gt; 0) {
<a name="l00298"></a>00298             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d84/win32_2file_8c.html#a5ed81d4b07f09d7c8cdd488df2db4ed6">IS_DIR_SEPARATOR_P</a>((*wfullpath)[trail_pos]))
<a name="l00299"></a>00299                 <span class="keywordflow">break</span>;
<a name="l00300"></a>00300             trail_pos--;
<a name="l00301"></a>00301         }
<a name="l00302"></a>00302         size = trail_pos + 1 + file_len;
<a name="l00303"></a>00303         <span class="keywordflow">if</span> ((size + 1) &gt; <span class="keyword">sizeof</span>(*wfullpath) / <span class="keyword">sizeof</span>((*wfullpath)[0])) {
<a name="l00304"></a>00304             <span class="keywordtype">wchar_t</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a> = (<span class="keywordtype">wchar_t</span> *)<a class="code" href="../../d8/db0/defines_8h.html#a6af5faec3f9662b20ffc9903f923dec0">xmalloc</a>((size + 1) * <span class="keyword">sizeof</span>(wchar_t));
<a name="l00305"></a>00305             wcsncpy(buf, *wfullpath, trail_pos + 1);
<a name="l00306"></a>00306             <span class="keywordflow">if</span> (heap)
<a name="l00307"></a>00307                 <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(*wfullpath);
<a name="l00308"></a>00308             *wfullpath = buf;
<a name="l00309"></a>00309         }
<a name="l00310"></a>00310         wcsncpy(*wfullpath + trail_pos + 1, find_data.cFileName, file_len + 1);
<a name="l00311"></a>00311     }
<a name="l00312"></a>00312     <span class="keywordflow">return</span> size;
<a name="l00313"></a>00313 }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00316"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#adaf377dd263ab3d84a0ee80f45a77571">00316</a> <a class="code" href="../../d6/d13/file_8c.html#adaf377dd263ab3d84a0ee80f45a77571">rb_file_expand_path_internal</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> fname, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> dname, <span class="keywordtype">int</span> abs_mode, <span class="keywordtype">int</span> long_name, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d8/d90/nkf_8c.html#a5ea5ac7abf5cce39283e422add1067d5">result</a>)
<a name="l00317"></a>00317 {
<a name="l00318"></a>00318     <span class="keywordtype">size_t</span> size = 0, wpath_len = 0, wdir_len = 0, whome_len = 0;
<a name="l00319"></a>00319     <span class="keywordtype">size_t</span> buffer_len = 0;
<a name="l00320"></a>00320     <span class="keywordtype">char</span> *fullpath = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00321"></a>00321     <span class="keywordtype">wchar_t</span> *wfullpath = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *wpath = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *wpath_pos = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *wdir = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00322"></a>00322     <span class="keywordtype">wchar_t</span> *whome = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *buffer = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *buffer_pos = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00323"></a>00323     UINT path_cp, cp;
<a name="l00324"></a>00324     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> path = fname, dir = dname;
<a name="l00325"></a>00325     <span class="keywordtype">wchar_t</span> wfullpath_buffer[<a class="code" href="../../d9/d84/win32_2file_8c.html#ade4153dce88aad3fea1b577fa825cf23">PATH_BUFFER_SIZE</a>];
<a name="l00326"></a>00326     <span class="keywordtype">wchar_t</span> path_drive = L<span class="charliteral">&apos;\0&apos;</span>, dir_drive = L<span class="charliteral">&apos;\0&apos;</span>;
<a name="l00327"></a>00327     <span class="keywordtype">int</span> ignore_dir = 0;
<a name="l00328"></a>00328     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *path_encoding;
<a name="l00329"></a>00329     <span class="keywordtype">int</span> tainted = 0;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <span class="comment">/* tainted if path is tainted */</span>
<a name="l00332"></a>00332     tainted = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a621bc62b1fd82640c1078daf90e1c061">OBJ_TAINTED</a>(path);
<a name="l00333"></a>00333 
<a name="l00334"></a>00334     <span class="comment">/* get path encoding */</span>
<a name="l00335"></a>00335     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(dir)) {
<a name="l00336"></a>00336         path_encoding = <a class="code" href="../../d5/db5/encoding_8c.html#ac21ed764f3b39453b6a848dd64a19585">rb_enc_get</a>(path);
<a name="l00337"></a>00337     }
<a name="l00338"></a>00338     <span class="keywordflow">else</span> {
<a name="l00339"></a>00339         path_encoding = <a class="code" href="../../d5/db5/encoding_8c.html#a7d17d602fae27de649f9310511c03db0">rb_enc_check</a>(path, dir);
<a name="l00340"></a>00340     }
<a name="l00341"></a>00341 
<a name="l00342"></a>00342     cp = path_cp = <a class="code" href="../../d9/d84/win32_2file_8c.html#aaaeae59d9853413e46001a6ad1761dbd">code_page</a>(path_encoding);
<a name="l00343"></a>00343 
<a name="l00344"></a>00344     <span class="comment">/* workaround invalid codepage */</span>
<a name="l00345"></a>00345     <span class="keywordflow">if</span> (path_cp == <a class="code" href="../../d9/d84/win32_2file_8c.html#a55cd0323a84206376eaa69b602a6befb">INVALID_CODE_PAGE</a>) {
<a name="l00346"></a>00346         cp = CP_UTF8;
<a name="l00347"></a>00347         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(path)) {
<a name="l00348"></a>00348             path = <a class="code" href="../../d9/d84/win32_2file_8c.html#a585426125f92febf56cc0344005992cd">fix_string_encoding</a>(path, path_encoding);
<a name="l00349"></a>00349         }
<a name="l00350"></a>00350     }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     <span class="comment">/* convert char * to wchar_t */</span>
<a name="l00353"></a>00353     <a class="code" href="../../d9/d84/win32_2file_8c.html#ad22eef55bdf0e268e6cfc886a399659a">convert_mb_to_wchar</a>(path, &amp;wpath, &amp;wpath_pos, &amp;wpath_len, cp);
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     <span class="comment">/* determine if we need the user&apos;s home directory */</span>
<a name="l00356"></a>00356     <span class="comment">/* expand &apos;~&apos; only if NOT rb_file_absolute_path() where `abs_mode` is 1 */</span>
<a name="l00357"></a>00357     <span class="keywordflow">if</span> (abs_mode == 0 &amp;&amp; wpath_len &gt; 0 &amp;&amp; wpath_pos[0] == L<span class="charliteral">&apos;~&apos;</span> &amp;&amp;
<a name="l00358"></a>00358         (wpath_len == 1 || <a class="code" href="../../d9/d84/win32_2file_8c.html#a5ed81d4b07f09d7c8cdd488df2db4ed6">IS_DIR_SEPARATOR_P</a>(wpath_pos[1]))) {
<a name="l00359"></a>00359         <span class="comment">/* tainted if expanding &apos;~&apos; */</span>
<a name="l00360"></a>00360         tainted = 1;
<a name="l00361"></a>00361 
<a name="l00362"></a>00362         whome = <a class="code" href="../../d9/d84/win32_2file_8c.html#a191dc832ea7ee7b2669bbcd62bfc6963">home_dir</a>();
<a name="l00363"></a>00363         <span class="keywordflow">if</span> (whome == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00364"></a>00364             <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(wpath);
<a name="l00365"></a>00365             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;couldn&apos;t find HOME environment -- expanding `~&apos;&quot;</span>);
<a name="l00366"></a>00366         }
<a name="l00367"></a>00367         whome_len = wcslen(whome);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369         <span class="keywordflow">if</span> (PathIsRelativeW(whome) &amp;&amp; !(whome_len &gt;= 2 &amp;&amp; <a class="code" href="../../d9/d84/win32_2file_8c.html#ac2d6f5703ea5be17a2d850ed8fa118a0">IS_DIR_UNC_P</a>(whome))) {
<a name="l00370"></a>00370             <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(wpath);
<a name="l00371"></a>00371             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;non-absolute home&quot;</span>);
<a name="l00372"></a>00372         }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374         <span class="comment">/* use filesystem encoding if expanding home dir */</span>
<a name="l00375"></a>00375         path_encoding = <a class="code" href="../../d5/db5/encoding_8c.html#af99b5328ff8c5511cbccd48fc0fe82bc">rb_filesystem_encoding</a>();
<a name="l00376"></a>00376         cp = path_cp = <a class="code" href="../../d9/d84/win32_2file_8c.html#aafb072b05d12f1f416683a7c76e2d5b5">system_code_page</a>();
<a name="l00377"></a>00377 
<a name="l00378"></a>00378         <span class="comment">/* ignores dir since we are expading home */</span>
<a name="l00379"></a>00379         ignore_dir = 1;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381         <span class="comment">/* exclude ~ from the result */</span>
<a name="l00382"></a>00382         wpath_pos++;
<a name="l00383"></a>00383         wpath_len--;
<a name="l00384"></a>00384 
<a name="l00385"></a>00385         <span class="comment">/* exclude separator if present */</span>
<a name="l00386"></a>00386         <span class="keywordflow">if</span> (wpath_len &amp;&amp; <a class="code" href="../../d9/d84/win32_2file_8c.html#a5ed81d4b07f09d7c8cdd488df2db4ed6">IS_DIR_SEPARATOR_P</a>(wpath_pos[0])) {
<a name="l00387"></a>00387             wpath_pos++;
<a name="l00388"></a>00388             wpath_len--;
<a name="l00389"></a>00389         }
<a name="l00390"></a>00390     }
<a name="l00391"></a>00391     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wpath_len &gt;= 2 &amp;&amp; wpath_pos[1] == L<span class="charliteral">&apos;:&apos;</span>) {
<a name="l00392"></a>00392         <span class="keywordflow">if</span> (wpath_len &gt;= 3 &amp;&amp; <a class="code" href="../../d9/d84/win32_2file_8c.html#a5ed81d4b07f09d7c8cdd488df2db4ed6">IS_DIR_SEPARATOR_P</a>(wpath_pos[2])) {
<a name="l00393"></a>00393             <span class="comment">/* ignore dir since path contains a drive letter and a root slash */</span>
<a name="l00394"></a>00394             ignore_dir = 1;
<a name="l00395"></a>00395         }
<a name="l00396"></a>00396         <span class="keywordflow">else</span> {
<a name="l00397"></a>00397             <span class="comment">/* determine if we ignore dir or not later */</span>
<a name="l00398"></a>00398             path_drive = wpath_pos[0];
<a name="l00399"></a>00399         }
<a name="l00400"></a>00400     }
<a name="l00401"></a>00401     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (abs_mode == 0 &amp;&amp; wpath_len &gt;= 2 &amp;&amp; wpath_pos[0] == L<span class="charliteral">&apos;~&apos;</span>) {
<a name="l00402"></a>00402         <span class="keywordtype">wchar_t</span> *wuser = wpath_pos + 1;
<a name="l00403"></a>00403         <span class="keywordtype">wchar_t</span> *pos = wuser;
<a name="l00404"></a>00404         <span class="keywordtype">char</span> *user;
<a name="l00405"></a>00405 
<a name="l00406"></a>00406         <span class="comment">/* tainted if expanding &apos;~&apos; */</span>
<a name="l00407"></a>00407         tainted = 1;
<a name="l00408"></a>00408 
<a name="l00409"></a>00409         <span class="keywordflow">while</span> (!<a class="code" href="../../d9/d84/win32_2file_8c.html#a5ed81d4b07f09d7c8cdd488df2db4ed6">IS_DIR_SEPARATOR_P</a>(*pos) &amp;&amp; *pos != <span class="charliteral">&apos;\0&apos;</span>)
<a name="l00410"></a>00410             pos++;
<a name="l00411"></a>00411 
<a name="l00412"></a>00412         *pos = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00413"></a>00413         <a class="code" href="../../d9/d84/win32_2file_8c.html#a3ab96d190a6f47b70cf97779ff25fd68">convert_wchar_to_mb</a>(wuser, &amp;user, &amp;size, cp);
<a name="l00414"></a>00414 
<a name="l00415"></a>00415         <span class="comment">/* convert to VALUE and set the path encoding */</span>
<a name="l00416"></a>00416         <span class="keywordflow">if</span> (path_cp == <a class="code" href="../../d9/d84/win32_2file_8c.html#a55cd0323a84206376eaa69b602a6befb">INVALID_CODE_PAGE</a>) {
<a name="l00417"></a>00417             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> tmp = <a class="code" href="../../d5/de3/encoding_8h.html#a6707b730597e0e614213beb11670aca2">rb_enc_str_new</a>(user, size, <a class="code" href="../../d5/db5/encoding_8c.html#a893004271cf8c790ca40c4712261aa8c">rb_utf8_encoding</a>());
<a name="l00418"></a>00418             result = <a class="code" href="../../d5/de3/encoding_8h.html#a92c4c79471eb00ba915287505a118401">rb_str_encode</a>(tmp, <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(path_encoding), 0, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l00419"></a>00419             <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(tmp, 0);
<a name="l00420"></a>00420         }
<a name="l00421"></a>00421         <span class="keywordflow">else</span> {
<a name="l00422"></a>00422             result = <a class="code" href="../../d5/de3/encoding_8h.html#a6707b730597e0e614213beb11670aca2">rb_enc_str_new</a>(user, size, path_encoding);
<a name="l00423"></a>00423         }
<a name="l00424"></a>00424 
<a name="l00425"></a>00425         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(wpath);
<a name="l00426"></a>00426         <span class="keywordflow">if</span> (user)
<a name="l00427"></a>00427             <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(user);
<a name="l00428"></a>00428 
<a name="l00429"></a>00429         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;can&apos;t find user %s&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2665a51abbd5b49c15abff3df00fa9db">StringValuePtr</a>(result));
<a name="l00430"></a>00430     }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432     <span class="comment">/* convert dir */</span>
<a name="l00433"></a>00433     <span class="keywordflow">if</span> (!ignore_dir &amp;&amp; !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(dir)) {
<a name="l00434"></a>00434         <span class="comment">/* fix string encoding */</span>
<a name="l00435"></a>00435         <span class="keywordflow">if</span> (path_cp == <a class="code" href="../../d9/d84/win32_2file_8c.html#a55cd0323a84206376eaa69b602a6befb">INVALID_CODE_PAGE</a>) {
<a name="l00436"></a>00436             dir = <a class="code" href="../../d9/d84/win32_2file_8c.html#a585426125f92febf56cc0344005992cd">fix_string_encoding</a>(dir, path_encoding);
<a name="l00437"></a>00437         }
<a name="l00438"></a>00438 
<a name="l00439"></a>00439         <span class="comment">/* convert char * to wchar_t */</span>
<a name="l00440"></a>00440         <a class="code" href="../../d9/d84/win32_2file_8c.html#ad22eef55bdf0e268e6cfc886a399659a">convert_mb_to_wchar</a>(dir, &amp;wdir, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;wdir_len, cp);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442         <span class="keywordflow">if</span> (wdir_len &gt;= 2 &amp;&amp; wdir[1] == L<span class="charliteral">&apos;:&apos;</span>) {
<a name="l00443"></a>00443             dir_drive = wdir[0];
<a name="l00444"></a>00444             <span class="keywordflow">if</span> (wpath_len &amp;&amp; <a class="code" href="../../d9/d84/win32_2file_8c.html#a5ed81d4b07f09d7c8cdd488df2db4ed6">IS_DIR_SEPARATOR_P</a>(wpath_pos[0])) {
<a name="l00445"></a>00445                 wdir_len = 2;
<a name="l00446"></a>00446             }
<a name="l00447"></a>00447         }
<a name="l00448"></a>00448         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wdir_len &gt;= 2 &amp;&amp; <a class="code" href="../../d9/d84/win32_2file_8c.html#ac2d6f5703ea5be17a2d850ed8fa118a0">IS_DIR_UNC_P</a>(wdir)) {
<a name="l00449"></a>00449             <span class="comment">/* UNC path */</span>
<a name="l00450"></a>00450             <span class="keywordflow">if</span> (wpath_len &amp;&amp; <a class="code" href="../../d9/d84/win32_2file_8c.html#a5ed81d4b07f09d7c8cdd488df2db4ed6">IS_DIR_SEPARATOR_P</a>(wpath_pos[0])) {
<a name="l00451"></a>00451                 <span class="comment">/* cut the UNC path tail to &apos;//host/share&apos; */</span>
<a name="l00452"></a>00452                 <span class="keywordtype">size_t</span> separators = 0;
<a name="l00453"></a>00453                 <span class="keywordtype">size_t</span> pos = 2;
<a name="l00454"></a>00454                 <span class="keywordflow">while</span> (pos &lt; wdir_len &amp;&amp; separators &lt; 2) {
<a name="l00455"></a>00455                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d84/win32_2file_8c.html#a5ed81d4b07f09d7c8cdd488df2db4ed6">IS_DIR_SEPARATOR_P</a>(wdir[pos])) {
<a name="l00456"></a>00456                         separators++;
<a name="l00457"></a>00457                     }
<a name="l00458"></a>00458                     pos++;
<a name="l00459"></a>00459                 }
<a name="l00460"></a>00460                 <span class="keywordflow">if</span> (separators == 2)
<a name="l00461"></a>00461                     wdir_len = pos - 1;
<a name="l00462"></a>00462             }
<a name="l00463"></a>00463         }
<a name="l00464"></a>00464     }
<a name="l00465"></a>00465 
<a name="l00466"></a>00466     <span class="comment">/* determine if we ignore dir or not */</span>
<a name="l00467"></a>00467     <span class="keywordflow">if</span> (!ignore_dir &amp;&amp; path_drive &amp;&amp; dir_drive) {
<a name="l00468"></a>00468         <span class="keywordflow">if</span> (towupper(path_drive) == towupper(dir_drive)) {
<a name="l00469"></a>00469             <span class="comment">/* exclude path drive letter to use dir */</span>
<a name="l00470"></a>00470             wpath_pos += 2;
<a name="l00471"></a>00471             wpath_len -= 2;
<a name="l00472"></a>00472         }
<a name="l00473"></a>00473         <span class="keywordflow">else</span> {
<a name="l00474"></a>00474             <span class="comment">/* ignore dir since path drive is different from dir drive */</span>
<a name="l00475"></a>00475             ignore_dir = 1;
<a name="l00476"></a>00476             wdir_len = 0;
<a name="l00477"></a>00477         }
<a name="l00478"></a>00478     }
<a name="l00479"></a>00479 
<a name="l00480"></a>00480     <span class="keywordflow">if</span> (!ignore_dir &amp;&amp; wpath_len &gt;= 2 &amp;&amp; <a class="code" href="../../d9/d84/win32_2file_8c.html#ac2d6f5703ea5be17a2d850ed8fa118a0">IS_DIR_UNC_P</a>(wpath)) {
<a name="l00481"></a>00481         <span class="comment">/* ignore dir since path has UNC root */</span>
<a name="l00482"></a>00482         ignore_dir = 1;
<a name="l00483"></a>00483         wdir_len = 0;
<a name="l00484"></a>00484     }
<a name="l00485"></a>00485     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!ignore_dir &amp;&amp; wpath_len &gt;= 1 &amp;&amp; <a class="code" href="../../d9/d84/win32_2file_8c.html#a5ed81d4b07f09d7c8cdd488df2db4ed6">IS_DIR_SEPARATOR_P</a>(wpath[0]) &amp;&amp;
<a name="l00486"></a>00486              !dir_drive &amp;&amp; !(wdir_len &gt;= 2 &amp;&amp; <a class="code" href="../../d9/d84/win32_2file_8c.html#ac2d6f5703ea5be17a2d850ed8fa118a0">IS_DIR_UNC_P</a>(wdir))) {
<a name="l00487"></a>00487         <span class="comment">/* ignore dir since path has root slash and dir doesn&apos;t have drive or UNC root */</span>
<a name="l00488"></a>00488         ignore_dir = 1;
<a name="l00489"></a>00489         wdir_len = 0;
<a name="l00490"></a>00490     }
<a name="l00491"></a>00491 
<a name="l00492"></a>00492     buffer_len = wpath_len + 1 + wdir_len + 1 + whome_len + 1;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     buffer = buffer_pos = (<span class="keywordtype">wchar_t</span> *)<a class="code" href="../../d8/db0/defines_8h.html#a6af5faec3f9662b20ffc9903f923dec0">xmalloc</a>((buffer_len + 1) * <span class="keyword">sizeof</span>(wchar_t));
<a name="l00495"></a>00495 
<a name="l00496"></a>00496     <span class="comment">/* add home */</span>
<a name="l00497"></a>00497     <span class="keywordflow">if</span> (whome_len) {
<a name="l00498"></a>00498         wcsncpy(buffer_pos, whome, whome_len);
<a name="l00499"></a>00499         buffer_pos += whome_len;
<a name="l00500"></a>00500     }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502     <span class="comment">/* Add separator if required */</span>
<a name="l00503"></a>00503     <span class="keywordflow">if</span> (whome_len &amp;&amp; wcsrchr(L<span class="stringliteral">&quot;\\/:&quot;</span>, buffer_pos[-1]) == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00504"></a>00504         buffer_pos[0] = L<span class="charliteral">&apos;\\&apos;</span>;
<a name="l00505"></a>00505         buffer_pos++;
<a name="l00506"></a>00506     }
<a name="l00507"></a>00507 
<a name="l00508"></a>00508     <span class="keywordflow">if</span> (wdir_len) {
<a name="l00509"></a>00509         <span class="comment">/* tainted if dir is used and dir is tainted */</span>
<a name="l00510"></a>00510         <span class="keywordflow">if</span> (!tainted &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a621bc62b1fd82640c1078daf90e1c061">OBJ_TAINTED</a>(dir))
<a name="l00511"></a>00511             tainted = 1;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513         wcsncpy(buffer_pos, wdir, wdir_len);
<a name="l00514"></a>00514         buffer_pos += wdir_len;
<a name="l00515"></a>00515     }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517     <span class="comment">/* add separator if required */</span>
<a name="l00518"></a>00518     <span class="keywordflow">if</span> (wdir_len &amp;&amp; wcsrchr(L<span class="stringliteral">&quot;\\/:&quot;</span>, buffer_pos[-1]) == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00519"></a>00519         buffer_pos[0] = L<span class="charliteral">&apos;\\&apos;</span>;
<a name="l00520"></a>00520         buffer_pos++;
<a name="l00521"></a>00521     }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     <span class="comment">/* now deal with path */</span>
<a name="l00524"></a>00524     <span class="keywordflow">if</span> (wpath_len) {
<a name="l00525"></a>00525         wcsncpy(buffer_pos, wpath_pos, wpath_len);
<a name="l00526"></a>00526         buffer_pos += wpath_len;
<a name="l00527"></a>00527     }
<a name="l00528"></a>00528 
<a name="l00529"></a>00529     <span class="comment">/* GetFullPathNameW requires at least &quot;.&quot; to determine current directory */</span>
<a name="l00530"></a>00530     <span class="keywordflow">if</span> (wpath_len == 0) {
<a name="l00531"></a>00531         buffer_pos[0] = L<span class="charliteral">&apos;.&apos;</span>;
<a name="l00532"></a>00532         buffer_pos++;
<a name="l00533"></a>00533     }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     <span class="comment">/* Ensure buffer is NULL terminated */</span>
<a name="l00536"></a>00536     buffer_pos[0] = L<span class="charliteral">&apos;\0&apos;</span>;
<a name="l00537"></a>00537 
<a name="l00538"></a>00538     <span class="comment">/* tainted if path is relative */</span>
<a name="l00539"></a>00539     <span class="keywordflow">if</span> (!tainted &amp;&amp; PathIsRelativeW(buffer) &amp;&amp; !(buffer_len &gt;= 2 &amp;&amp; <a class="code" href="../../d9/d84/win32_2file_8c.html#ac2d6f5703ea5be17a2d850ed8fa118a0">IS_DIR_UNC_P</a>(buffer)))
<a name="l00540"></a>00540         tainted = 1;
<a name="l00541"></a>00541 
<a name="l00542"></a>00542     <span class="comment">/* FIXME: Make this more robust */</span>
<a name="l00543"></a>00543     <span class="comment">/* Determine require buffer size */</span>
<a name="l00544"></a>00544     size = GetFullPathNameW(buffer, <a class="code" href="../../d9/d84/win32_2file_8c.html#ade4153dce88aad3fea1b577fa825cf23">PATH_BUFFER_SIZE</a>, wfullpath_buffer, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00545"></a>00545     <span class="keywordflow">if</span> (size &gt; <a class="code" href="../../d9/d84/win32_2file_8c.html#ade4153dce88aad3fea1b577fa825cf23">PATH_BUFFER_SIZE</a>) {
<a name="l00546"></a>00546         <span class="comment">/* allocate more memory than alloted originally by PATH_BUFFER_SIZE */</span>
<a name="l00547"></a>00547         wfullpath = (<span class="keywordtype">wchar_t</span> *)<a class="code" href="../../d8/db0/defines_8h.html#a6af5faec3f9662b20ffc9903f923dec0">xmalloc</a>(size * <span class="keyword">sizeof</span>(<span class="keywordtype">wchar_t</span>));
<a name="l00548"></a>00548         size = GetFullPathNameW(buffer, size, wfullpath, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00549"></a>00549     }
<a name="l00550"></a>00550     <span class="keywordflow">else</span> {
<a name="l00551"></a>00551         wfullpath = wfullpath_buffer;
<a name="l00552"></a>00552     }
<a name="l00553"></a>00553 
<a name="l00554"></a>00554     <span class="comment">/* Remove any trailing slashes */</span>
<a name="l00555"></a>00555     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d84/win32_2file_8c.html#a5ed81d4b07f09d7c8cdd488df2db4ed6">IS_DIR_SEPARATOR_P</a>(wfullpath[size - 1]) &amp;&amp;
<a name="l00556"></a>00556         wfullpath[size - 2] != L<span class="charliteral">&apos;:&apos;</span> &amp;&amp;
<a name="l00557"></a>00557         !(size == 2 &amp;&amp; <a class="code" href="../../d9/d84/win32_2file_8c.html#ac2d6f5703ea5be17a2d850ed8fa118a0">IS_DIR_UNC_P</a>(wfullpath))) {
<a name="l00558"></a>00558         size -= 1;
<a name="l00559"></a>00559         wfullpath[size] = L<span class="charliteral">&apos;\0&apos;</span>;
<a name="l00560"></a>00560     }
<a name="l00561"></a>00561 
<a name="l00562"></a>00562     <span class="comment">/* Remove any trailing dot */</span>
<a name="l00563"></a>00563     <span class="keywordflow">if</span> (wfullpath[size - 1] == L<span class="charliteral">&apos;.&apos;</span>) {
<a name="l00564"></a>00564         size -= 1;
<a name="l00565"></a>00565         wfullpath[size] = L<span class="charliteral">&apos;\0&apos;</span>;
<a name="l00566"></a>00566     }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568     <span class="comment">/* removes trailing invalid &apos;:$DATA&apos; */</span>
<a name="l00569"></a>00569     size = <a class="code" href="../../d9/d84/win32_2file_8c.html#ae5e5a84da25cf756fe46b1d4c8ffc967">remove_invalid_alternative_data</a>(wfullpath, size);
<a name="l00570"></a>00570 
<a name="l00571"></a>00571     <span class="comment">/* Replace the trailing path to long name */</span>
<a name="l00572"></a>00572     <span class="keywordflow">if</span> (long_name)
<a name="l00573"></a>00573         size = <a class="code" href="../../d9/d84/win32_2file_8c.html#a4a1c2f7db40f86a9a255b7d141d2bf33">replace_to_long_name</a>(&amp;wfullpath, size, (wfullpath != wfullpath_buffer));
<a name="l00574"></a>00574 
<a name="l00575"></a>00575     <span class="comment">/* sanitize backslashes with forwardslashes */</span>
<a name="l00576"></a>00576     <a class="code" href="../../d9/d84/win32_2file_8c.html#ac1f747d0a90966e122353d86742af462">replace_wchar</a>(wfullpath, L<span class="charliteral">&apos;\\&apos;</span>, L<span class="charliteral">&apos;/&apos;</span>);
<a name="l00577"></a>00577 
<a name="l00578"></a>00578     <span class="comment">/* convert to char * */</span>
<a name="l00579"></a>00579     size = WideCharToMultiByte(cp, 0, wfullpath, size, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00580"></a>00580     <span class="keywordflow">if</span> (size &gt; (<span class="keywordtype">size_t</span>)<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(result)) {
<a name="l00581"></a>00581         <a class="code" href="../../db/d2e/intern_8h.html#a63a6d05687cf812131dce11743581b9d">rb_str_modify</a>(result);
<a name="l00582"></a>00582         <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(result, size);
<a name="l00583"></a>00583     }
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     WideCharToMultiByte(cp, 0, wfullpath, size, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(result), size, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00586"></a>00586     <a class="code" href="../../d8/d81/ruby__missing_8h.html#a89ed8cb86ca6dd49d2db67adae809057">rb_str_set_len</a>(result, size);
<a name="l00587"></a>00587 
<a name="l00588"></a>00588     <span class="comment">/* convert to VALUE and set the path encoding */</span>
<a name="l00589"></a>00589     <span class="keywordflow">if</span> (path_cp == <a class="code" href="../../d9/d84/win32_2file_8c.html#a55cd0323a84206376eaa69b602a6befb">INVALID_CODE_PAGE</a>) {
<a name="l00590"></a>00590         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> tmp;
<a name="l00591"></a>00591         <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l00592"></a>00592 
<a name="l00593"></a>00593         <a class="code" href="../../d5/db5/encoding_8c.html#a150a6e3ac22ac3be8f8c2ccc74a28e7b">rb_enc_associate</a>(result, <a class="code" href="../../d5/db5/encoding_8c.html#a893004271cf8c790ca40c4712261aa8c">rb_utf8_encoding</a>());
<a name="l00594"></a>00594         <a class="code" href="../../d5/de3/encoding_8h.html#ae0d61803f8b4b76dab41851f686c6a19">ENC_CODERANGE_CLEAR</a>(result);
<a name="l00595"></a>00595         tmp = <a class="code" href="../../d5/de3/encoding_8h.html#a92c4c79471eb00ba915287505a118401">rb_str_encode</a>(result, <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(path_encoding), 0, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l00596"></a>00596         len = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(tmp);
<a name="l00597"></a>00597         <a class="code" href="../../db/d2e/intern_8h.html#a63a6d05687cf812131dce11743581b9d">rb_str_modify</a>(result);
<a name="l00598"></a>00598         <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(result, len);
<a name="l00599"></a>00599         memcpy(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(result), <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(tmp), len);
<a name="l00600"></a>00600         <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(tmp, 0);
<a name="l00601"></a>00601     }
<a name="l00602"></a>00602     <a class="code" href="../../d5/db5/encoding_8c.html#a150a6e3ac22ac3be8f8c2ccc74a28e7b">rb_enc_associate</a>(result, path_encoding);
<a name="l00603"></a>00603     <a class="code" href="../../d5/de3/encoding_8h.html#ae0d61803f8b4b76dab41851f686c6a19">ENC_CODERANGE_CLEAR</a>(result);
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     <span class="comment">/* makes the result object tainted if expanding tainted strings or returning modified path */</span>
<a name="l00606"></a>00606     <span class="keywordflow">if</span> (tainted)
<a name="l00607"></a>00607         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afd75ea0cb81c17e76c73e593d1d8a860">OBJ_TAINT</a>(result);
<a name="l00608"></a>00608 
<a name="l00609"></a>00609     <span class="comment">/* TODO: better cleanup */</span>
<a name="l00610"></a>00610     <span class="keywordflow">if</span> (buffer)
<a name="l00611"></a>00611         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(buffer);
<a name="l00612"></a>00612 
<a name="l00613"></a>00613     <span class="keywordflow">if</span> (wpath)
<a name="l00614"></a>00614         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(wpath);
<a name="l00615"></a>00615 
<a name="l00616"></a>00616     <span class="keywordflow">if</span> (wdir)
<a name="l00617"></a>00617         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(wdir);
<a name="l00618"></a>00618 
<a name="l00619"></a>00619     <span class="keywordflow">if</span> (whome)
<a name="l00620"></a>00620         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(whome);
<a name="l00621"></a>00621 
<a name="l00622"></a>00622     <span class="keywordflow">if</span> (wfullpath &amp;&amp; wfullpath != wfullpath_buffer)
<a name="l00623"></a>00623         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(wfullpath);
<a name="l00624"></a>00624 
<a name="l00625"></a>00625     <span class="keywordflow">if</span> (fullpath)
<a name="l00626"></a>00626         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(fullpath);
<a name="l00627"></a>00627 
<a name="l00628"></a>00628     <span class="keywordflow">return</span> result;
<a name="l00629"></a>00629 }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631 <span class="keywordtype">int</span>
<a name="l00632"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#a51a06fdf0a4a71e29b2a83f3295da88e">00632</a> <a class="code" href="../../d6/d13/file_8c.html#a51a06fdf0a4a71e29b2a83f3295da88e">rb_file_load_ok</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l00633"></a>00633 {
<a name="l00634"></a>00634     <span class="keywordtype">int</span> ret = 1;
<a name="l00635"></a>00635     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> attr = GetFileAttributes(path);
<a name="l00636"></a>00636     <span class="keywordflow">if</span> (attr == <a class="code" href="../../d9/d84/win32_2file_8c.html#a5c3e148aed786e7d7edf84c4551ebbb5">INVALID_FILE_ATTRIBUTES</a> ||
<a name="l00637"></a>00637         attr &amp; FILE_ATTRIBUTE_DIRECTORY) {
<a name="l00638"></a>00638         ret = 0;
<a name="l00639"></a>00639     }
<a name="l00640"></a>00640     <span class="keywordflow">else</span> {
<a name="l00641"></a>00641         HANDLE h = CreateFile(path, GENERIC_READ,
<a name="l00642"></a>00642                               FILE_SHARE_READ | FILE_SHARE_WRITE,
<a name="l00643"></a>00643                               <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00644"></a>00644         <span class="keywordflow">if</span> (h != INVALID_HANDLE_VALUE) {
<a name="l00645"></a>00645             CloseHandle(h);
<a name="l00646"></a>00646         }
<a name="l00647"></a>00647         <span class="keywordflow">else</span> {
<a name="l00648"></a>00648             ret = 0;
<a name="l00649"></a>00649         }
<a name="l00650"></a>00650     }
<a name="l00651"></a>00651     <span class="keywordflow">return</span> ret;
<a name="l00652"></a>00652 }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654 <span class="keywordtype">void</span>
<a name="l00655"></a><a class="code" href="../../d9/d84/win32_2file_8c.html#a0abd30ce064a07870ce7cabeabf6ef79">00655</a> <a class="code" href="../../d9/d84/win32_2file_8c.html#a0abd30ce064a07870ce7cabeabf6ef79">rb_w32_init_file</a>(<span class="keywordtype">void</span>)
<a name="l00656"></a>00656 {
<a name="l00657"></a>00657     <a class="code" href="../../d9/d84/win32_2file_8c.html#a8af7d8e43f5df3c47db11b0ab7f2ec5d">rb_code_page</a> = <a class="code" href="../../d1/d04/hash_8c.html#af1da586524a3a1739fd5b91272037815">rb_hash_new</a>();
<a name="l00658"></a>00658 
<a name="l00659"></a>00659     <span class="comment">/* prevent GC removing rb_code_page */</span>
<a name="l00660"></a>00660     <a class="code" href="../../d8/d16/gc_8c.html#adc7efe8997f04b5c275d7e7aed9169e3">rb_gc_register_mark_object</a>(<a class="code" href="../../d9/d84/win32_2file_8c.html#a8af7d8e43f5df3c47db11b0ab7f2ec5d">rb_code_page</a>);
<a name="l00661"></a>00661 }
<a name="l00662"></a>00662 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Mar 2013 for Ruby by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
