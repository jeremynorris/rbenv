<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Ruby: ext/date/date_strptime.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>ext/date/date_strptime.c</h1><a href="../../d9/df5/date__strptime_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">  date_strptime.c: Coded by Tadayoshi Funaba 2011,2012</span>
<a name="l00003"></a>00003 <span class="comment">*/</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="preprocessor">#include &quot;<a class="code" href="../../d9/d3f/ruby_8h.html">ruby.h</a>&quot;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/de3/encoding_8h.html">ruby/encoding.h</a>&quot;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &quot;<a class="code" href="../../db/db6/re_8h.html">ruby/re.h</a>&quot;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00009"></a>00009 
<a name="l00010"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a72e039f51c35ee4a11f7275224947d15">00010</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d9/df5/date__strptime_8c.html#a72e039f51c35ee4a11f7275224947d15">day_names</a>[] = {
<a name="l00011"></a>00011     <span class="stringliteral">&quot;Sunday&quot;</span>, <span class="stringliteral">&quot;Monday&quot;</span>, <span class="stringliteral">&quot;Tuesday&quot;</span>, <span class="stringliteral">&quot;Wednesday&quot;</span>,
<a name="l00012"></a>00012     <span class="stringliteral">&quot;Thursday&quot;</span>, <span class="stringliteral">&quot;Friday&quot;</span>, <span class="stringliteral">&quot;Saturday&quot;</span>,
<a name="l00013"></a>00013     <span class="stringliteral">&quot;Sun&quot;</span>, <span class="stringliteral">&quot;Mon&quot;</span>, <span class="stringliteral">&quot;Tue&quot;</span>, <span class="stringliteral">&quot;Wed&quot;</span>,
<a name="l00014"></a>00014     <span class="stringliteral">&quot;Thu&quot;</span>, <span class="stringliteral">&quot;Fri&quot;</span>, <span class="stringliteral">&quot;Sat&quot;</span>
<a name="l00015"></a>00015 };
<a name="l00016"></a>00016 
<a name="l00017"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#ac84f37cade9bfd306b66f6425decc7ca">00017</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d9/df5/date__strptime_8c.html#ac84f37cade9bfd306b66f6425decc7ca">month_names</a>[] = {
<a name="l00018"></a>00018     <span class="stringliteral">&quot;January&quot;</span>, <span class="stringliteral">&quot;February&quot;</span>, <span class="stringliteral">&quot;March&quot;</span>, <span class="stringliteral">&quot;April&quot;</span>,
<a name="l00019"></a>00019     <span class="stringliteral">&quot;May&quot;</span>, <span class="stringliteral">&quot;June&quot;</span>, <span class="stringliteral">&quot;July&quot;</span>, <span class="stringliteral">&quot;August&quot;</span>, <span class="stringliteral">&quot;September&quot;</span>,
<a name="l00020"></a>00020     <span class="stringliteral">&quot;October&quot;</span>, <span class="stringliteral">&quot;November&quot;</span>, <span class="stringliteral">&quot;December&quot;</span>,
<a name="l00021"></a>00021     <span class="stringliteral">&quot;Jan&quot;</span>, <span class="stringliteral">&quot;Feb&quot;</span>, <span class="stringliteral">&quot;Mar&quot;</span>, <span class="stringliteral">&quot;Apr&quot;</span>, <span class="stringliteral">&quot;May&quot;</span>, <span class="stringliteral">&quot;Jun&quot;</span>,
<a name="l00022"></a>00022     <span class="stringliteral">&quot;Jul&quot;</span>, <span class="stringliteral">&quot;Aug&quot;</span>, <span class="stringliteral">&quot;Sep&quot;</span>, <span class="stringliteral">&quot;Oct&quot;</span>, <span class="stringliteral">&quot;Nov&quot;</span>, <span class="stringliteral">&quot;Dec&quot;</span>
<a name="l00023"></a>00023 };
<a name="l00024"></a>00024 
<a name="l00025"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a7d07a04b495d2693d3bda4b42d662f0c">00025</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d9/df5/date__strptime_8c.html#a7d07a04b495d2693d3bda4b42d662f0c">merid_names</a>[] = {
<a name="l00026"></a>00026     <span class="stringliteral">&quot;am&quot;</span>, <span class="stringliteral">&quot;pm&quot;</span>,
<a name="l00027"></a>00027     <span class="stringliteral">&quot;a.m.&quot;</span>, <span class="stringliteral">&quot;p.m.&quot;</span>
<a name="l00028"></a>00028 };
<a name="l00029"></a>00029 
<a name="l00030"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#afc413ca749a9424d1c516677d3852545">00030</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d9/df5/date__strptime_8c.html#afc413ca749a9424d1c516677d3852545">extz_pats</a>[] = {
<a name="l00031"></a>00031     <span class="stringliteral">&quot;:z&quot;</span>,
<a name="l00032"></a>00032     <span class="stringliteral">&quot;::z&quot;</span>,
<a name="l00033"></a>00033     <span class="stringliteral">&quot;:::z&quot;</span>
<a name="l00034"></a>00034 };
<a name="l00035"></a>00035 
<a name="l00036"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a1ba34a4add044f9f10c2bcb551131499">00036</a> <span class="preprocessor">#define sizeof_array(o) (sizeof o / sizeof o[0])</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span>
<a name="l00038"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a0933ad9f95913001653394c7c3c3898d">00038</a> <span class="preprocessor">#define f_negate(x) rb_funcall(x, rb_intern(&quot;-</span><span class="stringliteral">@&quot;), 0)</span>
<a name="l00039"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a086db25e0919cc2cb7de8b65206dc0ea">00039</a> <span class="stringliteral">#define f_add(x,y) rb_funcall(x, &apos;+&apos;, 1, y)</span>
<a name="l00040"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a3b89897d45005b5ea77126fe57a4bf6e">00040</a> <span class="stringliteral">#define f_sub(x,y) rb_funcall(x, &apos;-&apos;, 1, y)</span>
<a name="l00041"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a11a8a27c7cc08005050225d0e3c5f88b">00041</a> <span class="stringliteral">#define f_mul(x,y) rb_funcall(x, &apos;*&apos;, 1, y)</span>
<a name="l00042"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a6e041cc22a9c318607a5e63fe5e68ed2">00042</a> <span class="stringliteral">#define f_div(x,y) rb_funcall(x, &apos;/&apos;, 1, y)</span>
<a name="l00043"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a85fe75d5b1762095d90ff972506687c8">00043</a> <span class="stringliteral">#define f_idiv(x,y) rb_funcall(x, rb_intern(&quot;</span>div&quot;), 1, y)
<a name="l00044"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#ad3d10170a0b84d9787810c2550d65b85">00044</a> <span class="preprocessor">#define f_mod(x,y) rb_funcall(x, &apos;%&apos;, 1, y)</span>
<a name="l00045"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#acbc7500ccf2c6b5a11c98dc2866e613f">00045</a> <span class="preprocessor"></span><span class="preprocessor">#define f_expt(x,y) rb_funcall(x, rb_intern(&quot;**&quot;), 1, y)</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>
<a name="l00047"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a80f985ec975e713aa6e2d37a5ef99649">00047</a> <span class="preprocessor">#define f_lt_p(x,y) rb_funcall(x, &apos;&lt;&apos;, 1, y)</span>
<a name="l00048"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a9c2ebf46ad91005aff7c378781326a5d">00048</a> <span class="preprocessor"></span><span class="preprocessor">#define f_gt_p(x,y) rb_funcall(x, &apos;&gt;&apos;, 1, y)</span>
<a name="l00049"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a53a83a3920f85cbb88de32151e5a4bc8">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define f_le_p(x,y) rb_funcall(x, rb_intern(&quot;&lt;=&quot;), 1, y)</span>
<a name="l00050"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a10d2f3dba73d7ce0f67cc8f0042da662">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define f_ge_p(x,y) rb_funcall(x, rb_intern(&quot;&gt;=&quot;), 1, y)</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>
<a name="l00052"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a0996fc7e55084393e7c677926564c2fc">00052</a> <span class="preprocessor">#define f_match(r,s) rb_funcall(r, rb_intern(&quot;match&quot;), 1, s)</span>
<a name="l00053"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a9df3bd9220b3f1213e65126dbac9c30f">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define f_aref(o,i) rb_funcall(o, rb_intern(&quot;[]&quot;), 1, i)</span>
<a name="l00054"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a6878df1692922416ea5c2fc4a53129de">00054</a> <span class="preprocessor"></span><span class="preprocessor">#define f_end(o,i) rb_funcall(o, rb_intern(&quot;end&quot;), 1, i)</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span>
<a name="l00056"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a523763d917fb93f44bdf717ad2654182">00056</a> <span class="preprocessor">#define issign(c) ((c) == &apos;-&apos; || (c) == &apos;+&apos;)</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span>
<a name="l00058"></a>00058 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00059"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a4cfc96577c7646d6a085ab5ea037cfbe">00059</a> <a class="code" href="../../d9/df5/date__strptime_8c.html#a4cfc96577c7646d6a085ab5ea037cfbe">num_pattern_p</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *s)
<a name="l00060"></a>00060 {
<a name="l00061"></a>00061     <span class="keywordflow">if</span> (isdigit(*s))
<a name="l00062"></a>00062         <span class="keywordflow">return</span> 1;
<a name="l00063"></a>00063     <span class="keywordflow">if</span> (*s == <span class="charliteral">&apos;%&apos;</span>) {
<a name="l00064"></a>00064         s++;
<a name="l00065"></a>00065         <span class="keywordflow">if</span> (*s == <span class="charliteral">&apos;E&apos;</span> || *s == <span class="charliteral">&apos;O&apos;</span>)
<a name="l00066"></a>00066             s++;
<a name="l00067"></a>00067         <span class="keywordflow">if</span> (*s &amp;&amp;
<a name="l00068"></a>00068             (<a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(<span class="stringliteral">&quot;CDdeFGgHIjkLlMmNQRrSsTUuVvWwXxYy&quot;</span>, *s) || isdigit(*s)))
<a name="l00069"></a>00069             <span class="keywordflow">return</span> 1;
<a name="l00070"></a>00070     }
<a name="l00071"></a>00071     <span class="keywordflow">return</span> 0;
<a name="l00072"></a>00072 }
<a name="l00073"></a>00073 
<a name="l00074"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#aeb920a925081ebd6f1bc87bb8cc843d6">00074</a> <span class="preprocessor">#define NUM_PATTERN_P() num_pattern_p(&amp;fmt[fi + 1])</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span>
<a name="l00076"></a>00076 <span class="keyword">static</span> <span class="keywordtype">long</span>
<a name="l00077"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a67acad822b54a1621de0261e326b4dde">00077</a> <a class="code" href="../../d9/df5/date__strptime_8c.html#a67acad822b54a1621de0261e326b4dde">read_digits</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *s, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *n, <span class="keywordtype">size_t</span> width)
<a name="l00078"></a>00078 {
<a name="l00079"></a>00079     <span class="keywordtype">size_t</span> l;
<a name="l00080"></a>00080 
<a name="l00081"></a>00081     l = strspn(s, <span class="stringliteral">&quot;0123456789&quot;</span>);
<a name="l00082"></a>00082 
<a name="l00083"></a>00083     <span class="keywordflow">if</span> (l == 0)
<a name="l00084"></a>00084         <span class="keywordflow">return</span> 0;
<a name="l00085"></a>00085 
<a name="l00086"></a>00086     <span class="keywordflow">if</span> (width &lt; l)
<a name="l00087"></a>00087         l = width;
<a name="l00088"></a>00088 
<a name="l00089"></a>00089     <span class="keywordflow">if</span> ((4 * l * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>)) &lt;= (<span class="keyword">sizeof</span>(<span class="keywordtype">long</span>)*<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a308d9dd2c0028ddb184b455bbd7865de">CHAR_BIT</a>)) {
<a name="l00090"></a>00090         <span class="keyword">const</span> <span class="keywordtype">char</span> *os = s;
<a name="l00091"></a>00091         <span class="keywordtype">long</span> v;
<a name="l00092"></a>00092 
<a name="l00093"></a>00093         v = 0;
<a name="l00094"></a>00094         <span class="keywordflow">while</span> ((<span class="keywordtype">size_t</span>)(s - os) &lt; l) {
<a name="l00095"></a>00095             v *= 10;
<a name="l00096"></a>00096             v += *s - <span class="charliteral">&apos;0&apos;</span>;
<a name="l00097"></a>00097             s++;
<a name="l00098"></a>00098         }
<a name="l00099"></a>00099         <span class="keywordflow">if</span> (os == s)
<a name="l00100"></a>00100             <span class="keywordflow">return</span> 0;
<a name="l00101"></a>00101         *n = <a class="code" href="../../dc/d0c/cparse_8c.html#af1afba1194a12547a1e65d92abf03b03">LONG2NUM</a>(v);
<a name="l00102"></a>00102         <span class="keywordflow">return</span> l;
<a name="l00103"></a>00103     }
<a name="l00104"></a>00104     <span class="keywordflow">else</span> {
<a name="l00105"></a>00105         <span class="keywordtype">char</span> *s2 = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1408f4b967485afd869990b67e766ceb">ALLOCA_N</a>(<span class="keywordtype">char</span>, l + 1);
<a name="l00106"></a>00106         memcpy(s2, s, l);
<a name="l00107"></a>00107         s2[l] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00108"></a>00108         *n = <a class="code" href="../../d1/dcc/bignum_8c.html#ad1cd4cd30b4ce5b52538392db6409651">rb_cstr_to_inum</a>(s2, 10, 0);
<a name="l00109"></a>00109         <span class="keywordflow">return</span> l;
<a name="l00110"></a>00110     }
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a77be02878bf6cf796943a0034e7a9780">00113</a> <span class="preprocessor">#define set_hash(k,v) rb_hash_aset(hash, ID2SYM(rb_intern(k)), v)</span>
<a name="l00114"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#aa8d8e349a342c6d3383e033841184190">00114</a> <span class="preprocessor"></span><span class="preprocessor">#define ref_hash(k) rb_hash_aref(hash, ID2SYM(rb_intern(k)))</span>
<a name="l00115"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a81ae375b266bf330c134e7370c449022">00115</a> <span class="preprocessor"></span><span class="preprocessor">#define del_hash(k) rb_hash_delete(hash, ID2SYM(rb_intern(k)))</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span>
<a name="l00117"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">00117</a> <span class="preprocessor">#define fail() \</span>
<a name="l00118"></a>00118 <span class="preprocessor">{ \</span>
<a name="l00119"></a>00119 <span class="preprocessor">    set_hash(&quot;_fail&quot;, Qtrue); \</span>
<a name="l00120"></a>00120 <span class="preprocessor">    return 0; \</span>
<a name="l00121"></a>00121 <span class="preprocessor">}</span>
<a name="l00122"></a>00122 <span class="preprocessor"></span>
<a name="l00123"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a87260ca3d2340e7464d142313384535d">00123</a> <span class="preprocessor">#define fail_p() (!NIL_P(ref_hash(&quot;_fail&quot;)))</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span>
<a name="l00125"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">00125</a> <span class="preprocessor">#define READ_DIGITS(n,w) \</span>
<a name="l00126"></a>00126 <span class="preprocessor">{ \</span>
<a name="l00127"></a>00127 <span class="preprocessor">    size_t l; \</span>
<a name="l00128"></a>00128 <span class="preprocessor">    l = read_digits(&amp;str[si], &amp;n, w); \</span>
<a name="l00129"></a>00129 <span class="preprocessor">    if (l == 0) \</span>
<a name="l00130"></a>00130 <span class="preprocessor">        fail(); \</span>
<a name="l00131"></a>00131 <span class="preprocessor">    si += l; \</span>
<a name="l00132"></a>00132 <span class="preprocessor">}</span>
<a name="l00133"></a>00133 <span class="preprocessor"></span>
<a name="l00134"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#af08ecd10049ca90fc43f028dd11b9e41">00134</a> <span class="preprocessor">#define READ_DIGITS_MAX(n) READ_DIGITS(n, LONG_MAX)</span>
<a name="l00135"></a>00135 <span class="preprocessor"></span>
<a name="l00136"></a>00136 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00137"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#aace2cb3bff93bb9ed29458a3d4d1ad27">00137</a> <a class="code" href="../../d9/df5/date__strptime_8c.html#aace2cb3bff93bb9ed29458a3d4d1ad27">valid_range_p</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v, <span class="keywordtype">int</span> a, <span class="keywordtype">int</span> b)
<a name="l00138"></a>00138 {
<a name="l00139"></a>00139     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#acf2fcf97dcf9c7c35452730eb3e2aeb2">FIXNUM_P</a>(v)) {
<a name="l00140"></a>00140         <span class="keywordtype">int</span> vi = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9444c431b3cb1184e7523fc572f2c758">FIX2INT</a>(v);
<a name="l00141"></a>00141         <span class="keywordflow">return</span> !(vi &lt; a || vi &gt; b);
<a name="l00142"></a>00142     }
<a name="l00143"></a>00143     <span class="keywordflow">return</span> !(<a class="code" href="../../dd/d9f/date__parse_8c.html#a80f985ec975e713aa6e2d37a5ef99649">f_lt_p</a>(v, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(a)) || <a class="code" href="../../dd/d9f/date__parse_8c.html#a9c2ebf46ad91005aff7c378781326a5d">f_gt_p</a>(v, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(b)));
<a name="l00144"></a>00144 }
<a name="l00145"></a>00145 
<a name="l00146"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#a554631207e429ff3f75bc8bacf3806d4">00146</a> <span class="preprocessor">#define recur(fmt) \</span>
<a name="l00147"></a>00147 <span class="preprocessor">{ \</span>
<a name="l00148"></a>00148 <span class="preprocessor">    size_t l; \</span>
<a name="l00149"></a>00149 <span class="preprocessor">    l = date__strptime_internal(&amp;str[si], slen - si, \</span>
<a name="l00150"></a>00150 <span class="preprocessor">                                fmt, sizeof fmt - 1, hash); \</span>
<a name="l00151"></a>00151 <span class="preprocessor">    if (fail_p()) \</span>
<a name="l00152"></a>00152 <span class="preprocessor">        return 0; \</span>
<a name="l00153"></a>00153 <span class="preprocessor">    si += l; \</span>
<a name="l00154"></a>00154 <span class="preprocessor">}</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span>
<a name="l00156"></a>00156 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dd/dc0/date__core_8c.html#ad7f3c5f977a91cf1f49e163cf8caccda">date_zone_to_diff</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>);
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 <span class="keyword">static</span> <span class="keywordtype">size_t</span>
<a name="l00159"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#af7c06364d339f19555fc3b796c124878">00159</a> <a class="code" href="../../d9/df5/date__strptime_8c.html#af7c06364d339f19555fc3b796c124878">date__strptime_internal</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *str, <span class="keywordtype">size_t</span> slen,
<a name="l00160"></a>00160                         <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, <span class="keywordtype">size_t</span> flen, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/deb/lex_8c.html#a5541f85ce416df233cce93949f0eeeca">hash</a>)
<a name="l00161"></a>00161 {
<a name="l00162"></a>00162     <span class="keywordtype">size_t</span> si, fi;
<a name="l00163"></a>00163     <span class="keywordtype">int</span> c;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165     si = fi = 0;
<a name="l00166"></a>00166 
<a name="l00167"></a>00167     <span class="keywordflow">while</span> (fi &lt; flen) {
<a name="l00168"></a>00168 
<a name="l00169"></a>00169         <span class="keywordflow">switch</span> (fmt[fi]) {
<a name="l00170"></a>00170           <span class="keywordflow">case</span> <span class="charliteral">&apos;%&apos;</span>:
<a name="l00171"></a>00171 
<a name="l00172"></a>00172           again:
<a name="l00173"></a>00173             fi++;
<a name="l00174"></a>00174             c = fmt[fi];
<a name="l00175"></a>00175 
<a name="l00176"></a>00176             <span class="keywordflow">switch</span> (c) {
<a name="l00177"></a>00177               <span class="keywordflow">case</span> <span class="charliteral">&apos;E&apos;</span>:
<a name="l00178"></a>00178                 <span class="keywordflow">if</span> (fmt[fi + 1] &amp;&amp; <a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(<span class="stringliteral">&quot;cCxXyY&quot;</span>, fmt[fi + 1]))
<a name="l00179"></a>00179                     <span class="keywordflow">goto</span> again;
<a name="l00180"></a>00180                 fi--;
<a name="l00181"></a>00181                 <span class="keywordflow">goto</span> ordinal;
<a name="l00182"></a>00182               <span class="keywordflow">case</span> <span class="charliteral">&apos;O&apos;</span>:
<a name="l00183"></a>00183                 <span class="keywordflow">if</span> (fmt[fi + 1] &amp;&amp; <a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(<span class="stringliteral">&quot;deHImMSuUVwWy&quot;</span>, fmt[fi + 1]))
<a name="l00184"></a>00184                     <span class="keywordflow">goto</span> again;
<a name="l00185"></a>00185                 fi--;
<a name="l00186"></a>00186                 <span class="keywordflow">goto</span> ordinal;
<a name="l00187"></a>00187               <span class="keywordflow">case</span> <span class="charliteral">&apos;:&apos;</span>:
<a name="l00188"></a>00188                 {
<a name="l00189"></a>00189                     <span class="keywordtype">int</span> i;
<a name="l00190"></a>00190 
<a name="l00191"></a>00191                     <span class="keywordflow">for</span> (i = 0; i &lt; (int)<a class="code" href="../../dd/d9f/date__parse_8c.html#a1ba34a4add044f9f10c2bcb551131499">sizeof_array</a>(<a class="code" href="../../d9/df5/date__strptime_8c.html#afc413ca749a9424d1c516677d3852545">extz_pats</a>); i++)
<a name="l00192"></a>00192                         <span class="keywordflow">if</span> (strncmp(<a class="code" href="../../d9/df5/date__strptime_8c.html#afc413ca749a9424d1c516677d3852545">extz_pats</a>[i], &amp;fmt[fi],
<a name="l00193"></a>00193                                         <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(<a class="code" href="../../d9/df5/date__strptime_8c.html#afc413ca749a9424d1c516677d3852545">extz_pats</a>[i])) == 0) {
<a name="l00194"></a>00194                             fi += i;
<a name="l00195"></a>00195                             <span class="keywordflow">goto</span> again;
<a name="l00196"></a>00196                         }
<a name="l00197"></a>00197                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00198"></a>00198                 }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200               <span class="keywordflow">case</span> <span class="charliteral">&apos;A&apos;</span>:
<a name="l00201"></a>00201               <span class="keywordflow">case</span> <span class="charliteral">&apos;a&apos;</span>:
<a name="l00202"></a>00202                 {
<a name="l00203"></a>00203                     <span class="keywordtype">int</span> i;
<a name="l00204"></a>00204 
<a name="l00205"></a>00205                     <span class="keywordflow">for</span> (i = 0; i &lt; (int)<a class="code" href="../../dd/d9f/date__parse_8c.html#a1ba34a4add044f9f10c2bcb551131499">sizeof_array</a>(<a class="code" href="../../d9/df5/date__strptime_8c.html#a72e039f51c35ee4a11f7275224947d15">day_names</a>); i++) {
<a name="l00206"></a>00206                         <span class="keywordtype">size_t</span> l = <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(<a class="code" href="../../d9/df5/date__strptime_8c.html#a72e039f51c35ee4a11f7275224947d15">day_names</a>[i]);
<a name="l00207"></a>00207                         <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#aba00036f71bb67f8600b239a39cf5ec9">strncasecmp</a>(<a class="code" href="../../d9/df5/date__strptime_8c.html#a72e039f51c35ee4a11f7275224947d15">day_names</a>[i], &amp;str[si], l) == 0) {
<a name="l00208"></a>00208                             si += l;
<a name="l00209"></a>00209                             <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;wday&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(i % 7));
<a name="l00210"></a>00210                             <span class="keywordflow">goto</span> matched;
<a name="l00211"></a>00211                         }
<a name="l00212"></a>00212                     }
<a name="l00213"></a>00213                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00214"></a>00214                 }
<a name="l00215"></a>00215               <span class="keywordflow">case</span> <span class="charliteral">&apos;B&apos;</span>:
<a name="l00216"></a>00216               <span class="keywordflow">case</span> <span class="charliteral">&apos;b&apos;</span>:
<a name="l00217"></a>00217               <span class="keywordflow">case</span> <span class="charliteral">&apos;h&apos;</span>:
<a name="l00218"></a>00218                 {
<a name="l00219"></a>00219                     <span class="keywordtype">int</span> i;
<a name="l00220"></a>00220 
<a name="l00221"></a>00221                     <span class="keywordflow">for</span> (i = 0; i &lt; (int)<a class="code" href="../../dd/d9f/date__parse_8c.html#a1ba34a4add044f9f10c2bcb551131499">sizeof_array</a>(<a class="code" href="../../d9/df5/date__strptime_8c.html#ac84f37cade9bfd306b66f6425decc7ca">month_names</a>); i++) {
<a name="l00222"></a>00222                         <span class="keywordtype">size_t</span> l = <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(<a class="code" href="../../d9/df5/date__strptime_8c.html#ac84f37cade9bfd306b66f6425decc7ca">month_names</a>[i]);
<a name="l00223"></a>00223                         <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#aba00036f71bb67f8600b239a39cf5ec9">strncasecmp</a>(<a class="code" href="../../d9/df5/date__strptime_8c.html#ac84f37cade9bfd306b66f6425decc7ca">month_names</a>[i], &amp;str[si], l) == 0) {
<a name="l00224"></a>00224                             si += l;
<a name="l00225"></a>00225                             <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;mon&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>((i % 12) + 1));
<a name="l00226"></a>00226                             <span class="keywordflow">goto</span> matched;
<a name="l00227"></a>00227                         }
<a name="l00228"></a>00228                     }
<a name="l00229"></a>00229                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00230"></a>00230                 }
<a name="l00231"></a>00231 
<a name="l00232"></a>00232               <span class="keywordflow">case</span> <span class="charliteral">&apos;C&apos;</span>:
<a name="l00233"></a>00233                 {
<a name="l00234"></a>00234                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00235"></a>00235 
<a name="l00236"></a>00236                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/df5/date__strptime_8c.html#aeb920a925081ebd6f1bc87bb8cc843d6">NUM_PATTERN_P</a>())
<a name="l00237"></a>00237                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 2)
<a name="l00238"></a>00238                     <span class="keywordflow">else</span>
<a name="l00239"></a>00239                         <a class="code" href="../../d9/df5/date__strptime_8c.html#af08ecd10049ca90fc43f028dd11b9e41">READ_DIGITS_MAX</a>(n)
<a name="l00240"></a>00240                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;_cent&quot;</span>, n);
<a name="l00241"></a>00241                     <span class="keywordflow">goto</span> matched;
<a name="l00242"></a>00242                 }
<a name="l00243"></a>00243 
<a name="l00244"></a>00244               <span class="keywordflow">case</span> <span class="charliteral">&apos;c&apos;</span>:
<a name="l00245"></a>00245                 <a class="code" href="../../d9/df5/date__strptime_8c.html#a554631207e429ff3f75bc8bacf3806d4">recur</a>(<span class="stringliteral">&quot;%a %b %e %H:%M:%S %Y&quot;</span>);
<a name="l00246"></a>00246                 <span class="keywordflow">goto</span> matched;
<a name="l00247"></a>00247 
<a name="l00248"></a>00248               <span class="keywordflow">case</span> <span class="charliteral">&apos;D&apos;</span>:
<a name="l00249"></a>00249                 <a class="code" href="../../d9/df5/date__strptime_8c.html#a554631207e429ff3f75bc8bacf3806d4">recur</a>(<span class="stringliteral">&quot;%m/%d/%y&quot;</span>);
<a name="l00250"></a>00250                 <span class="keywordflow">goto</span> matched;
<a name="l00251"></a>00251 
<a name="l00252"></a>00252               <span class="keywordflow">case</span> <span class="charliteral">&apos;d&apos;</span>:
<a name="l00253"></a>00253               <span class="keywordflow">case</span> <span class="charliteral">&apos;e&apos;</span>:
<a name="l00254"></a>00254                 {
<a name="l00255"></a>00255                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257                     <span class="keywordflow">if</span> (str[si] == <span class="charliteral">&apos; &apos;</span>) {
<a name="l00258"></a>00258                         si++;
<a name="l00259"></a>00259                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 1);
<a name="l00260"></a>00260                     } <span class="keywordflow">else</span> {
<a name="l00261"></a>00261                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 2);
<a name="l00262"></a>00262                     }
<a name="l00263"></a>00263                     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/df5/date__strptime_8c.html#aace2cb3bff93bb9ed29458a3d4d1ad27">valid_range_p</a>(n, 1, 31))
<a name="l00264"></a>00264                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00265"></a>00265                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;mday&quot;</span>, n);
<a name="l00266"></a>00266                     <span class="keywordflow">goto</span> matched;
<a name="l00267"></a>00267                 }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269               <span class="keywordflow">case</span> <span class="charliteral">&apos;F&apos;</span>:
<a name="l00270"></a>00270                 <a class="code" href="../../d9/df5/date__strptime_8c.html#a554631207e429ff3f75bc8bacf3806d4">recur</a>(<span class="stringliteral">&quot;%Y-%m-%d&quot;</span>);
<a name="l00271"></a>00271                 <span class="keywordflow">goto</span> matched;
<a name="l00272"></a>00272 
<a name="l00273"></a>00273               <span class="keywordflow">case</span> <span class="charliteral">&apos;G&apos;</span>:
<a name="l00274"></a>00274                 {
<a name="l00275"></a>00275                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00276"></a>00276 
<a name="l00277"></a>00277                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/df5/date__strptime_8c.html#aeb920a925081ebd6f1bc87bb8cc843d6">NUM_PATTERN_P</a>())
<a name="l00278"></a>00278                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 4)
<a name="l00279"></a>00279                     <span class="keywordflow">else</span>
<a name="l00280"></a>00280                         <a class="code" href="../../d9/df5/date__strptime_8c.html#af08ecd10049ca90fc43f028dd11b9e41">READ_DIGITS_MAX</a>(n)
<a name="l00281"></a>00281                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;cwyear&quot;</span>, n);
<a name="l00282"></a>00282                     <span class="keywordflow">goto</span> matched;
<a name="l00283"></a>00283                 }
<a name="l00284"></a>00284 
<a name="l00285"></a>00285               <span class="keywordflow">case</span> <span class="charliteral">&apos;g&apos;</span>:
<a name="l00286"></a>00286                 {
<a name="l00287"></a>00287                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00288"></a>00288 
<a name="l00289"></a>00289                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 2);
<a name="l00290"></a>00290                     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/df5/date__strptime_8c.html#aace2cb3bff93bb9ed29458a3d4d1ad27">valid_range_p</a>(n, 0, 99))
<a name="l00291"></a>00291                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00292"></a>00292                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;cwyear&quot;</span>,n);
<a name="l00293"></a>00293                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;_cent&quot;</span>,
<a name="l00294"></a>00294                              <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../dd/d9f/date__parse_8c.html#a10d2f3dba73d7ce0f67cc8f0042da662">f_ge_p</a>(n, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(69)) ? 19 : 20));
<a name="l00295"></a>00295                     <span class="keywordflow">goto</span> matched;
<a name="l00296"></a>00296                 }
<a name="l00297"></a>00297 
<a name="l00298"></a>00298               <span class="keywordflow">case</span> <span class="charliteral">&apos;H&apos;</span>:
<a name="l00299"></a>00299               <span class="keywordflow">case</span> <span class="charliteral">&apos;k&apos;</span>:
<a name="l00300"></a>00300                 {
<a name="l00301"></a>00301                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00302"></a>00302 
<a name="l00303"></a>00303                     <span class="keywordflow">if</span> (str[si] == <span class="charliteral">&apos; &apos;</span>) {
<a name="l00304"></a>00304                         si++;
<a name="l00305"></a>00305                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 1);
<a name="l00306"></a>00306                     } <span class="keywordflow">else</span> {
<a name="l00307"></a>00307                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 2);
<a name="l00308"></a>00308                     }
<a name="l00309"></a>00309                     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/df5/date__strptime_8c.html#aace2cb3bff93bb9ed29458a3d4d1ad27">valid_range_p</a>(n, 0, 24))
<a name="l00310"></a>00310                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00311"></a>00311                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;hour&quot;</span>, n);
<a name="l00312"></a>00312                     <span class="keywordflow">goto</span> matched;
<a name="l00313"></a>00313                 }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315               <span class="keywordflow">case</span> <span class="charliteral">&apos;I&apos;</span>:
<a name="l00316"></a>00316               <span class="keywordflow">case</span> <span class="charliteral">&apos;l&apos;</span>:
<a name="l00317"></a>00317                 {
<a name="l00318"></a>00318                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320                     <span class="keywordflow">if</span> (str[si] == <span class="charliteral">&apos; &apos;</span>) {
<a name="l00321"></a>00321                         si++;
<a name="l00322"></a>00322                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 1);
<a name="l00323"></a>00323                     } <span class="keywordflow">else</span> {
<a name="l00324"></a>00324                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 2);
<a name="l00325"></a>00325                     }
<a name="l00326"></a>00326                     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/df5/date__strptime_8c.html#aace2cb3bff93bb9ed29458a3d4d1ad27">valid_range_p</a>(n, 1, 12))
<a name="l00327"></a>00327                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00328"></a>00328                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;hour&quot;</span>, n);
<a name="l00329"></a>00329                     <span class="keywordflow">goto</span> matched;
<a name="l00330"></a>00330                 }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332               <span class="keywordflow">case</span> <span class="charliteral">&apos;j&apos;</span>:
<a name="l00333"></a>00333                 {
<a name="l00334"></a>00334                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 3);
<a name="l00337"></a>00337                     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/df5/date__strptime_8c.html#aace2cb3bff93bb9ed29458a3d4d1ad27">valid_range_p</a>(n, 1, 366))
<a name="l00338"></a>00338                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00339"></a>00339                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;yday&quot;</span>, n);
<a name="l00340"></a>00340                     <span class="keywordflow">goto</span> matched;
<a name="l00341"></a>00341                 }
<a name="l00342"></a>00342 
<a name="l00343"></a>00343               <span class="keywordflow">case</span> <span class="charliteral">&apos;L&apos;</span>:
<a name="l00344"></a>00344               <span class="keywordflow">case</span> <span class="charliteral">&apos;N&apos;</span>:
<a name="l00345"></a>00345                 {
<a name="l00346"></a>00346                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00347"></a>00347                     <span class="keywordtype">int</span> sign = 1;
<a name="l00348"></a>00348                     <span class="keywordtype">size_t</span> osi;
<a name="l00349"></a>00349 
<a name="l00350"></a>00350                     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d9f/date__parse_8c.html#a523763d917fb93f44bdf717ad2654182">issign</a>(str[si])) {
<a name="l00351"></a>00351                         <span class="keywordflow">if</span> (str[si] == <span class="charliteral">&apos;-&apos;</span>)
<a name="l00352"></a>00352                             sign = -1;
<a name="l00353"></a>00353                         si++;
<a name="l00354"></a>00354                     }
<a name="l00355"></a>00355                     osi = si;
<a name="l00356"></a>00356                     <span class="keywordflow">if</span> (<a class="code" href="../../d9/df5/date__strptime_8c.html#aeb920a925081ebd6f1bc87bb8cc843d6">NUM_PATTERN_P</a>())
<a name="l00357"></a>00357                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, c == <span class="charliteral">&apos;L&apos;</span> ? 3 : 9)
<a name="l00358"></a>00358                     <span class="keywordflow">else</span>
<a name="l00359"></a>00359                         <a class="code" href="../../d9/df5/date__strptime_8c.html#af08ecd10049ca90fc43f028dd11b9e41">READ_DIGITS_MAX</a>(n)
<a name="l00360"></a>00360                     <span class="keywordflow">if</span> (sign == -1)
<a name="l00361"></a>00361                         n = <a class="code" href="../../dd/dc0/date__core_8c.html#a0933ad9f95913001653394c7c3c3898d">f_negate</a>(n);
<a name="l00362"></a>00362                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;sec_fraction&quot;</span>,
<a name="l00363"></a>00363                              <a class="code" href="../../db/d2e/intern_8h.html#ae13ef3f18f6045c33bbf943c11e14ac5">rb_rational_new2</a>(n,
<a name="l00364"></a>00364                                               <a class="code" href="../../dd/dc0/date__core_8c.html#acbc7500ccf2c6b5a11c98dc2866e613f">f_expt</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(10),
<a name="l00365"></a>00365                                                      <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad9f758738ddf6560da578a4425987892">ULONG2NUM</a>(si - osi))));
<a name="l00366"></a>00366                     <span class="keywordflow">goto</span> matched;
<a name="l00367"></a>00367                 }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369               <span class="keywordflow">case</span> <span class="charliteral">&apos;M&apos;</span>:
<a name="l00370"></a>00370                 {
<a name="l00371"></a>00371                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 2);
<a name="l00374"></a>00374                     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/df5/date__strptime_8c.html#aace2cb3bff93bb9ed29458a3d4d1ad27">valid_range_p</a>(n, 0, 59))
<a name="l00375"></a>00375                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00376"></a>00376                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;min&quot;</span>, n);
<a name="l00377"></a>00377                     <span class="keywordflow">goto</span> matched;
<a name="l00378"></a>00378                 }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380               <span class="keywordflow">case</span> <span class="charliteral">&apos;m&apos;</span>:
<a name="l00381"></a>00381                 {
<a name="l00382"></a>00382                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00383"></a>00383 
<a name="l00384"></a>00384                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 2);
<a name="l00385"></a>00385                     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/df5/date__strptime_8c.html#aace2cb3bff93bb9ed29458a3d4d1ad27">valid_range_p</a>(n, 1, 12))
<a name="l00386"></a>00386                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00387"></a>00387                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;mon&quot;</span>, n);
<a name="l00388"></a>00388                     <span class="keywordflow">goto</span> matched;
<a name="l00389"></a>00389                 }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391               <span class="keywordflow">case</span> <span class="charliteral">&apos;n&apos;</span>:
<a name="l00392"></a>00392               <span class="keywordflow">case</span> <span class="charliteral">&apos;t&apos;</span>:
<a name="l00393"></a>00393                 <a class="code" href="../../d9/df5/date__strptime_8c.html#a554631207e429ff3f75bc8bacf3806d4">recur</a>(<span class="stringliteral">&quot; &quot;</span>);
<a name="l00394"></a>00394                 <span class="keywordflow">goto</span> matched;
<a name="l00395"></a>00395 
<a name="l00396"></a>00396               <span class="keywordflow">case</span> <span class="charliteral">&apos;P&apos;</span>:
<a name="l00397"></a>00397               <span class="keywordflow">case</span> <span class="charliteral">&apos;p&apos;</span>:
<a name="l00398"></a>00398                 {
<a name="l00399"></a>00399                     <span class="keywordtype">int</span> i;
<a name="l00400"></a>00400 
<a name="l00401"></a>00401                     <span class="keywordflow">for</span> (i = 0; i &lt; 4; i++) {
<a name="l00402"></a>00402                         <span class="keywordtype">size_t</span> l = <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(<a class="code" href="../../d9/df5/date__strptime_8c.html#a7d07a04b495d2693d3bda4b42d662f0c">merid_names</a>[i]);
<a name="l00403"></a>00403                         <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#aba00036f71bb67f8600b239a39cf5ec9">strncasecmp</a>(<a class="code" href="../../d9/df5/date__strptime_8c.html#a7d07a04b495d2693d3bda4b42d662f0c">merid_names</a>[i], &amp;str[si], l) == 0) {
<a name="l00404"></a>00404                             si += l;
<a name="l00405"></a>00405                             <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;_merid&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>((i % 2) == 0 ? 0 : 12));
<a name="l00406"></a>00406                             <span class="keywordflow">goto</span> matched;
<a name="l00407"></a>00407                         }
<a name="l00408"></a>00408                     }
<a name="l00409"></a>00409                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00410"></a>00410                 }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412               <span class="keywordflow">case</span> <span class="charliteral">&apos;Q&apos;</span>:
<a name="l00413"></a>00413                 {
<a name="l00414"></a>00414                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00415"></a>00415                     <span class="keywordtype">int</span> sign = 1;
<a name="l00416"></a>00416 
<a name="l00417"></a>00417                     <span class="keywordflow">if</span> (str[si] == <span class="charliteral">&apos;-&apos;</span>) {
<a name="l00418"></a>00418                         sign = -1;
<a name="l00419"></a>00419                         si++;
<a name="l00420"></a>00420                     }
<a name="l00421"></a>00421                     <a class="code" href="../../d9/df5/date__strptime_8c.html#af08ecd10049ca90fc43f028dd11b9e41">READ_DIGITS_MAX</a>(n);
<a name="l00422"></a>00422                     <span class="keywordflow">if</span> (sign == -1)
<a name="l00423"></a>00423                         n = <a class="code" href="../../dd/dc0/date__core_8c.html#a0933ad9f95913001653394c7c3c3898d">f_negate</a>(n);
<a name="l00424"></a>00424                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;seconds&quot;</span>,
<a name="l00425"></a>00425                              <a class="code" href="../../db/d2e/intern_8h.html#ae13ef3f18f6045c33bbf943c11e14ac5">rb_rational_new2</a>(n,
<a name="l00426"></a>00426                                               <a class="code" href="../../dd/dc0/date__core_8c.html#acbc7500ccf2c6b5a11c98dc2866e613f">f_expt</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(10),
<a name="l00427"></a>00427                                                      <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(3))));
<a name="l00428"></a>00428                     <span class="keywordflow">goto</span> matched;
<a name="l00429"></a>00429                 }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431               <span class="keywordflow">case</span> <span class="charliteral">&apos;R&apos;</span>:
<a name="l00432"></a>00432                 <a class="code" href="../../d9/df5/date__strptime_8c.html#a554631207e429ff3f75bc8bacf3806d4">recur</a>(<span class="stringliteral">&quot;%H:%M&quot;</span>);
<a name="l00433"></a>00433                 <span class="keywordflow">goto</span> matched;
<a name="l00434"></a>00434 
<a name="l00435"></a>00435               <span class="keywordflow">case</span> <span class="charliteral">&apos;r&apos;</span>:
<a name="l00436"></a>00436                 <a class="code" href="../../d9/df5/date__strptime_8c.html#a554631207e429ff3f75bc8bacf3806d4">recur</a>(<span class="stringliteral">&quot;%I:%M:%S %p&quot;</span>);
<a name="l00437"></a>00437                 <span class="keywordflow">goto</span> matched;
<a name="l00438"></a>00438 
<a name="l00439"></a>00439               <span class="keywordflow">case</span> <span class="charliteral">&apos;S&apos;</span>:
<a name="l00440"></a>00440                 {
<a name="l00441"></a>00441                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 2);
<a name="l00444"></a>00444                     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/df5/date__strptime_8c.html#aace2cb3bff93bb9ed29458a3d4d1ad27">valid_range_p</a>(n, 0, 60))
<a name="l00445"></a>00445                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00446"></a>00446                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;sec&quot;</span>, n);
<a name="l00447"></a>00447                     <span class="keywordflow">goto</span> matched;
<a name="l00448"></a>00448                 }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450               <span class="keywordflow">case</span> <span class="charliteral">&apos;s&apos;</span>:
<a name="l00451"></a>00451                 {
<a name="l00452"></a>00452                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00453"></a>00453                     <span class="keywordtype">int</span> sign = 1;
<a name="l00454"></a>00454 
<a name="l00455"></a>00455                     <span class="keywordflow">if</span> (str[si] == <span class="charliteral">&apos;-&apos;</span>) {
<a name="l00456"></a>00456                         sign = -1;
<a name="l00457"></a>00457                         si++;
<a name="l00458"></a>00458                     }
<a name="l00459"></a>00459                     <a class="code" href="../../d9/df5/date__strptime_8c.html#af08ecd10049ca90fc43f028dd11b9e41">READ_DIGITS_MAX</a>(n);
<a name="l00460"></a>00460                     <span class="keywordflow">if</span> (sign == -1)
<a name="l00461"></a>00461                         n = <a class="code" href="../../dd/dc0/date__core_8c.html#a0933ad9f95913001653394c7c3c3898d">f_negate</a>(n);
<a name="l00462"></a>00462                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;seconds&quot;</span>, n);
<a name="l00463"></a>00463                     <span class="keywordflow">goto</span> matched;
<a name="l00464"></a>00464                 }
<a name="l00465"></a>00465 
<a name="l00466"></a>00466               <span class="keywordflow">case</span> <span class="charliteral">&apos;T&apos;</span>:
<a name="l00467"></a>00467                 <a class="code" href="../../d9/df5/date__strptime_8c.html#a554631207e429ff3f75bc8bacf3806d4">recur</a>(<span class="stringliteral">&quot;%H:%M:%S&quot;</span>);
<a name="l00468"></a>00468                 <span class="keywordflow">goto</span> matched;
<a name="l00469"></a>00469 
<a name="l00470"></a>00470               <span class="keywordflow">case</span> <span class="charliteral">&apos;U&apos;</span>:
<a name="l00471"></a>00471               <span class="keywordflow">case</span> <span class="charliteral">&apos;W&apos;</span>:
<a name="l00472"></a>00472                 {
<a name="l00473"></a>00473                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 2);
<a name="l00476"></a>00476                     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/df5/date__strptime_8c.html#aace2cb3bff93bb9ed29458a3d4d1ad27">valid_range_p</a>(n, 0, 53))
<a name="l00477"></a>00477                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00478"></a>00478                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(c == <span class="charliteral">&apos;U&apos;</span> ? <span class="stringliteral">&quot;wnum0&quot;</span> : <span class="stringliteral">&quot;wnum1&quot;</span>, n);
<a name="l00479"></a>00479                     <span class="keywordflow">goto</span> matched;
<a name="l00480"></a>00480                 }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482               <span class="keywordflow">case</span> <span class="charliteral">&apos;u&apos;</span>:
<a name="l00483"></a>00483                 {
<a name="l00484"></a>00484                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00485"></a>00485 
<a name="l00486"></a>00486                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 1);
<a name="l00487"></a>00487                     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/df5/date__strptime_8c.html#aace2cb3bff93bb9ed29458a3d4d1ad27">valid_range_p</a>(n, 1, 7))
<a name="l00488"></a>00488                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00489"></a>00489                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;cwday&quot;</span>, n);
<a name="l00490"></a>00490                     <span class="keywordflow">goto</span> matched;
<a name="l00491"></a>00491                 }
<a name="l00492"></a>00492 
<a name="l00493"></a>00493               <span class="keywordflow">case</span> <span class="charliteral">&apos;V&apos;</span>:
<a name="l00494"></a>00494                 {
<a name="l00495"></a>00495                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 2);
<a name="l00498"></a>00498                     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/df5/date__strptime_8c.html#aace2cb3bff93bb9ed29458a3d4d1ad27">valid_range_p</a>(n, 1, 53))
<a name="l00499"></a>00499                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00500"></a>00500                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;cweek&quot;</span>, n);
<a name="l00501"></a>00501                     <span class="keywordflow">goto</span> matched;
<a name="l00502"></a>00502                 }
<a name="l00503"></a>00503 
<a name="l00504"></a>00504               <span class="keywordflow">case</span> <span class="charliteral">&apos;v&apos;</span>:
<a name="l00505"></a>00505                 <a class="code" href="../../d9/df5/date__strptime_8c.html#a554631207e429ff3f75bc8bacf3806d4">recur</a>(<span class="stringliteral">&quot;%e-%b-%Y&quot;</span>);
<a name="l00506"></a>00506                 <span class="keywordflow">goto</span> matched;
<a name="l00507"></a>00507 
<a name="l00508"></a>00508               <span class="keywordflow">case</span> <span class="charliteral">&apos;w&apos;</span>:
<a name="l00509"></a>00509                 {
<a name="l00510"></a>00510                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00511"></a>00511 
<a name="l00512"></a>00512                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 1);
<a name="l00513"></a>00513                     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/df5/date__strptime_8c.html#aace2cb3bff93bb9ed29458a3d4d1ad27">valid_range_p</a>(n, 0, 6))
<a name="l00514"></a>00514                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00515"></a>00515                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;wday&quot;</span>, n);
<a name="l00516"></a>00516                     <span class="keywordflow">goto</span> matched;
<a name="l00517"></a>00517                 }
<a name="l00518"></a>00518 
<a name="l00519"></a>00519               <span class="keywordflow">case</span> <span class="charliteral">&apos;X&apos;</span>:
<a name="l00520"></a>00520                 <a class="code" href="../../d9/df5/date__strptime_8c.html#a554631207e429ff3f75bc8bacf3806d4">recur</a>(<span class="stringliteral">&quot;%H:%M:%S&quot;</span>);
<a name="l00521"></a>00521                 <span class="keywordflow">goto</span> matched;
<a name="l00522"></a>00522 
<a name="l00523"></a>00523               <span class="keywordflow">case</span> <span class="charliteral">&apos;x&apos;</span>:
<a name="l00524"></a>00524                 <a class="code" href="../../d9/df5/date__strptime_8c.html#a554631207e429ff3f75bc8bacf3806d4">recur</a>(<span class="stringliteral">&quot;%m/%d/%y&quot;</span>);
<a name="l00525"></a>00525                 <span class="keywordflow">goto</span> matched;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527               <span class="keywordflow">case</span> <span class="charliteral">&apos;Y&apos;</span>:
<a name="l00528"></a>00528                   {
<a name="l00529"></a>00529                       <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00530"></a>00530                       <span class="keywordtype">int</span> sign = 1;
<a name="l00531"></a>00531 
<a name="l00532"></a>00532                       <span class="keywordflow">if</span> (<a class="code" href="../../dd/d9f/date__parse_8c.html#a523763d917fb93f44bdf717ad2654182">issign</a>(str[si])) {
<a name="l00533"></a>00533                           <span class="keywordflow">if</span> (str[si] == <span class="charliteral">&apos;-&apos;</span>)
<a name="l00534"></a>00534                               sign = -1;
<a name="l00535"></a>00535                           si++;
<a name="l00536"></a>00536                       }
<a name="l00537"></a>00537                       <span class="keywordflow">if</span> (<a class="code" href="../../d9/df5/date__strptime_8c.html#aeb920a925081ebd6f1bc87bb8cc843d6">NUM_PATTERN_P</a>())
<a name="l00538"></a>00538                           <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 4)
<a name="l00539"></a>00539                       <span class="keywordflow">else</span>
<a name="l00540"></a>00540                           <a class="code" href="../../d9/df5/date__strptime_8c.html#af08ecd10049ca90fc43f028dd11b9e41">READ_DIGITS_MAX</a>(n)
<a name="l00541"></a>00541                     <span class="keywordflow">if</span> (sign == -1)
<a name="l00542"></a>00542                         n = <a class="code" href="../../dd/dc0/date__core_8c.html#a0933ad9f95913001653394c7c3c3898d">f_negate</a>(n);
<a name="l00543"></a>00543                       <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;year&quot;</span>, n);
<a name="l00544"></a>00544                       <span class="keywordflow">goto</span> matched;
<a name="l00545"></a>00545                   }
<a name="l00546"></a>00546 
<a name="l00547"></a>00547               <span class="keywordflow">case</span> <span class="charliteral">&apos;y&apos;</span>:
<a name="l00548"></a>00548                 {
<a name="l00549"></a>00549                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l00550"></a>00550                     <span class="keywordtype">int</span> sign = 1;
<a name="l00551"></a>00551 
<a name="l00552"></a>00552                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a66215ba2c7e5c3bbf1f45f5f64ebd8df">READ_DIGITS</a>(n, 2);
<a name="l00553"></a>00553                     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/df5/date__strptime_8c.html#aace2cb3bff93bb9ed29458a3d4d1ad27">valid_range_p</a>(n, 0, 99))
<a name="l00554"></a>00554                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00555"></a>00555                     <span class="keywordflow">if</span> (sign == -1)
<a name="l00556"></a>00556                         n = <a class="code" href="../../dd/dc0/date__core_8c.html#a0933ad9f95913001653394c7c3c3898d">f_negate</a>(n);
<a name="l00557"></a>00557                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;year&quot;</span>, n);
<a name="l00558"></a>00558                     <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;_cent&quot;</span>,
<a name="l00559"></a>00559                              <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../dd/d9f/date__parse_8c.html#a10d2f3dba73d7ce0f67cc8f0042da662">f_ge_p</a>(n, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(69)) ? 19 : 20));
<a name="l00560"></a>00560                     <span class="keywordflow">goto</span> matched;
<a name="l00561"></a>00561                 }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563               <span class="keywordflow">case</span> <span class="charliteral">&apos;Z&apos;</span>:
<a name="l00564"></a>00564               <span class="keywordflow">case</span> <span class="charliteral">&apos;z&apos;</span>:
<a name="l00565"></a>00565                 {
<a name="l00566"></a>00566                     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> pat_source[] =
<a name="l00567"></a>00567                         <span class="stringliteral">&quot;\\A(&quot;</span>
<a name="l00568"></a>00568                         <span class="stringliteral">&quot;(?:gmt|utc?)?[-+]\\d+(?:[,.:]\\d+(?::\\d+)?)?&quot;</span>
<a name="l00569"></a>00569                         <span class="stringliteral">&quot;|[[:alpha:].\\s]+(?:standard|daylight)\\s+time\\b&quot;</span>
<a name="l00570"></a>00570                         <span class="stringliteral">&quot;|[[:alpha:]]+(?:\\s+dst)?\\b&quot;</span>
<a name="l00571"></a>00571                         <span class="stringliteral">&quot;)&quot;</span>;
<a name="l00572"></a>00572                     <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> pat = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00573"></a>00573                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> m, b;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575                     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(pat)) {
<a name="l00576"></a>00576                         pat = <a class="code" href="../../db/d2e/intern_8h.html#a9de8268f4a0b918cfed87666b7b0f4f2">rb_reg_new</a>(pat_source, <span class="keyword">sizeof</span> pat_source - 1,
<a name="l00577"></a>00577                                          <a class="code" href="../../d8/db3/oniguruma_8h.html#a7caf1d0c5932b5b8bb7c63185b0aa1d9">ONIG_OPTION_IGNORECASE</a>);
<a name="l00578"></a>00578                         <a class="code" href="../../d8/d16/gc_8c.html#adc7efe8997f04b5c275d7e7aed9169e3">rb_gc_register_mark_object</a>(pat);
<a name="l00579"></a>00579                     }
<a name="l00580"></a>00580 
<a name="l00581"></a>00581                     b = <a class="code" href="../../db/d2e/intern_8h.html#a2590f9272c0599ff0d1922bd0fb6efce">rb_backref_get</a>();
<a name="l00582"></a>00582                     <a class="code" href="../../db/d2e/intern_8h.html#a4ceb8f1d0fd61d42eeb9f1e40068ceba">rb_match_busy</a>(b);
<a name="l00583"></a>00583                     m = <a class="code" href="../../d1/d81/complex_8c.html#a11e81aca0cf7271a7f4c9715d91e0eed">f_match</a>(pat, <a class="code" href="../../db/d2e/intern_8h.html#a99895fce59be905b7c7f0a88bd32fa1f">rb_usascii_str_new2</a>(&amp;str[si]));
<a name="l00584"></a>00584 
<a name="l00585"></a>00585                     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(m)) {
<a name="l00586"></a>00586                         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> s, l, o;
<a name="l00587"></a>00587 
<a name="l00588"></a>00588                         s = <a class="code" href="../../db/d2e/intern_8h.html#ac50ab731365028f5efab69c001fba39d">rb_reg_nth_match</a>(1, m);
<a name="l00589"></a>00589                         l = <a class="code" href="../../dd/d9f/date__parse_8c.html#a6878df1692922416ea5c2fc4a53129de">f_end</a>(m, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0));
<a name="l00590"></a>00590                         o = <a class="code" href="../../dd/dc0/date__core_8c.html#ad7f3c5f977a91cf1f49e163cf8caccda">date_zone_to_diff</a>(s);
<a name="l00591"></a>00591                         si += <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(l);
<a name="l00592"></a>00592                         <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;zone&quot;</span>, s);
<a name="l00593"></a>00593                         <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;offset&quot;</span>, o);
<a name="l00594"></a>00594                         <a class="code" href="../../db/d2e/intern_8h.html#af108344435c1d0ea151c99dc859cccb4">rb_backref_set</a>(b);
<a name="l00595"></a>00595                         <span class="keywordflow">goto</span> matched;
<a name="l00596"></a>00596                     }
<a name="l00597"></a>00597                     <a class="code" href="../../db/d2e/intern_8h.html#af108344435c1d0ea151c99dc859cccb4">rb_backref_set</a>(b);
<a name="l00598"></a>00598                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00599"></a>00599                 }
<a name="l00600"></a>00600 
<a name="l00601"></a>00601               <span class="keywordflow">case</span> <span class="charliteral">&apos;%&apos;</span>:
<a name="l00602"></a>00602                 <span class="keywordflow">if</span> (str[si] != <span class="charliteral">&apos;%&apos;</span>)
<a name="l00603"></a>00603                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00604"></a>00604                 si++;
<a name="l00605"></a>00605                 <span class="keywordflow">goto</span> matched;
<a name="l00606"></a>00606 
<a name="l00607"></a>00607               <span class="keywordflow">case</span> <span class="charliteral">&apos;+&apos;</span>:
<a name="l00608"></a>00608                 <a class="code" href="../../d9/df5/date__strptime_8c.html#a554631207e429ff3f75bc8bacf3806d4">recur</a>(<span class="stringliteral">&quot;%a %b %e %H:%M:%S %Z %Y&quot;</span>);
<a name="l00609"></a>00609                 <span class="keywordflow">goto</span> matched;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611               <span class="keywordflow">default</span>:
<a name="l00612"></a>00612                 <span class="keywordflow">if</span> (str[si] != <span class="charliteral">&apos;%&apos;</span>)
<a name="l00613"></a>00613                     <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00614"></a>00614                 si++;
<a name="l00615"></a>00615                 <span class="keywordflow">if</span> (fi &lt; flen)
<a name="l00616"></a>00616                     <span class="keywordflow">if</span> (str[si] != fmt[fi])
<a name="l00617"></a>00617                         <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00618"></a>00618                 si++;
<a name="l00619"></a>00619                 <span class="keywordflow">goto</span> matched;
<a name="l00620"></a>00620             }
<a name="l00621"></a>00621           <span class="keywordflow">case</span> <span class="charliteral">&apos; &apos;</span>:
<a name="l00622"></a>00622           <span class="keywordflow">case</span> <span class="charliteral">&apos;\t&apos;</span>:
<a name="l00623"></a>00623           <span class="keywordflow">case</span> <span class="charliteral">&apos;\n&apos;</span>:
<a name="l00624"></a>00624           <span class="keywordflow">case</span> <span class="charliteral">&apos;\v&apos;</span>:
<a name="l00625"></a>00625           <span class="keywordflow">case</span> <span class="charliteral">&apos;\f&apos;</span>:
<a name="l00626"></a>00626           <span class="keywordflow">case</span> <span class="charliteral">&apos;\r&apos;</span>:
<a name="l00627"></a>00627             <span class="keywordflow">while</span> (isspace(str[si]))
<a name="l00628"></a>00628                 si++;
<a name="l00629"></a>00629             fi++;
<a name="l00630"></a>00630             <span class="keywordflow">break</span>;
<a name="l00631"></a>00631           <span class="keywordflow">default</span>:
<a name="l00632"></a>00632           ordinal:
<a name="l00633"></a>00633             <span class="keywordflow">if</span> (str[si] != fmt[fi])
<a name="l00634"></a>00634                 <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>();
<a name="l00635"></a>00635             si++;
<a name="l00636"></a>00636             fi++;
<a name="l00637"></a>00637             <span class="keywordflow">break</span>;
<a name="l00638"></a>00638           matched:
<a name="l00639"></a>00639             fi++;
<a name="l00640"></a>00640             <span class="keywordflow">break</span>;
<a name="l00641"></a>00641         }
<a name="l00642"></a>00642     }
<a name="l00643"></a>00643 
<a name="l00644"></a>00644     <span class="keywordflow">return</span> si;
<a name="l00645"></a>00645 }
<a name="l00646"></a>00646 
<a name="l00647"></a>00647 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00648"></a><a class="code" href="../../d9/df5/date__strptime_8c.html#ac084bedf00928a132c40624e762e182c">00648</a> <a class="code" href="../../dd/dc0/date__core_8c.html#ac084bedf00928a132c40624e762e182c">date__strptime</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *str, <span class="keywordtype">size_t</span> slen,
<a name="l00649"></a>00649                <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, <span class="keywordtype">size_t</span> flen, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/deb/lex_8c.html#a5541f85ce416df233cce93949f0eeeca">hash</a>)
<a name="l00650"></a>00650 {
<a name="l00651"></a>00651     <span class="keywordtype">size_t</span> si;
<a name="l00652"></a>00652     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> cent, merid;
<a name="l00653"></a>00653 
<a name="l00654"></a>00654     si = <a class="code" href="../../d9/df5/date__strptime_8c.html#af7c06364d339f19555fc3b796c124878">date__strptime_internal</a>(str, slen, fmt, flen, hash);
<a name="l00655"></a>00655 
<a name="l00656"></a>00656     <span class="keywordflow">if</span> (slen &gt; si) {
<a name="l00657"></a>00657         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> s;
<a name="l00658"></a>00658 
<a name="l00659"></a>00659         s = <a class="code" href="../../db/d2e/intern_8h.html#aed107a4eacd5f626b554d2d341b58bd5">rb_usascii_str_new</a>(&amp;str[si], slen - si);
<a name="l00660"></a>00660         <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;leftover&quot;</span>, s);
<a name="l00661"></a>00661     }
<a name="l00662"></a>00662 
<a name="l00663"></a>00663     <span class="keywordflow">if</span> (<a class="code" href="../../d9/df5/date__strptime_8c.html#a87260ca3d2340e7464d142313384535d">fail_p</a>())
<a name="l00664"></a>00664         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00665"></a>00665 
<a name="l00666"></a>00666     cent = <a class="code" href="../../dd/dc0/date__core_8c.html#aa8d8e349a342c6d3383e033841184190">ref_hash</a>(<span class="stringliteral">&quot;_cent&quot;</span>);
<a name="l00667"></a>00667     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(cent)) {
<a name="l00668"></a>00668         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> year;
<a name="l00669"></a>00669 
<a name="l00670"></a>00670         year = <a class="code" href="../../dd/dc0/date__core_8c.html#aa8d8e349a342c6d3383e033841184190">ref_hash</a>(<span class="stringliteral">&quot;cwyear&quot;</span>);
<a name="l00671"></a>00671         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(year))
<a name="l00672"></a>00672             <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;cwyear&quot;</span>, <a class="code" href="../../dd/dc0/date__core_8c.html#a086db25e0919cc2cb7de8b65206dc0ea">f_add</a>(year, <a class="code" href="../../dd/dc0/date__core_8c.html#a11a8a27c7cc08005050225d0e3c5f88b">f_mul</a>(cent, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(100))));
<a name="l00673"></a>00673         year = <a class="code" href="../../dd/dc0/date__core_8c.html#aa8d8e349a342c6d3383e033841184190">ref_hash</a>(<span class="stringliteral">&quot;year&quot;</span>);
<a name="l00674"></a>00674         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(year))
<a name="l00675"></a>00675             <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;year&quot;</span>, <a class="code" href="../../dd/dc0/date__core_8c.html#a086db25e0919cc2cb7de8b65206dc0ea">f_add</a>(year, <a class="code" href="../../dd/dc0/date__core_8c.html#a11a8a27c7cc08005050225d0e3c5f88b">f_mul</a>(cent, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(100))));
<a name="l00676"></a>00676         <a class="code" href="../../dd/dc0/date__core_8c.html#a81ae375b266bf330c134e7370c449022">del_hash</a>(<span class="stringliteral">&quot;_cent&quot;</span>);
<a name="l00677"></a>00677     }
<a name="l00678"></a>00678 
<a name="l00679"></a>00679     merid = <a class="code" href="../../dd/dc0/date__core_8c.html#aa8d8e349a342c6d3383e033841184190">ref_hash</a>(<span class="stringliteral">&quot;_merid&quot;</span>);
<a name="l00680"></a>00680     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(merid)) {
<a name="l00681"></a>00681         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> hour;
<a name="l00682"></a>00682 
<a name="l00683"></a>00683         hour = <a class="code" href="../../dd/dc0/date__core_8c.html#aa8d8e349a342c6d3383e033841184190">ref_hash</a>(<span class="stringliteral">&quot;hour&quot;</span>);
<a name="l00684"></a>00684         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(hour)) {
<a name="l00685"></a>00685             hour = <a class="code" href="../../dd/dc0/date__core_8c.html#ad3d10170a0b84d9787810c2550d65b85">f_mod</a>(hour, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(12));
<a name="l00686"></a>00686             <a class="code" href="../../dd/dc0/date__core_8c.html#a77be02878bf6cf796943a0034e7a9780">set_hash</a>(<span class="stringliteral">&quot;hour&quot;</span>, <a class="code" href="../../dd/dc0/date__core_8c.html#a086db25e0919cc2cb7de8b65206dc0ea">f_add</a>(hour, merid));
<a name="l00687"></a>00687         }
<a name="l00688"></a>00688         <a class="code" href="../../dd/dc0/date__core_8c.html#a81ae375b266bf330c134e7370c449022">del_hash</a>(<span class="stringliteral">&quot;_merid&quot;</span>);
<a name="l00689"></a>00689     }
<a name="l00690"></a>00690 
<a name="l00691"></a>00691     <span class="keywordflow">return</span> hash;
<a name="l00692"></a>00692 }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694 <span class="comment">/*</span>
<a name="l00695"></a>00695 <span class="comment">Local variables:</span>
<a name="l00696"></a>00696 <span class="comment">c-file-style: &quot;ruby&quot;</span>
<a name="l00697"></a>00697 <span class="comment">End:</span>
<a name="l00698"></a>00698 <span class="comment">*/</span>
<a name="l00699"></a>00699 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Mar 2013 for Ruby by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
