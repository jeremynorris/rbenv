<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Ruby: pack.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>pack.c</h1><a href="../../d1/d7d/pack_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/**********************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  pack.c -</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">  $Author: naruse $</span>
<a name="l00006"></a>00006 <span class="comment">  created at: Thu Feb 10 15:17:05 JST 1994</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment">  Copyright (C) 1993-2007 Yukihiro Matsumoto</span>
<a name="l00009"></a>00009 <span class="comment"></span>
<a name="l00010"></a>00010 <span class="comment">**********************************************************************/</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="../../de/de6/ruby_2ruby_8h.html">ruby/ruby.h</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/de3/encoding_8h.html">ruby/encoding.h</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00017"></a>00017 
<a name="l00018"></a><a class="code" href="../../d1/d7d/pack_8c.html#a4bf725cbcc302498a47e56787a7c999d">00018</a> <span class="preprocessor">#define GCC_VERSION_SINCE(major, minor, patchlevel) \</span>
<a name="l00019"></a>00019 <span class="preprocessor">  (defined(__GNUC__) &amp;&amp; !defined(__INTEL_COMPILER) &amp;&amp; \</span>
<a name="l00020"></a>00020 <span class="preprocessor">   ((__GNUC__ &gt; (major)) ||  \</span>
<a name="l00021"></a>00021 <span class="preprocessor">    (__GNUC__ == (major) &amp;&amp; __GNUC_MINOR__ &gt; (minor)) || \</span>
<a name="l00022"></a>00022 <span class="preprocessor">    (__GNUC__ == (major) &amp;&amp; __GNUC_MINOR__ == (minor) &amp;&amp; __GNUC_PATCHLEVEL__ &gt;= (patchlevel))))</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span><span class="preprocessor">#if SIZEOF_SHORT != 2 || SIZEOF_LONG != 4</span>
<a name="l00024"></a><a class="code" href="../../d1/d7d/pack_8c.html#ace392429c61fae7306b1a0dcb2bbdaee">00024</a> <span class="preprocessor"></span><span class="preprocessor"># define NATINT_PACK</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span>
<a name="l00027"></a>00027 <span class="preprocessor">#ifdef DYNAMIC_ENDIAN</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span> <span class="comment">/* for universal binary of NEXTSTEP and MacOS X */</span>
<a name="l00029"></a>00029  <span class="comment">/* useless since autoconf 2.63? */</span>
<a name="l00030"></a>00030  <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00031"></a>00031  is_bigendian(<span class="keywordtype">void</span>)
<a name="l00032"></a>00032  {
<a name="l00033"></a>00033      <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d43/-test-_2string_2init_8c.html#a7c6f1d2e32298f69b4ea18be4aa62129">init</a> = 0;
<a name="l00034"></a>00034      <span class="keyword">static</span> <span class="keywordtype">int</span> endian_value;
<a name="l00035"></a>00035      <span class="keywordtype">char</span> *p;
<a name="l00036"></a>00036 
<a name="l00037"></a>00037      <span class="keywordflow">if</span> (init) <span class="keywordflow">return</span> endian_value;
<a name="l00038"></a>00038      init = 1;
<a name="l00039"></a>00039      p = (<span class="keywordtype">char</span>*)&amp;init;
<a name="l00040"></a>00040      <span class="keywordflow">return</span> endian_value = p[0]?0:1;
<a name="l00041"></a>00041  }
<a name="l00042"></a>00042 <span class="preprocessor"># define BIGENDIAN_P() (is_bigendian())</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#elif defined(WORDS_BIGENDIAN)</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor"># define BIGENDIAN_P() 1</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00046"></a><a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">00046</a> <span class="preprocessor"></span><span class="preprocessor"># define BIGENDIAN_P() 0</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span>
<a name="l00049"></a>00049 <span class="preprocessor">#ifdef NATINT_PACK</span>
<a name="l00050"></a><a class="code" href="../../d1/d7d/pack_8c.html#a43fde2e64181f2ee17a4e448a546010c">00050</a> <span class="preprocessor"></span><span class="preprocessor"># define NATINT_LEN(type,len) (natint?(int)sizeof(type):(int)(len))</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span><span class="preprocessor"># define NATINT_LEN(type,len) ((int)sizeof(type))</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span>
<a name="l00055"></a>00055 <span class="preprocessor">#if SIZEOF_LONG == 8</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor"># define INT64toNUM(x) LONG2NUM(x)</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span><span class="preprocessor"># define UINT64toNUM(x) ULONG2NUM(x)</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor">#elif defined(HAVE_LONG_LONG) &amp;&amp; SIZEOF_LONG_LONG == 8</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span><span class="preprocessor"># define INT64toNUM(x) LL2NUM(x)</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span><span class="preprocessor"># define UINT64toNUM(x) ULL2NUM(x)</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span>
<a name="l00063"></a><a class="code" href="../../d1/d7d/pack_8c.html#a24d097fb20acf2370bbba54c7bf2af7f">00063</a> <span class="preprocessor">#define define_swapx(x, xtype)          \</span>
<a name="l00064"></a>00064 <span class="preprocessor">static xtype                            \</span>
<a name="l00065"></a>00065 <span class="preprocessor">TOKEN_PASTE(swap,x)(xtype z)            \</span>
<a name="l00066"></a>00066 <span class="preprocessor">{                                       \</span>
<a name="l00067"></a>00067 <span class="preprocessor">    xtype r;                            \</span>
<a name="l00068"></a>00068 <span class="preprocessor">    xtype *zp;                          \</span>
<a name="l00069"></a>00069 <span class="preprocessor">    unsigned char *s, *t;               \</span>
<a name="l00070"></a>00070 <span class="preprocessor">    int i;                              \</span>
<a name="l00071"></a>00071 <span class="preprocessor">                                        \</span>
<a name="l00072"></a>00072 <span class="preprocessor">    zp = xmalloc(sizeof(xtype));        \</span>
<a name="l00073"></a>00073 <span class="preprocessor">    *zp = z;                            \</span>
<a name="l00074"></a>00074 <span class="preprocessor">    s = (unsigned char*)zp;             \</span>
<a name="l00075"></a>00075 <span class="preprocessor">    t = xmalloc(sizeof(xtype));         \</span>
<a name="l00076"></a>00076 <span class="preprocessor">    for (i=0; i&lt;sizeof(xtype); i++) {   \</span>
<a name="l00077"></a>00077 <span class="preprocessor">        t[sizeof(xtype)-i-1] = s[i];    \</span>
<a name="l00078"></a>00078 <span class="preprocessor">    }                                   \</span>
<a name="l00079"></a>00079 <span class="preprocessor">    r = *(xtype *)t;                    \</span>
<a name="l00080"></a>00080 <span class="preprocessor">    xfree(t);                           \</span>
<a name="l00081"></a>00081 <span class="preprocessor">    xfree(zp);                          \</span>
<a name="l00082"></a>00082 <span class="preprocessor">    return r;                           \</span>
<a name="l00083"></a>00083 <span class="preprocessor">}</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span>
<a name="l00085"></a>00085 <span class="preprocessor">#if GCC_VERSION_SINCE(4,3,0)</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span><span class="preprocessor"># define swap32(x) __builtin_bswap32(x)</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span><span class="preprocessor"># define swap64(x) __builtin_bswap64(x)</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span>
<a name="l00090"></a>00090 <span class="preprocessor">#ifndef swap16</span>
<a name="l00091"></a><a class="code" href="../../d1/d7d/pack_8c.html#a230ba4a10a19fd06db52f5a5ed957d2b">00091</a> <span class="preprocessor"></span><span class="preprocessor"># define swap16(x)      ((((x)&amp;0xFF)&lt;&lt;8) | (((x)&gt;&gt;8)&amp;0xFF))</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span>
<a name="l00094"></a>00094 <span class="preprocessor">#ifndef swap32</span>
<a name="l00095"></a><a class="code" href="../../d1/d7d/pack_8c.html#a40f89812fbb971f324be796c9854a590">00095</a> <span class="preprocessor"></span><span class="preprocessor"># define swap32(x)      ((((x)&amp;0xFF)&lt;&lt;24)       \</span>
<a name="l00096"></a>00096 <span class="preprocessor">                        |(((x)&gt;&gt;24)&amp;0xFF)       \</span>
<a name="l00097"></a>00097 <span class="preprocessor">                        |(((x)&amp;0x0000FF00)&lt;&lt;8)  \</span>
<a name="l00098"></a>00098 <span class="preprocessor">                        |(((x)&amp;0x00FF0000)&gt;&gt;8)  )</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span>
<a name="l00101"></a>00101 <span class="preprocessor">#ifndef swap64</span>
<a name="l00102"></a>00102 <span class="preprocessor"></span><span class="preprocessor"># ifdef HAVE_INT64_T</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span><span class="preprocessor">#  define byte_in_64bit(n) ((uint64_t)0xff &lt;&lt; (n))</span>
<a name="l00104"></a>00104 <span class="preprocessor"></span><span class="preprocessor">#  define swap64(x)       ((((x)&amp;byte_in_64bit(0))&lt;&lt;56)         \</span>
<a name="l00105"></a>00105 <span class="preprocessor">                           |(((x)&gt;&gt;56)&amp;0xFF)                    \</span>
<a name="l00106"></a>00106 <span class="preprocessor">                           |(((x)&amp;byte_in_64bit(8))&lt;&lt;40)        \</span>
<a name="l00107"></a>00107 <span class="preprocessor">                           |(((x)&amp;byte_in_64bit(48))&gt;&gt;40)       \</span>
<a name="l00108"></a>00108 <span class="preprocessor">                           |(((x)&amp;byte_in_64bit(16))&lt;&lt;24)       \</span>
<a name="l00109"></a>00109 <span class="preprocessor">                           |(((x)&amp;byte_in_64bit(40))&gt;&gt;24)       \</span>
<a name="l00110"></a>00110 <span class="preprocessor">                           |(((x)&amp;byte_in_64bit(24))&lt;&lt;8)        \</span>
<a name="l00111"></a>00111 <span class="preprocessor">                           |(((x)&amp;byte_in_64bit(32))&gt;&gt;8))</span>
<a name="l00112"></a>00112 <span class="preprocessor"></span><span class="preprocessor"># endif</span>
<a name="l00113"></a>00113 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00114"></a>00114 <span class="preprocessor"></span>
<a name="l00115"></a>00115 <span class="preprocessor">#if SIZEOF_SHORT == 2</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span><span class="preprocessor"># define swaps(x)       swap16(x)</span>
<a name="l00117"></a>00117 <span class="preprocessor"></span><span class="preprocessor">#elif SIZEOF_SHORT == 4</span>
<a name="l00118"></a>00118 <span class="preprocessor"></span><span class="preprocessor"># define swaps(x)       swap32(x)</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00120"></a><a class="code" href="../../d1/d7d/pack_8c.html#a617a0ed6396d13a7c844f8f20876cf9a">00120</a> <span class="preprocessor"></span>  <a class="code" href="../../d1/d7d/pack_8c.html#a24d097fb20acf2370bbba54c7bf2af7f">define_swapx</a>(s,<span class="keywordtype">short</span>)
<a name="l00121"></a>00121 <span class="preprocessor">#endif</span>
<a name="l00122"></a>00122 <span class="preprocessor"></span>
<a name="l00123"></a>00123 <span class="preprocessor">#if SIZEOF_INT == 2</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span><span class="preprocessor"># define swapi(x)       swap16(x)</span>
<a name="l00125"></a>00125 <span class="preprocessor"></span><span class="preprocessor">#elif SIZEOF_INT == 4</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span><span class="preprocessor"># define swapi(x)       swap32(x)</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span>  <a class="code" href="../../d1/d7d/pack_8c.html#a24d097fb20acf2370bbba54c7bf2af7f">define_swapx</a>(i,<span class="keywordtype">int</span>)
<a name="l00129"></a>00129 <span class="preprocessor">#endif</span>
<a name="l00130"></a>00130 <span class="preprocessor"></span>
<a name="l00131"></a>00131 <span class="preprocessor">#if SIZEOF_LONG == 4</span>
<a name="l00132"></a>00132 <span class="preprocessor"></span><span class="preprocessor"># define swapl(x)       swap32(x)</span>
<a name="l00133"></a>00133 <span class="preprocessor"></span><span class="preprocessor">#elif SIZEOF_LONG == 8</span>
<a name="l00134"></a>00134 <span class="preprocessor"></span><span class="preprocessor"># define swapl(x)        swap64(x)</span>
<a name="l00135"></a>00135 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00136"></a>00136 <span class="preprocessor"></span>  <a class="code" href="../../d1/d7d/pack_8c.html#a24d097fb20acf2370bbba54c7bf2af7f">define_swapx</a>(l,<span class="keywordtype">long</span>)
<a name="l00137"></a>00137 <span class="preprocessor">#endif</span>
<a name="l00138"></a>00138 <span class="preprocessor"></span>
<a name="l00139"></a>00139 <span class="preprocessor">#ifdef HAVE_LONG_LONG</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span><span class="preprocessor"># if SIZEOF_LONG_LONG == 8</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span><span class="preprocessor">#  define swapll(x)        swap64(x)</span>
<a name="l00142"></a>00142 <span class="preprocessor"></span><span class="preprocessor"># else</span>
<a name="l00143"></a>00143 <span class="preprocessor"></span>   <a class="code" href="../../d1/d7d/pack_8c.html#a24d097fb20acf2370bbba54c7bf2af7f">define_swapx</a>(ll,LONG_LONG)
<a name="l00144"></a>00144 <span class="preprocessor"># endif</span>
<a name="l00145"></a>00145 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span>
<a name="l00147"></a>00147 <span class="preprocessor">#if SIZEOF_FLOAT == 4 &amp;&amp; defined(HAVE_INT32_T)</span>
<a name="l00148"></a>00148 <span class="preprocessor"></span><span class="preprocessor">#   define swapf(x)     swap32(x)</span>
<a name="l00149"></a>00149 <span class="preprocessor"></span><span class="preprocessor">#   define FLOAT_SWAPPER        uint32_t</span>
<a name="l00150"></a>00150 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00151"></a>00151 <span class="preprocessor"></span>    <a class="code" href="../../d1/d7d/pack_8c.html#a24d097fb20acf2370bbba54c7bf2af7f">define_swapx</a>(f,<span class="keywordtype">float</span>)
<a name="l00152"></a>00152 <span class="preprocessor">#endif</span>
<a name="l00153"></a>00153 <span class="preprocessor"></span>
<a name="l00154"></a>00154 <span class="preprocessor">#if SIZEOF_DOUBLE == 8 &amp;&amp; defined(HAVE_INT64_T)</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span><span class="preprocessor">#   define swapd(x)     swap64(x)</span>
<a name="l00156"></a>00156 <span class="preprocessor"></span><span class="preprocessor">#   define DOUBLE_SWAPPER       uint64_t</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span><span class="preprocessor">#elif SIZEOF_DOUBLE == 8 &amp;&amp; defined(HAVE_INT32_T)</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span>    <span class="keyword">static</span> <span class="keywordtype">double</span>
<a name="l00159"></a>00159     swapd(<span class="keyword">const</span> <span class="keywordtype">double</span> d)
<a name="l00160"></a>00160     {
<a name="l00161"></a>00161         <span class="keywordtype">double</span> dtmp = d;
<a name="l00162"></a>00162         <a class="code" href="../../db/d4d/sha2_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> utmp[2];
<a name="l00163"></a>00163         <a class="code" href="../../db/d4d/sha2_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> utmp0;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165         utmp[0] = 0; utmp[1] = 0;
<a name="l00166"></a>00166         memcpy(utmp,&amp;dtmp,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00167"></a>00167         utmp0 = utmp[0];
<a name="l00168"></a>00168         utmp[0] = <a class="code" href="../../d1/d7d/pack_8c.html#a40f89812fbb971f324be796c9854a590">swap32</a>(utmp[1]);
<a name="l00169"></a>00169         utmp[1] = <a class="code" href="../../d1/d7d/pack_8c.html#a40f89812fbb971f324be796c9854a590">swap32</a>(utmp0);
<a name="l00170"></a>00170         memcpy(&amp;dtmp,utmp,<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00171"></a>00171         <span class="keywordflow">return</span> dtmp;
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173 <span class="preprocessor">#else</span>
<a name="l00174"></a>00174 <span class="preprocessor"></span>    <a class="code" href="../../d1/d7d/pack_8c.html#a24d097fb20acf2370bbba54c7bf2af7f">define_swapx</a>(d, <span class="keywordtype">double</span>)
<a name="l00175"></a>00175 <span class="preprocessor">#endif</span>
<a name="l00176"></a>00176 <span class="preprocessor"></span>
<a name="l00177"></a>00177 <span class="preprocessor">#undef define_swapx</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span>
<a name="l00179"></a>00179 <span class="preprocessor">#define rb_ntohf(x) (BIGENDIAN_P()?(x):swapf(x))</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span><span class="preprocessor">#define rb_ntohd(x) (BIGENDIAN_P()?(x):swapd(x))</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span><span class="preprocessor">#define rb_htonf(x) (BIGENDIAN_P()?(x):swapf(x))</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span><span class="preprocessor">#define rb_htond(x) (BIGENDIAN_P()?(x):swapd(x))</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span><span class="preprocessor">#define rb_htovf(x) (BIGENDIAN_P()?swapf(x):(x))</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span><span class="preprocessor">#define rb_htovd(x) (BIGENDIAN_P()?swapd(x):(x))</span>
<a name="l00185"></a>00185 <span class="preprocessor"></span><span class="preprocessor">#define rb_vtohf(x) (BIGENDIAN_P()?swapf(x):(x))</span>
<a name="l00186"></a>00186 <span class="preprocessor"></span><span class="preprocessor">#define rb_vtohd(x) (BIGENDIAN_P()?swapd(x):(x))</span>
<a name="l00187"></a>00187 <span class="preprocessor"></span>
<a name="l00188"></a>00188 <span class="preprocessor">#ifdef FLOAT_SWAPPER</span>
<a name="l00189"></a>00189 <span class="preprocessor"></span><span class="preprocessor"># define FLOAT_CONVWITH(y)      FLOAT_SWAPPER y;</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span><span class="preprocessor"># define HTONF(x,y)     (memcpy(&amp;(y),&amp;(x),sizeof(float)),       \</span>
<a name="l00191"></a>00191 <span class="preprocessor">                         (y) = rb_htonf((FLOAT_SWAPPER)(y)),    \</span>
<a name="l00192"></a>00192 <span class="preprocessor">                         memcpy(&amp;(x),&amp;(y),sizeof(float)),       \</span>
<a name="l00193"></a>00193 <span class="preprocessor">                         (x))</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span><span class="preprocessor"># define HTOVF(x,y)     (memcpy(&amp;(y),&amp;(x),sizeof(float)),       \</span>
<a name="l00195"></a>00195 <span class="preprocessor">                         (y) = rb_htovf((FLOAT_SWAPPER)(y)),    \</span>
<a name="l00196"></a>00196 <span class="preprocessor">                         memcpy(&amp;(x),&amp;(y),sizeof(float)),       \</span>
<a name="l00197"></a>00197 <span class="preprocessor">                         (x))</span>
<a name="l00198"></a>00198 <span class="preprocessor"></span><span class="preprocessor"># define NTOHF(x,y)     (memcpy(&amp;(y),&amp;(x),sizeof(float)),       \</span>
<a name="l00199"></a>00199 <span class="preprocessor">                         (y) = rb_ntohf((FLOAT_SWAPPER)(y)),    \</span>
<a name="l00200"></a>00200 <span class="preprocessor">                         memcpy(&amp;(x),&amp;(y),sizeof(float)),       \</span>
<a name="l00201"></a>00201 <span class="preprocessor">                         (x))</span>
<a name="l00202"></a>00202 <span class="preprocessor"></span><span class="preprocessor"># define VTOHF(x,y)     (memcpy(&amp;(y),&amp;(x),sizeof(float)),       \</span>
<a name="l00203"></a>00203 <span class="preprocessor">                         (y) = rb_vtohf((FLOAT_SWAPPER)(y)),    \</span>
<a name="l00204"></a>00204 <span class="preprocessor">                         memcpy(&amp;(x),&amp;(y),sizeof(float)),       \</span>
<a name="l00205"></a>00205 <span class="preprocessor">                         (x))</span>
<a name="l00206"></a>00206 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00207"></a>00207 <span class="preprocessor"></span><span class="preprocessor"># define FLOAT_CONVWITH(y)</span>
<a name="l00208"></a>00208 <span class="preprocessor"></span><span class="preprocessor"># define HTONF(x,y)     rb_htonf(x)</span>
<a name="l00209"></a>00209 <span class="preprocessor"></span><span class="preprocessor"># define HTOVF(x,y)     rb_htovf(x)</span>
<a name="l00210"></a>00210 <span class="preprocessor"></span><span class="preprocessor"># define NTOHF(x,y)     rb_ntohf(x)</span>
<a name="l00211"></a>00211 <span class="preprocessor"></span><span class="preprocessor"># define VTOHF(x,y)     rb_vtohf(x)</span>
<a name="l00212"></a>00212 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00213"></a>00213 <span class="preprocessor"></span>
<a name="l00214"></a>00214 <span class="preprocessor">#ifdef DOUBLE_SWAPPER</span>
<a name="l00215"></a>00215 <span class="preprocessor"></span><span class="preprocessor"># define DOUBLE_CONVWITH(y)     DOUBLE_SWAPPER y;</span>
<a name="l00216"></a>00216 <span class="preprocessor"></span><span class="preprocessor"># define HTOND(x,y)     (memcpy(&amp;(y),&amp;(x),sizeof(double)),      \</span>
<a name="l00217"></a>00217 <span class="preprocessor">                         (y) = rb_htond((DOUBLE_SWAPPER)(y)),   \</span>
<a name="l00218"></a>00218 <span class="preprocessor">                         memcpy(&amp;(x),&amp;(y),sizeof(double)),      \</span>
<a name="l00219"></a>00219 <span class="preprocessor">                         (x))</span>
<a name="l00220"></a>00220 <span class="preprocessor"></span><span class="preprocessor"># define HTOVD(x,y)     (memcpy(&amp;(y),&amp;(x),sizeof(double)),      \</span>
<a name="l00221"></a>00221 <span class="preprocessor">                         (y) = rb_htovd((DOUBLE_SWAPPER)(y)),   \</span>
<a name="l00222"></a>00222 <span class="preprocessor">                         memcpy(&amp;(x),&amp;(y),sizeof(double)),      \</span>
<a name="l00223"></a>00223 <span class="preprocessor">                         (x))</span>
<a name="l00224"></a>00224 <span class="preprocessor"></span><span class="preprocessor"># define NTOHD(x,y)     (memcpy(&amp;(y),&amp;(x),sizeof(double)),      \</span>
<a name="l00225"></a>00225 <span class="preprocessor">                         (y) = rb_ntohd((DOUBLE_SWAPPER)(y)),   \</span>
<a name="l00226"></a>00226 <span class="preprocessor">                         memcpy(&amp;(x),&amp;(y),sizeof(double)),      \</span>
<a name="l00227"></a>00227 <span class="preprocessor">                         (x))</span>
<a name="l00228"></a>00228 <span class="preprocessor"></span><span class="preprocessor"># define VTOHD(x,y)     (memcpy(&amp;(y),&amp;(x),sizeof(double)),      \</span>
<a name="l00229"></a>00229 <span class="preprocessor">                         (y) = rb_vtohd((DOUBLE_SWAPPER)(y)),   \</span>
<a name="l00230"></a>00230 <span class="preprocessor">                         memcpy(&amp;(x),&amp;(y),sizeof(double)),      \</span>
<a name="l00231"></a>00231 <span class="preprocessor">                         (x))</span>
<a name="l00232"></a>00232 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00233"></a>00233 <span class="preprocessor"></span><span class="preprocessor"># define DOUBLE_CONVWITH(y)</span>
<a name="l00234"></a>00234 <span class="preprocessor"></span><span class="preprocessor"># define HTOND(x,y)     rb_htond(x)</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span><span class="preprocessor"># define HTOVD(x,y)     rb_htovd(x)</span>
<a name="l00236"></a>00236 <span class="preprocessor"></span><span class="preprocessor"># define NTOHD(x,y)     rb_ntohd(x)</span>
<a name="l00237"></a>00237 <span class="preprocessor"></span><span class="preprocessor"># define VTOHD(x,y)     rb_vtohd(x)</span>
<a name="l00238"></a>00238 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00239"></a>00239 <span class="preprocessor"></span>
<a name="l00240"></a>00240 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>
<a name="l00241"></a>00241 num2i32(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> x)
<a name="l00242"></a>00242 {
<a name="l00243"></a>00243     x = <a class="code" href="../../db/d2e/intern_8h.html#ae98f9e6c1a4b5181ca48e36d06b3157b">rb_to_int</a>(x); <span class="comment">/* is nil OK? (should not) */</span>
<a name="l00244"></a>00244 
<a name="l00245"></a>00245     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#acf2fcf97dcf9c7c35452730eb3e2aeb2">FIXNUM_P</a>(x)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae9390780cd6d04a2e0ac3d6282cdefea">FIX2LONG</a>(x);
<a name="l00246"></a>00246     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(x) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a41ac74a27dd1eadc2ca86d10590f2163">T_BIGNUM</a>) {
<a name="l00247"></a>00247         <span class="keywordflow">return</span> <a class="code" href="../../d1/dcc/bignum_8c.html#a526835b7dfb6ff67195413c09c7672d2">rb_big2ulong_pack</a>(x);
<a name="l00248"></a>00248     }
<a name="l00249"></a>00249     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a565ed9d70f4089e1b4a36e9b3381b8c6">rb_eTypeError</a>, <span class="stringliteral">&quot;can&apos;t convert %s to `integer&apos;&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9b4f42ada717bfbe7a78830639476aed">rb_obj_classname</a>(x));
<a name="l00250"></a>00250     <span class="keywordflow">return</span> 0;                   <span class="comment">/* not reached */</span>
<a name="l00251"></a>00251 }
<a name="l00252"></a>00252 
<a name="l00253"></a><a class="code" href="../../d1/d7d/pack_8c.html#a9bff5a43748b01cca699f5a0a4ccff05">00253</a> <span class="preprocessor">#define MAX_INTEGER_PACK_SIZE 8</span>
<a name="l00254"></a>00254 <span class="preprocessor"></span><span class="comment">/* #define FORCE_BIG_PACK */</span>
<a name="l00255"></a>00255 
<a name="l00256"></a><a class="code" href="../../d1/d7d/pack_8c.html#a247a4519476d17f6538818569985d0a0">00256</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="../../d1/d7d/pack_8c.html#a247a4519476d17f6538818569985d0a0">toofew</a>[] = <span class="stringliteral">&quot;too few arguments&quot;</span>;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d7d/pack_8c.html#aec39f4653ccc94226bc3a321fcc18bc2">encodes</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>,<span class="keyword">const</span> <span class="keywordtype">char</span>*,<span class="keywordtype">long</span>,<span class="keywordtype">int</span>,<span class="keywordtype">int</span>);
<a name="l00259"></a>00259 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d1/d7d/pack_8c.html#a44babce3c1805d72e7a6d064b77d569a">qpencode</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>,<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>,<span class="keywordtype">long</span>);
<a name="l00260"></a>00260 
<a name="l00261"></a>00261 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="../../d1/d7d/pack_8c.html#af5486696d49eda881dc03ff113431bc5">utf8_to_uv</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>*,<span class="keywordtype">long</span>*);
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <span class="comment">/*</span>
<a name="l00264"></a>00264 <span class="comment"> *  call-seq:</span>
<a name="l00265"></a>00265 <span class="comment"> *     arr.pack ( aTemplateString ) -&gt; aBinaryString</span>
<a name="l00266"></a>00266 <span class="comment"> *</span>
<a name="l00267"></a>00267 <span class="comment"> *  Packs the contents of &lt;i&gt;arr&lt;/i&gt; into a binary sequence according to</span>
<a name="l00268"></a>00268 <span class="comment"> *  the directives in &lt;i&gt;aTemplateString&lt;/i&gt; (see the table below)</span>
<a name="l00269"></a>00269 <span class="comment"> *  Directives ``A,&apos;&apos; ``a,&apos;&apos; and ``Z&apos;&apos; may be followed by a count,</span>
<a name="l00270"></a>00270 <span class="comment"> *  which gives the width of the resulting field. The remaining</span>
<a name="l00271"></a>00271 <span class="comment"> *  directives also may take a count, indicating the number of array</span>
<a name="l00272"></a>00272 <span class="comment"> *  elements to convert. If the count is an asterisk</span>
<a name="l00273"></a>00273 <span class="comment"> *  (``&lt;code&gt;*&lt;/code&gt;&apos;&apos;), all remaining array elements will be</span>
<a name="l00274"></a>00274 <span class="comment"> *  converted. Any of the directives ``&lt;code&gt;sSiIlL&lt;/code&gt;&apos;&apos; may be</span>
<a name="l00275"></a>00275 <span class="comment"> *  followed by an underscore (``&lt;code&gt;_&lt;/code&gt;&apos;&apos;) or</span>
<a name="l00276"></a>00276 <span class="comment"> *  exclamation mark (``&lt;code&gt;!&lt;/code&gt;&apos;&apos;) to use the underlying</span>
<a name="l00277"></a>00277 <span class="comment"> *  platform&apos;s native size for the specified type; otherwise, they use a</span>
<a name="l00278"></a>00278 <span class="comment"> *  platform-independent size. Spaces are ignored in the template</span>
<a name="l00279"></a>00279 <span class="comment"> *  string. See also &lt;code&gt;String#unpack&lt;/code&gt;.</span>
<a name="l00280"></a>00280 <span class="comment"> *</span>
<a name="l00281"></a>00281 <span class="comment"> *     a = [ &quot;a&quot;, &quot;b&quot;, &quot;c&quot; ]</span>
<a name="l00282"></a>00282 <span class="comment"> *     n = [ 65, 66, 67 ]</span>
<a name="l00283"></a>00283 <span class="comment"> *     a.pack(&quot;A3A3A3&quot;)   #=&gt; &quot;a  b  c  &quot;</span>
<a name="l00284"></a>00284 <span class="comment"> *     a.pack(&quot;a3a3a3&quot;)   #=&gt; &quot;a\000\000b\000\000c\000\000&quot;</span>
<a name="l00285"></a>00285 <span class="comment"> *     n.pack(&quot;ccc&quot;)      #=&gt; &quot;ABC&quot;</span>
<a name="l00286"></a>00286 <span class="comment"> *</span>
<a name="l00287"></a>00287 <span class="comment"> *  Directives for +pack+.</span>
<a name="l00288"></a>00288 <span class="comment"> *</span>
<a name="l00289"></a>00289 <span class="comment"> *   Integer      | Array   |</span>
<a name="l00290"></a>00290 <span class="comment"> *   Directive    | Element | Meaning</span>
<a name="l00291"></a>00291 <span class="comment"> *   ---------------------------------------------------------------------------</span>
<a name="l00292"></a>00292 <span class="comment"> *      C         | Integer | 8-bit unsigned (unsigned char)</span>
<a name="l00293"></a>00293 <span class="comment"> *      S         | Integer | 16-bit unsigned, native endian (uint16_t)</span>
<a name="l00294"></a>00294 <span class="comment"> *      L         | Integer | 32-bit unsigned, native endian (uint32_t)</span>
<a name="l00295"></a>00295 <span class="comment"> *      Q         | Integer | 64-bit unsigned, native endian (uint64_t)</span>
<a name="l00296"></a>00296 <span class="comment"> *                |         |</span>
<a name="l00297"></a>00297 <span class="comment"> *      c         | Integer | 8-bit signed (signed char)</span>
<a name="l00298"></a>00298 <span class="comment"> *      s         | Integer | 16-bit signed, native endian (int16_t)</span>
<a name="l00299"></a>00299 <span class="comment"> *      l         | Integer | 32-bit signed, native endian (int32_t)</span>
<a name="l00300"></a>00300 <span class="comment"> *      q         | Integer | 64-bit signed, native endian (int64_t)</span>
<a name="l00301"></a>00301 <span class="comment"> *                |         |</span>
<a name="l00302"></a>00302 <span class="comment"> *      S_, S!    | Integer | unsigned short, native endian</span>
<a name="l00303"></a>00303 <span class="comment"> *      I, I_, I! | Integer | unsigned int, native endian</span>
<a name="l00304"></a>00304 <span class="comment"> *      L_, L!    | Integer | unsigned long, native endian</span>
<a name="l00305"></a>00305 <span class="comment"> *                |         |</span>
<a name="l00306"></a>00306 <span class="comment"> *      s_, s!    | Integer | signed short, native endian</span>
<a name="l00307"></a>00307 <span class="comment"> *      i, i_, i! | Integer | signed int, native endian</span>
<a name="l00308"></a>00308 <span class="comment"> *      l_, l!    | Integer | signed long, native endian</span>
<a name="l00309"></a>00309 <span class="comment"> *                |         |</span>
<a name="l00310"></a>00310 <span class="comment"> *      S&gt; L&gt; Q&gt;  | Integer | same as the directives without &quot;&gt;&quot; except</span>
<a name="l00311"></a>00311 <span class="comment"> *      s&gt; l&gt; q&gt;  |         | big endian</span>
<a name="l00312"></a>00312 <span class="comment"> *      S!&gt; I!&gt;   |         | (available since Ruby 1.9.3)</span>
<a name="l00313"></a>00313 <span class="comment"> *      L!&gt;       |         | &quot;S&gt;&quot; is same as &quot;n&quot;</span>
<a name="l00314"></a>00314 <span class="comment"> *      s!&gt; i!&gt;   |         | &quot;L&gt;&quot; is same as &quot;N&quot;</span>
<a name="l00315"></a>00315 <span class="comment"> *      l!&gt;       |         |</span>
<a name="l00316"></a>00316 <span class="comment"> *                |         |</span>
<a name="l00317"></a>00317 <span class="comment"> *      S&lt; L&lt; Q&lt;  | Integer | same as the directives without &quot;&lt;&quot; except</span>
<a name="l00318"></a>00318 <span class="comment"> *      s&lt; l&lt; q&lt;  |         | little endian</span>
<a name="l00319"></a>00319 <span class="comment"> *      S!&lt; I!&lt;   |         | (available since Ruby 1.9.3)</span>
<a name="l00320"></a>00320 <span class="comment"> *      L!&lt;       |         | &quot;S&lt;&quot; is same as &quot;v&quot;</span>
<a name="l00321"></a>00321 <span class="comment"> *      s!&lt; i!&lt;   |         | &quot;L&lt;&quot; is same as &quot;V&quot;</span>
<a name="l00322"></a>00322 <span class="comment"> *      l!&lt;       |         |</span>
<a name="l00323"></a>00323 <span class="comment"> *                |         |</span>
<a name="l00324"></a>00324 <span class="comment"> *      n         | Integer | 16-bit unsigned, network (big-endian) byte order</span>
<a name="l00325"></a>00325 <span class="comment"> *      N         | Integer | 32-bit unsigned, network (big-endian) byte order</span>
<a name="l00326"></a>00326 <span class="comment"> *      v         | Integer | 16-bit unsigned, VAX (little-endian) byte order</span>
<a name="l00327"></a>00327 <span class="comment"> *      V         | Integer | 32-bit unsigned, VAX (little-endian) byte order</span>
<a name="l00328"></a>00328 <span class="comment"> *                |         |</span>
<a name="l00329"></a>00329 <span class="comment"> *      U         | Integer | UTF-8 character</span>
<a name="l00330"></a>00330 <span class="comment"> *      w         | Integer | BER-compressed integer</span>
<a name="l00331"></a>00331 <span class="comment"> *</span>
<a name="l00332"></a>00332 <span class="comment"> *   Float        |         |</span>
<a name="l00333"></a>00333 <span class="comment"> *   Directive    |         | Meaning</span>
<a name="l00334"></a>00334 <span class="comment"> *   ---------------------------------------------------------------------------</span>
<a name="l00335"></a>00335 <span class="comment"> *      D, d      | Float   | double-precision, native format</span>
<a name="l00336"></a>00336 <span class="comment"> *      F, f      | Float   | single-precision, native format</span>
<a name="l00337"></a>00337 <span class="comment"> *      E         | Float   | double-precision, little-endian byte order</span>
<a name="l00338"></a>00338 <span class="comment"> *      e         | Float   | single-precision, little-endian byte order</span>
<a name="l00339"></a>00339 <span class="comment"> *      G         | Float   | double-precision, network (big-endian) byte order</span>
<a name="l00340"></a>00340 <span class="comment"> *      g         | Float   | single-precision, network (big-endian) byte order</span>
<a name="l00341"></a>00341 <span class="comment"> *</span>
<a name="l00342"></a>00342 <span class="comment"> *   String       |         |</span>
<a name="l00343"></a>00343 <span class="comment"> *   Directive    |         | Meaning</span>
<a name="l00344"></a>00344 <span class="comment"> *   ---------------------------------------------------------------------------</span>
<a name="l00345"></a>00345 <span class="comment"> *      A         | String  | arbitrary binary string (space padded, count is width)</span>
<a name="l00346"></a>00346 <span class="comment"> *      a         | String  | arbitrary binary string (null padded, count is width)</span>
<a name="l00347"></a>00347 <span class="comment"> *      Z         | String  | same as ``a&apos;&apos;, except that null is added with *</span>
<a name="l00348"></a>00348 <span class="comment"> *      B         | String  | bit string (MSB first)</span>
<a name="l00349"></a>00349 <span class="comment"> *      b         | String  | bit string (LSB first)</span>
<a name="l00350"></a>00350 <span class="comment"> *      H         | String  | hex string (high nibble first)</span>
<a name="l00351"></a>00351 <span class="comment"> *      h         | String  | hex string (low nibble first)</span>
<a name="l00352"></a>00352 <span class="comment"> *      u         | String  | UU-encoded string</span>
<a name="l00353"></a>00353 <span class="comment"> *      M         | String  | quoted printable, MIME encoding (see RFC2045)</span>
<a name="l00354"></a>00354 <span class="comment"> *      m         | String  | base64 encoded string (see RFC 2045, count is width)</span>
<a name="l00355"></a>00355 <span class="comment"> *                |         | (if count is 0, no line feed are added, see RFC 4648)</span>
<a name="l00356"></a>00356 <span class="comment"> *      P         | String  | pointer to a structure (fixed-length string)</span>
<a name="l00357"></a>00357 <span class="comment"> *      p         | String  | pointer to a null-terminated string</span>
<a name="l00358"></a>00358 <span class="comment"> *</span>
<a name="l00359"></a>00359 <span class="comment"> *   Misc.        |         |</span>
<a name="l00360"></a>00360 <span class="comment"> *   Directive    |         | Meaning</span>
<a name="l00361"></a>00361 <span class="comment"> *   ---------------------------------------------------------------------------</span>
<a name="l00362"></a>00362 <span class="comment"> *      @         | ---     | moves to absolute position</span>
<a name="l00363"></a>00363 <span class="comment"> *      X         | ---     | back up a byte</span>
<a name="l00364"></a>00364 <span class="comment"> *      x         | ---     | null byte</span>
<a name="l00365"></a>00365 <span class="comment"> */</span>
<a name="l00366"></a>00366 
<a name="l00367"></a>00367 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00368"></a><a class="code" href="../../d1/d7d/pack_8c.html#af2d08e4a0e0ad79772645375d4db9e78">00368</a> <a class="code" href="../../d1/d7d/pack_8c.html#af2d08e4a0e0ad79772645375d4db9e78">pack_pack</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> fmt)
<a name="l00369"></a>00369 {
<a name="l00370"></a>00370     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> nul10[] = <span class="stringliteral">&quot;\0\0\0\0\0\0\0\0\0\0&quot;</span>;
<a name="l00371"></a>00371     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> spc10[] = <span class="stringliteral">&quot;          &quot;</span>;
<a name="l00372"></a>00372     <span class="keyword">const</span> <span class="keywordtype">char</span> *p, *pend;
<a name="l00373"></a>00373     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> res, from, associates = 0;
<a name="l00374"></a>00374     <span class="keywordtype">char</span> <a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>;
<a name="l00375"></a>00375     <span class="keywordtype">long</span> items, <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, idx, plen;
<a name="l00376"></a>00376     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr;
<a name="l00377"></a>00377     <span class="keywordtype">int</span> enc_info = 1;           <span class="comment">/* 0 - BINARY, 1 - US-ASCII, 2 - UTF-8 */</span>
<a name="l00378"></a>00378 <span class="preprocessor">#ifdef NATINT_PACK</span>
<a name="l00379"></a>00379 <span class="preprocessor"></span>    <span class="keywordtype">int</span> natint;         <span class="comment">/* native integer */</span>
<a name="l00380"></a>00380 <span class="preprocessor">#endif</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span>    <span class="keywordtype">int</span> signed_p, integer_size, bigendian_p;
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(fmt);
<a name="l00384"></a>00384     p = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(fmt);
<a name="l00385"></a>00385     pend = p + <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(fmt);
<a name="l00386"></a>00386     res = <a class="code" href="../../db/d2e/intern_8h.html#a65dee742ae2daaab92ac8974cb2fbff2">rb_str_buf_new</a>(0);
<a name="l00387"></a>00387 
<a name="l00388"></a>00388     items = <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(ary);
<a name="l00389"></a>00389     idx = 0;
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 <span class="preprocessor">#define TOO_FEW (rb_raise(rb_eArgError, toofew), 0)</span>
<a name="l00392"></a>00392 <span class="preprocessor"></span><span class="preprocessor">#define THISFROM (items &gt; 0 ? RARRAY_PTR(ary)[idx] : TOO_FEW)</span>
<a name="l00393"></a>00393 <span class="preprocessor"></span><span class="preprocessor">#define NEXTFROM (items-- &gt; 0 ? RARRAY_PTR(ary)[idx++] : TOO_FEW)</span>
<a name="l00394"></a>00394 <span class="preprocessor"></span>
<a name="l00395"></a>00395     <span class="keywordflow">while</span> (p &lt; pend) {
<a name="l00396"></a>00396         <span class="keywordtype">int</span> explicit_endian = 0;
<a name="l00397"></a>00397         <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(fmt) + <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(fmt) != pend) {
<a name="l00398"></a>00398             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a95ad3953d535707e2cf2b1d837f5e253">rb_eRuntimeError</a>, <span class="stringliteral">&quot;format string modified&quot;</span>);
<a name="l00399"></a>00399         }
<a name="l00400"></a>00400         type = *p++;            <span class="comment">/* get data type */</span>
<a name="l00401"></a>00401 <span class="preprocessor">#ifdef NATINT_PACK</span>
<a name="l00402"></a>00402 <span class="preprocessor"></span>        natint = 0;
<a name="l00403"></a>00403 <span class="preprocessor">#endif</span>
<a name="l00404"></a>00404 <span class="preprocessor"></span>
<a name="l00405"></a>00405         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae8cdc17e44905c826bddf416b7bf621c">ISSPACE</a>(type)) <span class="keywordflow">continue</span>;
<a name="l00406"></a>00406         <span class="keywordflow">if</span> (type == <span class="charliteral">&apos;#&apos;</span>) {
<a name="l00407"></a>00407             <span class="keywordflow">while</span> ((p &lt; pend) &amp;&amp; (*p != <span class="charliteral">&apos;\n&apos;</span>)) {
<a name="l00408"></a>00408                 p++;
<a name="l00409"></a>00409             }
<a name="l00410"></a>00410             <span class="keywordflow">continue</span>;
<a name="l00411"></a>00411         }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413         {
<a name="l00414"></a>00414             <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> natstr[] = <span class="stringliteral">&quot;sSiIlL&quot;</span>;
<a name="l00415"></a>00415             <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> endstr[] = <span class="stringliteral">&quot;sSiIlLqQ&quot;</span>;
<a name="l00416"></a>00416 
<a name="l00417"></a>00417           modifiers:
<a name="l00418"></a>00418             <span class="keywordflow">switch</span> (*p) {
<a name="l00419"></a>00419               <span class="keywordflow">case</span> <span class="charliteral">&apos;_&apos;</span>:
<a name="l00420"></a>00420               <span class="keywordflow">case</span> <span class="charliteral">&apos;!&apos;</span>:
<a name="l00421"></a>00421                 <span class="keywordflow">if</span> (<a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(natstr, type)) {
<a name="l00422"></a>00422 <span class="preprocessor">#ifdef NATINT_PACK</span>
<a name="l00423"></a>00423 <span class="preprocessor"></span>                    natint = 1;
<a name="l00424"></a>00424 <span class="preprocessor">#endif</span>
<a name="l00425"></a>00425 <span class="preprocessor"></span>                    p++;
<a name="l00426"></a>00426                 }
<a name="l00427"></a>00427                 <span class="keywordflow">else</span> {
<a name="l00428"></a>00428                     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;&apos;%c&apos; allowed only after types %s&quot;</span>, *p, natstr);
<a name="l00429"></a>00429                 }
<a name="l00430"></a>00430                 <span class="keywordflow">goto</span> modifiers;
<a name="l00431"></a>00431 
<a name="l00432"></a>00432               <span class="keywordflow">case</span> <span class="charliteral">&apos;&lt;&apos;</span>:
<a name="l00433"></a>00433               <span class="keywordflow">case</span> <span class="charliteral">&apos;&gt;&apos;</span>:
<a name="l00434"></a>00434                 <span class="keywordflow">if</span> (!<a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(endstr, type)) {
<a name="l00435"></a>00435                     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;&apos;%c&apos; allowed only after types %s&quot;</span>, *p, endstr);
<a name="l00436"></a>00436                 }
<a name="l00437"></a>00437                 <span class="keywordflow">if</span> (explicit_endian) {
<a name="l00438"></a>00438                     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a5211161e80760c30e2e009ae0bee7be8">rb_eRangeError</a>, <span class="stringliteral">&quot;Can&apos;t use both &apos;&lt;&apos; and &apos;&gt;&apos;&quot;</span>);
<a name="l00439"></a>00439                 }
<a name="l00440"></a>00440                 explicit_endian = *p++;
<a name="l00441"></a>00441                 <span class="keywordflow">goto</span> modifiers;
<a name="l00442"></a>00442             }
<a name="l00443"></a>00443         }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445         <span class="keywordflow">if</span> (*p == <span class="charliteral">&apos;*&apos;</span>) {        <span class="comment">/* set data length */</span>
<a name="l00446"></a>00446             len = <a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(<span class="stringliteral">&quot;@Xxu&quot;</span>, type) ? 0
<a name="l00447"></a>00447                 : <a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(<span class="stringliteral">&quot;PMm&quot;</span>, type) ? 1
<a name="l00448"></a>00448                 : items;
<a name="l00449"></a>00449             p++;
<a name="l00450"></a>00450         }
<a name="l00451"></a>00451         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/dcc/bignum_8c.html#ab615ddd0d086b80219cd7e0345d6b5ef">ISDIGIT</a>(*p)) {
<a name="l00452"></a>00452             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0;
<a name="l00453"></a>00453             len = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1da69daf7d0b9dfe25ed7bd614bab9c7">STRTOUL</a>(p, (<span class="keywordtype">char</span>**)&amp;p, 10);
<a name="l00454"></a>00454             <span class="keywordflow">if</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l00455"></a>00455                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a5211161e80760c30e2e009ae0bee7be8">rb_eRangeError</a>, <span class="stringliteral">&quot;pack length too big&quot;</span>);
<a name="l00456"></a>00456             }
<a name="l00457"></a>00457         }
<a name="l00458"></a>00458         <span class="keywordflow">else</span> {
<a name="l00459"></a>00459             len = 1;
<a name="l00460"></a>00460         }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462         <span class="keywordflow">switch</span> (type) {
<a name="l00463"></a>00463           <span class="keywordflow">case</span> <span class="charliteral">&apos;U&apos;</span>:
<a name="l00464"></a>00464             <span class="comment">/* if encoding is US-ASCII, upgrade to UTF-8 */</span>
<a name="l00465"></a>00465             <span class="keywordflow">if</span> (enc_info == 1) enc_info = 2;
<a name="l00466"></a>00466             <span class="keywordflow">break</span>;
<a name="l00467"></a>00467           <span class="keywordflow">case</span> <span class="charliteral">&apos;m&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;M&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;u&apos;</span>:
<a name="l00468"></a>00468             <span class="comment">/* keep US-ASCII (do nothing) */</span>
<a name="l00469"></a>00469             <span class="keywordflow">break</span>;
<a name="l00470"></a>00470           <span class="keywordflow">default</span>:
<a name="l00471"></a>00471             <span class="comment">/* fall back to BINARY */</span>
<a name="l00472"></a>00472             enc_info = 0;
<a name="l00473"></a>00473             <span class="keywordflow">break</span>;
<a name="l00474"></a>00474         }
<a name="l00475"></a>00475         <span class="keywordflow">switch</span> (type) {
<a name="l00476"></a>00476           <span class="keywordflow">case</span> <span class="charliteral">&apos;A&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;a&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;Z&apos;</span>:
<a name="l00477"></a>00477           <span class="keywordflow">case</span> <span class="charliteral">&apos;B&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;b&apos;</span>:
<a name="l00478"></a>00478           <span class="keywordflow">case</span> <span class="charliteral">&apos;H&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;h&apos;</span>:
<a name="l00479"></a>00479             from = <a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>;
<a name="l00480"></a>00480             <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(from)) {
<a name="l00481"></a>00481                 ptr = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00482"></a>00482                 plen = 0;
<a name="l00483"></a>00483             }
<a name="l00484"></a>00484             <span class="keywordflow">else</span> {
<a name="l00485"></a>00485                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(from);
<a name="l00486"></a>00486                 ptr = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(from);
<a name="l00487"></a>00487                 plen = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(from);
<a name="l00488"></a>00488                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3bf9ab455a1e0e3e8cfc6ebabd8f12df">OBJ_INFECT</a>(res, from);
<a name="l00489"></a>00489             }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491             <span class="keywordflow">if</span> (p[-1] == <span class="charliteral">&apos;*&apos;</span>)
<a name="l00492"></a>00492                 len = plen;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494             <span class="keywordflow">switch</span> (type) {
<a name="l00495"></a>00495               <span class="keywordflow">case</span> <span class="charliteral">&apos;a&apos;</span>:         <span class="comment">/* arbitrary binary string (null padded)  */</span>
<a name="l00496"></a>00496               <span class="keywordflow">case</span> <span class="charliteral">&apos;A&apos;</span>:         <span class="comment">/* arbitrary binary string (ASCII space padded) */</span>
<a name="l00497"></a>00497               <span class="keywordflow">case</span> <span class="charliteral">&apos;Z&apos;</span>:         <span class="comment">/* null terminated string  */</span>
<a name="l00498"></a>00498                 <span class="keywordflow">if</span> (plen &gt;= len) {
<a name="l00499"></a>00499                     <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, ptr, len);
<a name="l00500"></a>00500                     <span class="keywordflow">if</span> (p[-1] == <span class="charliteral">&apos;*&apos;</span> &amp;&amp; type == <span class="charliteral">&apos;Z&apos;</span>)
<a name="l00501"></a>00501                         <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, nul10, 1);
<a name="l00502"></a>00502                 }
<a name="l00503"></a>00503                 <span class="keywordflow">else</span> {
<a name="l00504"></a>00504                     <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, ptr, plen);
<a name="l00505"></a>00505                     len -= plen;
<a name="l00506"></a>00506                     <span class="keywordflow">while</span> (len &gt;= 10) {
<a name="l00507"></a>00507                         <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, (type == <span class="charliteral">&apos;A&apos;</span>)?spc10:nul10, 10);
<a name="l00508"></a>00508                         len -= 10;
<a name="l00509"></a>00509                     }
<a name="l00510"></a>00510                     <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, (type == <span class="charliteral">&apos;A&apos;</span>)?spc10:nul10, len);
<a name="l00511"></a>00511                 }
<a name="l00512"></a>00512                 <span class="keywordflow">break</span>;
<a name="l00513"></a>00513 
<a name="l00514"></a>00514               <span class="keywordflow">case</span> <span class="charliteral">&apos;b&apos;</span>:         <span class="comment">/* bit string (ascending) */</span>
<a name="l00515"></a>00515                 {
<a name="l00516"></a>00516                     <span class="keywordtype">int</span> byte = 0;
<a name="l00517"></a>00517                     <span class="keywordtype">long</span> i, j = 0;
<a name="l00518"></a>00518 
<a name="l00519"></a>00519                     <span class="keywordflow">if</span> (len &gt; plen) {
<a name="l00520"></a>00520                         j = (len - plen + 1)/2;
<a name="l00521"></a>00521                         len = plen;
<a name="l00522"></a>00522                     }
<a name="l00523"></a>00523                     <span class="keywordflow">for</span> (i=0; i++ &lt; len; ptr++) {
<a name="l00524"></a>00524                         <span class="keywordflow">if</span> (*ptr &amp; 1)
<a name="l00525"></a>00525                             byte |= 128;
<a name="l00526"></a>00526                         <span class="keywordflow">if</span> (i &amp; 7)
<a name="l00527"></a>00527                             byte &gt;&gt;= 1;
<a name="l00528"></a>00528                         <span class="keywordflow">else</span> {
<a name="l00529"></a>00529                             <span class="keywordtype">char</span> c = byte &amp; 0xff;
<a name="l00530"></a>00530                             <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, &amp;c, 1);
<a name="l00531"></a>00531                             byte = 0;
<a name="l00532"></a>00532                         }
<a name="l00533"></a>00533                     }
<a name="l00534"></a>00534                     <span class="keywordflow">if</span> (len &amp; 7) {
<a name="l00535"></a>00535                         <span class="keywordtype">char</span> c;
<a name="l00536"></a>00536                         byte &gt;&gt;= 7 - (len &amp; 7);
<a name="l00537"></a>00537                         c = byte &amp; 0xff;
<a name="l00538"></a>00538                         <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, &amp;c, 1);
<a name="l00539"></a>00539                     }
<a name="l00540"></a>00540                     len = j;
<a name="l00541"></a>00541                     <span class="keywordflow">goto</span> grow;
<a name="l00542"></a>00542                 }
<a name="l00543"></a>00543                 <span class="keywordflow">break</span>;
<a name="l00544"></a>00544 
<a name="l00545"></a>00545               <span class="keywordflow">case</span> <span class="charliteral">&apos;B&apos;</span>:         <span class="comment">/* bit string (descending) */</span>
<a name="l00546"></a>00546                 {
<a name="l00547"></a>00547                     <span class="keywordtype">int</span> byte = 0;
<a name="l00548"></a>00548                     <span class="keywordtype">long</span> i, j = 0;
<a name="l00549"></a>00549 
<a name="l00550"></a>00550                     <span class="keywordflow">if</span> (len &gt; plen) {
<a name="l00551"></a>00551                         j = (len - plen + 1)/2;
<a name="l00552"></a>00552                         len = plen;
<a name="l00553"></a>00553                     }
<a name="l00554"></a>00554                     <span class="keywordflow">for</span> (i=0; i++ &lt; len; ptr++) {
<a name="l00555"></a>00555                         byte |= *ptr &amp; 1;
<a name="l00556"></a>00556                         <span class="keywordflow">if</span> (i &amp; 7)
<a name="l00557"></a>00557                             byte &lt;&lt;= 1;
<a name="l00558"></a>00558                         <span class="keywordflow">else</span> {
<a name="l00559"></a>00559                             <span class="keywordtype">char</span> c = byte &amp; 0xff;
<a name="l00560"></a>00560                             <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, &amp;c, 1);
<a name="l00561"></a>00561                             byte = 0;
<a name="l00562"></a>00562                         }
<a name="l00563"></a>00563                     }
<a name="l00564"></a>00564                     <span class="keywordflow">if</span> (len &amp; 7) {
<a name="l00565"></a>00565                         <span class="keywordtype">char</span> c;
<a name="l00566"></a>00566                         byte &lt;&lt;= 7 - (len &amp; 7);
<a name="l00567"></a>00567                         c = byte &amp; 0xff;
<a name="l00568"></a>00568                         <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, &amp;c, 1);
<a name="l00569"></a>00569                     }
<a name="l00570"></a>00570                     len = j;
<a name="l00571"></a>00571                     <span class="keywordflow">goto</span> grow;
<a name="l00572"></a>00572                 }
<a name="l00573"></a>00573                 <span class="keywordflow">break</span>;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575               <span class="keywordflow">case</span> <span class="charliteral">&apos;h&apos;</span>:         <span class="comment">/* hex string (low nibble first) */</span>
<a name="l00576"></a>00576                 {
<a name="l00577"></a>00577                     <span class="keywordtype">int</span> byte = 0;
<a name="l00578"></a>00578                     <span class="keywordtype">long</span> i, j = 0;
<a name="l00579"></a>00579 
<a name="l00580"></a>00580                     <span class="keywordflow">if</span> (len &gt; plen) {
<a name="l00581"></a>00581                         j = (len + 1) / 2 - (plen + 1) / 2;
<a name="l00582"></a>00582                         len = plen;
<a name="l00583"></a>00583                     }
<a name="l00584"></a>00584                     <span class="keywordflow">for</span> (i=0; i++ &lt; len; ptr++) {
<a name="l00585"></a>00585                         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afe0bf9496b5e0ecf253fb86072ee7ecf">ISALPHA</a>(*ptr))
<a name="l00586"></a>00586                             byte |= (((*ptr &amp; 15) + 9) &amp; 15) &lt;&lt; 4;
<a name="l00587"></a>00587                         <span class="keywordflow">else</span>
<a name="l00588"></a>00588                             byte |= (*ptr &amp; 15) &lt;&lt; 4;
<a name="l00589"></a>00589                         <span class="keywordflow">if</span> (i &amp; 1)
<a name="l00590"></a>00590                             byte &gt;&gt;= 4;
<a name="l00591"></a>00591                         <span class="keywordflow">else</span> {
<a name="l00592"></a>00592                             <span class="keywordtype">char</span> c = byte &amp; 0xff;
<a name="l00593"></a>00593                             <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, &amp;c, 1);
<a name="l00594"></a>00594                             byte = 0;
<a name="l00595"></a>00595                         }
<a name="l00596"></a>00596                     }
<a name="l00597"></a>00597                     <span class="keywordflow">if</span> (len &amp; 1) {
<a name="l00598"></a>00598                         <span class="keywordtype">char</span> c = byte &amp; 0xff;
<a name="l00599"></a>00599                         <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, &amp;c, 1);
<a name="l00600"></a>00600                     }
<a name="l00601"></a>00601                     len = j;
<a name="l00602"></a>00602                     <span class="keywordflow">goto</span> grow;
<a name="l00603"></a>00603                 }
<a name="l00604"></a>00604                 <span class="keywordflow">break</span>;
<a name="l00605"></a>00605 
<a name="l00606"></a>00606               <span class="keywordflow">case</span> <span class="charliteral">&apos;H&apos;</span>:         <span class="comment">/* hex string (high nibble first) */</span>
<a name="l00607"></a>00607                 {
<a name="l00608"></a>00608                     <span class="keywordtype">int</span> byte = 0;
<a name="l00609"></a>00609                     <span class="keywordtype">long</span> i, j = 0;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611                     <span class="keywordflow">if</span> (len &gt; plen) {
<a name="l00612"></a>00612                         j = (len + 1) / 2 - (plen + 1) / 2;
<a name="l00613"></a>00613                         len = plen;
<a name="l00614"></a>00614                     }
<a name="l00615"></a>00615                     <span class="keywordflow">for</span> (i=0; i++ &lt; len; ptr++) {
<a name="l00616"></a>00616                         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afe0bf9496b5e0ecf253fb86072ee7ecf">ISALPHA</a>(*ptr))
<a name="l00617"></a>00617                             byte |= ((*ptr &amp; 15) + 9) &amp; 15;
<a name="l00618"></a>00618                         <span class="keywordflow">else</span>
<a name="l00619"></a>00619                             byte |= *ptr &amp; 15;
<a name="l00620"></a>00620                         <span class="keywordflow">if</span> (i &amp; 1)
<a name="l00621"></a>00621                             byte &lt;&lt;= 4;
<a name="l00622"></a>00622                         <span class="keywordflow">else</span> {
<a name="l00623"></a>00623                             <span class="keywordtype">char</span> c = byte &amp; 0xff;
<a name="l00624"></a>00624                             <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, &amp;c, 1);
<a name="l00625"></a>00625                             byte = 0;
<a name="l00626"></a>00626                         }
<a name="l00627"></a>00627                     }
<a name="l00628"></a>00628                     <span class="keywordflow">if</span> (len &amp; 1) {
<a name="l00629"></a>00629                         <span class="keywordtype">char</span> c = byte &amp; 0xff;
<a name="l00630"></a>00630                         <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, &amp;c, 1);
<a name="l00631"></a>00631                     }
<a name="l00632"></a>00632                     len = j;
<a name="l00633"></a>00633                     <span class="keywordflow">goto</span> grow;
<a name="l00634"></a>00634                 }
<a name="l00635"></a>00635                 <span class="keywordflow">break</span>;
<a name="l00636"></a>00636             }
<a name="l00637"></a>00637             <span class="keywordflow">break</span>;
<a name="l00638"></a>00638 
<a name="l00639"></a>00639           <span class="keywordflow">case</span> <span class="charliteral">&apos;c&apos;</span>:             <span class="comment">/* signed char */</span>
<a name="l00640"></a>00640           <span class="keywordflow">case</span> <span class="charliteral">&apos;C&apos;</span>:             <span class="comment">/* unsigned char */</span>
<a name="l00641"></a>00641             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l00642"></a>00642                 <span class="keywordtype">char</span> c;
<a name="l00643"></a>00643 
<a name="l00644"></a>00644                 from = <a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>;
<a name="l00645"></a>00645                 c = (char)num2i32(from);
<a name="l00646"></a>00646                 <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, &amp;c, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
<a name="l00647"></a>00647             }
<a name="l00648"></a>00648             <span class="keywordflow">break</span>;
<a name="l00649"></a>00649 
<a name="l00650"></a>00650           <span class="keywordflow">case</span> <span class="charliteral">&apos;s&apos;</span>:             <span class="comment">/* signed short */</span>
<a name="l00651"></a>00651             signed_p = 1;
<a name="l00652"></a>00652             integer_size = <a class="code" href="../../d1/d7d/pack_8c.html#a43fde2e64181f2ee17a4e448a546010c">NATINT_LEN</a>(<span class="keywordtype">short</span>, 2);
<a name="l00653"></a>00653             bigendian_p = <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>();
<a name="l00654"></a>00654             <span class="keywordflow">goto</span> pack_integer;
<a name="l00655"></a>00655 
<a name="l00656"></a>00656           <span class="keywordflow">case</span> <span class="charliteral">&apos;S&apos;</span>:             <span class="comment">/* unsigned short */</span>
<a name="l00657"></a>00657             signed_p = 0;
<a name="l00658"></a>00658             integer_size = <a class="code" href="../../d1/d7d/pack_8c.html#a43fde2e64181f2ee17a4e448a546010c">NATINT_LEN</a>(<span class="keywordtype">short</span>, 2);
<a name="l00659"></a>00659             bigendian_p = <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>();
<a name="l00660"></a>00660             <span class="keywordflow">goto</span> pack_integer;
<a name="l00661"></a>00661 
<a name="l00662"></a>00662           <span class="keywordflow">case</span> <span class="charliteral">&apos;i&apos;</span>:             <span class="comment">/* signed int */</span>
<a name="l00663"></a>00663             signed_p = 1;
<a name="l00664"></a>00664             integer_size = (int)<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>);
<a name="l00665"></a>00665             bigendian_p = <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>();
<a name="l00666"></a>00666             <span class="keywordflow">goto</span> pack_integer;
<a name="l00667"></a>00667 
<a name="l00668"></a>00668           <span class="keywordflow">case</span> <span class="charliteral">&apos;I&apos;</span>:             <span class="comment">/* unsigned int */</span>
<a name="l00669"></a>00669             signed_p = 0;
<a name="l00670"></a>00670             integer_size = (int)<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>);
<a name="l00671"></a>00671             bigendian_p = <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>();
<a name="l00672"></a>00672             <span class="keywordflow">goto</span> pack_integer;
<a name="l00673"></a>00673 
<a name="l00674"></a>00674           <span class="keywordflow">case</span> <span class="charliteral">&apos;l&apos;</span>:             <span class="comment">/* signed long */</span>
<a name="l00675"></a>00675             signed_p = 1;
<a name="l00676"></a>00676             integer_size = <a class="code" href="../../d1/d7d/pack_8c.html#a43fde2e64181f2ee17a4e448a546010c">NATINT_LEN</a>(<span class="keywordtype">long</span>, 4);
<a name="l00677"></a>00677             bigendian_p = <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>();
<a name="l00678"></a>00678             <span class="keywordflow">goto</span> pack_integer;
<a name="l00679"></a>00679 
<a name="l00680"></a>00680           <span class="keywordflow">case</span> <span class="charliteral">&apos;L&apos;</span>:             <span class="comment">/* unsigned long */</span>
<a name="l00681"></a>00681             signed_p = 0;
<a name="l00682"></a>00682             integer_size = <a class="code" href="../../d1/d7d/pack_8c.html#a43fde2e64181f2ee17a4e448a546010c">NATINT_LEN</a>(<span class="keywordtype">long</span>, 4);
<a name="l00683"></a>00683             bigendian_p = <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>();
<a name="l00684"></a>00684             <span class="keywordflow">goto</span> pack_integer;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686           <span class="keywordflow">case</span> <span class="charliteral">&apos;q&apos;</span>:             <span class="comment">/* signed quad (64bit) int */</span>
<a name="l00687"></a>00687             signed_p = 1;
<a name="l00688"></a>00688             integer_size = 8;
<a name="l00689"></a>00689             bigendian_p = <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>();
<a name="l00690"></a>00690             <span class="keywordflow">goto</span> pack_integer;
<a name="l00691"></a>00691 
<a name="l00692"></a>00692           <span class="keywordflow">case</span> <span class="charliteral">&apos;Q&apos;</span>:             <span class="comment">/* unsigned quad (64bit) int */</span>
<a name="l00693"></a>00693             signed_p = 0;
<a name="l00694"></a>00694             integer_size = 8;
<a name="l00695"></a>00695             bigendian_p = <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>();
<a name="l00696"></a>00696             <span class="keywordflow">goto</span> pack_integer;
<a name="l00697"></a>00697 
<a name="l00698"></a>00698           <span class="keywordflow">case</span> <span class="charliteral">&apos;n&apos;</span>:             <span class="comment">/* unsigned short (network byte-order)  */</span>
<a name="l00699"></a>00699             signed_p = 0;
<a name="l00700"></a>00700             integer_size = 2;
<a name="l00701"></a>00701             bigendian_p = 1;
<a name="l00702"></a>00702             <span class="keywordflow">goto</span> pack_integer;
<a name="l00703"></a>00703 
<a name="l00704"></a>00704           <span class="keywordflow">case</span> <span class="charliteral">&apos;N&apos;</span>:             <span class="comment">/* unsigned long (network byte-order) */</span>
<a name="l00705"></a>00705             signed_p = 0;
<a name="l00706"></a>00706             integer_size = 4;
<a name="l00707"></a>00707             bigendian_p = 1;
<a name="l00708"></a>00708             <span class="keywordflow">goto</span> pack_integer;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710           <span class="keywordflow">case</span> <span class="charliteral">&apos;v&apos;</span>:             <span class="comment">/* unsigned short (VAX byte-order) */</span>
<a name="l00711"></a>00711             signed_p = 0;
<a name="l00712"></a>00712             integer_size = 2;
<a name="l00713"></a>00713             bigendian_p = 0;
<a name="l00714"></a>00714             <span class="keywordflow">goto</span> pack_integer;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716           <span class="keywordflow">case</span> <span class="charliteral">&apos;V&apos;</span>:             <span class="comment">/* unsigned long (VAX byte-order) */</span>
<a name="l00717"></a>00717             signed_p = 0;
<a name="l00718"></a>00718             integer_size = 4;
<a name="l00719"></a>00719             bigendian_p = 0;
<a name="l00720"></a>00720             <span class="keywordflow">goto</span> pack_integer;
<a name="l00721"></a>00721 
<a name="l00722"></a>00722           pack_integer:
<a name="l00723"></a>00723             <span class="keywordflow">if</span> (explicit_endian) {
<a name="l00724"></a>00724                 bigendian_p = explicit_endian == <span class="charliteral">&apos;&gt;&apos;</span>;
<a name="l00725"></a>00725             }
<a name="l00726"></a>00726 
<a name="l00727"></a>00727             <span class="keywordflow">switch</span> (integer_size) {
<a name="l00728"></a>00728 <span class="preprocessor">#if defined(HAVE_INT16_T) &amp;&amp; !defined(FORCE_BIG_PACK)</span>
<a name="l00729"></a>00729 <span class="preprocessor"></span>              <span class="keywordflow">case</span> SIZEOF_INT16_T:
<a name="l00730"></a>00730                 <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l00731"></a>00731                     <span class="keyword">union </span>{
<a name="l00732"></a>00732                         int16_t i;
<a name="l00733"></a>00733                         <span class="keywordtype">char</span> a[<span class="keyword">sizeof</span>(int16_t)];
<a name="l00734"></a>00734                     } v;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736                     from = <a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>;
<a name="l00737"></a>00737                     v.i = (int16_t)num2i32(from);
<a name="l00738"></a>00738                     <span class="keywordflow">if</span> (bigendian_p != <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>()) v.i = <a class="code" href="../../d1/d7d/pack_8c.html#a230ba4a10a19fd06db52f5a5ed957d2b">swap16</a>(v.i);
<a name="l00739"></a>00739                     <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, v.a, <span class="keyword">sizeof</span>(int16_t));
<a name="l00740"></a>00740                 }
<a name="l00741"></a>00741                 <span class="keywordflow">break</span>;
<a name="l00742"></a>00742 <span class="preprocessor">#endif</span>
<a name="l00743"></a>00743 <span class="preprocessor"></span>
<a name="l00744"></a>00744 <span class="preprocessor">#if defined(HAVE_INT32_T) &amp;&amp; !defined(FORCE_BIG_PACK)</span>
<a name="l00745"></a>00745 <span class="preprocessor"></span>              <span class="keywordflow">case</span> SIZEOF_INT32_T:
<a name="l00746"></a>00746                 <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l00747"></a>00747                     <span class="keyword">union </span>{
<a name="l00748"></a>00748                         int32_t i;
<a name="l00749"></a>00749                         <span class="keywordtype">char</span> a[<span class="keyword">sizeof</span>(int32_t)];
<a name="l00750"></a>00750                     } v;
<a name="l00751"></a>00751 
<a name="l00752"></a>00752                     from = <a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>;
<a name="l00753"></a>00753                     v.i = (int32_t)num2i32(from);
<a name="l00754"></a>00754                     <span class="keywordflow">if</span> (bigendian_p != <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>()) v.i = <a class="code" href="../../d1/d7d/pack_8c.html#a40f89812fbb971f324be796c9854a590">swap32</a>(v.i);
<a name="l00755"></a>00755                     <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, v.a, <span class="keyword">sizeof</span>(int32_t));
<a name="l00756"></a>00756                 }
<a name="l00757"></a>00757                 <span class="keywordflow">break</span>;
<a name="l00758"></a>00758 <span class="preprocessor">#endif</span>
<a name="l00759"></a>00759 <span class="preprocessor"></span>
<a name="l00760"></a>00760 <span class="preprocessor">#if defined(HAVE_INT64_T) &amp;&amp; SIZEOF_LONG == SIZEOF_INT64_T &amp;&amp; !defined(FORCE_BIG_PACK)</span>
<a name="l00761"></a>00761 <span class="preprocessor"></span>              <span class="keywordflow">case</span> SIZEOF_INT64_T:
<a name="l00762"></a>00762                 <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l00763"></a>00763                     <span class="keyword">union </span>{
<a name="l00764"></a>00764                         int64_t i;
<a name="l00765"></a>00765                         <span class="keywordtype">char</span> a[<span class="keyword">sizeof</span>(int64_t)];
<a name="l00766"></a>00766                     } v;
<a name="l00767"></a>00767 
<a name="l00768"></a>00768                     from = <a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>;
<a name="l00769"></a>00769                     v.i = num2i32(from); <span class="comment">/* can return 64bit value if SIZEOF_LONG == SIZEOF_INT64_T */</span>
<a name="l00770"></a>00770                     <span class="keywordflow">if</span> (bigendian_p != <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>()) v.i = swap64(v.i);
<a name="l00771"></a>00771                     <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, v.a, <span class="keyword">sizeof</span>(int64_t));
<a name="l00772"></a>00772                 }
<a name="l00773"></a>00773                 <span class="keywordflow">break</span>;
<a name="l00774"></a>00774 <span class="preprocessor">#endif</span>
<a name="l00775"></a>00775 <span class="preprocessor"></span>
<a name="l00776"></a>00776               <span class="keywordflow">default</span>:
<a name="l00777"></a>00777                 <span class="keywordflow">if</span> (integer_size &gt; <a class="code" href="../../d1/d7d/pack_8c.html#a9bff5a43748b01cca699f5a0a4ccff05">MAX_INTEGER_PACK_SIZE</a>)
<a name="l00778"></a>00778                     <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;unexpected intger size for pack: %d&quot;</span>, integer_size);
<a name="l00779"></a>00779                 <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l00780"></a>00780                     <span class="keyword">union </span>{
<a name="l00781"></a>00781                         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> i[(<a class="code" href="../../d1/d7d/pack_8c.html#a9bff5a43748b01cca699f5a0a4ccff05">MAX_INTEGER_PACK_SIZE</a>+SIZEOF_LONG-1)/SIZEOF_LONG];
<a name="l00782"></a>00782                         <span class="keywordtype">char</span> a[(<a class="code" href="../../d1/d7d/pack_8c.html#a9bff5a43748b01cca699f5a0a4ccff05">MAX_INTEGER_PACK_SIZE</a>+SIZEOF_LONG-1)/SIZEOF_LONG*SIZEOF_LONG];
<a name="l00783"></a>00783                     } v;
<a name="l00784"></a>00784                     <span class="keywordtype">int</span> num_longs = (integer_size+SIZEOF_LONG-1)/SIZEOF_LONG;
<a name="l00785"></a>00785                     <span class="keywordtype">int</span> i;
<a name="l00786"></a>00786 
<a name="l00787"></a>00787                     from = <a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>;
<a name="l00788"></a>00788                     <a class="code" href="../../d1/dcc/bignum_8c.html#ad3ac9992e7f6cc6ce07ea0ee59302aa8">rb_big_pack</a>(from, v.i, num_longs);
<a name="l00789"></a>00789                     <span class="keywordflow">if</span> (bigendian_p) {
<a name="l00790"></a>00790                         <span class="keywordflow">for</span> (i = 0; i &lt; num_longs/2; i++) {
<a name="l00791"></a>00791                             <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> t = v.i[i];
<a name="l00792"></a>00792                             v.i[i] = v.i[num_longs-1-i];
<a name="l00793"></a>00793                             v.i[num_longs-1-i] = t;
<a name="l00794"></a>00794                         }
<a name="l00795"></a>00795                     }
<a name="l00796"></a>00796                     <span class="keywordflow">if</span> (bigendian_p != <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>()) {
<a name="l00797"></a>00797                         <span class="keywordflow">for</span> (i = 0; i &lt; num_longs; i++)
<a name="l00798"></a>00798                             v.i[i] = swapl(v.i[i]);
<a name="l00799"></a>00799                     }
<a name="l00800"></a>00800                     <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res,
<a name="l00801"></a>00801                                    bigendian_p ?
<a name="l00802"></a>00802                                      v.a + <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>)*num_longs - integer_size :
<a name="l00803"></a>00803                                      v.a,
<a name="l00804"></a>00804                                    integer_size);
<a name="l00805"></a>00805                 }
<a name="l00806"></a>00806                 <span class="keywordflow">break</span>;
<a name="l00807"></a>00807             }
<a name="l00808"></a>00808             <span class="keywordflow">break</span>;
<a name="l00809"></a>00809 
<a name="l00810"></a>00810           <span class="keywordflow">case</span> <span class="charliteral">&apos;f&apos;</span>:             <span class="comment">/* single precision float in native format */</span>
<a name="l00811"></a>00811           <span class="keywordflow">case</span> <span class="charliteral">&apos;F&apos;</span>:             <span class="comment">/* ditto */</span>
<a name="l00812"></a>00812             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l00813"></a>00813                 <span class="keywordtype">float</span> f;
<a name="l00814"></a>00814 
<a name="l00815"></a>00815                 from = <a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>;
<a name="l00816"></a>00816                 f = (float)<a class="code" href="../../d8/df4/generator_8h.html#a74258e532cd500e1cdfd6dcda7e97873">RFLOAT_VALUE</a>(<a class="code" href="../../db/d2e/intern_8h.html#a7fc6e036418db7ce57bd87bd9bef1bf5">rb_to_float</a>(from));
<a name="l00817"></a>00817                 <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, (<span class="keywordtype">char</span>*)&amp;f, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00818"></a>00818             }
<a name="l00819"></a>00819             <span class="keywordflow">break</span>;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821           <span class="keywordflow">case</span> <span class="charliteral">&apos;e&apos;</span>:             <span class="comment">/* single precision float in VAX byte-order */</span>
<a name="l00822"></a>00822             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l00823"></a>00823                 <span class="keywordtype">float</span> f;
<a name="l00824"></a>00824                 <a class="code" href="../../d1/d7d/pack_8c.html#af5b4a08285420f761188eb970aac5f2e">FLOAT_CONVWITH</a>(ftmp);
<a name="l00825"></a>00825 
<a name="l00826"></a>00826                 from = <a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>;
<a name="l00827"></a>00827                 f = (float)<a class="code" href="../../d8/df4/generator_8h.html#a74258e532cd500e1cdfd6dcda7e97873">RFLOAT_VALUE</a>(<a class="code" href="../../db/d2e/intern_8h.html#a7fc6e036418db7ce57bd87bd9bef1bf5">rb_to_float</a>(from));
<a name="l00828"></a>00828                 f = <a class="code" href="../../d1/d7d/pack_8c.html#adf9dfcdbd02b48a9cb6e2d77ce29c340">HTOVF</a>(f,ftmp);
<a name="l00829"></a>00829                 <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, (<span class="keywordtype">char</span>*)&amp;f, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00830"></a>00830             }
<a name="l00831"></a>00831             <span class="keywordflow">break</span>;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833           <span class="keywordflow">case</span> <span class="charliteral">&apos;E&apos;</span>:             <span class="comment">/* double precision float in VAX byte-order */</span>
<a name="l00834"></a>00834             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l00835"></a>00835                 <span class="keywordtype">double</span> d;
<a name="l00836"></a>00836                 <a class="code" href="../../d1/d7d/pack_8c.html#a5d9a17821872e6964ceaaf352e959e7b">DOUBLE_CONVWITH</a>(dtmp);
<a name="l00837"></a>00837 
<a name="l00838"></a>00838                 from = <a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>;
<a name="l00839"></a>00839                 d = <a class="code" href="../../d8/df4/generator_8h.html#a74258e532cd500e1cdfd6dcda7e97873">RFLOAT_VALUE</a>(<a class="code" href="../../db/d2e/intern_8h.html#a7fc6e036418db7ce57bd87bd9bef1bf5">rb_to_float</a>(from));
<a name="l00840"></a>00840                 d = <a class="code" href="../../d1/d7d/pack_8c.html#a5efa1bdaef062689f8de37c6b1c1ad1c">HTOVD</a>(d,dtmp);
<a name="l00841"></a>00841                 <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, (<span class="keywordtype">char</span>*)&amp;d, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00842"></a>00842             }
<a name="l00843"></a>00843             <span class="keywordflow">break</span>;
<a name="l00844"></a>00844 
<a name="l00845"></a>00845           <span class="keywordflow">case</span> <span class="charliteral">&apos;d&apos;</span>:             <span class="comment">/* double precision float in native format */</span>
<a name="l00846"></a>00846           <span class="keywordflow">case</span> <span class="charliteral">&apos;D&apos;</span>:             <span class="comment">/* ditto */</span>
<a name="l00847"></a>00847             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l00848"></a>00848                 <span class="keywordtype">double</span> d;
<a name="l00849"></a>00849 
<a name="l00850"></a>00850                 from = <a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>;
<a name="l00851"></a>00851                 d = <a class="code" href="../../d8/df4/generator_8h.html#a74258e532cd500e1cdfd6dcda7e97873">RFLOAT_VALUE</a>(<a class="code" href="../../db/d2e/intern_8h.html#a7fc6e036418db7ce57bd87bd9bef1bf5">rb_to_float</a>(from));
<a name="l00852"></a>00852                 <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, (<span class="keywordtype">char</span>*)&amp;d, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00853"></a>00853             }
<a name="l00854"></a>00854             <span class="keywordflow">break</span>;
<a name="l00855"></a>00855 
<a name="l00856"></a>00856           <span class="keywordflow">case</span> <span class="charliteral">&apos;g&apos;</span>:             <span class="comment">/* single precision float in network byte-order */</span>
<a name="l00857"></a>00857             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l00858"></a>00858                 <span class="keywordtype">float</span> f;
<a name="l00859"></a>00859                 <a class="code" href="../../d1/d7d/pack_8c.html#af5b4a08285420f761188eb970aac5f2e">FLOAT_CONVWITH</a>(ftmp);
<a name="l00860"></a>00860 
<a name="l00861"></a>00861                 from = <a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>;
<a name="l00862"></a>00862                 f = (float)<a class="code" href="../../d8/df4/generator_8h.html#a74258e532cd500e1cdfd6dcda7e97873">RFLOAT_VALUE</a>(<a class="code" href="../../db/d2e/intern_8h.html#a7fc6e036418db7ce57bd87bd9bef1bf5">rb_to_float</a>(from));
<a name="l00863"></a>00863                 f = <a class="code" href="../../d1/d7d/pack_8c.html#ae1c90d5dcb95490febf750109c0399fb">HTONF</a>(f,ftmp);
<a name="l00864"></a>00864                 <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, (<span class="keywordtype">char</span>*)&amp;f, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l00865"></a>00865             }
<a name="l00866"></a>00866             <span class="keywordflow">break</span>;
<a name="l00867"></a>00867 
<a name="l00868"></a>00868           <span class="keywordflow">case</span> <span class="charliteral">&apos;G&apos;</span>:             <span class="comment">/* double precision float in network byte-order */</span>
<a name="l00869"></a>00869             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l00870"></a>00870                 <span class="keywordtype">double</span> d;
<a name="l00871"></a>00871                 <a class="code" href="../../d1/d7d/pack_8c.html#a5d9a17821872e6964ceaaf352e959e7b">DOUBLE_CONVWITH</a>(dtmp);
<a name="l00872"></a>00872 
<a name="l00873"></a>00873                 from = <a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>;
<a name="l00874"></a>00874                 d = <a class="code" href="../../d8/df4/generator_8h.html#a74258e532cd500e1cdfd6dcda7e97873">RFLOAT_VALUE</a>(<a class="code" href="../../db/d2e/intern_8h.html#a7fc6e036418db7ce57bd87bd9bef1bf5">rb_to_float</a>(from));
<a name="l00875"></a>00875                 d = <a class="code" href="../../d1/d7d/pack_8c.html#a643d053f1942419ff7e220333e2e803b">HTOND</a>(d,dtmp);
<a name="l00876"></a>00876                 <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, (<span class="keywordtype">char</span>*)&amp;d, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l00877"></a>00877             }
<a name="l00878"></a>00878             <span class="keywordflow">break</span>;
<a name="l00879"></a>00879 
<a name="l00880"></a>00880           <span class="keywordflow">case</span> <span class="charliteral">&apos;x&apos;</span>:             <span class="comment">/* null byte */</span>
<a name="l00881"></a>00881           grow:
<a name="l00882"></a>00882             <span class="keywordflow">while</span> (len &gt;= 10) {
<a name="l00883"></a>00883                 <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, nul10, 10);
<a name="l00884"></a>00884                 len -= 10;
<a name="l00885"></a>00885             }
<a name="l00886"></a>00886             <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, nul10, len);
<a name="l00887"></a>00887             <span class="keywordflow">break</span>;
<a name="l00888"></a>00888 
<a name="l00889"></a>00889           <span class="keywordflow">case</span> <span class="charliteral">&apos;X&apos;</span>:             <span class="comment">/* back up byte */</span>
<a name="l00890"></a>00890           shrink:
<a name="l00891"></a>00891             plen = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(res);
<a name="l00892"></a>00892             <span class="keywordflow">if</span> (plen &lt; len)
<a name="l00893"></a>00893                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;X outside of string&quot;</span>);
<a name="l00894"></a>00894             <a class="code" href="../../d8/d81/ruby__missing_8h.html#a89ed8cb86ca6dd49d2db67adae809057">rb_str_set_len</a>(res, plen - len);
<a name="l00895"></a>00895             <span class="keywordflow">break</span>;
<a name="l00896"></a>00896 
<a name="l00897"></a>00897           <span class="keywordflow">case</span> <span class="charliteral">&apos;@&apos;</span>:             <span class="comment">/* null fill to absolute position */</span>
<a name="l00898"></a>00898             len -= <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(res);
<a name="l00899"></a>00899             <span class="keywordflow">if</span> (len &gt; 0) <span class="keywordflow">goto</span> grow;
<a name="l00900"></a>00900             len = -len;
<a name="l00901"></a>00901             <span class="keywordflow">if</span> (len &gt; 0) <span class="keywordflow">goto</span> shrink;
<a name="l00902"></a>00902             <span class="keywordflow">break</span>;
<a name="l00903"></a>00903 
<a name="l00904"></a>00904           <span class="keywordflow">case</span> <span class="charliteral">&apos;%&apos;</span>:
<a name="l00905"></a>00905             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;%% is not supported&quot;</span>);
<a name="l00906"></a>00906             <span class="keywordflow">break</span>;
<a name="l00907"></a>00907 
<a name="l00908"></a>00908           <span class="keywordflow">case</span> <span class="charliteral">&apos;U&apos;</span>:             <span class="comment">/* Unicode character */</span>
<a name="l00909"></a>00909             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l00910"></a>00910                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac1cf124db1e117ff7d61d608024f63ee">SIGNED_VALUE</a> l;
<a name="l00911"></a>00911                 <span class="keywordtype">char</span> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>[8];
<a name="l00912"></a>00912                 <span class="keywordtype">int</span> <a class="code" href="../../df/d73/time_8c.html#a52cb3a32b6f11cfde576472291abd769">le</a>;
<a name="l00913"></a>00913 
<a name="l00914"></a>00914                 from = <a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>;
<a name="l00915"></a>00915                 from = <a class="code" href="../../db/d2e/intern_8h.html#ae98f9e6c1a4b5181ca48e36d06b3157b">rb_to_int</a>(from);
<a name="l00916"></a>00916                 l = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(from);
<a name="l00917"></a>00917                 <span class="keywordflow">if</span> (l &lt; 0) {
<a name="l00918"></a>00918                     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a5211161e80760c30e2e009ae0bee7be8">rb_eRangeError</a>, <span class="stringliteral">&quot;pack(U): value out of range&quot;</span>);
<a name="l00919"></a>00919                 }
<a name="l00920"></a>00920                 le = <a class="code" href="../../db/d2e/intern_8h.html#af342a4146307dc4afb19e0b5ad1a3984">rb_uv_to_utf8</a>(buf, l);
<a name="l00921"></a>00921                 <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, (<span class="keywordtype">char</span>*)buf, le);
<a name="l00922"></a>00922             }
<a name="l00923"></a>00923             <span class="keywordflow">break</span>;
<a name="l00924"></a>00924 
<a name="l00925"></a>00925           <span class="keywordflow">case</span> <span class="charliteral">&apos;u&apos;</span>:             <span class="comment">/* uuencoded string */</span>
<a name="l00926"></a>00926           <span class="keywordflow">case</span> <span class="charliteral">&apos;m&apos;</span>:             <span class="comment">/* base64 encoded string */</span>
<a name="l00927"></a>00927             from = <a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>;
<a name="l00928"></a>00928             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(from);
<a name="l00929"></a>00929             ptr = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(from);
<a name="l00930"></a>00930             plen = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(from);
<a name="l00931"></a>00931 
<a name="l00932"></a>00932             <span class="keywordflow">if</span> (len == 0 &amp;&amp; type == <span class="charliteral">&apos;m&apos;</span>) {
<a name="l00933"></a>00933                 <a class="code" href="../../d1/d7d/pack_8c.html#aec39f4653ccc94226bc3a321fcc18bc2">encodes</a>(res, ptr, plen, type, 0);
<a name="l00934"></a>00934                 ptr += plen;
<a name="l00935"></a>00935                 <span class="keywordflow">break</span>;
<a name="l00936"></a>00936             }
<a name="l00937"></a>00937             <span class="keywordflow">if</span> (len &lt;= 2)
<a name="l00938"></a>00938                 len = 45;
<a name="l00939"></a>00939             <span class="keywordflow">else</span>
<a name="l00940"></a>00940                 len = len / 3 * 3;
<a name="l00941"></a>00941             <span class="keywordflow">while</span> (plen &gt; 0) {
<a name="l00942"></a>00942                 <span class="keywordtype">long</span> todo;
<a name="l00943"></a>00943 
<a name="l00944"></a>00944                 <span class="keywordflow">if</span> (plen &gt; len)
<a name="l00945"></a>00945                     todo = len;
<a name="l00946"></a>00946                 <span class="keywordflow">else</span>
<a name="l00947"></a>00947                     todo = plen;
<a name="l00948"></a>00948                 <a class="code" href="../../d1/d7d/pack_8c.html#aec39f4653ccc94226bc3a321fcc18bc2">encodes</a>(res, ptr, todo, type, 1);
<a name="l00949"></a>00949                 plen -= todo;
<a name="l00950"></a>00950                 ptr += todo;
<a name="l00951"></a>00951             }
<a name="l00952"></a>00952             <span class="keywordflow">break</span>;
<a name="l00953"></a>00953 
<a name="l00954"></a>00954           <span class="keywordflow">case</span> <span class="charliteral">&apos;M&apos;</span>:             <span class="comment">/* quoted-printable encoded string */</span>
<a name="l00955"></a>00955             from = <a class="code" href="../../db/d2e/intern_8h.html#acae5350f5d539c4654e4e33690256a9f">rb_obj_as_string</a>(<a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>);
<a name="l00956"></a>00956             <span class="keywordflow">if</span> (len &lt;= 1)
<a name="l00957"></a>00957                 len = 72;
<a name="l00958"></a>00958             <a class="code" href="../../d1/d7d/pack_8c.html#a44babce3c1805d72e7a6d064b77d569a">qpencode</a>(res, from, len);
<a name="l00959"></a>00959             <span class="keywordflow">break</span>;
<a name="l00960"></a>00960 
<a name="l00961"></a>00961           <span class="keywordflow">case</span> <span class="charliteral">&apos;P&apos;</span>:             <span class="comment">/* pointer to packed byte string */</span>
<a name="l00962"></a>00962             from = <a class="code" href="../../d1/d7d/pack_8c.html#ad87779abbc8c9eecb8b8f1bc3ca822a2">THISFROM</a>;
<a name="l00963"></a>00963             <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(from)) {
<a name="l00964"></a>00964                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(from);
<a name="l00965"></a>00965                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(from) &lt; len) {
<a name="l00966"></a>00966                     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;too short buffer for P(%ld for %ld)&quot;</span>,
<a name="l00967"></a>00967                              <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(from), len);
<a name="l00968"></a>00968                 }
<a name="l00969"></a>00969             }
<a name="l00970"></a>00970             len = 1;
<a name="l00971"></a>00971             <span class="comment">/* FALL THROUGH */</span>
<a name="l00972"></a>00972           <span class="keywordflow">case</span> <span class="charliteral">&apos;p&apos;</span>:             <span class="comment">/* pointer to string */</span>
<a name="l00973"></a>00973             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l00974"></a>00974                 <span class="keywordtype">char</span> *t;
<a name="l00975"></a>00975                 from = <a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>;
<a name="l00976"></a>00976                 <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(from)) {
<a name="l00977"></a>00977                     t = 0;
<a name="l00978"></a>00978                 }
<a name="l00979"></a>00979                 <span class="keywordflow">else</span> {
<a name="l00980"></a>00980                     t = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2665a51abbd5b49c15abff3df00fa9db">StringValuePtr</a>(from);
<a name="l00981"></a>00981                 }
<a name="l00982"></a>00982                 <span class="keywordflow">if</span> (!associates) {
<a name="l00983"></a>00983                     associates = <a class="code" href="../../dc/dcc/array_8c.html#a9518114fd36cb4ef4656ec1dc63348c9">rb_ary_new</a>();
<a name="l00984"></a>00984                 }
<a name="l00985"></a>00985                 <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(associates, from);
<a name="l00986"></a>00986                 <a class="code" href="../../db/d2e/intern_8h.html#ac576fb80a2fb4fcc3f359f75d0daf2bd">rb_obj_taint</a>(from);
<a name="l00987"></a>00987                 <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, (<span class="keywordtype">char</span>*)&amp;t, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>*));
<a name="l00988"></a>00988             }
<a name="l00989"></a>00989             <span class="keywordflow">break</span>;
<a name="l00990"></a>00990 
<a name="l00991"></a>00991           <span class="keywordflow">case</span> <span class="charliteral">&apos;w&apos;</span>:             <span class="comment">/* BER compressed integer  */</span>
<a name="l00992"></a>00992             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l00993"></a>00993                 <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ul;
<a name="l00994"></a>00994                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a> = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(0, 0);
<a name="l00995"></a>00995                 <span class="keywordtype">char</span> c, *bufs, *bufe;
<a name="l00996"></a>00996 
<a name="l00997"></a>00997                 from = <a class="code" href="../../d1/d7d/pack_8c.html#adcace0231ecb7876c368c16ba3f6327c">NEXTFROM</a>;
<a name="l00998"></a>00998                 <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(from) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a41ac74a27dd1eadc2ca86d10590f2163">T_BIGNUM</a>) {
<a name="l00999"></a>00999                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> big128 = <a class="code" href="../../d1/dcc/bignum_8c.html#afbcde0954c4494692919142fe48bf60c">rb_uint2big</a>(128);
<a name="l01000"></a>01000                     <span class="keywordflow">while</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(from) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a41ac74a27dd1eadc2ca86d10590f2163">T_BIGNUM</a>) {
<a name="l01001"></a>01001                         from = <a class="code" href="../../d1/dcc/bignum_8c.html#abbe46ceec250a75ee9e1c53c26b05020">rb_big_divmod</a>(from, big128);
<a name="l01002"></a>01002                         c = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(<a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(from)[1]) | 0x80; <span class="comment">/* mod */</span>
<a name="l01003"></a>01003                         <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(buf, &amp;c, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
<a name="l01004"></a>01004                         from = <a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(from)[0]; <span class="comment">/* div */</span>
<a name="l01005"></a>01005                     }
<a name="l01006"></a>01006                 }
<a name="l01007"></a>01007 
<a name="l01008"></a>01008                 {
<a name="l01009"></a>01009                     <span class="keywordtype">long</span> l = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(from);
<a name="l01010"></a>01010                     <span class="keywordflow">if</span> (l &lt; 0) {
<a name="l01011"></a>01011                         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;can&apos;t compress negative numbers&quot;</span>);
<a name="l01012"></a>01012                     }
<a name="l01013"></a>01013                     ul = l;
<a name="l01014"></a>01014                 }
<a name="l01015"></a>01015 
<a name="l01016"></a>01016                 <span class="keywordflow">while</span> (ul) {
<a name="l01017"></a>01017                     c = (char)(ul &amp; 0x7f) | 0x80;
<a name="l01018"></a>01018                     <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(buf, &amp;c, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
<a name="l01019"></a>01019                     ul &gt;&gt;=  7;
<a name="l01020"></a>01020                 }
<a name="l01021"></a>01021 
<a name="l01022"></a>01022                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(buf)) {
<a name="l01023"></a>01023                     bufs = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(buf);
<a name="l01024"></a>01024                     bufe = bufs + <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(buf) - 1;
<a name="l01025"></a>01025                     *bufs &amp;= 0x7f; <span class="comment">/* clear continue bit */</span>
<a name="l01026"></a>01026                     <span class="keywordflow">while</span> (bufs &lt; bufe) { <span class="comment">/* reverse */</span>
<a name="l01027"></a>01027                         c = *bufs;
<a name="l01028"></a>01028                         *bufs++ = *bufe;
<a name="l01029"></a>01029                         *bufe-- = c;
<a name="l01030"></a>01030                     }
<a name="l01031"></a>01031                     <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(buf), <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(buf));
<a name="l01032"></a>01032                 }
<a name="l01033"></a>01033                 <span class="keywordflow">else</span> {
<a name="l01034"></a>01034                     c = 0;
<a name="l01035"></a>01035                     <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(res, &amp;c, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
<a name="l01036"></a>01036                 }
<a name="l01037"></a>01037             }
<a name="l01038"></a>01038             <span class="keywordflow">break</span>;
<a name="l01039"></a>01039 
<a name="l01040"></a>01040           <span class="keywordflow">default</span>:
<a name="l01041"></a>01041             <span class="keywordflow">break</span>;
<a name="l01042"></a>01042         }
<a name="l01043"></a>01043     }
<a name="l01044"></a>01044 
<a name="l01045"></a>01045     <span class="keywordflow">if</span> (associates) {
<a name="l01046"></a>01046         <a class="code" href="../../db/d2e/intern_8h.html#a34ee266e7ad7a1fee62f02cb01b0fc56">rb_str_associate</a>(res, associates);
<a name="l01047"></a>01047     }
<a name="l01048"></a>01048     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3bf9ab455a1e0e3e8cfc6ebabd8f12df">OBJ_INFECT</a>(res, fmt);
<a name="l01049"></a>01049     <span class="keywordflow">switch</span> (enc_info) {
<a name="l01050"></a>01050       <span class="keywordflow">case</span> 1:
<a name="l01051"></a>01051         <a class="code" href="../../d5/de3/encoding_8h.html#af06e3f35ff3b6d79190eaf397328e7e6">ENCODING_CODERANGE_SET</a>(res, <a class="code" href="../../d5/db5/encoding_8c.html#af8bb373eaa8036994c2e16476458d6f4">rb_usascii_encindex</a>(), <a class="code" href="../../d5/de3/encoding_8h.html#a0a0e73a2d98205044e1ad19432502c5b">ENC_CODERANGE_7BIT</a>);
<a name="l01052"></a>01052         <span class="keywordflow">break</span>;
<a name="l01053"></a>01053       <span class="keywordflow">case</span> 2:
<a name="l01054"></a>01054         <a class="code" href="../../d5/db5/encoding_8c.html#a8130988e8200f6174670b44f71b7f284">rb_enc_set_index</a>(res, <a class="code" href="../../d5/db5/encoding_8c.html#a401176ad45a3d3834694ca2412bf2351">rb_utf8_encindex</a>());
<a name="l01055"></a>01055         <span class="keywordflow">break</span>;
<a name="l01056"></a>01056       <span class="keywordflow">default</span>:
<a name="l01057"></a>01057         <span class="comment">/* do nothing, keep ASCII-8BIT */</span>
<a name="l01058"></a>01058         <span class="keywordflow">break</span>;
<a name="l01059"></a>01059     }
<a name="l01060"></a>01060     <span class="keywordflow">return</span> res;
<a name="l01061"></a>01061 }
<a name="l01062"></a>01062 
<a name="l01063"></a><a class="code" href="../../d1/d7d/pack_8c.html#a4164f5b403ab7d85a9a032717516cb78">01063</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="../../d1/d7d/pack_8c.html#a4164f5b403ab7d85a9a032717516cb78">uu_table</a>[] =
<a name="l01064"></a>01064 <span class="stringliteral">&quot;`!\&quot;#$%&amp;&apos;()*+,-./0123456789:;&lt;=&gt;?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_&quot;</span>;
<a name="l01065"></a><a class="code" href="../../d1/d7d/pack_8c.html#abfb7807bca1894b8f5eda68986aac98d">01065</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="../../d1/d7d/pack_8c.html#abfb7807bca1894b8f5eda68986aac98d">b64_table</a>[] =
<a name="l01066"></a>01066 <span class="stringliteral">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span>;
<a name="l01067"></a>01067 
<a name="l01068"></a>01068 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01069"></a><a class="code" href="../../d1/d7d/pack_8c.html#aec39f4653ccc94226bc3a321fcc18bc2">01069</a> <a class="code" href="../../d1/d7d/pack_8c.html#aec39f4653ccc94226bc3a321fcc18bc2">encodes</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, <span class="keyword">const</span> <span class="keywordtype">char</span> *s, <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <span class="keywordtype">int</span> <a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>, <span class="keywordtype">int</span> tail_lf)
<a name="l01070"></a>01070 {
<a name="l01071"></a>01071     <span class="keywordtype">char</span> buff[4096];
<a name="l01072"></a>01072     <span class="keywordtype">long</span> i = 0;
<a name="l01073"></a>01073     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../de/d8f/big5_8c.html#a11a04596d19e18c50f2d29ecbb86533c">trans</a> = type == <span class="charliteral">&apos;u&apos;</span> ? uu_table : b64_table;
<a name="l01074"></a>01074     <span class="keywordtype">int</span> padding;
<a name="l01075"></a>01075 
<a name="l01076"></a>01076     <span class="keywordflow">if</span> (type == <span class="charliteral">&apos;u&apos;</span>) {
<a name="l01077"></a>01077         buff[i++] = (char)len + <span class="charliteral">&apos; &apos;</span>;
<a name="l01078"></a>01078         padding = <span class="charliteral">&apos;`&apos;</span>;
<a name="l01079"></a>01079     }
<a name="l01080"></a>01080     <span class="keywordflow">else</span> {
<a name="l01081"></a>01081         padding = <span class="charliteral">&apos;=&apos;</span>;
<a name="l01082"></a>01082     }
<a name="l01083"></a>01083     <span class="keywordflow">while</span> (len &gt;= 3) {
<a name="l01084"></a>01084         <span class="keywordflow">while</span> (len &gt;= 3 &amp;&amp; <span class="keyword">sizeof</span>(buff)-i &gt;= 4) {
<a name="l01085"></a>01085             buff[i++] = trans[077 &amp; (*s &gt;&gt; 2)];
<a name="l01086"></a>01086             buff[i++] = trans[077 &amp; (((*s &lt;&lt; 4) &amp; 060) | ((s[1] &gt;&gt; 4) &amp; 017))];
<a name="l01087"></a>01087             buff[i++] = trans[077 &amp; (((s[1] &lt;&lt; 2) &amp; 074) | ((s[2] &gt;&gt; 6) &amp; 03))];
<a name="l01088"></a>01088             buff[i++] = trans[077 &amp; s[2]];
<a name="l01089"></a>01089             s += 3;
<a name="l01090"></a>01090             len -= 3;
<a name="l01091"></a>01091         }
<a name="l01092"></a>01092         <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(buff)-i &lt; 4) {
<a name="l01093"></a>01093             <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(str, buff, i);
<a name="l01094"></a>01094             i = 0;
<a name="l01095"></a>01095         }
<a name="l01096"></a>01096     }
<a name="l01097"></a>01097 
<a name="l01098"></a>01098     <span class="keywordflow">if</span> (len == 2) {
<a name="l01099"></a>01099         buff[i++] = trans[077 &amp; (*s &gt;&gt; 2)];
<a name="l01100"></a>01100         buff[i++] = trans[077 &amp; (((*s &lt;&lt; 4) &amp; 060) | ((s[1] &gt;&gt; 4) &amp; 017))];
<a name="l01101"></a>01101         buff[i++] = trans[077 &amp; (((s[1] &lt;&lt; 2) &amp; 074) | ((<span class="charliteral">&apos;\0&apos;</span> &gt;&gt; 6) &amp; 03))];
<a name="l01102"></a>01102         buff[i++] = padding;
<a name="l01103"></a>01103     }
<a name="l01104"></a>01104     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len == 1) {
<a name="l01105"></a>01105         buff[i++] = trans[077 &amp; (*s &gt;&gt; 2)];
<a name="l01106"></a>01106         buff[i++] = trans[077 &amp; (((*s &lt;&lt; 4) &amp; 060) | ((&apos;\0&apos; &gt;&gt; 4) &amp; 017))];
<a name="l01107"></a>01107         buff[i++] = padding;
<a name="l01108"></a>01108         buff[i++] = padding;
<a name="l01109"></a>01109     }
<a name="l01110"></a>01110     <span class="keywordflow">if</span> (tail_lf) buff[i++] = <span class="charliteral">&apos;\n&apos;</span>;
<a name="l01111"></a>01111     <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(str, buff, i);
<a name="l01112"></a>01112 }
<a name="l01113"></a>01113 
<a name="l01114"></a><a class="code" href="../../d1/d7d/pack_8c.html#a1fd9aee3bb6a7695c79e6ec889022c60">01114</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="../../d3/ddc/syck_2emitter_8c.html#a1fd9aee3bb6a7695c79e6ec889022c60">hex_table</a>[] = <span class="stringliteral">&quot;0123456789ABCDEF&quot;</span>;
<a name="l01115"></a>01115 
<a name="l01116"></a>01116 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01117"></a><a class="code" href="../../d1/d7d/pack_8c.html#a44babce3c1805d72e7a6d064b77d569a">01117</a> <a class="code" href="../../d1/d7d/pack_8c.html#a44babce3c1805d72e7a6d064b77d569a">qpencode</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> from, <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>)
<a name="l01118"></a>01118 {
<a name="l01119"></a>01119     <span class="keywordtype">char</span> buff[1024];
<a name="l01120"></a>01120     <span class="keywordtype">long</span> i = 0, n = 0, <a class="code" href="../../d7/dc0/parse_8y.html#a71f8b6ffdc0cc58ffd989c3162fb2bcf">prev</a> = <a class="code" href="../../da/d50/vsnprintf_8c.html#a59adc4c82490d23754cd39c2fb99b0da">EOF</a>;
<a name="l01121"></a>01121     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *s = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(from);
<a name="l01122"></a>01122     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *send = s + <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(from);
<a name="l01123"></a>01123 
<a name="l01124"></a>01124     <span class="keywordflow">while</span> (s &lt; send) {
<a name="l01125"></a>01125         <span class="keywordflow">if</span> ((*s &gt; 126) ||
<a name="l01126"></a>01126             (*s &lt; 32 &amp;&amp; *s != <span class="charliteral">&apos;\n&apos;</span> &amp;&amp; *s != <span class="charliteral">&apos;\t&apos;</span>) ||
<a name="l01127"></a>01127             (*s == <span class="charliteral">&apos;=&apos;</span>)) {
<a name="l01128"></a>01128             buff[i++] = <span class="charliteral">&apos;=&apos;</span>;
<a name="l01129"></a>01129             buff[i++] = hex_table[*s &gt;&gt; 4];
<a name="l01130"></a>01130             buff[i++] = hex_table[*s &amp; 0x0f];
<a name="l01131"></a>01131             n += 3;
<a name="l01132"></a>01132             <a class="code" href="../../d7/dc0/parse_8y.html#a71f8b6ffdc0cc58ffd989c3162fb2bcf">prev</a> = <a class="code" href="../../da/d50/vsnprintf_8c.html#a59adc4c82490d23754cd39c2fb99b0da">EOF</a>;
<a name="l01133"></a>01133         }
<a name="l01134"></a>01134         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*s == <span class="charliteral">&apos;\n&apos;</span>) {
<a name="l01135"></a>01135             <span class="keywordflow">if</span> (<a class="code" href="../../d7/dc0/parse_8y.html#a71f8b6ffdc0cc58ffd989c3162fb2bcf">prev</a> == <span class="charliteral">&apos; &apos;</span> || <a class="code" href="../../d7/dc0/parse_8y.html#a71f8b6ffdc0cc58ffd989c3162fb2bcf">prev</a> == <span class="charliteral">&apos;\t&apos;</span>) {
<a name="l01136"></a>01136                 buff[i++] = <span class="charliteral">&apos;=&apos;</span>;
<a name="l01137"></a>01137                 buff[i++] = *s;
<a name="l01138"></a>01138             }
<a name="l01139"></a>01139             buff[i++] = *s;
<a name="l01140"></a>01140             n = 0;
<a name="l01141"></a>01141             <a class="code" href="../../d7/dc0/parse_8y.html#a71f8b6ffdc0cc58ffd989c3162fb2bcf">prev</a> = *s;
<a name="l01142"></a>01142         }
<a name="l01143"></a>01143         <span class="keywordflow">else</span> {
<a name="l01144"></a>01144             buff[i++] = *s;
<a name="l01145"></a>01145             n++;
<a name="l01146"></a>01146             <a class="code" href="../../d7/dc0/parse_8y.html#a71f8b6ffdc0cc58ffd989c3162fb2bcf">prev</a> = *s;
<a name="l01147"></a>01147         }
<a name="l01148"></a>01148         <span class="keywordflow">if</span> (n &gt; len) {
<a name="l01149"></a>01149             buff[i++] = <span class="charliteral">&apos;=&apos;</span>;
<a name="l01150"></a>01150             buff[i++] = <span class="charliteral">&apos;\n&apos;</span>;
<a name="l01151"></a>01151             n = 0;
<a name="l01152"></a>01152             <a class="code" href="../../d7/dc0/parse_8y.html#a71f8b6ffdc0cc58ffd989c3162fb2bcf">prev</a> = <span class="charliteral">&apos;\n&apos;</span>;
<a name="l01153"></a>01153         }
<a name="l01154"></a>01154         <span class="keywordflow">if</span> (i &gt; 1024 - 5) {
<a name="l01155"></a>01155             <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(str, buff, i);
<a name="l01156"></a>01156             i = 0;
<a name="l01157"></a>01157         }
<a name="l01158"></a>01158         s++;
<a name="l01159"></a>01159     }
<a name="l01160"></a>01160     <span class="keywordflow">if</span> (n &gt; 0) {
<a name="l01161"></a>01161         buff[i++] = <span class="charliteral">&apos;=&apos;</span>;
<a name="l01162"></a>01162         buff[i++] = <span class="charliteral">&apos;\n&apos;</span>;
<a name="l01163"></a>01163     }
<a name="l01164"></a>01164     <span class="keywordflow">if</span> (i &gt; 0) {
<a name="l01165"></a>01165         <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(str, buff, i);
<a name="l01166"></a>01166     }
<a name="l01167"></a>01167 }
<a name="l01168"></a>01168 
<a name="l01169"></a>01169 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l01170"></a><a class="code" href="../../d1/d7d/pack_8c.html#a3c9ea8434da148851c9d559b58607698">01170</a> <a class="code" href="../../d1/d7d/pack_8c.html#a3c9ea8434da148851c9d559b58607698">hex2num</a>(<span class="keywordtype">char</span> c)
<a name="l01171"></a>01171 {
<a name="l01172"></a>01172     <span class="keywordflow">switch</span> (c) {
<a name="l01173"></a>01173       <span class="keywordflow">case</span> <span class="charliteral">&apos;0&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;1&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;2&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;3&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;4&apos;</span>:
<a name="l01174"></a>01174       <span class="keywordflow">case</span> <span class="charliteral">&apos;5&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;6&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;7&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;8&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;9&apos;</span>:
<a name="l01175"></a>01175         <span class="keywordflow">return</span> c - <span class="charliteral">&apos;0&apos;</span>;
<a name="l01176"></a>01176       <span class="keywordflow">case</span> <span class="charliteral">&apos;a&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;b&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;c&apos;</span>:
<a name="l01177"></a>01177       <span class="keywordflow">case</span> <span class="charliteral">&apos;d&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;e&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;f&apos;</span>:
<a name="l01178"></a>01178         <span class="keywordflow">return</span> c - <span class="charliteral">&apos;a&apos;</span> + 10;
<a name="l01179"></a>01179       <span class="keywordflow">case</span> <span class="charliteral">&apos;A&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;B&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;C&apos;</span>:
<a name="l01180"></a>01180       <span class="keywordflow">case</span> <span class="charliteral">&apos;D&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;E&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;F&apos;</span>:
<a name="l01181"></a>01181         <span class="keywordflow">return</span> c - <span class="charliteral">&apos;A&apos;</span> + 10;
<a name="l01182"></a>01182       <span class="keywordflow">default</span>:
<a name="l01183"></a>01183         <span class="keywordflow">return</span> -1;
<a name="l01184"></a>01184     }
<a name="l01185"></a>01185 }
<a name="l01186"></a>01186 
<a name="l01187"></a><a class="code" href="../../d1/d7d/pack_8c.html#a6c749560bce2dcea8fd86b62037e7a02">01187</a> <span class="preprocessor">#define PACK_LENGTH_ADJUST_SIZE(sz) do {        \</span>
<a name="l01188"></a>01188 <span class="preprocessor">    tmp_len = 0;                                \</span>
<a name="l01189"></a>01189 <span class="preprocessor">    if (len &gt; (long)((send-s)/(sz))) {          \</span>
<a name="l01190"></a>01190 <span class="preprocessor">        if (!star) {                            \</span>
<a name="l01191"></a>01191 <span class="preprocessor">            tmp_len = len-(send-s)/(sz);                \</span>
<a name="l01192"></a>01192 <span class="preprocessor">        }                                       \</span>
<a name="l01193"></a>01193 <span class="preprocessor">        len = (send-s)/(sz);                    \</span>
<a name="l01194"></a>01194 <span class="preprocessor">    }                                           \</span>
<a name="l01195"></a>01195 <span class="preprocessor">} while (0)</span>
<a name="l01196"></a>01196 <span class="preprocessor"></span>
<a name="l01197"></a><a class="code" href="../../d1/d7d/pack_8c.html#aa23aff96b6ff6a9b87c992d3093f0e41">01197</a> <span class="preprocessor">#define PACK_ITEM_ADJUST() do { \</span>
<a name="l01198"></a>01198 <span class="preprocessor">    if (tmp_len &gt; 0 &amp;&amp; !block_p) \</span>
<a name="l01199"></a>01199 <span class="preprocessor">        rb_ary_store(ary, RARRAY_LEN(ary)+tmp_len-1, Qnil); \</span>
<a name="l01200"></a>01200 <span class="preprocessor">} while (0)</span>
<a name="l01201"></a>01201 <span class="preprocessor"></span>
<a name="l01202"></a>01202 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01203"></a><a class="code" href="../../d1/d7d/pack_8c.html#a86b9f5ea794549bedec734d5694bde44">01203</a> <a class="code" href="../../d1/d7d/pack_8c.html#a86b9f5ea794549bedec734d5694bde44">infected_str_new</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *ptr, <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str)
<a name="l01204"></a>01204 {
<a name="l01205"></a>01205     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> s = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(ptr, len);
<a name="l01206"></a>01206 
<a name="l01207"></a>01207     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3bf9ab455a1e0e3e8cfc6ebabd8f12df">OBJ_INFECT</a>(s, str);
<a name="l01208"></a>01208     <span class="keywordflow">return</span> s;
<a name="l01209"></a>01209 }
<a name="l01210"></a>01210 
<a name="l01211"></a>01211 <span class="comment">/*</span>
<a name="l01212"></a>01212 <span class="comment"> *  call-seq:</span>
<a name="l01213"></a>01213 <span class="comment"> *     str.unpack(format)    -&gt;  anArray</span>
<a name="l01214"></a>01214 <span class="comment"> *</span>
<a name="l01215"></a>01215 <span class="comment"> *  Decodes &lt;i&gt;str&lt;/i&gt; (which may contain binary data) according to the</span>
<a name="l01216"></a>01216 <span class="comment"> *  format string, returning an array of each value extracted. The</span>
<a name="l01217"></a>01217 <span class="comment"> *  format string consists of a sequence of single-character directives,</span>
<a name="l01218"></a>01218 <span class="comment"> *  summarized in the table at the end of this entry.</span>
<a name="l01219"></a>01219 <span class="comment"> *  Each directive may be followed</span>
<a name="l01220"></a>01220 <span class="comment"> *  by a number, indicating the number of times to repeat with this</span>
<a name="l01221"></a>01221 <span class="comment"> *  directive. An asterisk (``&lt;code&gt;*&lt;/code&gt;&apos;&apos;) will use up all</span>
<a name="l01222"></a>01222 <span class="comment"> *  remaining elements. The directives &lt;code&gt;sSiIlL&lt;/code&gt; may each be</span>
<a name="l01223"></a>01223 <span class="comment"> *  followed by an underscore (``&lt;code&gt;_&lt;/code&gt;&apos;&apos;) or</span>
<a name="l01224"></a>01224 <span class="comment"> *  exclamation mark (``&lt;code&gt;!&lt;/code&gt;&apos;&apos;) to use the underlying</span>
<a name="l01225"></a>01225 <span class="comment"> *  platform&apos;s native size for the specified type; otherwise, it uses a</span>
<a name="l01226"></a>01226 <span class="comment"> *  platform-independent consistent size. Spaces are ignored in the</span>
<a name="l01227"></a>01227 <span class="comment"> *  format string. See also &lt;code&gt;Array#pack&lt;/code&gt;.</span>
<a name="l01228"></a>01228 <span class="comment"> *</span>
<a name="l01229"></a>01229 <span class="comment"> *     &quot;abc \0\0abc \0\0&quot;.unpack(&apos;A6Z6&apos;)   #=&gt; [&quot;abc&quot;, &quot;abc &quot;]</span>
<a name="l01230"></a>01230 <span class="comment"> *     &quot;abc \0\0&quot;.unpack(&apos;a3a3&apos;)           #=&gt; [&quot;abc&quot;, &quot; \000\000&quot;]</span>
<a name="l01231"></a>01231 <span class="comment"> *     &quot;abc \0abc \0&quot;.unpack(&apos;Z*Z*&apos;)       #=&gt; [&quot;abc &quot;, &quot;abc &quot;]</span>
<a name="l01232"></a>01232 <span class="comment"> *     &quot;aa&quot;.unpack(&apos;b8B8&apos;)                 #=&gt; [&quot;10000110&quot;, &quot;01100001&quot;]</span>
<a name="l01233"></a>01233 <span class="comment"> *     &quot;aaa&quot;.unpack(&apos;h2H2c&apos;)               #=&gt; [&quot;16&quot;, &quot;61&quot;, 97]</span>
<a name="l01234"></a>01234 <span class="comment"> *     &quot;\xfe\xff\xfe\xff&quot;.unpack(&apos;sS&apos;)     #=&gt; [-2, 65534]</span>
<a name="l01235"></a>01235 <span class="comment"> *     &quot;now=20is&quot;.unpack(&apos;M*&apos;)             #=&gt; [&quot;now is&quot;]</span>
<a name="l01236"></a>01236 <span class="comment"> *     &quot;whole&quot;.unpack(&apos;xax2aX2aX1aX2a&apos;)    #=&gt; [&quot;h&quot;, &quot;e&quot;, &quot;l&quot;, &quot;l&quot;, &quot;o&quot;]</span>
<a name="l01237"></a>01237 <span class="comment"> *</span>
<a name="l01238"></a>01238 <span class="comment"> *  This table summarizes the various formats and the Ruby classes</span>
<a name="l01239"></a>01239 <span class="comment"> *  returned by each.</span>
<a name="l01240"></a>01240 <span class="comment"> *</span>
<a name="l01241"></a>01241 <span class="comment"> *   Integer      |         |</span>
<a name="l01242"></a>01242 <span class="comment"> *   Directive    | Returns | Meaning</span>
<a name="l01243"></a>01243 <span class="comment"> *   -----------------------------------------------------------------</span>
<a name="l01244"></a>01244 <span class="comment"> *      C         | Integer | 8-bit unsigned (unsigned char)</span>
<a name="l01245"></a>01245 <span class="comment"> *      S         | Integer | 16-bit unsigned, native endian (uint16_t)</span>
<a name="l01246"></a>01246 <span class="comment"> *      L         | Integer | 32-bit unsigned, native endian (uint32_t)</span>
<a name="l01247"></a>01247 <span class="comment"> *      Q         | Integer | 64-bit unsigned, native endian (uint64_t)</span>
<a name="l01248"></a>01248 <span class="comment"> *                |         |</span>
<a name="l01249"></a>01249 <span class="comment"> *      c         | Integer | 8-bit signed (signed char)</span>
<a name="l01250"></a>01250 <span class="comment"> *      s         | Integer | 16-bit signed, native endian (int16_t)</span>
<a name="l01251"></a>01251 <span class="comment"> *      l         | Integer | 32-bit signed, native endian (int32_t)</span>
<a name="l01252"></a>01252 <span class="comment"> *      q         | Integer | 64-bit signed, native endian (int64_t)</span>
<a name="l01253"></a>01253 <span class="comment"> *                |         |</span>
<a name="l01254"></a>01254 <span class="comment"> *      S_, S!    | Integer | unsigned short, native endian</span>
<a name="l01255"></a>01255 <span class="comment"> *      I, I_, I! | Integer | unsigned int, native endian</span>
<a name="l01256"></a>01256 <span class="comment"> *      L_, L!    | Integer | unsigned long, native endian</span>
<a name="l01257"></a>01257 <span class="comment"> *                |         |</span>
<a name="l01258"></a>01258 <span class="comment"> *      s_, s!    | Integer | signed short, native endian</span>
<a name="l01259"></a>01259 <span class="comment"> *      i, i_, i! | Integer | signed int, native endian</span>
<a name="l01260"></a>01260 <span class="comment"> *      l_, l!    | Integer | signed long, native endian</span>
<a name="l01261"></a>01261 <span class="comment"> *                |         |</span>
<a name="l01262"></a>01262 <span class="comment"> *      S&gt; L&gt; Q&gt;  | Integer | same as the directives without &quot;&gt;&quot; except</span>
<a name="l01263"></a>01263 <span class="comment"> *      s&gt; l&gt; q&gt;  |         | big endian</span>
<a name="l01264"></a>01264 <span class="comment"> *      S!&gt; I!&gt;   |         | (available since Ruby 1.9.3)</span>
<a name="l01265"></a>01265 <span class="comment"> *      L!&gt; Q!&gt;   |         | &quot;S&gt;&quot; is same as &quot;n&quot;</span>
<a name="l01266"></a>01266 <span class="comment"> *      s!&gt; i!&gt;   |         | &quot;L&gt;&quot; is same as &quot;N&quot;</span>
<a name="l01267"></a>01267 <span class="comment"> *      l!&gt; q!&gt;   |         |</span>
<a name="l01268"></a>01268 <span class="comment"> *                |         |</span>
<a name="l01269"></a>01269 <span class="comment"> *      S&lt; L&lt; Q&lt;  | Integer | same as the directives without &quot;&lt;&quot; except</span>
<a name="l01270"></a>01270 <span class="comment"> *      s&lt; l&lt; q&lt;  |         | little endian</span>
<a name="l01271"></a>01271 <span class="comment"> *      S!&lt; I!&lt;   |         | (available since Ruby 1.9.3)</span>
<a name="l01272"></a>01272 <span class="comment"> *      L!&lt; Q!&lt;   |         | &quot;S&lt;&quot; is same as &quot;v&quot;</span>
<a name="l01273"></a>01273 <span class="comment"> *      s!&lt; i!&lt;   |         | &quot;L&lt;&quot; is same as &quot;V&quot;</span>
<a name="l01274"></a>01274 <span class="comment"> *      l!&lt; q!&lt;   |         |</span>
<a name="l01275"></a>01275 <span class="comment"> *                |         |</span>
<a name="l01276"></a>01276 <span class="comment"> *      n         | Integer | 16-bit unsigned, network (big-endian) byte order</span>
<a name="l01277"></a>01277 <span class="comment"> *      N         | Integer | 32-bit unsigned, network (big-endian) byte order</span>
<a name="l01278"></a>01278 <span class="comment"> *      v         | Integer | 16-bit unsigned, VAX (little-endian) byte order</span>
<a name="l01279"></a>01279 <span class="comment"> *      V         | Integer | 32-bit unsigned, VAX (little-endian) byte order</span>
<a name="l01280"></a>01280 <span class="comment"> *                |         |</span>
<a name="l01281"></a>01281 <span class="comment"> *      U         | Integer | UTF-8 character</span>
<a name="l01282"></a>01282 <span class="comment"> *      w         | Integer | BER-compressed integer (see Array.pack)</span>
<a name="l01283"></a>01283 <span class="comment"> *</span>
<a name="l01284"></a>01284 <span class="comment"> *   Float        |         |</span>
<a name="l01285"></a>01285 <span class="comment"> *   Directive    | Returns | Meaning</span>
<a name="l01286"></a>01286 <span class="comment"> *   -----------------------------------------------------------------</span>
<a name="l01287"></a>01287 <span class="comment"> *      D, d      | Float   | double-precision, native format</span>
<a name="l01288"></a>01288 <span class="comment"> *      F, f      | Float   | single-precision, native format</span>
<a name="l01289"></a>01289 <span class="comment"> *      E         | Float   | double-precision, little-endian byte order</span>
<a name="l01290"></a>01290 <span class="comment"> *      e         | Float   | single-precision, little-endian byte order</span>
<a name="l01291"></a>01291 <span class="comment"> *      G         | Float   | double-precision, network (big-endian) byte order</span>
<a name="l01292"></a>01292 <span class="comment"> *      g         | Float   | single-precision, network (big-endian) byte order</span>
<a name="l01293"></a>01293 <span class="comment"> *</span>
<a name="l01294"></a>01294 <span class="comment"> *   String       |         |</span>
<a name="l01295"></a>01295 <span class="comment"> *   Directive    | Returns | Meaning</span>
<a name="l01296"></a>01296 <span class="comment"> *   -----------------------------------------------------------------</span>
<a name="l01297"></a>01297 <span class="comment"> *      A         | String  | arbitrary binary string (remove trailing nulls and ASCII spaces)</span>
<a name="l01298"></a>01298 <span class="comment"> *      a         | String  | arbitrary binary string</span>
<a name="l01299"></a>01299 <span class="comment"> *      Z         | String  | null-terminated string</span>
<a name="l01300"></a>01300 <span class="comment"> *      B         | String  | bit string (MSB first)</span>
<a name="l01301"></a>01301 <span class="comment"> *      b         | String  | bit string (LSB first)</span>
<a name="l01302"></a>01302 <span class="comment"> *      H         | String  | hex string (high nibble first)</span>
<a name="l01303"></a>01303 <span class="comment"> *      h         | String  | hex string (low nibble first)</span>
<a name="l01304"></a>01304 <span class="comment"> *      u         | String  | UU-encoded string</span>
<a name="l01305"></a>01305 <span class="comment"> *      M         | String  | quoted-printable, MIME encoding (see RFC2045)</span>
<a name="l01306"></a>01306 <span class="comment"> *      m         | String  | base64 encoded string (RFC 2045) (default)</span>
<a name="l01307"></a>01307 <span class="comment"> *                |         | base64 encoded string (RFC 4648) if followed by 0</span>
<a name="l01308"></a>01308 <span class="comment"> *      P         | String  | pointer to a structure (fixed-length string)</span>
<a name="l01309"></a>01309 <span class="comment"> *      p         | String  | pointer to a null-terminated string</span>
<a name="l01310"></a>01310 <span class="comment"> *</span>
<a name="l01311"></a>01311 <span class="comment"> *   Misc.        |         |</span>
<a name="l01312"></a>01312 <span class="comment"> *   Directive    | Returns | Meaning</span>
<a name="l01313"></a>01313 <span class="comment"> *   -----------------------------------------------------------------</span>
<a name="l01314"></a>01314 <span class="comment"> *      @         | ---     | skip to the offset given by the length argument</span>
<a name="l01315"></a>01315 <span class="comment"> *      X         | ---     | skip backward one byte</span>
<a name="l01316"></a>01316 <span class="comment"> *      x         | ---     | skip forward one byte</span>
<a name="l01317"></a>01317 <span class="comment"> */</span>
<a name="l01318"></a>01318 
<a name="l01319"></a>01319 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01320"></a><a class="code" href="../../d1/d7d/pack_8c.html#a2fac891305016ef32d610eb5fad08389">01320</a> <a class="code" href="../../d1/d7d/pack_8c.html#a2fac891305016ef32d610eb5fad08389">pack_unpack</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> fmt)
<a name="l01321"></a>01321 {
<a name="l01322"></a>01322     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> hexdigits[] = <span class="stringliteral">&quot;0123456789abcdef&quot;</span>;
<a name="l01323"></a>01323     <span class="keywordtype">char</span> *s, *send;
<a name="l01324"></a>01324     <span class="keywordtype">char</span> *p, *pend;
<a name="l01325"></a>01325     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary;
<a name="l01326"></a>01326     <span class="keywordtype">char</span> <a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>;
<a name="l01327"></a>01327     <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, tmp_len;
<a name="l01328"></a>01328     <span class="keywordtype">int</span> star;
<a name="l01329"></a>01329 <span class="preprocessor">#ifdef NATINT_PACK</span>
<a name="l01330"></a>01330 <span class="preprocessor"></span>    <span class="keywordtype">int</span> natint;                 <span class="comment">/* native integer */</span>
<a name="l01331"></a>01331 <span class="preprocessor">#endif</span>
<a name="l01332"></a>01332 <span class="preprocessor"></span>    <span class="keywordtype">int</span> block_p = <a class="code" href="../../d3/d57/eval_8c.html#aea346c4eb8bc06df88422e956bb05fec">rb_block_given_p</a>();
<a name="l01333"></a>01333     <span class="keywordtype">int</span> signed_p, integer_size, bigendian_p;
<a name="l01334"></a>01334 <span class="preprocessor">#define UNPACK_PUSH(item) do {\</span>
<a name="l01335"></a>01335 <span class="preprocessor">        VALUE item_val = (item);\</span>
<a name="l01336"></a>01336 <span class="preprocessor">        if (block_p) {\</span>
<a name="l01337"></a>01337 <span class="preprocessor">            rb_yield(item_val);\</span>
<a name="l01338"></a>01338 <span class="preprocessor">        }\</span>
<a name="l01339"></a>01339 <span class="preprocessor">        else {\</span>
<a name="l01340"></a>01340 <span class="preprocessor">            rb_ary_push(ary, item_val);\</span>
<a name="l01341"></a>01341 <span class="preprocessor">        }\</span>
<a name="l01342"></a>01342 <span class="preprocessor">    } while (0)</span>
<a name="l01343"></a>01343 <span class="preprocessor"></span>
<a name="l01344"></a>01344     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(str);
<a name="l01345"></a>01345     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(fmt);
<a name="l01346"></a>01346     s = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str);
<a name="l01347"></a>01347     send = s + <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str);
<a name="l01348"></a>01348     p = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(fmt);
<a name="l01349"></a>01349     pend = p + <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(fmt);
<a name="l01350"></a>01350 
<a name="l01351"></a>01351     ary = block_p ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a> : <a class="code" href="../../dc/dcc/array_8c.html#a9518114fd36cb4ef4656ec1dc63348c9">rb_ary_new</a>();
<a name="l01352"></a>01352     <span class="keywordflow">while</span> (p &lt; pend) {
<a name="l01353"></a>01353         <span class="keywordtype">int</span> explicit_endian = 0;
<a name="l01354"></a>01354         type = *p++;
<a name="l01355"></a>01355 <span class="preprocessor">#ifdef NATINT_PACK</span>
<a name="l01356"></a>01356 <span class="preprocessor"></span>        natint = 0;
<a name="l01357"></a>01357 <span class="preprocessor">#endif</span>
<a name="l01358"></a>01358 <span class="preprocessor"></span>
<a name="l01359"></a>01359         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae8cdc17e44905c826bddf416b7bf621c">ISSPACE</a>(type)) <span class="keywordflow">continue</span>;
<a name="l01360"></a>01360         <span class="keywordflow">if</span> (type == <span class="charliteral">&apos;#&apos;</span>) {
<a name="l01361"></a>01361             <span class="keywordflow">while</span> ((p &lt; pend) &amp;&amp; (*p != <span class="charliteral">&apos;\n&apos;</span>)) {
<a name="l01362"></a>01362                 p++;
<a name="l01363"></a>01363             }
<a name="l01364"></a>01364             <span class="keywordflow">continue</span>;
<a name="l01365"></a>01365         }
<a name="l01366"></a>01366 
<a name="l01367"></a>01367         star = 0;
<a name="l01368"></a>01368         {
<a name="l01369"></a>01369             <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> natstr[] = <span class="stringliteral">&quot;sSiIlL&quot;</span>;
<a name="l01370"></a>01370             <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> endstr[] = <span class="stringliteral">&quot;sSiIlLqQ&quot;</span>;
<a name="l01371"></a>01371 
<a name="l01372"></a>01372           modifiers:
<a name="l01373"></a>01373             <span class="keywordflow">switch</span> (*p) {
<a name="l01374"></a>01374               <span class="keywordflow">case</span> <span class="charliteral">&apos;_&apos;</span>:
<a name="l01375"></a>01375               <span class="keywordflow">case</span> <span class="charliteral">&apos;!&apos;</span>:
<a name="l01376"></a>01376 
<a name="l01377"></a>01377                 <span class="keywordflow">if</span> (<a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(natstr, type)) {
<a name="l01378"></a>01378 <span class="preprocessor">#ifdef NATINT_PACK</span>
<a name="l01379"></a>01379 <span class="preprocessor"></span>                    natint = 1;
<a name="l01380"></a>01380 <span class="preprocessor">#endif</span>
<a name="l01381"></a>01381 <span class="preprocessor"></span>                    p++;
<a name="l01382"></a>01382                 }
<a name="l01383"></a>01383                 <span class="keywordflow">else</span> {
<a name="l01384"></a>01384                     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;&apos;%c&apos; allowed only after types %s&quot;</span>, *p, natstr);
<a name="l01385"></a>01385                 }
<a name="l01386"></a>01386                 <span class="keywordflow">goto</span> modifiers;
<a name="l01387"></a>01387 
<a name="l01388"></a>01388               <span class="keywordflow">case</span> <span class="charliteral">&apos;&lt;&apos;</span>:
<a name="l01389"></a>01389               <span class="keywordflow">case</span> <span class="charliteral">&apos;&gt;&apos;</span>:
<a name="l01390"></a>01390                 <span class="keywordflow">if</span> (!<a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(endstr, type)) {
<a name="l01391"></a>01391                     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;&apos;%c&apos; allowed only after types %s&quot;</span>, *p, endstr);
<a name="l01392"></a>01392                 }
<a name="l01393"></a>01393                 <span class="keywordflow">if</span> (explicit_endian) {
<a name="l01394"></a>01394                     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a5211161e80760c30e2e009ae0bee7be8">rb_eRangeError</a>, <span class="stringliteral">&quot;Can&apos;t use both &apos;&lt;&apos; and &apos;&gt;&apos;&quot;</span>);
<a name="l01395"></a>01395                 }
<a name="l01396"></a>01396                 explicit_endian = *p++;
<a name="l01397"></a>01397                 <span class="keywordflow">goto</span> modifiers;
<a name="l01398"></a>01398             }
<a name="l01399"></a>01399         }
<a name="l01400"></a>01400 
<a name="l01401"></a>01401         <span class="keywordflow">if</span> (p &gt;= pend)
<a name="l01402"></a>01402             len = 1;
<a name="l01403"></a>01403         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*p == <span class="charliteral">&apos;*&apos;</span>) {
<a name="l01404"></a>01404             star = 1;
<a name="l01405"></a>01405             len = send - s;
<a name="l01406"></a>01406             p++;
<a name="l01407"></a>01407         }
<a name="l01408"></a>01408         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/dcc/bignum_8c.html#ab615ddd0d086b80219cd7e0345d6b5ef">ISDIGIT</a>(*p)) {
<a name="l01409"></a>01409             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0;
<a name="l01410"></a>01410             len = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1da69daf7d0b9dfe25ed7bd614bab9c7">STRTOUL</a>(p, (<span class="keywordtype">char</span>**)&amp;p, 10);
<a name="l01411"></a>01411             <span class="keywordflow">if</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l01412"></a>01412                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a5211161e80760c30e2e009ae0bee7be8">rb_eRangeError</a>, <span class="stringliteral">&quot;pack length too big&quot;</span>);
<a name="l01413"></a>01413             }
<a name="l01414"></a>01414         }
<a name="l01415"></a>01415         <span class="keywordflow">else</span> {
<a name="l01416"></a>01416             len = (type != <span class="charliteral">&apos;@&apos;</span>);
<a name="l01417"></a>01417         }
<a name="l01418"></a>01418 
<a name="l01419"></a>01419         <span class="keywordflow">switch</span> (type) {
<a name="l01420"></a>01420           <span class="keywordflow">case</span> <span class="charliteral">&apos;%&apos;</span>:
<a name="l01421"></a>01421             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;%% is not supported&quot;</span>);
<a name="l01422"></a>01422             <span class="keywordflow">break</span>;
<a name="l01423"></a>01423 
<a name="l01424"></a>01424           <span class="keywordflow">case</span> <span class="charliteral">&apos;A&apos;</span>:
<a name="l01425"></a>01425             <span class="keywordflow">if</span> (len &gt; send - s) len = send - s;
<a name="l01426"></a>01426             {
<a name="l01427"></a>01427                 <span class="keywordtype">long</span> end = len;
<a name="l01428"></a>01428                 <span class="keywordtype">char</span> *t = s + len - 1;
<a name="l01429"></a>01429 
<a name="l01430"></a>01430                 <span class="keywordflow">while</span> (t &gt;= s) {
<a name="l01431"></a>01431                     <span class="keywordflow">if</span> (*t != <span class="charliteral">&apos; &apos;</span> &amp;&amp; *t != <span class="charliteral">&apos;\0&apos;</span>) <span class="keywordflow">break</span>;
<a name="l01432"></a>01432                     t--; len--;
<a name="l01433"></a>01433                 }
<a name="l01434"></a>01434                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../d1/d7d/pack_8c.html#a86b9f5ea794549bedec734d5694bde44">infected_str_new</a>(s, len, str));
<a name="l01435"></a>01435                 s += end;
<a name="l01436"></a>01436             }
<a name="l01437"></a>01437             <span class="keywordflow">break</span>;
<a name="l01438"></a>01438 
<a name="l01439"></a>01439           <span class="keywordflow">case</span> <span class="charliteral">&apos;Z&apos;</span>:
<a name="l01440"></a>01440             {
<a name="l01441"></a>01441                 <span class="keywordtype">char</span> *t = s;
<a name="l01442"></a>01442 
<a name="l01443"></a>01443                 <span class="keywordflow">if</span> (len &gt; send-s) len = send-s;
<a name="l01444"></a>01444                 <span class="keywordflow">while</span> (t &lt; s+len &amp;&amp; *t) t++;
<a name="l01445"></a>01445                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../d1/d7d/pack_8c.html#a86b9f5ea794549bedec734d5694bde44">infected_str_new</a>(s, t-s, str));
<a name="l01446"></a>01446                 <span class="keywordflow">if</span> (t &lt; send) t++;
<a name="l01447"></a>01447                 s = star ? t : s+len;
<a name="l01448"></a>01448             }
<a name="l01449"></a>01449             <span class="keywordflow">break</span>;
<a name="l01450"></a>01450 
<a name="l01451"></a>01451           <span class="keywordflow">case</span> <span class="charliteral">&apos;a&apos;</span>:
<a name="l01452"></a>01452             <span class="keywordflow">if</span> (len &gt; send - s) len = send - s;
<a name="l01453"></a>01453             <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../d1/d7d/pack_8c.html#a86b9f5ea794549bedec734d5694bde44">infected_str_new</a>(s, len, str));
<a name="l01454"></a>01454             s += len;
<a name="l01455"></a>01455             <span class="keywordflow">break</span>;
<a name="l01456"></a>01456 
<a name="l01457"></a>01457           <span class="keywordflow">case</span> <span class="charliteral">&apos;b&apos;</span>:
<a name="l01458"></a>01458             {
<a name="l01459"></a>01459                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> bitstr;
<a name="l01460"></a>01460                 <span class="keywordtype">char</span> *t;
<a name="l01461"></a>01461                 <span class="keywordtype">int</span> bits;
<a name="l01462"></a>01462                 <span class="keywordtype">long</span> i;
<a name="l01463"></a>01463 
<a name="l01464"></a>01464                 <span class="keywordflow">if</span> (p[-1] == <span class="charliteral">&apos;*&apos;</span> || len &gt; (send - s) * 8)
<a name="l01465"></a>01465                     len = (send - s) * 8;
<a name="l01466"></a>01466                 bits = 0;
<a name="l01467"></a>01467                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(bitstr = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(0, len));
<a name="l01468"></a>01468                 t = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(bitstr);
<a name="l01469"></a>01469                 <span class="keywordflow">for</span> (i=0; i&lt;len; i++) {
<a name="l01470"></a>01470                     <span class="keywordflow">if</span> (i &amp; 7) bits &gt;&gt;= 1;
<a name="l01471"></a>01471                     <span class="keywordflow">else</span> bits = *s++;
<a name="l01472"></a>01472                     *t++ = (bits &amp; 1) ? <span class="charliteral">&apos;1&apos;</span> : <span class="charliteral">&apos;0&apos;</span>;
<a name="l01473"></a>01473                 }
<a name="l01474"></a>01474             }
<a name="l01475"></a>01475             <span class="keywordflow">break</span>;
<a name="l01476"></a>01476 
<a name="l01477"></a>01477           <span class="keywordflow">case</span> <span class="charliteral">&apos;B&apos;</span>:
<a name="l01478"></a>01478             {
<a name="l01479"></a>01479                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> bitstr;
<a name="l01480"></a>01480                 <span class="keywordtype">char</span> *t;
<a name="l01481"></a>01481                 <span class="keywordtype">int</span> bits;
<a name="l01482"></a>01482                 <span class="keywordtype">long</span> i;
<a name="l01483"></a>01483 
<a name="l01484"></a>01484                 <span class="keywordflow">if</span> (p[-1] == <span class="charliteral">&apos;*&apos;</span> || len &gt; (send - s) * 8)
<a name="l01485"></a>01485                     len = (send - s) * 8;
<a name="l01486"></a>01486                 bits = 0;
<a name="l01487"></a>01487                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(bitstr = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(0, len));
<a name="l01488"></a>01488                 t = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(bitstr);
<a name="l01489"></a>01489                 <span class="keywordflow">for</span> (i=0; i&lt;len; i++) {
<a name="l01490"></a>01490                     <span class="keywordflow">if</span> (i &amp; 7) bits &lt;&lt;= 1;
<a name="l01491"></a>01491                     <span class="keywordflow">else</span> bits = *s++;
<a name="l01492"></a>01492                     *t++ = (bits &amp; 128) ? <span class="charliteral">&apos;1&apos;</span> : <span class="charliteral">&apos;0&apos;</span>;
<a name="l01493"></a>01493                 }
<a name="l01494"></a>01494             }
<a name="l01495"></a>01495             <span class="keywordflow">break</span>;
<a name="l01496"></a>01496 
<a name="l01497"></a>01497           <span class="keywordflow">case</span> <span class="charliteral">&apos;h&apos;</span>:
<a name="l01498"></a>01498             {
<a name="l01499"></a>01499                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> bitstr;
<a name="l01500"></a>01500                 <span class="keywordtype">char</span> *t;
<a name="l01501"></a>01501                 <span class="keywordtype">int</span> bits;
<a name="l01502"></a>01502                 <span class="keywordtype">long</span> i;
<a name="l01503"></a>01503 
<a name="l01504"></a>01504                 <span class="keywordflow">if</span> (p[-1] == <span class="charliteral">&apos;*&apos;</span> || len &gt; (send - s) * 2)
<a name="l01505"></a>01505                     len = (send - s) * 2;
<a name="l01506"></a>01506                 bits = 0;
<a name="l01507"></a>01507                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(bitstr = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(0, len));
<a name="l01508"></a>01508                 t = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(bitstr);
<a name="l01509"></a>01509                 <span class="keywordflow">for</span> (i=0; i&lt;len; i++) {
<a name="l01510"></a>01510                     <span class="keywordflow">if</span> (i &amp; 1)
<a name="l01511"></a>01511                         bits &gt;&gt;= 4;
<a name="l01512"></a>01512                     <span class="keywordflow">else</span>
<a name="l01513"></a>01513                         bits = *s++;
<a name="l01514"></a>01514                     *t++ = hexdigits[bits &amp; 15];
<a name="l01515"></a>01515                 }
<a name="l01516"></a>01516             }
<a name="l01517"></a>01517             <span class="keywordflow">break</span>;
<a name="l01518"></a>01518 
<a name="l01519"></a>01519           <span class="keywordflow">case</span> <span class="charliteral">&apos;H&apos;</span>:
<a name="l01520"></a>01520             {
<a name="l01521"></a>01521                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> bitstr;
<a name="l01522"></a>01522                 <span class="keywordtype">char</span> *t;
<a name="l01523"></a>01523                 <span class="keywordtype">int</span> bits;
<a name="l01524"></a>01524                 <span class="keywordtype">long</span> i;
<a name="l01525"></a>01525 
<a name="l01526"></a>01526                 <span class="keywordflow">if</span> (p[-1] == <span class="charliteral">&apos;*&apos;</span> || len &gt; (send - s) * 2)
<a name="l01527"></a>01527                     len = (send - s) * 2;
<a name="l01528"></a>01528                 bits = 0;
<a name="l01529"></a>01529                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(bitstr = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(0, len));
<a name="l01530"></a>01530                 t = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(bitstr);
<a name="l01531"></a>01531                 <span class="keywordflow">for</span> (i=0; i&lt;len; i++) {
<a name="l01532"></a>01532                     <span class="keywordflow">if</span> (i &amp; 1)
<a name="l01533"></a>01533                         bits &lt;&lt;= 4;
<a name="l01534"></a>01534                     <span class="keywordflow">else</span>
<a name="l01535"></a>01535                         bits = *s++;
<a name="l01536"></a>01536                     *t++ = hexdigits[(bits &gt;&gt; 4) &amp; 15];
<a name="l01537"></a>01537                 }
<a name="l01538"></a>01538             }
<a name="l01539"></a>01539             <span class="keywordflow">break</span>;
<a name="l01540"></a>01540 
<a name="l01541"></a>01541           <span class="keywordflow">case</span> <span class="charliteral">&apos;c&apos;</span>:
<a name="l01542"></a>01542             <a class="code" href="../../d1/d7d/pack_8c.html#a6c749560bce2dcea8fd86b62037e7a02">PACK_LENGTH_ADJUST_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>));
<a name="l01543"></a>01543             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l01544"></a>01544                 <span class="keywordtype">int</span> c = *s++;
<a name="l01545"></a>01545                 <span class="keywordflow">if</span> (c &gt; (<span class="keywordtype">char</span>)127) c-=256;
<a name="l01546"></a>01546                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(c));
<a name="l01547"></a>01547             }
<a name="l01548"></a>01548             <a class="code" href="../../d1/d7d/pack_8c.html#aa23aff96b6ff6a9b87c992d3093f0e41">PACK_ITEM_ADJUST</a>();
<a name="l01549"></a>01549             <span class="keywordflow">break</span>;
<a name="l01550"></a>01550 
<a name="l01551"></a>01551           <span class="keywordflow">case</span> <span class="charliteral">&apos;C&apos;</span>:
<a name="l01552"></a>01552             <a class="code" href="../../d1/d7d/pack_8c.html#a6c749560bce2dcea8fd86b62037e7a02">PACK_LENGTH_ADJUST_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>));
<a name="l01553"></a>01553             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l01554"></a>01554                 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c = *s++;
<a name="l01555"></a>01555                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(c));
<a name="l01556"></a>01556             }
<a name="l01557"></a>01557             <a class="code" href="../../d1/d7d/pack_8c.html#aa23aff96b6ff6a9b87c992d3093f0e41">PACK_ITEM_ADJUST</a>();
<a name="l01558"></a>01558             <span class="keywordflow">break</span>;
<a name="l01559"></a>01559 
<a name="l01560"></a>01560           <span class="keywordflow">case</span> <span class="charliteral">&apos;s&apos;</span>:
<a name="l01561"></a>01561             signed_p = 1;
<a name="l01562"></a>01562             integer_size = <a class="code" href="../../d1/d7d/pack_8c.html#a43fde2e64181f2ee17a4e448a546010c">NATINT_LEN</a>(<span class="keywordtype">short</span>, 2);
<a name="l01563"></a>01563             bigendian_p = <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>();
<a name="l01564"></a>01564             <span class="keywordflow">goto</span> unpack_integer;
<a name="l01565"></a>01565 
<a name="l01566"></a>01566           <span class="keywordflow">case</span> <span class="charliteral">&apos;S&apos;</span>:
<a name="l01567"></a>01567             signed_p = 0;
<a name="l01568"></a>01568             integer_size = <a class="code" href="../../d1/d7d/pack_8c.html#a43fde2e64181f2ee17a4e448a546010c">NATINT_LEN</a>(<span class="keywordtype">short</span>, 2);
<a name="l01569"></a>01569             bigendian_p = <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>();
<a name="l01570"></a>01570             <span class="keywordflow">goto</span> unpack_integer;
<a name="l01571"></a>01571 
<a name="l01572"></a>01572           <span class="keywordflow">case</span> <span class="charliteral">&apos;i&apos;</span>:
<a name="l01573"></a>01573             signed_p = 1;
<a name="l01574"></a>01574             integer_size = (int)<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>);
<a name="l01575"></a>01575             bigendian_p = <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>();
<a name="l01576"></a>01576             <span class="keywordflow">goto</span> unpack_integer;
<a name="l01577"></a>01577 
<a name="l01578"></a>01578           <span class="keywordflow">case</span> <span class="charliteral">&apos;I&apos;</span>:
<a name="l01579"></a>01579             signed_p = 0;
<a name="l01580"></a>01580             integer_size = (int)<span class="keyword">sizeof</span>(<span class="keywordtype">int</span>);
<a name="l01581"></a>01581             bigendian_p = <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>();
<a name="l01582"></a>01582             <span class="keywordflow">goto</span> unpack_integer;
<a name="l01583"></a>01583 
<a name="l01584"></a>01584           <span class="keywordflow">case</span> <span class="charliteral">&apos;l&apos;</span>:
<a name="l01585"></a>01585             signed_p = 1;
<a name="l01586"></a>01586             integer_size = <a class="code" href="../../d1/d7d/pack_8c.html#a43fde2e64181f2ee17a4e448a546010c">NATINT_LEN</a>(<span class="keywordtype">long</span>, 4);
<a name="l01587"></a>01587             bigendian_p = <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>();
<a name="l01588"></a>01588             <span class="keywordflow">goto</span> unpack_integer;
<a name="l01589"></a>01589 
<a name="l01590"></a>01590           <span class="keywordflow">case</span> <span class="charliteral">&apos;L&apos;</span>:
<a name="l01591"></a>01591             signed_p = 0;
<a name="l01592"></a>01592             integer_size = <a class="code" href="../../d1/d7d/pack_8c.html#a43fde2e64181f2ee17a4e448a546010c">NATINT_LEN</a>(<span class="keywordtype">long</span>, 4);
<a name="l01593"></a>01593             bigendian_p = <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>();
<a name="l01594"></a>01594             <span class="keywordflow">goto</span> unpack_integer;
<a name="l01595"></a>01595 
<a name="l01596"></a>01596           <span class="keywordflow">case</span> <span class="charliteral">&apos;q&apos;</span>:
<a name="l01597"></a>01597             signed_p = 1;
<a name="l01598"></a>01598             integer_size = 8;
<a name="l01599"></a>01599             bigendian_p = <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>();
<a name="l01600"></a>01600             <span class="keywordflow">goto</span> unpack_integer;
<a name="l01601"></a>01601 
<a name="l01602"></a>01602           <span class="keywordflow">case</span> <span class="charliteral">&apos;Q&apos;</span>:
<a name="l01603"></a>01603             signed_p = 0;
<a name="l01604"></a>01604             integer_size = 8;
<a name="l01605"></a>01605             bigendian_p = <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>();
<a name="l01606"></a>01606             <span class="keywordflow">goto</span> unpack_integer;
<a name="l01607"></a>01607 
<a name="l01608"></a>01608           <span class="keywordflow">case</span> <span class="charliteral">&apos;n&apos;</span>:
<a name="l01609"></a>01609             signed_p = 0;
<a name="l01610"></a>01610             integer_size = 2;
<a name="l01611"></a>01611             bigendian_p = 1;
<a name="l01612"></a>01612             <span class="keywordflow">goto</span> unpack_integer;
<a name="l01613"></a>01613 
<a name="l01614"></a>01614           <span class="keywordflow">case</span> <span class="charliteral">&apos;N&apos;</span>:
<a name="l01615"></a>01615             signed_p = 0;
<a name="l01616"></a>01616             integer_size = 4;
<a name="l01617"></a>01617             bigendian_p = 1;
<a name="l01618"></a>01618             <span class="keywordflow">goto</span> unpack_integer;
<a name="l01619"></a>01619 
<a name="l01620"></a>01620           <span class="keywordflow">case</span> <span class="charliteral">&apos;v&apos;</span>:
<a name="l01621"></a>01621             signed_p = 0;
<a name="l01622"></a>01622             integer_size = 2;
<a name="l01623"></a>01623             bigendian_p = 0;
<a name="l01624"></a>01624             <span class="keywordflow">goto</span> unpack_integer;
<a name="l01625"></a>01625 
<a name="l01626"></a>01626           <span class="keywordflow">case</span> <span class="charliteral">&apos;V&apos;</span>:
<a name="l01627"></a>01627             signed_p = 0;
<a name="l01628"></a>01628             integer_size = 4;
<a name="l01629"></a>01629             bigendian_p = 0;
<a name="l01630"></a>01630             <span class="keywordflow">goto</span> unpack_integer;
<a name="l01631"></a>01631 
<a name="l01632"></a>01632           unpack_integer:
<a name="l01633"></a>01633             <span class="keywordflow">if</span> (explicit_endian) {
<a name="l01634"></a>01634                 bigendian_p = explicit_endian == <span class="charliteral">&apos;&gt;&apos;</span>;
<a name="l01635"></a>01635             }
<a name="l01636"></a>01636 
<a name="l01637"></a>01637             <span class="keywordflow">switch</span> (integer_size) {
<a name="l01638"></a>01638 <span class="preprocessor">#if defined(HAVE_INT16_T) &amp;&amp; !defined(FORCE_BIG_PACK)</span>
<a name="l01639"></a>01639 <span class="preprocessor"></span>              <span class="keywordflow">case</span> SIZEOF_INT16_T:
<a name="l01640"></a>01640                 <span class="keywordflow">if</span> (signed_p) {
<a name="l01641"></a>01641                     <a class="code" href="../../d1/d7d/pack_8c.html#a6c749560bce2dcea8fd86b62037e7a02">PACK_LENGTH_ADJUST_SIZE</a>(<span class="keyword">sizeof</span>(int16_t));
<a name="l01642"></a>01642                     <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l01643"></a>01643                         <span class="keyword">union </span>{
<a name="l01644"></a>01644                             int16_t i;
<a name="l01645"></a>01645                             <span class="keywordtype">char</span> a[<span class="keyword">sizeof</span>(int16_t)];
<a name="l01646"></a>01646                         } v;
<a name="l01647"></a>01647                         memcpy(v.a, s, <span class="keyword">sizeof</span>(int16_t));
<a name="l01648"></a>01648                         <span class="keywordflow">if</span> (bigendian_p != <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>()) v.i = <a class="code" href="../../d1/d7d/pack_8c.html#a230ba4a10a19fd06db52f5a5ed957d2b">swap16</a>(v.i);
<a name="l01649"></a>01649                         s += <span class="keyword">sizeof</span>(int16_t);
<a name="l01650"></a>01650                         <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(v.i));
<a name="l01651"></a>01651                     }
<a name="l01652"></a>01652                     <a class="code" href="../../d1/d7d/pack_8c.html#aa23aff96b6ff6a9b87c992d3093f0e41">PACK_ITEM_ADJUST</a>();
<a name="l01653"></a>01653                 }
<a name="l01654"></a>01654                 <span class="keywordflow">else</span> {
<a name="l01655"></a>01655                     <a class="code" href="../../d1/d7d/pack_8c.html#a6c749560bce2dcea8fd86b62037e7a02">PACK_LENGTH_ADJUST_SIZE</a>(<span class="keyword">sizeof</span>(uint16_t));
<a name="l01656"></a>01656                     <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l01657"></a>01657                         <span class="keyword">union </span>{
<a name="l01658"></a>01658                             uint16_t i;
<a name="l01659"></a>01659                             <span class="keywordtype">char</span> a[<span class="keyword">sizeof</span>(uint16_t)];
<a name="l01660"></a>01660                         } v;
<a name="l01661"></a>01661                         memcpy(v.a, s, <span class="keyword">sizeof</span>(uint16_t));
<a name="l01662"></a>01662                         <span class="keywordflow">if</span> (bigendian_p != <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>()) v.i = <a class="code" href="../../d1/d7d/pack_8c.html#a230ba4a10a19fd06db52f5a5ed957d2b">swap16</a>(v.i);
<a name="l01663"></a>01663                         s += <span class="keyword">sizeof</span>(uint16_t);
<a name="l01664"></a>01664                         <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(v.i));
<a name="l01665"></a>01665                     }
<a name="l01666"></a>01666                     <a class="code" href="../../d1/d7d/pack_8c.html#aa23aff96b6ff6a9b87c992d3093f0e41">PACK_ITEM_ADJUST</a>();
<a name="l01667"></a>01667                 }
<a name="l01668"></a>01668                 <span class="keywordflow">break</span>;
<a name="l01669"></a>01669 <span class="preprocessor">#endif</span>
<a name="l01670"></a>01670 <span class="preprocessor"></span>
<a name="l01671"></a>01671 <span class="preprocessor">#if defined(HAVE_INT32_T) &amp;&amp; !defined(FORCE_BIG_PACK)</span>
<a name="l01672"></a>01672 <span class="preprocessor"></span>              <span class="keywordflow">case</span> SIZEOF_INT32_T:
<a name="l01673"></a>01673                 <span class="keywordflow">if</span> (signed_p) {
<a name="l01674"></a>01674                     <a class="code" href="../../d1/d7d/pack_8c.html#a6c749560bce2dcea8fd86b62037e7a02">PACK_LENGTH_ADJUST_SIZE</a>(<span class="keyword">sizeof</span>(int32_t));
<a name="l01675"></a>01675                     <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l01676"></a>01676                         <span class="keyword">union </span>{
<a name="l01677"></a>01677                             int32_t i;
<a name="l01678"></a>01678                             <span class="keywordtype">char</span> a[<span class="keyword">sizeof</span>(int32_t)];
<a name="l01679"></a>01679                         } v;
<a name="l01680"></a>01680                         memcpy(v.a, s, <span class="keyword">sizeof</span>(int32_t));
<a name="l01681"></a>01681                         <span class="keywordflow">if</span> (bigendian_p != <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>()) v.i = <a class="code" href="../../d1/d7d/pack_8c.html#a40f89812fbb971f324be796c9854a590">swap32</a>(v.i);
<a name="l01682"></a>01682                         s += <span class="keyword">sizeof</span>(int32_t);
<a name="l01683"></a>01683                         <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(v.i));
<a name="l01684"></a>01684                     }
<a name="l01685"></a>01685                     <a class="code" href="../../d1/d7d/pack_8c.html#aa23aff96b6ff6a9b87c992d3093f0e41">PACK_ITEM_ADJUST</a>();
<a name="l01686"></a>01686                 }
<a name="l01687"></a>01687                 <span class="keywordflow">else</span> {
<a name="l01688"></a>01688                     <a class="code" href="../../d1/d7d/pack_8c.html#a6c749560bce2dcea8fd86b62037e7a02">PACK_LENGTH_ADJUST_SIZE</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../db/d4d/sha2_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>));
<a name="l01689"></a>01689                     <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l01690"></a>01690                         <span class="keyword">union </span>{
<a name="l01691"></a>01691                             <a class="code" href="../../db/d4d/sha2_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> i;
<a name="l01692"></a>01692                             <span class="keywordtype">char</span> a[<span class="keyword">sizeof</span>(<a class="code" href="../../db/d4d/sha2_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>)];
<a name="l01693"></a>01693                         } v;
<a name="l01694"></a>01694                         memcpy(v.a, s, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d4d/sha2_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>));
<a name="l01695"></a>01695                         <span class="keywordflow">if</span> (bigendian_p != <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>()) v.i = <a class="code" href="../../d1/d7d/pack_8c.html#a40f89812fbb971f324be796c9854a590">swap32</a>(v.i);
<a name="l01696"></a>01696                         s += <span class="keyword">sizeof</span>(<a class="code" href="../../db/d4d/sha2_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a>);
<a name="l01697"></a>01697                         <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6eb3054f7a740d26c133d34ae6afdf2c">UINT2NUM</a>(v.i));
<a name="l01698"></a>01698                     }
<a name="l01699"></a>01699                     <a class="code" href="../../d1/d7d/pack_8c.html#aa23aff96b6ff6a9b87c992d3093f0e41">PACK_ITEM_ADJUST</a>();
<a name="l01700"></a>01700                 }
<a name="l01701"></a>01701                 <span class="keywordflow">break</span>;
<a name="l01702"></a>01702 <span class="preprocessor">#endif</span>
<a name="l01703"></a>01703 <span class="preprocessor"></span>
<a name="l01704"></a>01704 <span class="preprocessor">#if defined(HAVE_INT64_T) &amp;&amp; !defined(FORCE_BIG_PACK)</span>
<a name="l01705"></a>01705 <span class="preprocessor"></span>              <span class="keywordflow">case</span> SIZEOF_INT64_T:
<a name="l01706"></a>01706                 <span class="keywordflow">if</span> (signed_p) {
<a name="l01707"></a>01707                     <a class="code" href="../../d1/d7d/pack_8c.html#a6c749560bce2dcea8fd86b62037e7a02">PACK_LENGTH_ADJUST_SIZE</a>(<span class="keyword">sizeof</span>(int64_t));
<a name="l01708"></a>01708                     <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l01709"></a>01709                         <span class="keyword">union </span>{
<a name="l01710"></a>01710                             int64_t i;
<a name="l01711"></a>01711                             <span class="keywordtype">char</span> a[<span class="keyword">sizeof</span>(int64_t)];
<a name="l01712"></a>01712                         } v;
<a name="l01713"></a>01713                         memcpy(v.a, s, <span class="keyword">sizeof</span>(int64_t));
<a name="l01714"></a>01714                         <span class="keywordflow">if</span> (bigendian_p != <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>()) v.i = swap64(v.i);
<a name="l01715"></a>01715                         s += <span class="keyword">sizeof</span>(int64_t);
<a name="l01716"></a>01716                         <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(INT64toNUM(v.i));
<a name="l01717"></a>01717                     }
<a name="l01718"></a>01718                     <a class="code" href="../../d1/d7d/pack_8c.html#aa23aff96b6ff6a9b87c992d3093f0e41">PACK_ITEM_ADJUST</a>();
<a name="l01719"></a>01719                 }
<a name="l01720"></a>01720                 <span class="keywordflow">else</span> {
<a name="l01721"></a>01721                     <a class="code" href="../../d1/d7d/pack_8c.html#a6c749560bce2dcea8fd86b62037e7a02">PACK_LENGTH_ADJUST_SIZE</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../df/dac/siphash_8h.html#a104204cb123abb831baa5adcfffc64e0">uint64_t</a>));
<a name="l01722"></a>01722                     <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l01723"></a>01723                         <span class="keyword">union </span>{
<a name="l01724"></a>01724                             <a class="code" href="../../df/dac/siphash_8h.html#a104204cb123abb831baa5adcfffc64e0">uint64_t</a> i;
<a name="l01725"></a>01725                             <span class="keywordtype">char</span> a[<span class="keyword">sizeof</span>(<a class="code" href="../../df/dac/siphash_8h.html#a104204cb123abb831baa5adcfffc64e0">uint64_t</a>)];
<a name="l01726"></a>01726                         } v;
<a name="l01727"></a>01727                         memcpy(v.a, s, <span class="keyword">sizeof</span>(<a class="code" href="../../df/dac/siphash_8h.html#a104204cb123abb831baa5adcfffc64e0">uint64_t</a>));
<a name="l01728"></a>01728                         <span class="keywordflow">if</span> (bigendian_p != <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>()) v.i = swap64(v.i);
<a name="l01729"></a>01729                         s += <span class="keyword">sizeof</span>(<a class="code" href="../../df/dac/siphash_8h.html#a104204cb123abb831baa5adcfffc64e0">uint64_t</a>);
<a name="l01730"></a>01730                         <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(UINT64toNUM(v.i));
<a name="l01731"></a>01731                     }
<a name="l01732"></a>01732                     <a class="code" href="../../d1/d7d/pack_8c.html#aa23aff96b6ff6a9b87c992d3093f0e41">PACK_ITEM_ADJUST</a>();
<a name="l01733"></a>01733                 }
<a name="l01734"></a>01734                 <span class="keywordflow">break</span>;
<a name="l01735"></a>01735 <span class="preprocessor">#endif</span>
<a name="l01736"></a>01736 <span class="preprocessor"></span>
<a name="l01737"></a>01737               <span class="keywordflow">default</span>:
<a name="l01738"></a>01738                 <span class="keywordflow">if</span> (integer_size &gt; <a class="code" href="../../d1/d7d/pack_8c.html#a9bff5a43748b01cca699f5a0a4ccff05">MAX_INTEGER_PACK_SIZE</a>)
<a name="l01739"></a>01739                     <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;unexpected intger size for pack: %d&quot;</span>, integer_size);
<a name="l01740"></a>01740                 <a class="code" href="../../d1/d7d/pack_8c.html#a6c749560bce2dcea8fd86b62037e7a02">PACK_LENGTH_ADJUST_SIZE</a>(integer_size);
<a name="l01741"></a>01741                 <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l01742"></a>01742                     <span class="keyword">union </span>{
<a name="l01743"></a>01743                         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> i[(<a class="code" href="../../d1/d7d/pack_8c.html#a9bff5a43748b01cca699f5a0a4ccff05">MAX_INTEGER_PACK_SIZE</a>+SIZEOF_LONG)/SIZEOF_LONG];
<a name="l01744"></a>01744                         <span class="keywordtype">char</span> a[(<a class="code" href="../../d1/d7d/pack_8c.html#a9bff5a43748b01cca699f5a0a4ccff05">MAX_INTEGER_PACK_SIZE</a>+SIZEOF_LONG)/SIZEOF_LONG*SIZEOF_LONG];
<a name="l01745"></a>01745                     } v;
<a name="l01746"></a>01746                     <span class="keywordtype">int</span> num_longs = (integer_size+SIZEOF_LONG)/SIZEOF_LONG;
<a name="l01747"></a>01747                     <span class="keywordtype">int</span> i;
<a name="l01748"></a>01748 
<a name="l01749"></a>01749                     <span class="keywordflow">if</span> (signed_p &amp;&amp; (<span class="keywordtype">signed</span> <span class="keywordtype">char</span>)s[bigendian_p ? 0 : (integer_size-1)] &lt; 0)
<a name="l01750"></a>01750                         memset(v.a, 0xff, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>)*num_longs);
<a name="l01751"></a>01751                     <span class="keywordflow">else</span>
<a name="l01752"></a>01752                         memset(v.a, 0, <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>)*num_longs);
<a name="l01753"></a>01753                     <span class="keywordflow">if</span> (bigendian_p)
<a name="l01754"></a>01754                         memcpy(v.a + <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>)*num_longs - integer_size, s, integer_size);
<a name="l01755"></a>01755                     <span class="keywordflow">else</span>
<a name="l01756"></a>01756                         memcpy(v.a, s, integer_size);
<a name="l01757"></a>01757                     <span class="keywordflow">if</span> (bigendian_p) {
<a name="l01758"></a>01758                         <span class="keywordflow">for</span> (i = 0; i &lt; num_longs/2; i++) {
<a name="l01759"></a>01759                             <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> t = v.i[i];
<a name="l01760"></a>01760                             v.i[i] = v.i[num_longs-1-i];
<a name="l01761"></a>01761                             v.i[num_longs-1-i] = t;
<a name="l01762"></a>01762                         }
<a name="l01763"></a>01763                     }
<a name="l01764"></a>01764                     <span class="keywordflow">if</span> (bigendian_p != <a class="code" href="../../d1/d7d/pack_8c.html#a980b99bf64c56d895d7c0974a1754614">BIGENDIAN_P</a>()) {
<a name="l01765"></a>01765                         <span class="keywordflow">for</span> (i = 0; i &lt; num_longs; i++)
<a name="l01766"></a>01766                             v.i[i] = swapl(v.i[i]);
<a name="l01767"></a>01767                     }
<a name="l01768"></a>01768                     s += integer_size;
<a name="l01769"></a>01769                     <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../d1/dcc/bignum_8c.html#aa5376ddc40f044463d5d52d5d120e0d0">rb_big_unpack</a>(v.i, num_longs));
<a name="l01770"></a>01770                 }
<a name="l01771"></a>01771                 <a class="code" href="../../d1/d7d/pack_8c.html#aa23aff96b6ff6a9b87c992d3093f0e41">PACK_ITEM_ADJUST</a>();
<a name="l01772"></a>01772                 <span class="keywordflow">break</span>;
<a name="l01773"></a>01773             }
<a name="l01774"></a>01774             <span class="keywordflow">break</span>;
<a name="l01775"></a>01775 
<a name="l01776"></a>01776           <span class="keywordflow">case</span> <span class="charliteral">&apos;f&apos;</span>:
<a name="l01777"></a>01777           <span class="keywordflow">case</span> <span class="charliteral">&apos;F&apos;</span>:
<a name="l01778"></a>01778             <a class="code" href="../../d1/d7d/pack_8c.html#a6c749560bce2dcea8fd86b62037e7a02">PACK_LENGTH_ADJUST_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l01779"></a>01779             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l01780"></a>01780                 <span class="keywordtype">float</span> tmp;
<a name="l01781"></a>01781                 memcpy(&amp;tmp, s, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l01782"></a>01782                 s += <span class="keyword">sizeof</span>(float);
<a name="l01783"></a>01783                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4affd02e0f0fe17593cd4ecd78cf9064">DBL2NUM</a>((<span class="keywordtype">double</span>)tmp));
<a name="l01784"></a>01784             }
<a name="l01785"></a>01785             <a class="code" href="../../d1/d7d/pack_8c.html#aa23aff96b6ff6a9b87c992d3093f0e41">PACK_ITEM_ADJUST</a>();
<a name="l01786"></a>01786             <span class="keywordflow">break</span>;
<a name="l01787"></a>01787 
<a name="l01788"></a>01788           <span class="keywordflow">case</span> <span class="charliteral">&apos;e&apos;</span>:
<a name="l01789"></a>01789             <a class="code" href="../../d1/d7d/pack_8c.html#a6c749560bce2dcea8fd86b62037e7a02">PACK_LENGTH_ADJUST_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l01790"></a>01790             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l01791"></a>01791                 <span class="keywordtype">float</span> tmp;
<a name="l01792"></a>01792                 <a class="code" href="../../d1/d7d/pack_8c.html#af5b4a08285420f761188eb970aac5f2e">FLOAT_CONVWITH</a>(ftmp);
<a name="l01793"></a>01793 
<a name="l01794"></a>01794                 memcpy(&amp;tmp, s, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l01795"></a>01795                 s += <span class="keyword">sizeof</span>(float);
<a name="l01796"></a>01796                 tmp = <a class="code" href="../../d1/d7d/pack_8c.html#a920cc26108a9ad46734217cde0533bce">VTOHF</a>(tmp,ftmp);
<a name="l01797"></a>01797                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4affd02e0f0fe17593cd4ecd78cf9064">DBL2NUM</a>((<span class="keywordtype">double</span>)tmp));
<a name="l01798"></a>01798             }
<a name="l01799"></a>01799             <a class="code" href="../../d1/d7d/pack_8c.html#aa23aff96b6ff6a9b87c992d3093f0e41">PACK_ITEM_ADJUST</a>();
<a name="l01800"></a>01800             <span class="keywordflow">break</span>;
<a name="l01801"></a>01801 
<a name="l01802"></a>01802           <span class="keywordflow">case</span> <span class="charliteral">&apos;E&apos;</span>:
<a name="l01803"></a>01803             <a class="code" href="../../d1/d7d/pack_8c.html#a6c749560bce2dcea8fd86b62037e7a02">PACK_LENGTH_ADJUST_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l01804"></a>01804             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l01805"></a>01805                 <span class="keywordtype">double</span> tmp;
<a name="l01806"></a>01806                 <a class="code" href="../../d1/d7d/pack_8c.html#a5d9a17821872e6964ceaaf352e959e7b">DOUBLE_CONVWITH</a>(dtmp);
<a name="l01807"></a>01807 
<a name="l01808"></a>01808                 memcpy(&amp;tmp, s, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l01809"></a>01809                 s += <span class="keyword">sizeof</span>(double);
<a name="l01810"></a>01810                 tmp = <a class="code" href="../../d1/d7d/pack_8c.html#aef31578ff1c0d598344efff5cb287110">VTOHD</a>(tmp,dtmp);
<a name="l01811"></a>01811                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4affd02e0f0fe17593cd4ecd78cf9064">DBL2NUM</a>(tmp));
<a name="l01812"></a>01812             }
<a name="l01813"></a>01813             <a class="code" href="../../d1/d7d/pack_8c.html#aa23aff96b6ff6a9b87c992d3093f0e41">PACK_ITEM_ADJUST</a>();
<a name="l01814"></a>01814             <span class="keywordflow">break</span>;
<a name="l01815"></a>01815 
<a name="l01816"></a>01816           <span class="keywordflow">case</span> <span class="charliteral">&apos;D&apos;</span>:
<a name="l01817"></a>01817           <span class="keywordflow">case</span> <span class="charliteral">&apos;d&apos;</span>:
<a name="l01818"></a>01818             <a class="code" href="../../d1/d7d/pack_8c.html#a6c749560bce2dcea8fd86b62037e7a02">PACK_LENGTH_ADJUST_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l01819"></a>01819             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l01820"></a>01820                 <span class="keywordtype">double</span> tmp;
<a name="l01821"></a>01821                 memcpy(&amp;tmp, s, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l01822"></a>01822                 s += <span class="keyword">sizeof</span>(double);
<a name="l01823"></a>01823                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4affd02e0f0fe17593cd4ecd78cf9064">DBL2NUM</a>(tmp));
<a name="l01824"></a>01824             }
<a name="l01825"></a>01825             <a class="code" href="../../d1/d7d/pack_8c.html#aa23aff96b6ff6a9b87c992d3093f0e41">PACK_ITEM_ADJUST</a>();
<a name="l01826"></a>01826             <span class="keywordflow">break</span>;
<a name="l01827"></a>01827 
<a name="l01828"></a>01828           <span class="keywordflow">case</span> <span class="charliteral">&apos;g&apos;</span>:
<a name="l01829"></a>01829             <a class="code" href="../../d1/d7d/pack_8c.html#a6c749560bce2dcea8fd86b62037e7a02">PACK_LENGTH_ADJUST_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l01830"></a>01830             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l01831"></a>01831                 <span class="keywordtype">float</span> tmp;
<a name="l01832"></a>01832                 <a class="code" href="../../d1/d7d/pack_8c.html#af5b4a08285420f761188eb970aac5f2e">FLOAT_CONVWITH</a>(ftmp);
<a name="l01833"></a>01833 
<a name="l01834"></a>01834                 memcpy(&amp;tmp, s, <span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));
<a name="l01835"></a>01835                 s += <span class="keyword">sizeof</span>(float);
<a name="l01836"></a>01836                 tmp = <a class="code" href="../../d1/d7d/pack_8c.html#a2928217773b3329d21b7b50cb8553e78">NTOHF</a>(tmp,ftmp);
<a name="l01837"></a>01837                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4affd02e0f0fe17593cd4ecd78cf9064">DBL2NUM</a>((<span class="keywordtype">double</span>)tmp));
<a name="l01838"></a>01838             }
<a name="l01839"></a>01839             <a class="code" href="../../d1/d7d/pack_8c.html#aa23aff96b6ff6a9b87c992d3093f0e41">PACK_ITEM_ADJUST</a>();
<a name="l01840"></a>01840             <span class="keywordflow">break</span>;
<a name="l01841"></a>01841 
<a name="l01842"></a>01842           <span class="keywordflow">case</span> <span class="charliteral">&apos;G&apos;</span>:
<a name="l01843"></a>01843             <a class="code" href="../../d1/d7d/pack_8c.html#a6c749560bce2dcea8fd86b62037e7a02">PACK_LENGTH_ADJUST_SIZE</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l01844"></a>01844             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l01845"></a>01845                 <span class="keywordtype">double</span> tmp;
<a name="l01846"></a>01846                 <a class="code" href="../../d1/d7d/pack_8c.html#a5d9a17821872e6964ceaaf352e959e7b">DOUBLE_CONVWITH</a>(dtmp);
<a name="l01847"></a>01847 
<a name="l01848"></a>01848                 memcpy(&amp;tmp, s, <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));
<a name="l01849"></a>01849                 s += <span class="keyword">sizeof</span>(double);
<a name="l01850"></a>01850                 tmp = <a class="code" href="../../d1/d7d/pack_8c.html#abaa94f306a599f84e65c5245b2ce5c95">NTOHD</a>(tmp,dtmp);
<a name="l01851"></a>01851                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4affd02e0f0fe17593cd4ecd78cf9064">DBL2NUM</a>(tmp));
<a name="l01852"></a>01852             }
<a name="l01853"></a>01853             <a class="code" href="../../d1/d7d/pack_8c.html#aa23aff96b6ff6a9b87c992d3093f0e41">PACK_ITEM_ADJUST</a>();
<a name="l01854"></a>01854             <span class="keywordflow">break</span>;
<a name="l01855"></a>01855 
<a name="l01856"></a>01856           <span class="keywordflow">case</span> <span class="charliteral">&apos;U&apos;</span>:
<a name="l01857"></a>01857             <span class="keywordflow">if</span> (len &gt; send - s) len = send - s;
<a name="l01858"></a>01858             <span class="keywordflow">while</span> (len &gt; 0 &amp;&amp; s &lt; send) {
<a name="l01859"></a>01859                 <span class="keywordtype">long</span> alen = send - s;
<a name="l01860"></a>01860                 <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> l;
<a name="l01861"></a>01861 
<a name="l01862"></a>01862                 l = <a class="code" href="../../d1/d7d/pack_8c.html#af5486696d49eda881dc03ff113431bc5">utf8_to_uv</a>(s, &amp;alen);
<a name="l01863"></a>01863                 s += alen; len--;
<a name="l01864"></a>01864                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad9f758738ddf6560da578a4425987892">ULONG2NUM</a>(l));
<a name="l01865"></a>01865             }
<a name="l01866"></a>01866             <span class="keywordflow">break</span>;
<a name="l01867"></a>01867 
<a name="l01868"></a>01868           <span class="keywordflow">case</span> <span class="charliteral">&apos;u&apos;</span>:
<a name="l01869"></a>01869             {
<a name="l01870"></a>01870                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a> = <a class="code" href="../../d1/d7d/pack_8c.html#a86b9f5ea794549bedec734d5694bde44">infected_str_new</a>(0, (send - s)*3/4, str);
<a name="l01871"></a>01871                 <span class="keywordtype">char</span> *ptr = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(buf);
<a name="l01872"></a>01872                 <span class="keywordtype">long</span> total = 0;
<a name="l01873"></a>01873 
<a name="l01874"></a>01874                 <span class="keywordflow">while</span> (s &lt; send &amp;&amp; *s &gt; <span class="charliteral">&apos; &apos;</span> &amp;&amp; *s &lt; <span class="charliteral">&apos;a&apos;</span>) {
<a name="l01875"></a>01875                     <span class="keywordtype">long</span> a,b,c,d;
<a name="l01876"></a>01876                     <span class="keywordtype">char</span> hunk[4];
<a name="l01877"></a>01877 
<a name="l01878"></a>01878                     hunk[3] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01879"></a>01879                     len = (*s++ - <span class="charliteral">&apos; &apos;</span>) &amp; 077;
<a name="l01880"></a>01880                     total += len;
<a name="l01881"></a>01881                     <span class="keywordflow">if</span> (total &gt; <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(buf)) {
<a name="l01882"></a>01882                         len -= total - <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(buf);
<a name="l01883"></a>01883                         total = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(buf);
<a name="l01884"></a>01884                     }
<a name="l01885"></a>01885 
<a name="l01886"></a>01886                     <span class="keywordflow">while</span> (len &gt; 0) {
<a name="l01887"></a>01887                         <span class="keywordtype">long</span> mlen = len &gt; 3 ? 3 : len;
<a name="l01888"></a>01888 
<a name="l01889"></a>01889                         <span class="keywordflow">if</span> (s &lt; send &amp;&amp; *s &gt;= <span class="charliteral">&apos; &apos;</span>)
<a name="l01890"></a>01890                             a = (*s++ - <span class="charliteral">&apos; &apos;</span>) &amp; 077;
<a name="l01891"></a>01891                         <span class="keywordflow">else</span>
<a name="l01892"></a>01892                             a = 0;
<a name="l01893"></a>01893                         <span class="keywordflow">if</span> (s &lt; send &amp;&amp; *s &gt;= <span class="charliteral">&apos; &apos;</span>)
<a name="l01894"></a>01894                             b = (*s++ - <span class="charliteral">&apos; &apos;</span>) &amp; 077;
<a name="l01895"></a>01895                         <span class="keywordflow">else</span>
<a name="l01896"></a>01896                             b = 0;
<a name="l01897"></a>01897                         <span class="keywordflow">if</span> (s &lt; send &amp;&amp; *s &gt;= <span class="charliteral">&apos; &apos;</span>)
<a name="l01898"></a>01898                             c = (*s++ - <span class="charliteral">&apos; &apos;</span>) &amp; 077;
<a name="l01899"></a>01899                         <span class="keywordflow">else</span>
<a name="l01900"></a>01900                             c = 0;
<a name="l01901"></a>01901                         <span class="keywordflow">if</span> (s &lt; send &amp;&amp; *s &gt;= <span class="charliteral">&apos; &apos;</span>)
<a name="l01902"></a>01902                             d = (*s++ - <span class="charliteral">&apos; &apos;</span>) &amp; 077;
<a name="l01903"></a>01903                         <span class="keywordflow">else</span>
<a name="l01904"></a>01904                             d = 0;
<a name="l01905"></a>01905                         hunk[0] = (char)(a &lt;&lt; 2 | b &gt;&gt; 4);
<a name="l01906"></a>01906                         hunk[1] = (char)(b &lt;&lt; 4 | c &gt;&gt; 2);
<a name="l01907"></a>01907                         hunk[2] = (char)(c &lt;&lt; 6 | d);
<a name="l01908"></a>01908                         memcpy(ptr, hunk, mlen);
<a name="l01909"></a>01909                         ptr += mlen;
<a name="l01910"></a>01910                         len -= mlen;
<a name="l01911"></a>01911                     }
<a name="l01912"></a>01912                     <span class="keywordflow">if</span> (*s == <span class="charliteral">&apos;\r&apos;</span>) s++;
<a name="l01913"></a>01913                     <span class="keywordflow">if</span> (*s == <span class="charliteral">&apos;\n&apos;</span>) s++;
<a name="l01914"></a>01914                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s &lt; send &amp;&amp; (s+1 == send || s[1] == <span class="charliteral">&apos;\n&apos;</span>))
<a name="l01915"></a>01915                         s += 2; <span class="comment">/* possible checksum byte */</span>
<a name="l01916"></a>01916                 }
<a name="l01917"></a>01917 
<a name="l01918"></a>01918                 <a class="code" href="../../d8/d81/ruby__missing_8h.html#a89ed8cb86ca6dd49d2db67adae809057">rb_str_set_len</a>(buf, total);
<a name="l01919"></a>01919                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(buf);
<a name="l01920"></a>01920             }
<a name="l01921"></a>01921             <span class="keywordflow">break</span>;
<a name="l01922"></a>01922 
<a name="l01923"></a>01923           <span class="keywordflow">case</span> <span class="charliteral">&apos;m&apos;</span>:
<a name="l01924"></a>01924             {
<a name="l01925"></a>01925                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a> = <a class="code" href="../../d1/d7d/pack_8c.html#a86b9f5ea794549bedec734d5694bde44">infected_str_new</a>(0, (send - s)*3/4, str);
<a name="l01926"></a>01926                 <span class="keywordtype">char</span> *ptr = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(buf);
<a name="l01927"></a>01927                 <span class="keywordtype">int</span> a = -1,b = -1,c = 0,d = 0;
<a name="l01928"></a>01928                 <span class="keyword">static</span> <span class="keywordtype">signed</span> <span class="keywordtype">char</span> b64_xtable[256];
<a name="l01929"></a>01929 
<a name="l01930"></a>01930                 <span class="keywordflow">if</span> (b64_xtable[<span class="charliteral">&apos;/&apos;</span>] &lt;= 0) {
<a name="l01931"></a>01931                     <span class="keywordtype">int</span> i;
<a name="l01932"></a>01932 
<a name="l01933"></a>01933                     <span class="keywordflow">for</span> (i = 0; i &lt; 256; i++) {
<a name="l01934"></a>01934                         b64_xtable[i] = -1;
<a name="l01935"></a>01935                     }
<a name="l01936"></a>01936                     <span class="keywordflow">for</span> (i = 0; i &lt; 64; i++) {
<a name="l01937"></a>01937                         b64_xtable[(<span class="keywordtype">unsigned</span> char)b64_table[i]] = i;
<a name="l01938"></a>01938                     }
<a name="l01939"></a>01939                 }
<a name="l01940"></a>01940                 <span class="keywordflow">if</span> (len == 0) {
<a name="l01941"></a>01941                     <span class="keywordflow">while</span> (s &lt; send) {
<a name="l01942"></a>01942                         a = b = c = d = -1;
<a name="l01943"></a>01943                         a = b64_xtable[(<span class="keywordtype">unsigned</span> char)*s++];
<a name="l01944"></a>01944                         <span class="keywordflow">if</span> (s &gt;= send || a == -1) <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;invalid base64&quot;</span>);
<a name="l01945"></a>01945                         b = b64_xtable[(<span class="keywordtype">unsigned</span> char)*s++];
<a name="l01946"></a>01946                         <span class="keywordflow">if</span> (s &gt;= send || b == -1) <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;invalid base64&quot;</span>);
<a name="l01947"></a>01947                         <span class="keywordflow">if</span> (*s == <span class="charliteral">&apos;=&apos;</span>) {
<a name="l01948"></a>01948                             <span class="keywordflow">if</span> (s + 2 == send &amp;&amp; *(s + 1) == <span class="charliteral">&apos;=&apos;</span>) <span class="keywordflow">break</span>;
<a name="l01949"></a>01949                             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;invalid base64&quot;</span>);
<a name="l01950"></a>01950                         }
<a name="l01951"></a>01951                         c = b64_xtable[(<span class="keywordtype">unsigned</span> char)*s++];
<a name="l01952"></a>01952                         <span class="keywordflow">if</span> (s &gt;= send || c == -1) <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;invalid base64&quot;</span>);
<a name="l01953"></a>01953                         <span class="keywordflow">if</span> (s + 1 == send &amp;&amp; *s == <span class="charliteral">&apos;=&apos;</span>) <span class="keywordflow">break</span>;
<a name="l01954"></a>01954                         d = b64_xtable[(<span class="keywordtype">unsigned</span> char)*s++];
<a name="l01955"></a>01955                         <span class="keywordflow">if</span> (d == -1) <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;invalid base64&quot;</span>);
<a name="l01956"></a>01956                         *ptr++ = a &lt;&lt; 2 | b &gt;&gt; 4;
<a name="l01957"></a>01957                         *ptr++ = b &lt;&lt; 4 | c &gt;&gt; 2;
<a name="l01958"></a>01958                         *ptr++ = c &lt;&lt; 6 | d;
<a name="l01959"></a>01959                     }
<a name="l01960"></a>01960                     <span class="keywordflow">if</span> (c == -1) {
<a name="l01961"></a>01961                         *ptr++ = a &lt;&lt; 2 | b &gt;&gt; 4;
<a name="l01962"></a>01962                         <span class="keywordflow">if</span> (b &amp; 0xf) <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;invalid base64&quot;</span>);
<a name="l01963"></a>01963                     }
<a name="l01964"></a>01964                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (d == -1) {
<a name="l01965"></a>01965                         *ptr++ = a &lt;&lt; 2 | b &gt;&gt; 4;
<a name="l01966"></a>01966                         *ptr++ = b &lt;&lt; 4 | c &gt;&gt; 2;
<a name="l01967"></a>01967                         <span class="keywordflow">if</span> (c &amp; 0x3) <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;invalid base64&quot;</span>);
<a name="l01968"></a>01968                     }
<a name="l01969"></a>01969                 }
<a name="l01970"></a>01970                 <span class="keywordflow">else</span> {
<a name="l01971"></a>01971                     <span class="keywordflow">while</span> (s &lt; send) {
<a name="l01972"></a>01972                         a = b = c = d = -1;
<a name="l01973"></a>01973                         <span class="keywordflow">while</span> ((a = b64_xtable[(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)*s]) == -1 &amp;&amp; s &lt; send) {s++;}
<a name="l01974"></a>01974                         <span class="keywordflow">if</span> (s &gt;= send) <span class="keywordflow">break</span>;
<a name="l01975"></a>01975                         s++;
<a name="l01976"></a>01976                         <span class="keywordflow">while</span> ((b = b64_xtable[(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)*s]) == -1 &amp;&amp; s &lt; send) {s++;}
<a name="l01977"></a>01977                         <span class="keywordflow">if</span> (s &gt;= send) <span class="keywordflow">break</span>;
<a name="l01978"></a>01978                         s++;
<a name="l01979"></a>01979                         <span class="keywordflow">while</span> ((c = b64_xtable[(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)*s]) == -1 &amp;&amp; s &lt; send) {<span class="keywordflow">if</span> (*s == <span class="charliteral">&apos;=&apos;</span>) <span class="keywordflow">break</span>; s++;}
<a name="l01980"></a>01980                         <span class="keywordflow">if</span> (*s == <span class="charliteral">&apos;=&apos;</span> || s &gt;= send) <span class="keywordflow">break</span>;
<a name="l01981"></a>01981                         s++;
<a name="l01982"></a>01982                         <span class="keywordflow">while</span> ((d = b64_xtable[(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)*s]) == -1 &amp;&amp; s &lt; send) {<span class="keywordflow">if</span> (*s == <span class="charliteral">&apos;=&apos;</span>) <span class="keywordflow">break</span>; s++;}
<a name="l01983"></a>01983                         <span class="keywordflow">if</span> (*s == <span class="charliteral">&apos;=&apos;</span> || s &gt;= send) <span class="keywordflow">break</span>;
<a name="l01984"></a>01984                         s++;
<a name="l01985"></a>01985                         *ptr++ = a &lt;&lt; 2 | b &gt;&gt; 4;
<a name="l01986"></a>01986                         *ptr++ = b &lt;&lt; 4 | c &gt;&gt; 2;
<a name="l01987"></a>01987                         *ptr++ = c &lt;&lt; 6 | d;
<a name="l01988"></a>01988                     }
<a name="l01989"></a>01989                     <span class="keywordflow">if</span> (a != -1 &amp;&amp; b != -1) {
<a name="l01990"></a>01990                         <span class="keywordflow">if</span> (c == -1 &amp;&amp; *s == <span class="charliteral">&apos;=&apos;</span>)
<a name="l01991"></a>01991                             *ptr++ = a &lt;&lt; 2 | b &gt;&gt; 4;
<a name="l01992"></a>01992                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c != -1 &amp;&amp; *s == <span class="charliteral">&apos;=&apos;</span>) {
<a name="l01993"></a>01993                             *ptr++ = a &lt;&lt; 2 | b &gt;&gt; 4;
<a name="l01994"></a>01994                             *ptr++ = b &lt;&lt; 4 | c &gt;&gt; 2;
<a name="l01995"></a>01995                         }
<a name="l01996"></a>01996                     }
<a name="l01997"></a>01997                 }
<a name="l01998"></a>01998                 <a class="code" href="../../d8/d81/ruby__missing_8h.html#a89ed8cb86ca6dd49d2db67adae809057">rb_str_set_len</a>(buf, ptr - <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(buf));
<a name="l01999"></a>01999                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(buf);
<a name="l02000"></a>02000             }
<a name="l02001"></a>02001             <span class="keywordflow">break</span>;
<a name="l02002"></a>02002 
<a name="l02003"></a>02003           <span class="keywordflow">case</span> <span class="charliteral">&apos;M&apos;</span>:
<a name="l02004"></a>02004             {
<a name="l02005"></a>02005                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a> = <a class="code" href="../../d1/d7d/pack_8c.html#a86b9f5ea794549bedec734d5694bde44">infected_str_new</a>(0, send - s, str);
<a name="l02006"></a>02006                 <span class="keywordtype">char</span> *ptr = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(buf), *ss = s;
<a name="l02007"></a>02007                 <span class="keywordtype">int</span> c1, c2;
<a name="l02008"></a>02008 
<a name="l02009"></a>02009                 <span class="keywordflow">while</span> (s &lt; send) {
<a name="l02010"></a>02010                     <span class="keywordflow">if</span> (*s == <span class="charliteral">&apos;=&apos;</span>) {
<a name="l02011"></a>02011                         <span class="keywordflow">if</span> (++s == send) <span class="keywordflow">break</span>;
<a name="l02012"></a>02012                        <span class="keywordflow">if</span> (s+1 &lt; send &amp;&amp; *s == <span class="charliteral">&apos;\r&apos;</span> &amp;&amp; *(s+1) == <span class="charliteral">&apos;\n&apos;</span>)
<a name="l02013"></a>02013                          s++;
<a name="l02014"></a>02014                         <span class="keywordflow">if</span> (*s != <span class="charliteral">&apos;\n&apos;</span>) {
<a name="l02015"></a>02015                             <span class="keywordflow">if</span> ((c1 = <a class="code" href="../../d1/d7d/pack_8c.html#a3c9ea8434da148851c9d559b58607698">hex2num</a>(*s)) == -1) <span class="keywordflow">break</span>;
<a name="l02016"></a>02016                             <span class="keywordflow">if</span> (++s == send) <span class="keywordflow">break</span>;
<a name="l02017"></a>02017                             <span class="keywordflow">if</span> ((c2 = <a class="code" href="../../d1/d7d/pack_8c.html#a3c9ea8434da148851c9d559b58607698">hex2num</a>(*s)) == -1) <span class="keywordflow">break</span>;
<a name="l02018"></a>02018                             *ptr++ = c1 &lt;&lt; 4 | c2;
<a name="l02019"></a>02019                         }
<a name="l02020"></a>02020                     }
<a name="l02021"></a>02021                     <span class="keywordflow">else</span> {
<a name="l02022"></a>02022                         *ptr++ = *s;
<a name="l02023"></a>02023                     }
<a name="l02024"></a>02024                     s++;
<a name="l02025"></a>02025                     ss = s;
<a name="l02026"></a>02026                 }
<a name="l02027"></a>02027                 <a class="code" href="../../d8/d81/ruby__missing_8h.html#a89ed8cb86ca6dd49d2db67adae809057">rb_str_set_len</a>(buf, ptr - <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(buf));
<a name="l02028"></a>02028                 <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(buf, ss, send-ss);
<a name="l02029"></a>02029                 <a class="code" href="../../d5/de3/encoding_8h.html#af06e3f35ff3b6d79190eaf397328e7e6">ENCODING_CODERANGE_SET</a>(buf, <a class="code" href="../../d5/db5/encoding_8c.html#a4a5d866d19763996332e622208d71e9f">rb_ascii8bit_encindex</a>(), <a class="code" href="../../d5/de3/encoding_8h.html#a0c81a12daaa1e57009d46b9d906957dc">ENC_CODERANGE_VALID</a>);
<a name="l02030"></a>02030                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(buf);
<a name="l02031"></a>02031             }
<a name="l02032"></a>02032             <span class="keywordflow">break</span>;
<a name="l02033"></a>02033 
<a name="l02034"></a>02034           <span class="keywordflow">case</span> <span class="charliteral">&apos;@&apos;</span>:
<a name="l02035"></a>02035             <span class="keywordflow">if</span> (len &gt; <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str))
<a name="l02036"></a>02036                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;@ outside of string&quot;</span>);
<a name="l02037"></a>02037             s = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str) + len;
<a name="l02038"></a>02038             <span class="keywordflow">break</span>;
<a name="l02039"></a>02039 
<a name="l02040"></a>02040           <span class="keywordflow">case</span> <span class="charliteral">&apos;X&apos;</span>:
<a name="l02041"></a>02041             <span class="keywordflow">if</span> (len &gt; s - <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str))
<a name="l02042"></a>02042                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;X outside of string&quot;</span>);
<a name="l02043"></a>02043             s -= len;
<a name="l02044"></a>02044             <span class="keywordflow">break</span>;
<a name="l02045"></a>02045 
<a name="l02046"></a>02046           <span class="keywordflow">case</span> <span class="charliteral">&apos;x&apos;</span>:
<a name="l02047"></a>02047             <span class="keywordflow">if</span> (len &gt; send - s)
<a name="l02048"></a>02048                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;x outside of string&quot;</span>);
<a name="l02049"></a>02049             s += len;
<a name="l02050"></a>02050             <span class="keywordflow">break</span>;
<a name="l02051"></a>02051 
<a name="l02052"></a>02052           <span class="keywordflow">case</span> <span class="charliteral">&apos;P&apos;</span>:
<a name="l02053"></a>02053             <span class="keywordflow">if</span> (<span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *) &lt;= (<span class="keywordtype">size_t</span>)(send - s)) {
<a name="l02054"></a>02054                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> tmp = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02055"></a>02055                 <span class="keywordtype">char</span> *t;
<a name="l02056"></a>02056 
<a name="l02057"></a>02057                 memcpy(&amp;t, s, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *));
<a name="l02058"></a>02058                 s += <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *);
<a name="l02059"></a>02059 
<a name="l02060"></a>02060                 <span class="keywordflow">if</span> (t) {
<a name="l02061"></a>02061                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> a, *p, *pend;
<a name="l02062"></a>02062 
<a name="l02063"></a>02063                     <span class="keywordflow">if</span> (!(a = <a class="code" href="../../db/d2e/intern_8h.html#a4136c19f4d8e2bfd3b48f35952305277">rb_str_associated</a>(str))) {
<a name="l02064"></a>02064                         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;no associated pointer&quot;</span>);
<a name="l02065"></a>02065                     }
<a name="l02066"></a>02066                     p = <a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(a);
<a name="l02067"></a>02067                     pend = p + <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(a);
<a name="l02068"></a>02068                     <span class="keywordflow">while</span> (p &lt; pend) {
<a name="l02069"></a>02069                         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(*p) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a22a8c2a4bbaae9b68f65c9bb92fd4e39">T_STRING</a> &amp;&amp; <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(*p) == t) {
<a name="l02070"></a>02070                             <span class="keywordflow">if</span> (len &lt; <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(*p)) {
<a name="l02071"></a>02071                                 tmp = <a class="code" href="../../db/d2e/intern_8h.html#a857320dd57dc897c57ee0345f6f04f06">rb_tainted_str_new</a>(t, len);
<a name="l02072"></a>02072                                 <a class="code" href="../../db/d2e/intern_8h.html#a34ee266e7ad7a1fee62f02cb01b0fc56">rb_str_associate</a>(tmp, a);
<a name="l02073"></a>02073                             }
<a name="l02074"></a>02074                             <span class="keywordflow">else</span> {
<a name="l02075"></a>02075                                 tmp = *p;
<a name="l02076"></a>02076                             }
<a name="l02077"></a>02077                             <span class="keywordflow">break</span>;
<a name="l02078"></a>02078                         }
<a name="l02079"></a>02079                         p++;
<a name="l02080"></a>02080                     }
<a name="l02081"></a>02081                     <span class="keywordflow">if</span> (p == pend) {
<a name="l02082"></a>02082                         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;non associated pointer&quot;</span>);
<a name="l02083"></a>02083                     }
<a name="l02084"></a>02084                 }
<a name="l02085"></a>02085                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(tmp);
<a name="l02086"></a>02086             }
<a name="l02087"></a>02087             <span class="keywordflow">break</span>;
<a name="l02088"></a>02088 
<a name="l02089"></a>02089           <span class="keywordflow">case</span> <span class="charliteral">&apos;p&apos;</span>:
<a name="l02090"></a>02090             <span class="keywordflow">if</span> (len &gt; (<span class="keywordtype">long</span>)((send - s) / <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *)))
<a name="l02091"></a>02091                 len = (send - s) / <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *);
<a name="l02092"></a>02092             <span class="keywordflow">while</span> (len-- &gt; 0) {
<a name="l02093"></a>02093                 <span class="keywordflow">if</span> ((<span class="keywordtype">size_t</span>)(send - s) &lt; <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *))
<a name="l02094"></a>02094                     <span class="keywordflow">break</span>;
<a name="l02095"></a>02095                 <span class="keywordflow">else</span> {
<a name="l02096"></a>02096                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> tmp = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02097"></a>02097                     <span class="keywordtype">char</span> *t;
<a name="l02098"></a>02098 
<a name="l02099"></a>02099                     memcpy(&amp;t, s, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *));
<a name="l02100"></a>02100                     s += <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *);
<a name="l02101"></a>02101 
<a name="l02102"></a>02102                     <span class="keywordflow">if</span> (t) {
<a name="l02103"></a>02103                         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> a, *p, *pend;
<a name="l02104"></a>02104 
<a name="l02105"></a>02105                         <span class="keywordflow">if</span> (!(a = <a class="code" href="../../db/d2e/intern_8h.html#a4136c19f4d8e2bfd3b48f35952305277">rb_str_associated</a>(str))) {
<a name="l02106"></a>02106                             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;no associated pointer&quot;</span>);
<a name="l02107"></a>02107                         }
<a name="l02108"></a>02108                         p = <a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(a);
<a name="l02109"></a>02109                         pend = p + <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(a);
<a name="l02110"></a>02110                         <span class="keywordflow">while</span> (p &lt; pend) {
<a name="l02111"></a>02111                             <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(*p) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a22a8c2a4bbaae9b68f65c9bb92fd4e39">T_STRING</a> &amp;&amp; <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(*p) == t) {
<a name="l02112"></a>02112                                 tmp = *p;
<a name="l02113"></a>02113                                 <span class="keywordflow">break</span>;
<a name="l02114"></a>02114                             }
<a name="l02115"></a>02115                             p++;
<a name="l02116"></a>02116                         }
<a name="l02117"></a>02117                         <span class="keywordflow">if</span> (p == pend) {
<a name="l02118"></a>02118                             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;non associated pointer&quot;</span>);
<a name="l02119"></a>02119                         }
<a name="l02120"></a>02120                     }
<a name="l02121"></a>02121                     <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(tmp);
<a name="l02122"></a>02122                 }
<a name="l02123"></a>02123             }
<a name="l02124"></a>02124             <span class="keywordflow">break</span>;
<a name="l02125"></a>02125 
<a name="l02126"></a>02126           <span class="keywordflow">case</span> <span class="charliteral">&apos;w&apos;</span>:
<a name="l02127"></a>02127             {
<a name="l02128"></a>02128                 <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ul = 0;
<a name="l02129"></a>02129                 <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> ulmask = 0xfeUL &lt;&lt; ((<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a>) - 1) * 8);
<a name="l02130"></a>02130 
<a name="l02131"></a>02131                 <span class="keywordflow">while</span> (len &gt; 0 &amp;&amp; s &lt; send) {
<a name="l02132"></a>02132                     ul &lt;&lt;= 7;
<a name="l02133"></a>02133                     ul |= (*s &amp; 0x7f);
<a name="l02134"></a>02134                     <span class="keywordflow">if</span> (!(*s++ &amp; 0x80)) {
<a name="l02135"></a>02135                         <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad9f758738ddf6560da578a4425987892">ULONG2NUM</a>(ul));
<a name="l02136"></a>02136                         len--;
<a name="l02137"></a>02137                         ul = 0;
<a name="l02138"></a>02138                     }
<a name="l02139"></a>02139                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ul &amp; ulmask) {
<a name="l02140"></a>02140                         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> big = <a class="code" href="../../d1/dcc/bignum_8c.html#afbcde0954c4494692919142fe48bf60c">rb_uint2big</a>(ul);
<a name="l02141"></a>02141                         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> big128 = <a class="code" href="../../d1/dcc/bignum_8c.html#afbcde0954c4494692919142fe48bf60c">rb_uint2big</a>(128);
<a name="l02142"></a>02142                         <span class="keywordflow">while</span> (s &lt; send) {
<a name="l02143"></a>02143                             big = <a class="code" href="../../d1/dcc/bignum_8c.html#a838287ae9846a01c6af80502216bd9b8">rb_big_mul</a>(big, big128);
<a name="l02144"></a>02144                             big = <a class="code" href="../../d1/dcc/bignum_8c.html#a3996827354a05ef544beeaa557ce38a3">rb_big_plus</a>(big, <a class="code" href="../../d1/dcc/bignum_8c.html#afbcde0954c4494692919142fe48bf60c">rb_uint2big</a>(*s &amp; 0x7f));
<a name="l02145"></a>02145                             <span class="keywordflow">if</span> (!(*s++ &amp; 0x80)) {
<a name="l02146"></a>02146                                 <a class="code" href="../../d1/d7d/pack_8c.html#a26ccb476a78a97b94710327f95390a27">UNPACK_PUSH</a>(big);
<a name="l02147"></a>02147                                 len--;
<a name="l02148"></a>02148                                 ul = 0;
<a name="l02149"></a>02149                                 <span class="keywordflow">break</span>;
<a name="l02150"></a>02150                             }
<a name="l02151"></a>02151                         }
<a name="l02152"></a>02152                     }
<a name="l02153"></a>02153                 }
<a name="l02154"></a>02154             }
<a name="l02155"></a>02155             <span class="keywordflow">break</span>;
<a name="l02156"></a>02156 
<a name="l02157"></a>02157           <span class="keywordflow">default</span>:
<a name="l02158"></a>02158             <span class="keywordflow">break</span>;
<a name="l02159"></a>02159         }
<a name="l02160"></a>02160     }
<a name="l02161"></a>02161 
<a name="l02162"></a>02162     <span class="keywordflow">return</span> ary;
<a name="l02163"></a>02163 }
<a name="l02164"></a>02164 
<a name="l02165"></a><a class="code" href="../../d1/d7d/pack_8c.html#ad72dc64cd2c9bc3598f792dc518d03b2">02165</a> <span class="preprocessor">#define BYTEWIDTH 8</span>
<a name="l02166"></a>02166 <span class="preprocessor"></span>
<a name="l02167"></a>02167 <span class="keywordtype">int</span>
<a name="l02168"></a><a class="code" href="../../d1/d7d/pack_8c.html#a9f0e2c122a1d57cada6d708da388648a">02168</a> <a class="code" href="../../db/d2e/intern_8h.html#af342a4146307dc4afb19e0b5ad1a3984">rb_uv_to_utf8</a>(<span class="keywordtype">char</span> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>[6], <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> uv)
<a name="l02169"></a>02169 {
<a name="l02170"></a>02170     <span class="keywordflow">if</span> (uv &lt;= 0x7f) {
<a name="l02171"></a>02171         buf[0] = (char)uv;
<a name="l02172"></a>02172         <span class="keywordflow">return</span> 1;
<a name="l02173"></a>02173     }
<a name="l02174"></a>02174     <span class="keywordflow">if</span> (uv &lt;= 0x7ff) {
<a name="l02175"></a>02175         buf[0] = (char)((uv&gt;&gt;6)&amp;0xff)|0xc0;
<a name="l02176"></a>02176         buf[1] = (char)(uv&amp;0x3f)|0x80;
<a name="l02177"></a>02177         <span class="keywordflow">return</span> 2;
<a name="l02178"></a>02178     }
<a name="l02179"></a>02179     <span class="keywordflow">if</span> (uv &lt;= 0xffff) {
<a name="l02180"></a>02180         buf[0] = (char)((uv&gt;&gt;12)&amp;0xff)|0xe0;
<a name="l02181"></a>02181         buf[1] = (char)((uv&gt;&gt;6)&amp;0x3f)|0x80;
<a name="l02182"></a>02182         buf[2] = (char)(uv&amp;0x3f)|0x80;
<a name="l02183"></a>02183         <span class="keywordflow">return</span> 3;
<a name="l02184"></a>02184     }
<a name="l02185"></a>02185     <span class="keywordflow">if</span> (uv &lt;= 0x1fffff) {
<a name="l02186"></a>02186         buf[0] = (char)((uv&gt;&gt;18)&amp;0xff)|0xf0;
<a name="l02187"></a>02187         buf[1] = (char)((uv&gt;&gt;12)&amp;0x3f)|0x80;
<a name="l02188"></a>02188         buf[2] = (char)((uv&gt;&gt;6)&amp;0x3f)|0x80;
<a name="l02189"></a>02189         buf[3] = (char)(uv&amp;0x3f)|0x80;
<a name="l02190"></a>02190         <span class="keywordflow">return</span> 4;
<a name="l02191"></a>02191     }
<a name="l02192"></a>02192     <span class="keywordflow">if</span> (uv &lt;= 0x3ffffff) {
<a name="l02193"></a>02193         buf[0] = (char)((uv&gt;&gt;24)&amp;0xff)|0xf8;
<a name="l02194"></a>02194         buf[1] = (char)((uv&gt;&gt;18)&amp;0x3f)|0x80;
<a name="l02195"></a>02195         buf[2] = (char)((uv&gt;&gt;12)&amp;0x3f)|0x80;
<a name="l02196"></a>02196         buf[3] = (char)((uv&gt;&gt;6)&amp;0x3f)|0x80;
<a name="l02197"></a>02197         buf[4] = (char)(uv&amp;0x3f)|0x80;
<a name="l02198"></a>02198         <span class="keywordflow">return</span> 5;
<a name="l02199"></a>02199     }
<a name="l02200"></a>02200     <span class="keywordflow">if</span> (uv &lt;= 0x7fffffff) {
<a name="l02201"></a>02201         buf[0] = (char)((uv&gt;&gt;30)&amp;0xff)|0xfc;
<a name="l02202"></a>02202         buf[1] = (char)((uv&gt;&gt;24)&amp;0x3f)|0x80;
<a name="l02203"></a>02203         buf[2] = (char)((uv&gt;&gt;18)&amp;0x3f)|0x80;
<a name="l02204"></a>02204         buf[3] = (char)((uv&gt;&gt;12)&amp;0x3f)|0x80;
<a name="l02205"></a>02205         buf[4] = (char)((uv&gt;&gt;6)&amp;0x3f)|0x80;
<a name="l02206"></a>02206         buf[5] = (char)(uv&amp;0x3f)|0x80;
<a name="l02207"></a>02207         <span class="keywordflow">return</span> 6;
<a name="l02208"></a>02208     }
<a name="l02209"></a>02209     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a5211161e80760c30e2e009ae0bee7be8">rb_eRangeError</a>, <span class="stringliteral">&quot;pack(U): value out of range&quot;</span>);
<a name="l02210"></a>02210 }
<a name="l02211"></a>02211 
<a name="l02212"></a><a class="code" href="../../d1/d7d/pack_8c.html#a2627791470f56f45a091b88bdc65b358">02212</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="../../d1/d7d/pack_8c.html#a2627791470f56f45a091b88bdc65b358">utf8_limits</a>[] = {
<a name="l02213"></a>02213     0x0,                        <span class="comment">/* 1 */</span>
<a name="l02214"></a>02214     0x80,                       <span class="comment">/* 2 */</span>
<a name="l02215"></a>02215     0x800,                      <span class="comment">/* 3 */</span>
<a name="l02216"></a>02216     0x10000,                    <span class="comment">/* 4 */</span>
<a name="l02217"></a>02217     0x200000,                   <span class="comment">/* 5 */</span>
<a name="l02218"></a>02218     0x4000000,                  <span class="comment">/* 6 */</span>
<a name="l02219"></a>02219     0x80000000,                 <span class="comment">/* 7 */</span>
<a name="l02220"></a>02220 };
<a name="l02221"></a>02221 
<a name="l02222"></a>02222 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>
<a name="l02223"></a><a class="code" href="../../d1/d7d/pack_8c.html#af5486696d49eda881dc03ff113431bc5">02223</a> <a class="code" href="../../d1/d7d/pack_8c.html#af5486696d49eda881dc03ff113431bc5">utf8_to_uv</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *p, <span class="keywordtype">long</span> *lenp)
<a name="l02224"></a>02224 {
<a name="l02225"></a>02225     <span class="keywordtype">int</span> c = *p++ &amp; 0xff;
<a name="l02226"></a>02226     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> uv = c;
<a name="l02227"></a>02227     <span class="keywordtype">long</span> n;
<a name="l02228"></a>02228 
<a name="l02229"></a>02229     <span class="keywordflow">if</span> (!(uv &amp; 0x80)) {
<a name="l02230"></a>02230         *lenp = 1;
<a name="l02231"></a>02231         <span class="keywordflow">return</span> uv;
<a name="l02232"></a>02232     }
<a name="l02233"></a>02233     <span class="keywordflow">if</span> (!(uv &amp; 0x40)) {
<a name="l02234"></a>02234         *lenp = 1;
<a name="l02235"></a>02235         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;malformed UTF-8 character&quot;</span>);
<a name="l02236"></a>02236     }
<a name="l02237"></a>02237 
<a name="l02238"></a>02238     <span class="keywordflow">if</span>      (!(uv &amp; 0x20)) { n = 2; uv &amp;= 0x1f; }
<a name="l02239"></a>02239     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(uv &amp; 0x10)) { n = 3; uv &amp;= 0x0f; }
<a name="l02240"></a>02240     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(uv &amp; 0x08)) { n = 4; uv &amp;= 0x07; }
<a name="l02241"></a>02241     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(uv &amp; 0x04)) { n = 5; uv &amp;= 0x03; }
<a name="l02242"></a>02242     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(uv &amp; 0x02)) { n = 6; uv &amp;= 0x01; }
<a name="l02243"></a>02243     <span class="keywordflow">else</span> {
<a name="l02244"></a>02244         *lenp = 1;
<a name="l02245"></a>02245         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;malformed UTF-8 character&quot;</span>);
<a name="l02246"></a>02246     }
<a name="l02247"></a>02247     <span class="keywordflow">if</span> (n &gt; *lenp) {
<a name="l02248"></a>02248         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;malformed UTF-8 character (expected %ld bytes, given %ld bytes)&quot;</span>,
<a name="l02249"></a>02249                  n, *lenp);
<a name="l02250"></a>02250     }
<a name="l02251"></a>02251     *lenp = n--;
<a name="l02252"></a>02252     <span class="keywordflow">if</span> (n != 0) {
<a name="l02253"></a>02253         <span class="keywordflow">while</span> (n--) {
<a name="l02254"></a>02254             c = *p++ &amp; 0xff;
<a name="l02255"></a>02255             <span class="keywordflow">if</span> ((c &amp; 0xc0) != 0x80) {
<a name="l02256"></a>02256                 *lenp -= n + 1;
<a name="l02257"></a>02257                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;malformed UTF-8 character&quot;</span>);
<a name="l02258"></a>02258             }
<a name="l02259"></a>02259             <span class="keywordflow">else</span> {
<a name="l02260"></a>02260                 c &amp;= 0x3f;
<a name="l02261"></a>02261                 uv = uv &lt;&lt; 6 | c;
<a name="l02262"></a>02262             }
<a name="l02263"></a>02263         }
<a name="l02264"></a>02264     }
<a name="l02265"></a>02265     n = *lenp - 1;
<a name="l02266"></a>02266     <span class="keywordflow">if</span> (uv &lt; utf8_limits[n]) {
<a name="l02267"></a>02267         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;redundant UTF-8 sequence&quot;</span>);
<a name="l02268"></a>02268     }
<a name="l02269"></a>02269     <span class="keywordflow">return</span> uv;
<a name="l02270"></a>02270 }
<a name="l02271"></a>02271 
<a name="l02272"></a>02272 <span class="keywordtype">void</span>
<a name="l02273"></a><a class="code" href="../../d1/d7d/pack_8c.html#a2fe54bebfc30f3ccc1098ee8c2ec6891">02273</a> <a class="code" href="../../d1/d7d/pack_8c.html#a2fe54bebfc30f3ccc1098ee8c2ec6891">Init_pack</a>(<span class="keywordtype">void</span>)
<a name="l02274"></a>02274 {
<a name="l02275"></a>02275     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dcc/array_8c.html#a2ae422f2c99d019bdfe5b12008c82b90">rb_cArray</a>, <span class="stringliteral">&quot;pack&quot;</span>, <a class="code" href="../../d1/d7d/pack_8c.html#af2d08e4a0e0ad79772645375d4db9e78">pack_pack</a>, 1);
<a name="l02276"></a>02276     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7d36c9c3e9faa34c27eb7f2eb9c874a8">rb_cString</a>, <span class="stringliteral">&quot;unpack&quot;</span>, <a class="code" href="../../d1/d7d/pack_8c.html#a2fac891305016ef32d610eb5fad08389">pack_unpack</a>, 1);
<a name="l02277"></a>02277 }
<a name="l02278"></a>02278 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Mar 2013 for Ruby by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
