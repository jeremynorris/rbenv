<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Ruby: st.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>st.c</h1><a href="../../d4/d71/st_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* This is a public domain general purpose hash table package written by Peter Moore @ UCB. */</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="comment">/* static       char    sccsid[] = &quot;@(#) st.c 5.1 89/12/14 Crucible&quot;; */</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="preprocessor">#ifdef NOT_RUBY</span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="../../d6/d87/regint_8h.html">regint.h</a>&quot;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &quot;st.h&quot;</span>
<a name="l00008"></a>00008 <span class="preprocessor">#else</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="../../de/de6/ruby_2ruby_8h.html">ruby/ruby.h</a>&quot;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#endif</span>
<a name="l00011"></a>00011 <span class="preprocessor"></span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#ifdef HAVE_STDLIB_H</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#endif</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span><span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00017"></a>00017 
<a name="l00018"></a><a class="code" href="../../d4/d71/st_8c.html#a4bafc81982b39c3f3fa20e5f7b3dbbf5">00018</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>;
<a name="l00019"></a>00019 
<a name="l00020"></a><a class="code" href="../../df/dfb/structst__table__entry.html">00020</a> <span class="keyword">struct </span><a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> {
<a name="l00021"></a><a class="code" href="../../df/dfb/structst__table__entry.html#a4054ac2ac0f2065f541246bd665c6c7d">00021</a>     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> <a class="code" href="../../df/dfb/structst__table__entry.html#a4054ac2ac0f2065f541246bd665c6c7d">hash</a>;
<a name="l00022"></a><a class="code" href="../../df/dfb/structst__table__entry.html#a7c3f404248d6b3ed3235c49425c2b899">00022</a>     <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> <a class="code" href="../../df/dfb/structst__table__entry.html#a7c3f404248d6b3ed3235c49425c2b899">key</a>;
<a name="l00023"></a><a class="code" href="../../df/dfb/structst__table__entry.html#a78379c2ee6cf57370697a50ff7971b17">00023</a>     <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> <a class="code" href="../../df/dfb/structst__table__entry.html#a78379c2ee6cf57370697a50ff7971b17">record</a>;
<a name="l00024"></a><a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">00024</a>     <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *<a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">next</a>;
<a name="l00025"></a><a class="code" href="../../df/dfb/structst__table__entry.html#a4f0048fd99145b5a1558da33c145ead3">00025</a>     <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *<a class="code" href="../../df/dfb/structst__table__entry.html#a4f0048fd99145b5a1558da33c145ead3">fore</a>, *<a class="code" href="../../df/dfb/structst__table__entry.html#a2cd684cc9d44752fa7de8946e10e0c13">back</a>;
<a name="l00026"></a>00026 };
<a name="l00027"></a>00027 
<a name="l00028"></a><a class="code" href="../../d4/d71/st_8c.html#a4f884be75490db2c92e409a0209fdbcb">00028</a> <span class="preprocessor">#define ST_DEFAULT_MAX_DENSITY 5</span>
<a name="l00029"></a><a class="code" href="../../d4/d71/st_8c.html#a311df13f4d458054df7d87ca22782ab2">00029</a> <span class="preprocessor"></span><span class="preprocessor">#define ST_DEFAULT_INIT_TABLE_SIZE 11</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span>
<a name="l00031"></a>00031     <span class="comment">/*</span>
<a name="l00032"></a>00032 <span class="comment">     * DEFAULT_MAX_DENSITY is the default for the largest we allow the</span>
<a name="l00033"></a>00033 <span class="comment">     * average number of items per bin before increasing the number of</span>
<a name="l00034"></a>00034 <span class="comment">     * bins</span>
<a name="l00035"></a>00035 <span class="comment">     *</span>
<a name="l00036"></a>00036 <span class="comment">     * DEFAULT_INIT_TABLE_SIZE is the default for the number of bins</span>
<a name="l00037"></a>00037 <span class="comment">     * allocated initially</span>
<a name="l00038"></a>00038 <span class="comment">     *</span>
<a name="l00039"></a>00039 <span class="comment">     */</span>
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="../../d4/d71/st_8c.html#ab3e563ba13f240493c3b964db47c91d9">00041</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="../../d6/d34/structst__hash__type.html">st_hash_type</a> <a class="code" href="../../d4/d71/st_8c.html#ab3e563ba13f240493c3b964db47c91d9">type_numhash</a> = {
<a name="l00042"></a>00042     <a class="code" href="../../dd/d24/st_8h.html#a2839ae91d54936af83392d0df9f97488">st_numcmp</a>,
<a name="l00043"></a>00043     <a class="code" href="../../dd/d24/st_8h.html#a50249b52a70e7a4aa8ca8582c380cd26">st_numhash</a>,
<a name="l00044"></a>00044 };
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 <span class="comment">/* extern int strcmp(const char *, const char *); */</span>
<a name="l00047"></a>00047 <span class="keyword">static</span> <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> <a class="code" href="../../d4/d71/st_8c.html#a167297ecc6a15b3e40576309d41e68d7">strhash</a>(<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>);
<a name="l00048"></a><a class="code" href="../../d4/d71/st_8c.html#acfaf774315212a7f26b139e77e62f75d">00048</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="../../d6/d34/structst__hash__type.html">st_hash_type</a> <a class="code" href="../../d4/d71/st_8c.html#acfaf774315212a7f26b139e77e62f75d">type_strhash</a> = {
<a name="l00049"></a>00049     strcmp,
<a name="l00050"></a>00050     <a class="code" href="../../d4/d71/st_8c.html#a167297ecc6a15b3e40576309d41e68d7">strhash</a>,
<a name="l00051"></a>00051 };
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="keyword">static</span> <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> <a class="code" href="../../d4/d71/st_8c.html#a1a0a643d881cfc8e9def03ff92d49b48">strcasehash</a>(<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>);
<a name="l00054"></a><a class="code" href="../../d4/d71/st_8c.html#a91069e070d6e0fbc1ff1145127c29742">00054</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="../../d6/d34/structst__hash__type.html">st_hash_type</a> <a class="code" href="../../d4/d71/st_8c.html#a91069e070d6e0fbc1ff1145127c29742">type_strcasehash</a> = {
<a name="l00055"></a>00055     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa34004564b66661c5c2f6d396e567e93">st_strcasecmp</a>,
<a name="l00056"></a>00056     <a class="code" href="../../d4/d71/st_8c.html#a1a0a643d881cfc8e9def03ff92d49b48">strcasehash</a>,
<a name="l00057"></a>00057 };
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d4/d71/st_8c.html#ae79a2e19d2287b6ac8d9a82f5c423a1c">rehash</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *);
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="preprocessor">#ifdef RUBY</span>
<a name="l00062"></a><a class="code" href="../../d4/d71/st_8c.html#acf143577800376dd931c059ecc61ba06">00062</a> <span class="preprocessor"></span><span class="preprocessor">#define malloc xmalloc</span>
<a name="l00063"></a><a class="code" href="../../d4/d71/st_8c.html#a84beef8cc122add35118ec7cd35286c4">00063</a> <span class="preprocessor"></span><span class="preprocessor">#define calloc xcalloc</span>
<a name="l00064"></a><a class="code" href="../../d4/d71/st_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define free(x) xfree(x)</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>
<a name="l00067"></a><a class="code" href="../../d4/d71/st_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">00067</a> <span class="preprocessor">#define numberof(array) (int)(sizeof(array) / sizeof((array)[0]))</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span>
<a name="l00069"></a><a class="code" href="../../d4/d71/st_8c.html#a385b96996caa48e6349681cf8036322f">00069</a> <span class="preprocessor">#define alloc(type) (type*)malloc((size_t)sizeof(type))</span>
<a name="l00070"></a><a class="code" href="../../d4/d71/st_8c.html#a94c395161bf80ffa3b1d224ad3542f11">00070</a> <span class="preprocessor"></span><span class="preprocessor">#define Calloc(n,s) (char*)calloc((n),(s))</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>
<a name="l00072"></a><a class="code" href="../../d4/d71/st_8c.html#ab5676cd1fb91981de326030c5b15c867">00072</a> <span class="preprocessor">#define EQUAL(table,x,y) ((x)==(y) || (*(table)-&gt;type-&gt;compare)((x),(y)) == 0)</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>
<a name="l00074"></a>00074 <span class="comment">/* remove cast to unsigned int in the future */</span>
<a name="l00075"></a><a class="code" href="../../d4/d71/st_8c.html#a8719b25fa2e849ad268f0bb382bae21c">00075</a> <span class="preprocessor">#define do_hash(key,table) (unsigned int)(st_index_t)(*(table)-&gt;type-&gt;hash)((key))</span>
<a name="l00076"></a><a class="code" href="../../d4/d71/st_8c.html#a2e66e2285d7393eca0aea2eac98b8ded">00076</a> <span class="preprocessor"></span><span class="preprocessor">#define do_hash_bin(key,table) (do_hash((key), (table))%(table)-&gt;num_bins)</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span>
<a name="l00078"></a>00078 <span class="comment">/*</span>
<a name="l00079"></a>00079 <span class="comment"> * MINSIZE is the minimum size of a dictionary.</span>
<a name="l00080"></a>00080 <span class="comment"> */</span>
<a name="l00081"></a>00081 
<a name="l00082"></a><a class="code" href="../../d4/d71/st_8c.html#a76ace81cc961cbcdba26190bcd706326">00082</a> <span class="preprocessor">#define MINSIZE 8</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span>
<a name="l00084"></a>00084 <span class="comment">/*</span>
<a name="l00085"></a>00085 <span class="comment">Table of prime numbers 2^n+a, 2&lt;=n&lt;=30.</span>
<a name="l00086"></a>00086 <span class="comment">*/</span>
<a name="l00087"></a><a class="code" href="../../d4/d71/st_8c.html#afa0b3f5a7c236c57525153e59dd3c608">00087</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d4/d71/st_8c.html#afa0b3f5a7c236c57525153e59dd3c608">primes</a>[] = {
<a name="l00088"></a>00088         8 + 3,
<a name="l00089"></a>00089         16 + 3,
<a name="l00090"></a>00090         32 + 5,
<a name="l00091"></a>00091         64 + 3,
<a name="l00092"></a>00092         128 + 3,
<a name="l00093"></a>00093         256 + 27,
<a name="l00094"></a>00094         512 + 9,
<a name="l00095"></a>00095         1024 + 9,
<a name="l00096"></a>00096         2048 + 5,
<a name="l00097"></a>00097         4096 + 3,
<a name="l00098"></a>00098         8192 + 27,
<a name="l00099"></a>00099         16384 + 43,
<a name="l00100"></a>00100         32768 + 3,
<a name="l00101"></a>00101         65536 + 45,
<a name="l00102"></a>00102         131072 + 29,
<a name="l00103"></a>00103         262144 + 3,
<a name="l00104"></a>00104         524288 + 21,
<a name="l00105"></a>00105         1048576 + 7,
<a name="l00106"></a>00106         2097152 + 17,
<a name="l00107"></a>00107         4194304 + 15,
<a name="l00108"></a>00108         8388608 + 9,
<a name="l00109"></a>00109         16777216 + 43,
<a name="l00110"></a>00110         33554432 + 35,
<a name="l00111"></a>00111         67108864 + 15,
<a name="l00112"></a>00112         134217728 + 29,
<a name="l00113"></a>00113         268435456 + 3,
<a name="l00114"></a>00114         536870912 + 11,
<a name="l00115"></a>00115         1073741824 + 85,
<a name="l00116"></a>00116         0
<a name="l00117"></a>00117 };
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 <span class="keyword">static</span> <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>
<a name="l00120"></a><a class="code" href="../../d4/d71/st_8c.html#a24df014296a421392679e4dd79101e7a">00120</a> <a class="code" href="../../d4/d71/st_8c.html#a24df014296a421392679e4dd79101e7a">new_size</a>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00121"></a>00121 {
<a name="l00122"></a>00122     <span class="keywordtype">int</span> i;
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 <span class="preprocessor">#if 0</span>
<a name="l00125"></a>00125 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (i=3; i&lt;31; i++) {
<a name="l00126"></a>00126         <span class="keywordflow">if</span> ((1&lt;&lt;i) &gt; size) <span class="keywordflow">return</span> 1&lt;&lt;i;
<a name="l00127"></a>00127     }
<a name="l00128"></a>00128     <span class="keywordflow">return</span> -1;
<a name="l00129"></a>00129 <span class="preprocessor">#else</span>
<a name="l00130"></a>00130 <span class="preprocessor"></span>    <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> newsize;
<a name="l00131"></a>00131 
<a name="l00132"></a>00132     <span class="keywordflow">for</span> (i = 0, newsize = <a class="code" href="../../d4/d71/st_8c.html#a76ace81cc961cbcdba26190bcd706326">MINSIZE</a>; i &lt; <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../d4/d71/st_8c.html#afa0b3f5a7c236c57525153e59dd3c608">primes</a>); i++, newsize &lt;&lt;= 1) {
<a name="l00133"></a>00133         <span class="keywordflow">if</span> (newsize &gt; size) <span class="keywordflow">return</span> <a class="code" href="../../d4/d71/st_8c.html#afa0b3f5a7c236c57525153e59dd3c608">primes</a>[i];
<a name="l00134"></a>00134     }
<a name="l00135"></a>00135     <span class="comment">/* Ran out of polynomials */</span>
<a name="l00136"></a>00136 <span class="preprocessor">#ifndef NOT_RUBY</span>
<a name="l00137"></a>00137 <span class="preprocessor"></span>    <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a95ad3953d535707e2cf2b1d837f5e253">rb_eRuntimeError</a>, <span class="stringliteral">&quot;st_table too big&quot;</span>);
<a name="l00138"></a>00138 <span class="preprocessor">#endif</span>
<a name="l00139"></a>00139 <span class="preprocessor"></span>    <span class="keywordflow">return</span> -1;                  <span class="comment">/* should raise exception */</span>
<a name="l00140"></a>00140 <span class="preprocessor">#endif</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>}
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 <span class="preprocessor">#ifdef HASH_LOG</span>
<a name="l00144"></a>00144 <span class="preprocessor"></span><span class="preprocessor">#ifdef HAVE_UNISTD_H</span>
<a name="l00145"></a>00145 <span class="preprocessor"></span><span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00146"></a>00146 <span class="preprocessor">#endif</span>
<a name="l00147"></a>00147 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span>{
<a name="l00148"></a>00148     <span class="keywordtype">int</span> all, total, num, str, strcase;
<a name="l00149"></a>00149 }  collision;
<a name="l00150"></a>00150 <span class="keyword">static</span> <span class="keywordtype">int</span> init_st = 0;
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00153"></a>00153 stat_col(<span class="keywordtype">void</span>)
<a name="l00154"></a>00154 {
<a name="l00155"></a>00155     <span class="keywordtype">char</span> fname[10+<span class="keyword">sizeof</span>(<a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a>)*3];
<a name="l00156"></a>00156     <a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *f = fopen((<a class="code" href="../../d7/d72/subst_8h.html#aa367b75c5aed883fef5befbdf04835a4">snprintf</a>(fname, <span class="keyword">sizeof</span>(fname), <span class="stringliteral">&quot;/tmp/col%ld&quot;</span>, (<span class="keywordtype">long</span>)getpid()), fname), <span class="stringliteral">&quot;w&quot;</span>);
<a name="l00157"></a>00157     fprintf(f, <span class="stringliteral">&quot;collision: %d / %d (%6.2f)\n&quot;</span>, collision.all, collision.total,
<a name="l00158"></a>00158             ((<span class="keywordtype">double</span>)collision.all / (collision.total)) * 100);
<a name="l00159"></a>00159     fprintf(f, <span class="stringliteral">&quot;num: %d, str: %d, strcase: %d\n&quot;</span>, collision.num, collision.str, collision.strcase);
<a name="l00160"></a>00160     fclose(f);
<a name="l00161"></a>00161 }
<a name="l00162"></a>00162 <span class="preprocessor">#endif</span>
<a name="l00163"></a>00163 <span class="preprocessor"></span>
<a name="l00164"></a><a class="code" href="../../d4/d71/st_8c.html#a5425f87cd69b75aba5ccbbb1c9a0a36a">00164</a> <span class="preprocessor">#define MAX_PACKED_NUMHASH (ST_DEFAULT_INIT_TABLE_SIZE/2)</span>
<a name="l00165"></a>00165 <span class="preprocessor"></span>
<a name="l00166"></a>00166 <a class="code" href="../../d0/ddd/structst__table.html">st_table</a>*
<a name="l00167"></a><a class="code" href="../../d4/d71/st_8c.html#aa5f47e0af563e177e8b559073f454625">00167</a> <a class="code" href="../../dd/d24/st_8h.html#a760f41c431b8dfcac5999005e2b07ead">st_init_table_with_size</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d6/d34/structst__hash__type.html">st_hash_type</a> *<a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>, <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00168"></a>00168 {
<a name="l00169"></a>00169     <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *tbl;
<a name="l00170"></a>00170 
<a name="l00171"></a>00171 <span class="preprocessor">#ifdef HASH_LOG</span>
<a name="l00172"></a>00172 <span class="preprocessor"></span><span class="preprocessor"># if HASH_LOG+0 &lt; 0</span>
<a name="l00173"></a>00173 <span class="preprocessor"></span>    {
<a name="l00174"></a>00174         <span class="keyword">const</span> <span class="keywordtype">char</span> *e = <a class="code" href="../../de/d32/dir_8c.html#aee28fd8a0e40b6d958f7d20348e45368">getenv</a>(<span class="stringliteral">&quot;ST_HASH_LOG&quot;</span>);
<a name="l00175"></a>00175         <span class="keywordflow">if</span> (!e || !*e) init_st = 1;
<a name="l00176"></a>00176     }
<a name="l00177"></a>00177 <span class="preprocessor"># endif</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (init_st == 0) {
<a name="l00179"></a>00179         init_st = 1;
<a name="l00180"></a>00180         atexit(stat_col);
<a name="l00181"></a>00181     }
<a name="l00182"></a>00182 <span class="preprocessor">#endif</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span>
<a name="l00184"></a>00184     size = <a class="code" href="../../d4/d71/st_8c.html#a24df014296a421392679e4dd79101e7a">new_size</a>(size);      <span class="comment">/* round up to prime number */</span>
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     tbl = <a class="code" href="../../d4/d71/st_8c.html#a385b96996caa48e6349681cf8036322f">alloc</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a>);
<a name="l00187"></a>00187     tbl-&gt;<a class="code" href="../../d0/ddd/structst__table.html#af56241399d8c6ebedbea58467e9efa61">type</a> = type;
<a name="l00188"></a>00188     tbl-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a> = 0;
<a name="l00189"></a>00189     tbl-&gt;<a class="code" href="../../d0/ddd/structst__table.html#af86c7c8652d8c86d356b6dc620a56efb">entries_packed</a> = type == &amp;type_numhash &amp;&amp; size/2 &lt;= <a class="code" href="../../d4/d71/st_8c.html#a5425f87cd69b75aba5ccbbb1c9a0a36a">MAX_PACKED_NUMHASH</a>;
<a name="l00190"></a>00190     tbl-&gt;<a class="code" href="../../d0/ddd/structst__table.html#a03f11a1fe0b82094d6acb038fa8118c3">num_bins</a> = size;
<a name="l00191"></a>00191     tbl-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a> = (<a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> **)<a class="code" href="../../d4/d71/st_8c.html#a94c395161bf80ffa3b1d224ad3542f11">Calloc</a>(size, <span class="keyword">sizeof</span>(<a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>*));
<a name="l00192"></a>00192     tbl-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aedc787fe0df08aff2d4079255a246878">head</a> = 0;
<a name="l00193"></a>00193     tbl-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aee1c61d83bbbf2f176255a8a903a92ed">tail</a> = 0;
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     <span class="keywordflow">return</span> tbl;
<a name="l00196"></a>00196 }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 <a class="code" href="../../d0/ddd/structst__table.html">st_table</a>*
<a name="l00199"></a><a class="code" href="../../d4/d71/st_8c.html#a9b0fdfc1b68819f2d666f74187f90b4a">00199</a> <a class="code" href="../../dd/d24/st_8h.html#ae30b3dcdde015a6957198cbeb9408db8">st_init_table</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d6/d34/structst__hash__type.html">st_hash_type</a> *<a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>)
<a name="l00200"></a>00200 {
<a name="l00201"></a>00201     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a760f41c431b8dfcac5999005e2b07ead">st_init_table_with_size</a>(type, 0);
<a name="l00202"></a>00202 }
<a name="l00203"></a>00203 
<a name="l00204"></a>00204 <a class="code" href="../../d0/ddd/structst__table.html">st_table</a>*
<a name="l00205"></a><a class="code" href="../../d4/d71/st_8c.html#a955c6e936b9681649ab9ffa4aa741949">00205</a> <a class="code" href="../../dd/d24/st_8h.html#a955c6e936b9681649ab9ffa4aa741949">st_init_numtable</a>(<span class="keywordtype">void</span>)
<a name="l00206"></a>00206 {
<a name="l00207"></a>00207     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#ae30b3dcdde015a6957198cbeb9408db8">st_init_table</a>(&amp;type_numhash);
<a name="l00208"></a>00208 }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 <a class="code" href="../../d0/ddd/structst__table.html">st_table</a>*
<a name="l00211"></a><a class="code" href="../../d4/d71/st_8c.html#a8a0fa825221e5025911fd93c6c30f3dd">00211</a> <a class="code" href="../../dd/d24/st_8h.html#aa1e7ba5d3e3a2e49801c2591a5b0601d">st_init_numtable_with_size</a>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00212"></a>00212 {
<a name="l00213"></a>00213     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a760f41c431b8dfcac5999005e2b07ead">st_init_table_with_size</a>(&amp;type_numhash, size);
<a name="l00214"></a>00214 }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 <a class="code" href="../../d0/ddd/structst__table.html">st_table</a>*
<a name="l00217"></a><a class="code" href="../../d4/d71/st_8c.html#aaca0d6a6f8e07dd6ad3265872d7b1f81">00217</a> <a class="code" href="../../dd/d24/st_8h.html#aaca0d6a6f8e07dd6ad3265872d7b1f81">st_init_strtable</a>(<span class="keywordtype">void</span>)
<a name="l00218"></a>00218 {
<a name="l00219"></a>00219     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#ae30b3dcdde015a6957198cbeb9408db8">st_init_table</a>(&amp;type_strhash);
<a name="l00220"></a>00220 }
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 <a class="code" href="../../d0/ddd/structst__table.html">st_table</a>*
<a name="l00223"></a><a class="code" href="../../d4/d71/st_8c.html#a92f0cb21ae7d4d53e0f57efcd158d80f">00223</a> <a class="code" href="../../dd/d24/st_8h.html#a0cf5937dc3b1f4d88ad16f83b94a5444">st_init_strtable_with_size</a>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00224"></a>00224 {
<a name="l00225"></a>00225     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a760f41c431b8dfcac5999005e2b07ead">st_init_table_with_size</a>(&amp;type_strhash, size);
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 <a class="code" href="../../d0/ddd/structst__table.html">st_table</a>*
<a name="l00229"></a><a class="code" href="../../d4/d71/st_8c.html#a60f14cceadd837db51e110881258944a">00229</a> <a class="code" href="../../dd/d24/st_8h.html#a60f14cceadd837db51e110881258944a">st_init_strcasetable</a>(<span class="keywordtype">void</span>)
<a name="l00230"></a>00230 {
<a name="l00231"></a>00231     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#ae30b3dcdde015a6957198cbeb9408db8">st_init_table</a>(&amp;type_strcasehash);
<a name="l00232"></a>00232 }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234 <a class="code" href="../../d0/ddd/structst__table.html">st_table</a>*
<a name="l00235"></a><a class="code" href="../../d4/d71/st_8c.html#a4c12b0bc4cb64bc0ebc40a3536e0198a">00235</a> <a class="code" href="../../dd/d24/st_8h.html#a8650831f7c601411625cb369422ee6d4">st_init_strcasetable_with_size</a>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00236"></a>00236 {
<a name="l00237"></a>00237     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a760f41c431b8dfcac5999005e2b07ead">st_init_table_with_size</a>(&amp;type_strcasehash, size);
<a name="l00238"></a>00238 }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 <span class="keywordtype">void</span>
<a name="l00241"></a><a class="code" href="../../d4/d71/st_8c.html#a9b0256b6986265c09661636af78fcb74">00241</a> <a class="code" href="../../dd/d24/st_8h.html#ad6324e2f86dbf2243270fd24aac5367f">st_clear</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table)
<a name="l00242"></a>00242 {
<a name="l00243"></a>00243     <span class="keyword">register</span> <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *ptr, *next;
<a name="l00244"></a>00244     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> i;
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     <span class="keywordflow">if</span> (table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#af86c7c8652d8c86d356b6dc620a56efb">entries_packed</a>) {
<a name="l00247"></a>00247         table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a> = 0;
<a name="l00248"></a>00248         <span class="keywordflow">return</span>;
<a name="l00249"></a>00249     }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     <span class="keywordflow">for</span>(i = 0; i &lt; table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#a03f11a1fe0b82094d6acb038fa8118c3">num_bins</a>; i++) {
<a name="l00252"></a>00252         ptr = table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i];
<a name="l00253"></a>00253         table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i] = 0;
<a name="l00254"></a>00254         <span class="keywordflow">while</span> (ptr != 0) {
<a name="l00255"></a>00255             next = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">next</a>;
<a name="l00256"></a>00256             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(ptr);
<a name="l00257"></a>00257             ptr = next;
<a name="l00258"></a>00258         }
<a name="l00259"></a>00259     }
<a name="l00260"></a>00260     table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a> = 0;
<a name="l00261"></a>00261     table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aedc787fe0df08aff2d4079255a246878">head</a> = 0;
<a name="l00262"></a>00262     table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aee1c61d83bbbf2f176255a8a903a92ed">tail</a> = 0;
<a name="l00263"></a>00263 }
<a name="l00264"></a>00264 
<a name="l00265"></a>00265 <span class="keywordtype">void</span>
<a name="l00266"></a><a class="code" href="../../d4/d71/st_8c.html#a93394fd99c5fa4fbcce2be9717abee45">00266</a> <a class="code" href="../../dd/d24/st_8h.html#acb004847ef312373d65bfb0d1a21c5b3">st_free_table</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table)
<a name="l00267"></a>00267 {
<a name="l00268"></a>00268     <a class="code" href="../../dd/d24/st_8h.html#ad6324e2f86dbf2243270fd24aac5367f">st_clear</a>(table);
<a name="l00269"></a>00269     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>);
<a name="l00270"></a>00270     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(table);
<a name="l00271"></a>00271 }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 <span class="keywordtype">size_t</span>
<a name="l00274"></a><a class="code" href="../../d4/d71/st_8c.html#a9c7d882a34165813cbf64b5fd68b8570">00274</a> <a class="code" href="../../dd/d24/st_8h.html#a1d0d955fb1f39486c18162f222deb82b">st_memsize</a>(<span class="keyword">const</span> <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table)
<a name="l00275"></a>00275 {
<a name="l00276"></a>00276     <span class="keywordflow">if</span> (table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#af86c7c8652d8c86d356b6dc620a56efb">entries_packed</a>) {
<a name="l00277"></a>00277         <span class="keywordflow">return</span> table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#a03f11a1fe0b82094d6acb038fa8118c3">num_bins</a> * <span class="keyword">sizeof</span> (<span class="keywordtype">void</span> *) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a>);
<a name="l00278"></a>00278     }
<a name="l00279"></a>00279     <span class="keywordflow">else</span> {
<a name="l00280"></a>00280         <span class="keywordflow">return</span> table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a> * <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>) + table-&gt;num_bins * <span class="keyword">sizeof</span> (<span class="keywordtype">void</span> *) + <span class="keyword">sizeof</span>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a>);
<a name="l00281"></a>00281     }
<a name="l00282"></a>00282 }
<a name="l00283"></a>00283 
<a name="l00284"></a><a class="code" href="../../d4/d71/st_8c.html#a349734f8cc08a7685ec22c76d31d0d87">00284</a> <span class="preprocessor">#define PTR_NOT_EQUAL(table, ptr, hash_val, key) \</span>
<a name="l00285"></a>00285 <span class="preprocessor">((ptr) != 0 &amp;&amp; ((ptr)-&gt;hash != (hash_val) || !EQUAL((table), (key), (ptr)-&gt;key)))</span>
<a name="l00286"></a>00286 <span class="preprocessor"></span>
<a name="l00287"></a>00287 <span class="preprocessor">#ifdef HASH_LOG</span>
<a name="l00288"></a>00288 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00289"></a>00289 count_collision(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d6/d34/structst__hash__type.html">st_hash_type</a> *<a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>)
<a name="l00290"></a>00290 {
<a name="l00291"></a>00291     collision.all++;
<a name="l00292"></a>00292     <span class="keywordflow">if</span> (type == &amp;type_numhash) {
<a name="l00293"></a>00293         collision.num++;
<a name="l00294"></a>00294     }
<a name="l00295"></a>00295     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == &amp;type_strhash) {
<a name="l00296"></a>00296         collision.strcase++;
<a name="l00297"></a>00297     }
<a name="l00298"></a>00298     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == &amp;type_strcasehash) {
<a name="l00299"></a>00299         collision.str++;
<a name="l00300"></a>00300     }
<a name="l00301"></a>00301 }
<a name="l00302"></a>00302 <span class="preprocessor">#define COLLISION (collision_check ? count_collision(table-&gt;type) : (void)0)</span>
<a name="l00303"></a>00303 <span class="preprocessor"></span><span class="preprocessor">#define FOUND_ENTRY (collision_check ? collision.total++ : (void)0)</span>
<a name="l00304"></a>00304 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00305"></a><a class="code" href="../../d4/d71/st_8c.html#aafd826a123a41fd03a9c88842387a821">00305</a> <span class="preprocessor"></span><span class="preprocessor">#define COLLISION</span>
<a name="l00306"></a><a class="code" href="../../d4/d71/st_8c.html#a3b3d5a648505e3a2db3d4d4504b13c0e">00306</a> <span class="preprocessor"></span><span class="preprocessor">#define FOUND_ENTRY</span>
<a name="l00307"></a>00307 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00308"></a>00308 <span class="preprocessor"></span>
<a name="l00309"></a><a class="code" href="../../d4/d71/st_8c.html#ade1811eeadef04915e40f72df282fa62">00309</a> <span class="preprocessor">#define FIND_ENTRY(table, ptr, hash_val, bin_pos) do {\</span>
<a name="l00310"></a>00310 <span class="preprocessor">    (bin_pos) = (hash_val)%(table)-&gt;num_bins;\</span>
<a name="l00311"></a>00311 <span class="preprocessor">    (ptr) = (table)-&gt;bins[(bin_pos)];\</span>
<a name="l00312"></a>00312 <span class="preprocessor">    FOUND_ENTRY;\</span>
<a name="l00313"></a>00313 <span class="preprocessor">    if (PTR_NOT_EQUAL((table), (ptr), (hash_val), key)) {\</span>
<a name="l00314"></a>00314 <span class="preprocessor">        COLLISION;\</span>
<a name="l00315"></a>00315 <span class="preprocessor">        while (PTR_NOT_EQUAL((table), (ptr)-&gt;next, (hash_val), key)) {\</span>
<a name="l00316"></a>00316 <span class="preprocessor">            (ptr) = (ptr)-&gt;next;\</span>
<a name="l00317"></a>00317 <span class="preprocessor">        }\</span>
<a name="l00318"></a>00318 <span class="preprocessor">        (ptr) = (ptr)-&gt;next;\</span>
<a name="l00319"></a>00319 <span class="preprocessor">    }\</span>
<a name="l00320"></a>00320 <span class="preprocessor">} while (0)</span>
<a name="l00321"></a>00321 <span class="preprocessor"></span>
<a name="l00322"></a>00322 <span class="preprocessor">#define collision_check 0</span>
<a name="l00323"></a>00323 <span class="preprocessor"></span>
<a name="l00324"></a>00324 <span class="keywordtype">int</span>
<a name="l00325"></a><a class="code" href="../../d4/d71/st_8c.html#af526fb7d918a9a5ceadadc087e79aa1c">00325</a> <a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table, <span class="keyword">register</span> <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> *value)
<a name="l00326"></a>00326 {
<a name="l00327"></a>00327     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> hash_val, bin_pos;
<a name="l00328"></a>00328     <span class="keyword">register</span> <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *ptr;
<a name="l00329"></a>00329 
<a name="l00330"></a>00330     <span class="keywordflow">if</span> (table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#af86c7c8652d8c86d356b6dc620a56efb">entries_packed</a>) {
<a name="l00331"></a>00331         <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> i;
<a name="l00332"></a>00332         <span class="keywordflow">for</span> (i = 0; i &lt; table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>; i++) {
<a name="l00333"></a>00333             <span class="keywordflow">if</span> ((<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2] == key) {
<a name="l00334"></a>00334                 <span class="keywordflow">if</span> (value !=0) *value = (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2+1];
<a name="l00335"></a>00335                 <span class="keywordflow">return</span> 1;
<a name="l00336"></a>00336             }
<a name="l00337"></a>00337         }
<a name="l00338"></a>00338         <span class="keywordflow">return</span> 0;
<a name="l00339"></a>00339     }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341     hash_val = <a class="code" href="../../d4/d71/st_8c.html#a8719b25fa2e849ad268f0bb382bae21c">do_hash</a>(key, table);
<a name="l00342"></a>00342     <a class="code" href="../../d4/d71/st_8c.html#ade1811eeadef04915e40f72df282fa62">FIND_ENTRY</a>(table, ptr, hash_val, bin_pos);
<a name="l00343"></a>00343 
<a name="l00344"></a>00344     <span class="keywordflow">if</span> (ptr == 0) {
<a name="l00345"></a>00345         <span class="keywordflow">return</span> 0;
<a name="l00346"></a>00346     }
<a name="l00347"></a>00347     <span class="keywordflow">else</span> {
<a name="l00348"></a>00348         <span class="keywordflow">if</span> (value != 0)  *value = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a78379c2ee6cf57370697a50ff7971b17">record</a>;
<a name="l00349"></a>00349         <span class="keywordflow">return</span> 1;
<a name="l00350"></a>00350     }
<a name="l00351"></a>00351 }
<a name="l00352"></a>00352 
<a name="l00353"></a>00353 <span class="keywordtype">int</span>
<a name="l00354"></a><a class="code" href="../../d4/d71/st_8c.html#ae666ef5798c3d30a0533bd91054ec1f3">00354</a> <a class="code" href="../../dd/d24/st_8h.html#a67fcf8f213cf0367f1923b2ae72b868d">st_get_key</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table, <span class="keyword">register</span> <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> *<a class="code" href="../../d8/d90/nkf_8c.html#a5ea5ac7abf5cce39283e422add1067d5">result</a>)
<a name="l00355"></a>00355 {
<a name="l00356"></a>00356     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> hash_val, bin_pos;
<a name="l00357"></a>00357     <span class="keyword">register</span> <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *ptr;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359     <span class="keywordflow">if</span> (table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#af86c7c8652d8c86d356b6dc620a56efb">entries_packed</a>) {
<a name="l00360"></a>00360         <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> i;
<a name="l00361"></a>00361         <span class="keywordflow">for</span> (i = 0; i &lt; table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>; i++) {
<a name="l00362"></a>00362             <span class="keywordflow">if</span> ((<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2] == key) {
<a name="l00363"></a>00363                 <span class="keywordflow">if</span> (result !=0) *result = (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2];
<a name="l00364"></a>00364                 <span class="keywordflow">return</span> 1;
<a name="l00365"></a>00365             }
<a name="l00366"></a>00366         }
<a name="l00367"></a>00367         <span class="keywordflow">return</span> 0;
<a name="l00368"></a>00368     }
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     hash_val = <a class="code" href="../../d4/d71/st_8c.html#a8719b25fa2e849ad268f0bb382bae21c">do_hash</a>(key, table);
<a name="l00371"></a>00371     <a class="code" href="../../d4/d71/st_8c.html#ade1811eeadef04915e40f72df282fa62">FIND_ENTRY</a>(table, ptr, hash_val, bin_pos);
<a name="l00372"></a>00372 
<a name="l00373"></a>00373     <span class="keywordflow">if</span> (ptr == 0) {
<a name="l00374"></a>00374         <span class="keywordflow">return</span> 0;
<a name="l00375"></a>00375     }
<a name="l00376"></a>00376     <span class="keywordflow">else</span> {
<a name="l00377"></a>00377         <span class="keywordflow">if</span> (result != 0)  *result = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a7c3f404248d6b3ed3235c49425c2b899">key</a>;
<a name="l00378"></a>00378         <span class="keywordflow">return</span> 1;
<a name="l00379"></a>00379     }
<a name="l00380"></a>00380 }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382 <span class="preprocessor">#undef collision_check</span>
<a name="l00383"></a><a class="code" href="../../d4/d71/st_8c.html#ae1c51589b76ef357bffa24d929c165e5">00383</a> <span class="preprocessor"></span><span class="preprocessor">#define collision_check 1</span>
<a name="l00384"></a>00384 <span class="preprocessor"></span>
<a name="l00385"></a><a class="code" href="../../d4/d71/st_8c.html#aecc14cc0cf491182bee62e6d4db68334">00385</a> <span class="preprocessor">#define MORE_PACKABLE_P(table) \</span>
<a name="l00386"></a>00386 <span class="preprocessor">    ((st_index_t)((table)-&gt;num_entries+1) * 2 &lt;= (table)-&gt;num_bins &amp;&amp; \</span>
<a name="l00387"></a>00387 <span class="preprocessor">     (table)-&gt;num_entries+1 &lt;= MAX_PACKED_NUMHASH)</span>
<a name="l00388"></a>00388 <span class="preprocessor"></span>
<a name="l00389"></a><a class="code" href="../../d4/d71/st_8c.html#a2adf90985f6ca4ecff6def2304d3d2dd">00389</a> <span class="preprocessor">#define ADD_DIRECT(table, key, value, hash_val, bin_pos)\</span>
<a name="l00390"></a>00390 <span class="preprocessor">do {\</span>
<a name="l00391"></a>00391 <span class="preprocessor">    st_table_entry *entry;\</span>
<a name="l00392"></a>00392 <span class="preprocessor">    if ((table)-&gt;num_entries &gt; ST_DEFAULT_MAX_DENSITY * (table)-&gt;num_bins) {\</span>
<a name="l00393"></a>00393 <span class="preprocessor">        rehash(table);\</span>
<a name="l00394"></a>00394 <span class="preprocessor">        (bin_pos) = (hash_val) % (table)-&gt;num_bins;\</span>
<a name="l00395"></a>00395 <span class="preprocessor">    }\</span>
<a name="l00396"></a>00396 <span class="preprocessor">    \</span>
<a name="l00397"></a>00397 <span class="preprocessor">    entry = alloc(st_table_entry);\</span>
<a name="l00398"></a>00398 <span class="preprocessor">    \</span>
<a name="l00399"></a>00399 <span class="preprocessor">    entry-&gt;hash = (hash_val);\</span>
<a name="l00400"></a>00400 <span class="preprocessor">    entry-&gt;key = (key);\</span>
<a name="l00401"></a>00401 <span class="preprocessor">    entry-&gt;record = (value);\</span>
<a name="l00402"></a>00402 <span class="preprocessor">    entry-&gt;next = (table)-&gt;bins[(bin_pos)];\</span>
<a name="l00403"></a>00403 <span class="preprocessor">    if ((table)-&gt;head != 0) {\</span>
<a name="l00404"></a>00404 <span class="preprocessor">        entry-&gt;fore = 0;\</span>
<a name="l00405"></a>00405 <span class="preprocessor">        (entry-&gt;back = (table)-&gt;tail)-&gt;fore = entry;\</span>
<a name="l00406"></a>00406 <span class="preprocessor">        (table)-&gt;tail = entry;\</span>
<a name="l00407"></a>00407 <span class="preprocessor">    }\</span>
<a name="l00408"></a>00408 <span class="preprocessor">    else {\</span>
<a name="l00409"></a>00409 <span class="preprocessor">        (table)-&gt;head = (table)-&gt;tail = entry;\</span>
<a name="l00410"></a>00410 <span class="preprocessor">        entry-&gt;fore = entry-&gt;back = 0;\</span>
<a name="l00411"></a>00411 <span class="preprocessor">    }\</span>
<a name="l00412"></a>00412 <span class="preprocessor">    (table)-&gt;bins[(bin_pos)] = entry;\</span>
<a name="l00413"></a>00413 <span class="preprocessor">    (table)-&gt;num_entries++;\</span>
<a name="l00414"></a>00414 <span class="preprocessor">} while (0)</span>
<a name="l00415"></a>00415 <span class="preprocessor"></span>
<a name="l00416"></a>00416 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00417"></a><a class="code" href="../../d4/d71/st_8c.html#abd2051b6b857de0a4b8aec12043fe005">00417</a> <a class="code" href="../../d4/d71/st_8c.html#abd2051b6b857de0a4b8aec12043fe005">unpack_entries</a>(<span class="keyword">register</span> <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table)
<a name="l00418"></a>00418 {
<a name="l00419"></a>00419     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> i;
<a name="l00420"></a>00420     <span class="keyword">struct </span><a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *packed_bins[<a class="code" href="../../d4/d71/st_8c.html#a5425f87cd69b75aba5ccbbb1c9a0a36a">MAX_PACKED_NUMHASH</a>*2];
<a name="l00421"></a>00421     <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> tmp_table = *table;
<a name="l00422"></a>00422 
<a name="l00423"></a>00423     memcpy(packed_bins, table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *) * table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>*2);
<a name="l00424"></a>00424     table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a> = packed_bins;
<a name="l00425"></a>00425     tmp_table.<a class="code" href="../../d0/ddd/structst__table.html#af86c7c8652d8c86d356b6dc620a56efb">entries_packed</a> = 0;
<a name="l00426"></a>00426     tmp_table.<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a> = 0;
<a name="l00427"></a>00427     memset(tmp_table.<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *) * tmp_table.<a class="code" href="../../d0/ddd/structst__table.html#a03f11a1fe0b82094d6acb038fa8118c3">num_bins</a>);
<a name="l00428"></a>00428     <span class="keywordflow">for</span> (i = 0; i &lt; table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>; i++) {
<a name="l00429"></a>00429         <a class="code" href="../../dd/d24/st_8h.html#acdc42c01229b7537ea5a4c6965c7e47a">st_insert</a>(&amp;tmp_table, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)packed_bins[i*2], (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)packed_bins[i*2+1]);
<a name="l00430"></a>00430     }
<a name="l00431"></a>00431     *table = tmp_table;
<a name="l00432"></a>00432 }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434 <span class="keywordtype">int</span>
<a name="l00435"></a><a class="code" href="../../d4/d71/st_8c.html#a068ebca65df8733df9e368b4d6dd82ca">00435</a> <a class="code" href="../../dd/d24/st_8h.html#acdc42c01229b7537ea5a4c6965c7e47a">st_insert</a>(<span class="keyword">register</span> <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table, <span class="keyword">register</span> <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> value)
<a name="l00436"></a>00436 {
<a name="l00437"></a>00437     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> hash_val, bin_pos;
<a name="l00438"></a>00438     <span class="keyword">register</span> <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *ptr;
<a name="l00439"></a>00439 
<a name="l00440"></a>00440     <span class="keywordflow">if</span> (table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#af86c7c8652d8c86d356b6dc620a56efb">entries_packed</a>) {
<a name="l00441"></a>00441         <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> i;
<a name="l00442"></a>00442         <span class="keywordflow">for</span> (i = 0; i &lt; table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>; i++) {
<a name="l00443"></a>00443             <span class="keywordflow">if</span> ((<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2] == key) {
<a name="l00444"></a>00444                 table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2+1] = (<span class="keyword">struct </span><a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>*)value;
<a name="l00445"></a>00445                 <span class="keywordflow">return</span> 1;
<a name="l00446"></a>00446             }
<a name="l00447"></a>00447         }
<a name="l00448"></a>00448         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d71/st_8c.html#aecc14cc0cf491182bee62e6d4db68334">MORE_PACKABLE_P</a>(table)) {
<a name="l00449"></a>00449             i = table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>++;
<a name="l00450"></a>00450             table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2] = (<span class="keyword">struct </span><a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>*)key;
<a name="l00451"></a>00451             table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2+1] = (<span class="keyword">struct </span><a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>*)value;
<a name="l00452"></a>00452             <span class="keywordflow">return</span> 0;
<a name="l00453"></a>00453         }
<a name="l00454"></a>00454         <span class="keywordflow">else</span> {
<a name="l00455"></a>00455             <a class="code" href="../../d4/d71/st_8c.html#abd2051b6b857de0a4b8aec12043fe005">unpack_entries</a>(table);
<a name="l00456"></a>00456         }
<a name="l00457"></a>00457     }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     hash_val = <a class="code" href="../../d4/d71/st_8c.html#a8719b25fa2e849ad268f0bb382bae21c">do_hash</a>(key, table);
<a name="l00460"></a>00460     <a class="code" href="../../d4/d71/st_8c.html#ade1811eeadef04915e40f72df282fa62">FIND_ENTRY</a>(table, ptr, hash_val, bin_pos);
<a name="l00461"></a>00461 
<a name="l00462"></a>00462     <span class="keywordflow">if</span> (ptr == 0) {
<a name="l00463"></a>00463         <a class="code" href="../../d4/d71/st_8c.html#a2adf90985f6ca4ecff6def2304d3d2dd">ADD_DIRECT</a>(table, key, value, hash_val, bin_pos);
<a name="l00464"></a>00464         <span class="keywordflow">return</span> 0;
<a name="l00465"></a>00465     }
<a name="l00466"></a>00466     <span class="keywordflow">else</span> {
<a name="l00467"></a>00467         ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a78379c2ee6cf57370697a50ff7971b17">record</a> = value;
<a name="l00468"></a>00468         <span class="keywordflow">return</span> 1;
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470 }
<a name="l00471"></a>00471 
<a name="l00472"></a>00472 <span class="keywordtype">int</span>
<a name="l00473"></a><a class="code" href="../../d4/d71/st_8c.html#a1000e3d262482cebe00e98bf21696749">00473</a> <a class="code" href="../../dd/d24/st_8h.html#a6978e6fe886b41a3c781a50760eb7d70">st_insert2</a>(<span class="keyword">register</span> <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table, <span class="keyword">register</span> <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> value,
<a name="l00474"></a>00474            <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> (*<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a>)(<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>))
<a name="l00475"></a>00475 {
<a name="l00476"></a>00476     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> hash_val, bin_pos;
<a name="l00477"></a>00477     <span class="keyword">register</span> <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *ptr;
<a name="l00478"></a>00478 
<a name="l00479"></a>00479     <span class="keywordflow">if</span> (table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#af86c7c8652d8c86d356b6dc620a56efb">entries_packed</a>) {
<a name="l00480"></a>00480         <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> i;
<a name="l00481"></a>00481         <span class="keywordflow">for</span> (i = 0; i &lt; table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>; i++) {
<a name="l00482"></a>00482             <span class="keywordflow">if</span> ((<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2] == key) {
<a name="l00483"></a>00483                 table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2+1] = (<span class="keyword">struct </span><a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>*)value;
<a name="l00484"></a>00484                 <span class="keywordflow">return</span> 1;
<a name="l00485"></a>00485             }
<a name="l00486"></a>00486         }
<a name="l00487"></a>00487         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d71/st_8c.html#aecc14cc0cf491182bee62e6d4db68334">MORE_PACKABLE_P</a>(table)) {
<a name="l00488"></a>00488             i = table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>++;
<a name="l00489"></a>00489             table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2] = (<span class="keyword">struct </span><a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>*)key;
<a name="l00490"></a>00490             table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2+1] = (<span class="keyword">struct </span><a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>*)value;
<a name="l00491"></a>00491             <span class="keywordflow">return</span> 0;
<a name="l00492"></a>00492         }
<a name="l00493"></a>00493         <span class="keywordflow">else</span> {
<a name="l00494"></a>00494             <a class="code" href="../../d4/d71/st_8c.html#abd2051b6b857de0a4b8aec12043fe005">unpack_entries</a>(table);
<a name="l00495"></a>00495         }
<a name="l00496"></a>00496     }
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     hash_val = <a class="code" href="../../d4/d71/st_8c.html#a8719b25fa2e849ad268f0bb382bae21c">do_hash</a>(key, table);
<a name="l00499"></a>00499     <a class="code" href="../../d4/d71/st_8c.html#ade1811eeadef04915e40f72df282fa62">FIND_ENTRY</a>(table, ptr, hash_val, bin_pos);
<a name="l00500"></a>00500 
<a name="l00501"></a>00501     <span class="keywordflow">if</span> (ptr == 0) {
<a name="l00502"></a>00502         key = (*func)(key);
<a name="l00503"></a>00503         <a class="code" href="../../d4/d71/st_8c.html#a2adf90985f6ca4ecff6def2304d3d2dd">ADD_DIRECT</a>(table, key, value, hash_val, bin_pos);
<a name="l00504"></a>00504         <span class="keywordflow">return</span> 0;
<a name="l00505"></a>00505     }
<a name="l00506"></a>00506     <span class="keywordflow">else</span> {
<a name="l00507"></a>00507         ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a78379c2ee6cf57370697a50ff7971b17">record</a> = value;
<a name="l00508"></a>00508         <span class="keywordflow">return</span> 1;
<a name="l00509"></a>00509     }
<a name="l00510"></a>00510 }
<a name="l00511"></a>00511 
<a name="l00512"></a>00512 <span class="keywordtype">void</span>
<a name="l00513"></a><a class="code" href="../../d4/d71/st_8c.html#a6c727f5a38e3e21fea2d0b8468813d87">00513</a> <a class="code" href="../../dd/d24/st_8h.html#aee4e16ae99cd543ddf851107d5ea5408">st_add_direct</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> key, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> value)
<a name="l00514"></a>00514 {
<a name="l00515"></a>00515     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> hash_val, bin_pos;
<a name="l00516"></a>00516 
<a name="l00517"></a>00517     <span class="keywordflow">if</span> (table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#af86c7c8652d8c86d356b6dc620a56efb">entries_packed</a>) {
<a name="l00518"></a>00518         <span class="keywordtype">int</span> i;
<a name="l00519"></a>00519         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d71/st_8c.html#aecc14cc0cf491182bee62e6d4db68334">MORE_PACKABLE_P</a>(table)) {
<a name="l00520"></a>00520             i = table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>++;
<a name="l00521"></a>00521             table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2] = (<span class="keyword">struct </span><a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>*)key;
<a name="l00522"></a>00522             table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2+1] = (<span class="keyword">struct </span><a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>*)value;
<a name="l00523"></a>00523             <span class="keywordflow">return</span>;
<a name="l00524"></a>00524         }
<a name="l00525"></a>00525         <span class="keywordflow">else</span> {
<a name="l00526"></a>00526             <a class="code" href="../../d4/d71/st_8c.html#abd2051b6b857de0a4b8aec12043fe005">unpack_entries</a>(table);
<a name="l00527"></a>00527         }
<a name="l00528"></a>00528     }
<a name="l00529"></a>00529 
<a name="l00530"></a>00530     hash_val = <a class="code" href="../../d4/d71/st_8c.html#a8719b25fa2e849ad268f0bb382bae21c">do_hash</a>(key, table);
<a name="l00531"></a>00531     bin_pos = hash_val % table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#a03f11a1fe0b82094d6acb038fa8118c3">num_bins</a>;
<a name="l00532"></a>00532     <a class="code" href="../../d4/d71/st_8c.html#a2adf90985f6ca4ecff6def2304d3d2dd">ADD_DIRECT</a>(table, key, value, hash_val, bin_pos);
<a name="l00533"></a>00533 }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00536"></a><a class="code" href="../../d4/d71/st_8c.html#a78898e934706b6d8fb8ffc7b598a0408">00536</a> <a class="code" href="../../d4/d71/st_8c.html#ae79a2e19d2287b6ac8d9a82f5c423a1c">rehash</a>(<span class="keyword">register</span> <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table)
<a name="l00537"></a>00537 {
<a name="l00538"></a>00538     <span class="keyword">register</span> <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *ptr, **new_bins;
<a name="l00539"></a>00539     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> i, new_num_bins, hash_val;
<a name="l00540"></a>00540 
<a name="l00541"></a>00541     new_num_bins = <a class="code" href="../../d4/d71/st_8c.html#a24df014296a421392679e4dd79101e7a">new_size</a>(table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#a03f11a1fe0b82094d6acb038fa8118c3">num_bins</a>+1);
<a name="l00542"></a>00542     new_bins = (<a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>**)
<a name="l00543"></a>00543         <a class="code" href="../../d8/db0/defines_8h.html#a40740062faf2d95d4935112447c464ef">xrealloc</a>(table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>, new_num_bins * <span class="keyword">sizeof</span>(<a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>*));
<a name="l00544"></a>00544     <span class="keywordflow">for</span> (i = 0; i &lt; new_num_bins; ++i) new_bins[i] = 0;
<a name="l00545"></a>00545     table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#a03f11a1fe0b82094d6acb038fa8118c3">num_bins</a> = new_num_bins;
<a name="l00546"></a>00546     table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a> = new_bins;
<a name="l00547"></a>00547 
<a name="l00548"></a>00548     <span class="keywordflow">if</span> ((ptr = table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aedc787fe0df08aff2d4079255a246878">head</a>) != 0) {
<a name="l00549"></a>00549         <span class="keywordflow">do</span> {
<a name="l00550"></a>00550             hash_val = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a4054ac2ac0f2065f541246bd665c6c7d">hash</a> % new_num_bins;
<a name="l00551"></a>00551             ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">next</a> = new_bins[hash_val];
<a name="l00552"></a>00552             new_bins[hash_val] = ptr;
<a name="l00553"></a>00553         } <span class="keywordflow">while</span> ((ptr = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a4f0048fd99145b5a1558da33c145ead3">fore</a>) != 0);
<a name="l00554"></a>00554     }
<a name="l00555"></a>00555 }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557 <a class="code" href="../../d0/ddd/structst__table.html">st_table</a>*
<a name="l00558"></a><a class="code" href="../../d4/d71/st_8c.html#a1fe53fe235ae6db0c7abe49413785363">00558</a> <a class="code" href="../../dd/d24/st_8h.html#a7dbfd8e3a251a09c8543b301bcef0cb5">st_copy</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *old_table)
<a name="l00559"></a>00559 {
<a name="l00560"></a>00560     <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *new_table;
<a name="l00561"></a>00561     <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *ptr, *entry, *<a class="code" href="../../d7/dc0/parse_8y.html#a71f8b6ffdc0cc58ffd989c3162fb2bcf">prev</a>, **tail;
<a name="l00562"></a>00562     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> num_bins = old_table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#a03f11a1fe0b82094d6acb038fa8118c3">num_bins</a>;
<a name="l00563"></a>00563     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> hash_val;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565     new_table = <a class="code" href="../../d4/d71/st_8c.html#a385b96996caa48e6349681cf8036322f">alloc</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a>);
<a name="l00566"></a>00566     <span class="keywordflow">if</span> (new_table == 0) {
<a name="l00567"></a>00567         <span class="keywordflow">return</span> 0;
<a name="l00568"></a>00568     }
<a name="l00569"></a>00569 
<a name="l00570"></a>00570     *new_table = *old_table;
<a name="l00571"></a>00571     new_table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a> = (<a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>**)
<a name="l00572"></a>00572         <a class="code" href="../../d4/d71/st_8c.html#a94c395161bf80ffa3b1d224ad3542f11">Calloc</a>((<span class="keywordtype">unsigned</span>)num_bins, <span class="keyword">sizeof</span>(<a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>*));
<a name="l00573"></a>00573 
<a name="l00574"></a>00574     <span class="keywordflow">if</span> (new_table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a> == 0) {
<a name="l00575"></a>00575         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(new_table);
<a name="l00576"></a>00576         <span class="keywordflow">return</span> 0;
<a name="l00577"></a>00577     }
<a name="l00578"></a>00578 
<a name="l00579"></a>00579     <span class="keywordflow">if</span> (old_table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#af86c7c8652d8c86d356b6dc620a56efb">entries_packed</a>) {
<a name="l00580"></a>00580         memcpy(new_table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>, old_table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *) * old_table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#a03f11a1fe0b82094d6acb038fa8118c3">num_bins</a>);
<a name="l00581"></a>00581         <span class="keywordflow">return</span> new_table;
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583 
<a name="l00584"></a>00584     <span class="keywordflow">if</span> ((ptr = old_table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aedc787fe0df08aff2d4079255a246878">head</a>) != 0) {
<a name="l00585"></a>00585         prev = 0;
<a name="l00586"></a>00586         tail = &amp;new_table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aedc787fe0df08aff2d4079255a246878">head</a>;
<a name="l00587"></a>00587         <span class="keywordflow">do</span> {
<a name="l00588"></a>00588             entry = <a class="code" href="../../d4/d71/st_8c.html#a385b96996caa48e6349681cf8036322f">alloc</a>(<a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>);
<a name="l00589"></a>00589             <span class="keywordflow">if</span> (entry == 0) {
<a name="l00590"></a>00590                 <a class="code" href="../../dd/d24/st_8h.html#acb004847ef312373d65bfb0d1a21c5b3">st_free_table</a>(new_table);
<a name="l00591"></a>00591                 <span class="keywordflow">return</span> 0;
<a name="l00592"></a>00592             }
<a name="l00593"></a>00593             *entry = *ptr;
<a name="l00594"></a>00594             hash_val = entry-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a4054ac2ac0f2065f541246bd665c6c7d">hash</a> % num_bins;
<a name="l00595"></a>00595             entry-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">next</a> = new_table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[hash_val];
<a name="l00596"></a>00596             new_table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[hash_val] = entry;
<a name="l00597"></a>00597             entry-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a2cd684cc9d44752fa7de8946e10e0c13">back</a> = prev;
<a name="l00598"></a>00598             *tail = prev = entry;
<a name="l00599"></a>00599             tail = &amp;entry-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a4f0048fd99145b5a1558da33c145ead3">fore</a>;
<a name="l00600"></a>00600         } <span class="keywordflow">while</span> ((ptr = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a4f0048fd99145b5a1558da33c145ead3">fore</a>) != 0);
<a name="l00601"></a>00601         new_table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aee1c61d83bbbf2f176255a8a903a92ed">tail</a> = prev;
<a name="l00602"></a>00602     }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604     <span class="keywordflow">return</span> new_table;
<a name="l00605"></a>00605 }
<a name="l00606"></a>00606 
<a name="l00607"></a><a class="code" href="../../d4/d71/st_8c.html#afbf658274f1e8229ce3efad9b1eb11d3">00607</a> <span class="preprocessor">#define REMOVE_ENTRY(table, ptr) do                                     \</span>
<a name="l00608"></a>00608 <span class="preprocessor">    {                                                                   \</span>
<a name="l00609"></a>00609 <span class="preprocessor">        if ((ptr)-&gt;fore == 0 &amp;&amp; (ptr)-&gt;back == 0) {                     \</span>
<a name="l00610"></a>00610 <span class="preprocessor">            (table)-&gt;head = 0;                                          \</span>
<a name="l00611"></a>00611 <span class="preprocessor">            (table)-&gt;tail = 0;                                          \</span>
<a name="l00612"></a>00612 <span class="preprocessor">        }                                                               \</span>
<a name="l00613"></a>00613 <span class="preprocessor">        else {                                                          \</span>
<a name="l00614"></a>00614 <span class="preprocessor">            st_table_entry *fore = (ptr)-&gt;fore, *back = (ptr)-&gt;back;    \</span>
<a name="l00615"></a>00615 <span class="preprocessor">            if (fore) fore-&gt;back = back;                                \</span>
<a name="l00616"></a>00616 <span class="preprocessor">            if (back) back-&gt;fore = fore;                                \</span>
<a name="l00617"></a>00617 <span class="preprocessor">            if ((ptr) == (table)-&gt;head) (table)-&gt;head = fore;           \</span>
<a name="l00618"></a>00618 <span class="preprocessor">            if ((ptr) == (table)-&gt;tail) (table)-&gt;tail = back;           \</span>
<a name="l00619"></a>00619 <span class="preprocessor">        }                                                               \</span>
<a name="l00620"></a>00620 <span class="preprocessor">        (table)-&gt;num_entries--;                                         \</span>
<a name="l00621"></a>00621 <span class="preprocessor">    } while (0)</span>
<a name="l00622"></a>00622 <span class="preprocessor"></span>
<a name="l00623"></a>00623 <span class="keywordtype">int</span>
<a name="l00624"></a><a class="code" href="../../d4/d71/st_8c.html#a376a6db1416fd2edb1ce72ad624ff109">00624</a> <a class="code" href="../../dd/d24/st_8h.html#aa04e4ee0a6e1f19e64f3be4668f41234">st_delete</a>(<span class="keyword">register</span> <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table, <span class="keyword">register</span> <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> *key, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> *value)
<a name="l00625"></a>00625 {
<a name="l00626"></a>00626     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> hash_val;
<a name="l00627"></a>00627     <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> **<a class="code" href="../../d7/dc0/parse_8y.html#a71f8b6ffdc0cc58ffd989c3162fb2bcf">prev</a>;
<a name="l00628"></a>00628     <span class="keyword">register</span> <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *ptr;
<a name="l00629"></a>00629 
<a name="l00630"></a>00630     <span class="keywordflow">if</span> (table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#af86c7c8652d8c86d356b6dc620a56efb">entries_packed</a>) {
<a name="l00631"></a>00631         <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> i;
<a name="l00632"></a>00632         <span class="keywordflow">for</span> (i = 0; i &lt; table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>; i++) {
<a name="l00633"></a>00633             <span class="keywordflow">if</span> ((<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2] == *key) {
<a name="l00634"></a>00634                 <span class="keywordflow">if</span> (value != 0) *value = (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2+1];
<a name="l00635"></a>00635                 table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>--;
<a name="l00636"></a>00636                 <a class="code" href="../../d3/d90/missing_8h.html#a809a3e9326a0d3e5aa549b17085b057d">memmove</a>(&amp;table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2], &amp;table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[(i+1)*2],
<a name="l00637"></a>00637                         <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>*) * 2*(table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>-i));
<a name="l00638"></a>00638                 <span class="keywordflow">return</span> 1;
<a name="l00639"></a>00639             }
<a name="l00640"></a>00640         }
<a name="l00641"></a>00641         <span class="keywordflow">if</span> (value != 0) *value = 0;
<a name="l00642"></a>00642         <span class="keywordflow">return</span> 0;
<a name="l00643"></a>00643     }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645     hash_val = <a class="code" href="../../d4/d71/st_8c.html#a2e66e2285d7393eca0aea2eac98b8ded">do_hash_bin</a>(*key, table);
<a name="l00646"></a>00646 
<a name="l00647"></a>00647     <span class="keywordflow">for</span> (prev = &amp;table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[hash_val]; (ptr = *prev) != 0; prev = &amp;ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">next</a>) {
<a name="l00648"></a>00648         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d71/st_8c.html#ab5676cd1fb91981de326030c5b15c867">EQUAL</a>(table, *key, ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a7c3f404248d6b3ed3235c49425c2b899">key</a>)) {
<a name="l00649"></a>00649             *prev = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">next</a>;
<a name="l00650"></a>00650             <a class="code" href="../../d4/d71/st_8c.html#afbf658274f1e8229ce3efad9b1eb11d3">REMOVE_ENTRY</a>(table, ptr);
<a name="l00651"></a>00651             <span class="keywordflow">if</span> (value != 0) *value = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a78379c2ee6cf57370697a50ff7971b17">record</a>;
<a name="l00652"></a>00652             *key = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a7c3f404248d6b3ed3235c49425c2b899">key</a>;
<a name="l00653"></a>00653             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(ptr);
<a name="l00654"></a>00654             <span class="keywordflow">return</span> 1;
<a name="l00655"></a>00655         }
<a name="l00656"></a>00656     }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658     <span class="keywordflow">if</span> (value != 0) *value = 0;
<a name="l00659"></a>00659     <span class="keywordflow">return</span> 0;
<a name="l00660"></a>00660 }
<a name="l00661"></a>00661 
<a name="l00662"></a>00662 <span class="keywordtype">int</span>
<a name="l00663"></a><a class="code" href="../../d4/d71/st_8c.html#aaafeee841b664f0ea14b28e7e1b1a71a">00663</a> <a class="code" href="../../dd/d24/st_8h.html#ad8f6ec3ebca4d18729cef285a2ce72f2">st_delete_safe</a>(<span class="keyword">register</span> <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table, <span class="keyword">register</span> <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> *key, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> *value, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> never)
<a name="l00664"></a>00664 {
<a name="l00665"></a>00665     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> hash_val;
<a name="l00666"></a>00666     <span class="keyword">register</span> <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *ptr;
<a name="l00667"></a>00667 
<a name="l00668"></a>00668     <span class="keywordflow">if</span> (table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#af86c7c8652d8c86d356b6dc620a56efb">entries_packed</a>) {
<a name="l00669"></a>00669         <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> i;
<a name="l00670"></a>00670         <span class="keywordflow">for</span> (i = 0; i &lt; table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>; i++) {
<a name="l00671"></a>00671             <span class="keywordflow">if</span> ((<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2] == *key) {
<a name="l00672"></a>00672                 <span class="keywordflow">if</span> (value != 0) *value = (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2+1];
<a name="l00673"></a>00673                 table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2] = (<span class="keywordtype">void</span> *)never;
<a name="l00674"></a>00674                 <span class="keywordflow">return</span> 1;
<a name="l00675"></a>00675             }
<a name="l00676"></a>00676         }
<a name="l00677"></a>00677         <span class="keywordflow">if</span> (value != 0) *value = 0;
<a name="l00678"></a>00678         <span class="keywordflow">return</span> 0;
<a name="l00679"></a>00679     }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     hash_val = <a class="code" href="../../d4/d71/st_8c.html#a2e66e2285d7393eca0aea2eac98b8ded">do_hash_bin</a>(*key, table);
<a name="l00682"></a>00682     ptr = table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[hash_val];
<a name="l00683"></a>00683 
<a name="l00684"></a>00684     <span class="keywordflow">for</span> (; ptr != 0; ptr = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">next</a>) {
<a name="l00685"></a>00685         <span class="keywordflow">if</span> ((ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a7c3f404248d6b3ed3235c49425c2b899">key</a> != never) &amp;&amp; <a class="code" href="../../d4/d71/st_8c.html#ab5676cd1fb91981de326030c5b15c867">EQUAL</a>(table, ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a7c3f404248d6b3ed3235c49425c2b899">key</a>, *key)) {
<a name="l00686"></a>00686             <a class="code" href="../../d4/d71/st_8c.html#afbf658274f1e8229ce3efad9b1eb11d3">REMOVE_ENTRY</a>(table, ptr);
<a name="l00687"></a>00687             *key = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a7c3f404248d6b3ed3235c49425c2b899">key</a>;
<a name="l00688"></a>00688             <span class="keywordflow">if</span> (value != 0) *value = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a78379c2ee6cf57370697a50ff7971b17">record</a>;
<a name="l00689"></a>00689             ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a7c3f404248d6b3ed3235c49425c2b899">key</a> = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a78379c2ee6cf57370697a50ff7971b17">record</a> = never;
<a name="l00690"></a>00690             <span class="keywordflow">return</span> 1;
<a name="l00691"></a>00691         }
<a name="l00692"></a>00692     }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694     <span class="keywordflow">if</span> (value != 0) *value = 0;
<a name="l00695"></a>00695     <span class="keywordflow">return</span> 0;
<a name="l00696"></a>00696 }
<a name="l00697"></a>00697 
<a name="l00698"></a>00698 <span class="keywordtype">void</span>
<a name="l00699"></a><a class="code" href="../../d4/d71/st_8c.html#a3fde5a76b3fc28787b7350eaf790676b">00699</a> <a class="code" href="../../dd/d24/st_8h.html#af5a20fb5a1b35bfc5d756146faca69b1">st_cleanup_safe</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> never)
<a name="l00700"></a>00700 {
<a name="l00701"></a>00701     <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *ptr, **<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a>, *tmp;
<a name="l00702"></a>00702     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> i;
<a name="l00703"></a>00703 
<a name="l00704"></a>00704     <span class="keywordflow">if</span> (table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#af86c7c8652d8c86d356b6dc620a56efb">entries_packed</a>) {
<a name="l00705"></a>00705         <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> i = 0, j = 0;
<a name="l00706"></a>00706         <span class="keywordflow">while</span> ((<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2] != never) {
<a name="l00707"></a>00707             <span class="keywordflow">if</span> (i++ == table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>) <span class="keywordflow">return</span>;
<a name="l00708"></a>00708         }
<a name="l00709"></a>00709         <span class="keywordflow">for</span> (j = i; ++i &lt; table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>;) {
<a name="l00710"></a>00710             <span class="keywordflow">if</span> ((<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2] == never) <span class="keywordflow">continue</span>;
<a name="l00711"></a>00711             table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[j*2] = table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2];
<a name="l00712"></a>00712             table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[j*2+1] = table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2+1];
<a name="l00713"></a>00713             j++;
<a name="l00714"></a>00714         }
<a name="l00715"></a>00715         table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a> = j;
<a name="l00716"></a>00716         <span class="keywordflow">return</span>;
<a name="l00717"></a>00717     }
<a name="l00718"></a>00718 
<a name="l00719"></a>00719     <span class="keywordflow">for</span> (i = 0; i &lt; table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#a03f11a1fe0b82094d6acb038fa8118c3">num_bins</a>; i++) {
<a name="l00720"></a>00720         ptr = *(last = &amp;table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i]);
<a name="l00721"></a>00721         <span class="keywordflow">while</span> (ptr != 0) {
<a name="l00722"></a>00722             <span class="keywordflow">if</span> (ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a7c3f404248d6b3ed3235c49425c2b899">key</a> == never) {
<a name="l00723"></a>00723                 tmp = ptr;
<a name="l00724"></a>00724                 *last = ptr = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">next</a>;
<a name="l00725"></a>00725                 <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(tmp);
<a name="l00726"></a>00726             }
<a name="l00727"></a>00727             <span class="keywordflow">else</span> {
<a name="l00728"></a>00728                 ptr = *(last = &amp;ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">next</a>);
<a name="l00729"></a>00729             }
<a name="l00730"></a>00730         }
<a name="l00731"></a>00731     }
<a name="l00732"></a>00732 }
<a name="l00733"></a>00733 
<a name="l00734"></a>00734 <span class="keywordtype">int</span>
<a name="l00735"></a><a class="code" href="../../d4/d71/st_8c.html#accc02c609f11fe0cad4061ff19f09b9a">00735</a> <a class="code" href="../../dd/d24/st_8h.html#ace5a79870d2800659a653fceeca55262">st_foreach</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table, <span class="keywordtype">int</span> (*<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a>)(<a class="code" href="../../d8/db0/defines_8h.html#af4fd7cbafda9af704310f78516042dfb">ANYARGS</a>), <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> arg)
<a name="l00736"></a>00736 {
<a name="l00737"></a>00737     <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *ptr, **<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a>, *tmp;
<a name="l00738"></a>00738     <span class="keyword">enum</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1f">st_retval</a> retval;
<a name="l00739"></a>00739     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> i;
<a name="l00740"></a>00740 
<a name="l00741"></a>00741     <span class="keywordflow">if</span> (table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#af86c7c8652d8c86d356b6dc620a56efb">entries_packed</a>) {
<a name="l00742"></a>00742         <span class="keywordflow">for</span> (i = 0; i &lt; table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>; i++) {
<a name="l00743"></a>00743             <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> j;
<a name="l00744"></a>00744             <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> key, val;
<a name="l00745"></a>00745             key = (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2];
<a name="l00746"></a>00746             val = (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2+1];
<a name="l00747"></a>00747             retval = (*func)(key, val, arg);
<a name="l00748"></a>00748             <span class="keywordflow">if</span> (!table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#af86c7c8652d8c86d356b6dc620a56efb">entries_packed</a>) {
<a name="l00749"></a>00749                 <a class="code" href="../../d4/d71/st_8c.html#ade1811eeadef04915e40f72df282fa62">FIND_ENTRY</a>(table, ptr, key, i);
<a name="l00750"></a>00750                 <span class="keywordflow">if</span> (retval == <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fa362d37dd656ca6a08178514d3dd3bf69">ST_CHECK</a>) {
<a name="l00751"></a>00751                     <span class="keywordflow">if</span> (!ptr) <span class="keywordflow">goto</span> deleted;
<a name="l00752"></a>00752                     <span class="keywordflow">goto</span> unpacked_continue;
<a name="l00753"></a>00753                 }
<a name="l00754"></a>00754                 <span class="keywordflow">goto</span> unpacked;
<a name="l00755"></a>00755             }
<a name="l00756"></a>00756             <span class="keywordflow">switch</span> (retval) {
<a name="l00757"></a>00757               <span class="keywordflow">case</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fa362d37dd656ca6a08178514d3dd3bf69">ST_CHECK</a>:    <span class="comment">/* check if hash is modified during iteration */</span>
<a name="l00758"></a>00758                 <span class="keywordflow">for</span> (j = 0; j &lt; table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>; j++) {
<a name="l00759"></a>00759                     <span class="keywordflow">if</span> ((<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[j*2] == key)
<a name="l00760"></a>00760                         <span class="keywordflow">break</span>;
<a name="l00761"></a>00761                 }
<a name="l00762"></a>00762                 <span class="keywordflow">if</span> (j == table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>) {
<a name="l00763"></a>00763                     <span class="keywordflow">goto</span> deleted;
<a name="l00764"></a>00764                 }
<a name="l00765"></a>00765                 <span class="comment">/* fall through */</span>
<a name="l00766"></a>00766               <span class="keywordflow">case</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>:
<a name="l00767"></a>00767                 <span class="keywordflow">break</span>;
<a name="l00768"></a>00768               <span class="keywordflow">case</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fa04b939c166d4baa471909eb224d5fed3">ST_STOP</a>:
<a name="l00769"></a>00769                 <span class="keywordflow">return</span> 0;
<a name="l00770"></a>00770               <span class="keywordflow">case</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fa64ab176f8e8b9719bcd9b5297ccda9c7">ST_DELETE</a>:
<a name="l00771"></a>00771                 table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>--;
<a name="l00772"></a>00772                 <a class="code" href="../../d3/d90/missing_8h.html#a809a3e9326a0d3e5aa549b17085b057d">memmove</a>(&amp;table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2], &amp;table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[(i+1)*2],
<a name="l00773"></a>00773                         <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>*) * 2*(table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>-i));
<a name="l00774"></a>00774                 i--;
<a name="l00775"></a>00775                 <span class="keywordflow">break</span>;
<a name="l00776"></a>00776             }
<a name="l00777"></a>00777         }
<a name="l00778"></a>00778         <span class="keywordflow">return</span> 0;
<a name="l00779"></a>00779     }
<a name="l00780"></a>00780     <span class="keywordflow">else</span> {
<a name="l00781"></a>00781         ptr = table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aedc787fe0df08aff2d4079255a246878">head</a>;
<a name="l00782"></a>00782     }
<a name="l00783"></a>00783 
<a name="l00784"></a>00784     <span class="keywordflow">if</span> (ptr != 0) {
<a name="l00785"></a>00785         <span class="keywordflow">do</span> {
<a name="l00786"></a>00786             i = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a4054ac2ac0f2065f541246bd665c6c7d">hash</a> % table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#a03f11a1fe0b82094d6acb038fa8118c3">num_bins</a>;
<a name="l00787"></a>00787             retval = (*func)(ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a7c3f404248d6b3ed3235c49425c2b899">key</a>, ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a78379c2ee6cf57370697a50ff7971b17">record</a>, arg);
<a name="l00788"></a>00788           unpacked:
<a name="l00789"></a>00789             <span class="keywordflow">switch</span> (retval) {
<a name="l00790"></a>00790               <span class="keywordflow">case</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fa362d37dd656ca6a08178514d3dd3bf69">ST_CHECK</a>:    <span class="comment">/* check if hash is modified during iteration */</span>
<a name="l00791"></a>00791                 <span class="keywordflow">for</span> (tmp = table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i]; tmp != ptr; tmp = tmp-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">next</a>) {
<a name="l00792"></a>00792                     <span class="keywordflow">if</span> (!tmp) {
<a name="l00793"></a>00793                       deleted:
<a name="l00794"></a>00794                         <span class="comment">/* call func with error notice */</span>
<a name="l00795"></a>00795                         retval = (*func)(0, 0, arg, 1);
<a name="l00796"></a>00796                         <span class="keywordflow">return</span> 1;
<a name="l00797"></a>00797                     }
<a name="l00798"></a>00798                 }
<a name="l00799"></a>00799                 <span class="comment">/* fall through */</span>
<a name="l00800"></a>00800               <span class="keywordflow">case</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>:
<a name="l00801"></a>00801               unpacked_continue:
<a name="l00802"></a>00802                 ptr = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a4f0048fd99145b5a1558da33c145ead3">fore</a>;
<a name="l00803"></a>00803                 <span class="keywordflow">break</span>;
<a name="l00804"></a>00804               <span class="keywordflow">case</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fa04b939c166d4baa471909eb224d5fed3">ST_STOP</a>:
<a name="l00805"></a>00805                 <span class="keywordflow">return</span> 0;
<a name="l00806"></a>00806               <span class="keywordflow">case</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fa64ab176f8e8b9719bcd9b5297ccda9c7">ST_DELETE</a>:
<a name="l00807"></a>00807                 last = &amp;table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a4054ac2ac0f2065f541246bd665c6c7d">hash</a> % table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#a03f11a1fe0b82094d6acb038fa8118c3">num_bins</a>];
<a name="l00808"></a>00808                 <span class="keywordflow">for</span> (; (tmp = *last) != 0; last = &amp;tmp-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">next</a>) {
<a name="l00809"></a>00809                     <span class="keywordflow">if</span> (ptr == tmp) {
<a name="l00810"></a>00810                         tmp = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a4f0048fd99145b5a1558da33c145ead3">fore</a>;
<a name="l00811"></a>00811                         *last = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">next</a>;
<a name="l00812"></a>00812                         <a class="code" href="../../d4/d71/st_8c.html#afbf658274f1e8229ce3efad9b1eb11d3">REMOVE_ENTRY</a>(table, ptr);
<a name="l00813"></a>00813                         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(ptr);
<a name="l00814"></a>00814                         <span class="keywordflow">if</span> (ptr == tmp) <span class="keywordflow">return</span> 0;
<a name="l00815"></a>00815                         ptr = tmp;
<a name="l00816"></a>00816                         <span class="keywordflow">break</span>;
<a name="l00817"></a>00817                     }
<a name="l00818"></a>00818                 }
<a name="l00819"></a>00819             }
<a name="l00820"></a>00820         } <span class="keywordflow">while</span> (ptr &amp;&amp; table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aedc787fe0df08aff2d4079255a246878">head</a>);
<a name="l00821"></a>00821     }
<a name="l00822"></a>00822     <span class="keywordflow">return</span> 0;
<a name="l00823"></a>00823 }
<a name="l00824"></a>00824 
<a name="l00825"></a>00825 <span class="preprocessor">#if 0  </span><span class="comment">/* unused right now */</span>
<a name="l00826"></a>00826 <span class="keywordtype">int</span>
<a name="l00827"></a>00827 <a class="code" href="../../dd/d24/st_8h.html#ad7c52b70fe389bc967a1868c76a1e10c">st_reverse_foreach</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table, <span class="keywordtype">int</span> (*<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a>)(<a class="code" href="../../d8/db0/defines_8h.html#af4fd7cbafda9af704310f78516042dfb">ANYARGS</a>), <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> arg)
<a name="l00828"></a>00828 {
<a name="l00829"></a>00829     <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a> *ptr, **<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a>, *tmp;
<a name="l00830"></a>00830     <span class="keyword">enum</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1f">st_retval</a> retval;
<a name="l00831"></a>00831     <span class="keywordtype">int</span> i;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833     <span class="keywordflow">if</span> (table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#af86c7c8652d8c86d356b6dc620a56efb">entries_packed</a>) {
<a name="l00834"></a>00834         <span class="keywordflow">for</span> (i = table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>-1; 0 &lt;= i; i--) {
<a name="l00835"></a>00835             <span class="keywordtype">int</span> j;
<a name="l00836"></a>00836             <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> key, val;
<a name="l00837"></a>00837             key = (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2];
<a name="l00838"></a>00838             val = (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2+1];
<a name="l00839"></a>00839             retval = (*func)(key, val, arg);
<a name="l00840"></a>00840             <span class="keywordflow">switch</span> (retval) {
<a name="l00841"></a>00841               <span class="keywordflow">case</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fa362d37dd656ca6a08178514d3dd3bf69">ST_CHECK</a>:    <span class="comment">/* check if hash is modified during iteration */</span>
<a name="l00842"></a>00842                 <span class="keywordflow">for</span> (j = 0; j &lt; table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>; j++) {
<a name="l00843"></a>00843                     <span class="keywordflow">if</span> ((<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[j*2] == key)
<a name="l00844"></a>00844                         <span class="keywordflow">break</span>;
<a name="l00845"></a>00845                 }
<a name="l00846"></a>00846                 <span class="keywordflow">if</span> (j == table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>) {
<a name="l00847"></a>00847                     <span class="comment">/* call func with error notice */</span>
<a name="l00848"></a>00848                     retval = (*func)(0, 0, arg, 1);
<a name="l00849"></a>00849                     <span class="keywordflow">return</span> 1;
<a name="l00850"></a>00850                 }
<a name="l00851"></a>00851                 <span class="comment">/* fall through */</span>
<a name="l00852"></a>00852               <span class="keywordflow">case</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>:
<a name="l00853"></a>00853                 <span class="keywordflow">break</span>;
<a name="l00854"></a>00854               <span class="keywordflow">case</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fa04b939c166d4baa471909eb224d5fed3">ST_STOP</a>:
<a name="l00855"></a>00855                 <span class="keywordflow">return</span> 0;
<a name="l00856"></a>00856               <span class="keywordflow">case</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fa64ab176f8e8b9719bcd9b5297ccda9c7">ST_DELETE</a>:
<a name="l00857"></a>00857                 table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>--;
<a name="l00858"></a>00858                 <a class="code" href="../../d3/d90/missing_8h.html#a809a3e9326a0d3e5aa549b17085b057d">memmove</a>(&amp;table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i*2], &amp;table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[(i+1)*2],
<a name="l00859"></a>00859                         <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../df/dfb/structst__table__entry.html">st_table_entry</a>*) * 2*(table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>-i));
<a name="l00860"></a>00860                 <span class="keywordflow">break</span>;
<a name="l00861"></a>00861             }
<a name="l00862"></a>00862         }
<a name="l00863"></a>00863         <span class="keywordflow">return</span> 0;
<a name="l00864"></a>00864     }
<a name="l00865"></a>00865 
<a name="l00866"></a>00866     <span class="keywordflow">if</span> ((ptr = table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aedc787fe0df08aff2d4079255a246878">head</a>) != 0) {
<a name="l00867"></a>00867         ptr = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a2cd684cc9d44752fa7de8946e10e0c13">back</a>;
<a name="l00868"></a>00868         <span class="keywordflow">do</span> {
<a name="l00869"></a>00869             retval = (*func)(ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a7c3f404248d6b3ed3235c49425c2b899">key</a>, ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a78379c2ee6cf57370697a50ff7971b17">record</a>, arg, 0);
<a name="l00870"></a>00870             <span class="keywordflow">switch</span> (retval) {
<a name="l00871"></a>00871               <span class="keywordflow">case</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fa362d37dd656ca6a08178514d3dd3bf69">ST_CHECK</a>:    <span class="comment">/* check if hash is modified during iteration */</span>
<a name="l00872"></a>00872                 i = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a4054ac2ac0f2065f541246bd665c6c7d">hash</a> % table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#a03f11a1fe0b82094d6acb038fa8118c3">num_bins</a>;
<a name="l00873"></a>00873                 <span class="keywordflow">for</span> (tmp = table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[i]; tmp != ptr; tmp = tmp-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">next</a>) {
<a name="l00874"></a>00874                     <span class="keywordflow">if</span> (!tmp) {
<a name="l00875"></a>00875                         <span class="comment">/* call func with error notice */</span>
<a name="l00876"></a>00876                         retval = (*func)(0, 0, arg, 1);
<a name="l00877"></a>00877                         <span class="keywordflow">return</span> 1;
<a name="l00878"></a>00878                     }
<a name="l00879"></a>00879                 }
<a name="l00880"></a>00880                 <span class="comment">/* fall through */</span>
<a name="l00881"></a>00881               <span class="keywordflow">case</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>:
<a name="l00882"></a>00882                 ptr = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a2cd684cc9d44752fa7de8946e10e0c13">back</a>;
<a name="l00883"></a>00883                 <span class="keywordflow">break</span>;
<a name="l00884"></a>00884               <span class="keywordflow">case</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fa04b939c166d4baa471909eb224d5fed3">ST_STOP</a>:
<a name="l00885"></a>00885                 <span class="keywordflow">return</span> 0;
<a name="l00886"></a>00886               <span class="keywordflow">case</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fa64ab176f8e8b9719bcd9b5297ccda9c7">ST_DELETE</a>:
<a name="l00887"></a>00887                 last = &amp;table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#ae05091dd67490761fee653130e12c997">bins</a>[ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a4054ac2ac0f2065f541246bd665c6c7d">hash</a> % table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#a03f11a1fe0b82094d6acb038fa8118c3">num_bins</a>];
<a name="l00888"></a>00888                 <span class="keywordflow">for</span> (; (tmp = *last) != 0; last = &amp;tmp-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">next</a>) {
<a name="l00889"></a>00889                     <span class="keywordflow">if</span> (ptr == tmp) {
<a name="l00890"></a>00890                         tmp = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a2cd684cc9d44752fa7de8946e10e0c13">back</a>;
<a name="l00891"></a>00891                         *last = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">next</a>;
<a name="l00892"></a>00892                         <a class="code" href="../../d4/d71/st_8c.html#afbf658274f1e8229ce3efad9b1eb11d3">REMOVE_ENTRY</a>(table, ptr);
<a name="l00893"></a>00893                         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(ptr);
<a name="l00894"></a>00894                         ptr = tmp;
<a name="l00895"></a>00895                         <span class="keywordflow">break</span>;
<a name="l00896"></a>00896                     }
<a name="l00897"></a>00897                 }
<a name="l00898"></a>00898                 ptr = ptr-&gt;<a class="code" href="../../df/dfb/structst__table__entry.html#a8c7fef89f13d76633cd71d595d39181d">next</a>;
<a name="l00899"></a>00899                 <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(tmp);
<a name="l00900"></a>00900                 table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a>--;
<a name="l00901"></a>00901             }
<a name="l00902"></a>00902         } <span class="keywordflow">while</span> (ptr &amp;&amp; table-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aedc787fe0df08aff2d4079255a246878">head</a>);
<a name="l00903"></a>00903     }
<a name="l00904"></a>00904     <span class="keywordflow">return</span> 0;
<a name="l00905"></a>00905 }
<a name="l00906"></a>00906 <span class="preprocessor">#endif</span>
<a name="l00907"></a>00907 <span class="preprocessor"></span>
<a name="l00908"></a>00908 <span class="comment">/*</span>
<a name="l00909"></a>00909 <span class="comment"> * hash_32 - 32 bit Fowler/Noll/Vo FNV-1a hash code</span>
<a name="l00910"></a>00910 <span class="comment"> *</span>
<a name="l00911"></a>00911 <span class="comment"> * @(#) $Hash32: Revision: 1.1 $</span>
<a name="l00912"></a>00912 <span class="comment"> * @(#) $Hash32: Id: hash_32a.c,v 1.1 2003/10/03 20:38:53 chongo Exp $</span>
<a name="l00913"></a>00913 <span class="comment"> * @(#) $Hash32: Source: /usr/local/src/cmd/fnv/RCS/hash_32a.c,v $</span>
<a name="l00914"></a>00914 <span class="comment"> *</span>
<a name="l00915"></a>00915 <span class="comment"> ***</span>
<a name="l00916"></a>00916 <span class="comment"> *</span>
<a name="l00917"></a>00917 <span class="comment"> * Fowler/Noll/Vo hash</span>
<a name="l00918"></a>00918 <span class="comment"> *</span>
<a name="l00919"></a>00919 <span class="comment"> * The basis of this hash algorithm was taken from an idea sent</span>
<a name="l00920"></a>00920 <span class="comment"> * as reviewer comments to the IEEE POSIX P1003.2 committee by:</span>
<a name="l00921"></a>00921 <span class="comment"> *</span>
<a name="l00922"></a>00922 <span class="comment"> *      Phong Vo (http://www.research.att.com/info/kpv/)</span>
<a name="l00923"></a>00923 <span class="comment"> *      Glenn Fowler (http://www.research.att.com/~gsf/)</span>
<a name="l00924"></a>00924 <span class="comment"> *</span>
<a name="l00925"></a>00925 <span class="comment"> * In a subsequent ballot round:</span>
<a name="l00926"></a>00926 <span class="comment"> *</span>
<a name="l00927"></a>00927 <span class="comment"> *      Landon Curt Noll (http://www.isthe.com/chongo/)</span>
<a name="l00928"></a>00928 <span class="comment"> *</span>
<a name="l00929"></a>00929 <span class="comment"> * improved on their algorithm.  Some people tried this hash</span>
<a name="l00930"></a>00930 <span class="comment"> * and found that it worked rather well.  In an EMail message</span>
<a name="l00931"></a>00931 <span class="comment"> * to Landon, they named it the ``Fowler/Noll/Vo&apos;&apos; or FNV hash.</span>
<a name="l00932"></a>00932 <span class="comment"> *</span>
<a name="l00933"></a>00933 <span class="comment"> * FNV hashes are designed to be fast while maintaining a low</span>
<a name="l00934"></a>00934 <span class="comment"> * collision rate. The FNV speed allows one to quickly hash lots</span>
<a name="l00935"></a>00935 <span class="comment"> * of data while maintaining a reasonable collision rate.  See:</span>
<a name="l00936"></a>00936 <span class="comment"> *</span>
<a name="l00937"></a>00937 <span class="comment"> *      http://www.isthe.com/chongo/tech/comp/fnv/index.html</span>
<a name="l00938"></a>00938 <span class="comment"> *</span>
<a name="l00939"></a>00939 <span class="comment"> * for more details as well as other forms of the FNV hash.</span>
<a name="l00940"></a>00940 <span class="comment"> ***</span>
<a name="l00941"></a>00941 <span class="comment"> *</span>
<a name="l00942"></a>00942 <span class="comment"> * To use the recommended 32 bit FNV-1a hash, pass FNV1_32A_INIT as the</span>
<a name="l00943"></a>00943 <span class="comment"> * Fnv32_t hashval argument to fnv_32a_buf() or fnv_32a_str().</span>
<a name="l00944"></a>00944 <span class="comment"> *</span>
<a name="l00945"></a>00945 <span class="comment"> ***</span>
<a name="l00946"></a>00946 <span class="comment"> *</span>
<a name="l00947"></a>00947 <span class="comment"> * Please do not copyright this code.  This code is in the public domain.</span>
<a name="l00948"></a>00948 <span class="comment"> *</span>
<a name="l00949"></a>00949 <span class="comment"> * LANDON CURT NOLL DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE,</span>
<a name="l00950"></a>00950 <span class="comment"> * INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO</span>
<a name="l00951"></a>00951 <span class="comment"> * EVENT SHALL LANDON CURT NOLL BE LIABLE FOR ANY SPECIAL, INDIRECT OR</span>
<a name="l00952"></a>00952 <span class="comment"> * CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF</span>
<a name="l00953"></a>00953 <span class="comment"> * USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR</span>
<a name="l00954"></a>00954 <span class="comment"> * OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR</span>
<a name="l00955"></a>00955 <span class="comment"> * PERFORMANCE OF THIS SOFTWARE.</span>
<a name="l00956"></a>00956 <span class="comment"> *</span>
<a name="l00957"></a>00957 <span class="comment"> * By:</span>
<a name="l00958"></a>00958 <span class="comment"> *      chongo &lt;Landon Curt Noll&gt; /\oo/\</span>
<a name="l00959"></a>00959 <span class="comment"> *      http://www.isthe.com/chongo/</span>
<a name="l00960"></a>00960 <span class="comment"> *</span>
<a name="l00961"></a>00961 <span class="comment"> * Share and Enjoy!     :-)</span>
<a name="l00962"></a>00962 <span class="comment"> */</span>
<a name="l00963"></a>00963 
<a name="l00964"></a>00964 <span class="comment">/*</span>
<a name="l00965"></a>00965 <span class="comment"> * 32 bit FNV-1 and FNV-1a non-zero initial basis</span>
<a name="l00966"></a>00966 <span class="comment"> *</span>
<a name="l00967"></a>00967 <span class="comment"> * The FNV-1 initial basis is the FNV-0 hash of the following 32 octets:</span>
<a name="l00968"></a>00968 <span class="comment"> *</span>
<a name="l00969"></a>00969 <span class="comment"> *              chongo &lt;Landon Curt Noll&gt; /\../\</span>
<a name="l00970"></a>00970 <span class="comment"> *</span>
<a name="l00971"></a>00971 <span class="comment"> * NOTE: The \&apos;s above are not back-slashing escape characters.</span>
<a name="l00972"></a>00972 <span class="comment"> * They are literal ASCII  backslash 0x5c characters.</span>
<a name="l00973"></a>00973 <span class="comment"> *</span>
<a name="l00974"></a>00974 <span class="comment"> * NOTE: The FNV-1a initial basis is the same value as FNV-1 by definition.</span>
<a name="l00975"></a>00975 <span class="comment"> */</span>
<a name="l00976"></a><a class="code" href="../../d4/d71/st_8c.html#a40a142ccb9ca21d50ea9f6ed8589cc96">00976</a> <span class="preprocessor">#define FNV1_32A_INIT 0x811c9dc5</span>
<a name="l00977"></a>00977 <span class="preprocessor"></span>
<a name="l00978"></a>00978 <span class="comment">/*</span>
<a name="l00979"></a>00979 <span class="comment"> * 32 bit magic FNV-1a prime</span>
<a name="l00980"></a>00980 <span class="comment"> */</span>
<a name="l00981"></a><a class="code" href="../../d4/d71/st_8c.html#ae13a6565bea334e9b6fb19033a392857">00981</a> <span class="preprocessor">#define FNV_32_PRIME 0x01000193</span>
<a name="l00982"></a>00982 <span class="preprocessor"></span>
<a name="l00983"></a>00983 <span class="preprocessor">#ifdef ST_USE_FNV1</span>
<a name="l00984"></a>00984 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>
<a name="l00985"></a>00985 <a class="code" href="../../d4/d71/st_8c.html#a167297ecc6a15b3e40576309d41e68d7">strhash</a>(<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> arg)
<a name="l00986"></a>00986 {
<a name="l00987"></a>00987     <span class="keyword">register</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">string</span> = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)arg;
<a name="l00988"></a>00988     <span class="keyword">register</span> <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> hval = <a class="code" href="../../d4/d71/st_8c.html#a40a142ccb9ca21d50ea9f6ed8589cc96">FNV1_32A_INIT</a>;
<a name="l00989"></a>00989 
<a name="l00990"></a>00990     <span class="comment">/*</span>
<a name="l00991"></a>00991 <span class="comment">     * FNV-1a hash each octet in the buffer</span>
<a name="l00992"></a>00992 <span class="comment">     */</span>
<a name="l00993"></a>00993     <span class="keywordflow">while</span> (*<span class="keywordtype">string</span>) {
<a name="l00994"></a>00994         <span class="comment">/* xor the bottom with the current octet */</span>
<a name="l00995"></a>00995         hval ^= (<span class="keywordtype">unsigned</span> int)*<span class="keywordtype">string</span>++;
<a name="l00996"></a>00996 
<a name="l00997"></a>00997         <span class="comment">/* multiply by the 32 bit FNV magic prime mod 2^32 */</span>
<a name="l00998"></a>00998         hval *= <a class="code" href="../../d4/d71/st_8c.html#ae13a6565bea334e9b6fb19033a392857">FNV_32_PRIME</a>;
<a name="l00999"></a>00999     }
<a name="l01000"></a>01000     <span class="keywordflow">return</span> hval;
<a name="l01001"></a>01001 }
<a name="l01002"></a>01002 <span class="preprocessor">#else</span>
<a name="l01003"></a>01003 <span class="preprocessor"></span>
<a name="l01004"></a>01004 <span class="preprocessor">#ifndef UNALIGNED_WORD_ACCESS</span>
<a name="l01005"></a>01005 <span class="preprocessor"></span><span class="preprocessor"># if defined(__i386) || defined(__i386__) || defined(_M_IX86) || \</span>
<a name="l01006"></a>01006 <span class="preprocessor">     defined(__x86_64) || defined(__x86_64__) || defined(_M_AMD86) || \</span>
<a name="l01007"></a>01007 <span class="preprocessor">     defined(__mc68020__)</span>
<a name="l01008"></a>01008 <span class="preprocessor"></span><span class="preprocessor">#   define UNALIGNED_WORD_ACCESS 1</span>
<a name="l01009"></a>01009 <span class="preprocessor"></span><span class="preprocessor"># endif</span>
<a name="l01010"></a>01010 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01011"></a>01011 <span class="preprocessor"></span><span class="preprocessor">#ifndef UNALIGNED_WORD_ACCESS</span>
<a name="l01012"></a>01012 <span class="preprocessor"></span><span class="preprocessor"># define UNALIGNED_WORD_ACCESS 0</span>
<a name="l01013"></a>01013 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01014"></a>01014 <span class="preprocessor"></span>
<a name="l01015"></a>01015 <span class="comment">/* MurmurHash described in http://murmurhash.googlepages.com/ */</span>
<a name="l01016"></a>01016 <span class="preprocessor">#ifndef MURMUR</span>
<a name="l01017"></a><a class="code" href="../../d4/d71/st_8c.html#aa92335ab2ca6139b94c65caee53d1627">01017</a> <span class="preprocessor"></span><span class="preprocessor">#define MURMUR 2</span>
<a name="l01018"></a>01018 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01019"></a>01019 <span class="preprocessor"></span>
<a name="l01020"></a><a class="code" href="../../d4/d71/st_8c.html#a923df315411e52498828f7cde38e5c87">01020</a> <span class="preprocessor">#define MurmurMagic_1 (st_index_t)0xc6a4a793</span>
<a name="l01021"></a><a class="code" href="../../d4/d71/st_8c.html#a99b9e759614d31ea6adc4b777aedd30e">01021</a> <span class="preprocessor"></span><span class="preprocessor">#define MurmurMagic_2 (st_index_t)0x5bd1e995</span>
<a name="l01022"></a>01022 <span class="preprocessor"></span><span class="preprocessor">#if MURMUR == 1</span>
<a name="l01023"></a>01023 <span class="preprocessor"></span><span class="preprocessor">#define MurmurMagic MurmurMagic_1</span>
<a name="l01024"></a>01024 <span class="preprocessor"></span><span class="preprocessor">#elif MURMUR == 2</span>
<a name="l01025"></a>01025 <span class="preprocessor"></span><span class="preprocessor">#if SIZEOF_ST_INDEX_T &gt; 4</span>
<a name="l01026"></a>01026 <span class="preprocessor"></span><span class="preprocessor">#define MurmurMagic ((MurmurMagic_1 &lt;&lt; 32) | MurmurMagic_2)</span>
<a name="l01027"></a>01027 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l01028"></a><a class="code" href="../../d4/d71/st_8c.html#a9bfe95f51203fde86c8dd3fe85d92bcd">01028</a> <span class="preprocessor"></span><span class="preprocessor">#define MurmurMagic MurmurMagic_2</span>
<a name="l01029"></a>01029 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01030"></a>01030 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01031"></a>01031 <span class="preprocessor"></span>
<a name="l01032"></a>01032 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>
<a name="l01033"></a><a class="code" href="../../d4/d71/st_8c.html#a6f8bc2a6eef7714715e56451ed32521c">01033</a> <a class="code" href="../../d4/d71/st_8c.html#a6f8bc2a6eef7714715e56451ed32521c">murmur</a>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> h, <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> k, <span class="keywordtype">int</span> r)
<a name="l01034"></a>01034 {
<a name="l01035"></a>01035     <span class="keyword">const</span> <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> m = <a class="code" href="../../d4/d71/st_8c.html#a9bfe95f51203fde86c8dd3fe85d92bcd">MurmurMagic</a>;
<a name="l01036"></a>01036 <span class="preprocessor">#if MURMUR == 1</span>
<a name="l01037"></a>01037 <span class="preprocessor"></span>    h += k;
<a name="l01038"></a>01038     h *= m;
<a name="l01039"></a>01039     h ^= h &gt;&gt; r;
<a name="l01040"></a>01040 <span class="preprocessor">#elif MURMUR == 2</span>
<a name="l01041"></a>01041 <span class="preprocessor"></span>    k *= m;
<a name="l01042"></a>01042     k ^= k &gt;&gt; r;
<a name="l01043"></a>01043     k *= m;
<a name="l01044"></a>01044 
<a name="l01045"></a>01045     h *= m;
<a name="l01046"></a>01046     h ^= k;
<a name="l01047"></a>01047 <span class="preprocessor">#endif</span>
<a name="l01048"></a>01048 <span class="preprocessor"></span>    <span class="keywordflow">return</span> h;
<a name="l01049"></a>01049 }
<a name="l01050"></a>01050 
<a name="l01051"></a>01051 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>
<a name="l01052"></a><a class="code" href="../../d4/d71/st_8c.html#a7319d13cc614204b9b40b6c022d5f911">01052</a> <a class="code" href="../../d4/d71/st_8c.html#a7319d13cc614204b9b40b6c022d5f911">murmur_finish</a>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> h)
<a name="l01053"></a>01053 {
<a name="l01054"></a>01054 <span class="preprocessor">#if MURMUR == 1</span>
<a name="l01055"></a>01055 <span class="preprocessor"></span>    h = <a class="code" href="../../d4/d71/st_8c.html#a6f8bc2a6eef7714715e56451ed32521c">murmur</a>(h, 0, 10);
<a name="l01056"></a>01056     h = <a class="code" href="../../d4/d71/st_8c.html#a6f8bc2a6eef7714715e56451ed32521c">murmur</a>(h, 0, 17);
<a name="l01057"></a>01057 <span class="preprocessor">#elif MURMUR == 2</span>
<a name="l01058"></a>01058 <span class="preprocessor"></span>    h ^= h &gt;&gt; 13;
<a name="l01059"></a>01059     h *= <a class="code" href="../../d4/d71/st_8c.html#a9bfe95f51203fde86c8dd3fe85d92bcd">MurmurMagic</a>;
<a name="l01060"></a>01060     h ^= h &gt;&gt; 15;
<a name="l01061"></a>01061 <span class="preprocessor">#endif</span>
<a name="l01062"></a>01062 <span class="preprocessor"></span>    <span class="keywordflow">return</span> h;
<a name="l01063"></a>01063 }
<a name="l01064"></a>01064 
<a name="l01065"></a><a class="code" href="../../d4/d71/st_8c.html#a42fee74992f1efd43ebdfb2d1c2c7538">01065</a> <span class="preprocessor">#define murmur_step(h, k) murmur((h), (k), 16)</span>
<a name="l01066"></a>01066 <span class="preprocessor"></span>
<a name="l01067"></a>01067 <span class="preprocessor">#if MURMUR == 1</span>
<a name="l01068"></a>01068 <span class="preprocessor"></span><span class="preprocessor">#define murmur1(h) murmur_step((h), 16)</span>
<a name="l01069"></a>01069 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l01070"></a><a class="code" href="../../d4/d71/st_8c.html#a08e80c200b25893c4c490666ce639528">01070</a> <span class="preprocessor"></span><span class="preprocessor">#define murmur1(h) murmur_step((h), 24)</span>
<a name="l01071"></a>01071 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01072"></a>01072 <span class="preprocessor"></span>
<a name="l01073"></a>01073 <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>
<a name="l01074"></a><a class="code" href="../../d4/d71/st_8c.html#a970b36e65b43e8fcccbea3e3397aeefa">01074</a> <a class="code" href="../../dd/d24/st_8h.html#a970b36e65b43e8fcccbea3e3397aeefa">st_hash</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> h)
<a name="l01075"></a>01075 {
<a name="l01076"></a>01076     <span class="keyword">const</span> <span class="keywordtype">char</span> *data = ptr;
<a name="l01077"></a>01077     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> t = 0;
<a name="l01078"></a>01078 
<a name="l01079"></a>01079     h += 0xdeadbeef;
<a name="l01080"></a>01080 
<a name="l01081"></a>01081 <span class="preprocessor">#define data_at(n) (st_index_t)((unsigned char)data[(n)])</span>
<a name="l01082"></a>01082 <span class="preprocessor"></span><span class="preprocessor">#define UNALIGNED_ADD_4 UNALIGNED_ADD(2); UNALIGNED_ADD(1); UNALIGNED_ADD(0)</span>
<a name="l01083"></a>01083 <span class="preprocessor"></span><span class="preprocessor">#if SIZEOF_ST_INDEX_T &gt; 4</span>
<a name="l01084"></a>01084 <span class="preprocessor"></span><span class="preprocessor">#define UNALIGNED_ADD_8 UNALIGNED_ADD(6); UNALIGNED_ADD(5); UNALIGNED_ADD(4); UNALIGNED_ADD(3); UNALIGNED_ADD_4</span>
<a name="l01085"></a>01085 <span class="preprocessor"></span><span class="preprocessor">#if SIZEOF_ST_INDEX_T &gt; 8</span>
<a name="l01086"></a>01086 <span class="preprocessor"></span><span class="preprocessor">#define UNALIGNED_ADD_16 UNALIGNED_ADD(14); UNALIGNED_ADD(13); UNALIGNED_ADD(12); UNALIGNED_ADD(11); \</span>
<a name="l01087"></a>01087 <span class="preprocessor">    UNALIGNED_ADD(10); UNALIGNED_ADD(9); UNALIGNED_ADD(8); UNALIGNED_ADD(7); UNALIGNED_ADD_8</span>
<a name="l01088"></a>01088 <span class="preprocessor"></span><span class="preprocessor">#define UNALIGNED_ADD_ALL UNALIGNED_ADD_16</span>
<a name="l01089"></a>01089 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01090"></a>01090 <span class="preprocessor"></span><span class="preprocessor">#define UNALIGNED_ADD_ALL UNALIGNED_ADD_8</span>
<a name="l01091"></a>01091 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l01092"></a>01092 <span class="preprocessor"></span><span class="preprocessor">#define UNALIGNED_ADD_ALL UNALIGNED_ADD_4</span>
<a name="l01093"></a>01093 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01094"></a>01094 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (len &gt;= <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>)) {
<a name="l01095"></a>01095 <span class="preprocessor">#if !UNALIGNED_WORD_ACCESS</span>
<a name="l01096"></a>01096 <span class="preprocessor"></span>        <span class="keywordtype">int</span> align = (int)((<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)data % <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>));
<a name="l01097"></a>01097         <span class="keywordflow">if</span> (align) {
<a name="l01098"></a>01098             <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> d = 0;
<a name="l01099"></a>01099             <span class="keywordtype">int</span> sl, sr, pack;
<a name="l01100"></a>01100 
<a name="l01101"></a>01101             <span class="keywordflow">switch</span> (align) {
<a name="l01102"></a>01102 <span class="preprocessor">#ifdef WORDS_BIGENDIAN</span>
<a name="l01103"></a>01103 <span class="preprocessor"></span><span class="preprocessor"># define UNALIGNED_ADD(n) case SIZEOF_ST_INDEX_T - (n) - 1: \</span>
<a name="l01104"></a>01104 <span class="preprocessor">                t |= data_at(n) &lt;&lt; CHAR_BIT*(SIZEOF_ST_INDEX_T - (n) - 2)</span>
<a name="l01105"></a>01105 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l01106"></a>01106 <span class="preprocessor"></span><span class="preprocessor"># define UNALIGNED_ADD(n) case SIZEOF_ST_INDEX_T - (n) - 1:     \</span>
<a name="l01107"></a>01107 <span class="preprocessor">                t |= data_at(n) &lt;&lt; CHAR_BIT*(n)</span>
<a name="l01108"></a>01108 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01109"></a>01109 <span class="preprocessor"></span>                <a class="code" href="../../d4/d71/st_8c.html#a58449b17c56fb078b9f006f8ab3c5314">UNALIGNED_ADD_ALL</a>;
<a name="l01110"></a>01110 <span class="preprocessor">#undef UNALIGNED_ADD</span>
<a name="l01111"></a>01111 <span class="preprocessor"></span>            }
<a name="l01112"></a>01112 
<a name="l01113"></a>01113 <span class="preprocessor">#ifdef WORDS_BIGENDIAN</span>
<a name="l01114"></a>01114 <span class="preprocessor"></span>            t &gt;&gt;= (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a308d9dd2c0028ddb184b455bbd7865de">CHAR_BIT</a> * align) - <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a308d9dd2c0028ddb184b455bbd7865de">CHAR_BIT</a>;
<a name="l01115"></a>01115 <span class="preprocessor">#else</span>
<a name="l01116"></a>01116 <span class="preprocessor"></span>            t &lt;&lt;= (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a308d9dd2c0028ddb184b455bbd7865de">CHAR_BIT</a> * align);
<a name="l01117"></a>01117 <span class="preprocessor">#endif</span>
<a name="l01118"></a>01118 <span class="preprocessor"></span>
<a name="l01119"></a>01119             data += <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>)-align;
<a name="l01120"></a>01120             len -= <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>)-align;
<a name="l01121"></a>01121 
<a name="l01122"></a>01122             sl = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a308d9dd2c0028ddb184b455bbd7865de">CHAR_BIT</a> * (<a class="code" href="../../dd/d24/st_8h.html#aa9a4938f87639b4d9a1c921f8ace1faa">SIZEOF_ST_INDEX_T</a>-align);
<a name="l01123"></a>01123             sr = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a308d9dd2c0028ddb184b455bbd7865de">CHAR_BIT</a> * align;
<a name="l01124"></a>01124 
<a name="l01125"></a>01125             <span class="keywordflow">while</span> (len &gt;= <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>)) {
<a name="l01126"></a>01126                 d = *(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> *)data;
<a name="l01127"></a>01127 <span class="preprocessor">#ifdef WORDS_BIGENDIAN</span>
<a name="l01128"></a>01128 <span class="preprocessor"></span>                t = (t &lt;&lt; sr) | (d &gt;&gt; sl);
<a name="l01129"></a>01129 <span class="preprocessor">#else</span>
<a name="l01130"></a>01130 <span class="preprocessor"></span>                t = (t &gt;&gt; sr) | (d &lt;&lt; sl);
<a name="l01131"></a>01131 <span class="preprocessor">#endif</span>
<a name="l01132"></a>01132 <span class="preprocessor"></span>                h = <a class="code" href="../../d4/d71/st_8c.html#a42fee74992f1efd43ebdfb2d1c2c7538">murmur_step</a>(h, t);
<a name="l01133"></a>01133                 t = d;
<a name="l01134"></a>01134                 data += <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>);
<a name="l01135"></a>01135                 len -= <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>);
<a name="l01136"></a>01136             }
<a name="l01137"></a>01137 
<a name="l01138"></a>01138             pack = len &lt; (size_t)align ? (<span class="keywordtype">int</span>)len : align;
<a name="l01139"></a>01139             d = 0;
<a name="l01140"></a>01140             <span class="keywordflow">switch</span> (pack) {
<a name="l01141"></a>01141 <span class="preprocessor">#ifdef WORDS_BIGENDIAN</span>
<a name="l01142"></a>01142 <span class="preprocessor"></span><span class="preprocessor"># define UNALIGNED_ADD(n) case (n) + 1: \</span>
<a name="l01143"></a>01143 <span class="preprocessor">                d |= data_at(n) &lt;&lt; CHAR_BIT*(SIZEOF_ST_INDEX_T - (n) - 1)</span>
<a name="l01144"></a>01144 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l01145"></a>01145 <span class="preprocessor"></span><span class="preprocessor"># define UNALIGNED_ADD(n) case (n) + 1: \</span>
<a name="l01146"></a>01146 <span class="preprocessor">                d |= data_at(n) &lt;&lt; CHAR_BIT*(n)</span>
<a name="l01147"></a>01147 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01148"></a>01148 <span class="preprocessor"></span>                <a class="code" href="../../d4/d71/st_8c.html#a58449b17c56fb078b9f006f8ab3c5314">UNALIGNED_ADD_ALL</a>;
<a name="l01149"></a>01149 <span class="preprocessor">#undef UNALIGNED_ADD</span>
<a name="l01150"></a>01150 <span class="preprocessor"></span>            }
<a name="l01151"></a>01151 <span class="preprocessor">#ifdef WORDS_BIGENDIAN</span>
<a name="l01152"></a>01152 <span class="preprocessor"></span>            t = (t &lt;&lt; sr) | (d &gt;&gt; sl);
<a name="l01153"></a>01153 <span class="preprocessor">#else</span>
<a name="l01154"></a>01154 <span class="preprocessor"></span>            t = (t &gt;&gt; sr) | (d &lt;&lt; sl);
<a name="l01155"></a>01155 <span class="preprocessor">#endif</span>
<a name="l01156"></a>01156 <span class="preprocessor"></span>
<a name="l01157"></a>01157 <span class="preprocessor">#if MURMUR == 2</span>
<a name="l01158"></a>01158 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (len &lt; (<span class="keywordtype">size_t</span>)align) <span class="keywordflow">goto</span> skip_tail;
<a name="l01159"></a>01159 <span class="preprocessor">#endif</span>
<a name="l01160"></a>01160 <span class="preprocessor"></span>            h = <a class="code" href="../../d4/d71/st_8c.html#a42fee74992f1efd43ebdfb2d1c2c7538">murmur_step</a>(h, t);
<a name="l01161"></a>01161             data += pack;
<a name="l01162"></a>01162             len -= pack;
<a name="l01163"></a>01163         }
<a name="l01164"></a>01164         <span class="keywordflow">else</span>
<a name="l01165"></a>01165 <span class="preprocessor">#endif</span>
<a name="l01166"></a>01166 <span class="preprocessor"></span>        {
<a name="l01167"></a>01167             <span class="keywordflow">do</span> {
<a name="l01168"></a>01168                 h = <a class="code" href="../../d4/d71/st_8c.html#a42fee74992f1efd43ebdfb2d1c2c7538">murmur_step</a>(h, *(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> *)data);
<a name="l01169"></a>01169                 data += <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>);
<a name="l01170"></a>01170                 len -= <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>);
<a name="l01171"></a>01171             } <span class="keywordflow">while</span> (len &gt;= <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>));
<a name="l01172"></a>01172         }
<a name="l01173"></a>01173     }
<a name="l01174"></a>01174 
<a name="l01175"></a>01175     t = 0;
<a name="l01176"></a>01176     <span class="keywordflow">switch</span> (len) {
<a name="l01177"></a>01177 <span class="preprocessor">#ifdef WORDS_BIGENDIAN</span>
<a name="l01178"></a>01178 <span class="preprocessor"></span><span class="preprocessor"># define UNALIGNED_ADD(n) case (n) + 1: \</span>
<a name="l01179"></a>01179 <span class="preprocessor">        t |= data_at(n) &lt;&lt; CHAR_BIT*(SIZEOF_ST_INDEX_T - (n) - 1)</span>
<a name="l01180"></a>01180 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l01181"></a>01181 <span class="preprocessor"></span><span class="preprocessor"># define UNALIGNED_ADD(n) case (n) + 1: \</span>
<a name="l01182"></a>01182 <span class="preprocessor">        t |= data_at(n) &lt;&lt; CHAR_BIT*(n)</span>
<a name="l01183"></a>01183 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01184"></a>01184 <span class="preprocessor"></span>        <a class="code" href="../../d4/d71/st_8c.html#a58449b17c56fb078b9f006f8ab3c5314">UNALIGNED_ADD_ALL</a>;
<a name="l01185"></a>01185 <span class="preprocessor">#undef UNALIGNED_ADD</span>
<a name="l01186"></a>01186 <span class="preprocessor"></span><span class="preprocessor">#if MURMUR == 1</span>
<a name="l01187"></a>01187 <span class="preprocessor"></span>        h = <a class="code" href="../../d4/d71/st_8c.html#a42fee74992f1efd43ebdfb2d1c2c7538">murmur_step</a>(h, t);
<a name="l01188"></a>01188 <span class="preprocessor">#elif MURMUR == 2</span>
<a name="l01189"></a>01189 <span class="preprocessor"></span><span class="preprocessor"># if !UNALIGNED_WORD_ACCESS</span>
<a name="l01190"></a>01190 <span class="preprocessor"></span>      skip_tail:
<a name="l01191"></a>01191 <span class="preprocessor"># endif</span>
<a name="l01192"></a>01192 <span class="preprocessor"></span>        h ^= t;
<a name="l01193"></a>01193         h *= <a class="code" href="../../d4/d71/st_8c.html#a9bfe95f51203fde86c8dd3fe85d92bcd">MurmurMagic</a>;
<a name="l01194"></a>01194 <span class="preprocessor">#endif</span>
<a name="l01195"></a>01195 <span class="preprocessor"></span>    }
<a name="l01196"></a>01196 
<a name="l01197"></a>01197     <span class="keywordflow">return</span> <a class="code" href="../../d4/d71/st_8c.html#a7319d13cc614204b9b40b6c022d5f911">murmur_finish</a>(h);
<a name="l01198"></a>01198 }
<a name="l01199"></a>01199 
<a name="l01200"></a>01200 <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>
<a name="l01201"></a><a class="code" href="../../d4/d71/st_8c.html#a3d78a46cfffcf594047cf492737d7406">01201</a> <a class="code" href="../../dd/d24/st_8h.html#a3d78a46cfffcf594047cf492737d7406">st_hash_uint32</a>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> h, <a class="code" href="../../db/d4d/sha2_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a> i)
<a name="l01202"></a>01202 {
<a name="l01203"></a>01203     <span class="keywordflow">return</span> <a class="code" href="../../d4/d71/st_8c.html#a42fee74992f1efd43ebdfb2d1c2c7538">murmur_step</a>(h + i, 16);
<a name="l01204"></a>01204 }
<a name="l01205"></a>01205 
<a name="l01206"></a>01206 <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>
<a name="l01207"></a><a class="code" href="../../d4/d71/st_8c.html#a72b493fcb3ac68760a725d058f1cb5d3">01207</a> <a class="code" href="../../dd/d24/st_8h.html#a72b493fcb3ac68760a725d058f1cb5d3">st_hash_uint</a>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> h, <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> i)
<a name="l01208"></a>01208 {
<a name="l01209"></a>01209     <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> v = 0;
<a name="l01210"></a>01210     h += i;
<a name="l01211"></a>01211 <span class="preprocessor">#ifdef WORDS_BIGENDIAN</span>
<a name="l01212"></a>01212 <span class="preprocessor"></span><span class="preprocessor">#if SIZEOF_ST_INDEX_T*CHAR_BIT &gt; 12*8</span>
<a name="l01213"></a>01213 <span class="preprocessor"></span>    v = <a class="code" href="../../d4/d71/st_8c.html#a08e80c200b25893c4c490666ce639528">murmur1</a>(v + (h &gt;&gt; 12*8));
<a name="l01214"></a>01214 <span class="preprocessor">#endif</span>
<a name="l01215"></a>01215 <span class="preprocessor"></span><span class="preprocessor">#if SIZEOF_ST_INDEX_T*CHAR_BIT &gt; 8*8</span>
<a name="l01216"></a>01216 <span class="preprocessor"></span>    v = <a class="code" href="../../d4/d71/st_8c.html#a08e80c200b25893c4c490666ce639528">murmur1</a>(v + (h &gt;&gt; 8*8));
<a name="l01217"></a>01217 <span class="preprocessor">#endif</span>
<a name="l01218"></a>01218 <span class="preprocessor"></span><span class="preprocessor">#if SIZEOF_ST_INDEX_T*CHAR_BIT &gt; 4*8</span>
<a name="l01219"></a>01219 <span class="preprocessor"></span>    v = <a class="code" href="../../d4/d71/st_8c.html#a08e80c200b25893c4c490666ce639528">murmur1</a>(v + (h &gt;&gt; 4*8));
<a name="l01220"></a>01220 <span class="preprocessor">#endif</span>
<a name="l01221"></a>01221 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01222"></a>01222 <span class="preprocessor"></span>    v = <a class="code" href="../../d4/d71/st_8c.html#a08e80c200b25893c4c490666ce639528">murmur1</a>(v + h);
<a name="l01223"></a>01223 <span class="preprocessor">#ifndef WORDS_BIGENDIAN</span>
<a name="l01224"></a>01224 <span class="preprocessor"></span><span class="preprocessor">#if SIZEOF_ST_INDEX_T*CHAR_BIT &gt; 4*8</span>
<a name="l01225"></a>01225 <span class="preprocessor"></span>    v = <a class="code" href="../../d4/d71/st_8c.html#a08e80c200b25893c4c490666ce639528">murmur1</a>(v + (h &gt;&gt; 4*8));
<a name="l01226"></a>01226 <span class="preprocessor">#endif</span>
<a name="l01227"></a>01227 <span class="preprocessor"></span><span class="preprocessor">#if SIZEOF_ST_INDEX_T*CHAR_BIT &gt; 8*8</span>
<a name="l01228"></a>01228 <span class="preprocessor"></span>    v = <a class="code" href="../../d4/d71/st_8c.html#a08e80c200b25893c4c490666ce639528">murmur1</a>(v + (h &gt;&gt; 8*8));
<a name="l01229"></a>01229 <span class="preprocessor">#endif</span>
<a name="l01230"></a>01230 <span class="preprocessor"></span><span class="preprocessor">#if SIZEOF_ST_INDEX_T*CHAR_BIT &gt; 12*8</span>
<a name="l01231"></a>01231 <span class="preprocessor"></span>    v = <a class="code" href="../../d4/d71/st_8c.html#a08e80c200b25893c4c490666ce639528">murmur1</a>(v + (h &gt;&gt; 12*8));
<a name="l01232"></a>01232 <span class="preprocessor">#endif</span>
<a name="l01233"></a>01233 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01234"></a>01234 <span class="preprocessor"></span>    <span class="keywordflow">return</span> v;
<a name="l01235"></a>01235 }
<a name="l01236"></a>01236 
<a name="l01237"></a>01237 <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>
<a name="l01238"></a><a class="code" href="../../d4/d71/st_8c.html#aee487969705d500b3308fc5c146fd357">01238</a> <a class="code" href="../../dd/d24/st_8h.html#aee487969705d500b3308fc5c146fd357">st_hash_end</a>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> h)
<a name="l01239"></a>01239 {
<a name="l01240"></a>01240     h = <a class="code" href="../../d4/d71/st_8c.html#a42fee74992f1efd43ebdfb2d1c2c7538">murmur_step</a>(h, 10);
<a name="l01241"></a>01241     h = <a class="code" href="../../d4/d71/st_8c.html#a42fee74992f1efd43ebdfb2d1c2c7538">murmur_step</a>(h, 17);
<a name="l01242"></a>01242     <span class="keywordflow">return</span> h;
<a name="l01243"></a>01243 }
<a name="l01244"></a>01244 
<a name="l01245"></a>01245 <span class="preprocessor">#undef st_hash_start</span>
<a name="l01246"></a>01246 <span class="preprocessor"></span><a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>
<a name="l01247"></a><a class="code" href="../../d4/d71/st_8c.html#abd6d8900985779079ec683ece31f6fd7">01247</a> <a class="code" href="../../dd/d24/st_8h.html#a1535c1b1e88190c7fe1a76e584bd9c59">st_hash_start</a>(<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> h)
<a name="l01248"></a>01248 {
<a name="l01249"></a>01249     <span class="keywordflow">return</span> h;
<a name="l01250"></a>01250 }
<a name="l01251"></a>01251 
<a name="l01252"></a>01252 <span class="keyword">static</span> <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>
<a name="l01253"></a><a class="code" href="../../d4/d71/st_8c.html#a167297ecc6a15b3e40576309d41e68d7">01253</a> <a class="code" href="../../d4/d71/st_8c.html#a167297ecc6a15b3e40576309d41e68d7">strhash</a>(<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> arg)
<a name="l01254"></a>01254 {
<a name="l01255"></a>01255     <span class="keyword">register</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">string</span> = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)arg;
<a name="l01256"></a>01256     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a970b36e65b43e8fcccbea3e3397aeefa">st_hash</a>(<span class="keywordtype">string</span>, <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(<span class="keywordtype">string</span>), <a class="code" href="../../d4/d71/st_8c.html#a40a142ccb9ca21d50ea9f6ed8589cc96">FNV1_32A_INIT</a>);
<a name="l01257"></a>01257 }
<a name="l01258"></a>01258 <span class="preprocessor">#endif</span>
<a name="l01259"></a>01259 <span class="preprocessor"></span>
<a name="l01260"></a>01260 <span class="keywordtype">int</span>
<a name="l01261"></a><a class="code" href="../../d4/d71/st_8c.html#aa34004564b66661c5c2f6d396e567e93">01261</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa34004564b66661c5c2f6d396e567e93">st_strcasecmp</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *s1, <span class="keyword">const</span> <span class="keywordtype">char</span> *s2)
<a name="l01262"></a>01262 {
<a name="l01263"></a>01263     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c1, c2;
<a name="l01264"></a>01264 
<a name="l01265"></a>01265     <span class="keywordflow">while</span> (1) {
<a name="l01266"></a>01266         c1 = (<span class="keywordtype">unsigned</span> char)*s1++;
<a name="l01267"></a>01267         c2 = (<span class="keywordtype">unsigned</span> char)*s2++;
<a name="l01268"></a>01268         <span class="keywordflow">if</span> (c1 == <span class="charliteral">&apos;\0&apos;</span> || c2 == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l01269"></a>01269             <span class="keywordflow">if</span> (c1 != <span class="charliteral">&apos;\0&apos;</span>) <span class="keywordflow">return</span> 1;
<a name="l01270"></a>01270             <span class="keywordflow">if</span> (c2 != <span class="charliteral">&apos;\0&apos;</span>) <span class="keywordflow">return</span> -1;
<a name="l01271"></a>01271             <span class="keywordflow">return</span> 0;
<a name="l01272"></a>01272         }
<a name="l01273"></a>01273         <span class="keywordflow">if</span> ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(c1 - <span class="charliteral">&apos;A&apos;</span>) &lt;= (<span class="charliteral">&apos;Z&apos;</span> - <span class="charliteral">&apos;A&apos;</span>)) c1 += <span class="charliteral">&apos;a&apos;</span> - <span class="charliteral">&apos;A&apos;</span>;
<a name="l01274"></a>01274         <span class="keywordflow">if</span> ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(c2 - <span class="charliteral">&apos;A&apos;</span>) &lt;= (<span class="charliteral">&apos;Z&apos;</span> - <span class="charliteral">&apos;A&apos;</span>)) c2 += <span class="charliteral">&apos;a&apos;</span> - <span class="charliteral">&apos;A&apos;</span>;
<a name="l01275"></a>01275         <span class="keywordflow">if</span> (c1 != c2) {
<a name="l01276"></a>01276             <span class="keywordflow">if</span> (c1 &gt; c2)
<a name="l01277"></a>01277                 <span class="keywordflow">return</span> 1;
<a name="l01278"></a>01278             <span class="keywordflow">else</span>
<a name="l01279"></a>01279                 <span class="keywordflow">return</span> -1;
<a name="l01280"></a>01280         }
<a name="l01281"></a>01281     }
<a name="l01282"></a>01282 }
<a name="l01283"></a>01283 
<a name="l01284"></a>01284 <span class="keywordtype">int</span>
<a name="l01285"></a><a class="code" href="../../d4/d71/st_8c.html#ae5d944df8ef1621b6ff43bfcaecb7d46">01285</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae5d944df8ef1621b6ff43bfcaecb7d46">st_strncasecmp</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *s1, <span class="keyword">const</span> <span class="keywordtype">char</span> *s2, <span class="keywordtype">size_t</span> n)
<a name="l01286"></a>01286 {
<a name="l01287"></a>01287     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c1, c2;
<a name="l01288"></a>01288 
<a name="l01289"></a>01289     <span class="keywordflow">while</span> (n--) {
<a name="l01290"></a>01290         c1 = (<span class="keywordtype">unsigned</span> char)*s1++;
<a name="l01291"></a>01291         c2 = (<span class="keywordtype">unsigned</span> char)*s2++;
<a name="l01292"></a>01292         <span class="keywordflow">if</span> (c1 == <span class="charliteral">&apos;\0&apos;</span> || c2 == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l01293"></a>01293             <span class="keywordflow">if</span> (c1 != <span class="charliteral">&apos;\0&apos;</span>) <span class="keywordflow">return</span> 1;
<a name="l01294"></a>01294             <span class="keywordflow">if</span> (c2 != <span class="charliteral">&apos;\0&apos;</span>) <span class="keywordflow">return</span> -1;
<a name="l01295"></a>01295             <span class="keywordflow">return</span> 0;
<a name="l01296"></a>01296         }
<a name="l01297"></a>01297         <span class="keywordflow">if</span> ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(c1 - <span class="charliteral">&apos;A&apos;</span>) &lt;= (<span class="charliteral">&apos;Z&apos;</span> - <span class="charliteral">&apos;A&apos;</span>)) c1 += <span class="charliteral">&apos;a&apos;</span> - <span class="charliteral">&apos;A&apos;</span>;
<a name="l01298"></a>01298         <span class="keywordflow">if</span> ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(c2 - <span class="charliteral">&apos;A&apos;</span>) &lt;= (<span class="charliteral">&apos;Z&apos;</span> - <span class="charliteral">&apos;A&apos;</span>)) c2 += <span class="charliteral">&apos;a&apos;</span> - <span class="charliteral">&apos;A&apos;</span>;
<a name="l01299"></a>01299         <span class="keywordflow">if</span> (c1 != c2) {
<a name="l01300"></a>01300             <span class="keywordflow">if</span> (c1 &gt; c2)
<a name="l01301"></a>01301                 <span class="keywordflow">return</span> 1;
<a name="l01302"></a>01302             <span class="keywordflow">else</span>
<a name="l01303"></a>01303                 <span class="keywordflow">return</span> -1;
<a name="l01304"></a>01304         }
<a name="l01305"></a>01305     }
<a name="l01306"></a>01306     <span class="keywordflow">return</span> 0;
<a name="l01307"></a>01307 }
<a name="l01308"></a>01308 
<a name="l01309"></a>01309 <span class="keyword">static</span> <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>
<a name="l01310"></a><a class="code" href="../../d4/d71/st_8c.html#a1a0a643d881cfc8e9def03ff92d49b48">01310</a> <a class="code" href="../../d4/d71/st_8c.html#a1a0a643d881cfc8e9def03ff92d49b48">strcasehash</a>(<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> arg)
<a name="l01311"></a>01311 {
<a name="l01312"></a>01312     <span class="keyword">register</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">string</span> = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)arg;
<a name="l01313"></a>01313     <span class="keyword">register</span> <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a> hval = <a class="code" href="../../d4/d71/st_8c.html#a40a142ccb9ca21d50ea9f6ed8589cc96">FNV1_32A_INIT</a>;
<a name="l01314"></a>01314 
<a name="l01315"></a>01315     <span class="comment">/*</span>
<a name="l01316"></a>01316 <span class="comment">     * FNV-1a hash each octet in the buffer</span>
<a name="l01317"></a>01317 <span class="comment">     */</span>
<a name="l01318"></a>01318     <span class="keywordflow">while</span> (*<span class="keywordtype">string</span>) {
<a name="l01319"></a>01319         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c = (<span class="keywordtype">unsigned</span> char)*<span class="keywordtype">string</span>++;
<a name="l01320"></a>01320         <span class="keywordflow">if</span> ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(c - <span class="charliteral">&apos;A&apos;</span>) &lt;= (<span class="charliteral">&apos;Z&apos;</span> - <span class="charliteral">&apos;A&apos;</span>)) c += <span class="charliteral">&apos;a&apos;</span> - <span class="charliteral">&apos;A&apos;</span>;
<a name="l01321"></a>01321         hval ^= c;
<a name="l01322"></a>01322 
<a name="l01323"></a>01323         <span class="comment">/* multiply by the 32 bit FNV magic prime mod 2^32 */</span>
<a name="l01324"></a>01324         hval *= <a class="code" href="../../d4/d71/st_8c.html#ae13a6565bea334e9b6fb19033a392857">FNV_32_PRIME</a>;
<a name="l01325"></a>01325     }
<a name="l01326"></a>01326     <span class="keywordflow">return</span> hval;
<a name="l01327"></a>01327 }
<a name="l01328"></a>01328 
<a name="l01329"></a>01329 <span class="keywordtype">int</span>
<a name="l01330"></a><a class="code" href="../../d4/d71/st_8c.html#a4c9a444f4aabb6c83a19c5afacbfdaf6">01330</a> <a class="code" href="../../dd/d24/st_8h.html#a2839ae91d54936af83392d0df9f97488">st_numcmp</a>(<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> x, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> y)
<a name="l01331"></a>01331 {
<a name="l01332"></a>01332     <span class="keywordflow">return</span> x != y;
<a name="l01333"></a>01333 }
<a name="l01334"></a>01334 
<a name="l01335"></a>01335 <a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>
<a name="l01336"></a><a class="code" href="../../d4/d71/st_8c.html#a012fbc7aee9522e01fa622dd6aafbaee">01336</a> <a class="code" href="../../dd/d24/st_8h.html#a50249b52a70e7a4aa8ca8582c380cd26">st_numhash</a>(<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> n)
<a name="l01337"></a>01337 {
<a name="l01338"></a>01338     <span class="keywordflow">return</span> (<a class="code" href="../../dd/d24/st_8h.html#ac214e5cdcf0de6a2108b9643e7fc12e0">st_index_t</a>)n;
<a name="l01339"></a>01339 }
<a name="l01340"></a>01340 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Mar 2013 for Ruby by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
