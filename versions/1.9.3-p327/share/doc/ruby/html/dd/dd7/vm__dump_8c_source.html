<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Ruby: vm_dump.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>vm_dump.c</h1><a href="../../dd/dd7/vm__dump_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/**********************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  vm_dump.c -</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">  $Author: naruse $</span>
<a name="l00006"></a>00006 <span class="comment"></span>
<a name="l00007"></a>00007 <span class="comment">  Copyright (C) 2004-2007 Koichi Sasada</span>
<a name="l00008"></a>00008 <span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment">**********************************************************************/</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="../../de/de6/ruby_2ruby_8h.html">ruby/ruby.h</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="../../d6/df3/addr2line_8h.html">addr2line.h</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d32/vm__core_8h.html">vm_core.h</a>&quot;</span>
<a name="l00015"></a>00015 
<a name="l00016"></a><a class="code" href="../../dd/dd7/vm__dump_8c.html#a8537bba92a6b0ad9700c765c83969b57">00016</a> <span class="preprocessor">#define MAX_POSBUF 128</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span>
<a name="l00018"></a><a class="code" href="../../dd/dd7/vm__dump_8c.html#acd3a62eaa8bfb2c0c2a59c2afa1179bb">00018</a> <span class="preprocessor">#define VM_CFP_CNT(th, cfp) \</span>
<a name="l00019"></a>00019 <span class="preprocessor">  ((rb_control_frame_t *)((th)-&gt;stack + (th)-&gt;stack_size) - (rb_control_frame_t *)(cfp))</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span>
<a name="l00021"></a>00021 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00022"></a><a class="code" href="../../dd/dd7/vm__dump_8c.html#ac8e45243b47b9a4d73d977c62c3e6975">00022</a> <a class="code" href="../../dd/dd7/vm__dump_8c.html#ac8e45243b47b9a4d73d977c62c3e6975">control_frame_dump</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp)
<a name="l00023"></a>00023 {
<a name="l00024"></a>00024     ptrdiff_t pc = -1, <a class="code" href="../../db/d16/debug_8h.html#a1baecad7f27ccf1689612054ecf6a397">bp</a> = -1;
<a name="l00025"></a>00025     ptrdiff_t lfp = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a> - th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a>;
<a name="l00026"></a>00026     ptrdiff_t dfp = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a> - th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a>;
<a name="l00027"></a>00027     <span class="keywordtype">char</span> lfp_in_heap = <span class="charliteral">&apos; &apos;</span>, dfp_in_heap = <span class="charliteral">&apos; &apos;</span>;
<a name="l00028"></a>00028     <span class="keywordtype">char</span> posbuf[<a class="code" href="../../dd/dd7/vm__dump_8c.html#a8537bba92a6b0ad9700c765c83969b57">MAX_POSBUF</a>+1];
<a name="l00029"></a>00029     <span class="keywordtype">int</span> line = 0;
<a name="l00030"></a>00030     <span class="keywordtype">int</span> nopos = 0;
<a name="l00031"></a>00031 
<a name="l00032"></a>00032     <span class="keyword">const</span> <span class="keywordtype">char</span> *magic, *iseq_name = <span class="stringliteral">&quot;-&quot;</span>, *selfstr = <span class="stringliteral">&quot;-&quot;</span>, *biseq_name = <span class="stringliteral">&quot;-&quot;</span>;
<a name="l00033"></a>00033     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> tmp;
<a name="l00034"></a>00034 
<a name="l00035"></a>00035     <span class="keywordflow">if</span> (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a2b5202626f8eab242cb282e928a19420">block_iseq</a> != 0 &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a2b5202626f8eab242cb282e928a19420">block_iseq</a>) != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5f1cc49c4da51d5bdffa64be79ff6fb0">T_NODE</a>) {
<a name="l00036"></a>00036         biseq_name = <span class="stringliteral">&quot;&quot;</span>;        <span class="comment">/* RSTRING(cfp-&gt;block_iseq-&gt;name)-&gt;ptr; */</span>
<a name="l00037"></a>00037     }
<a name="l00038"></a>00038 
<a name="l00039"></a>00039     <span class="keywordflow">if</span> (lfp &lt; 0 || (<span class="keywordtype">size_t</span>)lfp &gt; th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1587dec1a575fb9f8d6a689ef4fdb6b5">stack_size</a>) {
<a name="l00040"></a>00040         lfp = (ptrdiff_t)cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a>;
<a name="l00041"></a>00041         lfp_in_heap = <span class="charliteral">&apos;p&apos;</span>;
<a name="l00042"></a>00042     }
<a name="l00043"></a>00043     <span class="keywordflow">if</span> (dfp &lt; 0 || (<span class="keywordtype">size_t</span>)dfp &gt; th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1587dec1a575fb9f8d6a689ef4fdb6b5">stack_size</a>) {
<a name="l00044"></a>00044         dfp = (ptrdiff_t)cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a>;
<a name="l00045"></a>00045         dfp_in_heap = <span class="charliteral">&apos;p&apos;</span>;
<a name="l00046"></a>00046     }
<a name="l00047"></a>00047     <span class="keywordflow">if</span> (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a8e19fd7af779b623f1e9477f271358e6">bp</a>) {
<a name="l00048"></a>00048         <a class="code" href="../../db/d16/debug_8h.html#a1baecad7f27ccf1689612054ecf6a397">bp</a> = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a8e19fd7af779b623f1e9477f271358e6">bp</a> - th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a>;
<a name="l00049"></a>00049     }
<a name="l00050"></a>00050 
<a name="l00051"></a>00051     <span class="keywordflow">switch</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(cfp)) {
<a name="l00052"></a>00052       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#ac9390ef02c17a0bc7e3bd359264562c7">VM_FRAME_MAGIC_TOP</a>:
<a name="l00053"></a>00053         magic = <span class="stringliteral">&quot;TOP&quot;</span>;
<a name="l00054"></a>00054         <span class="keywordflow">break</span>;
<a name="l00055"></a>00055       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#abc8be29d36c6252fce6bc61621f81b71">VM_FRAME_MAGIC_METHOD</a>:
<a name="l00056"></a>00056         magic = <span class="stringliteral">&quot;METHOD&quot;</span>;
<a name="l00057"></a>00057         <span class="keywordflow">break</span>;
<a name="l00058"></a>00058       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#a2524f590c07fceb689b2b7d53114ff5f">VM_FRAME_MAGIC_CLASS</a>:
<a name="l00059"></a>00059         magic = <span class="stringliteral">&quot;CLASS&quot;</span>;
<a name="l00060"></a>00060         <span class="keywordflow">break</span>;
<a name="l00061"></a>00061       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#a83eeedff3dde6d2d1ffce5d84c2ba2f1">VM_FRAME_MAGIC_BLOCK</a>:
<a name="l00062"></a>00062         magic = <span class="stringliteral">&quot;BLOCK&quot;</span>;
<a name="l00063"></a>00063         <span class="keywordflow">break</span>;
<a name="l00064"></a>00064       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#a885c6468caef6c3de80b0ad6c50ae38d">VM_FRAME_MAGIC_FINISH</a>:
<a name="l00065"></a>00065         magic = <span class="stringliteral">&quot;FINISH&quot;</span>;
<a name="l00066"></a>00066         nopos = 1;
<a name="l00067"></a>00067         <span class="keywordflow">break</span>;
<a name="l00068"></a>00068       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#a26308f33317bb5b96ff89924822e8eab">VM_FRAME_MAGIC_CFUNC</a>:
<a name="l00069"></a>00069         magic = <span class="stringliteral">&quot;CFUNC&quot;</span>;
<a name="l00070"></a>00070         <span class="keywordflow">break</span>;
<a name="l00071"></a>00071       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#ac1f5b7efa57bccbeb4ff5e7ae6ff18c2">VM_FRAME_MAGIC_PROC</a>:
<a name="l00072"></a>00072         magic = <span class="stringliteral">&quot;PROC&quot;</span>;
<a name="l00073"></a>00073         <span class="keywordflow">break</span>;
<a name="l00074"></a>00074       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#a57840803108748406429fb1cb3b10530">VM_FRAME_MAGIC_LAMBDA</a>:
<a name="l00075"></a>00075         magic = <span class="stringliteral">&quot;LAMBDA&quot;</span>;
<a name="l00076"></a>00076         <span class="keywordflow">break</span>;
<a name="l00077"></a>00077       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#a795522d157a66fe8f0cdd335b28099c9">VM_FRAME_MAGIC_IFUNC</a>:
<a name="l00078"></a>00078         magic = <span class="stringliteral">&quot;IFUNC&quot;</span>;
<a name="l00079"></a>00079         <span class="keywordflow">break</span>;
<a name="l00080"></a>00080       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#ac7b8d797cce488d08572c273f49f28fe">VM_FRAME_MAGIC_EVAL</a>:
<a name="l00081"></a>00081         magic = <span class="stringliteral">&quot;EVAL&quot;</span>;
<a name="l00082"></a>00082         <span class="keywordflow">break</span>;
<a name="l00083"></a>00083       <span class="keywordflow">case</span> 0:
<a name="l00084"></a>00084         magic = <span class="stringliteral">&quot;------&quot;</span>;
<a name="l00085"></a>00085         <span class="keywordflow">break</span>;
<a name="l00086"></a>00086       <span class="keywordflow">default</span>:
<a name="l00087"></a>00087         magic = <span class="stringliteral">&quot;(none)&quot;</span>;
<a name="l00088"></a>00088         <span class="keywordflow">break</span>;
<a name="l00089"></a>00089     }
<a name="l00090"></a>00090 
<a name="l00091"></a>00091     <span class="keywordflow">if</span> (0) {
<a name="l00092"></a>00092         tmp = <a class="code" href="../../db/d2e/intern_8h.html#acbb281bacf6b80f460143348e26142e9">rb_inspect</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4c11a50358317e1207affd6d7b4ad576">self</a>);
<a name="l00093"></a>00093         selfstr = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(tmp);
<a name="l00094"></a>00094     }
<a name="l00095"></a>00095     <span class="keywordflow">else</span> {
<a name="l00096"></a>00096         selfstr = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00097"></a>00097     }
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     <span class="keywordflow">if</span> (nopos) {
<a name="l00100"></a>00100         <span class="comment">/* no name */</span>
<a name="l00101"></a>00101     }
<a name="l00102"></a>00102     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a> != 0) {
<a name="l00103"></a>00103         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#aa933aeb7a703c7cc2d136492acbbef22">RUBY_VM_IFUNC_P</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>)) {
<a name="l00104"></a>00104             iseq_name = <span class="stringliteral">&quot;&lt;ifunc&gt;&quot;</span>;
<a name="l00105"></a>00105         }
<a name="l00106"></a>00106         <span class="keywordflow">else</span> {
<a name="l00107"></a>00107             pc = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a28b0b301811a891225ba9a58c412482d">pc</a> - cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aa70f3e195a4350acbbc130f8a95c9958">iseq_encoded</a>;
<a name="l00108"></a>00108             iseq_name = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a35596da255ce28a5d1da94c2cc508c7d">name</a>);
<a name="l00109"></a>00109             line = <a class="code" href="../../de/de9/vm_8c.html#a70289cbb34babceed6243d9471e70e5f">rb_vm_get_sourceline</a>(cfp);
<a name="l00110"></a>00110             <span class="keywordflow">if</span> (line) {
<a name="l00111"></a>00111                 <a class="code" href="../../d7/d72/subst_8h.html#aa367b75c5aed883fef5befbdf04835a4">snprintf</a>(posbuf, <a class="code" href="../../dd/dd7/vm__dump_8c.html#a8537bba92a6b0ad9700c765c83969b57">MAX_POSBUF</a>, <span class="stringliteral">&quot;%s:%d&quot;</span>, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a06859fa5de56f2ede3cb692f1d9215e2">filename</a>), line);
<a name="l00112"></a>00112             }
<a name="l00113"></a>00113         }
<a name="l00114"></a>00114     }
<a name="l00115"></a>00115     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aa0ec76f80ebaf0668b688c4e4e5e3e3f">me</a>) {
<a name="l00116"></a>00116         iseq_name = <a class="code" href="../../d5/d11/ripper_8c.html#a877bc58c495643fcf49dc64c44631e72">rb_id2name</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aa0ec76f80ebaf0668b688c4e4e5e3e3f">me</a>-&gt;<a class="code" href="../../d7/db7/structrb__method__entry__struct.html#a6c868c50e67b757c6324dfef0f3184dc">def</a>-&gt;<a class="code" href="../../d6/dab/structrb__method__definition__struct.html#a7fc0edb8505a61f8ae8bf2544fa7f676">original_id</a>);
<a name="l00117"></a>00117         <a class="code" href="../../d7/d72/subst_8h.html#aa367b75c5aed883fef5befbdf04835a4">snprintf</a>(posbuf, <a class="code" href="../../dd/dd7/vm__dump_8c.html#a8537bba92a6b0ad9700c765c83969b57">MAX_POSBUF</a>, <span class="stringliteral">&quot;:%s&quot;</span>, iseq_name);
<a name="l00118"></a>00118         line = -1;
<a name="l00119"></a>00119     }
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     fprintf(stderr, <span class="stringliteral">&quot;c:%04&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca444ec27cdd86e8456e34dfc4aed830">PRIdPTRDIFF</a><span class="stringliteral">&quot; &quot;</span>,
<a name="l00122"></a>00122             ((<a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *)(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a> + th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1587dec1a575fb9f8d6a689ef4fdb6b5">stack_size</a>) - cfp));
<a name="l00123"></a>00123     <span class="keywordflow">if</span> (pc == -1) {
<a name="l00124"></a>00124         fprintf(stderr, <span class="stringliteral">&quot;p:---- &quot;</span>);
<a name="l00125"></a>00125     }
<a name="l00126"></a>00126     <span class="keywordflow">else</span> {
<a name="l00127"></a>00127         fprintf(stderr, <span class="stringliteral">&quot;p:%04&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca444ec27cdd86e8456e34dfc4aed830">PRIdPTRDIFF</a><span class="stringliteral">&quot; &quot;</span>, pc);
<a name="l00128"></a>00128     }
<a name="l00129"></a>00129     fprintf(stderr, <span class="stringliteral">&quot;s:%04&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca444ec27cdd86e8456e34dfc4aed830">PRIdPTRDIFF</a><span class="stringliteral">&quot; b:%04&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca444ec27cdd86e8456e34dfc4aed830">PRIdPTRDIFF</a><span class="stringliteral">&quot; &quot;</span>, (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a> - th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a>), <a class="code" href="../../db/d16/debug_8h.html#a1baecad7f27ccf1689612054ecf6a397">bp</a>);
<a name="l00130"></a>00130     fprintf(stderr, lfp_in_heap == <span class="charliteral">&apos; &apos;</span> ? <span class="stringliteral">&quot;l:%06&quot;</span>PRIdPTRDIFF<span class="stringliteral">&quot; &quot;</span> : <span class="stringliteral">&quot;l:%06&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae6db36a50ae612535a9aac7ad0ec5a0d">PRIxPTRDIFF</a><span class="stringliteral">&quot; &quot;</span>, lfp % 10000);
<a name="l00131"></a>00131     fprintf(stderr, dfp_in_heap == <span class="charliteral">&apos; &apos;</span> ? <span class="stringliteral">&quot;d:%06&quot;</span>PRIdPTRDIFF<span class="stringliteral">&quot; &quot;</span> : <span class="stringliteral">&quot;d:%06&quot;</span>PRIxPTRDIFF<span class="stringliteral">&quot; &quot;</span>, dfp % 10000);
<a name="l00132"></a>00132     fprintf(stderr, <span class="stringliteral">&quot;%-6s&quot;</span>, magic);
<a name="l00133"></a>00133     <span class="keywordflow">if</span> (line &amp;&amp; !nopos) {
<a name="l00134"></a>00134         fprintf(stderr, <span class="stringliteral">&quot; %s&quot;</span>, posbuf);
<a name="l00135"></a>00135     }
<a name="l00136"></a>00136     <span class="keywordflow">if</span> (0) {
<a name="l00137"></a>00137         fprintf(stderr, <span class="stringliteral">&quot;              \t&quot;</span>);
<a name="l00138"></a>00138         fprintf(stderr, <span class="stringliteral">&quot;iseq: %-24s &quot;</span>, iseq_name);
<a name="l00139"></a>00139         fprintf(stderr, <span class="stringliteral">&quot;self: %-24s &quot;</span>, selfstr);
<a name="l00140"></a>00140         fprintf(stderr, <span class="stringliteral">&quot;%-1s &quot;</span>, biseq_name);
<a name="l00141"></a>00141     }
<a name="l00142"></a>00142     fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00143"></a>00143 }
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 <span class="keywordtype">void</span>
<a name="l00146"></a><a class="code" href="../../dd/dd7/vm__dump_8c.html#a1dbfe98ae709e8806918bdd3121bf986">00146</a> <a class="code" href="../../d8/d32/vm__core_8h.html#aa68a3152178b05ba670cf15f88201c60">rb_vmdebug_stack_dump_raw</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp)
<a name="l00147"></a>00147 {
<a name="l00148"></a>00148 <span class="preprocessor">#if 0</span>
<a name="l00149"></a>00149 <span class="preprocessor"></span>    <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *sp = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a>, *<a class="code" href="../../db/d16/debug_8h.html#a1baecad7f27ccf1689612054ecf6a397">bp</a> = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a8e19fd7af779b623f1e9477f271358e6">bp</a>;
<a name="l00150"></a>00150     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *lfp = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a>;
<a name="l00151"></a>00151     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *dfp = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a>;
<a name="l00152"></a>00152     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *p, *st, *t;
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     fprintf(stderr, <span class="stringliteral">&quot;-- stack frame ------------\n&quot;</span>);
<a name="l00155"></a>00155     <span class="keywordflow">for</span> (p = st = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a>; p &lt; sp; p++) {
<a name="l00156"></a>00156         fprintf(stderr, <span class="stringliteral">&quot;%04ld (%p): %08&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa1bf33f94a5de592de48c16fcfe86db2">PRIxVALUE</a>, (<span class="keywordtype">long</span>)(p - st), p, *p);
<a name="l00157"></a>00157 
<a name="l00158"></a>00158         t = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *)*p;
<a name="l00159"></a>00159         <span class="keywordflow">if</span> (th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a> &lt;= t &amp;&amp; t &lt; sp) {
<a name="l00160"></a>00160             fprintf(stderr, <span class="stringliteral">&quot; (= %ld)&quot;</span>, (<span class="keywordtype">long</span>)((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *)<a class="code" href="../../d8/d32/vm__core_8h.html#a373f1cafd944ff9e99986582d0fd695b">GC_GUARDED_PTR_REF</a>(t) - th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a>));
<a name="l00161"></a>00161         }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163         <span class="keywordflow">if</span> (p == lfp)
<a name="l00164"></a>00164             fprintf(stderr, <span class="stringliteral">&quot; &lt;- lfp&quot;</span>);
<a name="l00165"></a>00165         <span class="keywordflow">if</span> (p == dfp)
<a name="l00166"></a>00166             fprintf(stderr, <span class="stringliteral">&quot; &lt;- dfp&quot;</span>);
<a name="l00167"></a>00167         <span class="keywordflow">if</span> (p == <a class="code" href="../../db/d16/debug_8h.html#a1baecad7f27ccf1689612054ecf6a397">bp</a>)
<a name="l00168"></a>00168             fprintf(stderr, <span class="stringliteral">&quot; &lt;- bp&quot;</span>);  <span class="comment">/* should not be */</span>
<a name="l00169"></a>00169 
<a name="l00170"></a>00170         fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00171"></a>00171     }
<a name="l00172"></a>00172 <span class="preprocessor">#endif</span>
<a name="l00173"></a>00173 <span class="preprocessor"></span>
<a name="l00174"></a>00174     fprintf(stderr, <span class="stringliteral">&quot;-- Control frame information &quot;</span>
<a name="l00175"></a>00175             <span class="stringliteral">&quot;-----------------------------------------------\n&quot;</span>);
<a name="l00176"></a>00176     <span class="keywordflow">while</span> ((<span class="keywordtype">void</span> *)cfp &lt; (<span class="keywordtype">void</span> *)(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a> + th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1587dec1a575fb9f8d6a689ef4fdb6b5">stack_size</a>)) {
<a name="l00177"></a>00177         <a class="code" href="../../dd/dd7/vm__dump_8c.html#ac8e45243b47b9a4d73d977c62c3e6975">control_frame_dump</a>(th, cfp);
<a name="l00178"></a>00178         cfp++;
<a name="l00179"></a>00179     }
<a name="l00180"></a>00180     fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00181"></a>00181 }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183 <span class="keywordtype">void</span>
<a name="l00184"></a><a class="code" href="../../dd/dd7/vm__dump_8c.html#a130d5c43a9da83c86a471cb88c28f080">00184</a> <a class="code" href="../../dd/dd7/vm__dump_8c.html#a130d5c43a9da83c86a471cb88c28f080">rb_vmdebug_stack_dump_raw_current</a>(<span class="keywordtype">void</span>)
<a name="l00185"></a>00185 {
<a name="l00186"></a>00186     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l00187"></a>00187     <a class="code" href="../../d8/d32/vm__core_8h.html#aa68a3152178b05ba670cf15f88201c60">rb_vmdebug_stack_dump_raw</a>(th, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>);
<a name="l00188"></a>00188 }
<a name="l00189"></a>00189 
<a name="l00190"></a>00190 <span class="keywordtype">void</span>
<a name="l00191"></a><a class="code" href="../../dd/dd7/vm__dump_8c.html#a00c5c84d7769a956e3651998e92ae823">00191</a> <a class="code" href="../../dd/dd7/vm__dump_8c.html#a00c5c84d7769a956e3651998e92ae823">rb_vmdebug_env_dump_raw</a>(<a class="code" href="../../d0/d73/structrb__env__t.html">rb_env_t</a> *env, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *lfp, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *dfp)
<a name="l00192"></a>00192 {
<a name="l00193"></a>00193     <span class="keywordtype">int</span> i;
<a name="l00194"></a>00194     fprintf(stderr, <span class="stringliteral">&quot;-- env --------------------\n&quot;</span>);
<a name="l00195"></a>00195 
<a name="l00196"></a>00196     <span class="keywordflow">while</span> (env) {
<a name="l00197"></a>00197         fprintf(stderr, <span class="stringliteral">&quot;--\n&quot;</span>);
<a name="l00198"></a>00198         <span class="keywordflow">for</span> (i = 0; i &lt; env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a2a6f73bb292a79e0beed588fa6fabe6a">env_size</a>; i++) {
<a name="l00199"></a>00199             fprintf(stderr, <span class="stringliteral">&quot;%04d: %08&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa1bf33f94a5de592de48c16fcfe86db2">PRIxVALUE</a><span class="stringliteral">&quot; (%p)&quot;</span>, -env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5babbdd0740bbdc371ae7d2f225e8b64">local_size</a> + i, env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a1c42d4847422b6ffd0fb340fdd0cfa8b">env</a>[i],
<a name="l00200"></a>00200                    (<span class="keywordtype">void</span> *)&amp;env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a1c42d4847422b6ffd0fb340fdd0cfa8b">env</a>[i]);
<a name="l00201"></a>00201             <span class="keywordflow">if</span> (&amp;env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a1c42d4847422b6ffd0fb340fdd0cfa8b">env</a>[i] == lfp)
<a name="l00202"></a>00202                 fprintf(stderr, <span class="stringliteral">&quot; &lt;- lfp&quot;</span>);
<a name="l00203"></a>00203             <span class="keywordflow">if</span> (&amp;env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a1c42d4847422b6ffd0fb340fdd0cfa8b">env</a>[i] == dfp)
<a name="l00204"></a>00204                 fprintf(stderr, <span class="stringliteral">&quot; &lt;- dfp&quot;</span>);
<a name="l00205"></a>00205             fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00206"></a>00206         }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208         <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#aa0a172915cc02522f2c6a2fe88a18bad">prev_envval</a> != 0) {
<a name="l00209"></a>00209             <a class="code" href="../../d8/d32/vm__core_8h.html#aaa39b3177aba775195d515b937ef78ff">GetEnvPtr</a>(env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#aa0a172915cc02522f2c6a2fe88a18bad">prev_envval</a>, env);
<a name="l00210"></a>00210         }
<a name="l00211"></a>00211         <span class="keywordflow">else</span> {
<a name="l00212"></a>00212             env = 0;
<a name="l00213"></a>00213         }
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215     fprintf(stderr, <span class="stringliteral">&quot;---------------------------\n&quot;</span>);
<a name="l00216"></a>00216 }
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 <span class="keywordtype">void</span>
<a name="l00219"></a><a class="code" href="../../dd/dd7/vm__dump_8c.html#ab3e8c769e0c63ba229bd1b6338639512">00219</a> <a class="code" href="../../dd/dd7/vm__dump_8c.html#ab3e8c769e0c63ba229bd1b6338639512">rb_vmdebug_proc_dump_raw</a>(<a class="code" href="../../d5/d77/structrb__proc__t.html">rb_proc_t</a> *proc)
<a name="l00220"></a>00220 {
<a name="l00221"></a>00221     <a class="code" href="../../d0/d73/structrb__env__t.html">rb_env_t</a> *<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>;
<a name="l00222"></a>00222     <span class="keywordtype">char</span> *selfstr;
<a name="l00223"></a>00223     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val = <a class="code" href="../../db/d2e/intern_8h.html#acbb281bacf6b80f460143348e26142e9">rb_inspect</a>(proc-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#acf80b0e350012548c28cba1ea64a7a6e">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ad54e1ec45ab21ef384fe9e4346570397">self</a>);
<a name="l00224"></a>00224     selfstr = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(val);
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     fprintf(stderr, <span class="stringliteral">&quot;-- proc -------------------\n&quot;</span>);
<a name="l00227"></a>00227     fprintf(stderr, <span class="stringliteral">&quot;self: %s\n&quot;</span>, selfstr);
<a name="l00228"></a>00228     <a class="code" href="../../d8/d32/vm__core_8h.html#aaa39b3177aba775195d515b937ef78ff">GetEnvPtr</a>(proc-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#acdb9a8c85422bf299615f7942ffbc916">envval</a>, env);
<a name="l00229"></a>00229     <a class="code" href="../../dd/dd7/vm__dump_8c.html#a00c5c84d7769a956e3651998e92ae823">rb_vmdebug_env_dump_raw</a>(env, proc-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#acf80b0e350012548c28cba1ea64a7a6e">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#a834e1c9b35a06714deeb62097636564f">lfp</a>, proc-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#acf80b0e350012548c28cba1ea64a7a6e">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a>);
<a name="l00230"></a>00230 }
<a name="l00231"></a>00231 
<a name="l00232"></a>00232 <span class="keywordtype">void</span>
<a name="l00233"></a><a class="code" href="../../dd/dd7/vm__dump_8c.html#aaefbe89c8af3d369bde339711a6e8668">00233</a> <a class="code" href="../../dd/dd7/vm__dump_8c.html#aaefbe89c8af3d369bde339711a6e8668">rb_vmdebug_stack_dump_th</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> thval)
<a name="l00234"></a>00234 {
<a name="l00235"></a>00235     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th;
<a name="l00236"></a>00236     <a class="code" href="../../d8/d32/vm__core_8h.html#a36e942386b2b43383c44e769bffe5808">GetThreadPtr</a>(thval, th);
<a name="l00237"></a>00237     <a class="code" href="../../d8/d32/vm__core_8h.html#aa68a3152178b05ba670cf15f88201c60">rb_vmdebug_stack_dump_raw</a>(th, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>);
<a name="l00238"></a>00238 }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240 <span class="preprocessor">#if VMDEBUG &gt; 2</span>
<a name="l00241"></a>00241 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00242"></a>00242 vm_stack_dump_each(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp)
<a name="l00243"></a>00243 {
<a name="l00244"></a>00244     <span class="keywordtype">int</span> i;
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> rstr;
<a name="l00247"></a>00247     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *sp = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a>;
<a name="l00248"></a>00248     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *lfp = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a>;
<a name="l00249"></a>00249     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *dfp = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a>;
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     <span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a> = 0, local_size = 0;
<a name="l00252"></a>00252     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>;
<a name="l00253"></a>00253     <a class="code" href="../../d6/de3/structrb__iseq__struct.html">rb_iseq_t</a> *iseq = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     <span class="keywordflow">if</span> (iseq == 0) {
<a name="l00256"></a>00256         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#ae154762699bf1f722bdf05c22026d678">RUBYVM_CFUNC_FRAME_P</a>(cfp)) {
<a name="l00257"></a>00257             name = <a class="code" href="../../d5/d11/ripper_8c.html#a877bc58c495643fcf49dc64c44631e72">rb_id2name</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aa0ec76f80ebaf0668b688c4e4e5e3e3f">me</a>-&gt;original_id);
<a name="l00258"></a>00258         }
<a name="l00259"></a>00259         <span class="keywordflow">else</span> {
<a name="l00260"></a>00260             name = <span class="stringliteral">&quot;?&quot;</span>;
<a name="l00261"></a>00261         }
<a name="l00262"></a>00262     }
<a name="l00263"></a>00263     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#aa933aeb7a703c7cc2d136492acbbef22">RUBY_VM_IFUNC_P</a>(iseq)) {
<a name="l00264"></a>00264         name = <span class="stringliteral">&quot;&lt;ifunc&gt;&quot;</span>;
<a name="l00265"></a>00265     }
<a name="l00266"></a>00266     <span class="keywordflow">else</span> {
<a name="l00267"></a>00267         argc = iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a5fd0acd110681eeb0f95c3b283451a0a" title="argument information">argc</a>;
<a name="l00268"></a>00268         local_size = iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#afbae994355f91f3ea547570debb757c0">local_size</a>;
<a name="l00269"></a>00269         name = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a35596da255ce28a5d1da94c2cc508c7d">name</a>);
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272     <span class="comment">/* stack trace header */</span>
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(cfp) == <a class="code" href="../../d8/d32/vm__core_8h.html#abc8be29d36c6252fce6bc61621f81b71">VM_FRAME_MAGIC_METHOD</a> ||
<a name="l00275"></a>00275         <a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(cfp) == <a class="code" href="../../d8/d32/vm__core_8h.html#ac9390ef02c17a0bc7e3bd359264562c7">VM_FRAME_MAGIC_TOP</a> ||
<a name="l00276"></a>00276         <a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(cfp) == <a class="code" href="../../d8/d32/vm__core_8h.html#a83eeedff3dde6d2d1ffce5d84c2ba2f1">VM_FRAME_MAGIC_BLOCK</a> ||
<a name="l00277"></a>00277         <a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(cfp) == <a class="code" href="../../d8/d32/vm__core_8h.html#a2524f590c07fceb689b2b7d53114ff5f">VM_FRAME_MAGIC_CLASS</a> ||
<a name="l00278"></a>00278         <a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(cfp) == <a class="code" href="../../d8/d32/vm__core_8h.html#ac1f5b7efa57bccbeb4ff5e7ae6ff18c2">VM_FRAME_MAGIC_PROC</a> ||
<a name="l00279"></a>00279         <a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(cfp) == <a class="code" href="../../d8/d32/vm__core_8h.html#a57840803108748406429fb1cb3b10530">VM_FRAME_MAGIC_LAMBDA</a> ||
<a name="l00280"></a>00280         <a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(cfp) == <a class="code" href="../../d8/d32/vm__core_8h.html#a26308f33317bb5b96ff89924822e8eab">VM_FRAME_MAGIC_CFUNC</a> ||
<a name="l00281"></a>00281         <a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(cfp) == <a class="code" href="../../d8/d32/vm__core_8h.html#a795522d157a66fe8f0cdd335b28099c9">VM_FRAME_MAGIC_IFUNC</a> ||
<a name="l00282"></a>00282         <a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(cfp) == <a class="code" href="../../d8/d32/vm__core_8h.html#ac7b8d797cce488d08572c273f49f28fe">VM_FRAME_MAGIC_EVAL</a>) {
<a name="l00283"></a>00283 
<a name="l00284"></a>00284         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *ptr = dfp - local_size;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286         vm_stack_dump_each(th, cfp + 1);
<a name="l00287"></a>00287         <a class="code" href="../../dd/dd7/vm__dump_8c.html#ac8e45243b47b9a4d73d977c62c3e6975">control_frame_dump</a>(th, cfp);
<a name="l00288"></a>00288 
<a name="l00289"></a>00289         <span class="keywordflow">if</span> (lfp != dfp) {
<a name="l00290"></a>00290             local_size++;
<a name="l00291"></a>00291         }
<a name="l00292"></a>00292         <span class="keywordflow">for</span> (i = 0; i &lt; argc; i++) {
<a name="l00293"></a>00293             rstr = <a class="code" href="../../db/d2e/intern_8h.html#acbb281bacf6b80f460143348e26142e9">rb_inspect</a>(*ptr);
<a name="l00294"></a>00294             fprintf(stderr, <span class="stringliteral">&quot;  arg   %2d: %8s (%p)\n&quot;</span>, i, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(rstr),
<a name="l00295"></a>00295                    (<span class="keywordtype">void</span> *)ptr++);
<a name="l00296"></a>00296         }
<a name="l00297"></a>00297         <span class="keywordflow">for</span> (; i &lt; local_size - 1; i++) {
<a name="l00298"></a>00298             rstr = <a class="code" href="../../db/d2e/intern_8h.html#acbb281bacf6b80f460143348e26142e9">rb_inspect</a>(*ptr);
<a name="l00299"></a>00299             fprintf(stderr, <span class="stringliteral">&quot;  local %2d: %8s (%p)\n&quot;</span>, i, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(rstr),
<a name="l00300"></a>00300                    (<span class="keywordtype">void</span> *)ptr++);
<a name="l00301"></a>00301         }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303         ptr = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a8e19fd7af779b623f1e9477f271358e6">bp</a>;
<a name="l00304"></a>00304         <span class="keywordflow">for</span> (; ptr &lt; sp; ptr++, i++) {
<a name="l00305"></a>00305             <span class="keywordflow">if</span> (*ptr == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a>) {
<a name="l00306"></a>00306                 rstr = <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;undef&quot;</span>);
<a name="l00307"></a>00307             }
<a name="l00308"></a>00308             <span class="keywordflow">else</span> {
<a name="l00309"></a>00309                 rstr = <a class="code" href="../../db/d2e/intern_8h.html#acbb281bacf6b80f460143348e26142e9">rb_inspect</a>(*ptr);
<a name="l00310"></a>00310             }
<a name="l00311"></a>00311             fprintf(stderr, <span class="stringliteral">&quot;  stack %2d: %8s (%&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca444ec27cdd86e8456e34dfc4aed830">PRIdPTRDIFF</a><span class="stringliteral">&quot;)\n&quot;</span>, i, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(rstr),
<a name="l00312"></a>00312                     (ptr - th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a>));
<a name="l00313"></a>00313         }
<a name="l00314"></a>00314     }
<a name="l00315"></a>00315     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(cfp) == <a class="code" href="../../d8/d32/vm__core_8h.html#a885c6468caef6c3de80b0ad6c50ae38d">VM_FRAME_MAGIC_FINISH</a>) {
<a name="l00316"></a>00316         <span class="keywordflow">if</span> ((th)-&gt;stack + (th)-&gt;stack_size &gt; (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *)(cfp + 2)) {
<a name="l00317"></a>00317             vm_stack_dump_each(th, cfp + 1);
<a name="l00318"></a>00318         }
<a name="l00319"></a>00319         <span class="keywordflow">else</span> {
<a name="l00320"></a>00320             <span class="comment">/* SDR(); */</span>
<a name="l00321"></a>00321         }
<a name="l00322"></a>00322     }
<a name="l00323"></a>00323     <span class="keywordflow">else</span> {
<a name="l00324"></a>00324         <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;unsupport frame type: %08lx&quot;</span>, <a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(cfp));
<a name="l00325"></a>00325     }
<a name="l00326"></a>00326 }
<a name="l00327"></a>00327 <span class="preprocessor">#endif</span>
<a name="l00328"></a>00328 <span class="preprocessor"></span>
<a name="l00329"></a>00329 <span class="keywordtype">void</span>
<a name="l00330"></a><a class="code" href="../../dd/dd7/vm__dump_8c.html#a066f88891bb609fc5d137b4347038f40">00330</a> <a class="code" href="../../dd/dd7/vm__dump_8c.html#a066f88891bb609fc5d137b4347038f40">rb_vmdebug_debug_print_register</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l00331"></a>00331 {
<a name="l00332"></a>00332     <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>;
<a name="l00333"></a>00333     ptrdiff_t pc = -1;
<a name="l00334"></a>00334     ptrdiff_t lfp = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a> - th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a>;
<a name="l00335"></a>00335     ptrdiff_t dfp = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a> - th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a>;
<a name="l00336"></a>00336     ptrdiff_t cfpi;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a79d03ad9b9cf8b7a8ca2b849e495a74f">RUBY_VM_NORMAL_ISEQ_P</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>)) {
<a name="l00339"></a>00339         pc = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a28b0b301811a891225ba9a58c412482d">pc</a> - cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aa70f3e195a4350acbbc130f8a95c9958">iseq_encoded</a>;
<a name="l00340"></a>00340     }
<a name="l00341"></a>00341 
<a name="l00342"></a>00342     <span class="keywordflow">if</span> (lfp &lt; 0 || (<span class="keywordtype">size_t</span>)lfp &gt; th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1587dec1a575fb9f8d6a689ef4fdb6b5">stack_size</a>)
<a name="l00343"></a>00343         lfp = -1;
<a name="l00344"></a>00344     <span class="keywordflow">if</span> (dfp &lt; 0 || (<span class="keywordtype">size_t</span>)dfp &gt; th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1587dec1a575fb9f8d6a689ef4fdb6b5">stack_size</a>)
<a name="l00345"></a>00345         dfp = -1;
<a name="l00346"></a>00346 
<a name="l00347"></a>00347     cfpi = ((<a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *)(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a> + th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1587dec1a575fb9f8d6a689ef4fdb6b5">stack_size</a>)) - cfp;
<a name="l00348"></a>00348     fprintf(stderr, <span class="stringliteral">&quot;  [PC] %04&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca444ec27cdd86e8456e34dfc4aed830">PRIdPTRDIFF</a><span class="stringliteral">&quot;, [SP] %04&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca444ec27cdd86e8456e34dfc4aed830">PRIdPTRDIFF</a><span class="stringliteral">&quot;, [LFP] %04&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca444ec27cdd86e8456e34dfc4aed830">PRIdPTRDIFF</a><span class="stringliteral">&quot;, [DFP] %04&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca444ec27cdd86e8456e34dfc4aed830">PRIdPTRDIFF</a><span class="stringliteral">&quot;, [CFP] %04&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca444ec27cdd86e8456e34dfc4aed830">PRIdPTRDIFF</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00349"></a>00349             pc, (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a> - th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a>), lfp, dfp, cfpi);
<a name="l00350"></a>00350 }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352 <span class="keywordtype">void</span>
<a name="l00353"></a><a class="code" href="../../dd/dd7/vm__dump_8c.html#a2dcc677a7d7e5b4bebbbcf6afe5955fd">00353</a> <a class="code" href="../../dd/dd7/vm__dump_8c.html#a2dcc677a7d7e5b4bebbbcf6afe5955fd">rb_vmdebug_thread_dump_regs</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> thval)
<a name="l00354"></a>00354 {
<a name="l00355"></a>00355     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th;
<a name="l00356"></a>00356     <a class="code" href="../../d8/d32/vm__core_8h.html#a36e942386b2b43383c44e769bffe5808">GetThreadPtr</a>(thval, th);
<a name="l00357"></a>00357     <a class="code" href="../../dd/dd7/vm__dump_8c.html#a066f88891bb609fc5d137b4347038f40">rb_vmdebug_debug_print_register</a>(th);
<a name="l00358"></a>00358 }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360 <span class="keywordtype">void</span>
<a name="l00361"></a><a class="code" href="../../dd/dd7/vm__dump_8c.html#ad61ad81b4e157971a62f262265a27160">00361</a> <a class="code" href="../../dd/dd7/vm__dump_8c.html#ad61ad81b4e157971a62f262265a27160">rb_vmdebug_debug_print_pre</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp)
<a name="l00362"></a>00362 {
<a name="l00363"></a>00363     <a class="code" href="../../d6/de3/structrb__iseq__struct.html">rb_iseq_t</a> *iseq = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>;
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     <span class="keywordflow">if</span> (iseq != 0 &amp;&amp; <a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(cfp) != <a class="code" href="../../d8/d32/vm__core_8h.html#a885c6468caef6c3de80b0ad6c50ae38d">VM_FRAME_MAGIC_FINISH</a>) {
<a name="l00366"></a>00366         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *seq = iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a8699ab44e2c44e7f8df87e26a9c7bee8">iseq</a>;
<a name="l00367"></a>00367         ptrdiff_t pc = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a28b0b301811a891225ba9a58c412482d">pc</a> - iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aa70f3e195a4350acbbc130f8a95c9958">iseq_encoded</a>;
<a name="l00368"></a>00368 
<a name="l00369"></a>00369         printf(<span class="stringliteral">&quot;%3&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca444ec27cdd86e8456e34dfc4aed830">PRIdPTRDIFF</a><span class="stringliteral">&quot; &quot;</span>, <a class="code" href="../../dd/dd7/vm__dump_8c.html#acd3a62eaa8bfb2c0c2a59c2afa1179bb">VM_CFP_CNT</a>(th, cfp));
<a name="l00370"></a>00370         <span class="keywordflow">if</span> (pc &gt;= 0) {
<a name="l00371"></a>00371             <a class="code" href="../../dd/d74/iseq_8c.html#a8af8d884c25dccb7380ce2c0e5ce1e1c" title="Disassemble a instruction Iseq -&amp;gt; Iseq inspect object.">rb_iseq_disasm_insn</a>(0, seq, (<span class="keywordtype">size_t</span>)pc, iseq, 0);
<a name="l00372"></a>00372         }
<a name="l00373"></a>00373     }
<a name="l00374"></a>00374 
<a name="l00375"></a>00375 <span class="preprocessor">#if VMDEBUG &gt; 3</span>
<a name="l00376"></a>00376 <span class="preprocessor"></span>    fprintf(stderr, <span class="stringliteral">&quot;        (1)&quot;</span>);
<a name="l00377"></a>00377     <a class="code" href="../../dd/dd7/vm__dump_8c.html#a066f88891bb609fc5d137b4347038f40">rb_vmdebug_debug_print_register</a>(th);
<a name="l00378"></a>00378 <span class="preprocessor">#endif</span>
<a name="l00379"></a>00379 <span class="preprocessor"></span>}
<a name="l00380"></a>00380 
<a name="l00381"></a>00381 <span class="keywordtype">void</span>
<a name="l00382"></a><a class="code" href="../../dd/dd7/vm__dump_8c.html#a10140e7b70a08eb48ba3befe9485ac42">00382</a> <a class="code" href="../../dd/dd7/vm__dump_8c.html#a10140e7b70a08eb48ba3befe9485ac42">rb_vmdebug_debug_print_post</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp
<a name="l00383"></a>00383 #<span class="keywordflow">if</span> OPT_STACK_CACHING
<a name="l00384"></a>00384                  , <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> reg_a, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> reg_b
<a name="l00385"></a>00385 #endif
<a name="l00386"></a>00386     )
<a name="l00387"></a>00387 {
<a name="l00388"></a>00388 <span class="preprocessor">#if VMDEBUG &gt; 9</span>
<a name="l00389"></a>00389 <span class="preprocessor"></span>    <a class="code" href="../../d8/d32/vm__core_8h.html#ab913ccb5c8b4c3065335169b15925411">SDR2</a>(cfp);
<a name="l00390"></a>00390 <span class="preprocessor">#endif</span>
<a name="l00391"></a>00391 <span class="preprocessor"></span>
<a name="l00392"></a>00392 <span class="preprocessor">#if VMDEBUG &gt; 3</span>
<a name="l00393"></a>00393 <span class="preprocessor"></span>    fprintf(stderr, <span class="stringliteral">&quot;        (2)&quot;</span>);
<a name="l00394"></a>00394     <a class="code" href="../../dd/dd7/vm__dump_8c.html#a066f88891bb609fc5d137b4347038f40">rb_vmdebug_debug_print_register</a>(th);
<a name="l00395"></a>00395 <span class="preprocessor">#endif</span>
<a name="l00396"></a>00396 <span class="preprocessor"></span>    <span class="comment">/* stack_dump_raw(th, cfp); */</span>
<a name="l00397"></a>00397 
<a name="l00398"></a>00398 <span class="preprocessor">#if VMDEBUG &gt; 2</span>
<a name="l00399"></a>00399 <span class="preprocessor"></span>    <span class="comment">/* stack_dump_thobj(th); */</span>
<a name="l00400"></a>00400     vm_stack_dump_each(th, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>);
<a name="l00401"></a>00401 <span class="preprocessor">#if OPT_STACK_CACHING</span>
<a name="l00402"></a>00402 <span class="preprocessor"></span>    {
<a name="l00403"></a>00403         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> rstr;
<a name="l00404"></a>00404         rstr = <a class="code" href="../../db/d2e/intern_8h.html#acbb281bacf6b80f460143348e26142e9">rb_inspect</a>(reg_a);
<a name="l00405"></a>00405         fprintf(stderr, <span class="stringliteral">&quot;  sc reg A: %s\n&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(rstr));
<a name="l00406"></a>00406         rstr = <a class="code" href="../../db/d2e/intern_8h.html#acbb281bacf6b80f460143348e26142e9">rb_inspect</a>(reg_b);
<a name="l00407"></a>00407         fprintf(stderr, <span class="stringliteral">&quot;  sc reg B: %s\n&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(rstr));
<a name="l00408"></a>00408     }
<a name="l00409"></a>00409 <span class="preprocessor">#endif</span>
<a name="l00410"></a>00410 <span class="preprocessor"></span>    printf
<a name="l00411"></a>00411         (<span class="stringliteral">&quot;--------------------------------------------------------------\n&quot;</span>);
<a name="l00412"></a>00412 <span class="preprocessor">#endif</span>
<a name="l00413"></a>00413 <span class="preprocessor"></span>}
<a name="l00414"></a>00414 
<a name="l00415"></a>00415 <span class="preprocessor">#ifdef COLLECT_USAGE_ANALYSIS</span>
<a name="l00416"></a>00416 <span class="preprocessor"></span><span class="comment">/* uh = {</span>
<a name="l00417"></a>00417 <span class="comment"> *   insn(Fixnum) =&gt; ihash(Hash)</span>
<a name="l00418"></a>00418 <span class="comment"> * }</span>
<a name="l00419"></a>00419 <span class="comment"> * ihash = {</span>
<a name="l00420"></a>00420 <span class="comment"> *   -1(Fixnum) =&gt; count,      # insn usage</span>
<a name="l00421"></a>00421 <span class="comment"> *    0(Fixnum) =&gt; ophash,     # operand usage</span>
<a name="l00422"></a>00422 <span class="comment"> * }</span>
<a name="l00423"></a>00423 <span class="comment"> * ophash = {</span>
<a name="l00424"></a>00424 <span class="comment"> *   val(interned string) =&gt; count(Fixnum)</span>
<a name="l00425"></a>00425 <span class="comment"> * }</span>
<a name="l00426"></a>00426 <span class="comment"> */</span>
<a name="l00427"></a>00427 <span class="keywordtype">void</span>
<a name="l00428"></a>00428 <a class="code" href="../../de/de9/vm_8c.html#aadc79f2891643166c13ed45e187396f2">vm_analysis_insn</a>(<span class="keywordtype">int</span> insn)
<a name="l00429"></a>00429 {
<a name="l00430"></a>00430     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> usage_hash;
<a name="l00431"></a>00431     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> bigram_hash;
<a name="l00432"></a>00432     <span class="keyword">static</span> <span class="keywordtype">int</span> prev_insn = -1;
<a name="l00433"></a>00433 
<a name="l00434"></a>00434     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> uh;
<a name="l00435"></a>00435     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ihash;
<a name="l00436"></a>00436     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a064e4a3a0f3f97b34dc187ea21bcc2f1">cv</a>;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa50b9d5bc665eb5545f6857c89232161">CONST_ID</a>(usage_hash, <span class="stringliteral">&quot;USAGE_ANALYSIS_INSN&quot;</span>);
<a name="l00439"></a>00439     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa50b9d5bc665eb5545f6857c89232161">CONST_ID</a>(bigram_hash, <span class="stringliteral">&quot;USAGE_ANALYSIS_INSN_BIGRAM&quot;</span>);
<a name="l00440"></a>00440     uh = <a class="code" href="../../db/d2e/intern_8h.html#a17a81c1a7d754e5ab49fc4b4369b6c8c">rb_const_get</a>(<a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a>, usage_hash);
<a name="l00441"></a>00441     <span class="keywordflow">if</span> ((ihash = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(uh, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(insn))) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>) {
<a name="l00442"></a>00442         ihash = <a class="code" href="../../d1/d04/hash_8c.html#af1da586524a3a1739fd5b91272037815">rb_hash_new</a>();
<a name="l00443"></a>00443         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(uh, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(insn), ihash);
<a name="l00444"></a>00444     }
<a name="l00445"></a>00445     <span class="keywordflow">if</span> ((cv = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(ihash, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(-1))) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>) {
<a name="l00446"></a>00446         cv = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0);
<a name="l00447"></a>00447     }
<a name="l00448"></a>00448     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(ihash, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(-1), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9444c431b3cb1184e7523fc572f2c758">FIX2INT</a>(cv) + 1));
<a name="l00449"></a>00449 
<a name="l00450"></a>00450     <span class="comment">/* calc bigram */</span>
<a name="l00451"></a>00451     <span class="keywordflow">if</span> (prev_insn != -1) {
<a name="l00452"></a>00452         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> bi;
<a name="l00453"></a>00453         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary[2];
<a name="l00454"></a>00454         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> cv;
<a name="l00455"></a>00455 
<a name="l00456"></a>00456         ary[0] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(prev_insn);
<a name="l00457"></a>00457         ary[1] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(insn);
<a name="l00458"></a>00458         bi = <a class="code" href="../../dc/dcc/array_8c.html#a575a99eebf6ce65893ed83c2b6783d2d">rb_ary_new4</a>(2, &amp;ary[0]);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460         uh = <a class="code" href="../../db/d2e/intern_8h.html#a17a81c1a7d754e5ab49fc4b4369b6c8c">rb_const_get</a>(<a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a>, bigram_hash);
<a name="l00461"></a>00461         <span class="keywordflow">if</span> ((cv = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(uh, bi)) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>) {
<a name="l00462"></a>00462             cv = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0);
<a name="l00463"></a>00463         }
<a name="l00464"></a>00464         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(uh, bi, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9444c431b3cb1184e7523fc572f2c758">FIX2INT</a>(cv) + 1));
<a name="l00465"></a>00465     }
<a name="l00466"></a>00466     prev_insn = insn;
<a name="l00467"></a>00467 }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469 <span class="comment">/* from disasm.c */</span>
<a name="l00470"></a>00470 <span class="keyword">extern</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dd/d74/iseq_8c.html#af94502bbd024003d18377cfb27b2045f">insn_operand_intern</a>(<span class="keywordtype">int</span> insn, <span class="keywordtype">int</span> op_no, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> op,
<a name="l00471"></a>00471                                  <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <span class="keywordtype">int</span> pos, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> child);
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 <span class="keywordtype">void</span>
<a name="l00474"></a>00474 <a class="code" href="../../de/de9/vm_8c.html#a70b2fd040eae21f04d68a7a6f7ee1a05">vm_analysis_operand</a>(<span class="keywordtype">int</span> insn, <span class="keywordtype">int</span> n, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> op)
<a name="l00475"></a>00475 {
<a name="l00476"></a>00476     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> usage_hash;
<a name="l00477"></a>00477 
<a name="l00478"></a>00478     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> uh;
<a name="l00479"></a>00479     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ihash;
<a name="l00480"></a>00480     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ophash;
<a name="l00481"></a>00481     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> valstr;
<a name="l00482"></a>00482     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> cv;
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa50b9d5bc665eb5545f6857c89232161">CONST_ID</a>(usage_hash, <span class="stringliteral">&quot;USAGE_ANALYSIS_INSN&quot;</span>);
<a name="l00485"></a>00485 
<a name="l00486"></a>00486     uh = <a class="code" href="../../db/d2e/intern_8h.html#a17a81c1a7d754e5ab49fc4b4369b6c8c">rb_const_get</a>(<a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a>, usage_hash);
<a name="l00487"></a>00487     <span class="keywordflow">if</span> ((ihash = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(uh, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(insn))) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>) {
<a name="l00488"></a>00488         ihash = <a class="code" href="../../d1/d04/hash_8c.html#af1da586524a3a1739fd5b91272037815">rb_hash_new</a>();
<a name="l00489"></a>00489         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(uh, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(insn), ihash);
<a name="l00490"></a>00490     }
<a name="l00491"></a>00491     <span class="keywordflow">if</span> ((ophash = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(ihash, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(n))) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>) {
<a name="l00492"></a>00492         ophash = <a class="code" href="../../d1/d04/hash_8c.html#af1da586524a3a1739fd5b91272037815">rb_hash_new</a>();
<a name="l00493"></a>00493         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(ihash, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(n), ophash);
<a name="l00494"></a>00494     }
<a name="l00495"></a>00495     <span class="comment">/* intern */</span>
<a name="l00496"></a>00496     valstr = <a class="code" href="../../dd/d74/iseq_8c.html#af94502bbd024003d18377cfb27b2045f">insn_operand_intern</a>(insn, n, op, 0, 0, 0);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <span class="comment">/* set count */</span>
<a name="l00499"></a>00499     <span class="keywordflow">if</span> ((cv = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(ophash, valstr)) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>) {
<a name="l00500"></a>00500         cv = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0);
<a name="l00501"></a>00501     }
<a name="l00502"></a>00502     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(ophash, valstr, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9444c431b3cb1184e7523fc572f2c758">FIX2INT</a>(cv) + 1));
<a name="l00503"></a>00503 }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505 <span class="keywordtype">void</span>
<a name="l00506"></a>00506 <a class="code" href="../../de/de9/vm_8c.html#a22af4689a1b73006b14a25502191cde5">vm_analysis_register</a>(<span class="keywordtype">int</span> reg, <span class="keywordtype">int</span> isset)
<a name="l00507"></a>00507 {
<a name="l00508"></a>00508     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> usage_hash;
<a name="l00509"></a>00509     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> uh;
<a name="l00510"></a>00510     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> rhash;
<a name="l00511"></a>00511     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> valstr;
<a name="l00512"></a>00512     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> regstrs[][5] = {
<a name="l00513"></a>00513         <span class="stringliteral">&quot;pc&quot;</span>,                   <span class="comment">/* 0 */</span>
<a name="l00514"></a>00514         <span class="stringliteral">&quot;sp&quot;</span>,                   <span class="comment">/* 1 */</span>
<a name="l00515"></a>00515         <span class="stringliteral">&quot;cfp&quot;</span>,                  <span class="comment">/* 2 */</span>
<a name="l00516"></a>00516         <span class="stringliteral">&quot;lfp&quot;</span>,                  <span class="comment">/* 3 */</span>
<a name="l00517"></a>00517         <span class="stringliteral">&quot;dfp&quot;</span>,                  <span class="comment">/* 4 */</span>
<a name="l00518"></a>00518         <span class="stringliteral">&quot;self&quot;</span>,                 <span class="comment">/* 5 */</span>
<a name="l00519"></a>00519         <span class="stringliteral">&quot;iseq&quot;</span>,                 <span class="comment">/* 6 */</span>
<a name="l00520"></a>00520     };
<a name="l00521"></a>00521     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> getsetstr[][4] = {
<a name="l00522"></a>00522         <span class="stringliteral">&quot;get&quot;</span>,
<a name="l00523"></a>00523         <span class="stringliteral">&quot;set&quot;</span>,
<a name="l00524"></a>00524     };
<a name="l00525"></a>00525     <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> syms[<span class="keyword">sizeof</span>(regstrs) / <span class="keyword">sizeof</span>(regstrs[0])][2];
<a name="l00526"></a>00526 
<a name="l00527"></a>00527     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> cv;
<a name="l00528"></a>00528 
<a name="l00529"></a>00529     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa50b9d5bc665eb5545f6857c89232161">CONST_ID</a>(usage_hash, <span class="stringliteral">&quot;USAGE_ANALYSIS_REGS&quot;</span>);
<a name="l00530"></a>00530     <span class="keywordflow">if</span> (syms[0] == 0) {
<a name="l00531"></a>00531         <span class="keywordtype">char</span> buff[0x10];
<a name="l00532"></a>00532         <span class="keywordtype">int</span> i;
<a name="l00533"></a>00533 
<a name="l00534"></a>00534         <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">sizeof</span>(regstrs) / <span class="keyword">sizeof</span>(regstrs[0]); i++) {
<a name="l00535"></a>00535             <span class="keywordtype">int</span> j;
<a name="l00536"></a>00536             <span class="keywordflow">for</span> (j = 0; j &lt; 2; j++) {
<a name="l00537"></a>00537                 snfprintf(stderr, buff, 0x10, <span class="stringliteral">&quot;%d %s %-4s&quot;</span>, i, getsetstr[j],
<a name="l00538"></a>00538                          regstrs[i]);
<a name="l00539"></a>00539                 syms[i][j] = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(buff));
<a name="l00540"></a>00540             }
<a name="l00541"></a>00541         }
<a name="l00542"></a>00542     }
<a name="l00543"></a>00543     valstr = syms[reg][isset];
<a name="l00544"></a>00544 
<a name="l00545"></a>00545     uh = <a class="code" href="../../db/d2e/intern_8h.html#a17a81c1a7d754e5ab49fc4b4369b6c8c">rb_const_get</a>(<a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a>, usage_hash);
<a name="l00546"></a>00546     <span class="keywordflow">if</span> ((cv = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(uh, valstr)) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>) {
<a name="l00547"></a>00547         cv = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0);
<a name="l00548"></a>00548     }
<a name="l00549"></a>00549     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(uh, valstr, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9444c431b3cb1184e7523fc572f2c758">FIX2INT</a>(cv) + 1));
<a name="l00550"></a>00550 }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 
<a name="l00553"></a>00553 <span class="preprocessor">#endif</span>
<a name="l00554"></a>00554 <span class="preprocessor"></span>
<a name="l00555"></a>00555 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00556"></a><a class="code" href="../../dd/dd7/vm__dump_8c.html#a4829e1bba567279a3c7df1a8e0056c65">00556</a> <a class="code" href="../../dd/dd7/vm__dump_8c.html#a4829e1bba567279a3c7df1a8e0056c65">rb_vmdebug_thread_dump_state</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l00557"></a>00557 {
<a name="l00558"></a>00558     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th;
<a name="l00559"></a>00559     <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp;
<a name="l00560"></a>00560     <a class="code" href="../../d8/d32/vm__core_8h.html#a36e942386b2b43383c44e769bffe5808">GetThreadPtr</a>(<span class="keyword">self</span>, th);
<a name="l00561"></a>00561     cfp = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>;
<a name="l00562"></a>00562 
<a name="l00563"></a>00563     fprintf(stderr, <span class="stringliteral">&quot;Thread state dump:\n&quot;</span>);
<a name="l00564"></a>00564     fprintf(stderr, <span class="stringliteral">&quot;pc : %p, sp : %p\n&quot;</span>, (<span class="keywordtype">void</span> *)cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a28b0b301811a891225ba9a58c412482d">pc</a>, (<span class="keywordtype">void</span> *)cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a>);
<a name="l00565"></a>00565     fprintf(stderr, <span class="stringliteral">&quot;cfp: %p, lfp: %p, dfp: %p\n&quot;</span>, (<span class="keywordtype">void</span> *)cfp, (<span class="keywordtype">void</span> *)cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a>, (<span class="keywordtype">void</span> *)cfp-&gt;dfp);
<a name="l00566"></a>00566 
<a name="l00567"></a>00567     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00568"></a>00568 }
<a name="l00569"></a>00569 
<a name="l00570"></a>00570 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00571"></a><a class="code" href="../../dd/dd7/vm__dump_8c.html#ae5165393259e08cff52a6c3d66619217">00571</a> <a class="code" href="../../dd/dd7/vm__dump_8c.html#ae5165393259e08cff52a6c3d66619217">bugreport_backtrace</a>(<span class="keywordtype">void</span> *arg, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> file, <span class="keywordtype">int</span> line, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d7/d2a/structiseq__inline__cache__entry.html#afe485ee1e6c1127a5512d3ec8c43d6a6">method</a>)
<a name="l00572"></a>00572 {
<a name="l00573"></a>00573     <span class="keyword">const</span> <span class="keywordtype">char</span> *filename = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(file) ? <span class="stringliteral">&quot;ruby&quot;</span> : <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(file);
<a name="l00574"></a>00574     <span class="keywordflow">if</span> (!*(<span class="keywordtype">int</span> *)arg) {
<a name="l00575"></a>00575         fprintf(stderr, <span class="stringliteral">&quot;-- Ruby level backtrace information &quot;</span>
<a name="l00576"></a>00576                 <span class="stringliteral">&quot;----------------------------------------\n&quot;</span>);
<a name="l00577"></a>00577         *(<span class="keywordtype">int</span> *)arg = 1;
<a name="l00578"></a>00578     }
<a name="l00579"></a>00579     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(method)) {
<a name="l00580"></a>00580         fprintf(stderr, <span class="stringliteral">&quot;%s:%d:in unknown method\n&quot;</span>, filename, line);
<a name="l00581"></a>00581     }
<a name="l00582"></a>00582     <span class="keywordflow">else</span> {
<a name="l00583"></a>00583         fprintf(stderr, <span class="stringliteral">&quot;%s:%d:in `%s&apos;\n&quot;</span>, filename, line, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(method));
<a name="l00584"></a>00584     }
<a name="l00585"></a>00585     <span class="keywordflow">return</span> 0;
<a name="l00586"></a>00586 }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588 <span class="preprocessor">#if defined(__FreeBSD__) &amp;&amp; defined(__OPTIMIZE__)</span>
<a name="l00589"></a>00589 <span class="preprocessor"></span><span class="preprocessor">#undef HAVE_BACKTRACE</span>
<a name="l00590"></a>00590 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00591"></a>00591 <span class="preprocessor"></span><span class="preprocessor">#if HAVE_BACKTRACE</span>
<a name="l00592"></a>00592 <span class="preprocessor"></span><span class="preprocessor"># include &lt;execinfo.h&gt;</span>
<a name="l00593"></a>00593 <span class="preprocessor">#elif defined(_WIN32)</span>
<a name="l00594"></a>00594 <span class="preprocessor"></span><span class="preprocessor"># include &lt;imagehlp.h&gt;</span>
<a name="l00595"></a>00595 <span class="preprocessor"># ifndef SYMOPT_DEBUG</span>
<a name="l00596"></a>00596 <span class="preprocessor"></span><span class="preprocessor">#  define SYMOPT_DEBUG 0x80000000</span>
<a name="l00597"></a>00597 <span class="preprocessor"></span><span class="preprocessor"># endif</span>
<a name="l00598"></a>00598 <span class="preprocessor"></span><span class="preprocessor"># ifndef MAX_SYM_NAME</span>
<a name="l00599"></a>00599 <span class="preprocessor"></span><span class="preprocessor"># define MAX_SYM_NAME 2000</span>
<a name="l00600"></a>00600 <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00601"></a>00601     DWORD64 Offset;
<a name="l00602"></a>00602     WORD Segment;
<a name="l00603"></a>00603     ADDRESS_MODE Mode;
<a name="l00604"></a>00604 } ADDRESS64;
<a name="l00605"></a>00605 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00606"></a>00606     DWORD64 Thread;
<a name="l00607"></a>00607     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> ThCallbackStack;
<a name="l00608"></a>00608     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> ThCallbackBStore;
<a name="l00609"></a>00609     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> NextCallback;
<a name="l00610"></a>00610     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> FramePointer;
<a name="l00611"></a>00611     DWORD64 KiCallUserMode;
<a name="l00612"></a>00612     DWORD64 KeUserCallbackDispatcher;
<a name="l00613"></a>00613     DWORD64 SystemRangeStart;
<a name="l00614"></a>00614     DWORD64 KiUserExceptionDispatcher;
<a name="l00615"></a>00615     DWORD64 StackBase;
<a name="l00616"></a>00616     DWORD64 StackLimit;
<a name="l00617"></a>00617     DWORD64 Reserved[5];
<a name="l00618"></a>00618 } KDHELP64;
<a name="l00619"></a>00619 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00620"></a>00620     ADDRESS64 AddrPC;
<a name="l00621"></a>00621     ADDRESS64 AddrReturn;
<a name="l00622"></a>00622     ADDRESS64 AddrFrame;
<a name="l00623"></a>00623     ADDRESS64 AddrStack;
<a name="l00624"></a>00624     ADDRESS64 AddrBStore;
<a name="l00625"></a>00625     <span class="keywordtype">void</span> *FuncTableEntry;
<a name="l00626"></a>00626     DWORD64 Params[4];
<a name="l00627"></a>00627     BOOL Far;
<a name="l00628"></a>00628     BOOL Virtual;
<a name="l00629"></a>00629     DWORD64 Reserved[3];
<a name="l00630"></a>00630     KDHELP64 KdHelp;
<a name="l00631"></a>00631 } STACKFRAME64;
<a name="l00632"></a>00632 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00633"></a>00633     <a class="code" href="../../d2/d99/win32ole_8c.html#a516d92a41f815ad3c448380a9aa3e4d0">ULONG</a> SizeOfStruct;
<a name="l00634"></a>00634     <a class="code" href="../../d2/d99/win32ole_8c.html#a516d92a41f815ad3c448380a9aa3e4d0">ULONG</a> TypeIndex;
<a name="l00635"></a>00635     ULONG64 Reserved[2];
<a name="l00636"></a>00636     <a class="code" href="../../d2/d99/win32ole_8c.html#a516d92a41f815ad3c448380a9aa3e4d0">ULONG</a> Index;
<a name="l00637"></a>00637     <a class="code" href="../../d2/d99/win32ole_8c.html#a516d92a41f815ad3c448380a9aa3e4d0">ULONG</a> Size;
<a name="l00638"></a>00638     ULONG64 ModBase;
<a name="l00639"></a>00639     <a class="code" href="../../d2/d99/win32ole_8c.html#a516d92a41f815ad3c448380a9aa3e4d0">ULONG</a> Flags;
<a name="l00640"></a>00640     ULONG64 Value;
<a name="l00641"></a>00641     ULONG64 Address;
<a name="l00642"></a>00642     <a class="code" href="../../d2/d99/win32ole_8c.html#a516d92a41f815ad3c448380a9aa3e4d0">ULONG</a> Register;
<a name="l00643"></a>00643     <a class="code" href="../../d2/d99/win32ole_8c.html#a516d92a41f815ad3c448380a9aa3e4d0">ULONG</a> Scope;
<a name="l00644"></a>00644     <a class="code" href="../../d2/d99/win32ole_8c.html#a516d92a41f815ad3c448380a9aa3e4d0">ULONG</a> Tag;
<a name="l00645"></a>00645     <a class="code" href="../../d2/d99/win32ole_8c.html#a516d92a41f815ad3c448380a9aa3e4d0">ULONG</a> NameLen;
<a name="l00646"></a>00646     <a class="code" href="../../d2/d99/win32ole_8c.html#a516d92a41f815ad3c448380a9aa3e4d0">ULONG</a> MaxNameLen;
<a name="l00647"></a>00647     <span class="keywordtype">char</span> Name[1];
<a name="l00648"></a>00648 } SYMBOL_INFO;
<a name="l00649"></a>00649 <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00650"></a>00650     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> SizeOfStruct;
<a name="l00651"></a>00651     <span class="keywordtype">void</span> *Key;
<a name="l00652"></a>00652     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> LineNumber;
<a name="l00653"></a>00653     <span class="keywordtype">char</span> *FileName;
<a name="l00654"></a>00654     DWORD64 Address;
<a name="l00655"></a>00655 } IMAGEHLP_LINE64;
<a name="l00656"></a>00656 <span class="keyword">typedef</span> <span class="keywordtype">void</span> *PREAD_PROCESS_MEMORY_ROUTINE64;
<a name="l00657"></a>00657 <span class="keyword">typedef</span> <span class="keywordtype">void</span> *PFUNCTION_TABLE_ACCESS_ROUTINE64;
<a name="l00658"></a>00658 <span class="keyword">typedef</span> <span class="keywordtype">void</span> *PGET_MODULE_BASE_ROUTINE64;
<a name="l00659"></a>00659 <span class="keyword">typedef</span> <span class="keywordtype">void</span> *PTRANSLATE_ADDRESS_ROUTINE64;
<a name="l00660"></a>00660 <span class="preprocessor"># endif</span>
<a name="l00661"></a>00661 <span class="preprocessor"></span>
<a name="l00662"></a>00662 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00663"></a>00663 dump_thread(<span class="keywordtype">void</span> *arg)
<a name="l00664"></a>00664 {
<a name="l00665"></a>00665     HANDLE dbghelp;
<a name="l00666"></a>00666     BOOL (WINAPI *pSymInitialize)(HANDLE, <span class="keyword">const</span> <span class="keywordtype">char</span> *, BOOL);
<a name="l00667"></a>00667     BOOL (WINAPI *pSymCleanup)(HANDLE);
<a name="l00668"></a>00668     BOOL (WINAPI *pStackWalk64)(<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>, HANDLE, HANDLE, STACKFRAME64 *, <span class="keywordtype">void</span> *, PREAD_PROCESS_MEMORY_ROUTINE64, PFUNCTION_TABLE_ACCESS_ROUTINE64, PGET_MODULE_BASE_ROUTINE64, PTRANSLATE_ADDRESS_ROUTINE64);
<a name="l00669"></a>00669     DWORD64 (WINAPI *pSymGetModuleBase64)(HANDLE, DWORD64);
<a name="l00670"></a>00670     BOOL (WINAPI *pSymFromAddr)(HANDLE, DWORD64, DWORD64 *, SYMBOL_INFO *);
<a name="l00671"></a>00671     BOOL (WINAPI *pSymGetLineFromAddr64)(HANDLE, DWORD64, <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> *, IMAGEHLP_LINE64 *);
<a name="l00672"></a>00672     HANDLE (WINAPI *pOpenThread)(DWORD, BOOL, DWORD);
<a name="l00673"></a>00673     DWORD tid = *(DWORD *)arg;
<a name="l00674"></a>00674     HANDLE ph;
<a name="l00675"></a>00675     HANDLE th;
<a name="l00676"></a>00676 
<a name="l00677"></a>00677     dbghelp = LoadLibrary(<span class="stringliteral">&quot;dbghelp.dll&quot;</span>);
<a name="l00678"></a>00678     <span class="keywordflow">if</span> (!dbghelp) <span class="keywordflow">return</span>;
<a name="l00679"></a>00679     pSymInitialize = (BOOL (WINAPI *)(HANDLE, <span class="keyword">const</span> <span class="keywordtype">char</span> *, BOOL))GetProcAddress(dbghelp, <span class="stringliteral">&quot;SymInitialize&quot;</span>);
<a name="l00680"></a>00680     pSymCleanup = (BOOL (WINAPI *)(HANDLE))GetProcAddress(dbghelp, <span class="stringliteral">&quot;SymCleanup&quot;</span>);
<a name="l00681"></a>00681     pStackWalk64 = (BOOL (WINAPI *)(DWORD, HANDLE, HANDLE, STACKFRAME64 *, <span class="keywordtype">void</span> *, PREAD_PROCESS_MEMORY_ROUTINE64, PFUNCTION_TABLE_ACCESS_ROUTINE64, PGET_MODULE_BASE_ROUTINE64, PTRANSLATE_ADDRESS_ROUTINE64))GetProcAddress(dbghelp, <span class="stringliteral">&quot;StackWalk64&quot;</span>);
<a name="l00682"></a>00682     pSymGetModuleBase64 = (DWORD64 (WINAPI *)(HANDLE, DWORD64))GetProcAddress(dbghelp, <span class="stringliteral">&quot;SymGetModuleBase64&quot;</span>);
<a name="l00683"></a>00683     pSymFromAddr = (BOOL (WINAPI *)(HANDLE, DWORD64, DWORD64 *, SYMBOL_INFO *))GetProcAddress(dbghelp, <span class="stringliteral">&quot;SymFromAddr&quot;</span>);
<a name="l00684"></a>00684     pSymGetLineFromAddr64 = (BOOL (WINAPI *)(HANDLE, DWORD64, DWORD *, IMAGEHLP_LINE64 *))GetProcAddress(dbghelp, <span class="stringliteral">&quot;SymGetLineFromAddr64&quot;</span>);
<a name="l00685"></a>00685     pOpenThread = (HANDLE (WINAPI *)(DWORD, BOOL, DWORD))GetProcAddress(GetModuleHandle(<span class="stringliteral">&quot;kernel32.dll&quot;</span>), <span class="stringliteral">&quot;OpenThread&quot;</span>);
<a name="l00686"></a>00686     <span class="keywordflow">if</span> (pSymInitialize &amp;&amp; pSymCleanup &amp;&amp; pStackWalk64 &amp;&amp; pSymGetModuleBase64 &amp;&amp;
<a name="l00687"></a>00687         pSymFromAddr &amp;&amp; pSymGetLineFromAddr64 &amp;&amp; pOpenThread) {
<a name="l00688"></a>00688         SymSetOptions(SYMOPT_UNDNAME | SYMOPT_DEFERRED_LOADS | SYMOPT_DEBUG | SYMOPT_LOAD_LINES);
<a name="l00689"></a>00689         ph = GetCurrentProcess();
<a name="l00690"></a>00690         pSymInitialize(ph, NULL, <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l00691"></a>00691         th = pOpenThread(THREAD_SUSPEND_RESUME|THREAD_GET_CONTEXT, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, tid);
<a name="l00692"></a>00692         <span class="keywordflow">if</span> (th) {
<a name="l00693"></a>00693             <span class="keywordflow">if</span> (SuspendThread(th) != (DWORD)-1) {
<a name="l00694"></a>00694                 CONTEXT context;
<a name="l00695"></a>00695                 memset(&amp;context, 0, <span class="keyword">sizeof</span>(context));
<a name="l00696"></a>00696                 context.ContextFlags = CONTEXT_FULL;
<a name="l00697"></a>00697                 <span class="keywordflow">if</span> (GetThreadContext(th, &amp;context)) {
<a name="l00698"></a>00698                     <span class="keywordtype">char</span> libpath[MAX_PATH];
<a name="l00699"></a>00699                     <span class="keywordtype">char</span> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>[<span class="keyword">sizeof</span>(SYMBOL_INFO) + MAX_SYM_NAME];
<a name="l00700"></a>00700                     SYMBOL_INFO *info = (SYMBOL_INFO *)<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>;
<a name="l00701"></a>00701                     DWORD mac;
<a name="l00702"></a>00702                     STACKFRAME64 frame;
<a name="l00703"></a>00703                     memset(&amp;frame, 0, <span class="keyword">sizeof</span>(frame));
<a name="l00704"></a>00704 <span class="preprocessor">#if defined(_M_AMD64) || defined(__x86_64__)</span>
<a name="l00705"></a>00705 <span class="preprocessor"></span>                    mac = IMAGE_FILE_MACHINE_AMD64;
<a name="l00706"></a>00706                     frame.AddrPC.Mode = AddrModeFlat;
<a name="l00707"></a>00707                     frame.AddrPC.Offset = context.Rip;
<a name="l00708"></a>00708                     frame.AddrFrame.Mode = AddrModeFlat;
<a name="l00709"></a>00709                     frame.AddrFrame.Offset = context.Rbp;
<a name="l00710"></a>00710                     frame.AddrStack.Mode = AddrModeFlat;
<a name="l00711"></a>00711                     frame.AddrStack.Offset = context.Rsp;
<a name="l00712"></a>00712 <span class="preprocessor">#elif defined(_M_IA64) || defined(__ia64__)</span>
<a name="l00713"></a>00713 <span class="preprocessor"></span>                    mac = IMAGE_FILE_MACHINE_IA64;
<a name="l00714"></a>00714                     frame.AddrPC.Mode = AddrModeFlat;
<a name="l00715"></a>00715                     frame.AddrPC.Offset = context.StIIP;
<a name="l00716"></a>00716                     frame.AddrBStore.Mode = AddrModeFlat;
<a name="l00717"></a>00717                     frame.AddrBStore.Offset = context.RsBSP;
<a name="l00718"></a>00718                     frame.AddrStack.Mode = AddrModeFlat;
<a name="l00719"></a>00719                     frame.AddrStack.Offset = context.IntSp;
<a name="l00720"></a>00720 <span class="preprocessor">#else   </span><span class="comment">/* i386 */</span>
<a name="l00721"></a>00721                     mac = IMAGE_FILE_MACHINE_I386;
<a name="l00722"></a>00722                     frame.AddrPC.Mode = AddrModeFlat;
<a name="l00723"></a>00723                     frame.AddrPC.Offset = context.Eip;
<a name="l00724"></a>00724                     frame.AddrFrame.Mode = AddrModeFlat;
<a name="l00725"></a>00725                     frame.AddrFrame.Offset = context.Ebp;
<a name="l00726"></a>00726                     frame.AddrStack.Mode = AddrModeFlat;
<a name="l00727"></a>00727                     frame.AddrStack.Offset = context.Esp;
<a name="l00728"></a>00728 <span class="preprocessor">#endif</span>
<a name="l00729"></a>00729 <span class="preprocessor"></span>
<a name="l00730"></a>00730                     <span class="keywordflow">while</span> (pStackWalk64(mac, ph, th, &amp;frame, &amp;context, NULL,
<a name="l00731"></a>00731                                         NULL, NULL, NULL)) {
<a name="l00732"></a>00732                         DWORD64 addr = frame.AddrPC.Offset;
<a name="l00733"></a>00733                         IMAGEHLP_LINE64 line;
<a name="l00734"></a>00734                         DWORD64 displacement;
<a name="l00735"></a>00735                         DWORD tmp;
<a name="l00736"></a>00736 
<a name="l00737"></a>00737                         <span class="keywordflow">if</span> (addr == frame.AddrReturn.Offset || addr == 0 ||
<a name="l00738"></a>00738                             frame.AddrReturn.Offset == 0)
<a name="l00739"></a>00739                             <span class="keywordflow">break</span>;
<a name="l00740"></a>00740 
<a name="l00741"></a>00741                         memset(<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>));
<a name="l00742"></a>00742                         info-&gt;SizeOfStruct = <span class="keyword">sizeof</span>(SYMBOL_INFO);
<a name="l00743"></a>00743                         info-&gt;MaxNameLen = MAX_SYM_NAME;
<a name="l00744"></a>00744                         <span class="keywordflow">if</span> (pSymFromAddr(ph, addr, &amp;displacement, info)) {
<a name="l00745"></a>00745                             <span class="keywordflow">if</span> (GetModuleFileName((HANDLE)(<a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a>)pSymGetModuleBase64(ph, addr), libpath, <span class="keyword">sizeof</span>(libpath)))
<a name="l00746"></a>00746                                 fprintf(stderr, <span class="stringliteral">&quot;%s&quot;</span>, libpath);
<a name="l00747"></a>00747                             fprintf(stderr, <span class="stringliteral">&quot;(%s+0x%I64x)&quot;</span>,
<a name="l00748"></a>00748                                     info-&gt;Name, displacement);
<a name="l00749"></a>00749                         }
<a name="l00750"></a>00750                         fprintf(stderr, <span class="stringliteral">&quot; [0x%p]&quot;</span>, (<span class="keywordtype">void</span> *)(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)addr);
<a name="l00751"></a>00751                         memset(&amp;line, 0, <span class="keyword">sizeof</span>(line));
<a name="l00752"></a>00752                         line.SizeOfStruct = <span class="keyword">sizeof</span>(line);
<a name="l00753"></a>00753                         <span class="keywordflow">if</span> (pSymGetLineFromAddr64(ph, addr, &amp;tmp, &amp;line))
<a name="l00754"></a>00754                             fprintf(stderr, <span class="stringliteral">&quot; %s:%lu&quot;</span>, line.FileName, line.LineNumber);
<a name="l00755"></a>00755                         fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00756"></a>00756                     }
<a name="l00757"></a>00757                 }
<a name="l00758"></a>00758 
<a name="l00759"></a>00759                 ResumeThread(th);
<a name="l00760"></a>00760             }
<a name="l00761"></a>00761             CloseHandle(th);
<a name="l00762"></a>00762         }
<a name="l00763"></a>00763         pSymCleanup(ph);
<a name="l00764"></a>00764     }
<a name="l00765"></a>00765     FreeLibrary(dbghelp);
<a name="l00766"></a>00766 }
<a name="l00767"></a>00767 <span class="preprocessor">#endif</span>
<a name="l00768"></a>00768 <span class="preprocessor"></span>
<a name="l00769"></a>00769 <span class="keywordtype">void</span>
<a name="l00770"></a><a class="code" href="../../dd/dd7/vm__dump_8c.html#af1b67bbf4b72295a772178d0bd939dd0">00770</a> <a class="code" href="../../d8/d32/vm__core_8h.html#af1b67bbf4b72295a772178d0bd939dd0">rb_vm_bugreport</a>(<span class="keywordtype">void</span>)
<a name="l00771"></a>00771 {
<a name="l00772"></a>00772     <a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vm = <a class="code" href="../../d8/d32/vm__core_8h.html#a6cfcd3997994924c8cd13c3b5c099ec6">GET_VM</a>();
<a name="l00773"></a>00773     <span class="keywordflow">if</span> (vm) {
<a name="l00774"></a>00774         <span class="keywordtype">int</span> i = 0;
<a name="l00775"></a>00775         <a class="code" href="../../d8/d32/vm__core_8h.html#ac33c371d81972685538097cb4f49181f">SDR</a>();
<a name="l00776"></a>00776 
<a name="l00777"></a>00777         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a53d4377e7685dd916255009372937561">rb_backtrace_each</a>(<a class="code" href="../../dd/dd7/vm__dump_8c.html#ae5165393259e08cff52a6c3d66619217">bugreport_backtrace</a>, &amp;i)) {
<a name="l00778"></a>00778             fputs(<span class="stringliteral">&quot;\n&quot;</span>, stderr);
<a name="l00779"></a>00779         }
<a name="l00780"></a>00780     }
<a name="l00781"></a>00781 
<a name="l00782"></a>00782 <span class="preprocessor">#if HAVE_BACKTRACE || defined(_WIN32)</span>
<a name="l00783"></a>00783 <span class="preprocessor"></span>    fprintf(stderr, <span class="stringliteral">&quot;-- C level backtrace information &quot;</span>
<a name="l00784"></a>00784             <span class="stringliteral">&quot;-------------------------------------------\n&quot;</span>);
<a name="l00785"></a>00785 
<a name="l00786"></a>00786     {
<a name="l00787"></a>00787 <span class="preprocessor">#if defined __MACH__ &amp;&amp; defined __APPLE__</span>
<a name="l00788"></a>00788 <span class="preprocessor"></span>        fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00789"></a>00789         fprintf(stderr, <span class="stringliteral">&quot;   See Crash Report log file under &quot;</span>
<a name="l00790"></a>00790                 <span class="stringliteral">&quot;~/Library/Logs/CrashReporter or\n&quot;</span>);
<a name="l00791"></a>00791         fprintf(stderr, <span class="stringliteral">&quot;   /Library/Logs/CrashReporter, for &quot;</span>
<a name="l00792"></a>00792                 <span class="stringliteral">&quot;the more detail of.\n&quot;</span>);
<a name="l00793"></a>00793 <span class="preprocessor">#elif HAVE_BACKTRACE</span>
<a name="l00794"></a>00794 <span class="preprocessor"></span><span class="preprocessor">#define MAX_NATIVE_TRACE 1024</span>
<a name="l00795"></a>00795 <span class="preprocessor"></span>        <span class="keyword">static</span> <span class="keywordtype">void</span> *trace[MAX_NATIVE_TRACE];
<a name="l00796"></a>00796         <span class="keywordtype">int</span> n = backtrace(trace, MAX_NATIVE_TRACE);
<a name="l00797"></a>00797         <span class="keywordtype">char</span> **syms = backtrace_symbols(trace, n);
<a name="l00798"></a>00798 
<a name="l00799"></a>00799         <span class="keywordflow">if</span> (syms) {
<a name="l00800"></a>00800 <span class="preprocessor">#ifdef USE_ELF</span>
<a name="l00801"></a>00801 <span class="preprocessor"></span>            rb_dump_backtrace_with_lines(n, trace, syms);
<a name="l00802"></a>00802 <span class="preprocessor">#else</span>
<a name="l00803"></a>00803 <span class="preprocessor"></span>            <span class="keywordtype">int</span> i;
<a name="l00804"></a>00804             <span class="keywordflow">for</span> (i=0; i&lt;n; i++) {
<a name="l00805"></a>00805                 fprintf(stderr, <span class="stringliteral">&quot;%s\n&quot;</span>, syms[i]);
<a name="l00806"></a>00806             }
<a name="l00807"></a>00807 <span class="preprocessor">#endif</span>
<a name="l00808"></a>00808 <span class="preprocessor"></span>            <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(syms);
<a name="l00809"></a>00809         }
<a name="l00810"></a>00810 <span class="preprocessor">#elif defined(_WIN32)</span>
<a name="l00811"></a>00811 <span class="preprocessor"></span>        DWORD tid = GetCurrentThreadId();
<a name="l00812"></a>00812         HANDLE th = (HANDLE)_beginthread(dump_thread, 0, &amp;tid);
<a name="l00813"></a>00813         <span class="keywordflow">if</span> (th != (HANDLE)-1)
<a name="l00814"></a>00814             WaitForSingleObject(th, INFINITE);
<a name="l00815"></a>00815 <span class="preprocessor">#endif</span>
<a name="l00816"></a>00816 <span class="preprocessor"></span>    }
<a name="l00817"></a>00817 
<a name="l00818"></a>00818     fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00819"></a>00819 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_BACKTRACE */</span>
<a name="l00820"></a>00820 
<a name="l00821"></a>00821     fprintf(stderr, <span class="stringliteral">&quot;-- Other runtime information &quot;</span>
<a name="l00822"></a>00822             <span class="stringliteral">&quot;-----------------------------------------------\n\n&quot;</span>);
<a name="l00823"></a>00823     {
<a name="l00824"></a>00824         <span class="keywordtype">int</span> i;
<a name="l00825"></a>00825 
<a name="l00826"></a>00826         fprintf(stderr, <span class="stringliteral">&quot;* Loaded script: %s\n&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a0fabbe8c44aac34d9538388955e2b461">progname</a>));
<a name="l00827"></a>00827         fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00828"></a>00828         fprintf(stderr, <span class="stringliteral">&quot;* Loaded features:\n\n&quot;</span>);
<a name="l00829"></a>00829         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#adc9a2f20cba11e9a872bbe603b7db593">loaded_features</a>); i++) {
<a name="l00830"></a>00830             fprintf(stderr, <span class="stringliteral">&quot; %4d %s\n&quot;</span>, i, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(<a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#adc9a2f20cba11e9a872bbe603b7db593">loaded_features</a>)[i]));
<a name="l00831"></a>00831         }
<a name="l00832"></a>00832         fprintf(stderr, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00833"></a>00833 
<a name="l00834"></a>00834 <span class="preprocessor">#if __linux__</span>
<a name="l00835"></a>00835 <span class="preprocessor"></span>        {
<a name="l00836"></a>00836             <a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *fp = fopen(<span class="stringliteral">&quot;/proc/self/maps&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l00837"></a>00837             <span class="keywordflow">if</span> (fp) {
<a name="l00838"></a>00838                 fprintf(stderr, <span class="stringliteral">&quot;* Process memory map:\n\n&quot;</span>);
<a name="l00839"></a>00839 
<a name="l00840"></a>00840                 <span class="keywordflow">while</span> (!<a class="code" href="../../da/d50/vsnprintf_8c.html#ac752882e678e3368676e57e5eb4b9d86">feof</a>(fp)) {
<a name="l00841"></a>00841                     <span class="keywordtype">char</span> buff[0x100];
<a name="l00842"></a>00842                     <span class="keywordtype">size_t</span> rn = fread(buff, 1, 0x100, fp);
<a name="l00843"></a>00843                     fwrite(buff, 1, rn, stderr);
<a name="l00844"></a>00844                 }
<a name="l00845"></a>00845 
<a name="l00846"></a>00846                 fclose(fp);
<a name="l00847"></a>00847                 fprintf(stderr, <span class="stringliteral">&quot;\n\n&quot;</span>);
<a name="l00848"></a>00848             }
<a name="l00849"></a>00849         }
<a name="l00850"></a>00850 <span class="preprocessor">#endif </span><span class="comment">/* __linux__ */</span>
<a name="l00851"></a>00851     }
<a name="l00852"></a>00852 }
<a name="l00853"></a>00853 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Mar 2013 for Ruby by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
