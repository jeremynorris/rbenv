<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Ruby: ext/syck/yaml2byte.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>ext/syck/yaml2byte.c</h1><a href="../../dd/dfb/yaml2byte_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * yaml2byte.c</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * $Author: nobu $</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Copyright (C) 2003 why the lucky stiff, clark evans</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> *   WARNING WARNING WARNING  --- THIS IS *NOT JUST* PLAYING</span>
<a name="l00009"></a>00009 <span class="comment"> *   ANYMORE! -- WHY HAS EMBRACED THIS AS THE REAL THING!</span>
<a name="l00010"></a>00010 <span class="comment"> */</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;<a class="code" href="../../de/de6/ruby_2ruby_8h.html">ruby/ruby.h</a>&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &lt;<a class="code" href="../../de/dce/syck_8h.html">syck.h</a>&gt;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00014"></a><a class="code" href="../../dd/dfb/yaml2byte_8c.html#a5bda8753099fc6c9045ffcf4435f3475">00014</a> <span class="preprocessor">#define YAMLBYTE_UTF8</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="../../d9/d27/yamlbyte_8h.html">yamlbyte.h</a>&quot;</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00018"></a><a class="code" href="../../dd/dfb/yaml2byte_8c.html#a3646ddf41e00ea19dbc7b8119f61d8ec">00018</a> <span class="preprocessor">#define TRACE0(a)  \</span>
<a name="l00019"></a>00019 <span class="preprocessor">    do { printf(a); printf(&quot;\n&quot;); fflush(stdout); } while(0)</span>
<a name="l00020"></a><a class="code" href="../../dd/dfb/yaml2byte_8c.html#a627e1a0ca04a9a90b0127ed32e60694f">00020</a> <span class="preprocessor"></span><span class="preprocessor">#define TRACE1(a,b) \</span>
<a name="l00021"></a>00021 <span class="preprocessor">    do { printf(a,b); printf(&quot;\n&quot;); fflush(stdout); } while(0)</span>
<a name="l00022"></a><a class="code" href="../../dd/dfb/yaml2byte_8c.html#a0e859a58ed7b7965812359fd5ebd8884">00022</a> <span class="preprocessor"></span><span class="preprocessor">#define TRACE2(a,b,c) \</span>
<a name="l00023"></a>00023 <span class="preprocessor">    do { printf(a,b,c); printf(&quot;\n&quot;); fflush(stdout); } while(0)</span>
<a name="l00024"></a><a class="code" href="../../dd/dfb/yaml2byte_8c.html#aa3bc62099d041a3157320a4bc15d00fe">00024</a> <span class="preprocessor"></span><span class="preprocessor">#define TRACE3(a,b,c,d) \</span>
<a name="l00025"></a>00025 <span class="preprocessor">    do { printf(a,b,c,d); printf(&quot;\n&quot;); fflush(stdout); } while(0)</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span>
<a name="l00027"></a>00027 <span class="comment">/* Reinvent the wheel... */</span>
<a name="l00028"></a><a class="code" href="../../dd/dfb/yaml2byte_8c.html#a239bebe1697b474e6f84945e9fb9faee">00028</a> <span class="preprocessor">#define CHUNKSIZE 64</span>
<a name="l00029"></a><a class="code" href="../../dd/dfb/yaml2byte_8c.html#a7172fe24d1ffc31d15b20a77ea9f34dd">00029</a> <span class="preprocessor"></span><span class="preprocessor">#define HASH ((long)0xCAFECAFE)</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00031"></a>00031    <span class="keywordtype">long</span> <a class="code" href="../../d3/deb/lex_8c.html#a5541f85ce416df233cce93949f0eeeca">hash</a>;
<a name="l00032"></a>00032    <span class="keywordtype">char</span> *buffer;
<a name="l00033"></a>00033    <span class="keywordtype">long</span> length;
<a name="l00034"></a>00034    <span class="keywordtype">long</span> remaining;
<a name="l00035"></a>00035    <span class="keywordtype">int</span>  printed;
<a name="l00036"></a>00036 } <a class="code" href="../../d4/d81/structbytestring__t.html">bytestring_t</a>;
<a name="l00037"></a><a class="code" href="../../dd/dfb/yaml2byte_8c.html#aa5f2f049bcd08960e798696685f57ee2">00037</a> <a class="code" href="../../d4/d81/structbytestring__t.html">bytestring_t</a> *<a class="code" href="../../dd/dfb/yaml2byte_8c.html#aa5f2f049bcd08960e798696685f57ee2">bytestring_alloc</a>(<span class="keywordtype">void</span>) {
<a name="l00038"></a>00038     <a class="code" href="../../d4/d81/structbytestring__t.html">bytestring_t</a> *ret;
<a name="l00039"></a>00039     <span class="comment">/*TRACE0(&quot;bytestring_alloc()&quot;);*/</span>
<a name="l00040"></a>00040     ret = <a class="code" href="../../de/dce/syck_8h.html#a4114ec55b6f0ccb17ffb6faf8b617019">S_ALLOC</a>(<a class="code" href="../../d4/d81/structbytestring__t.html">bytestring_t</a>);
<a name="l00041"></a>00041     ret-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#af73c2dba44f067679dbc930d61d9a665">hash</a>   = <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a7172fe24d1ffc31d15b20a77ea9f34dd">HASH</a>;
<a name="l00042"></a>00042     ret-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a8ad80c0e72a4de30b6bd05d62ee0e4df">length</a> = <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a239bebe1697b474e6f84945e9fb9faee">CHUNKSIZE</a>;
<a name="l00043"></a>00043     ret-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a49943d67cb29cfa1ceaab7dad14bff26">remaining</a> = ret-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a8ad80c0e72a4de30b6bd05d62ee0e4df">length</a>;
<a name="l00044"></a>00044     ret-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a97b2e8dc7d844178fc5a066b48e9bcaf">buffer</a> = <a class="code" href="../../de/dce/syck_8h.html#a2d20ec6949b5978b35b88eedf43f36ff">S_ALLOC_N</a>(<span class="keywordtype">char</span>, ret-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a8ad80c0e72a4de30b6bd05d62ee0e4df">length</a> + 1 );
<a name="l00045"></a>00045     ret-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a97b2e8dc7d844178fc5a066b48e9bcaf">buffer</a>[0] = 0;
<a name="l00046"></a>00046     ret-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#ae9f36dbfad0eeb3f630a3988a4344908">printed</a> = 0;
<a name="l00047"></a>00047     <span class="keywordflow">return</span> ret;
<a name="l00048"></a>00048 }
<a name="l00049"></a><a class="code" href="../../dd/dfb/yaml2byte_8c.html#a34c038047e70a4bf0994bec114ad8523">00049</a> <span class="keywordtype">void</span> <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a34c038047e70a4bf0994bec114ad8523">bytestring_append</a>(<a class="code" href="../../d4/d81/structbytestring__t.html">bytestring_t</a> *str, <span class="keywordtype">char</span> code,
<a name="l00050"></a>00050                        <span class="keywordtype">char</span> *start, <span class="keywordtype">char</span> *finish)
<a name="l00051"></a>00051 {
<a name="l00052"></a>00052     <span class="keywordtype">long</span> grow;
<a name="l00053"></a>00053     <span class="keywordtype">long</span> length = 2;   <span class="comment">/* CODE + LF */</span>
<a name="l00054"></a>00054     <span class="keywordtype">char</span> *curr;
<a name="l00055"></a>00055     <a class="code" href="../../d5/dac/ossl_8h.html#acdcc5aaebf3f273c1762f24a6ece2e5e">assert</a>(str &amp;&amp; <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a7172fe24d1ffc31d15b20a77ea9f34dd">HASH</a> == str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#af73c2dba44f067679dbc930d61d9a665">hash</a>);
<a name="l00056"></a>00056     <span class="comment">/*TRACE0(&quot;bytestring_append()&quot;);*/</span>
<a name="l00057"></a>00057     <span class="keywordflow">if</span>(start) {
<a name="l00058"></a>00058         <span class="keywordflow">if</span>(!finish)
<a name="l00059"></a>00059             finish = start + <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(start);
<a name="l00060"></a>00060         length += (finish-start);
<a name="l00061"></a>00061     }
<a name="l00062"></a>00062     <span class="keywordflow">if</span>(length &gt; str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a49943d67cb29cfa1ceaab7dad14bff26">remaining</a>) {
<a name="l00063"></a>00063         grow = (length - str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a49943d67cb29cfa1ceaab7dad14bff26">remaining</a>) + <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a239bebe1697b474e6f84945e9fb9faee">CHUNKSIZE</a>;
<a name="l00064"></a>00064         str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a49943d67cb29cfa1ceaab7dad14bff26">remaining</a> += grow;
<a name="l00065"></a>00065         str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a8ad80c0e72a4de30b6bd05d62ee0e4df">length</a>    += grow;
<a name="l00066"></a>00066         <a class="code" href="../../de/dce/syck_8h.html#a8e4e47dc8e12e09341df3edce2825334">S_REALLOC_N</a>( str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a97b2e8dc7d844178fc5a066b48e9bcaf">buffer</a>, <span class="keywordtype">char</span>, str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a8ad80c0e72a4de30b6bd05d62ee0e4df">length</a> + 1 );
<a name="l00067"></a>00067         <a class="code" href="../../d5/dac/ossl_8h.html#acdcc5aaebf3f273c1762f24a6ece2e5e">assert</a>(str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a97b2e8dc7d844178fc5a066b48e9bcaf">buffer</a>);
<a name="l00068"></a>00068     }
<a name="l00069"></a>00069     curr = str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a97b2e8dc7d844178fc5a066b48e9bcaf">buffer</a> + (str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a8ad80c0e72a4de30b6bd05d62ee0e4df">length</a> - str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a49943d67cb29cfa1ceaab7dad14bff26">remaining</a>);
<a name="l00070"></a>00070     *curr = code;
<a name="l00071"></a>00071     curr += 1;
<a name="l00072"></a>00072     <span class="keywordflow">if</span>(start)
<a name="l00073"></a>00073         <span class="keywordflow">while</span>(start &lt; finish)
<a name="l00074"></a>00074             *curr ++ = *start ++;
<a name="l00075"></a>00075     *curr = <span class="charliteral">&apos;\n&apos;</span>;
<a name="l00076"></a>00076     curr += 1;
<a name="l00077"></a>00077     *curr = 0;
<a name="l00078"></a>00078     str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a49943d67cb29cfa1ceaab7dad14bff26">remaining</a> = str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a49943d67cb29cfa1ceaab7dad14bff26">remaining</a> - length;
<a name="l00079"></a>00079     <a class="code" href="../../d5/dac/ossl_8h.html#acdcc5aaebf3f273c1762f24a6ece2e5e">assert</a>( (str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a97b2e8dc7d844178fc5a066b48e9bcaf">buffer</a> + str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a8ad80c0e72a4de30b6bd05d62ee0e4df">length</a>) - str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a49943d67cb29cfa1ceaab7dad14bff26">remaining</a> );
<a name="l00080"></a>00080 }
<a name="l00081"></a><a class="code" href="../../dd/dfb/yaml2byte_8c.html#a04ca234016d90ced736f74e6bf5c0172">00081</a> <span class="keywordtype">void</span> <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a04ca234016d90ced736f74e6bf5c0172">bytestring_extend</a>(<a class="code" href="../../d4/d81/structbytestring__t.html">bytestring_t</a> *str, <a class="code" href="../../d4/d81/structbytestring__t.html">bytestring_t</a> *ext)
<a name="l00082"></a>00082 {
<a name="l00083"></a>00083     <span class="keywordtype">char</span> *from;
<a name="l00084"></a>00084     <span class="keywordtype">char</span> *curr;
<a name="l00085"></a>00085     <span class="keywordtype">char</span> *stop;
<a name="l00086"></a>00086     <span class="keywordtype">long</span> grow;
<a name="l00087"></a>00087     <span class="keywordtype">long</span> length;
<a name="l00088"></a>00088     <a class="code" href="../../d5/dac/ossl_8h.html#acdcc5aaebf3f273c1762f24a6ece2e5e">assert</a>(str &amp;&amp; <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a7172fe24d1ffc31d15b20a77ea9f34dd">HASH</a> == str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#af73c2dba44f067679dbc930d61d9a665">hash</a>);
<a name="l00089"></a>00089     <a class="code" href="../../d5/dac/ossl_8h.html#acdcc5aaebf3f273c1762f24a6ece2e5e">assert</a>(ext &amp;&amp; <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a7172fe24d1ffc31d15b20a77ea9f34dd">HASH</a> == ext-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#af73c2dba44f067679dbc930d61d9a665">hash</a>);
<a name="l00090"></a>00090     <span class="keywordflow">if</span>(ext-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#ae9f36dbfad0eeb3f630a3988a4344908">printed</a>) {
<a name="l00091"></a>00091         <a class="code" href="../../d5/dac/ossl_8h.html#acdcc5aaebf3f273c1762f24a6ece2e5e">assert</a>(ext-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a97b2e8dc7d844178fc5a066b48e9bcaf">buffer</a>[0] ==<a class="code" href="../../d9/d27/yamlbyte_8h.html#a1dac5decea2c00985f2bf31e49517ea5">YAMLBYTE_ANCHOR</a>);
<a name="l00092"></a>00092         curr = ext-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a97b2e8dc7d844178fc5a066b48e9bcaf">buffer</a>;
<a name="l00093"></a>00093         <span class="keywordflow">while</span>( <span class="charliteral">&apos;\n&apos;</span> != *curr)
<a name="l00094"></a>00094             curr++;
<a name="l00095"></a>00095         <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a34c038047e70a4bf0994bec114ad8523">bytestring_append</a>(str, <a class="code" href="../../d9/d27/yamlbyte_8h.html#aa0080a137257927dbb1c182cbe9309c5">YAMLBYTE_ALIAS</a>, ext-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a97b2e8dc7d844178fc5a066b48e9bcaf">buffer</a> + 1, curr);
<a name="l00096"></a>00096     } <span class="keywordflow">else</span> {
<a name="l00097"></a>00097         ext-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#ae9f36dbfad0eeb3f630a3988a4344908">printed</a> = 1;
<a name="l00098"></a>00098         length  = (ext-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a8ad80c0e72a4de30b6bd05d62ee0e4df">length</a> - ext-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a49943d67cb29cfa1ceaab7dad14bff26">remaining</a>);
<a name="l00099"></a>00099         <span class="keywordflow">if</span>(length &gt; str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a49943d67cb29cfa1ceaab7dad14bff26">remaining</a>) {
<a name="l00100"></a>00100             grow = (length - str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a49943d67cb29cfa1ceaab7dad14bff26">remaining</a>) + <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a239bebe1697b474e6f84945e9fb9faee">CHUNKSIZE</a>;
<a name="l00101"></a>00101             str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a49943d67cb29cfa1ceaab7dad14bff26">remaining</a> += grow;
<a name="l00102"></a>00102             str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a8ad80c0e72a4de30b6bd05d62ee0e4df">length</a>    += grow;
<a name="l00103"></a>00103             <a class="code" href="../../de/dce/syck_8h.html#a8e4e47dc8e12e09341df3edce2825334">S_REALLOC_N</a>( str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a97b2e8dc7d844178fc5a066b48e9bcaf">buffer</a>, <span class="keywordtype">char</span>, str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a8ad80c0e72a4de30b6bd05d62ee0e4df">length</a> + 1 );
<a name="l00104"></a>00104         }
<a name="l00105"></a>00105         curr = str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a97b2e8dc7d844178fc5a066b48e9bcaf">buffer</a> + (str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a8ad80c0e72a4de30b6bd05d62ee0e4df">length</a> - str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a49943d67cb29cfa1ceaab7dad14bff26">remaining</a>);
<a name="l00106"></a>00106         from = ext-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a97b2e8dc7d844178fc5a066b48e9bcaf">buffer</a>;
<a name="l00107"></a>00107         stop = ext-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a97b2e8dc7d844178fc5a066b48e9bcaf">buffer</a> + length;
<a name="l00108"></a>00108         <span class="keywordflow">while</span>( from &lt; stop )
<a name="l00109"></a>00109             *curr ++ = *from ++;
<a name="l00110"></a>00110         *curr = 0;
<a name="l00111"></a>00111         str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a49943d67cb29cfa1ceaab7dad14bff26">remaining</a> = str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a49943d67cb29cfa1ceaab7dad14bff26">remaining</a> - length;
<a name="l00112"></a>00112         <a class="code" href="../../d5/dac/ossl_8h.html#acdcc5aaebf3f273c1762f24a6ece2e5e">assert</a>( (str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a97b2e8dc7d844178fc5a066b48e9bcaf">buffer</a> + str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a8ad80c0e72a4de30b6bd05d62ee0e4df">length</a>) - str-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a49943d67cb29cfa1ceaab7dad14bff26">remaining</a> );
<a name="l00113"></a>00113     }
<a name="l00114"></a>00114 }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 <span class="comment">/* convert SyckNode into yamlbyte_buffer_t objects */</span>
<a name="l00117"></a>00117 <a class="code" href="../../de/dce/syck_8h.html#a4e170963ed89a5ec1a7e8ffedc8c0b3b">SYMID</a>
<a name="l00118"></a><a class="code" href="../../dd/dfb/yaml2byte_8c.html#aec57c86cd85c89de9cb7576a56016990">00118</a> <a class="code" href="../../de/dce/syck_8h.html#a2423f29aeb99a165257d92077e450849">syck_yaml2byte_handler</a>(p, n)
<a name="l00119"></a>00119     <a class="code" href="../../db/d41/struct__syck__parser.html">SyckParser</a> *p;
<a name="l00120"></a>00120     <a class="code" href="../../df/dfc/struct__syck__node.html">SyckNode</a> *n;
<a name="l00121"></a>00121 {
<a name="l00122"></a>00122     <a class="code" href="../../de/dce/syck_8h.html#a4e170963ed89a5ec1a7e8ffedc8c0b3b">SYMID</a> oid;
<a name="l00123"></a>00123     <span class="keywordtype">long</span> i;
<a name="l00124"></a>00124     <span class="keywordtype">char</span> ch;
<a name="l00125"></a>00125     <span class="keywordtype">char</span> nextcode;
<a name="l00126"></a>00126     <span class="keywordtype">char</span> *start;
<a name="l00127"></a>00127     <span class="keywordtype">char</span> *current;
<a name="l00128"></a>00128     <span class="keywordtype">char</span> *finish;
<a name="l00129"></a>00129     <a class="code" href="../../d4/d81/structbytestring__t.html">bytestring_t</a> *val = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00130"></a>00130     <a class="code" href="../../d4/d81/structbytestring__t.html">bytestring_t</a> *sav = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00131"></a>00131     <span class="keywordtype">void</span> *data;
<a name="l00132"></a>00132     <span class="comment">/*TRACE0(&quot;syck_yaml2byte_handler()&quot;);*/</span>
<a name="l00133"></a>00133     val = <a class="code" href="../../dd/dfb/yaml2byte_8c.html#aa5f2f049bcd08960e798696685f57ee2">bytestring_alloc</a>();
<a name="l00134"></a>00134     <span class="keywordflow">if</span>(n-&gt;<a class="code" href="../../df/dfc/struct__syck__node.html#aa4af6d7d3f900f18531f8298a5dcff98">anchor</a>) <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a34c038047e70a4bf0994bec114ad8523">bytestring_append</a>(val,<a class="code" href="../../d9/d27/yamlbyte_8h.html#a1dac5decea2c00985f2bf31e49517ea5">YAMLBYTE_ANCHOR</a>, n-&gt;<a class="code" href="../../df/dfc/struct__syck__node.html#aa4af6d7d3f900f18531f8298a5dcff98">anchor</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00135"></a>00135     <span class="keywordflow">if</span> ( n-&gt;<a class="code" href="../../df/dfc/struct__syck__node.html#a29efc25fc63be0b2b4af16c23630adc9">type_id</a> )
<a name="l00136"></a>00136     {
<a name="l00137"></a>00137         <span class="keywordflow">if</span> ( p-&gt;taguri_expansion )
<a name="l00138"></a>00138         {
<a name="l00139"></a>00139             <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a34c038047e70a4bf0994bec114ad8523">bytestring_append</a>(val,<a class="code" href="../../d9/d27/yamlbyte_8h.html#aa7f400192e8adb8692533492690bda4c">YAMLBYTE_TRANSFER</a>, n-&gt;<a class="code" href="../../df/dfc/struct__syck__node.html#a29efc25fc63be0b2b4af16c23630adc9">type_id</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00140"></a>00140         }
<a name="l00141"></a>00141         <span class="keywordflow">else</span>
<a name="l00142"></a>00142         {
<a name="l00143"></a>00143             <span class="keywordtype">char</span> *type_tag = <a class="code" href="../../de/dce/syck_8h.html#a2d20ec6949b5978b35b88eedf43f36ff">S_ALLOC_N</a>( <span class="keywordtype">char</span>, <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>( n-&gt;<a class="code" href="../../df/dfc/struct__syck__node.html#a29efc25fc63be0b2b4af16c23630adc9">type_id</a> ) + 1 );
<a name="l00144"></a>00144             type_tag[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00145"></a>00145             strcat( type_tag, <span class="stringliteral">&quot;!&quot;</span> );
<a name="l00146"></a>00146             strcat( type_tag, n-&gt;<a class="code" href="../../df/dfc/struct__syck__node.html#a29efc25fc63be0b2b4af16c23630adc9">type_id</a> );
<a name="l00147"></a>00147             <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a34c038047e70a4bf0994bec114ad8523">bytestring_append</a>( val, <a class="code" href="../../d9/d27/yamlbyte_8h.html#aa7f400192e8adb8692533492690bda4c">YAMLBYTE_TRANSFER</a>, type_tag, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00148"></a>00148             <a class="code" href="../../de/dce/syck_8h.html#a59b854f4bc2b7cd8e19c75600deeb24d">S_FREE</a>(type_tag);
<a name="l00149"></a>00149         }
<a name="l00150"></a>00150     }
<a name="l00151"></a>00151     <span class="keywordflow">switch</span> (n-&gt;<a class="code" href="../../df/dfc/struct__syck__node.html#a7a01ec5b99a80be73a0d2d835e2cf778">kind</a>)
<a name="l00152"></a>00152     {
<a name="l00153"></a>00153         <span class="keywordflow">case</span> <a class="code" href="../../de/dce/syck_8h.html#ac1653bff2ff10775586c402316b9b733a216d57d7deae9b0632040d9d185605f4">syck_str_kind</a>:
<a name="l00154"></a>00154             nextcode = <a class="code" href="../../d9/d27/yamlbyte_8h.html#a86d34c436b3fdd1f5917e3f7c5b8ddc9">YAMLBYTE_SCALAR</a>;
<a name="l00155"></a>00155             start  = n-&gt;<a class="code" href="../../df/dfc/struct__syck__node.html#a4006b884b0cbad19942f70d16799b704">data</a>.<a class="code" href="../../df/dfc/struct__syck__node.html#a58578ada0ba308f913e4301cb8d6e146">str</a>-&gt;ptr;
<a name="l00156"></a>00156             finish = start + n-&gt;<a class="code" href="../../df/dfc/struct__syck__node.html#a4006b884b0cbad19942f70d16799b704">data</a>.<a class="code" href="../../df/dfc/struct__syck__node.html#a58578ada0ba308f913e4301cb8d6e146">str</a>-&gt;len - 1;
<a name="l00157"></a>00157             current = start;
<a name="l00158"></a>00158             <span class="comment">/*TRACE2(&quot;SCALAR: %s %d&quot;, start, n-&gt;data.str-&gt;len); */</span>
<a name="l00159"></a>00159             <span class="keywordflow">while</span>(1) {
<a name="l00160"></a>00160                 ch = *current;
<a name="l00161"></a>00161                 <span class="keywordflow">if</span>(<span class="charliteral">&apos;\n&apos;</span> == ch || 0 == ch || current &gt; finish) {
<a name="l00162"></a>00162                     <span class="keywordflow">if</span>(current &gt;= start) {
<a name="l00163"></a>00163                         <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a34c038047e70a4bf0994bec114ad8523">bytestring_append</a>(val, nextcode, start, current);
<a name="l00164"></a>00164                         nextcode = <a class="code" href="../../d9/d27/yamlbyte_8h.html#a976866e0c67e824c9b9af0b24e05e142">YAMLBYTE_CONTINUE</a>;
<a name="l00165"></a>00165                     }
<a name="l00166"></a>00166                     start = current + 1;
<a name="l00167"></a>00167                     <span class="keywordflow">if</span>(current &gt; finish)
<a name="l00168"></a>00168                     {
<a name="l00169"></a>00169                         <span class="keywordflow">break</span>;
<a name="l00170"></a>00170                     }
<a name="l00171"></a>00171                     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<span class="charliteral">&apos;\n&apos;</span> == ch )
<a name="l00172"></a>00172                     {
<a name="l00173"></a>00173                         <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a34c038047e70a4bf0994bec114ad8523">bytestring_append</a>(val,<a class="code" href="../../d9/d27/yamlbyte_8h.html#a4c945d21df29feebc4788e89c1475dd6">YAMLBYTE_NEWLINE</a>,<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00174"></a>00174                     }
<a name="l00175"></a>00175                     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(0 == ch)
<a name="l00176"></a>00176                     {
<a name="l00177"></a>00177                         <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a34c038047e70a4bf0994bec114ad8523">bytestring_append</a>(val,<a class="code" href="../../d9/d27/yamlbyte_8h.html#a34c500e264ec9be2aec4677c4daaadf0">YAMLBYTE_NULLCHAR</a>,<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00178"></a>00178                     }
<a name="l00179"></a>00179                     <span class="keywordflow">else</span>
<a name="l00180"></a>00180                     {
<a name="l00181"></a>00181                         <a class="code" href="../../d5/dac/ossl_8h.html#acdcc5aaebf3f273c1762f24a6ece2e5e">assert</a>(<span class="stringliteral">&quot;oops&quot;</span>);
<a name="l00182"></a>00182                     }
<a name="l00183"></a>00183                 }
<a name="l00184"></a>00184                 current += 1;
<a name="l00185"></a>00185             }
<a name="l00186"></a>00186         <span class="keywordflow">break</span>;
<a name="l00187"></a>00187         <span class="keywordflow">case</span> <a class="code" href="../../de/dce/syck_8h.html#ac1653bff2ff10775586c402316b9b733ab3ee44dfdcd52f7580a5ff6b46e53794">syck_seq_kind</a>:
<a name="l00188"></a>00188             <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a34c038047e70a4bf0994bec114ad8523">bytestring_append</a>(val,<a class="code" href="../../d9/d27/yamlbyte_8h.html#ab4d313bd0fb44fbaa752f4318e6f33be">YAMLBYTE_SEQUENCE</a>,<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00189"></a>00189             <span class="keywordflow">for</span> ( i = 0; i &lt; n-&gt;<a class="code" href="../../df/dfc/struct__syck__node.html#a4006b884b0cbad19942f70d16799b704">data</a>.<a class="code" href="../../df/dfc/struct__syck__node.html#aa5a5a77abca1a802e70b775b0da6c758">list</a>-&gt;idx; i++ )
<a name="l00190"></a>00190             {
<a name="l00191"></a>00191                 oid = <a class="code" href="../../d3/d18/ext_2syck_2node_8c.html#a974bbb9d9a1483fbb3198f784a8775fa">syck_seq_read</a>( n, i );
<a name="l00192"></a>00192                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7b/syck_8c.html#a0b7d95c9fbc68067b007ced0be4140d2">syck_lookup_sym</a>( p, oid, &amp;data )) sav = data;
<a name="l00193"></a>00193                 <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a04ca234016d90ced736f74e6bf5c0172">bytestring_extend</a>(val, sav);
<a name="l00194"></a>00194             }
<a name="l00195"></a>00195             <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a34c038047e70a4bf0994bec114ad8523">bytestring_append</a>(val,<a class="code" href="../../d9/d27/yamlbyte_8h.html#a3b22fcea441a6c89bd9b8487e3470066">YAMLBYTE_END_BRANCH</a>,<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00196"></a>00196         <span class="keywordflow">break</span>;
<a name="l00197"></a>00197         <span class="keywordflow">case</span> <a class="code" href="../../de/dce/syck_8h.html#ac1653bff2ff10775586c402316b9b733a992c3dbceb31f3bbf053fb2170fd307c">syck_map_kind</a>:
<a name="l00198"></a>00198             <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a34c038047e70a4bf0994bec114ad8523">bytestring_append</a>(val,<a class="code" href="../../d9/d27/yamlbyte_8h.html#a9428f8adb8cc7859527e17329ec370de">YAMLBYTE_MAPPING</a>,<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00199"></a>00199             <span class="keywordflow">for</span> ( i = 0; i &lt; n-&gt;<a class="code" href="../../df/dfc/struct__syck__node.html#a4006b884b0cbad19942f70d16799b704">data</a>.<a class="code" href="../../df/dfc/struct__syck__node.html#ae8c872c04b50917d6bf991629e8517f8">pairs</a>-&gt;idx; i++ )
<a name="l00200"></a>00200             {
<a name="l00201"></a>00201                 oid = <a class="code" href="../../d3/d18/ext_2syck_2node_8c.html#a705a2150acabae4566144d403c5eb6b0">syck_map_read</a>( n, <a class="code" href="../../de/dce/syck_8h.html#a548f9720218a1c09fb08e0b984c8f6a4a61d8cfcab139ffb67ab78027950729ff">map_key</a>, i );
<a name="l00202"></a>00202                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7b/syck_8c.html#a0b7d95c9fbc68067b007ced0be4140d2">syck_lookup_sym</a>( p, oid, &amp;data )) sav = data;
<a name="l00203"></a>00203                 <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a04ca234016d90ced736f74e6bf5c0172">bytestring_extend</a>(val, sav);
<a name="l00204"></a>00204                 oid = <a class="code" href="../../d3/d18/ext_2syck_2node_8c.html#a705a2150acabae4566144d403c5eb6b0">syck_map_read</a>( n, <a class="code" href="../../de/dce/syck_8h.html#a548f9720218a1c09fb08e0b984c8f6a4af7f7f627a79b093a48b160f9f9d53ec2">map_value</a>, i );
<a name="l00205"></a>00205                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7b/syck_8c.html#a0b7d95c9fbc68067b007ced0be4140d2">syck_lookup_sym</a>( p, oid, &amp;data )) sav = data;
<a name="l00206"></a>00206                 <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a04ca234016d90ced736f74e6bf5c0172">bytestring_extend</a>(val, sav);
<a name="l00207"></a>00207             }
<a name="l00208"></a>00208             <a class="code" href="../../dd/dfb/yaml2byte_8c.html#a34c038047e70a4bf0994bec114ad8523">bytestring_append</a>(val,<a class="code" href="../../d9/d27/yamlbyte_8h.html#a3b22fcea441a6c89bd9b8487e3470066">YAMLBYTE_END_BRANCH</a>,<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00209"></a>00209         <span class="keywordflow">break</span>;
<a name="l00210"></a>00210     }
<a name="l00211"></a>00211     oid = <a class="code" href="../../d1/d7b/syck_8c.html#ad22814d798d33704cbad597d252e2a69">syck_add_sym</a>( p, (<span class="keywordtype">char</span> *) val );
<a name="l00212"></a>00212     <span class="comment">/*TRACE1(&quot;Saving: %s&quot;, val-&gt;buffer );*/</span>
<a name="l00213"></a>00213     <span class="keywordflow">return</span> oid;
<a name="l00214"></a>00214 }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 <span class="keywordtype">char</span> *
<a name="l00217"></a><a class="code" href="../../dd/dfb/yaml2byte_8c.html#a55c087a447e8a4477cf0b912018ab606">00217</a> <a class="code" href="../../de/dce/syck_8h.html#a6a1663a771d8cb2ba1d9f12b32117692">syck_yaml2byte</a>(<span class="keywordtype">char</span> *yamlstr)
<a name="l00218"></a>00218 {
<a name="l00219"></a>00219     <a class="code" href="../../de/dce/syck_8h.html#a4e170963ed89a5ec1a7e8ffedc8c0b3b">SYMID</a> oid;
<a name="l00220"></a>00220     <span class="keywordtype">char</span> *ret;
<a name="l00221"></a>00221     <a class="code" href="../../d4/d81/structbytestring__t.html">bytestring_t</a> *sav;
<a name="l00222"></a>00222     <span class="keywordtype">void</span> *data;
<a name="l00223"></a>00223 
<a name="l00224"></a>00224     <a class="code" href="../../db/d41/struct__syck__parser.html">SyckParser</a> *parser = <a class="code" href="../../d1/d7b/syck_8c.html#a4e5c1f22c72cb41aa35cd1eb6b116ad6">syck_new_parser</a>();
<a name="l00225"></a>00225     <a class="code" href="../../d1/d7b/syck_8c.html#afaf8639371d69c2a94c01117e1e72f59">syck_parser_str_auto</a>( parser, yamlstr, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> );
<a name="l00226"></a>00226     <a class="code" href="../../d1/d7b/syck_8c.html#acdc6b9b29c306f28fc5253aff7821c24">syck_parser_handler</a>( parser, <a class="code" href="../../de/dce/syck_8h.html#a2423f29aeb99a165257d92077e450849">syck_yaml2byte_handler</a> );
<a name="l00227"></a>00227     <a class="code" href="../../d1/d7b/syck_8c.html#ab78f670894c6d59ebe330e0674a07af4">syck_parser_error_handler</a>( parser, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> );
<a name="l00228"></a>00228     <a class="code" href="../../d1/d7b/syck_8c.html#a398f38ffe519acd9c4153baea31375cf">syck_parser_implicit_typing</a>( parser, 1 );
<a name="l00229"></a>00229     <a class="code" href="../../d1/d7b/syck_8c.html#ad226f7c7f90bfc890ef1296b2e29c138">syck_parser_taguri_expansion</a>( parser, 1 );
<a name="l00230"></a>00230     oid = <a class="code" href="../../d1/d7b/syck_8c.html#a147faa73ff151288ba6b8574a0d82e1b">syck_parse</a>( parser );
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d7b/syck_8c.html#a0b7d95c9fbc68067b007ced0be4140d2">syck_lookup_sym</a>( parser, oid, &amp;data ) ) {
<a name="l00233"></a>00233         sav = data;
<a name="l00234"></a>00234         ret = <a class="code" href="../../de/dce/syck_8h.html#a2d20ec6949b5978b35b88eedf43f36ff">S_ALLOC_N</a>( <span class="keywordtype">char</span>, <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>( sav-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a97b2e8dc7d844178fc5a066b48e9bcaf">buffer</a> ) + 3 );
<a name="l00235"></a>00235         ret[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00236"></a>00236         strcat( ret, <span class="stringliteral">&quot;D\n&quot;</span> );
<a name="l00237"></a>00237         strcat( ret, sav-&gt;<a class="code" href="../../d4/d81/structbytestring__t.html#a97b2e8dc7d844178fc5a066b48e9bcaf">buffer</a> );
<a name="l00238"></a>00238     }
<a name="l00239"></a>00239     <span class="keywordflow">else</span>
<a name="l00240"></a>00240     {
<a name="l00241"></a>00241         ret = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00242"></a>00242     }
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     <a class="code" href="../../d1/d7b/syck_8c.html#a804cfaeb2b7a420b8be2eb6ca924971f">syck_free_parser</a>( parser );
<a name="l00245"></a>00245     <span class="keywordflow">return</span> ret;
<a name="l00246"></a>00246 }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 <span class="preprocessor">#ifdef TEST_YBEXT</span>
<a name="l00249"></a>00249 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00250"></a>00250 <span class="keywordtype">int</span> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a3c04138a5bfe5d72780bb7e82a18e627">main</a>() {
<a name="l00251"></a>00251    <span class="keywordtype">char</span> *yaml = <span class="stringliteral">&quot;test: 1\nand: \&quot;with new\\nline\\n\&quot;\nalso: &amp;3 three\nmore: *3&quot;</span>;
<a name="l00252"></a>00252    printf(<span class="stringliteral">&quot;--- # YAML \n&quot;</span>);
<a name="l00253"></a>00253    printf(yaml);
<a name="l00254"></a>00254    printf(<span class="stringliteral">&quot;\n...\n&quot;</span>);
<a name="l00255"></a>00255    printf(<a class="code" href="../../de/dce/syck_8h.html#a6a1663a771d8cb2ba1d9f12b32117692">syck_yaml2byte</a>(yaml));
<a name="l00256"></a>00256    <span class="keywordflow">return</span> 0;
<a name="l00257"></a>00257 }
<a name="l00258"></a>00258 <span class="preprocessor">#endif</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span>
<a name="l00260"></a>00260 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Mar 2013 for Ruby by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
