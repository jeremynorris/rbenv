<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Ruby: thread_win32.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>thread_win32.c</h1><a href="../../dd/d55/thread__win32_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* -*-c-*- */</span>
<a name="l00002"></a>00002 <span class="comment">/**********************************************************************</span>
<a name="l00003"></a>00003 <span class="comment"></span>
<a name="l00004"></a>00004 <span class="comment">  thread_win32.c -</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">  $Author: ko1 $</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment">  Copyright (C) 2004-2007 Koichi Sasada</span>
<a name="l00009"></a>00009 <span class="comment"></span>
<a name="l00010"></a>00010 <span class="comment">**********************************************************************/</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="preprocessor">#ifdef THREAD_SYSTEM_DEPENDENT_IMPLEMENTATION</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;process.h&gt;</span>
<a name="l00015"></a>00015 
<a name="l00016"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a0f616a99e12253578753bd5b6d4d7b08">00016</a> <span class="preprocessor">#define TIME_QUANTUM_USEC (100 * 1000)</span>
<a name="l00017"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#aba3e08d6b365b232c499d22a59908941">00017</a> <span class="preprocessor"></span><span class="preprocessor">#define RB_CONDATTR_CLOCK_MONOTONIC 1 </span><span class="comment">/* no effect */</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#undef Sleep</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span>
<a name="l00021"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a2eb53d5797cb97f1880947806d57d592">00021</a> <span class="preprocessor">#define native_thread_yield() Sleep(0)</span>
<a name="l00022"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#aa3b4048f842b0cb998c29b4ce052e6b8">00022</a> <span class="preprocessor"></span><span class="preprocessor">#define remove_signal_thread_list(th)</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span>
<a name="l00024"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a3c356d0ad5910784ed30dcf24990f985">00024</a> <span class="keyword">static</span> <span class="keyword">volatile</span> <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a3c356d0ad5910784ed30dcf24990f985">ruby_native_thread_key</a> = TLS_OUT_OF_INDEXES;
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/d55/thread__win32_8c.html#af545ea55128fbeb4784719faef9cb79b">w32_wait_events</a>(HANDLE *events, <span class="keywordtype">int</span> <a class="code" href="../../d5/db5/encoding_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>, <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> timeout, <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th);
<a name="l00027"></a>00027 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/d55/thread__win32_8c.html#ad9b8bad99bfb94fad8030038da1987b7">native_mutex_lock</a>(<a class="code" href="../../d2/d82/thread__pthread_8h.html#aad27e6c1e30cf79f10930122e8ae405e">rb_thread_lock_t</a> *lock);
<a name="l00028"></a>00028 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../dd/d55/thread__win32_8c.html#a3d698f06306ed5992e6f4fe1be7bad13">native_mutex_unlock</a>(<a class="code" href="../../d2/d82/thread__pthread_8h.html#aad27e6c1e30cf79f10930122e8ae405e">rb_thread_lock_t</a> *lock);
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00031"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a5aee49bd66acca743b8adca9ce63d939">00031</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a5aee49bd66acca743b8adca9ce63d939">w32_error</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a>)
<a name="l00032"></a>00032 {
<a name="l00033"></a>00033     LPVOID lpMsgBuf;
<a name="l00034"></a>00034     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a> = GetLastError();
<a name="l00035"></a>00035     <span class="keywordflow">if</span> (FormatMessage(FORMAT_MESSAGE_ALLOCATE_BUFFER |
<a name="l00036"></a>00036                       FORMAT_MESSAGE_FROM_SYSTEM |
<a name="l00037"></a>00037                       FORMAT_MESSAGE_IGNORE_INSERTS,
<a name="l00038"></a>00038                       <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00039"></a>00039                       err,
<a name="l00040"></a>00040                       MAKELANGID(LANG_ENGLISH, SUBLANG_ENGLISH_US),
<a name="l00041"></a>00041                       (LPTSTR) &amp; lpMsgBuf, 0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) == 0)
<a name="l00042"></a>00042         FormatMessage(FORMAT_MESSAGE_ALLOCATE_BUFFER |
<a name="l00043"></a>00043                       FORMAT_MESSAGE_FROM_SYSTEM |
<a name="l00044"></a>00044                       FORMAT_MESSAGE_IGNORE_INSERTS,
<a name="l00045"></a>00045                       <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00046"></a>00046                       err,
<a name="l00047"></a>00047                       MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
<a name="l00048"></a>00048                       (LPTSTR) &amp; lpMsgBuf, 0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00049"></a>00049     <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;%s: %s&quot;</span>, func, (<span class="keywordtype">char</span>*)lpMsgBuf);
<a name="l00050"></a>00050 }
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00053"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a10dffb317809f4a8f15ae7204ce69e15">00053</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a10dffb317809f4a8f15ae7204ce69e15">w32_mutex_lock</a>(HANDLE lock)
<a name="l00054"></a>00054 {
<a name="l00055"></a>00055     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../d8/d90/nkf_8c.html#a5ea5ac7abf5cce39283e422add1067d5">result</a>;
<a name="l00056"></a>00056     <span class="keywordflow">while</span> (1) {
<a name="l00057"></a>00057         <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;native_mutex_lock: %p\n&quot;</span>, lock);
<a name="l00058"></a>00058         result = <a class="code" href="../../dd/d55/thread__win32_8c.html#af545ea55128fbeb4784719faef9cb79b">w32_wait_events</a>(&amp;lock, 1, INFINITE, 0);
<a name="l00059"></a>00059         <span class="keywordflow">switch</span> (result) {
<a name="l00060"></a>00060           <span class="keywordflow">case</span> WAIT_OBJECT_0:
<a name="l00061"></a>00061             <span class="comment">/* get mutex object */</span>
<a name="l00062"></a>00062             <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;acquire mutex: %p\n&quot;</span>, lock);
<a name="l00063"></a>00063             <span class="keywordflow">return</span> 0;
<a name="l00064"></a>00064           <span class="keywordflow">case</span> WAIT_OBJECT_0 + 1:
<a name="l00065"></a>00065             <span class="comment">/* interrupt */</span>
<a name="l00066"></a>00066             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINTR;
<a name="l00067"></a>00067             <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;acquire mutex interrupted: %p\n&quot;</span>, lock);
<a name="l00068"></a>00068             <span class="keywordflow">return</span> 0;
<a name="l00069"></a>00069           <span class="keywordflow">case</span> WAIT_TIMEOUT:
<a name="l00070"></a>00070             <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;timeout mutex: %p\n&quot;</span>, lock);
<a name="l00071"></a>00071             <span class="keywordflow">break</span>;
<a name="l00072"></a>00072           <span class="keywordflow">case</span> WAIT_ABANDONED:
<a name="l00073"></a>00073             <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;win32_mutex_lock: WAIT_ABANDONED&quot;</span>);
<a name="l00074"></a>00074             <span class="keywordflow">break</span>;
<a name="l00075"></a>00075           <span class="keywordflow">default</span>:
<a name="l00076"></a>00076             <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;win32_mutex_lock: unknown result (%ld)&quot;</span>, result);
<a name="l00077"></a>00077             <span class="keywordflow">break</span>;
<a name="l00078"></a>00078         }
<a name="l00079"></a>00079     }
<a name="l00080"></a>00080     <span class="keywordflow">return</span> 0;
<a name="l00081"></a>00081 }
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 <span class="keyword">static</span> HANDLE
<a name="l00084"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#af6d91d5ce84b0837f92d454d2441e579">00084</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#af6d91d5ce84b0837f92d454d2441e579">w32_mutex_create</a>(<span class="keywordtype">void</span>)
<a name="l00085"></a>00085 {
<a name="l00086"></a>00086     HANDLE lock = CreateMutex(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00087"></a>00087     <span class="keywordflow">if</span> (lock == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00088"></a>00088         <a class="code" href="../../dd/d55/thread__win32_8c.html#a5aee49bd66acca743b8adca9ce63d939">w32_error</a>(<span class="stringliteral">&quot;native_mutex_initialize&quot;</span>);
<a name="l00089"></a>00089     }
<a name="l00090"></a>00090     <span class="keywordflow">return</span> lock;
<a name="l00091"></a>00091 }
<a name="l00092"></a>00092 
<a name="l00093"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#aa1bdcb58ee1bf0a2414821bb5e694788">00093</a> <span class="preprocessor">#define GVL_DEBUG 0</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span>
<a name="l00095"></a>00095 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00096"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#ab79a7242ae8c8e18ed5428572bd32d68">00096</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#ab79a7242ae8c8e18ed5428572bd32d68">gvl_acquire</a>(<a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vm, <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l00097"></a>00097 {
<a name="l00098"></a>00098     <a class="code" href="../../dd/d55/thread__win32_8c.html#a10dffb317809f4a8f15ae7204ce69e15">w32_mutex_lock</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a0e73c33ec1f57037ccdf288b3242bef5">gvl</a>.<a class="code" href="../../d3/d61/structrb__global__vm__lock__struct.html#a948be6b7a74025df722091e4da6d9701">lock</a>);
<a name="l00099"></a>00099     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d55/thread__win32_8c.html#aa1bdcb58ee1bf0a2414821bb5e694788">GVL_DEBUG</a>) fprintf(stderr, <span class="stringliteral">&quot;gvl acquire (%p): acquire\n&quot;</span>, th);
<a name="l00100"></a>00100 }
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00103"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#ace612546254f977d081161912cbc6335">00103</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#ace612546254f977d081161912cbc6335">gvl_release</a>(<a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vm)
<a name="l00104"></a>00104 {
<a name="l00105"></a>00105     ReleaseMutex(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a0e73c33ec1f57037ccdf288b3242bef5">gvl</a>.<a class="code" href="../../d3/d61/structrb__global__vm__lock__struct.html#a948be6b7a74025df722091e4da6d9701">lock</a>);
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00109"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a4c3b2a7689f7801fbae9eace3fc65402">00109</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a4c3b2a7689f7801fbae9eace3fc65402">gvl_yield</a>(<a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vm, <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l00110"></a>00110 {
<a name="l00111"></a>00111   <a class="code" href="../../dd/d55/thread__win32_8c.html#ace612546254f977d081161912cbc6335">gvl_release</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3e7d0b05e2d73f324e70c735ba50739e">vm</a>);
<a name="l00112"></a>00112   <a class="code" href="../../d1/d1c/thread__pthread_8c.html#a2eb53d5797cb97f1880947806d57d592">native_thread_yield</a>();
<a name="l00113"></a>00113   <a class="code" href="../../dd/d55/thread__win32_8c.html#ab79a7242ae8c8e18ed5428572bd32d68">gvl_acquire</a>(vm, th);
<a name="l00114"></a>00114 }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00118"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#aea7a77711353300d0b9759f25ee0d383">00118</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#aea7a77711353300d0b9759f25ee0d383">gvl_atfork</a>(<a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vm)
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120     <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;gvl_atfork() is called on win32&quot;</span>);
<a name="l00121"></a>00121 }
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00124"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#afdc2fa42b7688ee3cd2947adc7e7a4ca">00124</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#afdc2fa42b7688ee3cd2947adc7e7a4ca">gvl_init</a>(<a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vm)
<a name="l00125"></a>00125 {
<a name="l00126"></a>00126     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d55/thread__win32_8c.html#aa1bdcb58ee1bf0a2414821bb5e694788">GVL_DEBUG</a>) fprintf(stderr, <span class="stringliteral">&quot;gvl init\n&quot;</span>);
<a name="l00127"></a>00127     vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a0e73c33ec1f57037ccdf288b3242bef5">gvl</a>.<a class="code" href="../../d3/d61/structrb__global__vm__lock__struct.html#a948be6b7a74025df722091e4da6d9701">lock</a> = <a class="code" href="../../dd/d55/thread__win32_8c.html#af6d91d5ce84b0837f92d454d2441e579">w32_mutex_create</a>();
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00131"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a0aecca3c2db972156fb68cf7e9ed1c11">00131</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a0aecca3c2db972156fb68cf7e9ed1c11">gvl_destroy</a>(<a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vm)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d55/thread__win32_8c.html#aa1bdcb58ee1bf0a2414821bb5e694788">GVL_DEBUG</a>) fprintf(stderr, <span class="stringliteral">&quot;gvl destroy\n&quot;</span>);
<a name="l00134"></a>00134     CloseHandle(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a0e73c33ec1f57037ccdf288b3242bef5">gvl</a>.<a class="code" href="../../d3/d61/structrb__global__vm__lock__struct.html#a948be6b7a74025df722091e4da6d9701">lock</a>);
<a name="l00135"></a>00135 }
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 <span class="keyword">static</span> <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *
<a name="l00138"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a98b54a4d75d803d88e0c79a87ee998db">00138</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a98b54a4d75d803d88e0c79a87ee998db">ruby_thread_from_native</a>(<span class="keywordtype">void</span>)
<a name="l00139"></a>00139 {
<a name="l00140"></a>00140     <span class="keywordflow">return</span> TlsGetValue(<a class="code" href="../../dd/d55/thread__win32_8c.html#a3c356d0ad5910784ed30dcf24990f985">ruby_native_thread_key</a>);
<a name="l00141"></a>00141 }
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00144"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a49b83b44864480d73c0e32ab59b050cc">00144</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a49b83b44864480d73c0e32ab59b050cc">ruby_thread_set_native</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146     <span class="keywordflow">return</span> TlsSetValue(<a class="code" href="../../dd/d55/thread__win32_8c.html#a3c356d0ad5910784ed30dcf24990f985">ruby_native_thread_key</a>, th);
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 <span class="keywordtype">void</span>
<a name="l00150"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a1261ad828419468df5d4e92bb75ff6f3">00150</a> <a class="code" href="../../d1/d1c/thread__pthread_8c.html#a1261ad828419468df5d4e92bb75ff6f3">Init_native_thread</a>(<span class="keywordtype">void</span>)
<a name="l00151"></a>00151 {
<a name="l00152"></a>00152     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l00153"></a>00153 
<a name="l00154"></a>00154     <a class="code" href="../../dd/d55/thread__win32_8c.html#a3c356d0ad5910784ed30dcf24990f985">ruby_native_thread_key</a> = TlsAlloc();
<a name="l00155"></a>00155     <a class="code" href="../../dd/d55/thread__win32_8c.html#a49b83b44864480d73c0e32ab59b050cc">ruby_thread_set_native</a>(th);
<a name="l00156"></a>00156     DuplicateHandle(GetCurrentProcess(),
<a name="l00157"></a>00157                     GetCurrentThread(),
<a name="l00158"></a>00158                     GetCurrentProcess(),
<a name="l00159"></a>00159                     &amp;th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#acbd5b841dcb2158ed2111abd6b876251">thread_id</a>, 0, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, DUPLICATE_SAME_ACCESS);
<a name="l00160"></a>00160 
<a name="l00161"></a>00161     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1ee6880a07f5e4bf524af64d1ccf3ad0">native_thread_data</a>.<a class="code" href="../../d9/dae/structnative__thread__data__struct.html#a4535334b7a7e6bc0d274f19321365eba">interrupt_event</a> = CreateEvent(0, <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, 0);
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;initial thread (th: %p, thid: %p, event: %p)\n&quot;</span>,
<a name="l00164"></a>00164                  th, <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>()-&gt;thread_id,
<a name="l00165"></a>00165                  th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1ee6880a07f5e4bf524af64d1ccf3ad0">native_thread_data</a>.<a class="code" href="../../d9/dae/structnative__thread__data__struct.html#a4535334b7a7e6bc0d274f19321365eba">interrupt_event</a>);
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00169"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a61df43741ed4ac202eccf94cb670adb6">00169</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a61df43741ed4ac202eccf94cb670adb6">w32_set_event</a>(HANDLE handle)
<a name="l00170"></a>00170 {
<a name="l00171"></a>00171     <span class="keywordflow">if</span> (SetEvent(handle) == 0) {
<a name="l00172"></a>00172         <a class="code" href="../../dd/d55/thread__win32_8c.html#a5aee49bd66acca743b8adca9ce63d939">w32_error</a>(<span class="stringliteral">&quot;w32_set_event&quot;</span>);
<a name="l00173"></a>00173     }
<a name="l00174"></a>00174 }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00177"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#ab793980339b8cfdc5d7636b016a7195c">00177</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#ab793980339b8cfdc5d7636b016a7195c">w32_reset_event</a>(HANDLE handle)
<a name="l00178"></a>00178 {
<a name="l00179"></a>00179     <span class="keywordflow">if</span> (ResetEvent(handle) == 0) {
<a name="l00180"></a>00180         <a class="code" href="../../dd/d55/thread__win32_8c.html#a5aee49bd66acca743b8adca9ce63d939">w32_error</a>(<span class="stringliteral">&quot;w32_reset_event&quot;</span>);
<a name="l00181"></a>00181     }
<a name="l00182"></a>00182 }
<a name="l00183"></a>00183 
<a name="l00184"></a>00184 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00185"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#af545ea55128fbeb4784719faef9cb79b">00185</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#af545ea55128fbeb4784719faef9cb79b">w32_wait_events</a>(HANDLE *events, <span class="keywordtype">int</span> <a class="code" href="../../d5/db5/encoding_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>, <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> timeout, <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l00186"></a>00186 {
<a name="l00187"></a>00187     HANDLE *targets = events;
<a name="l00188"></a>00188     HANDLE intr;
<a name="l00189"></a>00189     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> ret;
<a name="l00190"></a>00190 
<a name="l00191"></a>00191     <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;  w32_wait_events events:%p, count:%d, timeout:%ld, th:%p\n&quot;</span>,
<a name="l00192"></a>00192                  events, count, timeout, th);
<a name="l00193"></a>00193     <span class="keywordflow">if</span> (th &amp;&amp; (intr = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1ee6880a07f5e4bf524af64d1ccf3ad0">native_thread_data</a>.<a class="code" href="../../d9/dae/structnative__thread__data__struct.html#a4535334b7a7e6bc0d274f19321365eba">interrupt_event</a>)) {
<a name="l00194"></a>00194         <a class="code" href="../../dd/d55/thread__win32_8c.html#ab79a7242ae8c8e18ed5428572bd32d68">gvl_acquire</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3e7d0b05e2d73f324e70c735ba50739e">vm</a>, th);
<a name="l00195"></a>00195         <span class="keywordflow">if</span> (intr == th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1ee6880a07f5e4bf524af64d1ccf3ad0">native_thread_data</a>.<a class="code" href="../../d9/dae/structnative__thread__data__struct.html#a4535334b7a7e6bc0d274f19321365eba">interrupt_event</a>) {
<a name="l00196"></a>00196             <a class="code" href="../../dd/d55/thread__win32_8c.html#ab793980339b8cfdc5d7636b016a7195c">w32_reset_event</a>(intr);
<a name="l00197"></a>00197             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a0556a5a4763f36a45f81053a30570f3d">RUBY_VM_INTERRUPTED</a>(th)) {
<a name="l00198"></a>00198                 <a class="code" href="../../dd/d55/thread__win32_8c.html#a61df43741ed4ac202eccf94cb670adb6">w32_set_event</a>(intr);
<a name="l00199"></a>00199             }
<a name="l00200"></a>00200 
<a name="l00201"></a>00201             targets = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1408f4b967485afd869990b67e766ceb">ALLOCA_N</a>(HANDLE, count + 1);
<a name="l00202"></a>00202             memcpy(targets, events, <span class="keyword">sizeof</span>(HANDLE) * count);
<a name="l00203"></a>00203 
<a name="l00204"></a>00204             targets[count++] = intr;
<a name="l00205"></a>00205             <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;  * handle: %p (count: %d, intr)\n&quot;</span>, intr, count);
<a name="l00206"></a>00206         }
<a name="l00207"></a>00207         <a class="code" href="../../dd/d55/thread__win32_8c.html#ace612546254f977d081161912cbc6335">gvl_release</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3e7d0b05e2d73f324e70c735ba50739e">vm</a>);
<a name="l00208"></a>00208     }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;  WaitForMultipleObjects start (count: %d)\n&quot;</span>, count);
<a name="l00211"></a>00211     ret = WaitForMultipleObjects(count, targets, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, timeout);
<a name="l00212"></a>00212     <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;  WaitForMultipleObjects end (ret: %lu)\n&quot;</span>, ret);
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     <span class="keywordflow">if</span> (ret == (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)(WAIT_OBJECT_0 + count - 1) &amp;&amp; th) {
<a name="l00215"></a>00215         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINTR;
<a name="l00216"></a>00216     }
<a name="l00217"></a>00217     <span class="keywordflow">if</span> (ret == WAIT_FAILED &amp;&amp; <a class="code" href="../../d3/de7/thread_8c.html#a90f94aa25d18b63151123512564bfdee">THREAD_DEBUG</a>) {
<a name="l00218"></a>00218         <span class="keywordtype">int</span> i;
<a name="l00219"></a>00219         <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> dmy;
<a name="l00220"></a>00220         <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
<a name="l00221"></a>00221             <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;  * error handle %d - %s\n&quot;</span>, i,
<a name="l00222"></a>00222                          GetHandleInformation(targets[i], &amp;dmy) ? <span class="stringliteral">&quot;OK&quot;</span> : <span class="stringliteral">&quot;NG&quot;</span>);
<a name="l00223"></a>00223         }
<a name="l00224"></a>00224     }
<a name="l00225"></a>00225     <span class="keywordflow">return</span> ret;
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../dd/d55/thread__win32_8c.html#a16db535e7ace3a4922e8a6fcba05ae7f">ubf_handle</a>(<span class="keywordtype">void</span> *ptr);
<a name="l00229"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a3076df0f2ebfc68df4f942ef35b3b7e4">00229</a> <span class="preprocessor">#define ubf_select ubf_handle</span>
<a name="l00230"></a>00230 <span class="preprocessor"></span>
<a name="l00231"></a>00231 <span class="keywordtype">int</span>
<a name="l00232"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a2da86cc53904a673b2b18547d63700f6">00232</a> <a class="code" href="../../dc/db1/win32_8h.html#a2da86cc53904a673b2b18547d63700f6">rb_w32_wait_events_blocking</a>(HANDLE *events, <span class="keywordtype">int</span> num, <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> timeout)
<a name="l00233"></a>00233 {
<a name="l00234"></a>00234     <span class="keywordflow">return</span> <a class="code" href="../../dd/d55/thread__win32_8c.html#af545ea55128fbeb4784719faef9cb79b">w32_wait_events</a>(events, num, timeout, <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>());
<a name="l00235"></a>00235 }
<a name="l00236"></a>00236 
<a name="l00237"></a>00237 <span class="keywordtype">int</span>
<a name="l00238"></a><a class="code" href="../../d5/df2/win32_8c.html#afbceca1751aaf315d88fd569003dcf5c">00238</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#afbceca1751aaf315d88fd569003dcf5c">rb_w32_wait_events</a>(HANDLE *events, <span class="keywordtype">int</span> num, <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> timeout)
<a name="l00239"></a>00239 {
<a name="l00240"></a>00240     <span class="keywordtype">int</span> ret;
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     <a class="code" href="../../dd/d8c/rubysocket_8h.html#aab661f33b0e48f646463d49475734126">BLOCKING_REGION</a>(ret = <a class="code" href="../../dc/db1/win32_8h.html#a2da86cc53904a673b2b18547d63700f6">rb_w32_wait_events_blocking</a>(events, num, timeout),
<a name="l00243"></a>00243                     <a class="code" href="../../dd/d55/thread__win32_8c.html#a16db535e7ace3a4922e8a6fcba05ae7f">ubf_handle</a>, <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>());
<a name="l00244"></a>00244     <span class="keywordflow">return</span> ret;
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00248"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#ac8f8efd3e6c6b2bdabb6d7932b4c4739">00248</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#ac8f8efd3e6c6b2bdabb6d7932b4c4739">w32_close_handle</a>(HANDLE handle)
<a name="l00249"></a>00249 {
<a name="l00250"></a>00250     <span class="keywordflow">if</span> (CloseHandle(handle) == 0) {
<a name="l00251"></a>00251         <a class="code" href="../../dd/d55/thread__win32_8c.html#a5aee49bd66acca743b8adca9ce63d939">w32_error</a>(<span class="stringliteral">&quot;w32_close_handle&quot;</span>);
<a name="l00252"></a>00252     }
<a name="l00253"></a>00253 }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00256"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a2e002cbcac1c21fa3157504ca9f4dba9">00256</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a2e002cbcac1c21fa3157504ca9f4dba9">w32_resume_thread</a>(HANDLE handle)
<a name="l00257"></a>00257 {
<a name="l00258"></a>00258     <span class="keywordflow">if</span> (ResumeThread(handle) == (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)-1) {
<a name="l00259"></a>00259         <a class="code" href="../../dd/d55/thread__win32_8c.html#a5aee49bd66acca743b8adca9ce63d939">w32_error</a>(<span class="stringliteral">&quot;w32_resume_thread&quot;</span>);
<a name="l00260"></a>00260     }
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <span class="preprocessor">#ifdef _MSC_VER</span>
<a name="l00264"></a>00264 <span class="preprocessor"></span><span class="preprocessor">#define HAVE__BEGINTHREADEX 1</span>
<a name="l00265"></a>00265 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00266"></a>00266 <span class="preprocessor"></span><span class="preprocessor">#undef HAVE__BEGINTHREADEX</span>
<a name="l00267"></a>00267 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span>
<a name="l00269"></a>00269 <span class="preprocessor">#ifdef HAVE__BEGINTHREADEX</span>
<a name="l00270"></a>00270 <span class="preprocessor"></span><span class="preprocessor">#define start_thread (HANDLE)_beginthreadex</span>
<a name="l00271"></a>00271 <span class="preprocessor"></span><span class="preprocessor">#define thread_errno errno</span>
<a name="l00272"></a>00272 <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a> (_stdcall *<a class="code" href="../../dd/d55/thread__win32_8c.html#ad408ca34b9c20ea0de9f2652ea3f0eef">w32_thread_start_func</a>)(<span class="keywordtype">void</span>*);
<a name="l00273"></a>00273 <span class="preprocessor">#else</span>
<a name="l00274"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a958d8be3ea8d1082b657b7b3fe2f0505">00274</a> <span class="preprocessor"></span><span class="preprocessor">#define start_thread CreateThread</span>
<a name="l00275"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a197cb19044cf3c83cc7722434974fe55">00275</a> <span class="preprocessor"></span><span class="preprocessor">#define thread_errno rb_w32_map_errno(GetLastError())</span>
<a name="l00276"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#ad408ca34b9c20ea0de9f2652ea3f0eef">00276</a> <span class="preprocessor"></span><span class="keyword">typedef</span> LPTHREAD_START_ROUTINE <a class="code" href="../../dd/d55/thread__win32_8c.html#ad408ca34b9c20ea0de9f2652ea3f0eef">w32_thread_start_func</a>;
<a name="l00277"></a>00277 <span class="preprocessor">#endif</span>
<a name="l00278"></a>00278 <span class="preprocessor"></span>
<a name="l00279"></a>00279 <span class="keyword">static</span> HANDLE
<a name="l00280"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a76040cdbe2a6af7471a76ccb3e206705">00280</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a76040cdbe2a6af7471a76ccb3e206705">w32_create_thread</a>(<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> stack_size, <a class="code" href="../../dd/d55/thread__win32_8c.html#ad408ca34b9c20ea0de9f2652ea3f0eef">w32_thread_start_func</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a>, <span class="keywordtype">void</span> *val)
<a name="l00281"></a>00281 {
<a name="l00282"></a>00282     <span class="keywordflow">return</span> <a class="code" href="../../dd/d55/thread__win32_8c.html#a958d8be3ea8d1082b657b7b3fe2f0505">start_thread</a>(0, stack_size, func, val, CREATE_SUSPENDED, 0);
<a name="l00283"></a>00283 }
<a name="l00284"></a>00284 
<a name="l00285"></a>00285 <span class="keywordtype">int</span>
<a name="l00286"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a2e942b300acf219df592259316a4ee5e">00286</a> <a class="code" href="../../dc/db1/win32_8h.html#a2e942b300acf219df592259316a4ee5e">rb_w32_sleep</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> msec)
<a name="l00287"></a>00287 {
<a name="l00288"></a>00288     <span class="keywordflow">return</span> <a class="code" href="../../dd/d55/thread__win32_8c.html#af545ea55128fbeb4784719faef9cb79b">w32_wait_events</a>(0, 0, msec, <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>());
<a name="l00289"></a>00289 }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291 <span class="keywordtype">int</span> WINAPI
<a name="l00292"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#acd7fc6bca447411467db66a1cc12f319">00292</a> <a class="code" href="../../dc/db1/win32_8h.html#acd7fc6bca447411467db66a1cc12f319">rb_w32_Sleep</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> msec)
<a name="l00293"></a>00293 {
<a name="l00294"></a>00294     <span class="keywordtype">int</span> ret;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296     <a class="code" href="../../dd/d8c/rubysocket_8h.html#aab661f33b0e48f646463d49475734126">BLOCKING_REGION</a>(ret = <a class="code" href="../../dc/db1/win32_8h.html#a2e942b300acf219df592259316a4ee5e">rb_w32_sleep</a>(msec),
<a name="l00297"></a>00297                     <a class="code" href="../../dd/d55/thread__win32_8c.html#a16db535e7ace3a4922e8a6fcba05ae7f">ubf_handle</a>, <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>());
<a name="l00298"></a>00298     <span class="keywordflow">return</span> ret;
<a name="l00299"></a>00299 }
<a name="l00300"></a>00300 
<a name="l00301"></a>00301 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00302"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a84eaf485c3bd48ff86492e0b8a0bb2c0">00302</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a84eaf485c3bd48ff86492e0b8a0bb2c0">native_sleep</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <span class="keyword">struct</span> <a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> *tv)
<a name="l00303"></a>00303 {
<a name="l00304"></a>00304     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> msec;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     <span class="keywordflow">if</span> (tv) {
<a name="l00307"></a>00307         msec = tv-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> * 1000 + tv-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> / 1000;
<a name="l00308"></a>00308     }
<a name="l00309"></a>00309     <span class="keywordflow">else</span> {
<a name="l00310"></a>00310         msec = INFINITE;
<a name="l00311"></a>00311     }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     <a class="code" href="../../d3/de7/thread_8c.html#ac4a353316c0c2cce85b75c7f0aada8ab">GVL_UNLOCK_BEGIN</a>();
<a name="l00314"></a>00314     {
<a name="l00315"></a>00315         <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> ret;
<a name="l00316"></a>00316 
<a name="l00317"></a>00317         <a class="code" href="../../dd/d55/thread__win32_8c.html#ad9b8bad99bfb94fad8030038da1987b7">native_mutex_lock</a>(&amp;th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a88b241c682c89f42b48fd478f208f5b2">interrupt_lock</a>);
<a name="l00318"></a>00318         th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1e8ee4d75d7d514449cf70ce7beca57e">unblock</a>.<a class="code" href="../../de/d45/structrb__unblock__callback.html#af641aca3c5c45670cdad373846a79dd2">func</a> = <a class="code" href="../../dd/d55/thread__win32_8c.html#a16db535e7ace3a4922e8a6fcba05ae7f">ubf_handle</a>;
<a name="l00319"></a>00319         th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1e8ee4d75d7d514449cf70ce7beca57e">unblock</a>.<a class="code" href="../../de/d45/structrb__unblock__callback.html#a11d7995ba5947f27f071cfda0f48c593">arg</a> = th;
<a name="l00320"></a>00320         <a class="code" href="../../dd/d55/thread__win32_8c.html#a3d698f06306ed5992e6f4fe1be7bad13">native_mutex_unlock</a>(&amp;th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a88b241c682c89f42b48fd478f208f5b2">interrupt_lock</a>);
<a name="l00321"></a>00321 
<a name="l00322"></a>00322         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a0556a5a4763f36a45f81053a30570f3d">RUBY_VM_INTERRUPTED</a>(th)) {
<a name="l00323"></a>00323             <span class="comment">/* interrupted.  return immediate */</span>
<a name="l00324"></a>00324         }
<a name="l00325"></a>00325         <span class="keywordflow">else</span> {
<a name="l00326"></a>00326             <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;native_sleep start (%lu)\n&quot;</span>, msec);
<a name="l00327"></a>00327             ret = <a class="code" href="../../dd/d55/thread__win32_8c.html#af545ea55128fbeb4784719faef9cb79b">w32_wait_events</a>(0, 0, msec, th);
<a name="l00328"></a>00328             <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;native_sleep done (%lu)\n&quot;</span>, ret);
<a name="l00329"></a>00329         }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331         <a class="code" href="../../dd/d55/thread__win32_8c.html#ad9b8bad99bfb94fad8030038da1987b7">native_mutex_lock</a>(&amp;th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a88b241c682c89f42b48fd478f208f5b2">interrupt_lock</a>);
<a name="l00332"></a>00332         th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1e8ee4d75d7d514449cf70ce7beca57e">unblock</a>.<a class="code" href="../../de/d45/structrb__unblock__callback.html#af641aca3c5c45670cdad373846a79dd2">func</a> = 0;
<a name="l00333"></a>00333         th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1e8ee4d75d7d514449cf70ce7beca57e">unblock</a>.<a class="code" href="../../de/d45/structrb__unblock__callback.html#a11d7995ba5947f27f071cfda0f48c593">arg</a> = 0;
<a name="l00334"></a>00334         <a class="code" href="../../dd/d55/thread__win32_8c.html#a3d698f06306ed5992e6f4fe1be7bad13">native_mutex_unlock</a>(&amp;th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a88b241c682c89f42b48fd478f208f5b2">interrupt_lock</a>);
<a name="l00335"></a>00335     }
<a name="l00336"></a>00336     <a class="code" href="../../d3/de7/thread_8c.html#a7731fc2a60a727d5bbd8cf78fd5375a6">GVL_UNLOCK_END</a>();
<a name="l00337"></a>00337 }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00340"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#ad9b8bad99bfb94fad8030038da1987b7">00340</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#ad9b8bad99bfb94fad8030038da1987b7">native_mutex_lock</a>(<a class="code" href="../../d2/d82/thread__pthread_8h.html#aad27e6c1e30cf79f10930122e8ae405e">rb_thread_lock_t</a> *lock)
<a name="l00341"></a>00341 {
<a name="l00342"></a>00342 <span class="preprocessor">#if USE_WIN32_MUTEX</span>
<a name="l00343"></a>00343 <span class="preprocessor"></span>    <a class="code" href="../../dd/d55/thread__win32_8c.html#a10dffb317809f4a8f15ae7204ce69e15">w32_mutex_lock</a>(*lock);
<a name="l00344"></a>00344 <span class="preprocessor">#else</span>
<a name="l00345"></a>00345 <span class="preprocessor"></span>    EnterCriticalSection(lock);
<a name="l00346"></a>00346     <span class="keywordflow">return</span> 0;
<a name="l00347"></a>00347 <span class="preprocessor">#endif</span>
<a name="l00348"></a>00348 <span class="preprocessor"></span>}
<a name="l00349"></a>00349 
<a name="l00350"></a>00350 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00351"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a3d698f06306ed5992e6f4fe1be7bad13">00351</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a3d698f06306ed5992e6f4fe1be7bad13">native_mutex_unlock</a>(<a class="code" href="../../d2/d82/thread__pthread_8h.html#aad27e6c1e30cf79f10930122e8ae405e">rb_thread_lock_t</a> *lock)
<a name="l00352"></a>00352 {
<a name="l00353"></a>00353 <span class="preprocessor">#if USE_WIN32_MUTEX</span>
<a name="l00354"></a>00354 <span class="preprocessor"></span>    <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;release mutex: %p\n&quot;</span>, *lock);
<a name="l00355"></a>00355     <span class="keywordflow">return</span> ReleaseMutex(*lock);
<a name="l00356"></a>00356 <span class="preprocessor">#else</span>
<a name="l00357"></a>00357 <span class="preprocessor"></span>    LeaveCriticalSection(lock);
<a name="l00358"></a>00358     <span class="keywordflow">return</span> 0;
<a name="l00359"></a>00359 <span class="preprocessor">#endif</span>
<a name="l00360"></a>00360 <span class="preprocessor"></span>}
<a name="l00361"></a>00361 
<a name="l00362"></a>00362 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00363"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a89dcb48e90fcc1f5ecb7bb14e0985419">00363</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a89dcb48e90fcc1f5ecb7bb14e0985419">native_mutex_trylock</a>(<a class="code" href="../../d2/d82/thread__pthread_8h.html#aad27e6c1e30cf79f10930122e8ae405e">rb_thread_lock_t</a> *lock)
<a name="l00364"></a>00364 {
<a name="l00365"></a>00365 <span class="preprocessor">#if USE_WIN32_MUTEX</span>
<a name="l00366"></a>00366 <span class="preprocessor"></span>    <span class="keywordtype">int</span> <a class="code" href="../../d8/d90/nkf_8c.html#a5ea5ac7abf5cce39283e422add1067d5">result</a>;
<a name="l00367"></a>00367     <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;native_mutex_trylock: %p\n&quot;</span>, *lock);
<a name="l00368"></a>00368     result = <a class="code" href="../../dd/d55/thread__win32_8c.html#af545ea55128fbeb4784719faef9cb79b">w32_wait_events</a>(&amp;*lock, 1, 1, 0);
<a name="l00369"></a>00369     <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;native_mutex_trylock result: %d\n&quot;</span>, result);
<a name="l00370"></a>00370     <span class="keywordflow">switch</span> (result) {
<a name="l00371"></a>00371       <span class="keywordflow">case</span> WAIT_OBJECT_0:
<a name="l00372"></a>00372         <span class="keywordflow">return</span> 0;
<a name="l00373"></a>00373       <span class="keywordflow">case</span> WAIT_TIMEOUT:
<a name="l00374"></a>00374         <span class="keywordflow">return</span> EBUSY;
<a name="l00375"></a>00375     }
<a name="l00376"></a>00376     <span class="keywordflow">return</span> EINVAL;
<a name="l00377"></a>00377 <span class="preprocessor">#else</span>
<a name="l00378"></a>00378 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../d7/de8/thread__win32_8h.html#ac807ed0840e06634b96ae06086db8798">TryEnterCriticalSection</a>(lock) == 0;
<a name="l00379"></a>00379 <span class="preprocessor">#endif</span>
<a name="l00380"></a>00380 <span class="preprocessor"></span>}
<a name="l00381"></a>00381 
<a name="l00382"></a>00382 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00383"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a2590fc19a12a331e4f27303cb8d741e8">00383</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a2590fc19a12a331e4f27303cb8d741e8">native_mutex_initialize</a>(<a class="code" href="../../d2/d82/thread__pthread_8h.html#aad27e6c1e30cf79f10930122e8ae405e">rb_thread_lock_t</a> *lock)
<a name="l00384"></a>00384 {
<a name="l00385"></a>00385 <span class="preprocessor">#if USE_WIN32_MUTEX</span>
<a name="l00386"></a>00386 <span class="preprocessor"></span>    *lock = <a class="code" href="../../dd/d55/thread__win32_8c.html#af6d91d5ce84b0837f92d454d2441e579">w32_mutex_create</a>();
<a name="l00387"></a>00387     <span class="comment">/* thread_debug(&quot;initialize mutex: %p\n&quot;, *lock); */</span>
<a name="l00388"></a>00388 <span class="preprocessor">#else</span>
<a name="l00389"></a>00389 <span class="preprocessor"></span>    InitializeCriticalSection(lock);
<a name="l00390"></a>00390 <span class="preprocessor">#endif</span>
<a name="l00391"></a>00391 <span class="preprocessor"></span>}
<a name="l00392"></a>00392 
<a name="l00393"></a>00393 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00394"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#aafa2df79de005c66a302b3da1888526e">00394</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#aafa2df79de005c66a302b3da1888526e">native_mutex_destroy</a>(<a class="code" href="../../d2/d82/thread__pthread_8h.html#aad27e6c1e30cf79f10930122e8ae405e">rb_thread_lock_t</a> *lock)
<a name="l00395"></a>00395 {
<a name="l00396"></a>00396 <span class="preprocessor">#if USE_WIN32_MUTEX</span>
<a name="l00397"></a>00397 <span class="preprocessor"></span>    <a class="code" href="../../dd/d55/thread__win32_8c.html#ac8f8efd3e6c6b2bdabb6d7932b4c4739">w32_close_handle</a>(lock);
<a name="l00398"></a>00398 <span class="preprocessor">#else</span>
<a name="l00399"></a>00399 <span class="preprocessor"></span>    DeleteCriticalSection(lock);
<a name="l00400"></a>00400 <span class="preprocessor">#endif</span>
<a name="l00401"></a>00401 <span class="preprocessor"></span>}
<a name="l00402"></a>00402 
<a name="l00403"></a><a class="code" href="../../da/d06/structcond__event__entry.html">00403</a> <span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a> {
<a name="l00404"></a><a class="code" href="../../da/d06/structcond__event__entry.html#ad96358c2236edf15033cc05e26bb3f77">00404</a>     <span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a>* <a class="code" href="../../da/d06/structcond__event__entry.html#ad96358c2236edf15033cc05e26bb3f77">next</a>;
<a name="l00405"></a><a class="code" href="../../da/d06/structcond__event__entry.html#a8f85c0527a7da6215ad36147dfb00b83">00405</a>     <span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a>* <a class="code" href="../../da/d06/structcond__event__entry.html#a8f85c0527a7da6215ad36147dfb00b83">prev</a>;
<a name="l00406"></a><a class="code" href="../../da/d06/structcond__event__entry.html#a42be9bc9c73b7eeed1d5ea020679d8aa">00406</a>     HANDLE <a class="code" href="../../da/d06/structcond__event__entry.html#a42be9bc9c73b7eeed1d5ea020679d8aa">event</a>;
<a name="l00407"></a>00407 };
<a name="l00408"></a>00408 
<a name="l00409"></a>00409 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00410"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#aced8e977df3e30acd20e57ecb4e5f046">00410</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#aced8e977df3e30acd20e57ecb4e5f046">native_cond_signal</a>(<a class="code" href="../../d0/d6c/structrb__thread__cond__struct.html">rb_thread_cond_t</a> *<a class="code" href="../../d5/d11/ripper_8c.html#a9c9363cead2d8e8616cb63b4eea79655">cond</a>)
<a name="l00411"></a>00411 {
<a name="l00412"></a>00412     <span class="comment">/* cond is guarded by mutex */</span>
<a name="l00413"></a>00413     <span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a> *e = cond-&gt;<a class="code" href="../../d0/d6c/structrb__thread__cond__struct.html#a5758046010aa36db164573a4e493d8ed">next</a>;
<a name="l00414"></a>00414     <span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a> *head = (<span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a>*)cond;
<a name="l00415"></a>00415 
<a name="l00416"></a>00416     <span class="keywordflow">if</span> (e != head) {
<a name="l00417"></a>00417         <span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a> *<a class="code" href="../../da/d06/structcond__event__entry.html#ad96358c2236edf15033cc05e26bb3f77">next</a> = e-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#ad96358c2236edf15033cc05e26bb3f77">next</a>;
<a name="l00418"></a>00418         <span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a> *<a class="code" href="../../d7/dc0/parse_8y.html#a71f8b6ffdc0cc58ffd989c3162fb2bcf">prev</a> = e-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#a8f85c0527a7da6215ad36147dfb00b83">prev</a>;
<a name="l00419"></a>00419 
<a name="l00420"></a>00420         prev-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#ad96358c2236edf15033cc05e26bb3f77">next</a> = next;
<a name="l00421"></a>00421         next-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#a8f85c0527a7da6215ad36147dfb00b83">prev</a> = prev;
<a name="l00422"></a>00422         e-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#ad96358c2236edf15033cc05e26bb3f77">next</a> = e-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#a8f85c0527a7da6215ad36147dfb00b83">prev</a> = e;
<a name="l00423"></a>00423 
<a name="l00424"></a>00424         SetEvent(e-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#a42be9bc9c73b7eeed1d5ea020679d8aa">event</a>);
<a name="l00425"></a>00425     }
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00429"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a577e4602d8738696e6e90756815b9f4d">00429</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a577e4602d8738696e6e90756815b9f4d">native_cond_broadcast</a>(<a class="code" href="../../d0/d6c/structrb__thread__cond__struct.html">rb_thread_cond_t</a> *<a class="code" href="../../d5/d11/ripper_8c.html#a9c9363cead2d8e8616cb63b4eea79655">cond</a>)
<a name="l00430"></a>00430 {
<a name="l00431"></a>00431     <span class="comment">/* cond is guarded by mutex */</span>
<a name="l00432"></a>00432     <span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a> *e = cond-&gt;<a class="code" href="../../d0/d6c/structrb__thread__cond__struct.html#a5758046010aa36db164573a4e493d8ed">next</a>;
<a name="l00433"></a>00433     <span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a> *head = (<span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a>*)cond;
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     <span class="keywordflow">while</span> (e != head) {
<a name="l00436"></a>00436         <span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a> *<a class="code" href="../../da/d06/structcond__event__entry.html#ad96358c2236edf15033cc05e26bb3f77">next</a> = e-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#ad96358c2236edf15033cc05e26bb3f77">next</a>;
<a name="l00437"></a>00437         <span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a> *<a class="code" href="../../d7/dc0/parse_8y.html#a71f8b6ffdc0cc58ffd989c3162fb2bcf">prev</a> = e-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#a8f85c0527a7da6215ad36147dfb00b83">prev</a>;
<a name="l00438"></a>00438 
<a name="l00439"></a>00439         SetEvent(e-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#a42be9bc9c73b7eeed1d5ea020679d8aa">event</a>);
<a name="l00440"></a>00440 
<a name="l00441"></a>00441         prev-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#ad96358c2236edf15033cc05e26bb3f77">next</a> = next;
<a name="l00442"></a>00442         next-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#a8f85c0527a7da6215ad36147dfb00b83">prev</a> = prev;
<a name="l00443"></a>00443         e-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#ad96358c2236edf15033cc05e26bb3f77">next</a> = e-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#a8f85c0527a7da6215ad36147dfb00b83">prev</a> = e;
<a name="l00444"></a>00444 
<a name="l00445"></a>00445         e = next;
<a name="l00446"></a>00446     }
<a name="l00447"></a>00447 }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449 
<a name="l00450"></a>00450 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00451"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a02190f80c199c963fd5e163e7be84f02">00451</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a02190f80c199c963fd5e163e7be84f02">__cond_timedwait</a>(<a class="code" href="../../d0/d6c/structrb__thread__cond__struct.html">rb_thread_cond_t</a> *<a class="code" href="../../d5/d11/ripper_8c.html#a9c9363cead2d8e8616cb63b4eea79655">cond</a>, <a class="code" href="../../d2/d82/thread__pthread_8h.html#aad27e6c1e30cf79f10930122e8ae405e">rb_thread_lock_t</a> *mutex, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> msec)
<a name="l00452"></a>00452 {
<a name="l00453"></a>00453     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> r;
<a name="l00454"></a>00454     <span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a> entry;
<a name="l00455"></a>00455     <span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a> *head = (<span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a>*)cond;
<a name="l00456"></a>00456 
<a name="l00457"></a>00457     entry.<a class="code" href="../../da/d06/structcond__event__entry.html#a42be9bc9c73b7eeed1d5ea020679d8aa">event</a> = CreateEvent(0, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, 0);
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     <span class="comment">/* cond is guarded by mutex */</span>
<a name="l00460"></a>00460     entry.<a class="code" href="../../da/d06/structcond__event__entry.html#ad96358c2236edf15033cc05e26bb3f77">next</a> = head;
<a name="l00461"></a>00461     entry.<a class="code" href="../../da/d06/structcond__event__entry.html#a8f85c0527a7da6215ad36147dfb00b83">prev</a> = head-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#a8f85c0527a7da6215ad36147dfb00b83">prev</a>;
<a name="l00462"></a>00462     head-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#a8f85c0527a7da6215ad36147dfb00b83">prev</a>-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#ad96358c2236edf15033cc05e26bb3f77">next</a> = &amp;entry;
<a name="l00463"></a>00463     head-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#a8f85c0527a7da6215ad36147dfb00b83">prev</a> = &amp;entry;
<a name="l00464"></a>00464 
<a name="l00465"></a>00465     <a class="code" href="../../dd/d55/thread__win32_8c.html#a3d698f06306ed5992e6f4fe1be7bad13">native_mutex_unlock</a>(mutex);
<a name="l00466"></a>00466     {
<a name="l00467"></a>00467         r = WaitForSingleObject(entry.<a class="code" href="../../da/d06/structcond__event__entry.html#a42be9bc9c73b7eeed1d5ea020679d8aa">event</a>, msec);
<a name="l00468"></a>00468         <span class="keywordflow">if</span> ((r != WAIT_OBJECT_0) &amp;&amp; (r != WAIT_TIMEOUT)) {
<a name="l00469"></a>00469             <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;native_cond_wait: WaitForSingleObject returns %lu&quot;</span>, r);
<a name="l00470"></a>00470         }
<a name="l00471"></a>00471     }
<a name="l00472"></a>00472     <a class="code" href="../../dd/d55/thread__win32_8c.html#ad9b8bad99bfb94fad8030038da1987b7">native_mutex_lock</a>(mutex);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     entry.<a class="code" href="../../da/d06/structcond__event__entry.html#a8f85c0527a7da6215ad36147dfb00b83">prev</a>-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#ad96358c2236edf15033cc05e26bb3f77">next</a> = entry.<a class="code" href="../../da/d06/structcond__event__entry.html#ad96358c2236edf15033cc05e26bb3f77">next</a>;
<a name="l00475"></a>00475     entry.<a class="code" href="../../da/d06/structcond__event__entry.html#ad96358c2236edf15033cc05e26bb3f77">next</a>-&gt;<a class="code" href="../../da/d06/structcond__event__entry.html#a8f85c0527a7da6215ad36147dfb00b83">prev</a> = entry.<a class="code" href="../../da/d06/structcond__event__entry.html#a8f85c0527a7da6215ad36147dfb00b83">prev</a>;
<a name="l00476"></a>00476 
<a name="l00477"></a>00477     <a class="code" href="../../dd/d55/thread__win32_8c.html#ac8f8efd3e6c6b2bdabb6d7932b4c4739">w32_close_handle</a>(entry.<a class="code" href="../../da/d06/structcond__event__entry.html#a42be9bc9c73b7eeed1d5ea020679d8aa">event</a>);
<a name="l00478"></a>00478     <span class="keywordflow">return</span> (r == WAIT_OBJECT_0) ? 0 : <a class="code" href="../../dc/db1/win32_8h.html#a597718e59a8fc9c4d4ab63f5a34e28b1">ETIMEDOUT</a>;
<a name="l00479"></a>00479 }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00482"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#aec61e755abce208ccbd364e70643ed4b">00482</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#aec61e755abce208ccbd364e70643ed4b">native_cond_wait</a>(<a class="code" href="../../d0/d6c/structrb__thread__cond__struct.html">rb_thread_cond_t</a> *<a class="code" href="../../d5/d11/ripper_8c.html#a9c9363cead2d8e8616cb63b4eea79655">cond</a>, <a class="code" href="../../d2/d82/thread__pthread_8h.html#aad27e6c1e30cf79f10930122e8ae405e">rb_thread_lock_t</a> *mutex)
<a name="l00483"></a>00483 {
<a name="l00484"></a>00484     <span class="keywordflow">return</span> <a class="code" href="../../dd/d55/thread__win32_8c.html#a02190f80c199c963fd5e163e7be84f02">__cond_timedwait</a>(cond, mutex, INFINITE);
<a name="l00485"></a>00485 }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>
<a name="l00488"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#af24ec2b5e5be940c99c2e0734b1ffb37">00488</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#af24ec2b5e5be940c99c2e0734b1ffb37">abs_timespec_to_timeout_ms</a>(<span class="keyword">struct</span> <a class="code" href="../../da/d1c/structtimespec.html">timespec</a> *ts)
<a name="l00489"></a>00489 {
<a name="l00490"></a>00490     <span class="keyword">struct </span><a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> tv;
<a name="l00491"></a>00491     <span class="keyword">struct </span><a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> now;
<a name="l00492"></a>00492 
<a name="l00493"></a>00493     <a class="code" href="../../dc/db1/win32_8h.html#a091a762f60d91b0f5441d9520dc2079c">gettimeofday</a>(&amp;now, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00494"></a>00494     tv.<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> = ts-&gt;<a class="code" href="../../da/d1c/structtimespec.html#afc3302668d7cb5952f590da69fdd4955">tv_sec</a>;
<a name="l00495"></a>00495     tv.<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> = ts-&gt;<a class="code" href="../../da/d1c/structtimespec.html#ae3c7510dafa8cbcaede866ed13c99683">tv_nsec</a> / 1000;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     <span class="keywordflow">if</span> (!<a class="code" href="../../dc/db1/win32_8h.html#ac963a05659d51e65f30a1b3e8c6f414b">rb_w32_time_subtract</a>(&amp;tv, &amp;now))
<a name="l00498"></a>00498         <span class="keywordflow">return</span> 0;
<a name="l00499"></a>00499 
<a name="l00500"></a>00500     <span class="keywordflow">return</span> (tv.<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> * 1000) + (tv.<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> / 1000);
<a name="l00501"></a>00501 }
<a name="l00502"></a>00502 
<a name="l00503"></a>00503 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00504"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a1fd1d6f644795f158edd7dc75f3a7d15">00504</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a1fd1d6f644795f158edd7dc75f3a7d15">native_cond_timedwait</a>(<a class="code" href="../../d0/d6c/structrb__thread__cond__struct.html">rb_thread_cond_t</a> *<a class="code" href="../../d5/d11/ripper_8c.html#a9c9363cead2d8e8616cb63b4eea79655">cond</a>, <a class="code" href="../../d2/d82/thread__pthread_8h.html#aad27e6c1e30cf79f10930122e8ae405e">rb_thread_lock_t</a> *mutex, <span class="keyword">struct</span> <a class="code" href="../../da/d1c/structtimespec.html">timespec</a> *ts)
<a name="l00505"></a>00505 {
<a name="l00506"></a>00506     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> timeout_ms;
<a name="l00507"></a>00507 
<a name="l00508"></a>00508     timeout_ms = <a class="code" href="../../dd/d55/thread__win32_8c.html#af24ec2b5e5be940c99c2e0734b1ffb37">abs_timespec_to_timeout_ms</a>(ts);
<a name="l00509"></a>00509     <span class="keywordflow">if</span> (!timeout_ms)
<a name="l00510"></a>00510         <span class="keywordflow">return</span> <a class="code" href="../../dc/db1/win32_8h.html#a597718e59a8fc9c4d4ab63f5a34e28b1">ETIMEDOUT</a>;
<a name="l00511"></a>00511 
<a name="l00512"></a>00512     <span class="keywordflow">return</span> <a class="code" href="../../dd/d55/thread__win32_8c.html#a02190f80c199c963fd5e163e7be84f02">__cond_timedwait</a>(cond, mutex, timeout_ms);
<a name="l00513"></a>00513 }
<a name="l00514"></a>00514 
<a name="l00515"></a>00515 <span class="preprocessor">#if SIZEOF_TIME_T == SIZEOF_LONG</span>
<a name="l00516"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#abe5239cfb3b9775b72cc1d81373c7e48">00516</a> <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="../../d1/d1c/thread__pthread_8c.html#abe5239cfb3b9775b72cc1d81373c7e48">unsigned_time_t</a>;
<a name="l00517"></a>00517 <span class="preprocessor">#elif SIZEOF_TIME_T == SIZEOF_INT</span>
<a name="l00518"></a>00518 <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d1/d1c/thread__pthread_8c.html#abe5239cfb3b9775b72cc1d81373c7e48">unsigned_time_t</a>;
<a name="l00519"></a>00519 <span class="preprocessor">#elif SIZEOF_TIME_T == SIZEOF_LONG_LONG</span>
<a name="l00520"></a>00520 <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> LONG_LONG <a class="code" href="../../d1/d1c/thread__pthread_8c.html#abe5239cfb3b9775b72cc1d81373c7e48">unsigned_time_t</a>;
<a name="l00521"></a>00521 <span class="preprocessor">#else</span>
<a name="l00522"></a>00522 <span class="preprocessor"></span><span class="preprocessor"># error cannot find integer type which size is same as time_t.</span>
<a name="l00523"></a>00523 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00524"></a>00524 <span class="preprocessor"></span>
<a name="l00525"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#ab95d28a7486992d93dd15bc24c06a9d2">00525</a> <span class="preprocessor">#define TIMET_MAX (~(time_t)0 &lt;= 0 ? (time_t)((~(unsigned_time_t)0) &gt;&gt; 1) : (time_t)(~(unsigned_time_t)0))</span>
<a name="l00526"></a>00526 <span class="preprocessor"></span>
<a name="l00527"></a>00527 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../da/d1c/structtimespec.html">timespec</a>
<a name="l00528"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a49eaf5503804eb0f89a72eab05b2cf4e">00528</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a49eaf5503804eb0f89a72eab05b2cf4e">native_cond_timeout</a>(<a class="code" href="../../d0/d6c/structrb__thread__cond__struct.html">rb_thread_cond_t</a> *<a class="code" href="../../d5/d11/ripper_8c.html#a9c9363cead2d8e8616cb63b4eea79655">cond</a>, <span class="keyword">struct </span><a class="code" href="../../da/d1c/structtimespec.html">timespec</a> timeout_rel)
<a name="l00529"></a>00529 {
<a name="l00530"></a>00530     <span class="keywordtype">int</span> ret;
<a name="l00531"></a>00531     <span class="keyword">struct </span><a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> tv;
<a name="l00532"></a>00532     <span class="keyword">struct </span><a class="code" href="../../da/d1c/structtimespec.html">timespec</a> timeout;
<a name="l00533"></a>00533     <span class="keyword">struct </span><a class="code" href="../../da/d1c/structtimespec.html">timespec</a> now;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     ret = <a class="code" href="../../dc/db1/win32_8h.html#a091a762f60d91b0f5441d9520dc2079c">gettimeofday</a>(&amp;tv, 0);
<a name="l00536"></a>00536     <span class="keywordflow">if</span> (ret != 0)
<a name="l00537"></a>00537         <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l00538"></a>00538     now.<a class="code" href="../../da/d1c/structtimespec.html#afc3302668d7cb5952f590da69fdd4955">tv_sec</a> = tv.<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a>;
<a name="l00539"></a>00539     now.<a class="code" href="../../da/d1c/structtimespec.html#ae3c7510dafa8cbcaede866ed13c99683">tv_nsec</a> = tv.<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> * 1000;
<a name="l00540"></a>00540 
<a name="l00541"></a>00541     timeout.<a class="code" href="../../da/d1c/structtimespec.html#afc3302668d7cb5952f590da69fdd4955">tv_sec</a> = now.<a class="code" href="../../da/d1c/structtimespec.html#afc3302668d7cb5952f590da69fdd4955">tv_sec</a>;
<a name="l00542"></a>00542     timeout.<a class="code" href="../../da/d1c/structtimespec.html#ae3c7510dafa8cbcaede866ed13c99683">tv_nsec</a> = now.<a class="code" href="../../da/d1c/structtimespec.html#ae3c7510dafa8cbcaede866ed13c99683">tv_nsec</a>;
<a name="l00543"></a>00543     timeout.<a class="code" href="../../da/d1c/structtimespec.html#afc3302668d7cb5952f590da69fdd4955">tv_sec</a> += timeout_rel.tv_sec;
<a name="l00544"></a>00544     timeout.<a class="code" href="../../da/d1c/structtimespec.html#ae3c7510dafa8cbcaede866ed13c99683">tv_nsec</a> += timeout_rel.tv_nsec;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546     <span class="keywordflow">if</span> (timeout.<a class="code" href="../../da/d1c/structtimespec.html#ae3c7510dafa8cbcaede866ed13c99683">tv_nsec</a> &gt;= 1000*1000*1000) {
<a name="l00547"></a>00547         timeout.<a class="code" href="../../da/d1c/structtimespec.html#afc3302668d7cb5952f590da69fdd4955">tv_sec</a>++;
<a name="l00548"></a>00548         timeout.<a class="code" href="../../da/d1c/structtimespec.html#ae3c7510dafa8cbcaede866ed13c99683">tv_nsec</a> -= 1000*1000*1000;
<a name="l00549"></a>00549     }
<a name="l00550"></a>00550 
<a name="l00551"></a>00551     <span class="keywordflow">if</span> (timeout.<a class="code" href="../../da/d1c/structtimespec.html#afc3302668d7cb5952f590da69fdd4955">tv_sec</a> &lt; now.<a class="code" href="../../da/d1c/structtimespec.html#afc3302668d7cb5952f590da69fdd4955">tv_sec</a>)
<a name="l00552"></a>00552         timeout.<a class="code" href="../../da/d1c/structtimespec.html#afc3302668d7cb5952f590da69fdd4955">tv_sec</a> = <a class="code" href="../../d1/d1c/thread__pthread_8c.html#ab95d28a7486992d93dd15bc24c06a9d2">TIMET_MAX</a>;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554     <span class="keywordflow">return</span> timeout;
<a name="l00555"></a>00555 }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00558"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#afb4ee8f3f35b5dc5a88222a1c165914f">00558</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#afb4ee8f3f35b5dc5a88222a1c165914f">native_cond_initialize</a>(<a class="code" href="../../d0/d6c/structrb__thread__cond__struct.html">rb_thread_cond_t</a> *cond, <span class="keywordtype">int</span> flags)
<a name="l00559"></a>00559 {
<a name="l00560"></a>00560     cond-&gt;<a class="code" href="../../d0/d6c/structrb__thread__cond__struct.html#a5758046010aa36db164573a4e493d8ed">next</a> = (<span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a> *)cond;
<a name="l00561"></a>00561     cond-&gt;<a class="code" href="../../d0/d6c/structrb__thread__cond__struct.html#ab52a060dc976e8b370e3dc809eab7e99">prev</a> = (<span class="keyword">struct </span><a class="code" href="../../da/d06/structcond__event__entry.html">cond_event_entry</a> *)cond;
<a name="l00562"></a>00562 }
<a name="l00563"></a>00563 
<a name="l00564"></a>00564 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00565"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a637f8eb803c6bf4d39bfde295f5f3abe">00565</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a637f8eb803c6bf4d39bfde295f5f3abe">native_cond_destroy</a>(<a class="code" href="../../d0/d6c/structrb__thread__cond__struct.html">rb_thread_cond_t</a> *cond)
<a name="l00566"></a>00566 {
<a name="l00567"></a>00567     <span class="comment">/* */</span>
<a name="l00568"></a>00568 }
<a name="l00569"></a>00569 
<a name="l00570"></a>00570 <span class="keywordtype">void</span>
<a name="l00571"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a76525fa144bacb76f7a5f0ac2afc0400">00571</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ab7d9aa9836c379212b86b985909f7303">ruby_init_stack</a>(<span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *addr)
<a name="l00572"></a>00572 {
<a name="l00573"></a>00573 }
<a name="l00574"></a>00574 
<a name="l00575"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a03d29947556616cff6536c1b329cf46b">00575</a> <span class="preprocessor">#define CHECK_ERR(expr) \</span>
<a name="l00576"></a>00576 <span class="preprocessor">    {if (!(expr)) {rb_bug(&quot;err: %lu - %s&quot;, GetLastError(), #expr);}}</span>
<a name="l00577"></a>00577 <span class="preprocessor"></span>
<a name="l00578"></a>00578 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00579"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a72f35c8838c5c6a02326ac86e6415a2d">00579</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a72f35c8838c5c6a02326ac86e6415a2d">native_thread_init_stack</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l00580"></a>00580 {
<a name="l00581"></a>00581     MEMORY_BASIC_INFORMATION mi;
<a name="l00582"></a>00582     <span class="keywordtype">char</span> *base, *end;
<a name="l00583"></a>00583     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>, space;
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     <a class="code" href="../../d1/d1c/thread__pthread_8c.html#a03d29947556616cff6536c1b329cf46b">CHECK_ERR</a>(VirtualQuery(&amp;mi, &amp;mi, <span class="keyword">sizeof</span>(mi)));
<a name="l00586"></a>00586     base = mi.AllocationBase;
<a name="l00587"></a>00587     end = mi.BaseAddress;
<a name="l00588"></a>00588     end += mi.RegionSize;
<a name="l00589"></a>00589     size = end - base;
<a name="l00590"></a>00590     space = size / 5;
<a name="l00591"></a>00591     <span class="keywordflow">if</span> (space &gt; 1024*1024) space = 1024*1024;
<a name="l00592"></a>00592     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a004e79191ba26ebbdc62ea9f77039f1b">machine_stack_start</a> = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *)end - 1;
<a name="l00593"></a>00593     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#add10746c443276bf6df2cc0c6a29c8d7">machine_stack_maxsize</a> = size - space;
<a name="l00594"></a>00594 }
<a name="l00595"></a>00595 
<a name="l00596"></a>00596 <span class="preprocessor">#ifndef InterlockedExchangePointer</span>
<a name="l00597"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a38ebac34a5c1f6b9a920f60030a27031">00597</a> <span class="preprocessor"></span><span class="preprocessor">#define InterlockedExchangePointer(t, v) \</span>
<a name="l00598"></a>00598 <span class="preprocessor">    (void *)InterlockedExchange((long *)(t), (long)(v))</span>
<a name="l00599"></a>00599 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00600"></a>00600 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00601"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a658ad9f5856e89345cf385ecc6652904">00601</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a658ad9f5856e89345cf385ecc6652904">native_thread_destroy</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l00602"></a>00602 {
<a name="l00603"></a>00603     HANDLE intr = <a class="code" href="../../dd/d55/thread__win32_8c.html#a38ebac34a5c1f6b9a920f60030a27031">InterlockedExchangePointer</a>(&amp;th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1ee6880a07f5e4bf524af64d1ccf3ad0">native_thread_data</a>.<a class="code" href="../../d9/dae/structnative__thread__data__struct.html#a4535334b7a7e6bc0d274f19321365eba">interrupt_event</a>, 0);
<a name="l00604"></a>00604     <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;close handle - intr: %p, thid: %p\n&quot;</span>, intr, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#acbd5b841dcb2158ed2111abd6b876251">thread_id</a>);
<a name="l00605"></a>00605     <a class="code" href="../../dd/d55/thread__win32_8c.html#ac8f8efd3e6c6b2bdabb6d7932b4c4739">w32_close_handle</a>(intr);
<a name="l00606"></a>00606 }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> _stdcall
<a name="l00609"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#aa69c898edd29b70447631f83c35736e5">00609</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#aa69c898edd29b70447631f83c35736e5">thread_start_func_1</a>(<span class="keywordtype">void</span> *th_ptr)
<a name="l00610"></a>00610 {
<a name="l00611"></a>00611     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = th_ptr;
<a name="l00612"></a>00612     <span class="keyword">volatile</span> HANDLE thread_id = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#acbd5b841dcb2158ed2111abd6b876251">thread_id</a>;
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     <a class="code" href="../../dd/d55/thread__win32_8c.html#a72f35c8838c5c6a02326ac86e6415a2d">native_thread_init_stack</a>(th);
<a name="l00615"></a>00615     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1ee6880a07f5e4bf524af64d1ccf3ad0">native_thread_data</a>.<a class="code" href="../../d9/dae/structnative__thread__data__struct.html#a4535334b7a7e6bc0d274f19321365eba">interrupt_event</a> = CreateEvent(0, <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, 0);
<a name="l00616"></a>00616 
<a name="l00617"></a>00617     <span class="comment">/* run */</span>
<a name="l00618"></a>00618     <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;thread created (th: %p, thid: %p, event: %p)\n&quot;</span>, th,
<a name="l00619"></a>00619                  th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#acbd5b841dcb2158ed2111abd6b876251">thread_id</a>, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1ee6880a07f5e4bf524af64d1ccf3ad0">native_thread_data</a>.<a class="code" href="../../d9/dae/structnative__thread__data__struct.html#a4535334b7a7e6bc0d274f19321365eba">interrupt_event</a>);
<a name="l00620"></a>00620 
<a name="l00621"></a>00621     <a class="code" href="../../d3/de7/thread_8c.html#a711ed0f5f2d64d14a71f64a971531c02">thread_start_func_2</a>(th, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a004e79191ba26ebbdc62ea9f77039f1b">machine_stack_start</a>, rb_ia64_bsp());
<a name="l00622"></a>00622 
<a name="l00623"></a>00623     <a class="code" href="../../dd/d55/thread__win32_8c.html#ac8f8efd3e6c6b2bdabb6d7932b4c4739">w32_close_handle</a>(thread_id);
<a name="l00624"></a>00624     <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;thread deleted (th: %p)\n&quot;</span>, th);
<a name="l00625"></a>00625     <span class="keywordflow">return</span> 0;
<a name="l00626"></a>00626 }
<a name="l00627"></a>00627 
<a name="l00628"></a>00628 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00629"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#ab712f550acaa3f9e1d46d4114415f68e">00629</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#ab712f550acaa3f9e1d46d4114415f68e">native_thread_create</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l00630"></a>00630 {
<a name="l00631"></a>00631     <span class="keywordtype">size_t</span> stack_size = 4 * 1024; <span class="comment">/* 4KB */</span>
<a name="l00632"></a>00632     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#acbd5b841dcb2158ed2111abd6b876251">thread_id</a> = <a class="code" href="../../dd/d55/thread__win32_8c.html#a76040cdbe2a6af7471a76ccb3e206705">w32_create_thread</a>(stack_size, <a class="code" href="../../dd/d55/thread__win32_8c.html#aa69c898edd29b70447631f83c35736e5">thread_start_func_1</a>, th);
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     <span class="keywordflow">if</span> ((th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#acbd5b841dcb2158ed2111abd6b876251">thread_id</a>) == 0) {
<a name="l00635"></a>00635         <span class="keywordflow">return</span> <a class="code" href="../../dd/d55/thread__win32_8c.html#a197cb19044cf3c83cc7722434974fe55">thread_errno</a>;
<a name="l00636"></a>00636     }
<a name="l00637"></a>00637 
<a name="l00638"></a>00638     <a class="code" href="../../dd/d55/thread__win32_8c.html#a2e002cbcac1c21fa3157504ca9f4dba9">w32_resume_thread</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#acbd5b841dcb2158ed2111abd6b876251">thread_id</a>);
<a name="l00639"></a>00639 
<a name="l00640"></a>00640     <span class="keywordflow">if</span> (<a class="code" href="../../d3/de7/thread_8c.html#a90f94aa25d18b63151123512564bfdee">THREAD_DEBUG</a>) {
<a name="l00641"></a>00641         Sleep(0);
<a name="l00642"></a>00642         <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;create: (th: %p, thid: %p, intr: %p), stack size: %&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#adc5e20179bf95e62d3e01da83774c1a9">PRIdSIZE</a><span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00643"></a>00643                      th, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#acbd5b841dcb2158ed2111abd6b876251">thread_id</a>,
<a name="l00644"></a>00644                      th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1ee6880a07f5e4bf524af64d1ccf3ad0">native_thread_data</a>.<a class="code" href="../../d9/dae/structnative__thread__data__struct.html#a4535334b7a7e6bc0d274f19321365eba">interrupt_event</a>, stack_size);
<a name="l00645"></a>00645     }
<a name="l00646"></a>00646     <span class="keywordflow">return</span> 0;
<a name="l00647"></a>00647 }
<a name="l00648"></a>00648 
<a name="l00649"></a>00649 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00650"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#aad3775eca23c95da4d452a9fe43ebb19">00650</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#aad3775eca23c95da4d452a9fe43ebb19">native_thread_join</a>(HANDLE th)
<a name="l00651"></a>00651 {
<a name="l00652"></a>00652     <a class="code" href="../../dd/d55/thread__win32_8c.html#af545ea55128fbeb4784719faef9cb79b">w32_wait_events</a>(&amp;th, 1, INFINITE, 0);
<a name="l00653"></a>00653 }
<a name="l00654"></a>00654 
<a name="l00655"></a>00655 <span class="preprocessor">#if USE_NATIVE_THREAD_PRIORITY</span>
<a name="l00656"></a>00656 <span class="preprocessor"></span>
<a name="l00657"></a>00657 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00658"></a>00658 native_thread_apply_priority(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l00659"></a>00659 {
<a name="l00660"></a>00660     <span class="keywordtype">int</span> priority = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#aec8d3fa76bacce31680b55dd03eac0e9">priority</a>;
<a name="l00661"></a>00661     <span class="keywordflow">if</span> (th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#aec8d3fa76bacce31680b55dd03eac0e9">priority</a> &gt; 0) {
<a name="l00662"></a>00662         priority = THREAD_PRIORITY_ABOVE_NORMAL;
<a name="l00663"></a>00663     }
<a name="l00664"></a>00664     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#aec8d3fa76bacce31680b55dd03eac0e9">priority</a> &lt; 0) {
<a name="l00665"></a>00665         priority = THREAD_PRIORITY_BELOW_NORMAL;
<a name="l00666"></a>00666     }
<a name="l00667"></a>00667     <span class="keywordflow">else</span> {
<a name="l00668"></a>00668         priority = THREAD_PRIORITY_NORMAL;
<a name="l00669"></a>00669     }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671     SetThreadPriority(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#acbd5b841dcb2158ed2111abd6b876251">thread_id</a>, priority);
<a name="l00672"></a>00672 }
<a name="l00673"></a>00673 
<a name="l00674"></a>00674 <span class="preprocessor">#endif </span><span class="comment">/* USE_NATIVE_THREAD_PRIORITY */</span>
<a name="l00675"></a>00675 
<a name="l00676"></a>00676 <span class="keywordtype">int</span> <a class="code" href="../../dd/d55/thread__win32_8c.html#aee02c8bcc7c78b0f0a55d4a084b4a792">rb_w32_select_with_thread</a>(<span class="keywordtype">int</span>, fd_set *, fd_set *, fd_set *, <span class="keyword">struct</span> <a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> *, <span class="keywordtype">void</span> *);     <span class="comment">/* @internal */</span>
<a name="l00677"></a>00677 
<a name="l00678"></a>00678 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00679"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a38cf27433d36b1888913320159875e1d">00679</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a38cf27433d36b1888913320159875e1d">native_fd_select</a>(<span class="keywordtype">int</span> n, <a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> *readfds, <a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> *writefds, <a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> *exceptfds, <span class="keyword">struct</span> <a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> *timeout, <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l00680"></a>00680 {
<a name="l00681"></a>00681     fd_set *r = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *w = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *e = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00682"></a>00682     <span class="keywordflow">if</span> (readfds) {
<a name="l00683"></a>00683         <a class="code" href="../../db/d2e/intern_8h.html#af397ee7887040522c847148628cf2536">rb_fd_resize</a>(n - 1, readfds);
<a name="l00684"></a>00684         r = <a class="code" href="../../db/d2e/intern_8h.html#aebfe768c419de183574af8f8f8a20c3a">rb_fd_ptr</a>(readfds);
<a name="l00685"></a>00685     }
<a name="l00686"></a>00686     <span class="keywordflow">if</span> (writefds) {
<a name="l00687"></a>00687         <a class="code" href="../../db/d2e/intern_8h.html#af397ee7887040522c847148628cf2536">rb_fd_resize</a>(n - 1, writefds);
<a name="l00688"></a>00688         w = <a class="code" href="../../db/d2e/intern_8h.html#aebfe768c419de183574af8f8f8a20c3a">rb_fd_ptr</a>(writefds);
<a name="l00689"></a>00689     }
<a name="l00690"></a>00690     <span class="keywordflow">if</span> (exceptfds) {
<a name="l00691"></a>00691         <a class="code" href="../../db/d2e/intern_8h.html#af397ee7887040522c847148628cf2536">rb_fd_resize</a>(n - 1, exceptfds);
<a name="l00692"></a>00692         e = <a class="code" href="../../db/d2e/intern_8h.html#aebfe768c419de183574af8f8f8a20c3a">rb_fd_ptr</a>(exceptfds);
<a name="l00693"></a>00693     }
<a name="l00694"></a>00694     <span class="keywordflow">return</span> <a class="code" href="../../dd/d55/thread__win32_8c.html#aee02c8bcc7c78b0f0a55d4a084b4a792">rb_w32_select_with_thread</a>(n, r, w, e, timeout, th);
<a name="l00695"></a>00695 }
<a name="l00696"></a>00696 
<a name="l00697"></a>00697 <span class="comment">/* @internal */</span>
<a name="l00698"></a>00698 <span class="keywordtype">int</span>
<a name="l00699"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#ac6833fd36955dd1028df31aa5cfa7036">00699</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#ac6833fd36955dd1028df31aa5cfa7036">rb_w32_check_interrupt</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l00700"></a>00700 {
<a name="l00701"></a>00701     <span class="keywordflow">return</span> <a class="code" href="../../dd/d55/thread__win32_8c.html#af545ea55128fbeb4784719faef9cb79b">w32_wait_events</a>(0, 0, 0, th);
<a name="l00702"></a>00702 }
<a name="l00703"></a>00703 
<a name="l00704"></a>00704 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00705"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a16db535e7ace3a4922e8a6fcba05ae7f">00705</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a16db535e7ace3a4922e8a6fcba05ae7f">ubf_handle</a>(<span class="keywordtype">void</span> *ptr)
<a name="l00706"></a>00706 {
<a name="l00707"></a>00707     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = (<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *)ptr;
<a name="l00708"></a>00708     <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;ubf_handle: %p\n&quot;</span>, th);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <a class="code" href="../../dd/d55/thread__win32_8c.html#a61df43741ed4ac202eccf94cb670adb6">w32_set_event</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1ee6880a07f5e4bf524af64d1ccf3ad0">native_thread_data</a>.<a class="code" href="../../d9/dae/structnative__thread__data__struct.html#a4535334b7a7e6bc0d274f19321365eba">interrupt_event</a>);
<a name="l00711"></a>00711 }
<a name="l00712"></a>00712 
<a name="l00713"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a4af969f68601927039b832d82e13d40a">00713</a> <span class="keyword">static</span> HANDLE <a class="code" href="../../dd/d55/thread__win32_8c.html#a4af969f68601927039b832d82e13d40a">timer_thread_id</a> = 0;
<a name="l00714"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#ad39b71a51a576b90ea044dab6b3b886b">00714</a> <span class="keyword">static</span> HANDLE <a class="code" href="../../dd/d55/thread__win32_8c.html#ad39b71a51a576b90ea044dab6b3b886b">timer_thread_lock</a>;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> _stdcall
<a name="l00717"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a81fe98465f65bbb1bfb66ab60d7123c6">00717</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a81fe98465f65bbb1bfb66ab60d7123c6">timer_thread_func</a>(<span class="keywordtype">void</span> *dummy)
<a name="l00718"></a>00718 {
<a name="l00719"></a>00719     <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;timer_thread\n&quot;</span>);
<a name="l00720"></a>00720     <span class="keywordflow">while</span> (WaitForSingleObject(timer_thread_lock, <a class="code" href="../../d1/d1c/thread__pthread_8c.html#a0f616a99e12253578753bd5b6d4d7b08">TIME_QUANTUM_USEC</a>/1000) ==
<a name="l00721"></a>00721            WAIT_TIMEOUT) {
<a name="l00722"></a>00722         <a class="code" href="../../d3/de7/thread_8c.html#a4ff953a04ceb8333e059e4fc73a786c0">timer_thread_function</a>(dummy);
<a name="l00723"></a>00723     }
<a name="l00724"></a>00724     <a class="code" href="../../d3/de7/thread_8c.html#aa15388c1c819019d2cfa216af70f82bc">thread_debug</a>(<span class="stringliteral">&quot;timer killed\n&quot;</span>);
<a name="l00725"></a>00725     <span class="keywordflow">return</span> 0;
<a name="l00726"></a>00726 }
<a name="l00727"></a>00727 
<a name="l00728"></a>00728 <span class="keywordtype">void</span>
<a name="l00729"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a9d4e96f3fcd05963b5d43fc2ecbee3bb">00729</a> <a class="code" href="../../d1/d1c/thread__pthread_8c.html#a9d4e96f3fcd05963b5d43fc2ecbee3bb">rb_thread_wakeup_timer_thread</a>(<span class="keywordtype">void</span>)
<a name="l00730"></a>00730 {
<a name="l00731"></a>00731     <span class="comment">/* do nothing */</span>
<a name="l00732"></a>00732 }
<a name="l00733"></a>00733 
<a name="l00734"></a>00734 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00735"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#ab4a06ab941bb4f3a5e4ab37f2183f69d">00735</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#ab4a06ab941bb4f3a5e4ab37f2183f69d">rb_thread_create_timer_thread</a>(<span class="keywordtype">void</span>)
<a name="l00736"></a>00736 {
<a name="l00737"></a>00737     <span class="keywordflow">if</span> (timer_thread_id == 0) {
<a name="l00738"></a>00738         <span class="keywordflow">if</span> (!timer_thread_lock) {
<a name="l00739"></a>00739             timer_thread_lock = CreateEvent(0, <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, 0);
<a name="l00740"></a>00740         }
<a name="l00741"></a>00741         timer_thread_id = <a class="code" href="../../dd/d55/thread__win32_8c.html#a76040cdbe2a6af7471a76ccb3e206705">w32_create_thread</a>(1024 + (<a class="code" href="../../d3/de7/thread_8c.html#a90f94aa25d18b63151123512564bfdee">THREAD_DEBUG</a> ? BUFSIZ : 0),
<a name="l00742"></a>00742                                             <a class="code" href="../../dd/d55/thread__win32_8c.html#a81fe98465f65bbb1bfb66ab60d7123c6">timer_thread_func</a>, 0);
<a name="l00743"></a>00743         <a class="code" href="../../dd/d55/thread__win32_8c.html#a2e002cbcac1c21fa3157504ca9f4dba9">w32_resume_thread</a>(timer_thread_id);
<a name="l00744"></a>00744     }
<a name="l00745"></a>00745 }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00748"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#aa4d271939eb94b9e79598c2286d19ba5">00748</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#aa4d271939eb94b9e79598c2286d19ba5">native_stop_timer_thread</a>(<span class="keywordtype">int</span> close_anyway)
<a name="l00749"></a>00749 {
<a name="l00750"></a>00750     <span class="keywordtype">int</span> stopped = --<a class="code" href="../../d3/de7/thread_8c.html#aa871bbcb89aaa173181b8afa98846042">system_working</a> &lt;= 0;
<a name="l00751"></a>00751     <span class="keywordflow">if</span> (stopped) {
<a name="l00752"></a>00752         SetEvent(timer_thread_lock);
<a name="l00753"></a>00753         <a class="code" href="../../dd/d55/thread__win32_8c.html#aad3775eca23c95da4d452a9fe43ebb19">native_thread_join</a>(timer_thread_id);
<a name="l00754"></a>00754         CloseHandle(timer_thread_lock);
<a name="l00755"></a>00755         timer_thread_lock = 0;
<a name="l00756"></a>00756     }
<a name="l00757"></a>00757     <span class="keywordflow">return</span> stopped;
<a name="l00758"></a>00758 }
<a name="l00759"></a>00759 
<a name="l00760"></a>00760 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00761"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a9e14fd47cbc6b9be9b20f8d90d8ff6e1">00761</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#a9e14fd47cbc6b9be9b20f8d90d8ff6e1">native_reset_timer_thread</a>(<span class="keywordtype">void</span>)
<a name="l00762"></a>00762 {
<a name="l00763"></a>00763     <span class="keywordflow">if</span> (timer_thread_id) {
<a name="l00764"></a>00764         CloseHandle(timer_thread_id);
<a name="l00765"></a>00765         timer_thread_id = 0;
<a name="l00766"></a>00766     }
<a name="l00767"></a>00767 }
<a name="l00768"></a>00768 
<a name="l00769"></a>00769 <span class="preprocessor">#ifdef RUBY_ALLOCA_CHKSTK</span>
<a name="l00770"></a>00770 <span class="preprocessor"></span><span class="keywordtype">void</span>
<a name="l00771"></a>00771 ruby_alloca_chkstk(<span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <span class="keywordtype">void</span> *sp)
<a name="l00772"></a>00772 {
<a name="l00773"></a>00773     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a472cd8893c0b7fcebc3111f097d32c03">ruby_stack_length</a>(NULL) * <span class="keyword">sizeof</span>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>) &gt;= len) {
<a name="l00774"></a>00774         <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l00775"></a>00775         <span class="keywordflow">if</span> (!<a class="code" href="../../dd/dd0/eval__intern_8h.html#a40f71161eb564f27c55a07db70d16643">rb_thread_raised_p</a>(th, <a class="code" href="../../dd/dd0/eval__intern_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da70f54790bd8bd0a6112026ddfa732459">RAISED_STACKOVERFLOW</a>)) {
<a name="l00776"></a>00776             <a class="code" href="../../dd/dd0/eval__intern_8h.html#a19275cde4c1d1413887ef2e1c948aa88">rb_thread_raised_set</a>(th, <a class="code" href="../../dd/dd0/eval__intern_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2da70f54790bd8bd0a6112026ddfa732459">RAISED_STACKOVERFLOW</a>);
<a name="l00777"></a>00777             <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(<a class="code" href="../../d8/d32/vm__core_8h.html#a7acad2ca9baf84e4d6cb6e68cd3da73f">sysstack_error</a>);
<a name="l00778"></a>00778         }
<a name="l00779"></a>00779     }
<a name="l00780"></a>00780 }
<a name="l00781"></a>00781 <span class="preprocessor">#endif</span>
<a name="l00782"></a>00782 <span class="preprocessor"></span><span class="keywordtype">int</span>
<a name="l00783"></a><a class="code" href="../../dd/d55/thread__win32_8c.html#a99e6a1aee4d7f246bde93617c860767a">00783</a> <a class="code" href="../../db/d2e/intern_8h.html#a99e6a1aee4d7f246bde93617c860767a">rb_reserved_fd_p</a>(<span class="keywordtype">int</span> fd)
<a name="l00784"></a>00784 {
<a name="l00785"></a>00785     <span class="keywordflow">return</span> 0;
<a name="l00786"></a>00786 }
<a name="l00787"></a>00787 <span class="preprocessor">#endif </span><span class="comment">/* THREAD_SYSTEM_DEPENDENT_IMPLEMENTATION */</span>
<a name="l00788"></a>00788 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Mar 2013 for Ruby by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
