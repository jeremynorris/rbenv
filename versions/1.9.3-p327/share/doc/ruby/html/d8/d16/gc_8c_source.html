<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Ruby: gc.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>gc.c</h1><a href="../../d8/d16/gc_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/**********************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  gc.c -</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">  $Author: naruse $</span>
<a name="l00006"></a>00006 <span class="comment">  created at: Tue Oct  5 09:44:46 JST 1993</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment">  Copyright (C) 1993-2007 Yukihiro Matsumoto</span>
<a name="l00009"></a>00009 <span class="comment">  Copyright (C) 2000  Network Applied Communication Laboratory, Inc.</span>
<a name="l00010"></a>00010 <span class="comment">  Copyright (C) 2000  Information-technology Promotion Agency, Japan</span>
<a name="l00011"></a>00011 <span class="comment"></span>
<a name="l00012"></a>00012 <span class="comment">**********************************************************************/</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="../../de/de6/ruby_2ruby_8h.html">ruby/ruby.h</a>&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d24/st_8h.html">ruby/st.h</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="../../db/db6/re_8h.html">ruby/re.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/dac/io_8h.html">ruby/io.h</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d3c/util_8h.html">ruby/util.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/dd0/eval__intern_8h.html">eval_intern.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d32/vm__core_8h.html">vm_core.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="../../db/dde/internal_8h.html">internal.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/daa/gc_8h.html">gc.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d17/constant_8h.html">constant.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;setjmp.h&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="preprocessor">#ifdef HAVE_SYS_TIME_H</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#endif</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span>
<a name="l00032"></a>00032 <span class="preprocessor">#ifdef HAVE_SYS_RESOURCE_H</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/resource.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#endif</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span>
<a name="l00036"></a>00036 <span class="preprocessor">#if defined _WIN32 || defined __CYGWIN__</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#include &lt;windows.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#endif</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span>
<a name="l00040"></a>00040 <span class="preprocessor">#ifdef HAVE_VALGRIND_MEMCHECK_H</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span><span class="preprocessor"># include &lt;valgrind/memcheck.h&gt;</span>
<a name="l00042"></a>00042 <span class="preprocessor"># ifndef VALGRIND_MAKE_MEM_DEFINED</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#  define VALGRIND_MAKE_MEM_DEFINED(p, n) VALGRIND_MAKE_READABLE((p), (n))</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor"># endif</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span><span class="preprocessor"># ifndef VALGRIND_MAKE_MEM_UNDEFINED</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span><span class="preprocessor">#  define VALGRIND_MAKE_MEM_UNDEFINED(p, n) VALGRIND_MAKE_WRITABLE((p), (n))</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span><span class="preprocessor"># endif</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00049"></a><a class="code" href="../../d8/d16/gc_8c.html#a17eefcd003c6b1e9429ccbd40496e594">00049</a> <span class="preprocessor"></span><span class="preprocessor"># define VALGRIND_MAKE_MEM_DEFINED(p, n) </span><span class="comment">/* empty */</span>
<a name="l00050"></a><a class="code" href="../../d8/d16/gc_8c.html#ae893baae242001d89c2319ab442fc610">00050</a> <span class="preprocessor"># define VALGRIND_MAKE_MEM_UNDEFINED(p, n) </span><span class="comment">/* empty */</span>
<a name="l00051"></a>00051 <span class="preprocessor">#endif</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span>
<a name="l00053"></a><a class="code" href="../../d8/d16/gc_8c.html#afd9f85d947337cd1ecf3a2ce138feb10">00053</a> <span class="preprocessor">#define rb_setjmp(env) RUBY_SETJMP(env)</span>
<a name="l00054"></a><a class="code" href="../../d8/d16/gc_8c.html#af6a4d0fda9a5b91dee22b1cfdbbb7164">00054</a> <span class="preprocessor"></span><span class="preprocessor">#define rb_jmp_buf rb_jmpbuf_t</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span>
<a name="l00056"></a>00056 <span class="comment">/* Make alloca work the best possible way.  */</span>
<a name="l00057"></a>00057 <span class="preprocessor">#ifdef __GNUC__</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor"># ifndef atarist</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span><span class="preprocessor">#  ifndef alloca</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span><span class="preprocessor">#   define alloca __builtin_alloca</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span><span class="preprocessor">#  endif</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span><span class="preprocessor"># endif </span><span class="comment">/* atarist */</span>
<a name="l00063"></a>00063 <span class="preprocessor">#else</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span><span class="preprocessor"># ifdef HAVE_ALLOCA_H</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;alloca.h&gt;</span>
<a name="l00066"></a>00066 <span class="preprocessor"># else</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span><span class="preprocessor">#  ifdef _AIX</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span><span class="preprocessor"> #pragma alloca</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span><span class="preprocessor">#  else</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span><span class="preprocessor">#   ifndef alloca </span><span class="comment">/* predefined by HP cc +Olibcalls */</span>
<a name="l00071"></a>00071 <span class="keywordtype">void</span> *<a class="code" href="../../dd/dd0/eval__intern_8h.html#a5eaa91cfa91453835de541a76ac3a213">alloca</a> ();
<a name="l00072"></a>00072 <span class="preprocessor">#   endif</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span><span class="preprocessor">#  endif </span><span class="comment">/* AIX */</span>
<a name="l00074"></a>00074 <span class="preprocessor"># endif </span><span class="comment">/* HAVE_ALLOCA_H */</span>
<a name="l00075"></a>00075 <span class="preprocessor">#endif </span><span class="comment">/* __GNUC__ */</span>
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 <span class="preprocessor">#ifndef GC_MALLOC_LIMIT</span>
<a name="l00078"></a><a class="code" href="../../d8/d16/gc_8c.html#a833cc6d14225609eb79c833b89be7457">00078</a> <span class="preprocessor"></span><span class="preprocessor">#define GC_MALLOC_LIMIT 8000000</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00080"></a><a class="code" href="../../d8/d16/gc_8c.html#a323a78736c2adfb81b32f30dfcbed8a7">00080</a> <span class="preprocessor"></span><span class="preprocessor">#define HEAP_MIN_SLOTS 10000</span>
<a name="l00081"></a><a class="code" href="../../d8/d16/gc_8c.html#a03cc7fd803118e133c4fab5f30259a24">00081</a> <span class="preprocessor"></span><span class="preprocessor">#define FREE_MIN  4096</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span>
<a name="l00083"></a><a class="code" href="../../d2/db7/structruby__gc__params__t.html">00083</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00084"></a><a class="code" href="../../d2/db7/structruby__gc__params__t.html#a6cdae74a7b7e25abfecf16ac7fab14b0">00084</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d16/gc_8c.html#a2f761e8733e04a9982316226de3bae1d">initial_malloc_limit</a>;
<a name="l00085"></a><a class="code" href="../../d2/db7/structruby__gc__params__t.html#a3dcd7363af0ae85a5d7e54d3a16cf093">00085</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d16/gc_8c.html#af98c6835eb4ba334b98c1de2eb0852f1">initial_heap_min_slots</a>;
<a name="l00086"></a><a class="code" href="../../d2/db7/structruby__gc__params__t.html#a35ca6aec28b0439ff2a47b81b78e162a">00086</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d16/gc_8c.html#a92ac65c13d9b117db8b96ae052c6ba09">initial_free_min</a>;
<a name="l00087"></a><a class="code" href="../../d2/db7/structruby__gc__params__t.html#ad7dbe3dcdb5b727b866fe5288c7c3bec">00087</a>     <span class="keywordtype">int</span> gc_stress;
<a name="l00088"></a>00088 } <a class="code" href="../../d2/db7/structruby__gc__params__t.html">ruby_gc_params_t</a>;
<a name="l00089"></a>00089 
<a name="l00090"></a><a class="code" href="../../d8/d16/gc_8c.html#a115c4d71e44a13de2c43f636ba4c5ce6">00090</a> <a class="code" href="../../d2/db7/structruby__gc__params__t.html">ruby_gc_params_t</a> <a class="code" href="../../d8/d16/gc_8c.html#a115c4d71e44a13de2c43f636ba4c5ce6">initial_params</a> = {
<a name="l00091"></a>00091     <a class="code" href="../../d8/d16/gc_8c.html#a833cc6d14225609eb79c833b89be7457">GC_MALLOC_LIMIT</a>,
<a name="l00092"></a>00092     <a class="code" href="../../d8/d16/gc_8c.html#a323a78736c2adfb81b32f30dfcbed8a7">HEAP_MIN_SLOTS</a>,
<a name="l00093"></a>00093     <a class="code" href="../../d8/d16/gc_8c.html#a03cc7fd803118e133c4fab5f30259a24">FREE_MIN</a>,
<a name="l00094"></a>00094 <span class="preprocessor">#if defined(ENABLE_VM_OBJSPACE) &amp;&amp; ENABLE_VM_OBJSPACE</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>    <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>,
<a name="l00096"></a>00096 <span class="preprocessor">#endif</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>};
<a name="l00098"></a>00098 
<a name="l00099"></a><a class="code" href="../../d8/d16/gc_8c.html#a5a548be06ee9f1eb5fd707c9d20da90c">00099</a> <span class="preprocessor">#define nomem_error GET_VM()-&gt;special_exceptions[ruby_error_nomemory]</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span>
<a name="l00101"></a><a class="code" href="../../d8/d16/gc_8c.html#a1673f550d1f0e94fec118e6b0a1f2bd3">00101</a> <span class="preprocessor">#define MARK_STACK_MAX 1024</span>
<a name="l00102"></a>00102 <span class="preprocessor"></span>
<a name="l00103"></a><a class="code" href="../../d8/d16/gc_8c.html#a8416510f5605ae0367ca55ac8ee09aeb">00103</a> <span class="keywordtype">int</span> <a class="code" href="../../d8/d16/gc_8c.html#a8416510f5605ae0367ca55ac8ee09aeb">ruby_gc_debug_indent</a> = 0;
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="comment">/* for GC profile */</span>
<a name="l00106"></a><a class="code" href="../../d8/d16/gc_8c.html#afd1de76982e7292a8f44a70475635f80">00106</a> <span class="preprocessor">#define GC_PROFILE_MORE_DETAIL 0</span>
<a name="l00107"></a><a class="code" href="../../d6/dc6/structgc__profile__record.html">00107</a> <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/dc6/structgc__profile__record.html">gc_profile_record</a> {
<a name="l00108"></a><a class="code" href="../../d6/dc6/structgc__profile__record.html#afc1b81459304949270edd36a131eb7a8">00108</a>     <span class="keywordtype">double</span> <a class="code" href="../../d6/dc6/structgc__profile__record.html#afc1b81459304949270edd36a131eb7a8">gc_time</a>;
<a name="l00109"></a><a class="code" href="../../d6/dc6/structgc__profile__record.html#a83cd092713937e19422e97063c70829a">00109</a>     <span class="keywordtype">double</span> <a class="code" href="../../d6/dc6/structgc__profile__record.html#a83cd092713937e19422e97063c70829a">gc_mark_time</a>;
<a name="l00110"></a><a class="code" href="../../d6/dc6/structgc__profile__record.html#a92ad4bf645726c16307cbf5252653916">00110</a>     <span class="keywordtype">double</span> <a class="code" href="../../d6/dc6/structgc__profile__record.html#a92ad4bf645726c16307cbf5252653916">gc_sweep_time</a>;
<a name="l00111"></a><a class="code" href="../../d6/dc6/structgc__profile__record.html#a3ae440b98bbe58e3dad0230cac016a90">00111</a>     <span class="keywordtype">double</span> <a class="code" href="../../d6/dc6/structgc__profile__record.html#a3ae440b98bbe58e3dad0230cac016a90">gc_invoke_time</a>;
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="../../d6/dc6/structgc__profile__record.html#a1e9969385cb8c8e8304d148a969f2f11">00113</a>     <span class="keywordtype">size_t</span> <a class="code" href="../../d6/dc6/structgc__profile__record.html#a1e9969385cb8c8e8304d148a969f2f11">heap_use_slots</a>;
<a name="l00114"></a><a class="code" href="../../d6/dc6/structgc__profile__record.html#a2899c8bd7fac2079942cd7cad2f19c41">00114</a>     <span class="keywordtype">size_t</span> <a class="code" href="../../d6/dc6/structgc__profile__record.html#a2899c8bd7fac2079942cd7cad2f19c41">heap_live_objects</a>;
<a name="l00115"></a><a class="code" href="../../d6/dc6/structgc__profile__record.html#a55ade9d92a69df6fd9c9dffacf5d644b">00115</a>     <span class="keywordtype">size_t</span> <a class="code" href="../../d6/dc6/structgc__profile__record.html#a55ade9d92a69df6fd9c9dffacf5d644b">heap_free_objects</a>;
<a name="l00116"></a><a class="code" href="../../d6/dc6/structgc__profile__record.html#ae562b7d7e8cb29fb3eae43c068639bf9">00116</a>     <span class="keywordtype">size_t</span> <a class="code" href="../../d6/dc6/structgc__profile__record.html#ae562b7d7e8cb29fb3eae43c068639bf9">heap_total_objects</a>;
<a name="l00117"></a><a class="code" href="../../d6/dc6/structgc__profile__record.html#aaaefa4991d4ae9d69b46dbbfa8f88133">00117</a>     <span class="keywordtype">size_t</span> <a class="code" href="../../d6/dc6/structgc__profile__record.html#aaaefa4991d4ae9d69b46dbbfa8f88133">heap_use_size</a>;
<a name="l00118"></a><a class="code" href="../../d6/dc6/structgc__profile__record.html#ae5bc3d7dc6a7b7c52631e5cdaf2e0669">00118</a>     <span class="keywordtype">size_t</span> <a class="code" href="../../d6/dc6/structgc__profile__record.html#ae5bc3d7dc6a7b7c52631e5cdaf2e0669">heap_total_size</a>;
<a name="l00119"></a>00119 
<a name="l00120"></a><a class="code" href="../../d6/dc6/structgc__profile__record.html#ac64ac9c78efd6644ac99d3c18c63706f">00120</a>     <span class="keywordtype">int</span> <a class="code" href="../../d6/dc6/structgc__profile__record.html#ac64ac9c78efd6644ac99d3c18c63706f">have_finalize</a>;
<a name="l00121"></a><a class="code" href="../../d6/dc6/structgc__profile__record.html#acf6cde8485aa059680e91831e10bf4f7">00121</a>     <span class="keywordtype">int</span> <a class="code" href="../../d6/dc6/structgc__profile__record.html#acf6cde8485aa059680e91831e10bf4f7">is_marked</a>;
<a name="l00122"></a>00122 
<a name="l00123"></a><a class="code" href="../../d6/dc6/structgc__profile__record.html#aee8b9e3a45c15c9be61aabe45ef161f9">00123</a>     <span class="keywordtype">size_t</span> <a class="code" href="../../d6/dc6/structgc__profile__record.html#aee8b9e3a45c15c9be61aabe45ef161f9">allocate_increase</a>;
<a name="l00124"></a><a class="code" href="../../d6/dc6/structgc__profile__record.html#ab1f30d8ec1d595e8f93fc8fce684d0f2">00124</a>     <span class="keywordtype">size_t</span> <a class="code" href="../../d6/dc6/structgc__profile__record.html#ab1f30d8ec1d595e8f93fc8fce684d0f2">allocate_limit</a>;
<a name="l00125"></a>00125 } <a class="code" href="../../d6/dc6/structgc__profile__record.html">gc_profile_record</a>;
<a name="l00126"></a>00126 
<a name="l00127"></a>00127 <span class="keyword">static</span> <span class="keywordtype">double</span>
<a name="l00128"></a><a class="code" href="../../d8/d16/gc_8c.html#a329edc8e2e8049fa7b5a08a83eb8261f">00128</a> <a class="code" href="../../d8/d16/gc_8c.html#a329edc8e2e8049fa7b5a08a83eb8261f">getrusage_time</a>(<span class="keywordtype">void</span>)
<a name="l00129"></a>00129 {
<a name="l00130"></a>00130 <span class="preprocessor">#ifdef RUSAGE_SELF</span>
<a name="l00131"></a>00131 <span class="preprocessor"></span>    <span class="keyword">struct </span>rusage usage;
<a name="l00132"></a>00132     <span class="keyword">struct </span><a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> time;
<a name="l00133"></a>00133     <a class="code" href="../../d1/d68/missing-pips_8c.html#acf3118ce39370dbc808ee9528cac75a4">getrusage</a>(RUSAGE_SELF, &amp;usage);
<a name="l00134"></a>00134     time = usage.ru_utime;
<a name="l00135"></a>00135     <span class="keywordflow">return</span> time.<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> + time.<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> * 1e-6;
<a name="l00136"></a>00136 <span class="preprocessor">#elif defined _WIN32</span>
<a name="l00137"></a>00137 <span class="preprocessor"></span>    FILETIME creation_time, exit_time, kernel_time, user_time;
<a name="l00138"></a>00138     ULARGE_INTEGER ui;
<a name="l00139"></a>00139     LONG_LONG q;
<a name="l00140"></a>00140     <span class="keywordtype">double</span> t;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142     <span class="keywordflow">if</span> (GetProcessTimes(GetCurrentProcess(),
<a name="l00143"></a>00143                         &amp;creation_time, &amp;exit_time, &amp;kernel_time, &amp;user_time) == 0)
<a name="l00144"></a>00144     {
<a name="l00145"></a>00145         <span class="keywordflow">return</span> 0.0;
<a name="l00146"></a>00146     }
<a name="l00147"></a>00147     memcpy(&amp;ui, &amp;user_time, <span class="keyword">sizeof</span>(FILETIME));
<a name="l00148"></a>00148     q = ui.QuadPart / 10L;
<a name="l00149"></a>00149     t = (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)(q % 1000000L) * 1e-6;
<a name="l00150"></a>00150     q /= 1000000L;
<a name="l00151"></a>00151 <span class="preprocessor">#ifdef __GNUC__</span>
<a name="l00152"></a>00152 <span class="preprocessor"></span>    t += q;
<a name="l00153"></a>00153 <span class="preprocessor">#else</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span>    t += (double)(<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)(q &gt;&gt; 16) * (1 &lt;&lt; 16);
<a name="l00155"></a>00155     t += (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)q &amp; ~(~0 &lt;&lt; 16);
<a name="l00156"></a>00156 <span class="preprocessor">#endif</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span>    <span class="keywordflow">return</span> t;
<a name="l00158"></a>00158 <span class="preprocessor">#else</span>
<a name="l00159"></a>00159 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 0.0;
<a name="l00160"></a>00160 <span class="preprocessor">#endif</span>
<a name="l00161"></a>00161 <span class="preprocessor"></span>}
<a name="l00162"></a>00162 
<a name="l00163"></a><a class="code" href="../../d8/d16/gc_8c.html#a0f4426fd7b01c2bf74b429c4d38c69ed">00163</a> <span class="preprocessor">#define GC_PROF_TIMER_START do {\</span>
<a name="l00164"></a>00164 <span class="preprocessor">        if (objspace-&gt;profile.run) {\</span>
<a name="l00165"></a>00165 <span class="preprocessor">            if (!objspace-&gt;profile.record) {\</span>
<a name="l00166"></a>00166 <span class="preprocessor">                objspace-&gt;profile.size = 1000;\</span>
<a name="l00167"></a>00167 <span class="preprocessor">                objspace-&gt;profile.record = malloc(sizeof(gc_profile_record) * objspace-&gt;profile.size);\</span>
<a name="l00168"></a>00168 <span class="preprocessor">            }\</span>
<a name="l00169"></a>00169 <span class="preprocessor">            if (count &gt;= objspace-&gt;profile.size) {\</span>
<a name="l00170"></a>00170 <span class="preprocessor">                objspace-&gt;profile.size += 1000;\</span>
<a name="l00171"></a>00171 <span class="preprocessor">                objspace-&gt;profile.record = realloc(objspace-&gt;profile.record, sizeof(gc_profile_record) * objspace-&gt;profile.size);\</span>
<a name="l00172"></a>00172 <span class="preprocessor">            }\</span>
<a name="l00173"></a>00173 <span class="preprocessor">            if (!objspace-&gt;profile.record) {\</span>
<a name="l00174"></a>00174 <span class="preprocessor">                rb_bug(&quot;gc_profile malloc or realloc miss&quot;);\</span>
<a name="l00175"></a>00175 <span class="preprocessor">            }\</span>
<a name="l00176"></a>00176 <span class="preprocessor">            MEMZERO(&amp;objspace-&gt;profile.record[count], gc_profile_record, 1);\</span>
<a name="l00177"></a>00177 <span class="preprocessor">            gc_time = getrusage_time();\</span>
<a name="l00178"></a>00178 <span class="preprocessor">            objspace-&gt;profile.record[count].gc_invoke_time = gc_time - objspace-&gt;profile.invoke_time;\</span>
<a name="l00179"></a>00179 <span class="preprocessor">        }\</span>
<a name="l00180"></a>00180 <span class="preprocessor">    } while(0)</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span>
<a name="l00182"></a><a class="code" href="../../d8/d16/gc_8c.html#afd036d5f19b0b4d1b0ba75654fd85b72">00182</a> <span class="preprocessor">#define GC_PROF_TIMER_STOP(marked) do {\</span>
<a name="l00183"></a>00183 <span class="preprocessor">        if (objspace-&gt;profile.run) {\</span>
<a name="l00184"></a>00184 <span class="preprocessor">            gc_time = getrusage_time() - gc_time;\</span>
<a name="l00185"></a>00185 <span class="preprocessor">            if (gc_time &lt; 0) gc_time = 0;\</span>
<a name="l00186"></a>00186 <span class="preprocessor">            objspace-&gt;profile.record[count].gc_time = gc_time;\</span>
<a name="l00187"></a>00187 <span class="preprocessor">            objspace-&gt;profile.record[count].is_marked = !!(marked);\</span>
<a name="l00188"></a>00188 <span class="preprocessor">            GC_PROF_SET_HEAP_INFO(objspace-&gt;profile.record[count]);\</span>
<a name="l00189"></a>00189 <span class="preprocessor">            objspace-&gt;profile.count++;\</span>
<a name="l00190"></a>00190 <span class="preprocessor">        }\</span>
<a name="l00191"></a>00191 <span class="preprocessor">    } while(0)</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span>
<a name="l00193"></a>00193 <span class="preprocessor">#if GC_PROFILE_MORE_DETAIL</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span><span class="preprocessor">#define INIT_GC_PROF_PARAMS double gc_time = 0, sweep_time = 0;\</span>
<a name="l00195"></a>00195 <span class="preprocessor">    size_t count = objspace-&gt;profile.count, total = 0, live = 0</span>
<a name="l00196"></a>00196 <span class="preprocessor"></span>
<a name="l00197"></a>00197 <span class="preprocessor">#define GC_PROF_MARK_TIMER_START double mark_time = 0;\</span>
<a name="l00198"></a>00198 <span class="preprocessor">    do {\</span>
<a name="l00199"></a>00199 <span class="preprocessor">        if (objspace-&gt;profile.run) {\</span>
<a name="l00200"></a>00200 <span class="preprocessor">            mark_time = getrusage_time();\</span>
<a name="l00201"></a>00201 <span class="preprocessor">        }\</span>
<a name="l00202"></a>00202 <span class="preprocessor">    } while(0)</span>
<a name="l00203"></a>00203 <span class="preprocessor"></span>
<a name="l00204"></a>00204 <span class="preprocessor">#define GC_PROF_MARK_TIMER_STOP do {\</span>
<a name="l00205"></a>00205 <span class="preprocessor">        if (objspace-&gt;profile.run) {\</span>
<a name="l00206"></a>00206 <span class="preprocessor">            mark_time = getrusage_time() - mark_time;\</span>
<a name="l00207"></a>00207 <span class="preprocessor">            if (mark_time &lt; 0) mark_time = 0;\</span>
<a name="l00208"></a>00208 <span class="preprocessor">            objspace-&gt;profile.record[objspace-&gt;profile.count].gc_mark_time = mark_time;\</span>
<a name="l00209"></a>00209 <span class="preprocessor">        }\</span>
<a name="l00210"></a>00210 <span class="preprocessor">    } while(0)</span>
<a name="l00211"></a>00211 <span class="preprocessor"></span>
<a name="l00212"></a>00212 <span class="preprocessor">#define GC_PROF_SWEEP_TIMER_START do {\</span>
<a name="l00213"></a>00213 <span class="preprocessor">        if (objspace-&gt;profile.run) {\</span>
<a name="l00214"></a>00214 <span class="preprocessor">            sweep_time = getrusage_time();\</span>
<a name="l00215"></a>00215 <span class="preprocessor">        }\</span>
<a name="l00216"></a>00216 <span class="preprocessor">    } while(0)</span>
<a name="l00217"></a>00217 <span class="preprocessor"></span>
<a name="l00218"></a>00218 <span class="preprocessor">#define GC_PROF_SWEEP_TIMER_STOP do {\</span>
<a name="l00219"></a>00219 <span class="preprocessor">        if (objspace-&gt;profile.run) {\</span>
<a name="l00220"></a>00220 <span class="preprocessor">            sweep_time = getrusage_time() - sweep_time;\</span>
<a name="l00221"></a>00221 <span class="preprocessor">            if (sweep_time &lt; 0) sweep_time = 0;\</span>
<a name="l00222"></a>00222 <span class="preprocessor">            objspace-&gt;profile.record[count].gc_sweep_time = sweep_time;\</span>
<a name="l00223"></a>00223 <span class="preprocessor">        }\</span>
<a name="l00224"></a>00224 <span class="preprocessor">    } while(0)</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span><span class="preprocessor">#define GC_PROF_SET_MALLOC_INFO do {\</span>
<a name="l00226"></a>00226 <span class="preprocessor">        if (objspace-&gt;profile.run) {\</span>
<a name="l00227"></a>00227 <span class="preprocessor">            gc_profile_record *record = &amp;objspace-&gt;profile.record[objspace-&gt;profile.count];\</span>
<a name="l00228"></a>00228 <span class="preprocessor">            record-&gt;allocate_increase = malloc_increase;\</span>
<a name="l00229"></a>00229 <span class="preprocessor">            record-&gt;allocate_limit = malloc_limit; \</span>
<a name="l00230"></a>00230 <span class="preprocessor">        }\</span>
<a name="l00231"></a>00231 <span class="preprocessor">    } while(0)</span>
<a name="l00232"></a>00232 <span class="preprocessor"></span><span class="preprocessor">#define GC_PROF_SET_HEAP_INFO(record) do {\</span>
<a name="l00233"></a>00233 <span class="preprocessor">        live = objspace-&gt;heap.live_num;\</span>
<a name="l00234"></a>00234 <span class="preprocessor">        total = heaps_used * HEAP_OBJ_LIMIT;\</span>
<a name="l00235"></a>00235 <span class="preprocessor">        (record).heap_use_slots = heaps_used;\</span>
<a name="l00236"></a>00236 <span class="preprocessor">        (record).heap_live_objects = live;\</span>
<a name="l00237"></a>00237 <span class="preprocessor">        (record).heap_free_objects = total - live;\</span>
<a name="l00238"></a>00238 <span class="preprocessor">        (record).heap_total_objects = total;\</span>
<a name="l00239"></a>00239 <span class="preprocessor">        (record).have_finalize = deferred_final_list ? Qtrue : Qfalse;\</span>
<a name="l00240"></a>00240 <span class="preprocessor">        (record).heap_use_size = live * sizeof(RVALUE);\</span>
<a name="l00241"></a>00241 <span class="preprocessor">        (record).heap_total_size = total * sizeof(RVALUE);\</span>
<a name="l00242"></a>00242 <span class="preprocessor">    } while(0)</span>
<a name="l00243"></a>00243 <span class="preprocessor"></span><span class="preprocessor">#define GC_PROF_INC_LIVE_NUM objspace-&gt;heap.live_num++</span>
<a name="l00244"></a>00244 <span class="preprocessor"></span><span class="preprocessor">#define GC_PROF_DEC_LIVE_NUM objspace-&gt;heap.live_num--</span>
<a name="l00245"></a>00245 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00246"></a><a class="code" href="../../d8/d16/gc_8c.html#adcecd8929620c2efedc87d949f9d70c7">00246</a> <span class="preprocessor"></span><span class="preprocessor">#define INIT_GC_PROF_PARAMS double gc_time = 0;\</span>
<a name="l00247"></a>00247 <span class="preprocessor">    size_t count = objspace-&gt;profile.count, total = 0, live = 0</span>
<a name="l00248"></a><a class="code" href="../../d8/d16/gc_8c.html#afe93f153de1f97b49f8a2cb3534efed5">00248</a> <span class="preprocessor"></span><span class="preprocessor">#define GC_PROF_MARK_TIMER_START</span>
<a name="l00249"></a><a class="code" href="../../d8/d16/gc_8c.html#a3c5e604aecb72dc1c35a647ee880686d">00249</a> <span class="preprocessor"></span><span class="preprocessor">#define GC_PROF_MARK_TIMER_STOP</span>
<a name="l00250"></a><a class="code" href="../../d8/d16/gc_8c.html#a7628bfffdd08c29df946bd922179f9ca">00250</a> <span class="preprocessor"></span><span class="preprocessor">#define GC_PROF_SWEEP_TIMER_START</span>
<a name="l00251"></a><a class="code" href="../../d8/d16/gc_8c.html#a4c6e2653b932903b441b181b5a98ef51">00251</a> <span class="preprocessor"></span><span class="preprocessor">#define GC_PROF_SWEEP_TIMER_STOP</span>
<a name="l00252"></a><a class="code" href="../../d8/d16/gc_8c.html#a5a00da4dda7d71ac309d078a8e537970">00252</a> <span class="preprocessor"></span><span class="preprocessor">#define GC_PROF_SET_MALLOC_INFO</span>
<a name="l00253"></a><a class="code" href="../../d8/d16/gc_8c.html#a1ef59845d099cbe4f6d666be7ecd1c7a">00253</a> <span class="preprocessor"></span><span class="preprocessor">#define GC_PROF_SET_HEAP_INFO(record) do {\</span>
<a name="l00254"></a>00254 <span class="preprocessor">        live = objspace-&gt;heap.live_num;\</span>
<a name="l00255"></a>00255 <span class="preprocessor">        total = heaps_used * HEAP_OBJ_LIMIT;\</span>
<a name="l00256"></a>00256 <span class="preprocessor">        (record).heap_total_objects = total;\</span>
<a name="l00257"></a>00257 <span class="preprocessor">        (record).heap_use_size = live * sizeof(RVALUE);\</span>
<a name="l00258"></a>00258 <span class="preprocessor">        (record).heap_total_size = total * sizeof(RVALUE);\</span>
<a name="l00259"></a>00259 <span class="preprocessor">    } while(0)</span>
<a name="l00260"></a><a class="code" href="../../d8/d16/gc_8c.html#a7ffed23fc49f552c28709b0f3e00f5ed">00260</a> <span class="preprocessor"></span><span class="preprocessor">#define GC_PROF_INC_LIVE_NUM</span>
<a name="l00261"></a><a class="code" href="../../d8/d16/gc_8c.html#a099dbbf45d09b64ccea651186b19fc68">00261</a> <span class="preprocessor"></span><span class="preprocessor">#define GC_PROF_DEC_LIVE_NUM</span>
<a name="l00262"></a>00262 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00263"></a>00263 <span class="preprocessor"></span>
<a name="l00264"></a>00264 
<a name="l00265"></a>00265 <span class="preprocessor">#if defined(_MSC_VER) || defined(__BORLANDC__) || defined(__CYGWIN__)</span>
<a name="l00266"></a>00266 <span class="preprocessor"></span><span class="preprocessor">#pragma pack(push, 1) </span><span class="comment">/* magic for reducing sizeof(RVALUE): 24 -&gt; 20 */</span>
<a name="l00267"></a>00267 <span class="preprocessor">#endif</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span>
<a name="l00269"></a>00269 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> {
<a name="l00270"></a>00270     <span class="keyword">union </span>{
<a name="l00271"></a>00271         <span class="keyword">struct </span>{
<a name="l00272"></a><a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a39f6e45489bc3d6aa366545ccc3b9478">00272</a>             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a39f6e45489bc3d6aa366545ccc3b9478">flags</a>;                <span class="comment">/* always 0 for freed obj */</span>
<a name="l00273"></a><a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#afb77c97e6f7fc6f3f258cd2259ddad16">00273</a>             <span class="keyword">struct </span><a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#afb77c97e6f7fc6f3f258cd2259ddad16">next</a>;
<a name="l00274"></a>00274         } <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#af8cb8a1856ec08aeed677584f8930880">free</a>;
<a name="l00275"></a>00275         <span class="keyword">struct </span><a class="code" href="../../d2/d22/struct_r_basic.html">RBasic</a>  <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>;
<a name="l00276"></a>00276         <span class="keyword">struct </span><a class="code" href="../../d7/da9/struct_r_object.html">RObject</a> <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a7da8ddcdf15cb61f40a944846d4e24a5">object</a>;
<a name="l00277"></a>00277         <span class="keyword">struct </span><a class="code" href="../../d5/d14/struct_r_class.html">RClass</a>  <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a2c96abf264bbd1bf0d640a87c187c992">klass</a>;
<a name="l00278"></a><a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#aa1708e570aac4fde30c8b74cd3d61262">00278</a>         <span class="keyword">struct </span><a class="code" href="../../db/dcd/struct_r_float.html">RFloat</a>  <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#aa1708e570aac4fde30c8b74cd3d61262">flonum</a>;
<a name="l00279"></a><a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#adf179b340c37d4f5b14fb06c2431214f">00279</a>         <span class="keyword">struct </span><a class="code" href="../../dd/d63/struct_r_string.html">RString</a> <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#adf179b340c37d4f5b14fb06c2431214f">string</a>;
<a name="l00280"></a>00280         <span class="keyword">struct </span><a class="code" href="../../dd/d8b/struct_r_array.html">RArray</a>  <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a9604d38ae2aaa6ccb4033a2e2908f832">array</a>;
<a name="l00281"></a><a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#aa3fecd4c586a9a8e040e75c9b144cad4">00281</a>         <span class="keyword">struct </span><a class="code" href="../../d5/d8b/struct_r_regexp.html">RRegexp</a> <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#aa3fecd4c586a9a8e040e75c9b144cad4">regexp</a>;
<a name="l00282"></a>00282         <span class="keyword">struct </span><a class="code" href="../../df/d3a/struct_r_hash.html">RHash</a>   <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a17e2439f96c5d71ad07ef32abfcb2f6e">hash</a>;
<a name="l00283"></a><a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a2a582321ccfa06c0485977c88de71d2d">00283</a>         <span class="keyword">struct </span><a class="code" href="../../d0/dcf/struct_r_data.html">RData</a>   <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a2a582321ccfa06c0485977c88de71d2d">data</a>;
<a name="l00284"></a><a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ac5b5f8701cc82db574b50da73b3bd6d8">00284</a>         <span class="keyword">struct </span><a class="code" href="../../d6/d45/struct_r_typed_data.html">RTypedData</a>   <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ac5b5f8701cc82db574b50da73b3bd6d8">typeddata</a>;
<a name="l00285"></a>00285         <span class="keyword">struct </span><a class="code" href="../../d4/d1a/struct_r_struct.html">RStruct</a> <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ae9a788cb7d2c0bb076e9bc0341e96c07">rstruct</a>;
<a name="l00286"></a><a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a7575acb16fef3a9e0aff3114537a5abd">00286</a>         <span class="keyword">struct </span><a class="code" href="../../d3/d44/struct_r_bignum.html">RBignum</a> <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a7575acb16fef3a9e0aff3114537a5abd">bignum</a>;
<a name="l00287"></a><a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a97cd726dd7aa22970264f034cd494c99">00287</a>         <span class="keyword">struct </span><a class="code" href="../../de/d5d/struct_r_file.html">RFile</a>   <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a97cd726dd7aa22970264f034cd494c99">file</a>;
<a name="l00288"></a><a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">00288</a>         <span class="keyword">struct </span>RNode   <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>;
<a name="l00289"></a><a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#aedde21bcd815aa6f4019616c3da8c85c">00289</a>         <span class="keyword">struct </span><a class="code" href="../../dd/d2b/struct_r_match.html">RMatch</a>  <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#aedde21bcd815aa6f4019616c3da8c85c">match</a>;
<a name="l00290"></a><a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#adfe7a482dccb1343ff7d39a76a64a057">00290</a>         <span class="keyword">struct </span><a class="code" href="../../d0/d66/struct_r_rational.html">RRational</a> <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#adfe7a482dccb1343ff7d39a76a64a057">rational</a>;
<a name="l00291"></a><a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a916be87d92f0b3857f982dfd913a64cd">00291</a>         <span class="keyword">struct </span><a class="code" href="../../db/d80/struct_r_complex.html">RComplex</a> <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a916be87d92f0b3857f982dfd913a64cd">complex</a>;
<a name="l00292"></a>00292     } <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>;
<a name="l00293"></a>00293 <span class="preprocessor">#ifdef GC_DEBUG</span>
<a name="l00294"></a>00294 <span class="preprocessor"></span>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a97cd726dd7aa22970264f034cd494c99">file</a>;
<a name="l00295"></a>00295     <span class="keywordtype">int</span>   line;
<a name="l00296"></a>00296 <span class="preprocessor">#endif</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span>} <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a>;
<a name="l00298"></a>00298 
<a name="l00299"></a>00299 <span class="preprocessor">#if defined(_MSC_VER) || defined(__BORLANDC__) || defined(__CYGWIN__)</span>
<a name="l00300"></a>00300 <span class="preprocessor"></span><span class="preprocessor">#pragma pack(pop)</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00302"></a>00302 <span class="preprocessor"></span>
<a name="l00303"></a><a class="code" href="../../da/dda/structheaps__slot.html">00303</a> <span class="keyword">struct </span><a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a> {
<a name="l00304"></a><a class="code" href="../../da/dda/structheaps__slot.html#a4e10e0c9aba6f88eddf3d5f6d9c408fb">00304</a>     <span class="keywordtype">void</span> *<a class="code" href="../../da/dda/structheaps__slot.html#a4e10e0c9aba6f88eddf3d5f6d9c408fb">membase</a>;
<a name="l00305"></a><a class="code" href="../../da/dda/structheaps__slot.html#ae677a624c841d9129e8f31d350dc5f21">00305</a>     <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *<a class="code" href="../../da/dda/structheaps__slot.html#ae677a624c841d9129e8f31d350dc5f21">slot</a>;
<a name="l00306"></a><a class="code" href="../../da/dda/structheaps__slot.html#aab5626f69fb1dff0779d330d780bd928">00306</a>     <span class="keywordtype">size_t</span> <a class="code" href="../../da/dda/structheaps__slot.html#aab5626f69fb1dff0779d330d780bd928">limit</a>;
<a name="l00307"></a><a class="code" href="../../da/dda/structheaps__slot.html#a369e6ce2c28e10e149c964d374fc7c27">00307</a>     <span class="keyword">struct </span><a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a> *<a class="code" href="../../da/dda/structheaps__slot.html#a369e6ce2c28e10e149c964d374fc7c27">next</a>;
<a name="l00308"></a><a class="code" href="../../da/dda/structheaps__slot.html#a03c40ceeaaa233463ff3e654d837427a">00308</a>     <span class="keyword">struct </span><a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a> *<a class="code" href="../../da/dda/structheaps__slot.html#a03c40ceeaaa233463ff3e654d837427a">prev</a>;
<a name="l00309"></a>00309 };
<a name="l00310"></a>00310 
<a name="l00311"></a><a class="code" href="../../d8/d95/structsorted__heaps__slot.html">00311</a> <span class="keyword">struct </span><a class="code" href="../../d8/d95/structsorted__heaps__slot.html">sorted_heaps_slot</a> {
<a name="l00312"></a><a class="code" href="../../d8/d95/structsorted__heaps__slot.html#ad33de4cd59e7ea8cba62c94e024d6829">00312</a>     <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#ad33de4cd59e7ea8cba62c94e024d6829">start</a>;
<a name="l00313"></a><a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a4344f152198021b7a489fbcfbe187f44">00313</a>     <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a4344f152198021b7a489fbcfbe187f44">end</a>;
<a name="l00314"></a><a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a79843785a726ea01bb4683ad9ba055d3">00314</a>     <span class="keyword">struct </span><a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a> *<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a79843785a726ea01bb4683ad9ba055d3">slot</a>;
<a name="l00315"></a>00315 };
<a name="l00316"></a>00316 
<a name="l00317"></a><a class="code" href="../../db/deb/structgc__list.html">00317</a> <span class="keyword">struct </span><a class="code" href="../../db/deb/structgc__list.html">gc_list</a> {
<a name="l00318"></a><a class="code" href="../../db/deb/structgc__list.html#aa0960ced4053997d8848996b638564c1">00318</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../db/deb/structgc__list.html#aa0960ced4053997d8848996b638564c1">varptr</a>;
<a name="l00319"></a><a class="code" href="../../db/deb/structgc__list.html#a57d24fcd3af36e93f16a3bee72773025">00319</a>     <span class="keyword">struct </span><a class="code" href="../../db/deb/structgc__list.html">gc_list</a> *<a class="code" href="../../db/deb/structgc__list.html#a57d24fcd3af36e93f16a3bee72773025">next</a>;
<a name="l00320"></a>00320 };
<a name="l00321"></a>00321 
<a name="l00322"></a><a class="code" href="../../d8/d16/gc_8c.html#a1c2e72270eebbd03951f7c0b06d202b8">00322</a> <span class="preprocessor">#define CALC_EXACT_MALLOC_SIZE 0</span>
<a name="l00323"></a>00323 <span class="preprocessor"></span>
<a name="l00324"></a><a class="code" href="../../d7/dc0/structrb__objspace.html">00324</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace</a> {
<a name="l00325"></a>00325     <span class="keyword">struct </span>{
<a name="l00326"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#accdadf980f0d468cb903e234b844bbfa">00326</a>         <span class="keywordtype">size_t</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#accdadf980f0d468cb903e234b844bbfa">limit</a>;
<a name="l00327"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#adf63779d1920d497cca27df284ce9cbb">00327</a>         <span class="keywordtype">size_t</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#adf63779d1920d497cca27df284ce9cbb">increase</a>;
<a name="l00328"></a>00328 <span class="preprocessor">#if CALC_EXACT_MALLOC_SIZE</span>
<a name="l00329"></a>00329 <span class="preprocessor"></span>        <span class="keywordtype">size_t</span> allocated_size;
<a name="l00330"></a>00330         <span class="keywordtype">size_t</span> allocations;
<a name="l00331"></a>00331 <span class="preprocessor">#endif</span>
<a name="l00332"></a>00332 <span class="preprocessor"></span>    } <a class="code" href="../../d7/dc0/structrb__objspace.html#a00724648850701b4da94ec9edf7e07e2">malloc_params</a>;
<a name="l00333"></a>00333     <span class="keyword">struct </span>{
<a name="l00334"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a8fb2c405ac1e0f78f5b8c66f8500178a">00334</a>         <span class="keywordtype">size_t</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#a8fb2c405ac1e0f78f5b8c66f8500178a">increment</a>;
<a name="l00335"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a450c55a247ef7b5948507a181a5c43d1">00335</a>         <span class="keyword">struct </span><a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a> *<a class="code" href="../../d7/dc0/structrb__objspace.html#a450c55a247ef7b5948507a181a5c43d1">ptr</a>;
<a name="l00336"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">00336</a>         <span class="keyword">struct </span><a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a> *<a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">sweep_slots</a>;
<a name="l00337"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">00337</a>         <span class="keyword">struct </span><a class="code" href="../../d8/d95/structsorted__heaps__slot.html">sorted_heaps_slot</a> *<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>;
<a name="l00338"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a3705ff04c752801f7cf54eb4d21a764e">00338</a>         <span class="keywordtype">size_t</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#a3705ff04c752801f7cf54eb4d21a764e">length</a>;
<a name="l00339"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a6a88982f921ff8b85c5c913c7efe723d">00339</a>         <span class="keywordtype">size_t</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#a6a88982f921ff8b85c5c913c7efe723d">used</a>;
<a name="l00340"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a50ad967b19a19d9760d646af3756e786">00340</a>         <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *<a class="code" href="../../d7/dc0/structrb__objspace.html#a50ad967b19a19d9760d646af3756e786">freelist</a>;
<a name="l00341"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#ae304015a6040543321efd5d48418141b">00341</a>         <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *<a class="code" href="../../d7/dc0/structrb__objspace.html#ae304015a6040543321efd5d48418141b">range</a>[2];
<a name="l00342"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#af80b8179dfd879292f87ac741e5290ca">00342</a>         <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *<a class="code" href="../../d7/dc0/structrb__objspace.html#af80b8179dfd879292f87ac741e5290ca">freed</a>;
<a name="l00343"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a18e3fbf186b1889395e01baebaa4d8e5">00343</a>         <span class="keywordtype">size_t</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#a18e3fbf186b1889395e01baebaa4d8e5">live_num</a>;
<a name="l00344"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#adae35865d1de5847544a532a63c451fa">00344</a>         <span class="keywordtype">size_t</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#adae35865d1de5847544a532a63c451fa">free_num</a>;
<a name="l00345"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#af80cd8ad8d90eb656684764436c94eab">00345</a>         <span class="keywordtype">size_t</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#af80cd8ad8d90eb656684764436c94eab">free_min</a>;
<a name="l00346"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a3fcb169372e6a22e464737dd3346cbae">00346</a>         <span class="keywordtype">size_t</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#a3fcb169372e6a22e464737dd3346cbae">final_num</a>;
<a name="l00347"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a30e591c3106a56c6f76f67d1d4351207">00347</a>         <span class="keywordtype">size_t</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#a30e591c3106a56c6f76f67d1d4351207">do_heap_free</a>;
<a name="l00348"></a>00348     } <a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>;
<a name="l00349"></a>00349     <span class="keyword">struct </span>{
<a name="l00350"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a878b0bfb3d544e9cd83c1166beeb87cd">00350</a>         <span class="keywordtype">int</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#a878b0bfb3d544e9cd83c1166beeb87cd">dont_gc</a>;
<a name="l00351"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a4d7a47226a51a21ac62139d9729c2cbe">00351</a>         <span class="keywordtype">int</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#a4d7a47226a51a21ac62139d9729c2cbe">dont_lazy_sweep</a>;
<a name="l00352"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a12f81728490630243d9b40817b1715cf">00352</a>         <span class="keywordtype">int</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#a12f81728490630243d9b40817b1715cf">during_gc</a>;
<a name="l00353"></a>00353     } <a class="code" href="../../d7/dc0/structrb__objspace.html#aba26cb1da0cbb0aa583f9947a5337b8f">flags</a>;
<a name="l00354"></a>00354     <span class="keyword">struct </span>{
<a name="l00355"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#abdf50e9191b37ee95c72b0d0269775b1">00355</a>         <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *<a class="code" href="../../d7/dc0/structrb__objspace.html#abdf50e9191b37ee95c72b0d0269775b1">table</a>;
<a name="l00356"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#ab95c7dbd1684cf3d22edfafd5f93e613">00356</a>         <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *<a class="code" href="../../d7/dc0/structrb__objspace.html#ab95c7dbd1684cf3d22edfafd5f93e613">deferred</a>;
<a name="l00357"></a>00357     } <span class="keyword">final</span>;
<a name="l00358"></a>00358     <span class="keyword">struct </span>{
<a name="l00359"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a7147916d0e7f2916d71f7532e212429b">00359</a>         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d7/dc0/structrb__objspace.html#a7147916d0e7f2916d71f7532e212429b">buffer</a>[<a class="code" href="../../d8/d16/gc_8c.html#a1673f550d1f0e94fec118e6b0a1f2bd3">MARK_STACK_MAX</a>];
<a name="l00360"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a5f91e5d0325dcd16c4973553097a6a81">00360</a>         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../d7/dc0/structrb__objspace.html#a450c55a247ef7b5948507a181a5c43d1">ptr</a>;
<a name="l00361"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a3500e196d77340be33889d4427e298d3">00361</a>         <span class="keywordtype">int</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#a3500e196d77340be33889d4427e298d3">overflow</a>;
<a name="l00362"></a>00362     } <a class="code" href="../../d7/dc0/structrb__objspace.html#a01c265a116430be28ad444f5dfb705f6">markstack</a>;
<a name="l00363"></a>00363     <span class="keyword">struct </span>{
<a name="l00364"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#af4e55acafd08b89083723f6d4162c444">00364</a>         <span class="keywordtype">int</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#af4e55acafd08b89083723f6d4162c444">run</a>;
<a name="l00365"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">00365</a>         <a class="code" href="../../d6/dc6/structgc__profile__record.html">gc_profile_record</a> *<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>;
<a name="l00366"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#ab44b67a8f5128f8aac3c3c340d91d8dd">00366</a>         <span class="keywordtype">size_t</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#ab44b67a8f5128f8aac3c3c340d91d8dd">count</a>;
<a name="l00367"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#acab1c19aadf393836c2f72a5dbc334a6">00367</a>         <span class="keywordtype">size_t</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#acab1c19aadf393836c2f72a5dbc334a6">size</a>;
<a name="l00368"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a27009672b0838377246bef2ba66bac27">00368</a>         <span class="keywordtype">double</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#a27009672b0838377246bef2ba66bac27">invoke_time</a>;
<a name="l00369"></a>00369     } <a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>;
<a name="l00370"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#a3361101249b8658bf3a2cc2d7e93c0c2">00370</a>     <span class="keyword">struct </span><a class="code" href="../../db/deb/structgc__list.html">gc_list</a> *<a class="code" href="../../d7/dc0/structrb__objspace.html#a3361101249b8658bf3a2cc2d7e93c0c2">global_list</a>;
<a name="l00371"></a>00371     <span class="keywordtype">size_t</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#ab44b67a8f5128f8aac3c3c340d91d8dd">count</a>;
<a name="l00372"></a><a class="code" href="../../d7/dc0/structrb__objspace.html#ade1918995280f8bde809ed88eb02c93d">00372</a>     <span class="keywordtype">int</span> <a class="code" href="../../d7/dc0/structrb__objspace.html#ade1918995280f8bde809ed88eb02c93d">gc_stress</a>;
<a name="l00373"></a>00373 } <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a>;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375 <span class="preprocessor">#if defined(ENABLE_VM_OBJSPACE) &amp;&amp; ENABLE_VM_OBJSPACE</span>
<a name="l00376"></a>00376 <span class="preprocessor"></span><span class="preprocessor">#define rb_objspace (*GET_VM()-&gt;objspace)</span>
<a name="l00377"></a>00377 <span class="preprocessor"></span><span class="preprocessor">#define ruby_initial_gc_stress  initial_params.gc_stress</span>
<a name="l00378"></a>00378 <span class="preprocessor"></span><span class="keywordtype">int</span> *<a class="code" href="../../d8/d16/gc_8c.html#ad6095c6ef13d2040ced01fd51c3ef3ad">ruby_initial_gc_stress_ptr</a> = &amp;ruby_initial_gc_stress;
<a name="l00379"></a>00379 <span class="preprocessor">#else</span>
<a name="l00380"></a><a class="code" href="../../d8/d16/gc_8c.html#a9f2482b21e16db7a61e5e7ec90fc16b8">00380</a> <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace</a> = {{<a class="code" href="../../d8/d16/gc_8c.html#a833cc6d14225609eb79c833b89be7457">GC_MALLOC_LIMIT</a>}, {<a class="code" href="../../d8/d16/gc_8c.html#a323a78736c2adfb81b32f30dfcbed8a7">HEAP_MIN_SLOTS</a>}};
<a name="l00381"></a><a class="code" href="../../d8/d16/gc_8c.html#ad6095c6ef13d2040ced01fd51c3ef3ad">00381</a> <span class="keywordtype">int</span> *<a class="code" href="../../d8/d16/gc_8c.html#ad6095c6ef13d2040ced01fd51c3ef3ad">ruby_initial_gc_stress_ptr</a> = &amp;rb_objspace.<a class="code" href="../../d7/dc0/structrb__objspace.html#ade1918995280f8bde809ed88eb02c93d">gc_stress</a>;
<a name="l00382"></a>00382 <span class="preprocessor">#endif</span>
<a name="l00383"></a><a class="code" href="../../d8/d16/gc_8c.html#a8bcd401e2531e938e512cfb2e30dd4e6">00383</a> <span class="preprocessor"></span><span class="preprocessor">#define malloc_limit            objspace-&gt;malloc_params.limit</span>
<a name="l00384"></a><a class="code" href="../../d8/d16/gc_8c.html#aef6ccce3587ce02d07ba0c720776f889">00384</a> <span class="preprocessor"></span><span class="preprocessor">#define malloc_increase         objspace-&gt;malloc_params.increase</span>
<a name="l00385"></a><a class="code" href="../../d8/d16/gc_8c.html#a3eb89961b2be51932ecadee6b63963ba">00385</a> <span class="preprocessor"></span><span class="preprocessor">#define heaps                   objspace-&gt;heap.ptr</span>
<a name="l00386"></a><a class="code" href="../../d8/d16/gc_8c.html#aed54069fadeba11ffce2b8cdf5412255">00386</a> <span class="preprocessor"></span><span class="preprocessor">#define heaps_length            objspace-&gt;heap.length</span>
<a name="l00387"></a><a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">00387</a> <span class="preprocessor"></span><span class="preprocessor">#define heaps_used              objspace-&gt;heap.used</span>
<a name="l00388"></a><a class="code" href="../../d8/d16/gc_8c.html#a896e77038c659ca416b686f1e7a93eb8">00388</a> <span class="preprocessor"></span><span class="preprocessor">#define freelist                objspace-&gt;heap.freelist</span>
<a name="l00389"></a><a class="code" href="../../d8/d16/gc_8c.html#a44030085eee46549ee44e25595782109">00389</a> <span class="preprocessor"></span><span class="preprocessor">#define lomem                   objspace-&gt;heap.range[0]</span>
<a name="l00390"></a><a class="code" href="../../d8/d16/gc_8c.html#a5072e77cd94db97413518f9513840112">00390</a> <span class="preprocessor"></span><span class="preprocessor">#define himem                   objspace-&gt;heap.range[1]</span>
<a name="l00391"></a><a class="code" href="../../d8/d16/gc_8c.html#a2081c1ed3cfcae50159143e599b5fd34">00391</a> <span class="preprocessor"></span><span class="preprocessor">#define heaps_inc               objspace-&gt;heap.increment</span>
<a name="l00392"></a><a class="code" href="../../d8/d16/gc_8c.html#a332222afe533612ed81b65681a48e1f3">00392</a> <span class="preprocessor"></span><span class="preprocessor">#define heaps_freed             objspace-&gt;heap.freed</span>
<a name="l00393"></a><a class="code" href="../../d8/d16/gc_8c.html#af3db9015bc1d568dfbb6f98ff169ef97">00393</a> <span class="preprocessor"></span><span class="preprocessor">#define dont_gc                 objspace-&gt;flags.dont_gc</span>
<a name="l00394"></a><a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">00394</a> <span class="preprocessor"></span><span class="preprocessor">#define during_gc               objspace-&gt;flags.during_gc</span>
<a name="l00395"></a><a class="code" href="../../d8/d16/gc_8c.html#ad42bffe188d60ed392ba783bf4c5e91b">00395</a> <span class="preprocessor"></span><span class="preprocessor">#define finalizer_table         objspace-&gt;final.table</span>
<a name="l00396"></a><a class="code" href="../../d8/d16/gc_8c.html#a39bb37371a2ddda30cc826e790ceda3c">00396</a> <span class="preprocessor"></span><span class="preprocessor">#define deferred_final_list     objspace-&gt;final.deferred</span>
<a name="l00397"></a><a class="code" href="../../d8/d16/gc_8c.html#a2b33539aa8ca6caef37f852a8df9993a">00397</a> <span class="preprocessor"></span><span class="preprocessor">#define mark_stack              objspace-&gt;markstack.buffer</span>
<a name="l00398"></a><a class="code" href="../../d8/d16/gc_8c.html#a18c8c3930b6076e2dbd77931a8ffb2fa">00398</a> <span class="preprocessor"></span><span class="preprocessor">#define mark_stack_ptr          objspace-&gt;markstack.ptr</span>
<a name="l00399"></a><a class="code" href="../../d8/d16/gc_8c.html#aef4fe92f4edf54293f8676f2c34c0139">00399</a> <span class="preprocessor"></span><span class="preprocessor">#define mark_stack_overflow     objspace-&gt;markstack.overflow</span>
<a name="l00400"></a><a class="code" href="../../d8/d16/gc_8c.html#a24293dffd2d9e073607ec2e58ad90f15">00400</a> <span class="preprocessor"></span><span class="preprocessor">#define global_List             objspace-&gt;global_list</span>
<a name="l00401"></a><a class="code" href="../../d8/d16/gc_8c.html#aba00d537a97326bf91eeb0e17fc2204e">00401</a> <span class="preprocessor"></span><span class="preprocessor">#define ruby_gc_stress          objspace-&gt;gc_stress</span>
<a name="l00402"></a><a class="code" href="../../d8/d16/gc_8c.html#a2f761e8733e04a9982316226de3bae1d">00402</a> <span class="preprocessor"></span><span class="preprocessor">#define initial_malloc_limit    initial_params.initial_malloc_limit</span>
<a name="l00403"></a><a class="code" href="../../d8/d16/gc_8c.html#af98c6835eb4ba334b98c1de2eb0852f1">00403</a> <span class="preprocessor"></span><span class="preprocessor">#define initial_heap_min_slots  initial_params.initial_heap_min_slots</span>
<a name="l00404"></a><a class="code" href="../../d8/d16/gc_8c.html#a92ac65c13d9b117db8b96ae052c6ba09">00404</a> <span class="preprocessor"></span><span class="preprocessor">#define initial_free_min        initial_params.initial_free_min</span>
<a name="l00405"></a>00405 <span class="preprocessor"></span>
<a name="l00406"></a>00406 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d16/gc_8c.html#a18340727917773260d690cc32eeb7681">rb_objspace_call_finalizer</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace);
<a name="l00407"></a>00407 
<a name="l00408"></a>00408 <span class="preprocessor">#if defined(ENABLE_VM_OBJSPACE) &amp;&amp; ENABLE_VM_OBJSPACE</span>
<a name="l00409"></a>00409 <span class="preprocessor"></span><a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *
<a name="l00410"></a>00410 rb_objspace_alloc(<span class="keywordtype">void</span>)
<a name="l00411"></a>00411 {
<a name="l00412"></a>00412     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = <a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a>));
<a name="l00413"></a>00413     memset(objspace, 0, <span class="keyword">sizeof</span>(*objspace));
<a name="l00414"></a>00414     <a class="code" href="../../d8/d16/gc_8c.html#a8bcd401e2531e938e512cfb2e30dd4e6">malloc_limit</a> = <a class="code" href="../../d8/d16/gc_8c.html#a2f761e8733e04a9982316226de3bae1d">initial_malloc_limit</a>;
<a name="l00415"></a>00415     <a class="code" href="../../d8/d16/gc_8c.html#aba00d537a97326bf91eeb0e17fc2204e">ruby_gc_stress</a> = ruby_initial_gc_stress;
<a name="l00416"></a>00416 
<a name="l00417"></a>00417     <span class="keywordflow">return</span> objspace;
<a name="l00418"></a>00418 }
<a name="l00419"></a>00419 <span class="preprocessor">#endif</span>
<a name="l00420"></a>00420 <span class="preprocessor"></span>
<a name="l00421"></a>00421 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d16/gc_8c.html#ad90afff6d51115e96f5fa3bfaf42a988">initial_expand_heap</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace);
<a name="l00422"></a>00422 
<a name="l00423"></a>00423 <span class="keywordtype">void</span>
<a name="l00424"></a><a class="code" href="../../db/d2e/intern_8h.html#a13a294ac30c3b27f5b8f81ec1a6ee2ad">00424</a> <a class="code" href="../../d8/d16/gc_8c.html#a13a294ac30c3b27f5b8f81ec1a6ee2ad">rb_gc_set_params</a>(<span class="keywordtype">void</span>)
<a name="l00425"></a>00425 {
<a name="l00426"></a>00426     <span class="keywordtype">char</span> *malloc_limit_ptr, *heap_min_slots_ptr, *free_min_ptr;
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9d/tcltklib_8c.html#a6f520624fabb8332dc98fd223491bf8d">rb_safe_level</a>() &gt; 0) <span class="keywordflow">return</span>;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430     malloc_limit_ptr = <a class="code" href="../../de/d32/dir_8c.html#aee28fd8a0e40b6d958f7d20348e45368">getenv</a>(<span class="stringliteral">&quot;RUBY_GC_MALLOC_LIMIT&quot;</span>);
<a name="l00431"></a>00431     <span class="keywordflow">if</span> (malloc_limit_ptr != <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00432"></a>00432         <span class="keywordtype">int</span> malloc_limit_i = atoi(malloc_limit_ptr);
<a name="l00433"></a>00433         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a56087d5316e4c73027105c023006cb15">ruby_verbose</a>))
<a name="l00434"></a>00434             fprintf(stderr, <span class="stringliteral">&quot;malloc_limit=%d (%d)\n&quot;</span>,
<a name="l00435"></a>00435                     malloc_limit_i, <a class="code" href="../../d8/d16/gc_8c.html#a2f761e8733e04a9982316226de3bae1d">initial_malloc_limit</a>);
<a name="l00436"></a>00436         <span class="keywordflow">if</span> (malloc_limit_i &gt; 0) {
<a name="l00437"></a>00437             <a class="code" href="../../d8/d16/gc_8c.html#a2f761e8733e04a9982316226de3bae1d">initial_malloc_limit</a> = malloc_limit_i;
<a name="l00438"></a>00438         }
<a name="l00439"></a>00439     }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441     heap_min_slots_ptr = <a class="code" href="../../de/d32/dir_8c.html#aee28fd8a0e40b6d958f7d20348e45368">getenv</a>(<span class="stringliteral">&quot;RUBY_HEAP_MIN_SLOTS&quot;</span>);
<a name="l00442"></a>00442     <span class="keywordflow">if</span> (heap_min_slots_ptr != <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00443"></a>00443         <span class="keywordtype">int</span> heap_min_slots_i = atoi(heap_min_slots_ptr);
<a name="l00444"></a>00444         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a56087d5316e4c73027105c023006cb15">ruby_verbose</a>))
<a name="l00445"></a>00445             fprintf(stderr, <span class="stringliteral">&quot;heap_min_slots=%d (%d)\n&quot;</span>,
<a name="l00446"></a>00446                     heap_min_slots_i, <a class="code" href="../../d8/d16/gc_8c.html#af98c6835eb4ba334b98c1de2eb0852f1">initial_heap_min_slots</a>);
<a name="l00447"></a>00447         <span class="keywordflow">if</span> (heap_min_slots_i &gt; 0) {
<a name="l00448"></a>00448             <a class="code" href="../../d8/d16/gc_8c.html#af98c6835eb4ba334b98c1de2eb0852f1">initial_heap_min_slots</a> = heap_min_slots_i;
<a name="l00449"></a>00449             <a class="code" href="../../d8/d16/gc_8c.html#ad90afff6d51115e96f5fa3bfaf42a988">initial_expand_heap</a>(&amp;rb_objspace);
<a name="l00450"></a>00450         }
<a name="l00451"></a>00451     }
<a name="l00452"></a>00452 
<a name="l00453"></a>00453     free_min_ptr = <a class="code" href="../../de/d32/dir_8c.html#aee28fd8a0e40b6d958f7d20348e45368">getenv</a>(<span class="stringliteral">&quot;RUBY_FREE_MIN&quot;</span>);
<a name="l00454"></a>00454     <span class="keywordflow">if</span> (free_min_ptr != <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00455"></a>00455         <span class="keywordtype">int</span> free_min_i = atoi(free_min_ptr);
<a name="l00456"></a>00456         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a56087d5316e4c73027105c023006cb15">ruby_verbose</a>))
<a name="l00457"></a>00457             fprintf(stderr, <span class="stringliteral">&quot;free_min=%d (%d)\n&quot;</span>, free_min_i, <a class="code" href="../../d8/d16/gc_8c.html#a92ac65c13d9b117db8b96ae052c6ba09">initial_free_min</a>);
<a name="l00458"></a>00458         <span class="keywordflow">if</span> (free_min_i &gt; 0) {
<a name="l00459"></a>00459             <a class="code" href="../../d8/d16/gc_8c.html#a92ac65c13d9b117db8b96ae052c6ba09">initial_free_min</a> = free_min_i;
<a name="l00460"></a>00460         }
<a name="l00461"></a>00461     }
<a name="l00462"></a>00462 }
<a name="l00463"></a>00463 
<a name="l00464"></a>00464 <span class="preprocessor">#if defined(ENABLE_VM_OBJSPACE) &amp;&amp; ENABLE_VM_OBJSPACE</span>
<a name="l00465"></a>00465 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d16/gc_8c.html#a76b02cd914ceb682ce9c9e3ab7235283">gc_sweep</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *);
<a name="l00466"></a>00466 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d16/gc_8c.html#af13cde662aad9d628f5152fb09bddd3a">slot_sweep</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *, <span class="keyword">struct</span> <a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a> *);
<a name="l00467"></a>00467 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d16/gc_8c.html#ab33ac0d8116118bd4eb59677ec4c3fe2">rest_sweep</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *);
<a name="l00468"></a>00468 
<a name="l00469"></a>00469 <span class="keywordtype">void</span>
<a name="l00470"></a>00470 <a class="code" href="../../d8/d32/vm__core_8h.html#aea0806876fcecf60de5af807dd054ab0">rb_objspace_free</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l00471"></a>00471 {
<a name="l00472"></a>00472     <a class="code" href="../../d8/d16/gc_8c.html#ab33ac0d8116118bd4eb59677ec4c3fe2">rest_sweep</a>(objspace);
<a name="l00473"></a>00473     <span class="keywordflow">if</span> (objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>) {
<a name="l00474"></a>00474         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>);
<a name="l00475"></a>00475         objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a> = 0;
<a name="l00476"></a>00476     }
<a name="l00477"></a>00477     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a24293dffd2d9e073607ec2e58ad90f15">global_List</a>) {
<a name="l00478"></a>00478         <span class="keyword">struct </span><a class="code" href="../../db/deb/structgc__list.html">gc_list</a> *<a class="code" href="../../d5/db5/encoding_8c.html#a05f70dacbe595d27364e1e014efb0c8e">list</a>, *<a class="code" href="../../db/deb/structgc__list.html#a57d24fcd3af36e93f16a3bee72773025">next</a>;
<a name="l00479"></a>00479         <span class="keywordflow">for</span> (list = <a class="code" href="../../d8/d16/gc_8c.html#a24293dffd2d9e073607ec2e58ad90f15">global_List</a>; list; list = next) {
<a name="l00480"></a>00480             next = list-&gt;<a class="code" href="../../db/deb/structgc__list.html#a57d24fcd3af36e93f16a3bee72773025">next</a>;
<a name="l00481"></a>00481             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(list);
<a name="l00482"></a>00482         }
<a name="l00483"></a>00483     }
<a name="l00484"></a>00484     <span class="keywordflow">if</span> (objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>) {
<a name="l00485"></a>00485         <span class="keywordtype">size_t</span> i;
<a name="l00486"></a>00486         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a>; ++i) {
<a name="l00487"></a>00487             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a79843785a726ea01bb4683ad9ba055d3">slot</a>-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a4e10e0c9aba6f88eddf3d5f6d9c408fb">membase</a>);
<a name="l00488"></a>00488             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a79843785a726ea01bb4683ad9ba055d3">slot</a>);
<a name="l00489"></a>00489         }
<a name="l00490"></a>00490         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>);
<a name="l00491"></a>00491         heaps_used = 0;
<a name="l00492"></a>00492         <a class="code" href="../../d8/d16/gc_8c.html#a3eb89961b2be51932ecadee6b63963ba">heaps</a> = 0;
<a name="l00493"></a>00493     }
<a name="l00494"></a>00494     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(objspace);
<a name="l00495"></a>00495 }
<a name="l00496"></a>00496 <span class="preprocessor">#endif</span>
<a name="l00497"></a>00497 <span class="preprocessor"></span>
<a name="l00498"></a>00498 <span class="comment">/* tiny heap size */</span>
<a name="l00499"></a>00499 <span class="comment">/* 32KB */</span>
<a name="l00500"></a>00500 <span class="comment">/*#define HEAP_SIZE 0x8000 */</span>
<a name="l00501"></a>00501 <span class="comment">/* 128KB */</span>
<a name="l00502"></a>00502 <span class="comment">/*#define HEAP_SIZE 0x20000 */</span>
<a name="l00503"></a>00503 <span class="comment">/* 64KB */</span>
<a name="l00504"></a>00504 <span class="comment">/*#define HEAP_SIZE 0x10000 */</span>
<a name="l00505"></a>00505 <span class="comment">/* 16KB */</span>
<a name="l00506"></a><a class="code" href="../../d8/d16/gc_8c.html#a1b45302695680930829cac31d65e41e1">00506</a> <span class="preprocessor">#define HEAP_SIZE 0x4000</span>
<a name="l00507"></a>00507 <span class="preprocessor"></span><span class="comment">/* 8KB */</span>
<a name="l00508"></a>00508 <span class="comment">/*#define HEAP_SIZE 0x2000 */</span>
<a name="l00509"></a>00509 <span class="comment">/* 4KB */</span>
<a name="l00510"></a>00510 <span class="comment">/*#define HEAP_SIZE 0x1000 */</span>
<a name="l00511"></a>00511 <span class="comment">/* 2KB */</span>
<a name="l00512"></a>00512 <span class="comment">/*#define HEAP_SIZE 0x800 */</span>
<a name="l00513"></a>00513 
<a name="l00514"></a><a class="code" href="../../d8/d16/gc_8c.html#a82e0c515bb2727a22897b61364edf3dc">00514</a> <span class="preprocessor">#define HEAP_OBJ_LIMIT (unsigned int)(HEAP_SIZE / sizeof(struct RVALUE))</span>
<a name="l00515"></a>00515 <span class="preprocessor"></span>
<a name="l00516"></a>00516 <span class="keyword">extern</span> <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *<a class="code" href="../../de/ddf/group__class.html#gaff0db6a05b2bd3b173b91c804ed0b552">rb_class_tbl</a>;
<a name="l00517"></a>00517 
<a name="l00518"></a><a class="code" href="../../d8/d16/gc_8c.html#a5b31630e75c310b1f3d5168f1f4bf82f">00518</a> <span class="keywordtype">int</span> <a class="code" href="../../d8/d16/gc_8c.html#a5b31630e75c310b1f3d5168f1f4bf82f">ruby_disable_gc_stress</a> = 0;
<a name="l00519"></a>00519 
<a name="l00520"></a>00520 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d16/gc_8c.html#af529267e0eab924c8d9427304a310794">run_final</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj);
<a name="l00521"></a>00521 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d16/gc_8c.html#ae40ead8ed1ce1ae638710978a3fc8ff3">garbage_collect</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace);
<a name="l00522"></a>00522 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d16/gc_8c.html#a8a4293c49811c85d724070323c80c7b7">gc_lazy_sweep</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace);
<a name="l00523"></a>00523 
<a name="l00524"></a>00524 <span class="keywordtype">void</span>
<a name="l00525"></a><a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7a3ec1f2873f0cc02ab13c1a31996c7b">00525</a> <a class="code" href="../../d8/d16/gc_8c.html#a5196f826932fd0ac9b923d35816e8e1d">rb_global_variable</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *var)
<a name="l00526"></a>00526 {
<a name="l00527"></a>00527     <a class="code" href="../../d8/d16/gc_8c.html#ad0a40ec1bb0a454b10bfd9727e741511">rb_gc_register_address</a>(var);
<a name="l00528"></a>00528 }
<a name="l00529"></a>00529 
<a name="l00530"></a>00530 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l00531"></a><a class="code" href="../../d8/d16/gc_8c.html#a2f32ab80ee1a83564fe6f8a93f5a2ba5">00531</a> <a class="code" href="../../d8/d16/gc_8c.html#a2f32ab80ee1a83564fe6f8a93f5a2ba5">ruby_memerror_body</a>(<span class="keywordtype">void</span> *dummy)
<a name="l00532"></a>00532 {
<a name="l00533"></a>00533     <a class="code" href="../../d8/d16/gc_8c.html#a14b9fe6e6bba3f2279b95af407c546f8">rb_memerror</a>();
<a name="l00534"></a>00534     <span class="keywordflow">return</span> 0;
<a name="l00535"></a>00535 }
<a name="l00536"></a>00536 
<a name="l00537"></a>00537 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00538"></a><a class="code" href="../../d8/d16/gc_8c.html#a40dbcc73646b676fa655a31e9de5f0b0">00538</a> <a class="code" href="../../d8/d16/gc_8c.html#a40dbcc73646b676fa655a31e9de5f0b0">ruby_memerror</a>(<span class="keywordtype">void</span>)
<a name="l00539"></a>00539 {
<a name="l00540"></a>00540     <span class="keywordflow">if</span> (<a class="code" href="../../d3/de7/thread_8c.html#a2293d6040c352991d160113a62fe5be3">ruby_thread_has_gvl_p</a>()) {
<a name="l00541"></a>00541         <a class="code" href="../../d8/d16/gc_8c.html#a14b9fe6e6bba3f2279b95af407c546f8">rb_memerror</a>();
<a name="l00542"></a>00542     }
<a name="l00543"></a>00543     <span class="keywordflow">else</span> {
<a name="l00544"></a>00544         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9d/tcltklib_8c.html#a9e7d742a9c52a78b9b3dc81df878e2ed">ruby_native_thread_p</a>()) {
<a name="l00545"></a>00545             <a class="code" href="../../d3/de7/thread_8c.html#a750cc265be9b084ee41c51157948f756">rb_thread_call_with_gvl</a>(<a class="code" href="../../d8/d16/gc_8c.html#a2f32ab80ee1a83564fe6f8a93f5a2ba5">ruby_memerror_body</a>, 0);
<a name="l00546"></a>00546         }
<a name="l00547"></a>00547         <span class="keywordflow">else</span> {
<a name="l00548"></a>00548             <span class="comment">/* no ruby thread */</span>
<a name="l00549"></a>00549             fprintf(stderr, <span class="stringliteral">&quot;[FATAL] failed to allocate memory\n&quot;</span>);
<a name="l00550"></a>00550             exit(<a class="code" href="../../dd/dd0/eval__intern_8h.html#a73efe787c131b385070f25d18b7c9aa4">EXIT_FAILURE</a>);
<a name="l00551"></a>00551         }
<a name="l00552"></a>00552     }
<a name="l00553"></a>00553 }
<a name="l00554"></a>00554 
<a name="l00555"></a>00555 <span class="keywordtype">void</span>
<a name="l00556"></a><a class="code" href="../../d8/d16/gc_8c.html#a14b9fe6e6bba3f2279b95af407c546f8">00556</a> <a class="code" href="../../d8/d16/gc_8c.html#a14b9fe6e6bba3f2279b95af407c546f8">rb_memerror</a>(<span class="keywordtype">void</span>)
<a name="l00557"></a>00557 {
<a name="l00558"></a>00558     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l00559"></a>00559     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d16/gc_8c.html#a5a548be06ee9f1eb5fd707c9d20da90c">nomem_error</a> ||
<a name="l00560"></a>00560         (<a class="code" href="../../dd/dd0/eval__intern_8h.html#a40f71161eb564f27c55a07db70d16643">rb_thread_raised_p</a>(th, <a class="code" href="../../dd/dd0/eval__intern_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2dae8335a54ac796cfcfc20de0af92925c1">RAISED_NOMEMORY</a>) &amp;&amp; <a class="code" href="../../d5/d9d/tcltklib_8c.html#a6f520624fabb8332dc98fd223491bf8d">rb_safe_level</a>() &lt; 4)) {
<a name="l00561"></a>00561         fprintf(stderr, <span class="stringliteral">&quot;[FATAL] failed to allocate memory\n&quot;</span>);
<a name="l00562"></a>00562         exit(<a class="code" href="../../dd/dd0/eval__intern_8h.html#a73efe787c131b385070f25d18b7c9aa4">EXIT_FAILURE</a>);
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564     <span class="keywordflow">if</span> (<a class="code" href="../../dd/dd0/eval__intern_8h.html#a40f71161eb564f27c55a07db70d16643">rb_thread_raised_p</a>(th, <a class="code" href="../../dd/dd0/eval__intern_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2dae8335a54ac796cfcfc20de0af92925c1">RAISED_NOMEMORY</a>)) {
<a name="l00565"></a>00565         <a class="code" href="../../dd/dd0/eval__intern_8h.html#a4a34b7bc20283967d79d84b2f236dda4">rb_thread_raised_clear</a>(th);
<a name="l00566"></a>00566         <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>()-&gt;errinfo = <a class="code" href="../../d8/d16/gc_8c.html#a5a548be06ee9f1eb5fd707c9d20da90c">nomem_error</a>;
<a name="l00567"></a>00567         <a class="code" href="../../dd/dd0/eval__intern_8h.html#a24884166ae699029ade34fd36bedd688">JUMP_TAG</a>(<a class="code" href="../../dd/dd0/eval__intern_8h.html#a0b034bce069147e233776bc1dcc74c01">TAG_RAISE</a>);
<a name="l00568"></a>00568     }
<a name="l00569"></a>00569     <a class="code" href="../../dd/dd0/eval__intern_8h.html#a19275cde4c1d1413887ef2e1c948aa88">rb_thread_raised_set</a>(th, <a class="code" href="../../dd/dd0/eval__intern_8h.html#a0411cd49bb5b71852cecd93bcbf0ca2dae8335a54ac796cfcfc20de0af92925c1">RAISED_NOMEMORY</a>);
<a name="l00570"></a>00570     <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(<a class="code" href="../../d8/d16/gc_8c.html#a5a548be06ee9f1eb5fd707c9d20da90c">nomem_error</a>);
<a name="l00571"></a>00571 }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573 <span class="comment">/*</span>
<a name="l00574"></a>00574 <span class="comment"> *  call-seq:</span>
<a name="l00575"></a>00575 <span class="comment"> *    GC.stress                 -&gt; true or false</span>
<a name="l00576"></a>00576 <span class="comment"> *</span>
<a name="l00577"></a>00577 <span class="comment"> *  returns current status of GC stress mode.</span>
<a name="l00578"></a>00578 <span class="comment"> */</span>
<a name="l00579"></a>00579 
<a name="l00580"></a>00580 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00581"></a><a class="code" href="../../d8/d16/gc_8c.html#abe778bb43360fd945e9f2dea667f237b">00581</a> <a class="code" href="../../d8/d16/gc_8c.html#abe778bb43360fd945e9f2dea667f237b">gc_stress_get</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l00582"></a>00582 {
<a name="l00583"></a>00583     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l00584"></a>00584     <span class="keywordflow">return</span> <a class="code" href="../../d8/d16/gc_8c.html#aba00d537a97326bf91eeb0e17fc2204e">ruby_gc_stress</a> ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l00585"></a>00585 }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587 <span class="comment">/*</span>
<a name="l00588"></a>00588 <span class="comment"> *  call-seq:</span>
<a name="l00589"></a>00589 <span class="comment"> *    GC.stress = bool          -&gt; bool</span>
<a name="l00590"></a>00590 <span class="comment"> *</span>
<a name="l00591"></a>00591 <span class="comment"> *  Updates the GC stress mode.</span>
<a name="l00592"></a>00592 <span class="comment"> *</span>
<a name="l00593"></a>00593 <span class="comment"> *  When stress mode is enabled the GC is invoked at every GC opportunity:</span>
<a name="l00594"></a>00594 <span class="comment"> *  all memory and object allocations.</span>
<a name="l00595"></a>00595 <span class="comment"> *</span>
<a name="l00596"></a>00596 <span class="comment"> *  Enabling stress mode makes Ruby very slow, it is only for debugging.</span>
<a name="l00597"></a>00597 <span class="comment"> */</span>
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00600"></a><a class="code" href="../../d8/d16/gc_8c.html#a927a74eab36807709e91a163728fa6b1">00600</a> <a class="code" href="../../d8/d16/gc_8c.html#a927a74eab36807709e91a163728fa6b1">gc_stress_set</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> flag)
<a name="l00601"></a>00601 {
<a name="l00602"></a>00602     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l00603"></a>00603     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a98b91af598acb64fe8497413ce498766">rb_secure</a>(2);
<a name="l00604"></a>00604     <a class="code" href="../../d8/d16/gc_8c.html#aba00d537a97326bf91eeb0e17fc2204e">ruby_gc_stress</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(flag);
<a name="l00605"></a>00605     <span class="keywordflow">return</span> flag;
<a name="l00606"></a>00606 }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608 <span class="comment">/*</span>
<a name="l00609"></a>00609 <span class="comment"> *  call-seq:</span>
<a name="l00610"></a>00610 <span class="comment"> *    GC::Profiler.enable?                 -&gt; true or false</span>
<a name="l00611"></a>00611 <span class="comment"> *</span>
<a name="l00612"></a>00612 <span class="comment"> *  The current status of GC profile mode.</span>
<a name="l00613"></a>00613 <span class="comment"> */</span>
<a name="l00614"></a>00614 
<a name="l00615"></a>00615 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00616"></a><a class="code" href="../../d8/d16/gc_8c.html#a666215deb83c1b9b81db945fd4cc4a00">00616</a> <a class="code" href="../../d8/d16/gc_8c.html#a666215deb83c1b9b81db945fd4cc4a00">gc_profile_enable_get</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l00617"></a>00617 {
<a name="l00618"></a>00618     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l00619"></a>00619     <span class="keywordflow">return</span> objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af4e55acafd08b89083723f6d4162c444">run</a>;
<a name="l00620"></a>00620 }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622 <span class="comment">/*</span>
<a name="l00623"></a>00623 <span class="comment"> *  call-seq:</span>
<a name="l00624"></a>00624 <span class="comment"> *    GC::Profiler.enable          -&gt; nil</span>
<a name="l00625"></a>00625 <span class="comment"> *</span>
<a name="l00626"></a>00626 <span class="comment"> *  Starts the GC profiler.</span>
<a name="l00627"></a>00627 <span class="comment"> *</span>
<a name="l00628"></a>00628 <span class="comment"> */</span>
<a name="l00629"></a>00629 
<a name="l00630"></a>00630 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00631"></a><a class="code" href="../../d8/d16/gc_8c.html#a38d2d9350a6a56f10d54b6dd184b9529">00631</a> <a class="code" href="../../d8/d16/gc_8c.html#a38d2d9350a6a56f10d54b6dd184b9529">gc_profile_enable</a>(<span class="keywordtype">void</span>)
<a name="l00632"></a>00632 {
<a name="l00633"></a>00633     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af4e55acafd08b89083723f6d4162c444">run</a> = <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00636"></a>00636     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00637"></a>00637 }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639 <span class="comment">/*</span>
<a name="l00640"></a>00640 <span class="comment"> *  call-seq:</span>
<a name="l00641"></a>00641 <span class="comment"> *    GC::Profiler.disable          -&gt; nil</span>
<a name="l00642"></a>00642 <span class="comment"> *</span>
<a name="l00643"></a>00643 <span class="comment"> *  Stops the GC profiler.</span>
<a name="l00644"></a>00644 <span class="comment"> *</span>
<a name="l00645"></a>00645 <span class="comment"> */</span>
<a name="l00646"></a>00646 
<a name="l00647"></a>00647 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00648"></a><a class="code" href="../../d8/d16/gc_8c.html#a93630fa8367d4c036ca6be546ef63b17">00648</a> <a class="code" href="../../d8/d16/gc_8c.html#a93630fa8367d4c036ca6be546ef63b17">gc_profile_disable</a>(<span class="keywordtype">void</span>)
<a name="l00649"></a>00649 {
<a name="l00650"></a>00650     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l00651"></a>00651 
<a name="l00652"></a>00652     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af4e55acafd08b89083723f6d4162c444">run</a> = <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00653"></a>00653     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00654"></a>00654 }
<a name="l00655"></a>00655 
<a name="l00656"></a>00656 <span class="comment">/*</span>
<a name="l00657"></a>00657 <span class="comment"> *  call-seq:</span>
<a name="l00658"></a>00658 <span class="comment"> *    GC::Profiler.clear          -&gt; nil</span>
<a name="l00659"></a>00659 <span class="comment"> *</span>
<a name="l00660"></a>00660 <span class="comment"> *  Clears the GC profiler data.</span>
<a name="l00661"></a>00661 <span class="comment"> *</span>
<a name="l00662"></a>00662 <span class="comment"> */</span>
<a name="l00663"></a>00663 
<a name="l00664"></a>00664 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00665"></a><a class="code" href="../../d8/d16/gc_8c.html#a1224eeec4cd2de1c7104f78a579e63e8">00665</a> <a class="code" href="../../d8/d16/gc_8c.html#a1224eeec4cd2de1c7104f78a579e63e8">gc_profile_clear</a>(<span class="keywordtype">void</span>)
<a name="l00666"></a>00666 {
<a name="l00667"></a>00667     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l00668"></a>00668     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a56d620b94b668ed7665d1616b2c54e48">MEMZERO</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>, <a class="code" href="../../d6/dc6/structgc__profile__record.html">gc_profile_record</a>, objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#acab1c19aadf393836c2f72a5dbc334a6">size</a>);
<a name="l00669"></a>00669     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab44b67a8f5128f8aac3c3c340d91d8dd">count</a> = 0;
<a name="l00670"></a>00670     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00671"></a>00671 }
<a name="l00672"></a>00672 
<a name="l00673"></a>00673 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l00674"></a><a class="code" href="../../d8/d16/gc_8c.html#a730804b1ab81ac246c90f32c5b525bae">00674</a> <a class="code" href="../../d8/d16/gc_8c.html#a730804b1ab81ac246c90f32c5b525bae">negative_size_allocation_error_with_gvl</a>(<span class="keywordtype">void</span> *ptr)
<a name="l00675"></a>00675 {
<a name="l00676"></a>00676     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a4f973054529e0ee4d2dfd40d9b6980ab">rb_eNoMemError</a>, <span class="stringliteral">&quot;%s&quot;</span>, (<span class="keyword">const</span> <span class="keywordtype">char</span> *)ptr);
<a name="l00677"></a>00677     <span class="keywordflow">return</span> 0; <span class="comment">/* should not be reached */</span>
<a name="l00678"></a>00678 }
<a name="l00679"></a>00679 
<a name="l00680"></a>00680 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00681"></a><a class="code" href="../../d8/d16/gc_8c.html#add45fa548f86379d0f5185769dfaec85">00681</a> <a class="code" href="../../d8/d16/gc_8c.html#add45fa548f86379d0f5185769dfaec85">negative_size_allocation_error</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d5/d04/strerror_8c.html#ae4f3f55be5de649fd367081b9d1b4b0c">msg</a>)
<a name="l00682"></a>00682 {
<a name="l00683"></a>00683     <span class="keywordflow">if</span> (<a class="code" href="../../d3/de7/thread_8c.html#a2293d6040c352991d160113a62fe5be3">ruby_thread_has_gvl_p</a>()) {
<a name="l00684"></a>00684         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a4f973054529e0ee4d2dfd40d9b6980ab">rb_eNoMemError</a>, <span class="stringliteral">&quot;%s&quot;</span>, msg);
<a name="l00685"></a>00685     }
<a name="l00686"></a>00686     <span class="keywordflow">else</span> {
<a name="l00687"></a>00687         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9d/tcltklib_8c.html#a9e7d742a9c52a78b9b3dc81df878e2ed">ruby_native_thread_p</a>()) {
<a name="l00688"></a>00688             <a class="code" href="../../d3/de7/thread_8c.html#a750cc265be9b084ee41c51157948f756">rb_thread_call_with_gvl</a>(<a class="code" href="../../d8/d16/gc_8c.html#a730804b1ab81ac246c90f32c5b525bae">negative_size_allocation_error_with_gvl</a>, (<span class="keywordtype">void</span> *)msg);
<a name="l00689"></a>00689         }
<a name="l00690"></a>00690         <span class="keywordflow">else</span> {
<a name="l00691"></a>00691             fprintf(stderr, <span class="stringliteral">&quot;[FATAL] %s\n&quot;</span>, msg);
<a name="l00692"></a>00692             exit(<a class="code" href="../../dd/dd0/eval__intern_8h.html#a73efe787c131b385070f25d18b7c9aa4">EXIT_FAILURE</a>);
<a name="l00693"></a>00693         }
<a name="l00694"></a>00694     }
<a name="l00695"></a>00695 }
<a name="l00696"></a>00696 
<a name="l00697"></a>00697 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l00698"></a><a class="code" href="../../d8/d16/gc_8c.html#ad63856b5ebe6854c2986f75c4ff112ad">00698</a> <a class="code" href="../../d8/d16/gc_8c.html#ad63856b5ebe6854c2986f75c4ff112ad">gc_with_gvl</a>(<span class="keywordtype">void</span> *ptr)
<a name="l00699"></a>00699 {
<a name="l00700"></a>00700     <span class="keywordflow">return</span> (<span class="keywordtype">void</span> *)(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)<a class="code" href="../../d8/d16/gc_8c.html#ae40ead8ed1ce1ae638710978a3fc8ff3">garbage_collect</a>((<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *)ptr);
<a name="l00701"></a>00701 }
<a name="l00702"></a>00702 
<a name="l00703"></a>00703 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00704"></a><a class="code" href="../../d8/d16/gc_8c.html#a10e6f1de8031d487e2e7608f7478cbe7">00704</a> <a class="code" href="../../d8/d16/gc_8c.html#a10e6f1de8031d487e2e7608f7478cbe7">garbage_collect_with_gvl</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l00705"></a>00705 {
<a name="l00706"></a>00706     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#af3db9015bc1d568dfbb6f98ff169ef97">dont_gc</a>) <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00707"></a>00707     <span class="keywordflow">if</span> (<a class="code" href="../../d3/de7/thread_8c.html#a2293d6040c352991d160113a62fe5be3">ruby_thread_has_gvl_p</a>()) {
<a name="l00708"></a>00708         <span class="keywordflow">return</span> <a class="code" href="../../d8/d16/gc_8c.html#ae40ead8ed1ce1ae638710978a3fc8ff3">garbage_collect</a>(objspace);
<a name="l00709"></a>00709     }
<a name="l00710"></a>00710     <span class="keywordflow">else</span> {
<a name="l00711"></a>00711         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9d/tcltklib_8c.html#a9e7d742a9c52a78b9b3dc81df878e2ed">ruby_native_thread_p</a>()) {
<a name="l00712"></a>00712             <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)<a class="code" href="../../d3/de7/thread_8c.html#a750cc265be9b084ee41c51157948f756">rb_thread_call_with_gvl</a>(<a class="code" href="../../d8/d16/gc_8c.html#ad63856b5ebe6854c2986f75c4ff112ad">gc_with_gvl</a>, (<span class="keywordtype">void</span> *)objspace);
<a name="l00713"></a>00713         }
<a name="l00714"></a>00714         <span class="keywordflow">else</span> {
<a name="l00715"></a>00715             <span class="comment">/* no ruby thread */</span>
<a name="l00716"></a>00716             fprintf(stderr, <span class="stringliteral">&quot;[FATAL] failed to allocate memory\n&quot;</span>);
<a name="l00717"></a>00717             exit(<a class="code" href="../../dd/dd0/eval__intern_8h.html#a73efe787c131b385070f25d18b7c9aa4">EXIT_FAILURE</a>);
<a name="l00718"></a>00718         }
<a name="l00719"></a>00719     }
<a name="l00720"></a>00720 }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d16/gc_8c.html#a90315e21f8a7bee7523a2e009bfa9777">vm_xfree</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <span class="keywordtype">void</span> *ptr);
<a name="l00723"></a>00723 
<a name="l00724"></a>00724 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">size_t</span>
<a name="l00725"></a><a class="code" href="../../d8/d16/gc_8c.html#ae440405a2d8c85c20ccefb3def5597f5">00725</a> <a class="code" href="../../d8/d16/gc_8c.html#ae440405a2d8c85c20ccefb3def5597f5">vm_malloc_prepare</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00726"></a>00726 {
<a name="l00727"></a>00727     <span class="keywordflow">if</span> ((ssize_t)size &lt; 0) {
<a name="l00728"></a>00728         <a class="code" href="../../d8/d16/gc_8c.html#add45fa548f86379d0f5185769dfaec85">negative_size_allocation_error</a>(<span class="stringliteral">&quot;negative allocation size (or too big)&quot;</span>);
<a name="l00729"></a>00729     }
<a name="l00730"></a>00730     <span class="keywordflow">if</span> (size == 0) size = 1;
<a name="l00731"></a>00731 
<a name="l00732"></a>00732 <span class="preprocessor">#if CALC_EXACT_MALLOC_SIZE</span>
<a name="l00733"></a>00733 <span class="preprocessor"></span>    size += <span class="keyword">sizeof</span>(size_t);
<a name="l00734"></a>00734 <span class="preprocessor">#endif</span>
<a name="l00735"></a>00735 <span class="preprocessor"></span>
<a name="l00736"></a>00736     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d16/gc_8c.html#aba00d537a97326bf91eeb0e17fc2204e">ruby_gc_stress</a> &amp;&amp; !ruby_disable_gc_stress) ||
<a name="l00737"></a>00737         (<a class="code" href="../../d8/d16/gc_8c.html#aef6ccce3587ce02d07ba0c720776f889">malloc_increase</a>+size) &gt; <a class="code" href="../../d8/d16/gc_8c.html#a8bcd401e2531e938e512cfb2e30dd4e6">malloc_limit</a>) {
<a name="l00738"></a>00738         <a class="code" href="../../d8/d16/gc_8c.html#a10e6f1de8031d487e2e7608f7478cbe7">garbage_collect_with_gvl</a>(objspace);
<a name="l00739"></a>00739     }
<a name="l00740"></a>00740 
<a name="l00741"></a>00741     <span class="keywordflow">return</span> size;
<a name="l00742"></a>00742 }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> *
<a name="l00745"></a><a class="code" href="../../d8/d16/gc_8c.html#aa50963062f98d1c6f5a5bba82b782cb4">00745</a> <a class="code" href="../../d8/d16/gc_8c.html#aa50963062f98d1c6f5a5bba82b782cb4">vm_malloc_fixup</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <span class="keywordtype">void</span> *mem, <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00746"></a>00746 {
<a name="l00747"></a>00747     <a class="code" href="../../d8/d16/gc_8c.html#aef6ccce3587ce02d07ba0c720776f889">malloc_increase</a> += size;
<a name="l00748"></a>00748 
<a name="l00749"></a>00749 <span class="preprocessor">#if CALC_EXACT_MALLOC_SIZE</span>
<a name="l00750"></a>00750 <span class="preprocessor"></span>    objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a00724648850701b4da94ec9edf7e07e2">malloc_params</a>.allocated_size += size;
<a name="l00751"></a>00751     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a00724648850701b4da94ec9edf7e07e2">malloc_params</a>.allocations++;
<a name="l00752"></a>00752     ((<span class="keywordtype">size_t</span> *)mem)[0] = size;
<a name="l00753"></a>00753     mem = (<span class="keywordtype">size_t</span> *)mem + 1;
<a name="l00754"></a>00754 <span class="preprocessor">#endif</span>
<a name="l00755"></a>00755 <span class="preprocessor"></span>
<a name="l00756"></a>00756     <span class="keywordflow">return</span> mem;
<a name="l00757"></a>00757 }
<a name="l00758"></a>00758 
<a name="l00759"></a><a class="code" href="../../d8/d16/gc_8c.html#a7017b4cf300bf1b1773af77bd2becdd8">00759</a> <span class="preprocessor">#define TRY_WITH_GC(alloc) do { \</span>
<a name="l00760"></a>00760 <span class="preprocessor">        if (!(alloc) &amp;&amp; \</span>
<a name="l00761"></a>00761 <span class="preprocessor">            (!garbage_collect_with_gvl(objspace) || \</span>
<a name="l00762"></a>00762 <span class="preprocessor">             !(alloc))) { \</span>
<a name="l00763"></a>00763 <span class="preprocessor">            ruby_memerror(); \</span>
<a name="l00764"></a>00764 <span class="preprocessor">        } \</span>
<a name="l00765"></a>00765 <span class="preprocessor">    } while (0)</span>
<a name="l00766"></a>00766 <span class="preprocessor"></span>
<a name="l00767"></a>00767 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l00768"></a><a class="code" href="../../d8/d16/gc_8c.html#a4f9ba6b787d1019c15ede3e14b5946d0">00768</a> <a class="code" href="../../d8/d16/gc_8c.html#a4f9ba6b787d1019c15ede3e14b5946d0">vm_xmalloc</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00769"></a>00769 {
<a name="l00770"></a>00770     <span class="keywordtype">void</span> *mem;
<a name="l00771"></a>00771 
<a name="l00772"></a>00772     size = <a class="code" href="../../d8/d16/gc_8c.html#ae440405a2d8c85c20ccefb3def5597f5">vm_malloc_prepare</a>(objspace, size);
<a name="l00773"></a>00773     <a class="code" href="../../d8/d16/gc_8c.html#a7017b4cf300bf1b1773af77bd2becdd8">TRY_WITH_GC</a>(mem = <a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(size));
<a name="l00774"></a>00774     <span class="keywordflow">return</span> <a class="code" href="../../d8/d16/gc_8c.html#aa50963062f98d1c6f5a5bba82b782cb4">vm_malloc_fixup</a>(objspace, mem, size);
<a name="l00775"></a>00775 }
<a name="l00776"></a>00776 
<a name="l00777"></a>00777 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l00778"></a><a class="code" href="../../d8/d16/gc_8c.html#a71b7d2a625f759943f113ba38628a975">00778</a> <a class="code" href="../../d8/d16/gc_8c.html#a71b7d2a625f759943f113ba38628a975">vm_xrealloc</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00779"></a>00779 {
<a name="l00780"></a>00780     <span class="keywordtype">void</span> *mem;
<a name="l00781"></a>00781 
<a name="l00782"></a>00782     <span class="keywordflow">if</span> ((ssize_t)size &lt; 0) {
<a name="l00783"></a>00783         <a class="code" href="../../d8/d16/gc_8c.html#add45fa548f86379d0f5185769dfaec85">negative_size_allocation_error</a>(<span class="stringliteral">&quot;negative re-allocation size&quot;</span>);
<a name="l00784"></a>00784     }
<a name="l00785"></a>00785     <span class="keywordflow">if</span> (!ptr) <span class="keywordflow">return</span> <a class="code" href="../../d8/d16/gc_8c.html#a4f9ba6b787d1019c15ede3e14b5946d0">vm_xmalloc</a>(objspace, size);
<a name="l00786"></a>00786     <span class="keywordflow">if</span> (size == 0) {
<a name="l00787"></a>00787         <a class="code" href="../../d8/d16/gc_8c.html#a90315e21f8a7bee7523a2e009bfa9777">vm_xfree</a>(objspace, ptr);
<a name="l00788"></a>00788         <span class="keywordflow">return</span> 0;
<a name="l00789"></a>00789     }
<a name="l00790"></a>00790     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#aba00d537a97326bf91eeb0e17fc2204e">ruby_gc_stress</a> &amp;&amp; !ruby_disable_gc_stress)
<a name="l00791"></a>00791         <a class="code" href="../../d8/d16/gc_8c.html#a10e6f1de8031d487e2e7608f7478cbe7">garbage_collect_with_gvl</a>(objspace);
<a name="l00792"></a>00792 
<a name="l00793"></a>00793 <span class="preprocessor">#if CALC_EXACT_MALLOC_SIZE</span>
<a name="l00794"></a>00794 <span class="preprocessor"></span>    size += <span class="keyword">sizeof</span>(size_t);
<a name="l00795"></a>00795     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a00724648850701b4da94ec9edf7e07e2">malloc_params</a>.allocated_size -= size;
<a name="l00796"></a>00796     ptr = (<span class="keywordtype">size_t</span> *)ptr - 1;
<a name="l00797"></a>00797 <span class="preprocessor">#endif</span>
<a name="l00798"></a>00798 <span class="preprocessor"></span>
<a name="l00799"></a>00799     mem = <a class="code" href="../../d5/d11/ripper_8c.html#a1b739878adcdb46fb5d209af7ce79628">realloc</a>(ptr, size);
<a name="l00800"></a>00800     <span class="keywordflow">if</span> (!mem) {
<a name="l00801"></a>00801         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a10e6f1de8031d487e2e7608f7478cbe7">garbage_collect_with_gvl</a>(objspace)) {
<a name="l00802"></a>00802             mem = <a class="code" href="../../d5/d11/ripper_8c.html#a1b739878adcdb46fb5d209af7ce79628">realloc</a>(ptr, size);
<a name="l00803"></a>00803         }
<a name="l00804"></a>00804         <span class="keywordflow">if</span> (!mem) {
<a name="l00805"></a>00805             <a class="code" href="../../d8/d16/gc_8c.html#a40dbcc73646b676fa655a31e9de5f0b0">ruby_memerror</a>();
<a name="l00806"></a>00806         }
<a name="l00807"></a>00807     }
<a name="l00808"></a>00808     <a class="code" href="../../d8/d16/gc_8c.html#aef6ccce3587ce02d07ba0c720776f889">malloc_increase</a> += size;
<a name="l00809"></a>00809 
<a name="l00810"></a>00810 <span class="preprocessor">#if CALC_EXACT_MALLOC_SIZE</span>
<a name="l00811"></a>00811 <span class="preprocessor"></span>    objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a00724648850701b4da94ec9edf7e07e2">malloc_params</a>.allocated_size += size;
<a name="l00812"></a>00812     ((<span class="keywordtype">size_t</span> *)mem)[0] = size;
<a name="l00813"></a>00813     mem = (<span class="keywordtype">size_t</span> *)mem + 1;
<a name="l00814"></a>00814 <span class="preprocessor">#endif</span>
<a name="l00815"></a>00815 <span class="preprocessor"></span>
<a name="l00816"></a>00816     <span class="keywordflow">return</span> mem;
<a name="l00817"></a>00817 }
<a name="l00818"></a>00818 
<a name="l00819"></a>00819 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00820"></a><a class="code" href="../../d8/d16/gc_8c.html#a90315e21f8a7bee7523a2e009bfa9777">00820</a> <a class="code" href="../../d8/d16/gc_8c.html#a90315e21f8a7bee7523a2e009bfa9777">vm_xfree</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <span class="keywordtype">void</span> *ptr)
<a name="l00821"></a>00821 {
<a name="l00822"></a>00822 <span class="preprocessor">#if CALC_EXACT_MALLOC_SIZE</span>
<a name="l00823"></a>00823 <span class="preprocessor"></span>    <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>;
<a name="l00824"></a>00824     ptr = ((<span class="keywordtype">size_t</span> *)ptr) - 1;
<a name="l00825"></a>00825     size = ((<span class="keywordtype">size_t</span>*)ptr)[0];
<a name="l00826"></a>00826     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a00724648850701b4da94ec9edf7e07e2">malloc_params</a>.allocated_size -= size;
<a name="l00827"></a>00827     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a00724648850701b4da94ec9edf7e07e2">malloc_params</a>.allocations--;
<a name="l00828"></a>00828 <span class="preprocessor">#endif</span>
<a name="l00829"></a>00829 <span class="preprocessor"></span>
<a name="l00830"></a>00830     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(ptr);
<a name="l00831"></a>00831 }
<a name="l00832"></a>00832 
<a name="l00833"></a>00833 <span class="keywordtype">void</span> *
<a name="l00834"></a><a class="code" href="../../d8/d16/gc_8c.html#a6bc5fb330da1d3b53deec9a4fd38f72f">00834</a> <a class="code" href="../../d8/d16/gc_8c.html#a6bc5fb330da1d3b53deec9a4fd38f72f">ruby_xmalloc</a>(<span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00835"></a>00835 {
<a name="l00836"></a>00836     <span class="keywordflow">return</span> <a class="code" href="../../d8/d16/gc_8c.html#a4f9ba6b787d1019c15ede3e14b5946d0">vm_xmalloc</a>(&amp;rb_objspace, size);
<a name="l00837"></a>00837 }
<a name="l00838"></a>00838 
<a name="l00839"></a>00839 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">size_t</span>
<a name="l00840"></a><a class="code" href="../../d8/d16/gc_8c.html#aca13826ee8cbbbc540c9ceb262e2f7f3">00840</a> <a class="code" href="../../d8/d16/gc_8c.html#aca13826ee8cbbbc540c9ceb262e2f7f3">xmalloc2_size</a>(<span class="keywordtype">size_t</span> n, <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00841"></a>00841 {
<a name="l00842"></a>00842     <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = size * n;
<a name="l00843"></a>00843     <span class="keywordflow">if</span> (n != 0 &amp;&amp; size != len / n) {
<a name="l00844"></a>00844         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;malloc: possible integer overflow&quot;</span>);
<a name="l00845"></a>00845     }
<a name="l00846"></a>00846     <span class="keywordflow">return</span> len;
<a name="l00847"></a>00847 }
<a name="l00848"></a>00848 
<a name="l00849"></a>00849 <span class="keywordtype">void</span> *
<a name="l00850"></a><a class="code" href="../../d8/d16/gc_8c.html#a270ca68bb5b041856969a8200d9a5877">00850</a> <a class="code" href="../../d8/d16/gc_8c.html#a270ca68bb5b041856969a8200d9a5877">ruby_xmalloc2</a>(<span class="keywordtype">size_t</span> n, <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00851"></a>00851 {
<a name="l00852"></a>00852     <span class="keywordflow">return</span> <a class="code" href="../../d8/d16/gc_8c.html#a4f9ba6b787d1019c15ede3e14b5946d0">vm_xmalloc</a>(&amp;rb_objspace, <a class="code" href="../../d8/d16/gc_8c.html#aca13826ee8cbbbc540c9ceb262e2f7f3">xmalloc2_size</a>(n, size));
<a name="l00853"></a>00853 }
<a name="l00854"></a>00854 
<a name="l00855"></a>00855 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l00856"></a><a class="code" href="../../d8/d16/gc_8c.html#a36eaef7d76f993b769ea10f785dea603">00856</a> <a class="code" href="../../d8/d16/gc_8c.html#a36eaef7d76f993b769ea10f785dea603">vm_xcalloc</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>, <span class="keywordtype">size_t</span> elsize)
<a name="l00857"></a>00857 {
<a name="l00858"></a>00858     <span class="keywordtype">void</span> *mem;
<a name="l00859"></a>00859     <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861     size = <a class="code" href="../../d8/d16/gc_8c.html#aca13826ee8cbbbc540c9ceb262e2f7f3">xmalloc2_size</a>(count, elsize);
<a name="l00862"></a>00862     size = <a class="code" href="../../d8/d16/gc_8c.html#ae440405a2d8c85c20ccefb3def5597f5">vm_malloc_prepare</a>(objspace, size);
<a name="l00863"></a>00863 
<a name="l00864"></a>00864     <a class="code" href="../../d8/d16/gc_8c.html#a7017b4cf300bf1b1773af77bd2becdd8">TRY_WITH_GC</a>(mem = <a class="code" href="../../d5/d11/ripper_8c.html#a84beef8cc122add35118ec7cd35286c4">calloc</a>(1, size));
<a name="l00865"></a>00865     <span class="keywordflow">return</span> <a class="code" href="../../d8/d16/gc_8c.html#aa50963062f98d1c6f5a5bba82b782cb4">vm_malloc_fixup</a>(objspace, mem, size);
<a name="l00866"></a>00866 }
<a name="l00867"></a>00867 
<a name="l00868"></a>00868 <span class="keywordtype">void</span> *
<a name="l00869"></a><a class="code" href="../../d8/d16/gc_8c.html#af138664fd4aa149328f138241bead053">00869</a> <a class="code" href="../../d8/d16/gc_8c.html#af138664fd4aa149328f138241bead053">ruby_xcalloc</a>(<span class="keywordtype">size_t</span> n, <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00870"></a>00870 {
<a name="l00871"></a>00871     <span class="keywordflow">return</span> <a class="code" href="../../d8/d16/gc_8c.html#a36eaef7d76f993b769ea10f785dea603">vm_xcalloc</a>(&amp;rb_objspace, n, size);
<a name="l00872"></a>00872 }
<a name="l00873"></a>00873 
<a name="l00874"></a>00874 <span class="keywordtype">void</span> *
<a name="l00875"></a><a class="code" href="../../d8/d16/gc_8c.html#a6d2202b39dca06c253433cae603ed97f">00875</a> <a class="code" href="../../d8/d16/gc_8c.html#a6d2202b39dca06c253433cae603ed97f">ruby_xrealloc</a>(<span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00876"></a>00876 {
<a name="l00877"></a>00877     <span class="keywordflow">return</span> <a class="code" href="../../d8/d16/gc_8c.html#a71b7d2a625f759943f113ba38628a975">vm_xrealloc</a>(&amp;rb_objspace, ptr, size);
<a name="l00878"></a>00878 }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880 <span class="keywordtype">void</span> *
<a name="l00881"></a><a class="code" href="../../d8/d16/gc_8c.html#a53d01e246b9eb6f9c613ec583c39bd12">00881</a> <a class="code" href="../../d8/d16/gc_8c.html#a53d01e246b9eb6f9c613ec583c39bd12">ruby_xrealloc2</a>(<span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> n, <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l00882"></a>00882 {
<a name="l00883"></a>00883     <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = size * n;
<a name="l00884"></a>00884     <span class="keywordflow">if</span> (n != 0 &amp;&amp; size != len / n) {
<a name="l00885"></a>00885         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;realloc: possible integer overflow&quot;</span>);
<a name="l00886"></a>00886     }
<a name="l00887"></a>00887     <span class="keywordflow">return</span> <a class="code" href="../../d8/d16/gc_8c.html#a6d2202b39dca06c253433cae603ed97f">ruby_xrealloc</a>(ptr, len);
<a name="l00888"></a>00888 }
<a name="l00889"></a>00889 
<a name="l00890"></a>00890 <span class="keywordtype">void</span>
<a name="l00891"></a><a class="code" href="../../d8/d16/gc_8c.html#a0bffec5b2cc004adcebb6802e7620387">00891</a> <a class="code" href="../../d8/d16/gc_8c.html#a0bffec5b2cc004adcebb6802e7620387">ruby_xfree</a>(<span class="keywordtype">void</span> *x)
<a name="l00892"></a>00892 {
<a name="l00893"></a>00893     <span class="keywordflow">if</span> (x)
<a name="l00894"></a>00894         <a class="code" href="../../d8/d16/gc_8c.html#a90315e21f8a7bee7523a2e009bfa9777">vm_xfree</a>(&amp;rb_objspace, x);
<a name="l00895"></a>00895 }
<a name="l00896"></a>00896 
<a name="l00897"></a>00897 
<a name="l00898"></a>00898 <span class="comment">/*</span>
<a name="l00899"></a>00899 <span class="comment"> *  call-seq:</span>
<a name="l00900"></a>00900 <span class="comment"> *     GC.enable    -&gt; true or false</span>
<a name="l00901"></a>00901 <span class="comment"> *</span>
<a name="l00902"></a>00902 <span class="comment"> *  Enables garbage collection, returning &lt;code&gt;true&lt;/code&gt; if garbage</span>
<a name="l00903"></a>00903 <span class="comment"> *  collection was previously disabled.</span>
<a name="l00904"></a>00904 <span class="comment"> *</span>
<a name="l00905"></a>00905 <span class="comment"> *     GC.disable   #=&gt; false</span>
<a name="l00906"></a>00906 <span class="comment"> *     GC.enable    #=&gt; true</span>
<a name="l00907"></a>00907 <span class="comment"> *     GC.enable    #=&gt; false</span>
<a name="l00908"></a>00908 <span class="comment"> *</span>
<a name="l00909"></a>00909 <span class="comment"> */</span>
<a name="l00910"></a>00910 
<a name="l00911"></a>00911 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00912"></a><a class="code" href="../../db/d2e/intern_8h.html#a3cbc64cc9d74c437c08a5dc923d1c7dd">00912</a> <a class="code" href="../../d8/d16/gc_8c.html#a3cbc64cc9d74c437c08a5dc923d1c7dd">rb_gc_enable</a>(<span class="keywordtype">void</span>)
<a name="l00913"></a>00913 {
<a name="l00914"></a>00914     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l00915"></a>00915     <span class="keywordtype">int</span> old = <a class="code" href="../../d8/d16/gc_8c.html#af3db9015bc1d568dfbb6f98ff169ef97">dont_gc</a>;
<a name="l00916"></a>00916 
<a name="l00917"></a>00917     <a class="code" href="../../d8/d16/gc_8c.html#af3db9015bc1d568dfbb6f98ff169ef97">dont_gc</a> = <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00918"></a>00918     <span class="keywordflow">return</span> old ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l00919"></a>00919 }
<a name="l00920"></a>00920 
<a name="l00921"></a>00921 <span class="comment">/*</span>
<a name="l00922"></a>00922 <span class="comment"> *  call-seq:</span>
<a name="l00923"></a>00923 <span class="comment"> *     GC.disable    -&gt; true or false</span>
<a name="l00924"></a>00924 <span class="comment"> *</span>
<a name="l00925"></a>00925 <span class="comment"> *  Disables garbage collection, returning &lt;code&gt;true&lt;/code&gt; if garbage</span>
<a name="l00926"></a>00926 <span class="comment"> *  collection was already disabled.</span>
<a name="l00927"></a>00927 <span class="comment"> *</span>
<a name="l00928"></a>00928 <span class="comment"> *     GC.disable   #=&gt; false</span>
<a name="l00929"></a>00929 <span class="comment"> *     GC.disable   #=&gt; true</span>
<a name="l00930"></a>00930 <span class="comment"> *</span>
<a name="l00931"></a>00931 <span class="comment"> */</span>
<a name="l00932"></a>00932 
<a name="l00933"></a>00933 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00934"></a><a class="code" href="../../db/d2e/intern_8h.html#a27a2dbb7307d5ea8e096ce4357f6ece6">00934</a> <a class="code" href="../../d8/d16/gc_8c.html#a27a2dbb7307d5ea8e096ce4357f6ece6">rb_gc_disable</a>(<span class="keywordtype">void</span>)
<a name="l00935"></a>00935 {
<a name="l00936"></a>00936     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l00937"></a>00937     <span class="keywordtype">int</span> old = <a class="code" href="../../d8/d16/gc_8c.html#af3db9015bc1d568dfbb6f98ff169ef97">dont_gc</a>;
<a name="l00938"></a>00938 
<a name="l00939"></a>00939     <a class="code" href="../../d8/d16/gc_8c.html#af3db9015bc1d568dfbb6f98ff169ef97">dont_gc</a> = <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00940"></a>00940     <span class="keywordflow">return</span> old ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l00941"></a>00941 }
<a name="l00942"></a>00942 
<a name="l00943"></a><a class="code" href="../../d8/d16/gc_8c.html#a6f20c4094ef7b6c6bced06cc3b86b531">00943</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d8/d16/gc_8c.html#a6f20c4094ef7b6c6bced06cc3b86b531">rb_mGC</a>;
<a name="l00944"></a>00944 
<a name="l00945"></a>00945 <span class="keywordtype">void</span>
<a name="l00946"></a><a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3f6582d7ce88966569003eee9b2706ba">00946</a> <a class="code" href="../../d8/d16/gc_8c.html#adc7efe8997f04b5c275d7e7aed9169e3">rb_gc_register_mark_object</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj)
<a name="l00947"></a>00947 {
<a name="l00948"></a>00948     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>()-&gt;vm-&gt;mark_object_ary;
<a name="l00949"></a>00949     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, obj);
<a name="l00950"></a>00950 }
<a name="l00951"></a>00951 
<a name="l00952"></a>00952 <span class="keywordtype">void</span>
<a name="l00953"></a><a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9702c1a8500b467d0590bedb7dc8f6df">00953</a> <a class="code" href="../../d8/d16/gc_8c.html#ad0a40ec1bb0a454b10bfd9727e741511">rb_gc_register_address</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *addr)
<a name="l00954"></a>00954 {
<a name="l00955"></a>00955     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l00956"></a>00956     <span class="keyword">struct </span><a class="code" href="../../db/deb/structgc__list.html">gc_list</a> *tmp;
<a name="l00957"></a>00957 
<a name="l00958"></a>00958     tmp = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac8df5a8a8961bd9e16be385fef28c2f2">ALLOC</a>(<span class="keyword">struct</span> <a class="code" href="../../db/deb/structgc__list.html">gc_list</a>);
<a name="l00959"></a>00959     tmp-&gt;<a class="code" href="../../db/deb/structgc__list.html#a57d24fcd3af36e93f16a3bee72773025">next</a> = <a class="code" href="../../d8/d16/gc_8c.html#a24293dffd2d9e073607ec2e58ad90f15">global_List</a>;
<a name="l00960"></a>00960     tmp-&gt;<a class="code" href="../../db/deb/structgc__list.html#aa0960ced4053997d8848996b638564c1">varptr</a> = addr;
<a name="l00961"></a>00961     <a class="code" href="../../d8/d16/gc_8c.html#a24293dffd2d9e073607ec2e58ad90f15">global_List</a> = tmp;
<a name="l00962"></a>00962 }
<a name="l00963"></a>00963 
<a name="l00964"></a>00964 <span class="keywordtype">void</span>
<a name="l00965"></a><a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4074c9f89941eb564bcf9e1c90ca8b4c">00965</a> <a class="code" href="../../d8/d16/gc_8c.html#ac23599b4e229eebfad59b58e2705f7ca">rb_gc_unregister_address</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *addr)
<a name="l00966"></a>00966 {
<a name="l00967"></a>00967     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l00968"></a>00968     <span class="keyword">struct </span><a class="code" href="../../db/deb/structgc__list.html">gc_list</a> *tmp = <a class="code" href="../../d8/d16/gc_8c.html#a24293dffd2d9e073607ec2e58ad90f15">global_List</a>;
<a name="l00969"></a>00969 
<a name="l00970"></a>00970     <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="../../db/deb/structgc__list.html#aa0960ced4053997d8848996b638564c1">varptr</a> == addr) {
<a name="l00971"></a>00971         <a class="code" href="../../d8/d16/gc_8c.html#a24293dffd2d9e073607ec2e58ad90f15">global_List</a> = tmp-&gt;<a class="code" href="../../db/deb/structgc__list.html#a57d24fcd3af36e93f16a3bee72773025">next</a>;
<a name="l00972"></a>00972         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(tmp);
<a name="l00973"></a>00973         <span class="keywordflow">return</span>;
<a name="l00974"></a>00974     }
<a name="l00975"></a>00975     <span class="keywordflow">while</span> (tmp-&gt;<a class="code" href="../../db/deb/structgc__list.html#a57d24fcd3af36e93f16a3bee72773025">next</a>) {
<a name="l00976"></a>00976         <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="../../db/deb/structgc__list.html#a57d24fcd3af36e93f16a3bee72773025">next</a>-&gt;<a class="code" href="../../db/deb/structgc__list.html#aa0960ced4053997d8848996b638564c1">varptr</a> == addr) {
<a name="l00977"></a>00977             <span class="keyword">struct </span><a class="code" href="../../db/deb/structgc__list.html">gc_list</a> *t = tmp-&gt;<a class="code" href="../../db/deb/structgc__list.html#a57d24fcd3af36e93f16a3bee72773025">next</a>;
<a name="l00978"></a>00978 
<a name="l00979"></a>00979             tmp-&gt;<a class="code" href="../../db/deb/structgc__list.html#a57d24fcd3af36e93f16a3bee72773025">next</a> = tmp-&gt;<a class="code" href="../../db/deb/structgc__list.html#a57d24fcd3af36e93f16a3bee72773025">next</a>-&gt;<a class="code" href="../../db/deb/structgc__list.html#a57d24fcd3af36e93f16a3bee72773025">next</a>;
<a name="l00980"></a>00980             <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(t);
<a name="l00981"></a>00981             <span class="keywordflow">break</span>;
<a name="l00982"></a>00982         }
<a name="l00983"></a>00983         tmp = tmp-&gt;<a class="code" href="../../db/deb/structgc__list.html#a57d24fcd3af36e93f16a3bee72773025">next</a>;
<a name="l00984"></a>00984     }
<a name="l00985"></a>00985 }
<a name="l00986"></a>00986 
<a name="l00987"></a>00987 
<a name="l00988"></a>00988 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00989"></a><a class="code" href="../../d8/d16/gc_8c.html#adaac76849af684a61b2e6ebc5538c70c">00989</a> <a class="code" href="../../d8/d16/gc_8c.html#adaac76849af684a61b2e6ebc5538c70c">allocate_sorted_heaps</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <span class="keywordtype">size_t</span> next_heaps_length)
<a name="l00990"></a>00990 {
<a name="l00991"></a>00991     <span class="keyword">struct </span><a class="code" href="../../d8/d95/structsorted__heaps__slot.html">sorted_heaps_slot</a> *p;
<a name="l00992"></a>00992     <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>;
<a name="l00993"></a>00993 
<a name="l00994"></a>00994     size = next_heaps_length*<span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="../../d8/d95/structsorted__heaps__slot.html">sorted_heaps_slot</a>);
<a name="l00995"></a>00995 
<a name="l00996"></a>00996     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a> &gt; 0) {
<a name="l00997"></a>00997         p = (<span class="keyword">struct </span><a class="code" href="../../d8/d95/structsorted__heaps__slot.html">sorted_heaps_slot</a> *)<a class="code" href="../../d5/d11/ripper_8c.html#a1b739878adcdb46fb5d209af7ce79628">realloc</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>, size);
<a name="l00998"></a>00998         <span class="keywordflow">if</span> (p) objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a> = p;
<a name="l00999"></a>00999     }
<a name="l01000"></a>01000     <span class="keywordflow">else</span> {
<a name="l01001"></a>01001         p = objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a> = (<span class="keyword">struct </span><a class="code" href="../../d8/d95/structsorted__heaps__slot.html">sorted_heaps_slot</a> *)<a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(size);
<a name="l01002"></a>01002     }
<a name="l01003"></a>01003 
<a name="l01004"></a>01004     <span class="keywordflow">if</span> (p == 0) {
<a name="l01005"></a>01005         <a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a> = 0;
<a name="l01006"></a>01006         <a class="code" href="../../d8/d16/gc_8c.html#a14b9fe6e6bba3f2279b95af407c546f8">rb_memerror</a>();
<a name="l01007"></a>01007     }
<a name="l01008"></a>01008     <a class="code" href="../../d8/d16/gc_8c.html#aed54069fadeba11ffce2b8cdf5412255">heaps_length</a> = next_heaps_length;
<a name="l01009"></a>01009 }
<a name="l01010"></a>01010 
<a name="l01011"></a>01011 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01012"></a><a class="code" href="../../d8/d16/gc_8c.html#ade1a9f3d1faf57ca8ee95b45df7def26">01012</a> <a class="code" href="../../d8/d16/gc_8c.html#ade1a9f3d1faf57ca8ee95b45df7def26">assign_heap_slot</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l01013"></a>01013 {
<a name="l01014"></a>01014     <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *p, *pend, *membase;
<a name="l01015"></a>01015     <span class="keyword">struct </span><a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a> *<a class="code" href="../../da/dda/structheaps__slot.html#ae677a624c841d9129e8f31d350dc5f21">slot</a>;
<a name="l01016"></a>01016     <span class="keywordtype">size_t</span> <a class="code" href="../../dd/d2d/siphash_8c.html#a073817140685ccd37103f69352762610">hi</a>, <a class="code" href="../../dd/d2d/siphash_8c.html#a06c5f8eeca62bb9b7d4c85d43c4f20d9">lo</a>, mid;
<a name="l01017"></a>01017     <span class="keywordtype">size_t</span> objs;
<a name="l01018"></a>01018 
<a name="l01019"></a>01019     objs = <a class="code" href="../../d8/d16/gc_8c.html#a82e0c515bb2727a22897b61364edf3dc">HEAP_OBJ_LIMIT</a>;
<a name="l01020"></a>01020     p = (<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a>*)<a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(<a class="code" href="../../d8/d16/gc_8c.html#a1b45302695680930829cac31d65e41e1">HEAP_SIZE</a>);
<a name="l01021"></a>01021     <span class="keywordflow">if</span> (p == 0) {
<a name="l01022"></a>01022         <a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a> = 0;
<a name="l01023"></a>01023         <a class="code" href="../../d8/d16/gc_8c.html#a14b9fe6e6bba3f2279b95af407c546f8">rb_memerror</a>();
<a name="l01024"></a>01024     }
<a name="l01025"></a>01025     slot = (<span class="keyword">struct </span><a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a> *)<a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a>));
<a name="l01026"></a>01026     <span class="keywordflow">if</span> (slot == 0) {
<a name="l01027"></a>01027         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(p);
<a name="l01028"></a>01028         <a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a> = 0;
<a name="l01029"></a>01029         <a class="code" href="../../d8/d16/gc_8c.html#a14b9fe6e6bba3f2279b95af407c546f8">rb_memerror</a>();
<a name="l01030"></a>01030     }
<a name="l01031"></a>01031     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a56d620b94b668ed7665d1616b2c54e48">MEMZERO</a>((<span class="keywordtype">void</span>*)slot, <span class="keyword">struct</span> <a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a>, 1);
<a name="l01032"></a>01032 
<a name="l01033"></a>01033     slot-&gt;next = <a class="code" href="../../d8/d16/gc_8c.html#a3eb89961b2be51932ecadee6b63963ba">heaps</a>;
<a name="l01034"></a>01034     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a3eb89961b2be51932ecadee6b63963ba">heaps</a>) <a class="code" href="../../d8/d16/gc_8c.html#a3eb89961b2be51932ecadee6b63963ba">heaps</a>-&gt;prev = slot;
<a name="l01035"></a>01035     <a class="code" href="../../d8/d16/gc_8c.html#a3eb89961b2be51932ecadee6b63963ba">heaps</a> = slot;
<a name="l01036"></a>01036 
<a name="l01037"></a>01037     membase = p;
<a name="l01038"></a>01038     <span class="keywordflow">if</span> ((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)p % <span class="keyword">sizeof</span>(<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a>) != 0) {
<a name="l01039"></a>01039         p = (<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a>*)((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)p + <span class="keyword">sizeof</span>(<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a>) - ((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)p % <span class="keyword">sizeof</span>(<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a>)));
<a name="l01040"></a>01040         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d16/gc_8c.html#a1b45302695680930829cac31d65e41e1">HEAP_SIZE</a> - <a class="code" href="../../d8/d16/gc_8c.html#a82e0c515bb2727a22897b61364edf3dc">HEAP_OBJ_LIMIT</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a>)) &lt; (<span class="keywordtype">size_t</span>)((<span class="keywordtype">char</span>*)p - (<span class="keywordtype">char</span>*)membase)) {
<a name="l01041"></a>01041             objs--;
<a name="l01042"></a>01042         }
<a name="l01043"></a>01043     }
<a name="l01044"></a>01044 
<a name="l01045"></a>01045     lo = 0;
<a name="l01046"></a>01046     hi = <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a>;
<a name="l01047"></a>01047     <span class="keywordflow">while</span> (lo &lt; hi) {
<a name="l01048"></a>01048         <span class="keyword">register</span> <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *mid_membase;
<a name="l01049"></a>01049         mid = (lo + hi) / 2;
<a name="l01050"></a>01050         mid_membase = objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[mid].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a79843785a726ea01bb4683ad9ba055d3">slot</a>-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a4e10e0c9aba6f88eddf3d5f6d9c408fb">membase</a>;
<a name="l01051"></a>01051         <span class="keywordflow">if</span> (mid_membase &lt; membase) {
<a name="l01052"></a>01052             lo = mid + 1;
<a name="l01053"></a>01053         }
<a name="l01054"></a>01054         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mid_membase &gt; membase) {
<a name="l01055"></a>01055             hi = mid;
<a name="l01056"></a>01056         }
<a name="l01057"></a>01057         <span class="keywordflow">else</span> {
<a name="l01058"></a>01058             <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;same heap slot is allocated: %p at %&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae774c3950c5712bd0935dc2e10ee613e">PRIuVALUE</a>, (<span class="keywordtype">void</span> *)membase, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)mid);
<a name="l01059"></a>01059         }
<a name="l01060"></a>01060     }
<a name="l01061"></a>01061     <span class="keywordflow">if</span> (hi &lt; <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a>) {
<a name="l01062"></a>01062         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aad09de334c9b8c7f717d314b14679e62">MEMMOVE</a>(&amp;objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[hi+1], &amp;objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[hi], <span class="keyword">struct</span> <a class="code" href="../../d8/d95/structsorted__heaps__slot.html">sorted_heaps_slot</a>, <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a> - hi);
<a name="l01063"></a>01063     }
<a name="l01064"></a>01064     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[hi].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a79843785a726ea01bb4683ad9ba055d3">slot</a> = slot;
<a name="l01065"></a>01065     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[hi].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#ad33de4cd59e7ea8cba62c94e024d6829">start</a> = p;
<a name="l01066"></a>01066     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[hi].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a4344f152198021b7a489fbcfbe187f44">end</a> = (p + objs);
<a name="l01067"></a>01067     <a class="code" href="../../d8/d16/gc_8c.html#a3eb89961b2be51932ecadee6b63963ba">heaps</a>-&gt;membase = membase;
<a name="l01068"></a>01068     <a class="code" href="../../d8/d16/gc_8c.html#a3eb89961b2be51932ecadee6b63963ba">heaps</a>-&gt;slot = p;
<a name="l01069"></a>01069     <a class="code" href="../../d8/d16/gc_8c.html#a3eb89961b2be51932ecadee6b63963ba">heaps</a>-&gt;limit = objs;
<a name="l01070"></a>01070     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#adae35865d1de5847544a532a63c451fa">free_num</a> += objs;
<a name="l01071"></a>01071     pend = p + objs;
<a name="l01072"></a>01072     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a44030085eee46549ee44e25595782109">lomem</a> == 0 || <a class="code" href="../../d8/d16/gc_8c.html#a44030085eee46549ee44e25595782109">lomem</a> &gt; p) <a class="code" href="../../d8/d16/gc_8c.html#a44030085eee46549ee44e25595782109">lomem</a> = p;
<a name="l01073"></a>01073     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a5072e77cd94db97413518f9513840112">himem</a> &lt; pend) <a class="code" href="../../d8/d16/gc_8c.html#a5072e77cd94db97413518f9513840112">himem</a> = pend;
<a name="l01074"></a>01074     <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a>++;
<a name="l01075"></a>01075 
<a name="l01076"></a>01076     <span class="keywordflow">while</span> (p &lt; pend) {
<a name="l01077"></a>01077         p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#af8cb8a1856ec08aeed677584f8930880">free</a>.flags = 0;
<a name="l01078"></a>01078         p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#af8cb8a1856ec08aeed677584f8930880">free</a>.next = <a class="code" href="../../d8/d16/gc_8c.html#a896e77038c659ca416b686f1e7a93eb8">freelist</a>;
<a name="l01079"></a>01079         <a class="code" href="../../d8/d16/gc_8c.html#a896e77038c659ca416b686f1e7a93eb8">freelist</a> = p;
<a name="l01080"></a>01080         p++;
<a name="l01081"></a>01081     }
<a name="l01082"></a>01082 }
<a name="l01083"></a>01083 
<a name="l01084"></a>01084 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01085"></a><a class="code" href="../../d8/d16/gc_8c.html#a2ac6bfbf38d538ee793dca2ada438eba">01085</a> <a class="code" href="../../d8/d16/gc_8c.html#a2ac6bfbf38d538ee793dca2ada438eba">add_heap_slots</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <span class="keywordtype">size_t</span> <a class="code" href="../../d1/d6f/date__strftime_8c.html#aa62ba8463316e20fcef4b9db83bab2fd">add</a>)
<a name="l01086"></a>01086 {
<a name="l01087"></a>01087     <span class="keywordtype">size_t</span> i;
<a name="l01088"></a>01088 
<a name="l01089"></a>01089     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a> + add) &gt; <a class="code" href="../../d8/d16/gc_8c.html#aed54069fadeba11ffce2b8cdf5412255">heaps_length</a>) {
<a name="l01090"></a>01090         <a class="code" href="../../d8/d16/gc_8c.html#adaac76849af684a61b2e6ebc5538c70c">allocate_sorted_heaps</a>(objspace, <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a> + add);
<a name="l01091"></a>01091     }
<a name="l01092"></a>01092 
<a name="l01093"></a>01093     <span class="keywordflow">for</span> (i = 0; i &lt; add; i++) {
<a name="l01094"></a>01094         <a class="code" href="../../d8/d16/gc_8c.html#ade1a9f3d1faf57ca8ee95b45df7def26">assign_heap_slot</a>(objspace);
<a name="l01095"></a>01095     }
<a name="l01096"></a>01096     <a class="code" href="../../d8/d16/gc_8c.html#a2081c1ed3cfcae50159143e599b5fd34">heaps_inc</a> = 0;
<a name="l01097"></a>01097 }
<a name="l01098"></a>01098 
<a name="l01099"></a>01099 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01100"></a><a class="code" href="../../d8/d16/gc_8c.html#aabf1d9f721b7654647f11fa09694df32">01100</a> <a class="code" href="../../d8/d16/gc_8c.html#aabf1d9f721b7654647f11fa09694df32">init_heap</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l01101"></a>01101 {
<a name="l01102"></a>01102     <a class="code" href="../../d8/d16/gc_8c.html#a2ac6bfbf38d538ee793dca2ada438eba">add_heap_slots</a>(objspace, <a class="code" href="../../d8/d16/gc_8c.html#a323a78736c2adfb81b32f30dfcbed8a7">HEAP_MIN_SLOTS</a> / <a class="code" href="../../d8/d16/gc_8c.html#a82e0c515bb2727a22897b61364edf3dc">HEAP_OBJ_LIMIT</a>);
<a name="l01103"></a>01103 <span class="preprocessor">#ifdef USE_SIGALTSTACK</span>
<a name="l01104"></a>01104 <span class="preprocessor"></span>    {
<a name="l01105"></a>01105         <span class="comment">/* altstack of another threads are allocated in another place */</span>
<a name="l01106"></a>01106         <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l01107"></a>01107         <span class="keywordtype">void</span> *tmp = th-&gt;altstack;
<a name="l01108"></a>01108         th-&gt;altstack = <a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(<a class="code" href="../../d8/d32/vm__core_8h.html#aca50bfb7be201e098951bf4ec357f5c2">ALT_STACK_SIZE</a>);
<a name="l01109"></a>01109         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(tmp); <span class="comment">/* free previously allocated area */</span>
<a name="l01110"></a>01110     }
<a name="l01111"></a>01111 <span class="preprocessor">#endif</span>
<a name="l01112"></a>01112 <span class="preprocessor"></span>
<a name="l01113"></a>01113     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a27009672b0838377246bef2ba66bac27">invoke_time</a> = <a class="code" href="../../d8/d16/gc_8c.html#a329edc8e2e8049fa7b5a08a83eb8261f">getrusage_time</a>();
<a name="l01114"></a>01114     <a class="code" href="../../d8/d16/gc_8c.html#ad42bffe188d60ed392ba783bf4c5e91b">finalizer_table</a> = <a class="code" href="../../dd/d24/st_8h.html#a955c6e936b9681649ab9ffa4aa741949">st_init_numtable</a>();
<a name="l01115"></a>01115 }
<a name="l01116"></a>01116 
<a name="l01117"></a>01117 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01118"></a><a class="code" href="../../d8/d16/gc_8c.html#ad90afff6d51115e96f5fa3bfaf42a988">01118</a> <a class="code" href="../../d8/d16/gc_8c.html#ad90afff6d51115e96f5fa3bfaf42a988">initial_expand_heap</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l01119"></a>01119 {
<a name="l01120"></a>01120     <span class="keywordtype">size_t</span> min_size = <a class="code" href="../../d8/d16/gc_8c.html#af98c6835eb4ba334b98c1de2eb0852f1">initial_heap_min_slots</a> / <a class="code" href="../../d8/d16/gc_8c.html#a82e0c515bb2727a22897b61364edf3dc">HEAP_OBJ_LIMIT</a>;
<a name="l01121"></a>01121 
<a name="l01122"></a>01122     <span class="keywordflow">if</span> (min_size &gt; <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a>) {
<a name="l01123"></a>01123         <a class="code" href="../../d8/d16/gc_8c.html#a2ac6bfbf38d538ee793dca2ada438eba">add_heap_slots</a>(objspace, min_size - <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a>);
<a name="l01124"></a>01124     }
<a name="l01125"></a>01125 }
<a name="l01126"></a>01126 
<a name="l01127"></a>01127 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01128"></a><a class="code" href="../../d8/d16/gc_8c.html#a0573de72950f16e074f90eb6cebe798e">01128</a> <a class="code" href="../../d8/d16/gc_8c.html#a0573de72950f16e074f90eb6cebe798e">set_heaps_increment</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l01129"></a>01129 {
<a name="l01130"></a>01130     <span class="keywordtype">size_t</span> next_heaps_length = (size_t)(<a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a> * 1.8);
<a name="l01131"></a>01131 
<a name="l01132"></a>01132     <span class="keywordflow">if</span> (next_heaps_length == <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a>) {
<a name="l01133"></a>01133         next_heaps_length++;
<a name="l01134"></a>01134     }
<a name="l01135"></a>01135 
<a name="l01136"></a>01136     <a class="code" href="../../d8/d16/gc_8c.html#a2081c1ed3cfcae50159143e599b5fd34">heaps_inc</a> = next_heaps_length - <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a>;
<a name="l01137"></a>01137 
<a name="l01138"></a>01138     <span class="keywordflow">if</span> (next_heaps_length &gt; <a class="code" href="../../d8/d16/gc_8c.html#aed54069fadeba11ffce2b8cdf5412255">heaps_length</a>) {
<a name="l01139"></a>01139         <a class="code" href="../../d8/d16/gc_8c.html#adaac76849af684a61b2e6ebc5538c70c">allocate_sorted_heaps</a>(objspace, next_heaps_length);
<a name="l01140"></a>01140     }
<a name="l01141"></a>01141 }
<a name="l01142"></a>01142 
<a name="l01143"></a>01143 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01144"></a><a class="code" href="../../d8/d16/gc_8c.html#a4c82c9dea941e571de0ef59457d2810a">01144</a> <a class="code" href="../../d8/d16/gc_8c.html#a4c82c9dea941e571de0ef59457d2810a">heaps_increment</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l01145"></a>01145 {
<a name="l01146"></a>01146     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a2081c1ed3cfcae50159143e599b5fd34">heaps_inc</a> &gt; 0) {
<a name="l01147"></a>01147         <a class="code" href="../../d8/d16/gc_8c.html#ade1a9f3d1faf57ca8ee95b45df7def26">assign_heap_slot</a>(objspace);
<a name="l01148"></a>01148         <a class="code" href="../../d8/d16/gc_8c.html#a2081c1ed3cfcae50159143e599b5fd34">heaps_inc</a>--;
<a name="l01149"></a>01149         <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01150"></a>01150     }
<a name="l01151"></a>01151     <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01152"></a>01152 }
<a name="l01153"></a>01153 
<a name="l01154"></a>01154 <span class="keywordtype">int</span>
<a name="l01155"></a><a class="code" href="../../db/d2e/intern_8h.html#a481b1446700e95e49f9531c653543c85">01155</a> <a class="code" href="../../d8/d16/gc_8c.html#a481b1446700e95e49f9531c653543c85">rb_during_gc</a>(<span class="keywordtype">void</span>)
<a name="l01156"></a>01156 {
<a name="l01157"></a>01157     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l01158"></a>01158     <span class="keywordflow">return</span> <a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a>;
<a name="l01159"></a>01159 }
<a name="l01160"></a>01160 
<a name="l01161"></a><a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">01161</a> <span class="preprocessor">#define RANY(o) ((RVALUE*)(o))</span>
<a name="l01162"></a>01162 <span class="preprocessor"></span>
<a name="l01163"></a>01163 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01164"></a><a class="code" href="../../de/de6/ruby_2ruby_8h.html#a277505e3004532460640c6d83112d689">01164</a> <a class="code" href="../../d8/d16/gc_8c.html#a277505e3004532460640c6d83112d689">rb_newobj</a>(<span class="keywordtype">void</span>)
<a name="l01165"></a>01165 {
<a name="l01166"></a>01166     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l01167"></a>01167     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj;
<a name="l01168"></a>01168 
<a name="l01169"></a>01169     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#ab10d0a221f4d7a706701b806c8135fd7">UNLIKELY</a>(<a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a>)) {
<a name="l01170"></a>01170         <a class="code" href="../../d8/d16/gc_8c.html#af3db9015bc1d568dfbb6f98ff169ef97">dont_gc</a> = 1;
<a name="l01171"></a>01171         <a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a> = 0;
<a name="l01172"></a>01172         <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;object allocation during garbage collection phase&quot;</span>);
<a name="l01173"></a>01173     }
<a name="l01174"></a>01174 
<a name="l01175"></a>01175     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#ab10d0a221f4d7a706701b806c8135fd7">UNLIKELY</a>(<a class="code" href="../../d8/d16/gc_8c.html#aba00d537a97326bf91eeb0e17fc2204e">ruby_gc_stress</a> &amp;&amp; !ruby_disable_gc_stress)) {
<a name="l01176"></a>01176         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d16/gc_8c.html#ae40ead8ed1ce1ae638710978a3fc8ff3">garbage_collect</a>(objspace)) {
<a name="l01177"></a>01177             <a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a> = 0;
<a name="l01178"></a>01178             <a class="code" href="../../d8/d16/gc_8c.html#a14b9fe6e6bba3f2279b95af407c546f8">rb_memerror</a>();
<a name="l01179"></a>01179         }
<a name="l01180"></a>01180     }
<a name="l01181"></a>01181 
<a name="l01182"></a>01182     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#ab10d0a221f4d7a706701b806c8135fd7">UNLIKELY</a>(!<a class="code" href="../../d8/d16/gc_8c.html#a896e77038c659ca416b686f1e7a93eb8">freelist</a>)) {
<a name="l01183"></a>01183         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d16/gc_8c.html#a8a4293c49811c85d724070323c80c7b7">gc_lazy_sweep</a>(objspace)) {
<a name="l01184"></a>01184             <a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a> = 0;
<a name="l01185"></a>01185             <a class="code" href="../../d8/d16/gc_8c.html#a14b9fe6e6bba3f2279b95af407c546f8">rb_memerror</a>();
<a name="l01186"></a>01186         }
<a name="l01187"></a>01187     }
<a name="l01188"></a>01188 
<a name="l01189"></a>01189     obj = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)<a class="code" href="../../d8/d16/gc_8c.html#a896e77038c659ca416b686f1e7a93eb8">freelist</a>;
<a name="l01190"></a>01190     <a class="code" href="../../d8/d16/gc_8c.html#a896e77038c659ca416b686f1e7a93eb8">freelist</a> = <a class="code" href="../../d8/d16/gc_8c.html#a896e77038c659ca416b686f1e7a93eb8">freelist</a>-&gt;as.free.next;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a56d620b94b668ed7665d1616b2c54e48">MEMZERO</a>((<span class="keywordtype">void</span>*)obj, <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a>, 1);
<a name="l01193"></a>01193 <span class="preprocessor">#ifdef GC_DEBUG</span>
<a name="l01194"></a>01194 <span class="preprocessor"></span>    <a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;file = <a class="code" href="../../d5/d9d/tcltklib_8c.html#aaa4f8c9b566fd7fb6873866c423c2016">rb_sourcefile</a>();
<a name="l01195"></a>01195     <a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;line = <a class="code" href="../../db/d2e/intern_8h.html#af5f87f9d39ea7433dc0de2f655bd6359">rb_sourceline</a>();
<a name="l01196"></a>01196 <span class="preprocessor">#endif</span>
<a name="l01197"></a>01197 <span class="preprocessor"></span>    <a class="code" href="../../d8/d16/gc_8c.html#a7ffed23fc49f552c28709b0f3e00f5ed">GC_PROF_INC_LIVE_NUM</a>;
<a name="l01198"></a>01198 
<a name="l01199"></a>01199     <span class="keywordflow">return</span> obj;
<a name="l01200"></a>01200 }
<a name="l01201"></a>01201 
<a name="l01202"></a>01202 NODE*
<a name="l01203"></a><a class="code" href="../../d8/d16/gc_8c.html#a49993c063c23478f45c8cf8b0016cce2">01203</a> <a class="code" href="../../d5/d11/ripper_8c.html#aa6e8d7f44de147b7e48991c2e9f3f3d4">rb_node_newnode</a>(<span class="keyword">enum</span> <a class="code" href="../../d1/d72/debug_8c.html#a3dae8bc7c708705be3a6e1688378868e">node_type</a> <a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> a0, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> a1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> a2)
<a name="l01204"></a>01204 {
<a name="l01205"></a>01205     NODE *n = (NODE*)<a class="code" href="../../d8/d16/gc_8c.html#a277505e3004532460640c6d83112d689">rb_newobj</a>();
<a name="l01206"></a>01206 
<a name="l01207"></a>01207     n-&gt;flags |= <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5f1cc49c4da51d5bdffa64be79ff6fb0">T_NODE</a>;
<a name="l01208"></a>01208     <a class="code" href="../../d3/d09/ripper_8y.html#a2d1f690881009147e0af52d3bcd84ccb">nd_set_type</a>(n, type);
<a name="l01209"></a>01209 
<a name="l01210"></a>01210     n-&gt;u1.value = a0;
<a name="l01211"></a>01211     n-&gt;u2.value = a1;
<a name="l01212"></a>01212     n-&gt;u3.value = a2;
<a name="l01213"></a>01213 
<a name="l01214"></a>01214     <span class="keywordflow">return</span> n;
<a name="l01215"></a>01215 }
<a name="l01216"></a>01216 
<a name="l01217"></a>01217 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01218"></a><a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa15fef037465dd64cf53413ef6fb0bf3">01218</a> <a class="code" href="../../d8/d16/gc_8c.html#a148a9ff180de64b2525ff7c13e817867">rb_data_object_alloc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass, <span class="keywordtype">void</span> *datap, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad83646c4b210a82fc3d1a1e723ffc931">RUBY_DATA_FUNC</a> dmark, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad83646c4b210a82fc3d1a1e723ffc931">RUBY_DATA_FUNC</a> dfree)
<a name="l01219"></a>01219 {
<a name="l01220"></a>01220     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ab8e75ef1f427d9b009705ebd577bee92">NEWOBJ</a>(data, <span class="keyword">struct</span> <a class="code" href="../../d0/dcf/struct_r_data.html">RData</a>);
<a name="l01221"></a>01221     <span class="keywordflow">if</span> (klass) <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad5a1e03b0a66824f95f6aaf07b4a4052">Check_Type</a>(klass, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad04c63d175774c6d6e7dfaf0f0a982c9">T_CLASS</a>);
<a name="l01222"></a>01222     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a607a9da5249e026d1c4a0826dc840143">OBJSETUP</a>(data, klass, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a55f295817faf14e42b3cff745a7ac706">T_DATA</a>);
<a name="l01223"></a>01223     data-&gt;data = datap;
<a name="l01224"></a>01224     data-&gt;dfree = dfree;
<a name="l01225"></a>01225     data-&gt;dmark = dmark;
<a name="l01226"></a>01226 
<a name="l01227"></a>01227     <span class="keywordflow">return</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)data;
<a name="l01228"></a>01228 }
<a name="l01229"></a>01229 
<a name="l01230"></a>01230 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01231"></a><a class="code" href="../../de/de6/ruby_2ruby_8h.html#abeee962265b678b3b6cc61ca01fe5b52">01231</a> <a class="code" href="../../d8/d16/gc_8c.html#a34aac3e76b04b2077cb3c9257b966ba3">rb_data_typed_object_alloc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass, <span class="keywordtype">void</span> *datap, <span class="keyword">const</span> <a class="code" href="../../d7/de2/structrb__data__type__struct.html">rb_data_type_t</a> *<a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>)
<a name="l01232"></a>01232 {
<a name="l01233"></a>01233     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ab8e75ef1f427d9b009705ebd577bee92">NEWOBJ</a>(data, <span class="keyword">struct</span> <a class="code" href="../../d6/d45/struct_r_typed_data.html">RTypedData</a>);
<a name="l01234"></a>01234 
<a name="l01235"></a>01235     <span class="keywordflow">if</span> (klass) <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad5a1e03b0a66824f95f6aaf07b4a4052">Check_Type</a>(klass, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad04c63d175774c6d6e7dfaf0f0a982c9">T_CLASS</a>);
<a name="l01236"></a>01236 
<a name="l01237"></a>01237     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a607a9da5249e026d1c4a0826dc840143">OBJSETUP</a>(data, klass, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a55f295817faf14e42b3cff745a7ac706">T_DATA</a>);
<a name="l01238"></a>01238 
<a name="l01239"></a>01239     data-&gt;data = datap;
<a name="l01240"></a>01240     data-&gt;typed_flag = 1;
<a name="l01241"></a>01241     data-&gt;type = type;
<a name="l01242"></a>01242 
<a name="l01243"></a>01243     <span class="keywordflow">return</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)data;
<a name="l01244"></a>01244 }
<a name="l01245"></a>01245 
<a name="l01246"></a>01246 <span class="keywordtype">size_t</span>
<a name="l01247"></a><a class="code" href="../../d0/daa/gc_8h.html#a2808ab60a7e7a458c3d440d3e4d34120">01247</a> <a class="code" href="../../d3/d4e/objspace_8c.html#a2808ab60a7e7a458c3d440d3e4d34120">rb_objspace_data_type_memsize</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj)
<a name="l01248"></a>01248 {
<a name="l01249"></a>01249     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac167240ec598e32f5ff3cdb902fb98b9">RTYPEDDATA_P</a>(obj) &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa7423675bf99068c658e91a4ba55016c">RTYPEDDATA_TYPE</a>(obj)-&gt;function.dsize) {
<a name="l01250"></a>01250         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa7423675bf99068c658e91a4ba55016c">RTYPEDDATA_TYPE</a>(obj)-&gt;function.dsize(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4477d4967d61de5b76a2d9da1f3ce6a9">RTYPEDDATA_DATA</a>(obj));
<a name="l01251"></a>01251     }
<a name="l01252"></a>01252     <span class="keywordflow">else</span> {
<a name="l01253"></a>01253         <span class="keywordflow">return</span> 0;
<a name="l01254"></a>01254     }
<a name="l01255"></a>01255 }
<a name="l01256"></a>01256 
<a name="l01257"></a>01257 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l01258"></a><a class="code" href="../../d8/d16/gc_8c.html#acc22a6c614d2f714a6716085ca9f63e7">01258</a> <a class="code" href="../../d8/d16/gc_8c.html#acc22a6c614d2f714a6716085ca9f63e7">rb_objspace_data_type_name</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj)
<a name="l01259"></a>01259 {
<a name="l01260"></a>01260     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac167240ec598e32f5ff3cdb902fb98b9">RTYPEDDATA_P</a>(obj)) {
<a name="l01261"></a>01261         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa7423675bf99068c658e91a4ba55016c">RTYPEDDATA_TYPE</a>(obj)-&gt;wrap_struct_name;
<a name="l01262"></a>01262     }
<a name="l01263"></a>01263     <span class="keywordflow">else</span> {
<a name="l01264"></a>01264         <span class="keywordflow">return</span> 0;
<a name="l01265"></a>01265     }
<a name="l01266"></a>01266 }
<a name="l01267"></a>01267 
<a name="l01268"></a>01268 <span class="preprocessor">#ifdef __ia64</span>
<a name="l01269"></a>01269 <span class="preprocessor"></span><span class="preprocessor">#define SET_STACK_END (SET_MACHINE_STACK_END(&amp;th-&gt;machine_stack_end), th-&gt;machine_register_stack_end = rb_ia64_bsp())</span>
<a name="l01270"></a>01270 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l01271"></a><a class="code" href="../../d8/d16/gc_8c.html#a6c696630f91fd869561b931817456b5f">01271</a> <span class="preprocessor"></span><span class="preprocessor">#define SET_STACK_END SET_MACHINE_STACK_END(&amp;th-&gt;machine_stack_end)</span>
<a name="l01272"></a>01272 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01273"></a>01273 <span class="preprocessor"></span>
<a name="l01274"></a><a class="code" href="../../d8/d16/gc_8c.html#a1763c9556bd80b7806528729edc98a05">01274</a> <span class="preprocessor">#define STACK_START (th-&gt;machine_stack_start)</span>
<a name="l01275"></a><a class="code" href="../../d8/d16/gc_8c.html#a0ca05222298465ac22f8f4606f7cb49d">01275</a> <span class="preprocessor"></span><span class="preprocessor">#define STACK_END (th-&gt;machine_stack_end)</span>
<a name="l01276"></a><a class="code" href="../../d8/d16/gc_8c.html#af1f8ac0055ec2703f59a33408cc4f39e">01276</a> <span class="preprocessor"></span><span class="preprocessor">#define STACK_LEVEL_MAX (th-&gt;machine_stack_maxsize/sizeof(VALUE))</span>
<a name="l01277"></a>01277 <span class="preprocessor"></span>
<a name="l01278"></a>01278 <span class="preprocessor">#if STACK_GROW_DIRECTION &lt; 0</span>
<a name="l01279"></a>01279 <span class="preprocessor"></span><span class="preprocessor"># define STACK_LENGTH  (size_t)(STACK_START - STACK_END)</span>
<a name="l01280"></a>01280 <span class="preprocessor"></span><span class="preprocessor">#elif STACK_GROW_DIRECTION &gt; 0</span>
<a name="l01281"></a>01281 <span class="preprocessor"></span><span class="preprocessor"># define STACK_LENGTH  (size_t)(STACK_END - STACK_START + 1)</span>
<a name="l01282"></a>01282 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l01283"></a><a class="code" href="../../d8/d16/gc_8c.html#a70688b1c3ab0aab15ede3968ef6ae9b0">01283</a> <span class="preprocessor"></span><span class="preprocessor"># define STACK_LENGTH  ((STACK_END &lt; STACK_START) ? (size_t)(STACK_START - STACK_END) \</span>
<a name="l01284"></a>01284 <span class="preprocessor">                        : (size_t)(STACK_END - STACK_START + 1))</span>
<a name="l01285"></a>01285 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01286"></a>01286 <span class="preprocessor"></span><span class="preprocessor">#if !STACK_GROW_DIRECTION</span>
<a name="l01287"></a><a class="code" href="../../d8/d16/gc_8c.html#ab5c13b72c3ff4d1b33c56fcc5d8c2323">01287</a> <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="../../d8/d16/gc_8c.html#ab5c13b72c3ff4d1b33c56fcc5d8c2323">ruby_stack_grow_direction</a>;
<a name="l01288"></a>01288 <span class="keywordtype">int</span>
<a name="l01289"></a><a class="code" href="../../d0/daa/gc_8h.html#a903b838cf82db7d3c29b95f0edb5bb04">01289</a> <a class="code" href="../../d8/d16/gc_8c.html#a903b838cf82db7d3c29b95f0edb5bb04">ruby_get_stack_grow_direction</a>(<span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *addr)
<a name="l01290"></a>01290 {
<a name="l01291"></a>01291     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *end;
<a name="l01292"></a>01292     <a class="code" href="../../d0/daa/gc_8h.html#a8f3496982ec2b045c65f0681d3f83863">SET_MACHINE_STACK_END</a>(&amp;end);
<a name="l01293"></a>01293 
<a name="l01294"></a>01294     <span class="keywordflow">if</span> (end &gt; addr) <span class="keywordflow">return</span> ruby_stack_grow_direction = 1;
<a name="l01295"></a>01295     <span class="keywordflow">return</span> ruby_stack_grow_direction = -1;
<a name="l01296"></a>01296 }
<a name="l01297"></a>01297 <span class="preprocessor">#endif</span>
<a name="l01298"></a>01298 <span class="preprocessor"></span>
<a name="l01299"></a><a class="code" href="../../d8/d16/gc_8c.html#a6a4c68f1112d5c4aa0ffaa6568a4d9ea">01299</a> <span class="preprocessor">#define GC_LEVEL_MAX 250</span>
<a name="l01300"></a><a class="code" href="../../d8/d16/gc_8c.html#a7ff51d9dd142f87667e4500fa4e3cd88">01300</a> <span class="preprocessor"></span><span class="preprocessor">#define STACKFRAME_FOR_GC_MARK (GC_LEVEL_MAX * GC_MARK_STACKFRAME_WORD)</span>
<a name="l01301"></a>01301 <span class="preprocessor"></span>
<a name="l01302"></a>01302 <span class="keywordtype">size_t</span>
<a name="l01303"></a><a class="code" href="../../db/d2e/intern_8h.html#af73c2b3991b1f89c5b3241e2b7e4ed48">01303</a> <a class="code" href="../../d8/d16/gc_8c.html#a472cd8893c0b7fcebc3111f097d32c03">ruby_stack_length</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> **p)
<a name="l01304"></a>01304 {
<a name="l01305"></a>01305     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l01306"></a>01306     <a class="code" href="../../d8/d16/gc_8c.html#a6c696630f91fd869561b931817456b5f">SET_STACK_END</a>;
<a name="l01307"></a>01307     <span class="keywordflow">if</span> (p) *p = <a class="code" href="../../d0/daa/gc_8h.html#ad79961092b2737e9102a9bcf9ca2dbed">STACK_UPPER</a>(<a class="code" href="../../d8/d16/gc_8c.html#a0ca05222298465ac22f8f4606f7cb49d">STACK_END</a>, <a class="code" href="../../d8/d16/gc_8c.html#a1763c9556bd80b7806528729edc98a05">STACK_START</a>, <a class="code" href="../../d8/d16/gc_8c.html#a0ca05222298465ac22f8f4606f7cb49d">STACK_END</a>);
<a name="l01308"></a>01308     <span class="keywordflow">return</span> <a class="code" href="../../d8/d16/gc_8c.html#a70688b1c3ab0aab15ede3968ef6ae9b0">STACK_LENGTH</a>;
<a name="l01309"></a>01309 }
<a name="l01310"></a>01310 
<a name="l01311"></a>01311 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01312"></a><a class="code" href="../../d8/d16/gc_8c.html#a09688a4aa4e47b16c17f851e6f651b81">01312</a> <a class="code" href="../../d8/d16/gc_8c.html#a09688a4aa4e47b16c17f851e6f651b81">stack_check</a>(<span class="keywordtype">int</span> water_mark)
<a name="l01313"></a>01313 {
<a name="l01314"></a>01314     <span class="keywordtype">int</span> ret;
<a name="l01315"></a>01315     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l01316"></a>01316     <a class="code" href="../../d8/d16/gc_8c.html#a6c696630f91fd869561b931817456b5f">SET_STACK_END</a>;
<a name="l01317"></a>01317     ret = <a class="code" href="../../d8/d16/gc_8c.html#a70688b1c3ab0aab15ede3968ef6ae9b0">STACK_LENGTH</a> &gt; <a class="code" href="../../d8/d16/gc_8c.html#af1f8ac0055ec2703f59a33408cc4f39e">STACK_LEVEL_MAX</a> - water_mark;
<a name="l01318"></a>01318 <span class="preprocessor">#ifdef __ia64</span>
<a name="l01319"></a>01319 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!ret) {
<a name="l01320"></a>01320         ret = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>*)rb_ia64_bsp() - th-&gt;machine_register_stack_start &gt;
<a name="l01321"></a>01321               th-&gt;machine_register_stack_maxsize/<span class="keyword">sizeof</span>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>) - water_mark;
<a name="l01322"></a>01322     }
<a name="l01323"></a>01323 <span class="preprocessor">#endif</span>
<a name="l01324"></a>01324 <span class="preprocessor"></span>    <span class="keywordflow">return</span> ret;
<a name="l01325"></a>01325 }
<a name="l01326"></a>01326 
<a name="l01327"></a><a class="code" href="../../d8/d16/gc_8c.html#a782bb9a88751880ef0f40c650722abfc">01327</a> <span class="preprocessor">#define STACKFRAME_FOR_CALL_CFUNC 512</span>
<a name="l01328"></a>01328 <span class="preprocessor"></span>
<a name="l01329"></a>01329 <span class="keywordtype">int</span>
<a name="l01330"></a><a class="code" href="../../db/d2e/intern_8h.html#a9be1c274a7c6746223f95464b3fe7c45">01330</a> <a class="code" href="../../d8/d16/gc_8c.html#a9be1c274a7c6746223f95464b3fe7c45">ruby_stack_check</a>(<span class="keywordtype">void</span>)
<a name="l01331"></a>01331 {
<a name="l01332"></a>01332 <span class="preprocessor">#if defined(POSIX_SIGNAL) &amp;&amp; defined(SIGSEGV) &amp;&amp; defined(HAVE_SIGALTSTACK)</span>
<a name="l01333"></a>01333 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 0;
<a name="l01334"></a>01334 <span class="preprocessor">#else</span>
<a name="l01335"></a>01335 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../d8/d16/gc_8c.html#a09688a4aa4e47b16c17f851e6f651b81">stack_check</a>(<a class="code" href="../../d8/d16/gc_8c.html#a782bb9a88751880ef0f40c650722abfc">STACKFRAME_FOR_CALL_CFUNC</a>);
<a name="l01336"></a>01336 <span class="preprocessor">#endif</span>
<a name="l01337"></a>01337 <span class="preprocessor"></span>}
<a name="l01338"></a>01338 
<a name="l01339"></a>01339 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01340"></a><a class="code" href="../../d8/d16/gc_8c.html#a283d577269028c9ba06479ebbbc65c29">01340</a> <a class="code" href="../../d8/d16/gc_8c.html#a283d577269028c9ba06479ebbbc65c29">init_mark_stack</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l01341"></a>01341 {
<a name="l01342"></a>01342     <a class="code" href="../../d8/d16/gc_8c.html#aef4fe92f4edf54293f8676f2c34c0139">mark_stack_overflow</a> = 0;
<a name="l01343"></a>01343     <a class="code" href="../../d8/d16/gc_8c.html#a18c8c3930b6076e2dbd77931a8ffb2fa">mark_stack_ptr</a> = <a class="code" href="../../d8/d16/gc_8c.html#a2b33539aa8ca6caef37f852a8df9993a">mark_stack</a>;
<a name="l01344"></a>01344 }
<a name="l01345"></a>01345 
<a name="l01346"></a><a class="code" href="../../d8/d16/gc_8c.html#ad89ec7f8fce04e225ec4f872ad9c524a">01346</a> <span class="preprocessor">#define MARK_STACK_EMPTY (mark_stack_ptr == mark_stack)</span>
<a name="l01347"></a>01347 <span class="preprocessor"></span>
<a name="l01348"></a>01348 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ptr, <span class="keywordtype">int</span> lev);
<a name="l01349"></a>01349 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d16/gc_8c.html#a8df4c0d3a28655b6652fd5e15cd31e55">gc_mark_children</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ptr, <span class="keywordtype">int</span> lev);
<a name="l01350"></a>01350 
<a name="l01351"></a>01351 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01352"></a><a class="code" href="../../d8/d16/gc_8c.html#abe497043b3fbcd6a2d72a48a4926b2aa">01352</a> <a class="code" href="../../d8/d16/gc_8c.html#abe497043b3fbcd6a2d72a48a4926b2aa">gc_mark_all</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l01353"></a>01353 {
<a name="l01354"></a>01354     <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *p, *pend;
<a name="l01355"></a>01355     <span class="keywordtype">size_t</span> i;
<a name="l01356"></a>01356 
<a name="l01357"></a>01357     <a class="code" href="../../d8/d16/gc_8c.html#a283d577269028c9ba06479ebbbc65c29">init_mark_stack</a>(objspace);
<a name="l01358"></a>01358     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a>; i++) {
<a name="l01359"></a>01359         p = objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#ad33de4cd59e7ea8cba62c94e024d6829">start</a>; pend = objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a4344f152198021b7a489fbcfbe187f44">end</a>;
<a name="l01360"></a>01360         <span class="keywordflow">while</span> (p &lt; pend) {
<a name="l01361"></a>01361             <span class="keywordflow">if</span> ((p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a> &amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a39ebc82a159cc4776f6ca7037cbd2e26">FL_MARK</a>) &amp;&amp;
<a name="l01362"></a>01362                 (p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a> != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a39ebc82a159cc4776f6ca7037cbd2e26">FL_MARK</a>)) {
<a name="l01363"></a>01363                 <a class="code" href="../../d8/d16/gc_8c.html#a8df4c0d3a28655b6652fd5e15cd31e55">gc_mark_children</a>(objspace, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)p, 0);
<a name="l01364"></a>01364             }
<a name="l01365"></a>01365             p++;
<a name="l01366"></a>01366         }
<a name="l01367"></a>01367     }
<a name="l01368"></a>01368 }
<a name="l01369"></a>01369 
<a name="l01370"></a>01370 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01371"></a><a class="code" href="../../d8/d16/gc_8c.html#a751d57c89cc3a17769525bc7e3c71550">01371</a> <a class="code" href="../../d8/d16/gc_8c.html#a751d57c89cc3a17769525bc7e3c71550">gc_mark_rest</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l01372"></a>01372 {
<a name="l01373"></a>01373     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> tmp_arry[<a class="code" href="../../d8/d16/gc_8c.html#a1673f550d1f0e94fec118e6b0a1f2bd3">MARK_STACK_MAX</a>];
<a name="l01374"></a>01374     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *p;
<a name="l01375"></a>01375 
<a name="l01376"></a>01376     p = (<a class="code" href="../../d8/d16/gc_8c.html#a18c8c3930b6076e2dbd77931a8ffb2fa">mark_stack_ptr</a> - <a class="code" href="../../d8/d16/gc_8c.html#a2b33539aa8ca6caef37f852a8df9993a">mark_stack</a>) + tmp_arry;
<a name="l01377"></a>01377     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a04ab67335215e8362c63ed27ae2d1c40">MEMCPY</a>(tmp_arry, <a class="code" href="../../d8/d16/gc_8c.html#a2b33539aa8ca6caef37f852a8df9993a">mark_stack</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>, p - tmp_arry);
<a name="l01378"></a>01378 
<a name="l01379"></a>01379     <a class="code" href="../../d8/d16/gc_8c.html#a283d577269028c9ba06479ebbbc65c29">init_mark_stack</a>(objspace);
<a name="l01380"></a>01380     <span class="keywordflow">while</span> (p != tmp_arry) {
<a name="l01381"></a>01381         p--;
<a name="l01382"></a>01382         <a class="code" href="../../d8/d16/gc_8c.html#a8df4c0d3a28655b6652fd5e15cd31e55">gc_mark_children</a>(objspace, *p, 0);
<a name="l01383"></a>01383     }
<a name="l01384"></a>01384 }
<a name="l01385"></a>01385 
<a name="l01386"></a>01386 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l01387"></a><a class="code" href="../../d8/d16/gc_8c.html#a7cbe2fa2f2f134649873d6cc1bac0238">01387</a> <a class="code" href="../../d8/d16/gc_8c.html#a7cbe2fa2f2f134649873d6cc1bac0238">is_pointer_to_heap</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <span class="keywordtype">void</span> *ptr)
<a name="l01388"></a>01388 {
<a name="l01389"></a>01389     <span class="keyword">register</span> <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *p = <a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(ptr);
<a name="l01390"></a>01390     <span class="keyword">register</span> <span class="keyword">struct </span><a class="code" href="../../d8/d95/structsorted__heaps__slot.html">sorted_heaps_slot</a> *heap;
<a name="l01391"></a>01391     <span class="keyword">register</span> <span class="keywordtype">size_t</span> <a class="code" href="../../dd/d2d/siphash_8c.html#a073817140685ccd37103f69352762610">hi</a>, <a class="code" href="../../dd/d2d/siphash_8c.html#a06c5f8eeca62bb9b7d4c85d43c4f20d9">lo</a>, mid;
<a name="l01392"></a>01392 
<a name="l01393"></a>01393     <span class="keywordflow">if</span> (p &lt; lomem || p &gt; <a class="code" href="../../d8/d16/gc_8c.html#a5072e77cd94db97413518f9513840112">himem</a>) <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01394"></a>01394     <span class="keywordflow">if</span> ((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)p % <span class="keyword">sizeof</span>(<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a>) != 0) <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01395"></a>01395 
<a name="l01396"></a>01396     <span class="comment">/* check if p looks like a pointer using bsearch*/</span>
<a name="l01397"></a>01397     lo = 0;
<a name="l01398"></a>01398     hi = <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a>;
<a name="l01399"></a>01399     <span class="keywordflow">while</span> (lo &lt; hi) {
<a name="l01400"></a>01400         mid = (lo + hi) / 2;
<a name="l01401"></a>01401         heap = &amp;objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[mid];
<a name="l01402"></a>01402         <span class="keywordflow">if</span> (heap-&gt;<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#ad33de4cd59e7ea8cba62c94e024d6829">start</a> &lt;= p) {
<a name="l01403"></a>01403             <span class="keywordflow">if</span> (p &lt; heap-&gt;<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a4344f152198021b7a489fbcfbe187f44">end</a>)
<a name="l01404"></a>01404                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01405"></a>01405             lo = mid + 1;
<a name="l01406"></a>01406         }
<a name="l01407"></a>01407         <span class="keywordflow">else</span> {
<a name="l01408"></a>01408             hi = mid;
<a name="l01409"></a>01409         }
<a name="l01410"></a>01410     }
<a name="l01411"></a>01411     <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01412"></a>01412 }
<a name="l01413"></a>01413 
<a name="l01414"></a>01414 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01415"></a><a class="code" href="../../d8/d16/gc_8c.html#af89d492005300beea54a436d1470b652">01415</a> <a class="code" href="../../d8/d16/gc_8c.html#af89d492005300beea54a436d1470b652">mark_locations_array</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <span class="keyword">register</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *x, <span class="keyword">register</span> <span class="keywordtype">long</span> n)
<a name="l01416"></a>01416 {
<a name="l01417"></a>01417     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v;
<a name="l01418"></a>01418     <span class="keywordflow">while</span> (n--) {
<a name="l01419"></a>01419         v = *x;
<a name="l01420"></a>01420         <a class="code" href="../../db/d74/zlib_8c.html#a17eefcd003c6b1e9429ccbd40496e594">VALGRIND_MAKE_MEM_DEFINED</a>(&amp;v, <span class="keyword">sizeof</span>(v));
<a name="l01421"></a>01421         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a7cbe2fa2f2f134649873d6cc1bac0238">is_pointer_to_heap</a>(objspace, (<span class="keywordtype">void</span> *)v)) {
<a name="l01422"></a>01422             <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, v, 0);
<a name="l01423"></a>01423         }
<a name="l01424"></a>01424         x++;
<a name="l01425"></a>01425     }
<a name="l01426"></a>01426 }
<a name="l01427"></a>01427 
<a name="l01428"></a>01428 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01429"></a><a class="code" href="../../d8/d16/gc_8c.html#a62989acc52da8079512776aa17622cfd">01429</a> <a class="code" href="../../d8/d16/gc_8c.html#a62989acc52da8079512776aa17622cfd">gc_mark_locations</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#ad33de4cd59e7ea8cba62c94e024d6829">start</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a4344f152198021b7a489fbcfbe187f44">end</a>)
<a name="l01430"></a>01430 {
<a name="l01431"></a>01431     <span class="keywordtype">long</span> n;
<a name="l01432"></a>01432 
<a name="l01433"></a>01433     <span class="keywordflow">if</span> (end &lt;= start) <span class="keywordflow">return</span>;
<a name="l01434"></a>01434     n = end - start;
<a name="l01435"></a>01435     <a class="code" href="../../d8/d16/gc_8c.html#af89d492005300beea54a436d1470b652">mark_locations_array</a>(objspace, start, n);
<a name="l01436"></a>01436 }
<a name="l01437"></a>01437 
<a name="l01438"></a>01438 <span class="keywordtype">void</span>
<a name="l01439"></a><a class="code" href="../../db/d2e/intern_8h.html#a1c360746431a2e3ebf9b5128f8775611">01439</a> <a class="code" href="../../d8/d16/gc_8c.html#a90e176b7e9d24053977f64a611c1d8bb">rb_gc_mark_locations</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#ad33de4cd59e7ea8cba62c94e024d6829">start</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a4344f152198021b7a489fbcfbe187f44">end</a>)
<a name="l01440"></a>01440 {
<a name="l01441"></a>01441     <a class="code" href="../../d8/d16/gc_8c.html#a62989acc52da8079512776aa17622cfd">gc_mark_locations</a>(&amp;rb_objspace, start, end);
<a name="l01442"></a>01442 }
<a name="l01443"></a>01443 
<a name="l01444"></a><a class="code" href="../../d8/d16/gc_8c.html#a90e176b7e9d24053977f64a611c1d8bb">01444</a> <span class="preprocessor">#define rb_gc_mark_locations(start, end) gc_mark_locations(objspace, (start), (end))</span>
<a name="l01445"></a>01445 <span class="preprocessor"></span>
<a name="l01446"></a><a class="code" href="../../d8/d73/structmark__tbl__arg.html">01446</a> <span class="keyword">struct </span><a class="code" href="../../d8/d73/structmark__tbl__arg.html">mark_tbl_arg</a> {
<a name="l01447"></a><a class="code" href="../../d8/d73/structmark__tbl__arg.html#ad48457aff3adfec89fa5423dac9bc2b0">01447</a>     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace;
<a name="l01448"></a><a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">01448</a>     <span class="keywordtype">int</span> <a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a>;
<a name="l01449"></a>01449 };
<a name="l01450"></a>01450 
<a name="l01451"></a>01451 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01452"></a><a class="code" href="../../d8/d16/gc_8c.html#adacd26cf5bef0f01a4ccff3585a0f1c0">01452</a> <a class="code" href="../../d8/d16/gc_8c.html#adacd26cf5bef0f01a4ccff3585a0f1c0">mark_entry</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> value, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> data)
<a name="l01453"></a>01453 {
<a name="l01454"></a>01454     <span class="keyword">struct </span><a class="code" href="../../d8/d73/structmark__tbl__arg.html">mark_tbl_arg</a> *arg = (<span class="keywordtype">void</span>*)data;
<a name="l01455"></a>01455     <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(arg-&gt;<a class="code" href="../../d8/d73/structmark__tbl__arg.html#ad48457aff3adfec89fa5423dac9bc2b0">objspace</a>, value, arg-&gt;<a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a>);
<a name="l01456"></a>01456     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>;
<a name="l01457"></a>01457 }
<a name="l01458"></a>01458 
<a name="l01459"></a>01459 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01460"></a><a class="code" href="../../d8/d16/gc_8c.html#a113604568481126fb9e62cec5ae99257">01460</a> <a class="code" href="../../d8/d16/gc_8c.html#a113604568481126fb9e62cec5ae99257">mark_tbl</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *tbl, <span class="keywordtype">int</span> <a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a>)
<a name="l01461"></a>01461 {
<a name="l01462"></a>01462     <span class="keyword">struct </span><a class="code" href="../../d8/d73/structmark__tbl__arg.html">mark_tbl_arg</a> arg;
<a name="l01463"></a>01463     <span class="keywordflow">if</span> (!tbl || tbl-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a> == 0) <span class="keywordflow">return</span>;
<a name="l01464"></a>01464     arg.<a class="code" href="../../d8/d73/structmark__tbl__arg.html#ad48457aff3adfec89fa5423dac9bc2b0">objspace</a> = objspace;
<a name="l01465"></a>01465     arg.<a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a> = lev;
<a name="l01466"></a>01466     <a class="code" href="../../dd/d24/st_8h.html#ace5a79870d2800659a653fceeca55262">st_foreach</a>(tbl, <a class="code" href="../../d8/d16/gc_8c.html#adacd26cf5bef0f01a4ccff3585a0f1c0">mark_entry</a>, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)&amp;arg);
<a name="l01467"></a>01467 }
<a name="l01468"></a>01468 
<a name="l01469"></a>01469 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01470"></a><a class="code" href="../../d8/d16/gc_8c.html#a731af26dcf3989b9ac43ce6f16c26029">01470</a> <a class="code" href="../../d8/d16/gc_8c.html#a731af26dcf3989b9ac43ce6f16c26029">mark_key</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> value, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> data)
<a name="l01471"></a>01471 {
<a name="l01472"></a>01472     <span class="keyword">struct </span><a class="code" href="../../d8/d73/structmark__tbl__arg.html">mark_tbl_arg</a> *arg = (<span class="keywordtype">void</span>*)data;
<a name="l01473"></a>01473     <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(arg-&gt;<a class="code" href="../../d8/d73/structmark__tbl__arg.html#ad48457aff3adfec89fa5423dac9bc2b0">objspace</a>, key, arg-&gt;<a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a>);
<a name="l01474"></a>01474     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>;
<a name="l01475"></a>01475 }
<a name="l01476"></a>01476 
<a name="l01477"></a>01477 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01478"></a><a class="code" href="../../d8/d16/gc_8c.html#ac1cd67cceb2116bb7fa1dfccecc9b0d0">01478</a> <a class="code" href="../../d8/d16/gc_8c.html#ac1cd67cceb2116bb7fa1dfccecc9b0d0">mark_set</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *tbl, <span class="keywordtype">int</span> <a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a>)
<a name="l01479"></a>01479 {
<a name="l01480"></a>01480     <span class="keyword">struct </span><a class="code" href="../../d8/d73/structmark__tbl__arg.html">mark_tbl_arg</a> arg;
<a name="l01481"></a>01481     <span class="keywordflow">if</span> (!tbl) <span class="keywordflow">return</span>;
<a name="l01482"></a>01482     arg.<a class="code" href="../../d8/d73/structmark__tbl__arg.html#ad48457aff3adfec89fa5423dac9bc2b0">objspace</a> = objspace;
<a name="l01483"></a>01483     arg.<a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a> = lev;
<a name="l01484"></a>01484     <a class="code" href="../../dd/d24/st_8h.html#ace5a79870d2800659a653fceeca55262">st_foreach</a>(tbl, <a class="code" href="../../d8/d16/gc_8c.html#a731af26dcf3989b9ac43ce6f16c26029">mark_key</a>, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)&amp;arg);
<a name="l01485"></a>01485 }
<a name="l01486"></a>01486 
<a name="l01487"></a>01487 <span class="keywordtype">void</span>
<a name="l01488"></a><a class="code" href="../../db/d2e/intern_8h.html#adee04662027c2decd1be09fa10734e3f">01488</a> <a class="code" href="../../d8/d16/gc_8c.html#a4c89e57c529e83d16accc5f8c659cc7e">rb_mark_set</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *tbl)
<a name="l01489"></a>01489 {
<a name="l01490"></a>01490     <a class="code" href="../../d8/d16/gc_8c.html#ac1cd67cceb2116bb7fa1dfccecc9b0d0">mark_set</a>(&amp;rb_objspace, tbl, 0);
<a name="l01491"></a>01491 }
<a name="l01492"></a>01492 
<a name="l01493"></a>01493 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01494"></a><a class="code" href="../../d8/d16/gc_8c.html#a768c5b720372a006882e1e2cce084e68">01494</a> <a class="code" href="../../d8/d16/gc_8c.html#a768c5b720372a006882e1e2cce084e68">mark_keyvalue</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> value, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> data)
<a name="l01495"></a>01495 {
<a name="l01496"></a>01496     <span class="keyword">struct </span><a class="code" href="../../d8/d73/structmark__tbl__arg.html">mark_tbl_arg</a> *arg = (<span class="keywordtype">void</span>*)data;
<a name="l01497"></a>01497     <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(arg-&gt;<a class="code" href="../../d8/d73/structmark__tbl__arg.html#ad48457aff3adfec89fa5423dac9bc2b0">objspace</a>, key, arg-&gt;<a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a>);
<a name="l01498"></a>01498     <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(arg-&gt;<a class="code" href="../../d8/d73/structmark__tbl__arg.html#ad48457aff3adfec89fa5423dac9bc2b0">objspace</a>, value, arg-&gt;<a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a>);
<a name="l01499"></a>01499     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>;
<a name="l01500"></a>01500 }
<a name="l01501"></a>01501 
<a name="l01502"></a>01502 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01503"></a><a class="code" href="../../d8/d16/gc_8c.html#a738f23012e6259467a0163ec7f49c053">01503</a> <a class="code" href="../../d8/d16/gc_8c.html#a738f23012e6259467a0163ec7f49c053">mark_hash</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *tbl, <span class="keywordtype">int</span> <a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a>)
<a name="l01504"></a>01504 {
<a name="l01505"></a>01505     <span class="keyword">struct </span><a class="code" href="../../d8/d73/structmark__tbl__arg.html">mark_tbl_arg</a> arg;
<a name="l01506"></a>01506     <span class="keywordflow">if</span> (!tbl) <span class="keywordflow">return</span>;
<a name="l01507"></a>01507     arg.<a class="code" href="../../d8/d73/structmark__tbl__arg.html#ad48457aff3adfec89fa5423dac9bc2b0">objspace</a> = objspace;
<a name="l01508"></a>01508     arg.<a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a> = lev;
<a name="l01509"></a>01509     <a class="code" href="../../dd/d24/st_8h.html#ace5a79870d2800659a653fceeca55262">st_foreach</a>(tbl, <a class="code" href="../../d8/d16/gc_8c.html#a768c5b720372a006882e1e2cce084e68">mark_keyvalue</a>, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)&amp;arg);
<a name="l01510"></a>01510 }
<a name="l01511"></a>01511 
<a name="l01512"></a>01512 <span class="keywordtype">void</span>
<a name="l01513"></a><a class="code" href="../../db/d2e/intern_8h.html#ae104e742e11d542705a7b400620c928f">01513</a> <a class="code" href="../../d8/d16/gc_8c.html#a5489730b418f25891238cfea5cdaa531">rb_mark_hash</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *tbl)
<a name="l01514"></a>01514 {
<a name="l01515"></a>01515     <a class="code" href="../../d8/d16/gc_8c.html#a738f23012e6259467a0163ec7f49c053">mark_hash</a>(&amp;rb_objspace, tbl, 0);
<a name="l01516"></a>01516 }
<a name="l01517"></a>01517 
<a name="l01518"></a>01518 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01519"></a><a class="code" href="../../d8/d16/gc_8c.html#a59bbb0020beab828deedf3c37378567f">01519</a> <a class="code" href="../../d8/d16/gc_8c.html#a59bbb0020beab828deedf3c37378567f">mark_method_entry</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <span class="keyword">const</span> <a class="code" href="../../d7/db7/structrb__method__entry__struct.html">rb_method_entry_t</a> *me, <span class="keywordtype">int</span> <a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a>)
<a name="l01520"></a>01520 {
<a name="l01521"></a>01521     <span class="keyword">const</span> <a class="code" href="../../d6/dab/structrb__method__definition__struct.html">rb_method_definition_t</a> *def = me-&gt;<a class="code" href="../../d7/db7/structrb__method__entry__struct.html#a6c868c50e67b757c6324dfef0f3184dc">def</a>;
<a name="l01522"></a>01522 
<a name="l01523"></a>01523     <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, me-&gt;<a class="code" href="../../d7/db7/structrb__method__entry__struct.html#a9ce0871480ac405b00673b25234738de">klass</a>, lev);
<a name="l01524"></a>01524     <span class="keywordflow">if</span> (!def) <span class="keywordflow">return</span>;
<a name="l01525"></a>01525     <span class="keywordflow">switch</span> (def-&gt;<a class="code" href="../../d6/dab/structrb__method__definition__struct.html#a60ad63aa9037403df6e773853973c41b">type</a>) {
<a name="l01526"></a>01526       <span class="keywordflow">case</span> <a class="code" href="../../db/d0a/method_8h.html#a88a981f6cc69187ed9c2de2630a1687aa09fd70c8c3426502348b7df7c121e505">VM_METHOD_TYPE_ISEQ</a>:
<a name="l01527"></a>01527         <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, def-&gt;<a class="code" href="../../d6/dab/structrb__method__definition__struct.html#a83806aa27bac8990f4f9ce83377c76e7">body</a>.<a class="code" href="../../d6/dab/structrb__method__definition__struct.html#aadf9737964ff683c467dfc1b820b1016">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a46d5fb5c3de970a9540ab85d4b060957">self</a>, lev);
<a name="l01528"></a>01528         <span class="keywordflow">break</span>;
<a name="l01529"></a>01529       <span class="keywordflow">case</span> <a class="code" href="../../db/d0a/method_8h.html#a88a981f6cc69187ed9c2de2630a1687aa851a2c8d2c25891b7d1ce87759b31de0">VM_METHOD_TYPE_BMETHOD</a>:
<a name="l01530"></a>01530         <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, def-&gt;<a class="code" href="../../d6/dab/structrb__method__definition__struct.html#a83806aa27bac8990f4f9ce83377c76e7">body</a>.<a class="code" href="../../d6/dab/structrb__method__definition__struct.html#a75d163b2711e8ab402ba04853f72d246">proc</a>, lev);
<a name="l01531"></a>01531         <span class="keywordflow">break</span>;
<a name="l01532"></a>01532       <span class="keywordflow">case</span> <a class="code" href="../../db/d0a/method_8h.html#a88a981f6cc69187ed9c2de2630a1687aa0afa124f1dfc47ee89ab883b2591573b">VM_METHOD_TYPE_ATTRSET</a>:
<a name="l01533"></a>01533       <span class="keywordflow">case</span> <a class="code" href="../../db/d0a/method_8h.html#a88a981f6cc69187ed9c2de2630a1687aa876dfcf064e4f083567badb52e606e0e">VM_METHOD_TYPE_IVAR</a>:
<a name="l01534"></a>01534         <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, def-&gt;<a class="code" href="../../d6/dab/structrb__method__definition__struct.html#a83806aa27bac8990f4f9ce83377c76e7">body</a>.<a class="code" href="../../d6/dab/structrb__method__definition__struct.html#a8dc19a3a32e0b6fe94d3418cddb06170">attr</a>.<a class="code" href="../../d2/d79/structrb__method__attr__struct.html#a4c08c4ffa6528eef639b645a6bf864b6">location</a>, lev);
<a name="l01535"></a>01535         <span class="keywordflow">break</span>;
<a name="l01536"></a>01536       <span class="keywordflow">default</span>:
<a name="l01537"></a>01537         <span class="keywordflow">break</span>; <span class="comment">/* ignore */</span>
<a name="l01538"></a>01538     }
<a name="l01539"></a>01539 }
<a name="l01540"></a>01540 
<a name="l01541"></a>01541 <span class="keywordtype">void</span>
<a name="l01542"></a><a class="code" href="../../db/d0a/method_8h.html#aac91fd74442afdfbafcdaf2c54f92240">01542</a> <a class="code" href="../../d8/d16/gc_8c.html#aac91fd74442afdfbafcdaf2c54f92240">rb_mark_method_entry</a>(<span class="keyword">const</span> <a class="code" href="../../d7/db7/structrb__method__entry__struct.html">rb_method_entry_t</a> *me)
<a name="l01543"></a>01543 {
<a name="l01544"></a>01544     <a class="code" href="../../d8/d16/gc_8c.html#a59bbb0020beab828deedf3c37378567f">mark_method_entry</a>(&amp;rb_objspace, me, 0);
<a name="l01545"></a>01545 }
<a name="l01546"></a>01546 
<a name="l01547"></a>01547 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01548"></a><a class="code" href="../../d8/d16/gc_8c.html#aedc65b906df88d1467e4767bdfe336f7">01548</a> <a class="code" href="../../d8/d16/gc_8c.html#aedc65b906df88d1467e4767bdfe336f7">mark_method_entry_i</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <span class="keyword">const</span> <a class="code" href="../../d7/db7/structrb__method__entry__struct.html">rb_method_entry_t</a> *me, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> data)
<a name="l01549"></a>01549 {
<a name="l01550"></a>01550     <span class="keyword">struct </span><a class="code" href="../../d8/d73/structmark__tbl__arg.html">mark_tbl_arg</a> *arg = (<span class="keywordtype">void</span>*)data;
<a name="l01551"></a>01551     <a class="code" href="../../d8/d16/gc_8c.html#a59bbb0020beab828deedf3c37378567f">mark_method_entry</a>(arg-&gt;<a class="code" href="../../d8/d73/structmark__tbl__arg.html#ad48457aff3adfec89fa5423dac9bc2b0">objspace</a>, me, arg-&gt;<a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a>);
<a name="l01552"></a>01552     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>;
<a name="l01553"></a>01553 }
<a name="l01554"></a>01554 
<a name="l01555"></a>01555 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01556"></a><a class="code" href="../../d8/d16/gc_8c.html#a7f22256df2a196f68d00e4ba23f6c57d">01556</a> <a class="code" href="../../d8/d16/gc_8c.html#a7f22256df2a196f68d00e4ba23f6c57d">mark_m_tbl</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *tbl, <span class="keywordtype">int</span> <a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a>)
<a name="l01557"></a>01557 {
<a name="l01558"></a>01558     <span class="keyword">struct </span><a class="code" href="../../d8/d73/structmark__tbl__arg.html">mark_tbl_arg</a> arg;
<a name="l01559"></a>01559     <span class="keywordflow">if</span> (!tbl) <span class="keywordflow">return</span>;
<a name="l01560"></a>01560     arg.<a class="code" href="../../d8/d73/structmark__tbl__arg.html#ad48457aff3adfec89fa5423dac9bc2b0">objspace</a> = objspace;
<a name="l01561"></a>01561     arg.<a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a> = lev;
<a name="l01562"></a>01562     <a class="code" href="../../dd/d24/st_8h.html#ace5a79870d2800659a653fceeca55262">st_foreach</a>(tbl, <a class="code" href="../../d8/d16/gc_8c.html#aedc65b906df88d1467e4767bdfe336f7">mark_method_entry_i</a>, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)&amp;arg);
<a name="l01563"></a>01563 }
<a name="l01564"></a>01564 
<a name="l01565"></a>01565 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01566"></a><a class="code" href="../../d8/d16/gc_8c.html#a1d12cb141e26cc2576dfd1f4fc0496d1">01566</a> <a class="code" href="../../d8/d16/gc_8c.html#a1d12cb141e26cc2576dfd1f4fc0496d1">free_method_entry_i</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <a class="code" href="../../d7/db7/structrb__method__entry__struct.html">rb_method_entry_t</a> *me, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> data)
<a name="l01567"></a>01567 {
<a name="l01568"></a>01568     <a class="code" href="../../db/d0a/method_8h.html#a8a35ddad7e9cc63983104d205c812919">rb_free_method_entry</a>(me);
<a name="l01569"></a>01569     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>;
<a name="l01570"></a>01570 }
<a name="l01571"></a>01571 
<a name="l01572"></a>01572 <span class="keywordtype">void</span>
<a name="l01573"></a><a class="code" href="../../db/d0a/method_8h.html#ab38e8b9b35211acb88ff3f8d2070be9f">01573</a> <a class="code" href="../../d8/d16/gc_8c.html#ab38e8b9b35211acb88ff3f8d2070be9f">rb_free_m_table</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *tbl)
<a name="l01574"></a>01574 {
<a name="l01575"></a>01575     <a class="code" href="../../dd/d24/st_8h.html#ace5a79870d2800659a653fceeca55262">st_foreach</a>(tbl, <a class="code" href="../../d8/d16/gc_8c.html#a1d12cb141e26cc2576dfd1f4fc0496d1">free_method_entry_i</a>, 0);
<a name="l01576"></a>01576     <a class="code" href="../../dd/d24/st_8h.html#acb004847ef312373d65bfb0d1a21c5b3">st_free_table</a>(tbl);
<a name="l01577"></a>01577 }
<a name="l01578"></a>01578 
<a name="l01579"></a>01579 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01580"></a><a class="code" href="../../d8/d16/gc_8c.html#af5d8b5c3d6d87a2907b3ab62627901e0">01580</a> <a class="code" href="../../d8/d16/gc_8c.html#af5d8b5c3d6d87a2907b3ab62627901e0">mark_const_entry_i</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <span class="keyword">const</span> <a class="code" href="../../d1/df3/structrb__const__entry__struct.html">rb_const_entry_t</a> *ce, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> data)
<a name="l01581"></a>01581 {
<a name="l01582"></a>01582     <span class="keyword">struct </span><a class="code" href="../../d8/d73/structmark__tbl__arg.html">mark_tbl_arg</a> *arg = (<span class="keywordtype">void</span>*)data;
<a name="l01583"></a>01583     <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(arg-&gt;<a class="code" href="../../d8/d73/structmark__tbl__arg.html#ad48457aff3adfec89fa5423dac9bc2b0">objspace</a>, ce-&gt;<a class="code" href="../../d1/df3/structrb__const__entry__struct.html#a6c6625cf3ef6330d1714d19fa2aa5f4a">value</a>, arg-&gt;<a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a>);
<a name="l01584"></a>01584     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>;
<a name="l01585"></a>01585 }
<a name="l01586"></a>01586 
<a name="l01587"></a>01587 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01588"></a><a class="code" href="../../d8/d16/gc_8c.html#abdafbbf8f190ea8ee68fcca46713edaa">01588</a> <a class="code" href="../../d8/d16/gc_8c.html#abdafbbf8f190ea8ee68fcca46713edaa">mark_const_tbl</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *tbl, <span class="keywordtype">int</span> <a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a>)
<a name="l01589"></a>01589 {
<a name="l01590"></a>01590     <span class="keyword">struct </span><a class="code" href="../../d8/d73/structmark__tbl__arg.html">mark_tbl_arg</a> arg;
<a name="l01591"></a>01591     <span class="keywordflow">if</span> (!tbl) <span class="keywordflow">return</span>;
<a name="l01592"></a>01592     arg.<a class="code" href="../../d8/d73/structmark__tbl__arg.html#ad48457aff3adfec89fa5423dac9bc2b0">objspace</a> = objspace;
<a name="l01593"></a>01593     arg.<a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a> = lev;
<a name="l01594"></a>01594     <a class="code" href="../../dd/d24/st_8h.html#ace5a79870d2800659a653fceeca55262">st_foreach</a>(tbl, <a class="code" href="../../d8/d16/gc_8c.html#af5d8b5c3d6d87a2907b3ab62627901e0">mark_const_entry_i</a>, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)&amp;arg);
<a name="l01595"></a>01595 }
<a name="l01596"></a>01596 
<a name="l01597"></a>01597 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01598"></a><a class="code" href="../../d8/d16/gc_8c.html#a4d9c447b8f55fd03f47312d52cb7dbce">01598</a> <a class="code" href="../../d8/d16/gc_8c.html#a4d9c447b8f55fd03f47312d52cb7dbce">free_const_entry_i</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <a class="code" href="../../d1/df3/structrb__const__entry__struct.html">rb_const_entry_t</a> *ce, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> data)
<a name="l01599"></a>01599 {
<a name="l01600"></a>01600     <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(ce);
<a name="l01601"></a>01601     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>;
<a name="l01602"></a>01602 }
<a name="l01603"></a>01603 
<a name="l01604"></a>01604 <span class="keywordtype">void</span>
<a name="l01605"></a><a class="code" href="../../d8/d16/gc_8c.html#ac0930709fa9ea2985f4513b9ea1631eb">01605</a> <a class="code" href="../../dd/d17/constant_8h.html#ac0930709fa9ea2985f4513b9ea1631eb">rb_free_const_table</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *tbl)
<a name="l01606"></a>01606 {
<a name="l01607"></a>01607     <a class="code" href="../../dd/d24/st_8h.html#ace5a79870d2800659a653fceeca55262">st_foreach</a>(tbl, <a class="code" href="../../d8/d16/gc_8c.html#a4d9c447b8f55fd03f47312d52cb7dbce">free_const_entry_i</a>, 0);
<a name="l01608"></a>01608     <a class="code" href="../../dd/d24/st_8h.html#acb004847ef312373d65bfb0d1a21c5b3">st_free_table</a>(tbl);
<a name="l01609"></a>01609 }
<a name="l01610"></a>01610 
<a name="l01611"></a>01611 <span class="keywordtype">void</span>
<a name="l01612"></a><a class="code" href="../../db/d2e/intern_8h.html#a1be53fb256f4714b1cea89cfeac151ee">01612</a> <a class="code" href="../../d8/d16/gc_8c.html#a6b9a51387748f1a94f4d77092163aa3a">rb_mark_tbl</a>(<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *tbl)
<a name="l01613"></a>01613 {
<a name="l01614"></a>01614     <a class="code" href="../../d8/d16/gc_8c.html#a113604568481126fb9e62cec5ae99257">mark_tbl</a>(&amp;rb_objspace, tbl, 0);
<a name="l01615"></a>01615 }
<a name="l01616"></a>01616 
<a name="l01617"></a>01617 <span class="keywordtype">void</span>
<a name="l01618"></a><a class="code" href="../../db/d2e/intern_8h.html#a1d3247e340fb349b995f3efdd58bee42">01618</a> <a class="code" href="../../d8/d16/gc_8c.html#a59645c727f2a28c9f86e056159b12fa5">rb_gc_mark_maybe</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj)
<a name="l01619"></a>01619 {
<a name="l01620"></a>01620     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a7cbe2fa2f2f134649873d6cc1bac0238">is_pointer_to_heap</a>(&amp;rb_objspace, (<span class="keywordtype">void</span> *)obj)) {
<a name="l01621"></a>01621         <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(&amp;rb_objspace, obj, 0);
<a name="l01622"></a>01622     }
<a name="l01623"></a>01623 }
<a name="l01624"></a>01624 
<a name="l01625"></a>01625 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01626"></a><a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">01626</a> <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ptr, <span class="keywordtype">int</span> <a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a>)
<a name="l01627"></a>01627 {
<a name="l01628"></a>01628     <span class="keyword">register</span> <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *obj;
<a name="l01629"></a>01629 
<a name="l01630"></a>01630     obj = <a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(ptr);
<a name="l01631"></a>01631     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a71420fb92a2a1c8a3af58c50dff37ccb">rb_special_const_p</a>(ptr)) <span class="keywordflow">return</span>; <span class="comment">/* special const not marked */</span>
<a name="l01632"></a>01632     <span class="keywordflow">if</span> (obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a> == 0) <span class="keywordflow">return</span>;       <span class="comment">/* free cell */</span>
<a name="l01633"></a>01633     <span class="keywordflow">if</span> (obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a> &amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a39ebc82a159cc4776f6ca7037cbd2e26">FL_MARK</a>) <span class="keywordflow">return</span>;  <span class="comment">/* already marked */</span>
<a name="l01634"></a>01634     obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a> |= <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a39ebc82a159cc4776f6ca7037cbd2e26">FL_MARK</a>;
<a name="l01635"></a>01635     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a18e3fbf186b1889395e01baebaa4d8e5">live_num</a>++;
<a name="l01636"></a>01636 
<a name="l01637"></a>01637     <span class="keywordflow">if</span> (lev &gt; <a class="code" href="../../d8/d16/gc_8c.html#a6a4c68f1112d5c4aa0ffaa6568a4d9ea">GC_LEVEL_MAX</a> || (lev == 0 &amp;&amp; <a class="code" href="../../d8/d16/gc_8c.html#a09688a4aa4e47b16c17f851e6f651b81">stack_check</a>(<a class="code" href="../../d8/d16/gc_8c.html#a7ff51d9dd142f87667e4500fa4e3cd88">STACKFRAME_FOR_GC_MARK</a>))) {
<a name="l01638"></a>01638         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d16/gc_8c.html#aef4fe92f4edf54293f8676f2c34c0139">mark_stack_overflow</a>) {
<a name="l01639"></a>01639             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a18c8c3930b6076e2dbd77931a8ffb2fa">mark_stack_ptr</a> - <a class="code" href="../../d8/d16/gc_8c.html#a2b33539aa8ca6caef37f852a8df9993a">mark_stack</a> &lt; <a class="code" href="../../d8/d16/gc_8c.html#a1673f550d1f0e94fec118e6b0a1f2bd3">MARK_STACK_MAX</a>) {
<a name="l01640"></a>01640                 *<a class="code" href="../../d8/d16/gc_8c.html#a18c8c3930b6076e2dbd77931a8ffb2fa">mark_stack_ptr</a> = ptr;
<a name="l01641"></a>01641                 <a class="code" href="../../d8/d16/gc_8c.html#a18c8c3930b6076e2dbd77931a8ffb2fa">mark_stack_ptr</a>++;
<a name="l01642"></a>01642             }
<a name="l01643"></a>01643             <span class="keywordflow">else</span> {
<a name="l01644"></a>01644                 <a class="code" href="../../d8/d16/gc_8c.html#aef4fe92f4edf54293f8676f2c34c0139">mark_stack_overflow</a> = 1;
<a name="l01645"></a>01645             }
<a name="l01646"></a>01646         }
<a name="l01647"></a>01647         <span class="keywordflow">return</span>;
<a name="l01648"></a>01648     }
<a name="l01649"></a>01649     <a class="code" href="../../d8/d16/gc_8c.html#a8df4c0d3a28655b6652fd5e15cd31e55">gc_mark_children</a>(objspace, ptr, lev+1);
<a name="l01650"></a>01650 }
<a name="l01651"></a>01651 
<a name="l01652"></a>01652 <span class="keywordtype">void</span>
<a name="l01653"></a><a class="code" href="../../db/d2e/intern_8h.html#a9cc63a619ac827ce302907081a810324">01653</a> <a class="code" href="../../d8/d16/gc_8c.html#a98250264e6adf4924cf2becf80122325">rb_gc_mark</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ptr)
<a name="l01654"></a>01654 {
<a name="l01655"></a>01655     <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(&amp;rb_objspace, ptr, 0);
<a name="l01656"></a>01656 }
<a name="l01657"></a>01657 
<a name="l01658"></a>01658 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01659"></a><a class="code" href="../../d8/d16/gc_8c.html#a8df4c0d3a28655b6652fd5e15cd31e55">01659</a> <a class="code" href="../../d8/d16/gc_8c.html#a8df4c0d3a28655b6652fd5e15cd31e55">gc_mark_children</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ptr, <span class="keywordtype">int</span> <a class="code" href="../../d8/d73/structmark__tbl__arg.html#a5cfed44b6b159e5728f8df0be9d8d008">lev</a>)
<a name="l01660"></a>01660 {
<a name="l01661"></a>01661     <span class="keyword">register</span> <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *obj = <a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(ptr);
<a name="l01662"></a>01662 
<a name="l01663"></a>01663     <span class="keywordflow">goto</span> marking;               <span class="comment">/* skip */</span>
<a name="l01664"></a>01664 
<a name="l01665"></a>01665   again:
<a name="l01666"></a>01666     obj = <a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(ptr);
<a name="l01667"></a>01667     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a71420fb92a2a1c8a3af58c50dff37ccb">rb_special_const_p</a>(ptr)) <span class="keywordflow">return</span>; <span class="comment">/* special const not marked */</span>
<a name="l01668"></a>01668     <span class="keywordflow">if</span> (obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a> == 0) <span class="keywordflow">return</span>;       <span class="comment">/* free cell */</span>
<a name="l01669"></a>01669     <span class="keywordflow">if</span> (obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a> &amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a39ebc82a159cc4776f6ca7037cbd2e26">FL_MARK</a>) <span class="keywordflow">return</span>;  <span class="comment">/* already marked */</span>
<a name="l01670"></a>01670     obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a> |= <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a39ebc82a159cc4776f6ca7037cbd2e26">FL_MARK</a>;
<a name="l01671"></a>01671     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a18e3fbf186b1889395e01baebaa4d8e5">live_num</a>++;
<a name="l01672"></a>01672 
<a name="l01673"></a>01673   marking:
<a name="l01674"></a>01674     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1ae918b6cc84188a9dc6ab545f732e4d">FL_TEST</a>(obj, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0eecbc9617756148ca4e1c4c0a8c9de6">FL_EXIVAR</a>)) {
<a name="l01675"></a>01675         <a class="code" href="../../db/d2e/intern_8h.html#a4bbb384523553f5c92d1055e3a97bedf">rb_mark_generic_ivar</a>(ptr);
<a name="l01676"></a>01676     }
<a name="l01677"></a>01677 
<a name="l01678"></a>01678     <span class="keywordflow">switch</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(obj)) {
<a name="l01679"></a>01679       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3a7d10c48d5dff0a5d4aa94acb74811a">T_NIL</a>:
<a name="l01680"></a>01680       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a523855de5546c34061e030f4606db3e9">T_FIXNUM</a>:
<a name="l01681"></a>01681         <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;rb_gc_mark() called for broken object&quot;</span>);
<a name="l01682"></a>01682         <span class="keywordflow">break</span>;
<a name="l01683"></a>01683 
<a name="l01684"></a>01684       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5f1cc49c4da51d5bdffa64be79ff6fb0">T_NODE</a>:
<a name="l01685"></a>01685         <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d09/ripper_8y.html#ade12c589b26f55f089dc25d689249c11">nd_type</a>(obj)) {
<a name="l01686"></a>01686           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ab964a29f7a8cdb1e4b518b4cb7420ea5">NODE_IF</a>:         <span class="comment">/* 1,2,3 */</span>
<a name="l01687"></a>01687           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a89c760fc0f7a2209bcac44c5c7907950">NODE_FOR</a>:
<a name="l01688"></a>01688           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a729d82aaada1fbeac7bf4592aa467b76">NODE_ITER</a>:
<a name="l01689"></a>01689           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#abe133b4015b1ff19345d5d25781fc25e">NODE_WHEN</a>:
<a name="l01690"></a>01690           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ad03c15faf9f8ca478889f491431b406b">NODE_MASGN</a>:
<a name="l01691"></a>01691           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a2e2ee74ca4f1fe85350a59ae648d6310">NODE_RESCUE</a>:
<a name="l01692"></a>01692           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a1fa11202ec4f8e4011503e785d2a019b">NODE_RESBODY</a>:
<a name="l01693"></a>01693           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#abb6f5b1caf75e58982beec5eb2b616ab">NODE_CLASS</a>:
<a name="l01694"></a>01694           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#aac25fa5ac2c9b236539991db75bbe3b7">NODE_BLOCK_PASS</a>:
<a name="l01695"></a>01695             <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u2.node, lev);
<a name="l01696"></a>01696             <span class="comment">/* fall through */</span>
<a name="l01697"></a>01697           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ae26c9ff309f6c5d0fd5c3edd0232ee0d">NODE_BLOCK</a>:      <span class="comment">/* 1,3 */</span>
<a name="l01698"></a>01698           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ad13c06599208704f1b6ce18e61e08646">NODE_OPTBLOCK</a>:
<a name="l01699"></a>01699           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a490d1fc6f7f9e81a1815e9b1c3080d94">NODE_ARRAY</a>:
<a name="l01700"></a>01700           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a6487236f9718bcfe094a657cb0efd498">NODE_DSTR</a>:
<a name="l01701"></a>01701           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ac175ada0354ab81202c744d1db266a85">NODE_DXSTR</a>:
<a name="l01702"></a>01702           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a12aabedfc8eee47d21349ce818f3e60c">NODE_DREGX</a>:
<a name="l01703"></a>01703           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a43e52cd8b79e69a358e2ff4082094d2b">NODE_DREGX_ONCE</a>:
<a name="l01704"></a>01704           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#abd2d897cf3ea6a0b59b4cafb72d99b4c">NODE_ENSURE</a>:
<a name="l01705"></a>01705           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ae72a414c065eefb25d29b0376ee93e3d">NODE_CALL</a>:
<a name="l01706"></a>01706           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a1aa42b99b85e6641856c375c18999ebc">NODE_DEFS</a>:
<a name="l01707"></a>01707           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a7ed32e1efe76c3f34ccf1ac4c9def39c">NODE_OP_ASGN1</a>:
<a name="l01708"></a>01708           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a18b66c00780c5dbaa65fd104893c1027">NODE_ARGS</a>:
<a name="l01709"></a>01709             <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u1.node, lev);
<a name="l01710"></a>01710             <span class="comment">/* fall through */</span>
<a name="l01711"></a>01711           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ab986d79d4c826e86db4b17dd331e7b80">NODE_SUPER</a>:      <span class="comment">/* 3 */</span>
<a name="l01712"></a>01712           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a611c4facbf6699e4b795320442ace55f">NODE_FCALL</a>:
<a name="l01713"></a>01713           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a0ce7b90eaf281deb02709b014b182134">NODE_DEFN</a>:
<a name="l01714"></a>01714           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ad3b89428ec7a30b3ddeeba50778a1fd1">NODE_ARGS_AUX</a>:
<a name="l01715"></a>01715             ptr = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u3.node;
<a name="l01716"></a>01716             <span class="keywordflow">goto</span> again;
<a name="l01717"></a>01717 
<a name="l01718"></a>01718           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a271e594a40ed0575457ea8d9def940ac">NODE_WHILE</a>:      <span class="comment">/* 1,2 */</span>
<a name="l01719"></a>01719           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#af25da300c34f1bca6c6e4df28947cb72">NODE_UNTIL</a>:
<a name="l01720"></a>01720           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#afce3dc60f5eb8de336e40138600ef910">NODE_AND</a>:
<a name="l01721"></a>01721           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#addcdfeefb5907f74a7b172a710c8d45e">NODE_OR</a>:
<a name="l01722"></a>01722           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a73d8430547c57f3a7c0734b1a598ff8e">NODE_CASE</a>:
<a name="l01723"></a>01723           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a6b27bbbd70ada5579b4863a16c28d77e">NODE_SCLASS</a>:
<a name="l01724"></a>01724           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#af08e3ddc6c11af4918239aef9490687f">NODE_DOT2</a>:
<a name="l01725"></a>01725           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a9a66d4437b952e9a6bbcbcad6801fc31">NODE_DOT3</a>:
<a name="l01726"></a>01726           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a8b309511f0b3dabe54732e6f19739609">NODE_FLIP2</a>:
<a name="l01727"></a>01727           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ab356b7f8605576fa62c0b0bdf41d8ff3">NODE_FLIP3</a>:
<a name="l01728"></a>01728           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ada6ce553369f37deef93f9019262450a">NODE_MATCH2</a>:
<a name="l01729"></a>01729           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#af18fb86fc2079d7f21c0e918001865cd">NODE_MATCH3</a>:
<a name="l01730"></a>01730           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a19f6bacf83d13be68f94e4d54a02bc5d">NODE_OP_ASGN_OR</a>:
<a name="l01731"></a>01731           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a844d8faea88bfbb66bc0b43a20019df1">NODE_OP_ASGN_AND</a>:
<a name="l01732"></a>01732           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ac8b0046f8276f3b5175c782f6c2a9380">NODE_MODULE</a>:
<a name="l01733"></a>01733           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a0b706295869ed8e7a099d11f8ef9a584">NODE_ALIAS</a>:
<a name="l01734"></a>01734           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a533349938d03fe5c779f78036adf8796">NODE_VALIAS</a>:
<a name="l01735"></a>01735           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a796ba7c9f501e5f81b4f6f06972250fd">NODE_ARGSCAT</a>:
<a name="l01736"></a>01736             <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u1.node, lev);
<a name="l01737"></a>01737             <span class="comment">/* fall through */</span>
<a name="l01738"></a>01738           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#acc59e8bf53d75d27835d03ee9bbac630">NODE_GASGN</a>:      <span class="comment">/* 2 */</span>
<a name="l01739"></a>01739           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#aa9d208a2eb1e5266beea027e10f3d472">NODE_LASGN</a>:
<a name="l01740"></a>01740           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#af92abe71c6571a24b59b4eb4ebb5908f">NODE_DASGN</a>:
<a name="l01741"></a>01741           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#aa69a9128d7cd7376dc4d76e65d90e994">NODE_DASGN_CURR</a>:
<a name="l01742"></a>01742           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a4e3d1029dca72147900e9b1a840bf968">NODE_IASGN</a>:
<a name="l01743"></a>01743           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a015923f7f402969debebc4d989678ea4">NODE_IASGN2</a>:
<a name="l01744"></a>01744           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ae0d7af3d0cea1ce334874826929507bf">NODE_CVASGN</a>:
<a name="l01745"></a>01745           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a614c6f2b1367102fbde526a5eb2871af">NODE_COLON3</a>:
<a name="l01746"></a>01746           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a25c86d19e5399c64a4d3b1278e158272">NODE_OPT_N</a>:
<a name="l01747"></a>01747           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ad557cd9d6e3e99782e148e0ed5712826">NODE_EVSTR</a>:
<a name="l01748"></a>01748           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#abfeac49b2473bade38a545bedf938fdd">NODE_UNDEF</a>:
<a name="l01749"></a>01749           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#aa672b8251edf71e8aee4a1a542451a92">NODE_POSTEXE</a>:
<a name="l01750"></a>01750             ptr = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u2.node;
<a name="l01751"></a>01751             <span class="keywordflow">goto</span> again;
<a name="l01752"></a>01752 
<a name="l01753"></a>01753           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a9e0e908fdac1fc1cfcfba007f8ab1f6b">NODE_HASH</a>:       <span class="comment">/* 1 */</span>
<a name="l01754"></a>01754           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#af19d1c1d9f26c7b19546967449e887f6">NODE_LIT</a>:
<a name="l01755"></a>01755           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#aac55f53b58d8cbef84a61f2d744e7643">NODE_STR</a>:
<a name="l01756"></a>01756           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a4850c3a60b6471d48bbb7b574cc3c3ca">NODE_XSTR</a>:
<a name="l01757"></a>01757           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a9a02a48d7532185f602ab2eee4e7b79a">NODE_DEFINED</a>:
<a name="l01758"></a>01758           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a4621f705bd2dfef90360d8d333d52015">NODE_MATCH</a>:
<a name="l01759"></a>01759           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a0740a4cb8cfb60e24ac741779344739b">NODE_RETURN</a>:
<a name="l01760"></a>01760           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ac20bfa82bfa40e0dbcb4c41c2d5ee603">NODE_BREAK</a>:
<a name="l01761"></a>01761           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a419512cc7a70c27779dfb2fb3ca71a5a">NODE_NEXT</a>:
<a name="l01762"></a>01762           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a210571fb93e1d6ca4c50d6e897cd1d60">NODE_YIELD</a>:
<a name="l01763"></a>01763           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#aff107642c64833eb6f64e7043c4d2b5c">NODE_COLON2</a>:
<a name="l01764"></a>01764           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a985f27752acfb29eca912c28522329c3">NODE_SPLAT</a>:
<a name="l01765"></a>01765           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ac44e1d75073efc2baad77a3eae558bb3">NODE_TO_ARY</a>:
<a name="l01766"></a>01766             ptr = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u1.node;
<a name="l01767"></a>01767             <span class="keywordflow">goto</span> again;
<a name="l01768"></a>01768 
<a name="l01769"></a>01769           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ac6983f7134e356786ebe01ddea8985cd">NODE_SCOPE</a>:      <span class="comment">/* 2,3 */</span>
<a name="l01770"></a>01770           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a62bbab89538c1de14389202f9797ab3d">NODE_CDECL</a>:
<a name="l01771"></a>01771           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#af2b1989d52a7af5b39c0d680a9d27595">NODE_OPT_ARG</a>:
<a name="l01772"></a>01772             <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u3.node, lev);
<a name="l01773"></a>01773             ptr = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u2.node;
<a name="l01774"></a>01774             <span class="keywordflow">goto</span> again;
<a name="l01775"></a>01775 
<a name="l01776"></a>01776           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#acb7153a88fb24c846bd6751ca2fa9316">NODE_ZARRAY</a>:     <span class="comment">/* - */</span>
<a name="l01777"></a>01777           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a5966d8a24f1a0b7ab182a430c3f92ccd">NODE_ZSUPER</a>:
<a name="l01778"></a>01778           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ae2efc36a65904690f165fda092b0a8b1">NODE_VCALL</a>:
<a name="l01779"></a>01779           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a19a08624c33d66f2ef3cfb66af6d9d9f">NODE_GVAR</a>:
<a name="l01780"></a>01780           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#aeb55bab156cfba6fcec9991e963bce3c">NODE_LVAR</a>:
<a name="l01781"></a>01781           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#af01a3b936fc2a83332b8314ef6b00697">NODE_DVAR</a>:
<a name="l01782"></a>01782           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a64cab035c0744c9f375bdf575e0cac2f">NODE_IVAR</a>:
<a name="l01783"></a>01783           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#accf6c145831fd42cf9d6c816498ec82b">NODE_CVAR</a>:
<a name="l01784"></a>01784           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a3ea55c01c2adc06cf9da2a42925ccf03">NODE_NTH_REF</a>:
<a name="l01785"></a>01785           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a276fc132dec9ae10a63bf430e66a1064">NODE_BACK_REF</a>:
<a name="l01786"></a>01786           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a18d2e6f19f54d07ba73aa95f4eab97d3">NODE_REDO</a>:
<a name="l01787"></a>01787           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ab34acb27dadef25e21806f3c6e8e0b2e">NODE_RETRY</a>:
<a name="l01788"></a>01788           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a4beb90d7425a19420390f5f402c7cd7b">NODE_SELF</a>:
<a name="l01789"></a>01789           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a52160547548851ab924923b8ca1dcb42">NODE_NIL</a>:
<a name="l01790"></a>01790           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a00911cb328ad9df305f886837c76923c">NODE_TRUE</a>:
<a name="l01791"></a>01791           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#aa66ba820f9577731ad767ba777d2e633">NODE_FALSE</a>:
<a name="l01792"></a>01792           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a1ef166bb056e61d3375c561896bf24e7">NODE_ERRINFO</a>:
<a name="l01793"></a>01793           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#a6df4a7704528f1713bab81f999b0176c">NODE_BLOCK_ARG</a>:
<a name="l01794"></a>01794             <span class="keywordflow">break</span>;
<a name="l01795"></a>01795           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#afe798b4130b52162a6b58ff378c4a83e">NODE_ALLOCA</a>:
<a name="l01796"></a>01796             <a class="code" href="../../d8/d16/gc_8c.html#af89d492005300beea54a436d1470b652">mark_locations_array</a>(objspace,
<a name="l01797"></a>01797                                  (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>*)obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u1.value,
<a name="l01798"></a>01798                                  obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u3.cnt);
<a name="l01799"></a>01799             ptr = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u2.node;
<a name="l01800"></a>01800             <span class="keywordflow">goto</span> again;
<a name="l01801"></a>01801 
<a name="l01802"></a>01802           <span class="keywordflow">default</span>:              <span class="comment">/* unlisted NODE */</span>
<a name="l01803"></a>01803             <a class="code" href="../../d7/dc0/parse_8y.html#a2ac1143ac343c79cbfa448e30d74fa1c">if</a> (<a class="code" href="../../d8/d16/gc_8c.html#a7cbe2fa2f2f134649873d6cc1bac0238">is_pointer_to_heap</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u1.node)) {
<a name="l01804"></a>01804                 <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u1.node, lev);
<a name="l01805"></a>01805             }
<a name="l01806"></a>01806             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a7cbe2fa2f2f134649873d6cc1bac0238">is_pointer_to_heap</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u2.node)) {
<a name="l01807"></a>01807                 <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u2.node, lev);
<a name="l01808"></a>01808             }
<a name="l01809"></a>01809             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a7cbe2fa2f2f134649873d6cc1bac0238">is_pointer_to_heap</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u3.node)) {
<a name="l01810"></a>01810                 <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ab9fe66852aa0601fa3cf323fb24371e8">node</a>.u3.node, lev);
<a name="l01811"></a>01811             }
<a name="l01812"></a>01812         }
<a name="l01813"></a>01813         <span class="keywordflow">return</span>;                 <span class="comment">/* no need to mark class. */</span>
<a name="l01814"></a>01814     }
<a name="l01815"></a>01815 
<a name="l01816"></a>01816     <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a31e86dc428e998786b528fef067424a4">klass</a>, lev);
<a name="l01817"></a>01817     <span class="keywordflow">switch</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(obj)) {
<a name="l01818"></a>01818       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a82c8c4569748b9645c958b9eaeaabb81">T_ICLASS</a>:
<a name="l01819"></a>01819       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad04c63d175774c6d6e7dfaf0f0a982c9">T_CLASS</a>:
<a name="l01820"></a>01820       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6cdc7dfe8f84777325da08a96ae5f795">T_MODULE</a>:
<a name="l01821"></a>01821         <a class="code" href="../../d8/d16/gc_8c.html#a7f22256df2a196f68d00e4ba23f6c57d">mark_m_tbl</a>(objspace, <a class="code" href="../../d3/d09/ripper_8y.html#ab59ea80cdf15f3f19bbae0346314c9ad">RCLASS_M_TBL</a>(obj), lev);
<a name="l01822"></a>01822         <a class="code" href="../../d8/d16/gc_8c.html#a113604568481126fb9e62cec5ae99257">mark_tbl</a>(objspace, <a class="code" href="../../d3/d09/ripper_8y.html#a7f7f2dbf958976d9bf317167396992d4">RCLASS_IV_TBL</a>(obj), lev);
<a name="l01823"></a>01823         <a class="code" href="../../d8/d16/gc_8c.html#abdafbbf8f190ea8ee68fcca46713edaa">mark_const_tbl</a>(objspace, <a class="code" href="../../d3/d09/ripper_8y.html#a9dfcc3730f2a2a5ef643c2b6c3e606d1">RCLASS_CONST_TBL</a>(obj), lev);
<a name="l01824"></a>01824         ptr = <a class="code" href="../../d3/d09/ripper_8y.html#a19d17315b6b34045cdffec9912342b91">RCLASS_SUPER</a>(obj);
<a name="l01825"></a>01825         <span class="keywordflow">goto</span> again;
<a name="l01826"></a>01826 
<a name="l01827"></a>01827       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a>:
<a name="l01828"></a>01828         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1ae918b6cc84188a9dc6ab545f732e4d">FL_TEST</a>(obj, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4f77ed51d02515ee27ce9fca7880ce8f">ELTS_SHARED</a>)) {
<a name="l01829"></a>01829             ptr = obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a9604d38ae2aaa6ccb4033a2e2908f832">array</a>.<a class="code" href="../../dd/d8b/struct_r_array.html#af89eaa842b2c677c8c2c9b04e29ecb34">as</a>.<a class="code" href="../../dd/d8b/struct_r_array.html#a7aaca072a107f0bf208afd23228fc3bd">heap</a>.aux.shared;
<a name="l01830"></a>01830             <span class="keywordflow">goto</span> again;
<a name="l01831"></a>01831         }
<a name="l01832"></a>01832         <span class="keywordflow">else</span> {
<a name="l01833"></a>01833             <span class="keywordtype">long</span> i, <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(obj);
<a name="l01834"></a>01834             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *ptr = <a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(obj);
<a name="l01835"></a>01835             <span class="keywordflow">for</span> (i=0; i &lt; len; i++) {
<a name="l01836"></a>01836                 <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, *ptr++, lev);
<a name="l01837"></a>01837             }
<a name="l01838"></a>01838         }
<a name="l01839"></a>01839         <span class="keywordflow">break</span>;
<a name="l01840"></a>01840 
<a name="l01841"></a>01841       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8357e81bbb60cb41b0a292a90653a5e5">T_HASH</a>:
<a name="l01842"></a>01842         <a class="code" href="../../d8/d16/gc_8c.html#a738f23012e6259467a0163ec7f49c053">mark_hash</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a17e2439f96c5d71ad07ef32abfcb2f6e">hash</a>.<a class="code" href="../../df/d3a/struct_r_hash.html#ac0d25203ebfc9e701013406542941597">ntbl</a>, lev);
<a name="l01843"></a>01843         ptr = obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a17e2439f96c5d71ad07ef32abfcb2f6e">hash</a>.<a class="code" href="../../df/d3a/struct_r_hash.html#a75f341be893b37eb26be4f027bf9cd44">ifnone</a>;
<a name="l01844"></a>01844         <span class="keywordflow">goto</span> again;
<a name="l01845"></a>01845 
<a name="l01846"></a>01846       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a22a8c2a4bbaae9b68f65c9bb92fd4e39">T_STRING</a>:
<a name="l01847"></a>01847 <span class="preprocessor">#define STR_ASSOC FL_USER3   </span><span class="comment">/* copied from string.c */</span>
<a name="l01848"></a>01848         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1ae918b6cc84188a9dc6ab545f732e4d">FL_TEST</a>(obj, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a38c3130e65fdd7e20a3e3cb2d0f54299">RSTRING_NOEMBED</a>) &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2807acd546bffb9c5a75633fb1ef59f3">FL_ANY</a>(obj, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4f77ed51d02515ee27ce9fca7880ce8f">ELTS_SHARED</a>|<a class="code" href="../../d8/d16/gc_8c.html#a2f2bd1a90a891cf8697328b4ba8d4d54">STR_ASSOC</a>)) {
<a name="l01849"></a>01849             ptr = obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#adf179b340c37d4f5b14fb06c2431214f">string</a>.<a class="code" href="../../dd/d63/struct_r_string.html#a49bf8805294a5671d53a5cb3876c2915">as</a>.<a class="code" href="../../dd/d63/struct_r_string.html#a826280fdfc96d05037ffa50a1607ebfe">heap</a>.aux.shared;
<a name="l01850"></a>01850             <span class="keywordflow">goto</span> again;
<a name="l01851"></a>01851         }
<a name="l01852"></a>01852         <span class="keywordflow">break</span>;
<a name="l01853"></a>01853 
<a name="l01854"></a>01854       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a55f295817faf14e42b3cff745a7ac706">T_DATA</a>:
<a name="l01855"></a>01855         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac167240ec598e32f5ff3cdb902fb98b9">RTYPEDDATA_P</a>(obj)) {
<a name="l01856"></a>01856             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad83646c4b210a82fc3d1a1e723ffc931">RUBY_DATA_FUNC</a> mark_func = obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#ac5b5f8701cc82db574b50da73b3bd6d8">typeddata</a>.<a class="code" href="../../d6/d45/struct_r_typed_data.html#a95b19d67ba62f896285c3cef8d55fcc0">type</a>-&gt;<a class="code" href="../../d7/de2/structrb__data__type__struct.html#acc2fdc5bc1fc7398acd19db50ee2a10d">function</a>.<a class="code" href="../../d7/de2/structrb__data__type__struct.html#a6c4ced56438c08a52d789bc52d64b5d8">dmark</a>;
<a name="l01857"></a>01857             <span class="keywordflow">if</span> (mark_func) (*mark_func)(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#abb509cfdf6560a9f795b1f6932d93691">DATA_PTR</a>(obj));
<a name="l01858"></a>01858         }
<a name="l01859"></a>01859         <span class="keywordflow">else</span> {
<a name="l01860"></a>01860             <span class="keywordflow">if</span> (obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a2a582321ccfa06c0485977c88de71d2d">data</a>.<a class="code" href="../../d0/dcf/struct_r_data.html#a3965b3d7e0e0b3d2713be9efdfbdef7d">dmark</a>) (*obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a2a582321ccfa06c0485977c88de71d2d">data</a>.<a class="code" href="../../d0/dcf/struct_r_data.html#a3965b3d7e0e0b3d2713be9efdfbdef7d">dmark</a>)(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#abb509cfdf6560a9f795b1f6932d93691">DATA_PTR</a>(obj));
<a name="l01861"></a>01861         }
<a name="l01862"></a>01862         <span class="keywordflow">break</span>;
<a name="l01863"></a>01863 
<a name="l01864"></a>01864       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abed71c72d5c3083041d52ad25630270e">T_OBJECT</a>:
<a name="l01865"></a>01865         {
<a name="l01866"></a>01866             <span class="keywordtype">long</span> i, <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afd3b3bb33823e7f8e0196f56e3870dd4">ROBJECT_NUMIV</a>(obj);
<a name="l01867"></a>01867             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *ptr = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#adfa7e6250c07b5504c39bf163892462d">ROBJECT_IVPTR</a>(obj);
<a name="l01868"></a>01868             <span class="keywordflow">for</span> (i  = 0; i &lt; len; i++) {
<a name="l01869"></a>01869                 <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, *ptr++, lev);
<a name="l01870"></a>01870             }
<a name="l01871"></a>01871         }
<a name="l01872"></a>01872         <span class="keywordflow">break</span>;
<a name="l01873"></a>01873 
<a name="l01874"></a>01874       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a>:
<a name="l01875"></a>01875         <span class="keywordflow">if</span> (obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a97cd726dd7aa22970264f034cd494c99">file</a>.<a class="code" href="../../de/d5d/struct_r_file.html#a6c4c7ce6825193998a35110535111d4e">fptr</a>) {
<a name="l01876"></a>01876             <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a97cd726dd7aa22970264f034cd494c99">file</a>.<a class="code" href="../../de/d5d/struct_r_file.html#a6c4c7ce6825193998a35110535111d4e">fptr</a>-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>, lev);
<a name="l01877"></a>01877             <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a97cd726dd7aa22970264f034cd494c99">file</a>.<a class="code" href="../../de/d5d/struct_r_file.html#a6c4c7ce6825193998a35110535111d4e">fptr</a>-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ad4507dbb812bff2064ead59f235039c2">tied_io_for_writing</a>, lev);
<a name="l01878"></a>01878             <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a97cd726dd7aa22970264f034cd494c99">file</a>.<a class="code" href="../../de/d5d/struct_r_file.html#a6c4c7ce6825193998a35110535111d4e">fptr</a>-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a8b6143bfe35f445d8564a71b547101ee">writeconv_asciicompat</a>, lev);
<a name="l01879"></a>01879             <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a97cd726dd7aa22970264f034cd494c99">file</a>.<a class="code" href="../../de/d5d/struct_r_file.html#a6c4c7ce6825193998a35110535111d4e">fptr</a>-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ac82d528d2dee6d4f0f880fa9526fa9a6">writeconv_pre_ecopts</a>, lev);
<a name="l01880"></a>01880             <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a97cd726dd7aa22970264f034cd494c99">file</a>.<a class="code" href="../../de/d5d/struct_r_file.html#a6c4c7ce6825193998a35110535111d4e">fptr</a>-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecopts, lev);
<a name="l01881"></a>01881             <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a97cd726dd7aa22970264f034cd494c99">file</a>.<a class="code" href="../../de/d5d/struct_r_file.html#a6c4c7ce6825193998a35110535111d4e">fptr</a>-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ab6eade210f169f0a929e1381cbef947d">write_lock</a>, lev);
<a name="l01882"></a>01882         }
<a name="l01883"></a>01883         <span class="keywordflow">break</span>;
<a name="l01884"></a>01884 
<a name="l01885"></a>01885       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afd5c1e36d171ecc04514332e8dcf6388">T_REGEXP</a>:
<a name="l01886"></a>01886         <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#aa3fecd4c586a9a8e040e75c9b144cad4">regexp</a>.<a class="code" href="../../d5/d8b/struct_r_regexp.html#a209dbf22d066e837ddeaab765d46f780">src</a>, lev);
<a name="l01887"></a>01887         <span class="keywordflow">break</span>;
<a name="l01888"></a>01888 
<a name="l01889"></a>01889       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3d072e0c25cf678e9b8601b957b92eae">T_FLOAT</a>:
<a name="l01890"></a>01890       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a41ac74a27dd1eadc2ca86d10590f2163">T_BIGNUM</a>:
<a name="l01891"></a>01891       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ab80c70472770bcae8d33bbf6139262d0">T_ZOMBIE</a>:
<a name="l01892"></a>01892         <span class="keywordflow">break</span>;
<a name="l01893"></a>01893 
<a name="l01894"></a>01894       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#acc66e9c9228bc7ad6f292a253ce5fdf4">T_MATCH</a>:
<a name="l01895"></a>01895         <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#aedde21bcd815aa6f4019616c3da8c85c">match</a>.<a class="code" href="../../dd/d2b/struct_r_match.html#a0209981436771c79983ec44174efa957">regexp</a>, lev);
<a name="l01896"></a>01896         <span class="keywordflow">if</span> (obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#aedde21bcd815aa6f4019616c3da8c85c">match</a>.<a class="code" href="../../dd/d2b/struct_r_match.html#afe31908c73af6751f8231c34d2fcc500">str</a>) {
<a name="l01897"></a>01897             ptr = obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#aedde21bcd815aa6f4019616c3da8c85c">match</a>.<a class="code" href="../../dd/d2b/struct_r_match.html#afe31908c73af6751f8231c34d2fcc500">str</a>;
<a name="l01898"></a>01898             <span class="keywordflow">goto</span> again;
<a name="l01899"></a>01899         }
<a name="l01900"></a>01900         <span class="keywordflow">break</span>;
<a name="l01901"></a>01901 
<a name="l01902"></a>01902       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a804d1259cf2408f16969b2dc06b293fc">T_RATIONAL</a>:
<a name="l01903"></a>01903         <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#adfe7a482dccb1343ff7d39a76a64a057">rational</a>.<a class="code" href="../../d0/d66/struct_r_rational.html#a0df44f2949dbf2b7596e8f3a747dd7eb">num</a>, lev);
<a name="l01904"></a>01904         <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#adfe7a482dccb1343ff7d39a76a64a057">rational</a>.<a class="code" href="../../d0/d66/struct_r_rational.html#aa57daf63daa734924d5be4870cf74480">den</a>, lev);
<a name="l01905"></a>01905         <span class="keywordflow">break</span>;
<a name="l01906"></a>01906 
<a name="l01907"></a>01907       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a05f3b14562e8d1e2d09e7a4438c1d2fa">T_COMPLEX</a>:
<a name="l01908"></a>01908         <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a916be87d92f0b3857f982dfd913a64cd">complex</a>.<a class="code" href="../../db/d80/struct_r_complex.html#a94749ec8ca27f6b6ecfb094b1ce14e11">real</a>, lev);
<a name="l01909"></a>01909         <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, obj-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a916be87d92f0b3857f982dfd913a64cd">complex</a>.<a class="code" href="../../db/d80/struct_r_complex.html#a605e4f400530792d6e4dbb9ce221e1ea">imag</a>, lev);
<a name="l01910"></a>01910         <span class="keywordflow">break</span>;
<a name="l01911"></a>01911 
<a name="l01912"></a>01912       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4853f60a017b2b7a126d3e23db98a954">T_STRUCT</a>:
<a name="l01913"></a>01913         {
<a name="l01914"></a>01914             <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aaeedf10e5dac36c5e7d3dd9d78f8766d">RSTRUCT_LEN</a>(obj);
<a name="l01915"></a>01915             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *ptr = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad29ef3419dc9cdc93ae39eea4a31beed">RSTRUCT_PTR</a>(obj);
<a name="l01916"></a>01916 
<a name="l01917"></a>01917             <span class="keywordflow">while</span> (len--) {
<a name="l01918"></a>01918                 <a class="code" href="../../d8/d16/gc_8c.html#af630c90989bf4473b0e7941e99a4499c">gc_mark</a>(objspace, *ptr++, lev);
<a name="l01919"></a>01919             }
<a name="l01920"></a>01920         }
<a name="l01921"></a>01921         <span class="keywordflow">break</span>;
<a name="l01922"></a>01922 
<a name="l01923"></a>01923       <span class="keywordflow">default</span>:
<a name="l01924"></a>01924         <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;rb_gc_mark(): unknown data type 0x%x(%p) %s&quot;</span>,
<a name="l01925"></a>01925                <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(obj), (<span class="keywordtype">void</span> *)obj,
<a name="l01926"></a>01926                <a class="code" href="../../d8/d16/gc_8c.html#a7cbe2fa2f2f134649873d6cc1bac0238">is_pointer_to_heap</a>(objspace, obj) ? <span class="stringliteral">&quot;corrupted object&quot;</span> : <span class="stringliteral">&quot;non object&quot;</span>);
<a name="l01927"></a>01927     }
<a name="l01928"></a>01928 }
<a name="l01929"></a>01929 
<a name="l01930"></a>01930 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d16/gc_8c.html#a775c65b64712d2910826aed291ba8f48">obj_free</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>);
<a name="l01931"></a>01931 
<a name="l01932"></a>01932 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l01933"></a><a class="code" href="../../d8/d16/gc_8c.html#a2e1258f08c3958e131561d2452d62413">01933</a> <a class="code" href="../../d8/d16/gc_8c.html#a2e1258f08c3958e131561d2452d62413">add_freelist</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *p)
<a name="l01934"></a>01934 {
<a name="l01935"></a>01935     <a class="code" href="../../db/d74/zlib_8c.html#ae893baae242001d89c2319ab442fc610">VALGRIND_MAKE_MEM_UNDEFINED</a>((<span class="keywordtype">void</span>*)p, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a>));
<a name="l01936"></a>01936     p-&gt;as.free.flags = 0;
<a name="l01937"></a>01937     p-&gt;as.free.next = <a class="code" href="../../d8/d16/gc_8c.html#a896e77038c659ca416b686f1e7a93eb8">freelist</a>;
<a name="l01938"></a>01938     <a class="code" href="../../d8/d16/gc_8c.html#a896e77038c659ca416b686f1e7a93eb8">freelist</a> = p;
<a name="l01939"></a>01939 }
<a name="l01940"></a>01940 
<a name="l01941"></a>01941 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01942"></a><a class="code" href="../../d8/d16/gc_8c.html#aeb6d71a1da244f134fa6b041f3f0bd8f">01942</a> <a class="code" href="../../d8/d16/gc_8c.html#aeb6d71a1da244f134fa6b041f3f0bd8f">finalize_list</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *p)
<a name="l01943"></a>01943 {
<a name="l01944"></a>01944     <span class="keywordflow">while</span> (p) {
<a name="l01945"></a>01945         <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *tmp = p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#af8cb8a1856ec08aeed677584f8930880">free</a>.next;
<a name="l01946"></a>01946         <a class="code" href="../../d8/d16/gc_8c.html#af529267e0eab924c8d9427304a310794">run_final</a>(objspace, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)p);
<a name="l01947"></a>01947         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1ae918b6cc84188a9dc6ab545f732e4d">FL_TEST</a>(p, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a081b5172ef37829bb3a258cd1ad393bc">FL_SINGLETON</a>)) { <span class="comment">/* not freeing page */</span>
<a name="l01948"></a>01948             <span class="keywordflow">if</span> (objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">sweep_slots</a>) {
<a name="l01949"></a>01949                 p-&gt;as.free.flags = 0;
<a name="l01950"></a>01950             }
<a name="l01951"></a>01951             <span class="keywordflow">else</span> {
<a name="l01952"></a>01952                 <a class="code" href="../../d8/d16/gc_8c.html#a099dbbf45d09b64ccea651186b19fc68">GC_PROF_DEC_LIVE_NUM</a>;
<a name="l01953"></a>01953                 <a class="code" href="../../d8/d16/gc_8c.html#a2e1258f08c3958e131561d2452d62413">add_freelist</a>(objspace, p);
<a name="l01954"></a>01954             }
<a name="l01955"></a>01955         }
<a name="l01956"></a>01956         <span class="keywordflow">else</span> {
<a name="l01957"></a>01957             <span class="keyword">struct </span><a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a> *<a class="code" href="../../da/dda/structheaps__slot.html#ae677a624c841d9129e8f31d350dc5f21">slot</a> = (<span class="keyword">struct </span><a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a> *)(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa38eb1376d31aae1fe0b334b9b76f2ef">RDATA</a>(p)-&gt;dmark;
<a name="l01958"></a>01958             slot-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#aab5626f69fb1dff0779d330d780bd928">limit</a>--;
<a name="l01959"></a>01959         }
<a name="l01960"></a>01960         p = tmp;
<a name="l01961"></a>01961     }
<a name="l01962"></a>01962 }
<a name="l01963"></a>01963 
<a name="l01964"></a>01964 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01965"></a><a class="code" href="../../d8/d16/gc_8c.html#a5620a0e8328f3b6e9274f701fe21b83e">01965</a> <a class="code" href="../../d8/d16/gc_8c.html#a5620a0e8328f3b6e9274f701fe21b83e">unlink_heap_slot</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <span class="keyword">struct</span> <a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a> *<a class="code" href="../../da/dda/structheaps__slot.html#ae677a624c841d9129e8f31d350dc5f21">slot</a>)
<a name="l01966"></a>01966 {
<a name="l01967"></a>01967     <span class="keywordflow">if</span> (slot-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a03c40ceeaaa233463ff3e654d837427a">prev</a>)
<a name="l01968"></a>01968         slot-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a03c40ceeaaa233463ff3e654d837427a">prev</a>-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a369e6ce2c28e10e149c964d374fc7c27">next</a> = slot-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a369e6ce2c28e10e149c964d374fc7c27">next</a>;
<a name="l01969"></a>01969     <span class="keywordflow">if</span> (slot-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a369e6ce2c28e10e149c964d374fc7c27">next</a>)
<a name="l01970"></a>01970         slot-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a369e6ce2c28e10e149c964d374fc7c27">next</a>-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a03c40ceeaaa233463ff3e654d837427a">prev</a> = slot-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a03c40ceeaaa233463ff3e654d837427a">prev</a>;
<a name="l01971"></a>01971     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a3eb89961b2be51932ecadee6b63963ba">heaps</a> == slot)
<a name="l01972"></a>01972         <a class="code" href="../../d8/d16/gc_8c.html#a3eb89961b2be51932ecadee6b63963ba">heaps</a> = slot-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a369e6ce2c28e10e149c964d374fc7c27">next</a>;
<a name="l01973"></a>01973     <span class="keywordflow">if</span> (objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">sweep_slots</a> == slot)
<a name="l01974"></a>01974         objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">sweep_slots</a> = slot-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a369e6ce2c28e10e149c964d374fc7c27">next</a>;
<a name="l01975"></a>01975     slot-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a03c40ceeaaa233463ff3e654d837427a">prev</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01976"></a>01976     slot-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a369e6ce2c28e10e149c964d374fc7c27">next</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01977"></a>01977 }
<a name="l01978"></a>01978 
<a name="l01979"></a>01979 
<a name="l01980"></a>01980 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01981"></a><a class="code" href="../../d8/d16/gc_8c.html#a56d5d60ded6c80b927508340f4211373">01981</a> <a class="code" href="../../d8/d16/gc_8c.html#a56d5d60ded6c80b927508340f4211373">free_unused_heaps</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l01982"></a>01982 {
<a name="l01983"></a>01983     <span class="keywordtype">size_t</span> i, j;
<a name="l01984"></a>01984     <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a> = 0;
<a name="l01985"></a>01985 
<a name="l01986"></a>01986     <span class="keywordflow">for</span> (i = j = 1; j &lt; <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a>; i++) {
<a name="l01987"></a>01987         <span class="keywordflow">if</span> (objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a79843785a726ea01bb4683ad9ba055d3">slot</a>-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#aab5626f69fb1dff0779d330d780bd928">limit</a> == 0) {
<a name="l01988"></a>01988             <span class="keywordflow">if</span> (!last) {
<a name="l01989"></a>01989                 last = objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a79843785a726ea01bb4683ad9ba055d3">slot</a>-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a4e10e0c9aba6f88eddf3d5f6d9c408fb">membase</a>;
<a name="l01990"></a>01990             }
<a name="l01991"></a>01991             <span class="keywordflow">else</span> {
<a name="l01992"></a>01992                 <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a79843785a726ea01bb4683ad9ba055d3">slot</a>-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a4e10e0c9aba6f88eddf3d5f6d9c408fb">membase</a>);
<a name="l01993"></a>01993             }
<a name="l01994"></a>01994             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a79843785a726ea01bb4683ad9ba055d3">slot</a>);
<a name="l01995"></a>01995             heaps_used--;
<a name="l01996"></a>01996         }
<a name="l01997"></a>01997         <span class="keywordflow">else</span> {
<a name="l01998"></a>01998             <span class="keywordflow">if</span> (i != j) {
<a name="l01999"></a>01999                 objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[j] = objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i];
<a name="l02000"></a>02000             }
<a name="l02001"></a>02001             j++;
<a name="l02002"></a>02002         }
<a name="l02003"></a>02003     }
<a name="l02004"></a>02004     <span class="keywordflow">if</span> (last) {
<a name="l02005"></a>02005         <span class="keywordflow">if</span> (last &lt; <a class="code" href="../../d8/d16/gc_8c.html#a332222afe533612ed81b65681a48e1f3">heaps_freed</a>) {
<a name="l02006"></a>02006             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(<a class="code" href="../../d8/d16/gc_8c.html#a332222afe533612ed81b65681a48e1f3">heaps_freed</a>);
<a name="l02007"></a>02007             <a class="code" href="../../d8/d16/gc_8c.html#a332222afe533612ed81b65681a48e1f3">heaps_freed</a> = last;
<a name="l02008"></a>02008         }
<a name="l02009"></a>02009         <span class="keywordflow">else</span> {
<a name="l02010"></a>02010             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(last);
<a name="l02011"></a>02011         }
<a name="l02012"></a>02012     }
<a name="l02013"></a>02013 }
<a name="l02014"></a>02014 
<a name="l02015"></a>02015 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02016"></a><a class="code" href="../../d8/d16/gc_8c.html#af13cde662aad9d628f5152fb09bddd3a">02016</a> <a class="code" href="../../d8/d16/gc_8c.html#af13cde662aad9d628f5152fb09bddd3a">slot_sweep</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <span class="keyword">struct</span> <a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a> *sweep_slot)
<a name="l02017"></a>02017 {
<a name="l02018"></a>02018     <span class="keywordtype">size_t</span> free_num = 0, final_num = 0;
<a name="l02019"></a>02019     <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *p, *pend;
<a name="l02020"></a>02020     <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *<a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a> = <a class="code" href="../../d8/d16/gc_8c.html#a896e77038c659ca416b686f1e7a93eb8">freelist</a>, *<span class="keyword">final</span> = <a class="code" href="../../d8/d16/gc_8c.html#a39bb37371a2ddda30cc826e790ceda3c">deferred_final_list</a>;
<a name="l02021"></a>02021     <span class="keywordtype">int</span> deferred;
<a name="l02022"></a>02022 
<a name="l02023"></a>02023     p = sweep_slot-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#ae677a624c841d9129e8f31d350dc5f21">slot</a>; pend = p + sweep_slot-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#aab5626f69fb1dff0779d330d780bd928">limit</a>;
<a name="l02024"></a>02024     <span class="keywordflow">while</span> (p &lt; pend) {
<a name="l02025"></a>02025         <span class="keywordflow">if</span> (!(p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a> &amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a39ebc82a159cc4776f6ca7037cbd2e26">FL_MARK</a>)) {
<a name="l02026"></a>02026             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a> &amp;&amp;
<a name="l02027"></a>02027                 ((deferred = <a class="code" href="../../d8/d16/gc_8c.html#a775c65b64712d2910826aed291ba8f48">obj_free</a>(objspace, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)p)) ||
<a name="l02028"></a>02028                  (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1ae918b6cc84188a9dc6ab545f732e4d">FL_TEST</a>(p, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6c5ccf5e4d375da1c8f418ccd41c92bb">FL_FINALIZE</a>)))) {
<a name="l02029"></a>02029                 <span class="keywordflow">if</span> (!deferred) {
<a name="l02030"></a>02030                     p-&gt;as.free.flags = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ab80c70472770bcae8d33bbf6139262d0">T_ZOMBIE</a>;
<a name="l02031"></a>02031                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa38eb1376d31aae1fe0b334b9b76f2ef">RDATA</a>(p)-&gt;dfree = 0;
<a name="l02032"></a>02032                 }
<a name="l02033"></a>02033                 p-&gt;as.free.flags |= <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a39ebc82a159cc4776f6ca7037cbd2e26">FL_MARK</a>;
<a name="l02034"></a>02034                 p-&gt;as.free.next = <a class="code" href="../../d8/d16/gc_8c.html#a39bb37371a2ddda30cc826e790ceda3c">deferred_final_list</a>;
<a name="l02035"></a>02035                 <a class="code" href="../../d8/d16/gc_8c.html#a39bb37371a2ddda30cc826e790ceda3c">deferred_final_list</a> = p;
<a name="l02036"></a>02036                 final_num++;
<a name="l02037"></a>02037             }
<a name="l02038"></a>02038             <span class="keywordflow">else</span> {
<a name="l02039"></a>02039                 <a class="code" href="../../d8/d16/gc_8c.html#a2e1258f08c3958e131561d2452d62413">add_freelist</a>(objspace, p);
<a name="l02040"></a>02040                 free_num++;
<a name="l02041"></a>02041             }
<a name="l02042"></a>02042         }
<a name="l02043"></a>02043         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(p) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ab80c70472770bcae8d33bbf6139262d0">T_ZOMBIE</a>) {
<a name="l02044"></a>02044             <span class="comment">/* objects to be finalized */</span>
<a name="l02045"></a>02045             <span class="comment">/* do nothing remain marked */</span>
<a name="l02046"></a>02046         }
<a name="l02047"></a>02047         <span class="keywordflow">else</span> {
<a name="l02048"></a>02048             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1d4c05021aacd8cab989ff60f95ebe2d">RBASIC</a>(p)-&gt;flags &amp;= ~<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a39ebc82a159cc4776f6ca7037cbd2e26">FL_MARK</a>;
<a name="l02049"></a>02049         }
<a name="l02050"></a>02050         p++;
<a name="l02051"></a>02051     }
<a name="l02052"></a>02052     <span class="keywordflow">if</span> (final_num + free_num == sweep_slot-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#aab5626f69fb1dff0779d330d780bd928">limit</a> &amp;&amp;
<a name="l02053"></a>02053         objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#adae35865d1de5847544a532a63c451fa">free_num</a> &gt; objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a30e591c3106a56c6f76f67d1d4351207">do_heap_free</a>) {
<a name="l02054"></a>02054         <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *pp;
<a name="l02055"></a>02055 
<a name="l02056"></a>02056         <span class="keywordflow">for</span> (pp = <a class="code" href="../../d8/d16/gc_8c.html#a39bb37371a2ddda30cc826e790ceda3c">deferred_final_list</a>; pp != <span class="keyword">final</span>; pp = pp-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#af8cb8a1856ec08aeed677584f8930880">free</a>.next) {
<a name="l02057"></a>02057             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa38eb1376d31aae1fe0b334b9b76f2ef">RDATA</a>(pp)-&gt;dmark = (void (*)(<span class="keywordtype">void</span> *))(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)sweep_slot;
<a name="l02058"></a>02058             pp-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#af8cb8a1856ec08aeed677584f8930880">free</a>.flags |= <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a081b5172ef37829bb3a258cd1ad393bc">FL_SINGLETON</a>; <span class="comment">/* freeing page mark */</span>
<a name="l02059"></a>02059         }
<a name="l02060"></a>02060         sweep_slot-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#aab5626f69fb1dff0779d330d780bd928">limit</a> = final_num;
<a name="l02061"></a>02061         <a class="code" href="../../d8/d16/gc_8c.html#a896e77038c659ca416b686f1e7a93eb8">freelist</a> = free;        <span class="comment">/* cancel this page from freelist */</span>
<a name="l02062"></a>02062         <a class="code" href="../../d8/d16/gc_8c.html#a5620a0e8328f3b6e9274f701fe21b83e">unlink_heap_slot</a>(objspace, sweep_slot);
<a name="l02063"></a>02063     }
<a name="l02064"></a>02064     <span class="keywordflow">else</span> {
<a name="l02065"></a>02065         objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#adae35865d1de5847544a532a63c451fa">free_num</a> += free_num;
<a name="l02066"></a>02066     }
<a name="l02067"></a>02067     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a3fcb169372e6a22e464737dd3346cbae">final_num</a> += final_num;
<a name="l02068"></a>02068 
<a name="l02069"></a>02069     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a39bb37371a2ddda30cc826e790ceda3c">deferred_final_list</a>) {
<a name="l02070"></a>02070         <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l02071"></a>02071         <span class="keywordflow">if</span> (th) {
<a name="l02072"></a>02072             <a class="code" href="../../d8/d32/vm__core_8h.html#a24bcbe1a08ff7427bcefc4ba3ec16463">RUBY_VM_SET_FINALIZER_INTERRUPT</a>(th);
<a name="l02073"></a>02073         }
<a name="l02074"></a>02074     }
<a name="l02075"></a>02075 }
<a name="l02076"></a>02076 
<a name="l02077"></a>02077 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02078"></a><a class="code" href="../../d8/d16/gc_8c.html#a8b36b35fc92a92063db78b31a87d9e58">02078</a> <a class="code" href="../../d8/d16/gc_8c.html#a8b36b35fc92a92063db78b31a87d9e58">ready_to_gc</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l02079"></a>02079 {
<a name="l02080"></a>02080     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#af3db9015bc1d568dfbb6f98ff169ef97">dont_gc</a> || <a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a>) {
<a name="l02081"></a>02081         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d16/gc_8c.html#a896e77038c659ca416b686f1e7a93eb8">freelist</a>) {
<a name="l02082"></a>02082             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d16/gc_8c.html#a4c82c9dea941e571de0ef59457d2810a">heaps_increment</a>(objspace)) {
<a name="l02083"></a>02083                 <a class="code" href="../../d8/d16/gc_8c.html#a0573de72950f16e074f90eb6cebe798e">set_heaps_increment</a>(objspace);
<a name="l02084"></a>02084                 <a class="code" href="../../d8/d16/gc_8c.html#a4c82c9dea941e571de0ef59457d2810a">heaps_increment</a>(objspace);
<a name="l02085"></a>02085             }
<a name="l02086"></a>02086         }
<a name="l02087"></a>02087         <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02088"></a>02088     }
<a name="l02089"></a>02089     <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02090"></a>02090 }
<a name="l02091"></a>02091 
<a name="l02092"></a>02092 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02093"></a><a class="code" href="../../d8/d16/gc_8c.html#ae968442157aa672e11a305e08257066f">02093</a> <a class="code" href="../../d8/d16/gc_8c.html#ae968442157aa672e11a305e08257066f">before_gc_sweep</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l02094"></a>02094 {
<a name="l02095"></a>02095     <a class="code" href="../../d8/d16/gc_8c.html#a896e77038c659ca416b686f1e7a93eb8">freelist</a> = 0;
<a name="l02096"></a>02096     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a30e591c3106a56c6f76f67d1d4351207">do_heap_free</a> = (size_t)((<a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a> * <a class="code" href="../../d8/d16/gc_8c.html#a82e0c515bb2727a22897b61364edf3dc">HEAP_OBJ_LIMIT</a>) * 0.65);
<a name="l02097"></a>02097     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af80cd8ad8d90eb656684764436c94eab">free_min</a> = (size_t)((<a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a> * HEAP_OBJ_LIMIT)  * 0.2);
<a name="l02098"></a>02098     <span class="keywordflow">if</span> (objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af80cd8ad8d90eb656684764436c94eab">free_min</a> &lt; <a class="code" href="../../d8/d16/gc_8c.html#a92ac65c13d9b117db8b96ae052c6ba09">initial_free_min</a>) {
<a name="l02099"></a>02099         objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a30e591c3106a56c6f76f67d1d4351207">do_heap_free</a> = <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a> * HEAP_OBJ_LIMIT;
<a name="l02100"></a>02100         objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af80cd8ad8d90eb656684764436c94eab">free_min</a> = <a class="code" href="../../d8/d16/gc_8c.html#a92ac65c13d9b117db8b96ae052c6ba09">initial_free_min</a>;
<a name="l02101"></a>02101     }
<a name="l02102"></a>02102     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">sweep_slots</a> = <a class="code" href="../../d8/d16/gc_8c.html#a3eb89961b2be51932ecadee6b63963ba">heaps</a>;
<a name="l02103"></a>02103     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#adae35865d1de5847544a532a63c451fa">free_num</a> = 0;
<a name="l02104"></a>02104 
<a name="l02105"></a>02105     <span class="comment">/* sweep unlinked method entries */</span>
<a name="l02106"></a>02106     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a6cfcd3997994924c8cd13c3b5c099ec6">GET_VM</a>()-&gt;unlinked_method_entry_list) {
<a name="l02107"></a>02107         <a class="code" href="../../db/d0a/method_8h.html#ad9ab3245b7b5f28802c3f74d1b30a949">rb_sweep_method_entry</a>(<a class="code" href="../../d8/d32/vm__core_8h.html#a6cfcd3997994924c8cd13c3b5c099ec6">GET_VM</a>());
<a name="l02108"></a>02108     }
<a name="l02109"></a>02109 }
<a name="l02110"></a>02110 
<a name="l02111"></a>02111 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02112"></a><a class="code" href="../../d8/d16/gc_8c.html#a451e4beefe1d0525f8314d4220552a1e">02112</a> <a class="code" href="../../d8/d16/gc_8c.html#a451e4beefe1d0525f8314d4220552a1e">after_gc_sweep</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l02113"></a>02113 {
<a name="l02114"></a>02114     <a class="code" href="../../d8/d16/gc_8c.html#a5a00da4dda7d71ac309d078a8e537970">GC_PROF_SET_MALLOC_INFO</a>;
<a name="l02115"></a>02115 
<a name="l02116"></a>02116     <span class="keywordflow">if</span> (objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#adae35865d1de5847544a532a63c451fa">free_num</a> &lt; objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af80cd8ad8d90eb656684764436c94eab">free_min</a>) {
<a name="l02117"></a>02117         <a class="code" href="../../d8/d16/gc_8c.html#a0573de72950f16e074f90eb6cebe798e">set_heaps_increment</a>(objspace);
<a name="l02118"></a>02118         <a class="code" href="../../d8/d16/gc_8c.html#a4c82c9dea941e571de0ef59457d2810a">heaps_increment</a>(objspace);
<a name="l02119"></a>02119     }
<a name="l02120"></a>02120 
<a name="l02121"></a>02121     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#aef6ccce3587ce02d07ba0c720776f889">malloc_increase</a> &gt; <a class="code" href="../../d8/d16/gc_8c.html#a8bcd401e2531e938e512cfb2e30dd4e6">malloc_limit</a>) {
<a name="l02122"></a>02122         <a class="code" href="../../d8/d16/gc_8c.html#a8bcd401e2531e938e512cfb2e30dd4e6">malloc_limit</a> += (size_t)((<a class="code" href="../../d8/d16/gc_8c.html#aef6ccce3587ce02d07ba0c720776f889">malloc_increase</a> - <a class="code" href="../../d8/d16/gc_8c.html#a8bcd401e2531e938e512cfb2e30dd4e6">malloc_limit</a>) * (double)objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a18e3fbf186b1889395e01baebaa4d8e5">live_num</a> / (<a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a> * <a class="code" href="../../d8/d16/gc_8c.html#a82e0c515bb2727a22897b61364edf3dc">HEAP_OBJ_LIMIT</a>));
<a name="l02123"></a>02123         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a8bcd401e2531e938e512cfb2e30dd4e6">malloc_limit</a> &lt; <a class="code" href="../../d8/d16/gc_8c.html#a2f761e8733e04a9982316226de3bae1d">initial_malloc_limit</a>) <a class="code" href="../../d8/d16/gc_8c.html#a8bcd401e2531e938e512cfb2e30dd4e6">malloc_limit</a> = <a class="code" href="../../d8/d16/gc_8c.html#a2f761e8733e04a9982316226de3bae1d">initial_malloc_limit</a>;
<a name="l02124"></a>02124     }
<a name="l02125"></a>02125     <a class="code" href="../../d8/d16/gc_8c.html#aef6ccce3587ce02d07ba0c720776f889">malloc_increase</a> = 0;
<a name="l02126"></a>02126 
<a name="l02127"></a>02127     <a class="code" href="../../d8/d16/gc_8c.html#a56d5d60ded6c80b927508340f4211373">free_unused_heaps</a>(objspace);
<a name="l02128"></a>02128 }
<a name="l02129"></a>02129 
<a name="l02130"></a>02130 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02131"></a><a class="code" href="../../d8/d16/gc_8c.html#a2540ee5bf88b2f34551ea9ec78350594">02131</a> <a class="code" href="../../d8/d16/gc_8c.html#a2540ee5bf88b2f34551ea9ec78350594">lazy_sweep</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l02132"></a>02132 {
<a name="l02133"></a>02133     <span class="keyword">struct </span><a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a> *next;
<a name="l02134"></a>02134 
<a name="l02135"></a>02135     <a class="code" href="../../d8/d16/gc_8c.html#a4c82c9dea941e571de0ef59457d2810a">heaps_increment</a>(objspace);
<a name="l02136"></a>02136     <span class="keywordflow">while</span> (objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">sweep_slots</a>) {
<a name="l02137"></a>02137         next = objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">sweep_slots</a>-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a369e6ce2c28e10e149c964d374fc7c27">next</a>;
<a name="l02138"></a>02138         <a class="code" href="../../d8/d16/gc_8c.html#af13cde662aad9d628f5152fb09bddd3a">slot_sweep</a>(objspace, objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">sweep_slots</a>);
<a name="l02139"></a>02139         objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">sweep_slots</a> = next;
<a name="l02140"></a>02140         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a896e77038c659ca416b686f1e7a93eb8">freelist</a>) {
<a name="l02141"></a>02141             <a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a> = 0;
<a name="l02142"></a>02142             <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02143"></a>02143         }
<a name="l02144"></a>02144     }
<a name="l02145"></a>02145     <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02146"></a>02146 }
<a name="l02147"></a>02147 
<a name="l02148"></a>02148 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02149"></a><a class="code" href="../../d8/d16/gc_8c.html#ab33ac0d8116118bd4eb59677ec4c3fe2">02149</a> <a class="code" href="../../d8/d16/gc_8c.html#ab33ac0d8116118bd4eb59677ec4c3fe2">rest_sweep</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l02150"></a>02150 {
<a name="l02151"></a>02151     <span class="keywordflow">if</span> (objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">sweep_slots</a>) {
<a name="l02152"></a>02152        <span class="keywordflow">while</span> (objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">sweep_slots</a>) {
<a name="l02153"></a>02153            <a class="code" href="../../d8/d16/gc_8c.html#a2540ee5bf88b2f34551ea9ec78350594">lazy_sweep</a>(objspace);
<a name="l02154"></a>02154        }
<a name="l02155"></a>02155        <a class="code" href="../../d8/d16/gc_8c.html#a451e4beefe1d0525f8314d4220552a1e">after_gc_sweep</a>(objspace);
<a name="l02156"></a>02156     }
<a name="l02157"></a>02157 }
<a name="l02158"></a>02158 
<a name="l02159"></a>02159 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d8/d16/gc_8c.html#a37430ca39daeb0e10e979ee8a081f79e">gc_marks</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace);
<a name="l02160"></a>02160 
<a name="l02161"></a>02161 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02162"></a><a class="code" href="../../d8/d16/gc_8c.html#a8a4293c49811c85d724070323c80c7b7">02162</a> <a class="code" href="../../d8/d16/gc_8c.html#a8a4293c49811c85d724070323c80c7b7">gc_lazy_sweep</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l02163"></a>02163 {
<a name="l02164"></a>02164     <span class="keywordtype">int</span> res;
<a name="l02165"></a>02165     <a class="code" href="../../d8/d16/gc_8c.html#adcecd8929620c2efedc87d949f9d70c7">INIT_GC_PROF_PARAMS</a>;
<a name="l02166"></a>02166 
<a name="l02167"></a>02167     <span class="keywordflow">if</span> (objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#aba26cb1da0cbb0aa583f9947a5337b8f">flags</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a4d7a47226a51a21ac62139d9729c2cbe">dont_lazy_sweep</a>)
<a name="l02168"></a>02168         <span class="keywordflow">return</span> <a class="code" href="../../d8/d16/gc_8c.html#ae40ead8ed1ce1ae638710978a3fc8ff3">garbage_collect</a>(objspace);
<a name="l02169"></a>02169 
<a name="l02170"></a>02170 
<a name="l02171"></a>02171     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d16/gc_8c.html#a8b36b35fc92a92063db78b31a87d9e58">ready_to_gc</a>(objspace)) <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02172"></a>02172 
<a name="l02173"></a>02173     <a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a>++;
<a name="l02174"></a>02174     <a class="code" href="../../d8/d16/gc_8c.html#a0f4426fd7b01c2bf74b429c4d38c69ed">GC_PROF_TIMER_START</a>;
<a name="l02175"></a>02175     <a class="code" href="../../d8/d16/gc_8c.html#a7628bfffdd08c29df946bd922179f9ca">GC_PROF_SWEEP_TIMER_START</a>;
<a name="l02176"></a>02176 
<a name="l02177"></a>02177     <span class="keywordflow">if</span> (objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">sweep_slots</a>) {
<a name="l02178"></a>02178         res = <a class="code" href="../../d8/d16/gc_8c.html#a2540ee5bf88b2f34551ea9ec78350594">lazy_sweep</a>(objspace);
<a name="l02179"></a>02179         <span class="keywordflow">if</span> (res) {
<a name="l02180"></a>02180             <a class="code" href="../../d8/d16/gc_8c.html#a4c6e2653b932903b441b181b5a98ef51">GC_PROF_SWEEP_TIMER_STOP</a>;
<a name="l02181"></a>02181             <a class="code" href="../../d8/d16/gc_8c.html#a5a00da4dda7d71ac309d078a8e537970">GC_PROF_SET_MALLOC_INFO</a>;
<a name="l02182"></a>02182             <a class="code" href="../../d8/d16/gc_8c.html#afd036d5f19b0b4d1b0ba75654fd85b72">GC_PROF_TIMER_STOP</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l02183"></a>02183             <span class="keywordflow">return</span> res;
<a name="l02184"></a>02184         }
<a name="l02185"></a>02185         <a class="code" href="../../d8/d16/gc_8c.html#a451e4beefe1d0525f8314d4220552a1e">after_gc_sweep</a>(objspace);
<a name="l02186"></a>02186     }
<a name="l02187"></a>02187     <span class="keywordflow">else</span> {
<a name="l02188"></a>02188         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a4c82c9dea941e571de0ef59457d2810a">heaps_increment</a>(objspace)) {
<a name="l02189"></a>02189             <a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a> = 0;
<a name="l02190"></a>02190             <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02191"></a>02191         }
<a name="l02192"></a>02192     }
<a name="l02193"></a>02193 
<a name="l02194"></a>02194     <a class="code" href="../../d8/d16/gc_8c.html#a37430ca39daeb0e10e979ee8a081f79e">gc_marks</a>(objspace);
<a name="l02195"></a>02195 
<a name="l02196"></a>02196     <a class="code" href="../../d8/d16/gc_8c.html#ae968442157aa672e11a305e08257066f">before_gc_sweep</a>(objspace);
<a name="l02197"></a>02197     <span class="keywordflow">if</span> (objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af80cd8ad8d90eb656684764436c94eab">free_min</a> &gt; (<a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a> * <a class="code" href="../../d8/d16/gc_8c.html#a82e0c515bb2727a22897b61364edf3dc">HEAP_OBJ_LIMIT</a> - objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a18e3fbf186b1889395e01baebaa4d8e5">live_num</a>)) {
<a name="l02198"></a>02198         <a class="code" href="../../d8/d16/gc_8c.html#a0573de72950f16e074f90eb6cebe798e">set_heaps_increment</a>(objspace);
<a name="l02199"></a>02199     }
<a name="l02200"></a>02200 
<a name="l02201"></a>02201     <a class="code" href="../../d8/d16/gc_8c.html#a7628bfffdd08c29df946bd922179f9ca">GC_PROF_SWEEP_TIMER_START</a>;
<a name="l02202"></a>02202     <span class="keywordflow">if</span>(!(res = <a class="code" href="../../d8/d16/gc_8c.html#a2540ee5bf88b2f34551ea9ec78350594">lazy_sweep</a>(objspace))) {
<a name="l02203"></a>02203         <a class="code" href="../../d8/d16/gc_8c.html#a451e4beefe1d0525f8314d4220552a1e">after_gc_sweep</a>(objspace);
<a name="l02204"></a>02204         <span class="keywordflow">if</span>(<a class="code" href="../../d8/d16/gc_8c.html#a896e77038c659ca416b686f1e7a93eb8">freelist</a>) {
<a name="l02205"></a>02205             res = <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02206"></a>02206             <a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a> = 0;
<a name="l02207"></a>02207         }
<a name="l02208"></a>02208     }
<a name="l02209"></a>02209     <a class="code" href="../../d8/d16/gc_8c.html#a4c6e2653b932903b441b181b5a98ef51">GC_PROF_SWEEP_TIMER_STOP</a>;
<a name="l02210"></a>02210 
<a name="l02211"></a>02211     <a class="code" href="../../d8/d16/gc_8c.html#afd036d5f19b0b4d1b0ba75654fd85b72">GC_PROF_TIMER_STOP</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>);
<a name="l02212"></a>02212     <span class="keywordflow">return</span> res;
<a name="l02213"></a>02213 }
<a name="l02214"></a>02214 
<a name="l02215"></a>02215 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02216"></a><a class="code" href="../../d8/d16/gc_8c.html#a76b02cd914ceb682ce9c9e3ab7235283">02216</a> <a class="code" href="../../d8/d16/gc_8c.html#a76b02cd914ceb682ce9c9e3ab7235283">gc_sweep</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l02217"></a>02217 {
<a name="l02218"></a>02218     <span class="keyword">struct </span><a class="code" href="../../da/dda/structheaps__slot.html">heaps_slot</a> *next;
<a name="l02219"></a>02219 
<a name="l02220"></a>02220     <a class="code" href="../../d8/d16/gc_8c.html#ae968442157aa672e11a305e08257066f">before_gc_sweep</a>(objspace);
<a name="l02221"></a>02221 
<a name="l02222"></a>02222     <span class="keywordflow">while</span> (objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">sweep_slots</a>) {
<a name="l02223"></a>02223         next = objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">sweep_slots</a>-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a369e6ce2c28e10e149c964d374fc7c27">next</a>;
<a name="l02224"></a>02224         <a class="code" href="../../d8/d16/gc_8c.html#af13cde662aad9d628f5152fb09bddd3a">slot_sweep</a>(objspace, objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">sweep_slots</a>);
<a name="l02225"></a>02225         objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab153985f9baa6bd6e57350e77ae4bae4">sweep_slots</a> = next;
<a name="l02226"></a>02226     }
<a name="l02227"></a>02227 
<a name="l02228"></a>02228     <a class="code" href="../../d8/d16/gc_8c.html#a451e4beefe1d0525f8314d4220552a1e">after_gc_sweep</a>(objspace);
<a name="l02229"></a>02229 
<a name="l02230"></a>02230     <a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a> = 0;
<a name="l02231"></a>02231 }
<a name="l02232"></a>02232 
<a name="l02233"></a>02233 <span class="keywordtype">void</span>
<a name="l02234"></a><a class="code" href="../../db/d2e/intern_8h.html#ac93c86c78fb19a534843660eb5642fab">02234</a> <a class="code" href="../../d8/d16/gc_8c.html#a53016811c87ff4c3ea839c9e85a9a9a4">rb_gc_force_recycle</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> p)
<a name="l02235"></a>02235 {
<a name="l02236"></a>02236     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l02237"></a>02237     <a class="code" href="../../d8/d16/gc_8c.html#a099dbbf45d09b64ccea651186b19fc68">GC_PROF_DEC_LIVE_NUM</a>;
<a name="l02238"></a>02238     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1d4c05021aacd8cab989ff60f95ebe2d">RBASIC</a>(p)-&gt;flags &amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a39ebc82a159cc4776f6ca7037cbd2e26">FL_MARK</a>) {
<a name="l02239"></a>02239         <a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(p)-&gt;as.free.flags = 0;
<a name="l02240"></a>02240     }
<a name="l02241"></a>02241     <span class="keywordflow">else</span> {
<a name="l02242"></a>02242         <a class="code" href="../../d8/d16/gc_8c.html#a2e1258f08c3958e131561d2452d62413">add_freelist</a>(objspace, (<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *)p);
<a name="l02243"></a>02243     }
<a name="l02244"></a>02244 }
<a name="l02245"></a>02245 
<a name="l02246"></a>02246 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l02247"></a><a class="code" href="../../d8/d16/gc_8c.html#a240b3f2bf37a7bae8d4f43018cba0387">02247</a> <a class="code" href="../../d8/d16/gc_8c.html#a240b3f2bf37a7bae8d4f43018cba0387">make_deferred</a>(<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *p)
<a name="l02248"></a>02248 {
<a name="l02249"></a>02249     p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a> = (p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a> &amp; ~<a class="code" href="../../d7/d6c/md5_8c.html#a2d8a5083a030f6b36bc9a5fe6d71b519">T_MASK</a>) | <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ab80c70472770bcae8d33bbf6139262d0">T_ZOMBIE</a>;
<a name="l02250"></a>02250 }
<a name="l02251"></a>02251 
<a name="l02252"></a>02252 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l02253"></a><a class="code" href="../../d8/d16/gc_8c.html#aad601bcf0ca8b959ec5d7327b98e6dbc">02253</a> <a class="code" href="../../d8/d16/gc_8c.html#aad601bcf0ca8b959ec5d7327b98e6dbc">make_io_deferred</a>(<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *p)
<a name="l02254"></a>02254 {
<a name="l02255"></a>02255     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr = p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a97cd726dd7aa22970264f034cd494c99">file</a>.<a class="code" href="../../de/d5d/struct_r_file.html#a6c4c7ce6825193998a35110535111d4e">fptr</a>;
<a name="l02256"></a>02256     <a class="code" href="../../d8/d16/gc_8c.html#a240b3f2bf37a7bae8d4f43018cba0387">make_deferred</a>(p);
<a name="l02257"></a>02257     p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a2a582321ccfa06c0485977c88de71d2d">data</a>.<a class="code" href="../../d0/dcf/struct_r_data.html#a75adc0410251bf6099208ccc68f3ef81">dfree</a> = (void (*)(<span class="keywordtype">void</span>*))<a class="code" href="../../dc/dac/io_8h.html#a6fc4023c7b0bced3b799f7300913de28">rb_io_fptr_finalize</a>;
<a name="l02258"></a>02258     p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a2a582321ccfa06c0485977c88de71d2d">data</a>.<a class="code" href="../../d0/dcf/struct_r_data.html#a6be39add744656d1ae948d056dfdbc0e">data</a> = fptr;
<a name="l02259"></a>02259 }
<a name="l02260"></a>02260 
<a name="l02261"></a>02261 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02262"></a><a class="code" href="../../d8/d16/gc_8c.html#a775c65b64712d2910826aed291ba8f48">02262</a> <a class="code" href="../../d8/d16/gc_8c.html#a775c65b64712d2910826aed291ba8f48">obj_free</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj)
<a name="l02263"></a>02263 {
<a name="l02264"></a>02264     <span class="keywordflow">switch</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(obj)) {
<a name="l02265"></a>02265       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3a7d10c48d5dff0a5d4aa94acb74811a">T_NIL</a>:
<a name="l02266"></a>02266       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a523855de5546c34061e030f4606db3e9">T_FIXNUM</a>:
<a name="l02267"></a>02267       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7fc7e09f45d0ef129ea29f3a5b0c32b8">T_TRUE</a>:
<a name="l02268"></a>02268       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9ab816c37c9173898ff256b7be9e5ea9">T_FALSE</a>:
<a name="l02269"></a>02269         <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;obj_free() called for broken object&quot;</span>);
<a name="l02270"></a>02270         <span class="keywordflow">break</span>;
<a name="l02271"></a>02271     }
<a name="l02272"></a>02272 
<a name="l02273"></a>02273     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1ae918b6cc84188a9dc6ab545f732e4d">FL_TEST</a>(obj, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0eecbc9617756148ca4e1c4c0a8c9de6">FL_EXIVAR</a>)) {
<a name="l02274"></a>02274         <a class="code" href="../../db/d2e/intern_8h.html#a3d37a1a46f14639236b17649070973b5">rb_free_generic_ivar</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)obj);
<a name="l02275"></a>02275         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6db7676c6cc4059a7cf021be34f53840">FL_UNSET</a>(obj, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0eecbc9617756148ca4e1c4c0a8c9de6">FL_EXIVAR</a>);
<a name="l02276"></a>02276     }
<a name="l02277"></a>02277 
<a name="l02278"></a>02278     <span class="keywordflow">switch</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(obj)) {
<a name="l02279"></a>02279       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abed71c72d5c3083041d52ad25630270e">T_OBJECT</a>:
<a name="l02280"></a>02280         <span class="keywordflow">if</span> (!(<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.basic.flags &amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a49df79f2c7c1ec147dad9a122de1a7d7">ROBJECT_EMBED</a>) &amp;&amp;
<a name="l02281"></a>02281             <a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.object.as.heap.ivptr) {
<a name="l02282"></a>02282             <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.object.as.heap.ivptr);
<a name="l02283"></a>02283         }
<a name="l02284"></a>02284         <span class="keywordflow">break</span>;
<a name="l02285"></a>02285       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6cdc7dfe8f84777325da08a96ae5f795">T_MODULE</a>:
<a name="l02286"></a>02286       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad04c63d175774c6d6e7dfaf0f0a982c9">T_CLASS</a>:
<a name="l02287"></a>02287         <a class="code" href="../../db/d2e/intern_8h.html#a63f782fac47f7ec90e09a6ba971fe7bf">rb_clear_cache_by_class</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)obj);
<a name="l02288"></a>02288         <a class="code" href="../../d8/d16/gc_8c.html#ab38e8b9b35211acb88ff3f8d2070be9f">rb_free_m_table</a>(<a class="code" href="../../d3/d09/ripper_8y.html#ab59ea80cdf15f3f19bbae0346314c9ad">RCLASS_M_TBL</a>(obj));
<a name="l02289"></a>02289         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d09/ripper_8y.html#a7f7f2dbf958976d9bf317167396992d4">RCLASS_IV_TBL</a>(obj)) {
<a name="l02290"></a>02290             <a class="code" href="../../dd/d24/st_8h.html#acb004847ef312373d65bfb0d1a21c5b3">st_free_table</a>(<a class="code" href="../../d3/d09/ripper_8y.html#a7f7f2dbf958976d9bf317167396992d4">RCLASS_IV_TBL</a>(obj));
<a name="l02291"></a>02291         }
<a name="l02292"></a>02292         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d09/ripper_8y.html#a9dfcc3730f2a2a5ef643c2b6c3e606d1">RCLASS_CONST_TBL</a>(obj)) {
<a name="l02293"></a>02293             <a class="code" href="../../dd/d17/constant_8h.html#ac0930709fa9ea2985f4513b9ea1631eb">rb_free_const_table</a>(<a class="code" href="../../d3/d09/ripper_8y.html#a9dfcc3730f2a2a5ef643c2b6c3e606d1">RCLASS_CONST_TBL</a>(obj));
<a name="l02294"></a>02294         }
<a name="l02295"></a>02295         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d09/ripper_8y.html#ae5267dcfc60a00436251a80cbee8455f">RCLASS_IV_INDEX_TBL</a>(obj)) {
<a name="l02296"></a>02296             <a class="code" href="../../dd/d24/st_8h.html#acb004847ef312373d65bfb0d1a21c5b3">st_free_table</a>(<a class="code" href="../../d3/d09/ripper_8y.html#ae5267dcfc60a00436251a80cbee8455f">RCLASS_IV_INDEX_TBL</a>(obj));
<a name="l02297"></a>02297         }
<a name="l02298"></a>02298         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.klass.ptr);
<a name="l02299"></a>02299         <span class="keywordflow">break</span>;
<a name="l02300"></a>02300       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a22a8c2a4bbaae9b68f65c9bb92fd4e39">T_STRING</a>:
<a name="l02301"></a>02301         <a class="code" href="../../db/d2e/intern_8h.html#a62f03b299bc2bbe479e3ab3c3ca76ad0">rb_str_free</a>(obj);
<a name="l02302"></a>02302         <span class="keywordflow">break</span>;
<a name="l02303"></a>02303       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a>:
<a name="l02304"></a>02304         <a class="code" href="../../dc/dcc/array_8c.html#a5c6b248d971f78b215844c60cdb00020">rb_ary_free</a>(obj);
<a name="l02305"></a>02305         <span class="keywordflow">break</span>;
<a name="l02306"></a>02306       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8357e81bbb60cb41b0a292a90653a5e5">T_HASH</a>:
<a name="l02307"></a>02307         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.hash.ntbl) {
<a name="l02308"></a>02308             <a class="code" href="../../dd/d24/st_8h.html#acb004847ef312373d65bfb0d1a21c5b3">st_free_table</a>(<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.hash.ntbl);
<a name="l02309"></a>02309         }
<a name="l02310"></a>02310         <span class="keywordflow">break</span>;
<a name="l02311"></a>02311       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afd5c1e36d171ecc04514332e8dcf6388">T_REGEXP</a>:
<a name="l02312"></a>02312         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.regexp.ptr) {
<a name="l02313"></a>02313             <a class="code" href="../../d0/d86/regcomp_8c.html#ac84095b31018b2fe291a31408179ae07">onig_free</a>(<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.regexp.ptr);
<a name="l02314"></a>02314         }
<a name="l02315"></a>02315         <span class="keywordflow">break</span>;
<a name="l02316"></a>02316       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a55f295817faf14e42b3cff745a7ac706">T_DATA</a>:
<a name="l02317"></a>02317         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#abb509cfdf6560a9f795b1f6932d93691">DATA_PTR</a>(obj)) {
<a name="l02318"></a>02318             <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac167240ec598e32f5ff3cdb902fb98b9">RTYPEDDATA_P</a>(obj)) {
<a name="l02319"></a>02319                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa38eb1376d31aae1fe0b334b9b76f2ef">RDATA</a>(obj)-&gt;dfree = <a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.typeddata.type-&gt;function.dfree;
<a name="l02320"></a>02320             }
<a name="l02321"></a>02321             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.data.dfree == (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad83646c4b210a82fc3d1a1e723ffc931">RUBY_DATA_FUNC</a>)-1) {
<a name="l02322"></a>02322                 <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#abb509cfdf6560a9f795b1f6932d93691">DATA_PTR</a>(obj));
<a name="l02323"></a>02323             }
<a name="l02324"></a>02324             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.data.dfree) {
<a name="l02325"></a>02325                 <a class="code" href="../../d8/d16/gc_8c.html#a240b3f2bf37a7bae8d4f43018cba0387">make_deferred</a>(<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj));
<a name="l02326"></a>02326                 <span class="keywordflow">return</span> 1;
<a name="l02327"></a>02327             }
<a name="l02328"></a>02328         }
<a name="l02329"></a>02329         <span class="keywordflow">break</span>;
<a name="l02330"></a>02330       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#acc66e9c9228bc7ad6f292a253ce5fdf4">T_MATCH</a>:
<a name="l02331"></a>02331         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.match.rmatch) {
<a name="l02332"></a>02332             <span class="keyword">struct </span><a class="code" href="../../d8/d5b/structrmatch.html">rmatch</a> *rm = <a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.match.rmatch;
<a name="l02333"></a>02333             <a class="code" href="../../db/d4b/regexec_8c.html#a4d0f148a95d73dd950fd2a09654fa9c7">onig_region_free</a>(&amp;rm-&gt;<a class="code" href="../../d8/d5b/structrmatch.html#a4dcfcb4bcfe057ae528a24651a920bb0">regs</a>, 0);
<a name="l02334"></a>02334             <span class="keywordflow">if</span> (rm-&gt;<a class="code" href="../../d8/d5b/structrmatch.html#a2c4aaf35e7aad9abdacaa8354810e85a">char_offset</a>)
<a name="l02335"></a>02335                 <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(rm-&gt;<a class="code" href="../../d8/d5b/structrmatch.html#a2c4aaf35e7aad9abdacaa8354810e85a">char_offset</a>);
<a name="l02336"></a>02336             <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(rm);
<a name="l02337"></a>02337         }
<a name="l02338"></a>02338         <span class="keywordflow">break</span>;
<a name="l02339"></a>02339       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a>:
<a name="l02340"></a>02340         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.file.fptr) {
<a name="l02341"></a>02341             <a class="code" href="../../d8/d16/gc_8c.html#aad601bcf0ca8b959ec5d7327b98e6dbc">make_io_deferred</a>(<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj));
<a name="l02342"></a>02342             <span class="keywordflow">return</span> 1;
<a name="l02343"></a>02343         }
<a name="l02344"></a>02344         <span class="keywordflow">break</span>;
<a name="l02345"></a>02345       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a804d1259cf2408f16969b2dc06b293fc">T_RATIONAL</a>:
<a name="l02346"></a>02346       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a05f3b14562e8d1e2d09e7a4438c1d2fa">T_COMPLEX</a>:
<a name="l02347"></a>02347         <span class="keywordflow">break</span>;
<a name="l02348"></a>02348       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a82c8c4569748b9645c958b9eaeaabb81">T_ICLASS</a>:
<a name="l02349"></a>02349         <span class="comment">/* iClass shares table with the module */</span>
<a name="l02350"></a>02350         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.klass.ptr);
<a name="l02351"></a>02351         <span class="keywordflow">break</span>;
<a name="l02352"></a>02352 
<a name="l02353"></a>02353       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3d072e0c25cf678e9b8601b957b92eae">T_FLOAT</a>:
<a name="l02354"></a>02354         <span class="keywordflow">break</span>;
<a name="l02355"></a>02355 
<a name="l02356"></a>02356       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a41ac74a27dd1eadc2ca86d10590f2163">T_BIGNUM</a>:
<a name="l02357"></a>02357         <span class="keywordflow">if</span> (!(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1d4c05021aacd8cab989ff60f95ebe2d">RBASIC</a>(obj)-&gt;flags &amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad6856192451c57b81debeb24282a11c8">RBIGNUM_EMBED_FLAG</a>) &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a59c00018ecd3df95bd35b33fd65eba6d">RBIGNUM_DIGITS</a>(obj)) {
<a name="l02358"></a>02358             <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a59c00018ecd3df95bd35b33fd65eba6d">RBIGNUM_DIGITS</a>(obj));
<a name="l02359"></a>02359         }
<a name="l02360"></a>02360         <span class="keywordflow">break</span>;
<a name="l02361"></a>02361       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5f1cc49c4da51d5bdffa64be79ff6fb0">T_NODE</a>:
<a name="l02362"></a>02362         <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d09/ripper_8y.html#ade12c589b26f55f089dc25d689249c11">nd_type</a>(obj)) {
<a name="l02363"></a>02363           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#ac6983f7134e356786ebe01ddea8985cd">NODE_SCOPE</a>:
<a name="l02364"></a>02364             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.node.u1.tbl) {
<a name="l02365"></a>02365                 <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.node.u1.tbl);
<a name="l02366"></a>02366             }
<a name="l02367"></a>02367             <span class="keywordflow">break</span>;
<a name="l02368"></a>02368           <span class="keywordflow">case</span> <a class="code" href="../../d3/d09/ripper_8y.html#afe798b4130b52162a6b58ff378c4a83e">NODE_ALLOCA</a>:
<a name="l02369"></a>02369             <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.node.u1.node);
<a name="l02370"></a>02370             <span class="keywordflow">break</span>;
<a name="l02371"></a>02371         }
<a name="l02372"></a>02372         <span class="keywordflow">break</span>;                  <span class="comment">/* no need to free iv_tbl */</span>
<a name="l02373"></a>02373 
<a name="l02374"></a>02374       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4853f60a017b2b7a126d3e23db98a954">T_STRUCT</a>:
<a name="l02375"></a>02375         <span class="keywordflow">if</span> ((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1d4c05021aacd8cab989ff60f95ebe2d">RBASIC</a>(obj)-&gt;flags &amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a35cd6a4e08e17baf58c79050acb6978c">RSTRUCT_EMBED_LEN_MASK</a>) == 0 &amp;&amp;
<a name="l02376"></a>02376             <a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.rstruct.as.heap.ptr) {
<a name="l02377"></a>02377             <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(obj)-&gt;as.rstruct.as.heap.ptr);
<a name="l02378"></a>02378         }
<a name="l02379"></a>02379         <span class="keywordflow">break</span>;
<a name="l02380"></a>02380 
<a name="l02381"></a>02381       <span class="keywordflow">default</span>:
<a name="l02382"></a>02382         <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;gc_sweep(): unknown data type 0x%x(%p)&quot;</span>,
<a name="l02383"></a>02383                <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(obj), (<span class="keywordtype">void</span>*)obj);
<a name="l02384"></a>02384     }
<a name="l02385"></a>02385 
<a name="l02386"></a>02386     <span class="keywordflow">return</span> 0;
<a name="l02387"></a>02387 }
<a name="l02388"></a>02388 
<a name="l02389"></a><a class="code" href="../../d8/d16/gc_8c.html#aaeacd6016aa6c32604c1a00a7511ef55">02389</a> <span class="preprocessor">#define GC_NOTIFY 0</span>
<a name="l02390"></a>02390 <span class="preprocessor"></span>
<a name="l02391"></a>02391 <span class="preprocessor">#if STACK_GROW_DIRECTION &lt; 0</span>
<a name="l02392"></a>02392 <span class="preprocessor"></span><span class="preprocessor">#define GET_STACK_BOUNDS(start, end, appendix) ((start) = STACK_END, (end) = STACK_START)</span>
<a name="l02393"></a>02393 <span class="preprocessor"></span><span class="preprocessor">#elif STACK_GROW_DIRECTION &gt; 0</span>
<a name="l02394"></a>02394 <span class="preprocessor"></span><span class="preprocessor">#define GET_STACK_BOUNDS(start, end, appendix) ((start) = STACK_START, (end) = STACK_END+(appendix))</span>
<a name="l02395"></a>02395 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l02396"></a><a class="code" href="../../d8/d16/gc_8c.html#a86ec6dc57e82696d536f32a2fe1b96a9">02396</a> <span class="preprocessor"></span><span class="preprocessor">#define GET_STACK_BOUNDS(start, end, appendix) \</span>
<a name="l02397"></a>02397 <span class="preprocessor">    ((STACK_END &lt; STACK_START) ? \</span>
<a name="l02398"></a>02398 <span class="preprocessor">     ((start) = STACK_END, (end) = STACK_START) : ((start) = STACK_START, (end) = STACK_END+(appendix)))</span>
<a name="l02399"></a>02399 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l02400"></a>02400 <span class="preprocessor"></span>
<a name="l02401"></a><a class="code" href="../../d8/d16/gc_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">02401</a> <span class="preprocessor">#define numberof(array) (int)(sizeof(array) / sizeof((array)[0]))</span>
<a name="l02402"></a>02402 <span class="preprocessor"></span>
<a name="l02403"></a>02403 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02404"></a><a class="code" href="../../d8/d16/gc_8c.html#ad53830cb5243db89d9bf3f7064162488">02404</a> <a class="code" href="../../d8/d16/gc_8c.html#ad53830cb5243db89d9bf3f7064162488">mark_current_machine_context</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l02405"></a>02405 {
<a name="l02406"></a>02406     <span class="keyword">union </span>{
<a name="l02407"></a>02407         <a class="code" href="../../d8/d16/gc_8c.html#af6a4d0fda9a5b91dee22b1cfdbbb7164">rb_jmp_buf</a> j;
<a name="l02408"></a>02408         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v[<span class="keyword">sizeof</span>(<a class="code" href="../../d8/d16/gc_8c.html#af6a4d0fda9a5b91dee22b1cfdbbb7164">rb_jmp_buf</a>) / <span class="keyword">sizeof</span>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)];
<a name="l02409"></a>02409     } save_regs_gc_mark;
<a name="l02410"></a>02410     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../d1/d1c/thread__pthread_8c.html#aafba1985311b4e67c8c0b4e2ef09ab72">stack_start</a>, *stack_end;
<a name="l02411"></a>02411 
<a name="l02412"></a>02412     <a class="code" href="../../d8/db0/defines_8h.html#a04dc56188f4c2f0ea9b0cddfcbe2c73d">FLUSH_REGISTER_WINDOWS</a>;
<a name="l02413"></a>02413     <span class="comment">/* This assumes that all registers are saved into the jmp_buf (and stack) */</span>
<a name="l02414"></a>02414     <a class="code" href="../../d8/d16/gc_8c.html#afd9f85d947337cd1ecf3a2ce138feb10">rb_setjmp</a>(save_regs_gc_mark.j);
<a name="l02415"></a>02415 
<a name="l02416"></a>02416     <a class="code" href="../../d8/d16/gc_8c.html#a6c696630f91fd869561b931817456b5f">SET_STACK_END</a>;
<a name="l02417"></a>02417     <a class="code" href="../../d8/d16/gc_8c.html#a86ec6dc57e82696d536f32a2fe1b96a9">GET_STACK_BOUNDS</a>(stack_start, stack_end, 1);
<a name="l02418"></a>02418 
<a name="l02419"></a>02419     <a class="code" href="../../d8/d16/gc_8c.html#af89d492005300beea54a436d1470b652">mark_locations_array</a>(objspace, save_regs_gc_mark.v, <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(save_regs_gc_mark.v));
<a name="l02420"></a>02420 
<a name="l02421"></a>02421     <a class="code" href="../../d8/d16/gc_8c.html#a90e176b7e9d24053977f64a611c1d8bb">rb_gc_mark_locations</a>(stack_start, stack_end);
<a name="l02422"></a>02422 <span class="preprocessor">#ifdef __ia64</span>
<a name="l02423"></a>02423 <span class="preprocessor"></span>    <a class="code" href="../../d8/d16/gc_8c.html#a90e176b7e9d24053977f64a611c1d8bb">rb_gc_mark_locations</a>(th-&gt;machine_register_stack_start, th-&gt;machine_register_stack_end);
<a name="l02424"></a>02424 <span class="preprocessor">#endif</span>
<a name="l02425"></a>02425 <span class="preprocessor"></span><span class="preprocessor">#if defined(__mc68000__)</span>
<a name="l02426"></a>02426 <span class="preprocessor"></span>    <a class="code" href="../../d8/d16/gc_8c.html#af89d492005300beea54a436d1470b652">mark_locations_array</a>(objspace, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>*)((<span class="keywordtype">char</span>*)<a class="code" href="../../d8/d16/gc_8c.html#a0ca05222298465ac22f8f4606f7cb49d">STACK_END</a> + 2),
<a name="l02427"></a>02427                          (<a class="code" href="../../d8/d16/gc_8c.html#a1763c9556bd80b7806528729edc98a05">STACK_START</a> - <a class="code" href="../../d8/d16/gc_8c.html#a0ca05222298465ac22f8f4606f7cb49d">STACK_END</a>));
<a name="l02428"></a>02428 <span class="preprocessor">#endif</span>
<a name="l02429"></a>02429 <span class="preprocessor"></span>}
<a name="l02430"></a>02430 
<a name="l02431"></a>02431 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02432"></a><a class="code" href="../../d8/d16/gc_8c.html#a37430ca39daeb0e10e979ee8a081f79e">02432</a> <a class="code" href="../../d8/d16/gc_8c.html#a37430ca39daeb0e10e979ee8a081f79e">gc_marks</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l02433"></a>02433 {
<a name="l02434"></a>02434     <span class="keyword">struct </span><a class="code" href="../../db/deb/structgc__list.html">gc_list</a> *list;
<a name="l02435"></a>02435     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l02436"></a>02436     <a class="code" href="../../d8/d16/gc_8c.html#afe93f153de1f97b49f8a2cb3534efed5">GC_PROF_MARK_TIMER_START</a>;
<a name="l02437"></a>02437 
<a name="l02438"></a>02438     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a18e3fbf186b1889395e01baebaa4d8e5">live_num</a> = 0;
<a name="l02439"></a>02439     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#ab44b67a8f5128f8aac3c3c340d91d8dd">count</a>++;
<a name="l02440"></a>02440 
<a name="l02441"></a>02441 
<a name="l02442"></a>02442     <a class="code" href="../../d8/d16/gc_8c.html#a6c696630f91fd869561b931817456b5f">SET_STACK_END</a>;
<a name="l02443"></a>02443 
<a name="l02444"></a>02444     <a class="code" href="../../d8/d16/gc_8c.html#a283d577269028c9ba06479ebbbc65c29">init_mark_stack</a>(objspace);
<a name="l02445"></a>02445 
<a name="l02446"></a>02446     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3e7d0b05e2d73f324e70c735ba50739e">vm</a>-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a60a372cceaf16011b6c3d3b6861df36b">self</a> ? <a class="code" href="../../d8/d16/gc_8c.html#a98250264e6adf4924cf2becf80122325">rb_gc_mark</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3e7d0b05e2d73f324e70c735ba50739e">vm</a>-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a60a372cceaf16011b6c3d3b6861df36b">self</a>) : <a class="code" href="../../de/de9/vm_8c.html#a8002db40fa68e94f40fec02f6d7d6ea6">rb_vm_mark</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3e7d0b05e2d73f324e70c735ba50739e">vm</a>);
<a name="l02447"></a>02447 
<a name="l02448"></a>02448     <a class="code" href="../../d8/d16/gc_8c.html#a113604568481126fb9e62cec5ae99257">mark_tbl</a>(objspace, <a class="code" href="../../d8/d16/gc_8c.html#ad42bffe188d60ed392ba783bf4c5e91b">finalizer_table</a>, 0);
<a name="l02449"></a>02449     <a class="code" href="../../d8/d16/gc_8c.html#ad53830cb5243db89d9bf3f7064162488">mark_current_machine_context</a>(objspace, th);
<a name="l02450"></a>02450 
<a name="l02451"></a>02451     <a class="code" href="../../d5/d11/ripper_8c.html#af6c57b43ffd3a787abbb1c96ef23b582">rb_gc_mark_symbols</a>();
<a name="l02452"></a>02452     <a class="code" href="../../d5/db5/encoding_8c.html#a07e81848c79e6f127b05ade8004210b2">rb_gc_mark_encodings</a>();
<a name="l02453"></a>02453 
<a name="l02454"></a>02454     <span class="comment">/* mark protected global variables */</span>
<a name="l02455"></a>02455     <span class="keywordflow">for</span> (list = <a class="code" href="../../d8/d16/gc_8c.html#a24293dffd2d9e073607ec2e58ad90f15">global_List</a>; list; list = list-&gt;<a class="code" href="../../db/deb/structgc__list.html#a57d24fcd3af36e93f16a3bee72773025">next</a>) {
<a name="l02456"></a>02456         <a class="code" href="../../d8/d16/gc_8c.html#a59645c727f2a28c9f86e056159b12fa5">rb_gc_mark_maybe</a>(*list-&gt;<a class="code" href="../../db/deb/structgc__list.html#aa0960ced4053997d8848996b638564c1">varptr</a>);
<a name="l02457"></a>02457     }
<a name="l02458"></a>02458     <a class="code" href="../../d6/d9b/eval__jump_8c.html#a2471c730b71a930bf9dbfb82764181e4">rb_mark_end_proc</a>();
<a name="l02459"></a>02459     <a class="code" href="../../db/d2e/intern_8h.html#a4b58e8d415a4d5ec9df82bfe55c6d474">rb_gc_mark_global_tbl</a>();
<a name="l02460"></a>02460 
<a name="l02461"></a>02461     <a class="code" href="../../d8/d16/gc_8c.html#a113604568481126fb9e62cec5ae99257">mark_tbl</a>(objspace, rb_class_tbl, 0);
<a name="l02462"></a>02462 
<a name="l02463"></a>02463     <span class="comment">/* mark generic instance variables for special constants */</span>
<a name="l02464"></a>02464     <a class="code" href="../../db/d2e/intern_8h.html#ae78389e33072a6602428d7799bb42b2b">rb_mark_generic_ivar_tbl</a>();
<a name="l02465"></a>02465 
<a name="l02466"></a>02466     <a class="code" href="../../d5/d11/ripper_8c.html#a7285d41caf052f74c447b185ae226d8b">rb_gc_mark_parser</a>();
<a name="l02467"></a>02467 
<a name="l02468"></a>02468     <a class="code" href="../../d8/d32/vm__core_8h.html#a8eff8ae2b2df7dba69ca516542b1a708">rb_gc_mark_unlinked_live_method_entries</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3e7d0b05e2d73f324e70c735ba50739e">vm</a>);
<a name="l02469"></a>02469 
<a name="l02470"></a>02470     <span class="comment">/* gc_mark objects whose marking are not completed*/</span>
<a name="l02471"></a>02471     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d16/gc_8c.html#ad89ec7f8fce04e225ec4f872ad9c524a">MARK_STACK_EMPTY</a>) {
<a name="l02472"></a>02472         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#aef4fe92f4edf54293f8676f2c34c0139">mark_stack_overflow</a>) {
<a name="l02473"></a>02473             <a class="code" href="../../d8/d16/gc_8c.html#abe497043b3fbcd6a2d72a48a4926b2aa">gc_mark_all</a>(objspace);
<a name="l02474"></a>02474         }
<a name="l02475"></a>02475         <span class="keywordflow">else</span> {
<a name="l02476"></a>02476             <a class="code" href="../../d8/d16/gc_8c.html#a751d57c89cc3a17769525bc7e3c71550">gc_mark_rest</a>(objspace);
<a name="l02477"></a>02477         }
<a name="l02478"></a>02478     }
<a name="l02479"></a>02479     <a class="code" href="../../d8/d16/gc_8c.html#a3c5e604aecb72dc1c35a647ee880686d">GC_PROF_MARK_TIMER_STOP</a>;
<a name="l02480"></a>02480 }
<a name="l02481"></a>02481 
<a name="l02482"></a>02482 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02483"></a><a class="code" href="../../d8/d16/gc_8c.html#ae40ead8ed1ce1ae638710978a3fc8ff3">02483</a> <a class="code" href="../../d8/d16/gc_8c.html#ae40ead8ed1ce1ae638710978a3fc8ff3">garbage_collect</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l02484"></a>02484 {
<a name="l02485"></a>02485     <a class="code" href="../../d8/d16/gc_8c.html#adcecd8929620c2efedc87d949f9d70c7">INIT_GC_PROF_PARAMS</a>;
<a name="l02486"></a>02486 
<a name="l02487"></a>02487     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#aaeacd6016aa6c32604c1a00a7511ef55">GC_NOTIFY</a>) printf(<span class="stringliteral">&quot;start garbage_collect()\n&quot;</span>);
<a name="l02488"></a>02488 
<a name="l02489"></a>02489     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d16/gc_8c.html#a3eb89961b2be51932ecadee6b63963ba">heaps</a>) {
<a name="l02490"></a>02490         <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02491"></a>02491     }
<a name="l02492"></a>02492     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d16/gc_8c.html#a8b36b35fc92a92063db78b31a87d9e58">ready_to_gc</a>(objspace)) {
<a name="l02493"></a>02493         <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02494"></a>02494     }
<a name="l02495"></a>02495 
<a name="l02496"></a>02496     <a class="code" href="../../d8/d16/gc_8c.html#a0f4426fd7b01c2bf74b429c4d38c69ed">GC_PROF_TIMER_START</a>;
<a name="l02497"></a>02497 
<a name="l02498"></a>02498     <a class="code" href="../../d8/d16/gc_8c.html#ab33ac0d8116118bd4eb59677ec4c3fe2">rest_sweep</a>(objspace);
<a name="l02499"></a>02499 
<a name="l02500"></a>02500     <a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a>++;
<a name="l02501"></a>02501     <a class="code" href="../../d8/d16/gc_8c.html#a37430ca39daeb0e10e979ee8a081f79e">gc_marks</a>(objspace);
<a name="l02502"></a>02502 
<a name="l02503"></a>02503     <a class="code" href="../../d8/d16/gc_8c.html#a7628bfffdd08c29df946bd922179f9ca">GC_PROF_SWEEP_TIMER_START</a>;
<a name="l02504"></a>02504     <a class="code" href="../../d8/d16/gc_8c.html#a76b02cd914ceb682ce9c9e3ab7235283">gc_sweep</a>(objspace);
<a name="l02505"></a>02505     <a class="code" href="../../d8/d16/gc_8c.html#a4c6e2653b932903b441b181b5a98ef51">GC_PROF_SWEEP_TIMER_STOP</a>;
<a name="l02506"></a>02506 
<a name="l02507"></a>02507     <a class="code" href="../../d8/d16/gc_8c.html#afd036d5f19b0b4d1b0ba75654fd85b72">GC_PROF_TIMER_STOP</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>);
<a name="l02508"></a>02508     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#aaeacd6016aa6c32604c1a00a7511ef55">GC_NOTIFY</a>) printf(<span class="stringliteral">&quot;end garbage_collect()\n&quot;</span>);
<a name="l02509"></a>02509     <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02510"></a>02510 }
<a name="l02511"></a>02511 
<a name="l02512"></a>02512 <span class="keywordtype">int</span>
<a name="l02513"></a><a class="code" href="../../d8/d16/gc_8c.html#a8f041464b7b26de5018be9535067c79b">02513</a> <a class="code" href="../../d8/d16/gc_8c.html#a8f041464b7b26de5018be9535067c79b">rb_garbage_collect</a>(<span class="keywordtype">void</span>)
<a name="l02514"></a>02514 {
<a name="l02515"></a>02515     <span class="keywordflow">return</span> <a class="code" href="../../d8/d16/gc_8c.html#ae40ead8ed1ce1ae638710978a3fc8ff3">garbage_collect</a>(&amp;rb_objspace);
<a name="l02516"></a>02516 }
<a name="l02517"></a>02517 
<a name="l02518"></a>02518 <span class="keywordtype">void</span>
<a name="l02519"></a><a class="code" href="../../d8/d32/vm__core_8h.html#a4c2152009e465bf40a157fa23dfcc92e">02519</a> <a class="code" href="../../d8/d16/gc_8c.html#a4c2152009e465bf40a157fa23dfcc92e">rb_gc_mark_machine_stack</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l02520"></a>02520 {
<a name="l02521"></a>02521     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l02522"></a>02522     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../d1/d1c/thread__pthread_8c.html#aafba1985311b4e67c8c0b4e2ef09ab72">stack_start</a>, *stack_end;
<a name="l02523"></a>02523 
<a name="l02524"></a>02524     <a class="code" href="../../d8/d16/gc_8c.html#a86ec6dc57e82696d536f32a2fe1b96a9">GET_STACK_BOUNDS</a>(stack_start, stack_end, 0);
<a name="l02525"></a>02525     <a class="code" href="../../d8/d16/gc_8c.html#a90e176b7e9d24053977f64a611c1d8bb">rb_gc_mark_locations</a>(stack_start, stack_end);
<a name="l02526"></a>02526 <span class="preprocessor">#ifdef __ia64</span>
<a name="l02527"></a>02527 <span class="preprocessor"></span>    <a class="code" href="../../d8/d16/gc_8c.html#a90e176b7e9d24053977f64a611c1d8bb">rb_gc_mark_locations</a>(th-&gt;machine_register_stack_start, th-&gt;machine_register_stack_end);
<a name="l02528"></a>02528 <span class="preprocessor">#endif</span>
<a name="l02529"></a>02529 <span class="preprocessor"></span>}
<a name="l02530"></a>02530 
<a name="l02531"></a>02531 
<a name="l02532"></a>02532 <span class="comment">/*</span>
<a name="l02533"></a>02533 <span class="comment"> *  call-seq:</span>
<a name="l02534"></a>02534 <span class="comment"> *     GC.start                     -&gt; nil</span>
<a name="l02535"></a>02535 <span class="comment"> *     gc.garbage_collect           -&gt; nil</span>
<a name="l02536"></a>02536 <span class="comment"> *     ObjectSpace.garbage_collect  -&gt; nil</span>
<a name="l02537"></a>02537 <span class="comment"> *</span>
<a name="l02538"></a>02538 <span class="comment"> *  Initiates garbage collection, unless manually disabled.</span>
<a name="l02539"></a>02539 <span class="comment"> *</span>
<a name="l02540"></a>02540 <span class="comment"> */</span>
<a name="l02541"></a>02541 
<a name="l02542"></a>02542 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02543"></a><a class="code" href="../../db/d2e/intern_8h.html#a2a2d48737bcaedc111aad7bb6059165d">02543</a> <a class="code" href="../../d8/d16/gc_8c.html#a2a2d48737bcaedc111aad7bb6059165d">rb_gc_start</a>(<span class="keywordtype">void</span>)
<a name="l02544"></a>02544 {
<a name="l02545"></a>02545     <a class="code" href="../../d8/d16/gc_8c.html#a7a12ca86b76e272a301173e7661acfea">rb_gc</a>();
<a name="l02546"></a>02546     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02547"></a>02547 }
<a name="l02548"></a>02548 
<a name="l02549"></a>02549 <span class="preprocessor">#undef Init_stack</span>
<a name="l02550"></a>02550 <span class="preprocessor"></span>
<a name="l02551"></a>02551 <span class="keywordtype">void</span>
<a name="l02552"></a><a class="code" href="../../d8/d16/gc_8c.html#a9690e09aab5a833181c0468cf1c7308e">02552</a> <a class="code" href="../../db/d2e/intern_8h.html#a1b620d9508844b84f2facc6b77bae0c2">Init_stack</a>(<span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *addr)
<a name="l02553"></a>02553 {
<a name="l02554"></a>02554     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ab7d9aa9836c379212b86b985909f7303">ruby_init_stack</a>(addr);
<a name="l02555"></a>02555 }
<a name="l02556"></a>02556 
<a name="l02557"></a>02557 <span class="comment">/*</span>
<a name="l02558"></a>02558 <span class="comment"> * Document-class: ObjectSpace</span>
<a name="l02559"></a>02559 <span class="comment"> *</span>
<a name="l02560"></a>02560 <span class="comment"> *  The &lt;code&gt;ObjectSpace&lt;/code&gt; module contains a number of routines</span>
<a name="l02561"></a>02561 <span class="comment"> *  that interact with the garbage collection facility and allow you to</span>
<a name="l02562"></a>02562 <span class="comment"> *  traverse all living objects with an iterator.</span>
<a name="l02563"></a>02563 <span class="comment"> *</span>
<a name="l02564"></a>02564 <span class="comment"> *  &lt;code&gt;ObjectSpace&lt;/code&gt; also provides support for object</span>
<a name="l02565"></a>02565 <span class="comment"> *  finalizers, procs that will be called when a specific object is</span>
<a name="l02566"></a>02566 <span class="comment"> *  about to be destroyed by garbage collection.</span>
<a name="l02567"></a>02567 <span class="comment"> *</span>
<a name="l02568"></a>02568 <span class="comment"> *     include ObjectSpace</span>
<a name="l02569"></a>02569 <span class="comment"> *</span>
<a name="l02570"></a>02570 <span class="comment"> *</span>
<a name="l02571"></a>02571 <span class="comment"> *     a = &quot;A&quot;</span>
<a name="l02572"></a>02572 <span class="comment"> *     b = &quot;B&quot;</span>
<a name="l02573"></a>02573 <span class="comment"> *     c = &quot;C&quot;</span>
<a name="l02574"></a>02574 <span class="comment"> *</span>
<a name="l02575"></a>02575 <span class="comment"> *</span>
<a name="l02576"></a>02576 <span class="comment"> *     define_finalizer(a, proc {|id| puts &quot;Finalizer one on #{id}&quot; })</span>
<a name="l02577"></a>02577 <span class="comment"> *     define_finalizer(a, proc {|id| puts &quot;Finalizer two on #{id}&quot; })</span>
<a name="l02578"></a>02578 <span class="comment"> *     define_finalizer(b, proc {|id| puts &quot;Finalizer three on #{id}&quot; })</span>
<a name="l02579"></a>02579 <span class="comment"> *</span>
<a name="l02580"></a>02580 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l02581"></a>02581 <span class="comment"> *</span>
<a name="l02582"></a>02582 <span class="comment"> *     Finalizer three on 537763470</span>
<a name="l02583"></a>02583 <span class="comment"> *     Finalizer one on 537763480</span>
<a name="l02584"></a>02584 <span class="comment"> *     Finalizer two on 537763480</span>
<a name="l02585"></a>02585 <span class="comment"> *</span>
<a name="l02586"></a>02586 <span class="comment"> */</span>
<a name="l02587"></a>02587 
<a name="l02588"></a>02588 <span class="keywordtype">void</span>
<a name="l02589"></a><a class="code" href="../../d8/d16/gc_8c.html#a28562cb36223b2cae4ba88ef1c81a5c9">02589</a> <a class="code" href="../../d8/d16/gc_8c.html#a28562cb36223b2cae4ba88ef1c81a5c9">Init_heap</a>(<span class="keywordtype">void</span>)
<a name="l02590"></a>02590 {
<a name="l02591"></a>02591     <a class="code" href="../../d8/d16/gc_8c.html#aabf1d9f721b7654647f11fa09694df32">init_heap</a>(&amp;rb_objspace);
<a name="l02592"></a>02592 }
<a name="l02593"></a>02593 
<a name="l02594"></a>02594 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02595"></a><a class="code" href="../../d8/d16/gc_8c.html#af0247fa98c0ef198e898c532bfd49a37">02595</a> <a class="code" href="../../d8/d16/gc_8c.html#af0247fa98c0ef198e898c532bfd49a37">lazy_sweep_enable</a>(<span class="keywordtype">void</span>)
<a name="l02596"></a>02596 {
<a name="l02597"></a>02597     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l02598"></a>02598 
<a name="l02599"></a>02599     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#aba26cb1da0cbb0aa583f9947a5337b8f">flags</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a4d7a47226a51a21ac62139d9729c2cbe">dont_lazy_sweep</a> = <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02600"></a>02600     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02601"></a>02601 }
<a name="l02602"></a>02602 
<a name="l02603"></a><a class="code" href="../../d8/d16/gc_8c.html#af87c3d28861a78edf901291aee5de28c">02603</a> <span class="keyword">typedef</span> <span class="keywordtype">int</span> <a class="code" href="../../d8/d16/gc_8c.html#af87c3d28861a78edf901291aee5de28c">each_obj_callback</a>(<span class="keywordtype">void</span> *, <span class="keywordtype">void</span> *, <span class="keywordtype">size_t</span>, <span class="keywordtype">void</span> *);
<a name="l02604"></a>02604 
<a name="l02605"></a><a class="code" href="../../d4/d87/structeach__obj__args.html">02605</a> <span class="keyword">struct </span><a class="code" href="../../d4/d87/structeach__obj__args.html">each_obj_args</a> {
<a name="l02606"></a><a class="code" href="../../d4/d87/structeach__obj__args.html#a50d4d5ae13a6522ffc4150e4d284c557">02606</a>     <a class="code" href="../../d8/d16/gc_8c.html#af87c3d28861a78edf901291aee5de28c">each_obj_callback</a> *<a class="code" href="../../d4/d87/structeach__obj__args.html#a50d4d5ae13a6522ffc4150e4d284c557">callback</a>;
<a name="l02607"></a><a class="code" href="../../d4/d87/structeach__obj__args.html#ad3ee49ea0978a3662a6b84f3a5e23fb2">02607</a>     <span class="keywordtype">void</span> *<a class="code" href="../../d4/d87/structeach__obj__args.html#ad3ee49ea0978a3662a6b84f3a5e23fb2">data</a>;
<a name="l02608"></a>02608 };
<a name="l02609"></a>02609 
<a name="l02610"></a>02610 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02611"></a><a class="code" href="../../d8/d16/gc_8c.html#af48110c253fedaf2575a2ad1208a89c3">02611</a> <a class="code" href="../../d8/d16/gc_8c.html#af48110c253fedaf2575a2ad1208a89c3">objspace_each_objects</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l02612"></a>02612 {
<a name="l02613"></a>02613     <span class="keywordtype">size_t</span> i;
<a name="l02614"></a>02614     <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *membase = 0;
<a name="l02615"></a>02615     <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *pstart, *pend;
<a name="l02616"></a>02616     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l02617"></a>02617     <span class="keyword">struct </span><a class="code" href="../../d4/d87/structeach__obj__args.html">each_obj_args</a> *<a class="code" href="../../d3/d09/ripper_8y.html#a8187411843a6284ffb964ef3fb9fcab3">args</a> = (<span class="keyword">struct </span><a class="code" href="../../d4/d87/structeach__obj__args.html">each_obj_args</a> *)arg;
<a name="l02618"></a>02618     <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v;
<a name="l02619"></a>02619 
<a name="l02620"></a>02620     i = 0;
<a name="l02621"></a>02621     <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a>) {
<a name="l02622"></a>02622         <span class="keywordflow">while</span> (0 &lt; i &amp;&amp; (<a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a>)membase &lt; (<a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a>)objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i-1].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a79843785a726ea01bb4683ad9ba055d3">slot</a>-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a4e10e0c9aba6f88eddf3d5f6d9c408fb">membase</a>)
<a name="l02623"></a>02623             i--;
<a name="l02624"></a>02624         <span class="keywordflow">while</span> (i &lt; <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a> &amp;&amp; (<a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a>)objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a79843785a726ea01bb4683ad9ba055d3">slot</a>-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a4e10e0c9aba6f88eddf3d5f6d9c408fb">membase</a> &lt;= (<a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a>)membase)
<a name="l02625"></a>02625             i++;
<a name="l02626"></a>02626         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a> &lt;= i)
<a name="l02627"></a>02627           <span class="keywordflow">break</span>;
<a name="l02628"></a>02628         membase = objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a79843785a726ea01bb4683ad9ba055d3">slot</a>-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#a4e10e0c9aba6f88eddf3d5f6d9c408fb">membase</a>;
<a name="l02629"></a>02629 
<a name="l02630"></a>02630         pstart = objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a79843785a726ea01bb4683ad9ba055d3">slot</a>-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#ae677a624c841d9129e8f31d350dc5f21">slot</a>;
<a name="l02631"></a>02631         pend = pstart + objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a79843785a726ea01bb4683ad9ba055d3">slot</a>-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#aab5626f69fb1dff0779d330d780bd928">limit</a>;
<a name="l02632"></a>02632 
<a name="l02633"></a>02633         <span class="keywordflow">for</span> (; pstart != pend; pstart++) {
<a name="l02634"></a>02634             <span class="keywordflow">if</span> (pstart-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a>) {
<a name="l02635"></a>02635                 v = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)pstart; <span class="comment">/* acquire to save this object */</span>
<a name="l02636"></a>02636                 <span class="keywordflow">break</span>;
<a name="l02637"></a>02637             }
<a name="l02638"></a>02638         }
<a name="l02639"></a>02639         <span class="keywordflow">if</span> (pstart != pend) {
<a name="l02640"></a>02640             <span class="keywordflow">if</span> ((*args-&gt;<a class="code" href="../../d4/d87/structeach__obj__args.html#a50d4d5ae13a6522ffc4150e4d284c557">callback</a>)(pstart, pend, <span class="keyword">sizeof</span>(<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a>), args-&gt;<a class="code" href="../../d4/d87/structeach__obj__args.html#ad3ee49ea0978a3662a6b84f3a5e23fb2">data</a>)) {
<a name="l02641"></a>02641                 <span class="keywordflow">break</span>;
<a name="l02642"></a>02642             }
<a name="l02643"></a>02643         }
<a name="l02644"></a>02644     }
<a name="l02645"></a>02645 
<a name="l02646"></a>02646     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02647"></a>02647 }
<a name="l02648"></a>02648 
<a name="l02649"></a>02649 <span class="comment">/*</span>
<a name="l02650"></a>02650 <span class="comment"> * rb_objspace_each_objects() is special C API to walk through</span>
<a name="l02651"></a>02651 <span class="comment"> * Ruby object space.  This C API is too difficult to use it.</span>
<a name="l02652"></a>02652 <span class="comment"> * To be frank, you should not use it. Or you need to read the</span>
<a name="l02653"></a>02653 <span class="comment"> * source code of this function and understand what this function does.</span>
<a name="l02654"></a>02654 <span class="comment"> *</span>
<a name="l02655"></a>02655 <span class="comment"> * &apos;callback&apos; will be called several times (the number of heap slot,</span>
<a name="l02656"></a>02656 <span class="comment"> * at current implementation) with:</span>
<a name="l02657"></a>02657 <span class="comment"> *   vstart: a pointer to the first living object of the heap_slot.</span>
<a name="l02658"></a>02658 <span class="comment"> *   vend: a pointer to next to the valid heap_slot area.</span>
<a name="l02659"></a>02659 <span class="comment"> *   stride: a distance to next VALUE.</span>
<a name="l02660"></a>02660 <span class="comment"> *</span>
<a name="l02661"></a>02661 <span class="comment"> * If callback() returns non-zero, the iteration will be stopped.</span>
<a name="l02662"></a>02662 <span class="comment"> *</span>
<a name="l02663"></a>02663 <span class="comment"> * This is a sample callback code to iterate liveness objects:</span>
<a name="l02664"></a>02664 <span class="comment"> *</span>
<a name="l02665"></a>02665 <span class="comment"> *   int</span>
<a name="l02666"></a>02666 <span class="comment"> *   sample_callback(void *vstart, void *vend, int stride, void *data) {</span>
<a name="l02667"></a>02667 <span class="comment"> *     VALUE v = (VALUE)vstart;</span>
<a name="l02668"></a>02668 <span class="comment"> *     for (; v != (VALUE)vend; v += stride) {</span>
<a name="l02669"></a>02669 <span class="comment"> *       if (RBASIC(v)-&gt;flags) { // liveness check</span>
<a name="l02670"></a>02670 <span class="comment"> *       // do something with live object &apos;v&apos;</span>
<a name="l02671"></a>02671 <span class="comment"> *     }</span>
<a name="l02672"></a>02672 <span class="comment"> *     return 0; // continue to iteration</span>
<a name="l02673"></a>02673 <span class="comment"> *   }</span>
<a name="l02674"></a>02674 <span class="comment"> *</span>
<a name="l02675"></a>02675 <span class="comment"> * Note: &apos;vstart&apos; is not a top of heap_slot.  This point the first</span>
<a name="l02676"></a>02676 <span class="comment"> *       living object to grasp at least one object to avoid GC issue.</span>
<a name="l02677"></a>02677 <span class="comment"> *       This means that you can not walk through all Ruby object slot</span>
<a name="l02678"></a>02678 <span class="comment"> *       including freed object slot.</span>
<a name="l02679"></a>02679 <span class="comment"> *</span>
<a name="l02680"></a>02680 <span class="comment"> * Note: On this implementation, &apos;stride&apos; is same as sizeof(RVALUE).</span>
<a name="l02681"></a>02681 <span class="comment"> *       However, there are possibilities to pass variable values with</span>
<a name="l02682"></a>02682 <span class="comment"> *       &apos;stride&apos; with some reasons.  You must use stride instead of</span>
<a name="l02683"></a>02683 <span class="comment"> *       use some constant value in the iteration.</span>
<a name="l02684"></a>02684 <span class="comment"> */</span>
<a name="l02685"></a>02685 <span class="keywordtype">void</span>
<a name="l02686"></a><a class="code" href="../../d8/d16/gc_8c.html#ac2b65f7b2d778d973bfc7f0bf0c3dc62">02686</a> <a class="code" href="../../d8/d16/gc_8c.html#ac2b65f7b2d778d973bfc7f0bf0c3dc62">rb_objspace_each_objects</a>(<a class="code" href="../../d8/d16/gc_8c.html#af87c3d28861a78edf901291aee5de28c">each_obj_callback</a> *<a class="code" href="../../d2/d34/closure_8c.html#aae67b2d791319e3a2e38ef8f3eebb1e9">callback</a>, <span class="keywordtype">void</span> *<a class="code" href="../../d4/d87/structeach__obj__args.html#ad3ee49ea0978a3662a6b84f3a5e23fb2">data</a>)
<a name="l02687"></a>02687 {
<a name="l02688"></a>02688     <span class="keyword">struct </span><a class="code" href="../../d4/d87/structeach__obj__args.html">each_obj_args</a> args;
<a name="l02689"></a>02689     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l02690"></a>02690 
<a name="l02691"></a>02691     <a class="code" href="../../d8/d16/gc_8c.html#ab33ac0d8116118bd4eb59677ec4c3fe2">rest_sweep</a>(objspace);
<a name="l02692"></a>02692     objspace-&gt;flags.dont_lazy_sweep = <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02693"></a>02693 
<a name="l02694"></a>02694     args.<a class="code" href="../../d4/d87/structeach__obj__args.html#a50d4d5ae13a6522ffc4150e4d284c557">callback</a> = callback;
<a name="l02695"></a>02695     args.<a class="code" href="../../d4/d87/structeach__obj__args.html#ad3ee49ea0978a3662a6b84f3a5e23fb2">data</a> = data;
<a name="l02696"></a>02696     <a class="code" href="../../d3/d57/eval_8c.html#a8061198378fb16adeb931f90540b2839">rb_ensure</a>(<a class="code" href="../../d8/d16/gc_8c.html#af48110c253fedaf2575a2ad1208a89c3">objspace_each_objects</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;args, <a class="code" href="../../d8/d16/gc_8c.html#af0247fa98c0ef198e898c532bfd49a37">lazy_sweep_enable</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l02697"></a>02697 }
<a name="l02698"></a>02698 
<a name="l02699"></a><a class="code" href="../../dc/df2/structos__each__struct.html">02699</a> <span class="keyword">struct </span><a class="code" href="../../dc/df2/structos__each__struct.html">os_each_struct</a> {
<a name="l02700"></a><a class="code" href="../../dc/df2/structos__each__struct.html#ad1e7fe74d73812a4290db1f2dc9e894e">02700</a>     <span class="keywordtype">size_t</span> <a class="code" href="../../dc/df2/structos__each__struct.html#ad1e7fe74d73812a4290db1f2dc9e894e">num</a>;
<a name="l02701"></a><a class="code" href="../../dc/df2/structos__each__struct.html#aa1e23965467f694c0c7bbea17b43cc53">02701</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dc/df2/structos__each__struct.html#aa1e23965467f694c0c7bbea17b43cc53">of</a>;
<a name="l02702"></a>02702 };
<a name="l02703"></a>02703 
<a name="l02704"></a>02704 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02705"></a><a class="code" href="../../d8/d16/gc_8c.html#aa2798ce349acc96e22ebd43aae05ceba">02705</a> <a class="code" href="../../d8/d16/gc_8c.html#aa2798ce349acc96e22ebd43aae05ceba">os_obj_of_i</a>(<span class="keywordtype">void</span> *vstart, <span class="keywordtype">void</span> *vend, <span class="keywordtype">size_t</span> stride, <span class="keywordtype">void</span> *data)
<a name="l02706"></a>02706 {
<a name="l02707"></a>02707     <span class="keyword">struct </span><a class="code" href="../../dc/df2/structos__each__struct.html">os_each_struct</a> *oes = (<span class="keyword">struct </span><a class="code" href="../../dc/df2/structos__each__struct.html">os_each_struct</a> *)data;
<a name="l02708"></a>02708     <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *p = (<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *)vstart, *pend = (<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *)vend;
<a name="l02709"></a>02709     <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v;
<a name="l02710"></a>02710 
<a name="l02711"></a>02711     <span class="keywordflow">for</span> (; p != pend; p++) {
<a name="l02712"></a>02712         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a>) {
<a name="l02713"></a>02713             <span class="keywordflow">switch</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(p)) {
<a name="l02714"></a>02714               <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5efefe46b598af6f98c691fead03682d">T_NONE</a>:
<a name="l02715"></a>02715               <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a82c8c4569748b9645c958b9eaeaabb81">T_ICLASS</a>:
<a name="l02716"></a>02716               <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5f1cc49c4da51d5bdffa64be79ff6fb0">T_NODE</a>:
<a name="l02717"></a>02717               <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ab80c70472770bcae8d33bbf6139262d0">T_ZOMBIE</a>:
<a name="l02718"></a>02718                 <span class="keywordflow">continue</span>;
<a name="l02719"></a>02719               <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad04c63d175774c6d6e7dfaf0f0a982c9">T_CLASS</a>:
<a name="l02720"></a>02720                 <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1ae918b6cc84188a9dc6ab545f732e4d">FL_TEST</a>(p, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a081b5172ef37829bb3a258cd1ad393bc">FL_SINGLETON</a>))
<a name="l02721"></a>02721                   <span class="keywordflow">continue</span>;
<a name="l02722"></a>02722               <span class="keywordflow">default</span>:
<a name="l02723"></a>02723                 <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a31e86dc428e998786b528fef067424a4">klass</a>) <span class="keywordflow">continue</span>;
<a name="l02724"></a>02724                 v = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)p;
<a name="l02725"></a>02725                 <span class="keywordflow">if</span> (!oes-&gt;<a class="code" href="../../dc/df2/structos__each__struct.html#aa1e23965467f694c0c7bbea17b43cc53">of</a> || <a class="code" href="../../db/d2e/intern_8h.html#a6e65fc310dd65ebd60d68ada991da6f6">rb_obj_is_kind_of</a>(v, oes-&gt;<a class="code" href="../../dc/df2/structos__each__struct.html#aa1e23965467f694c0c7bbea17b43cc53">of</a>)) {
<a name="l02726"></a>02726                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae6bd0c4ea4db971ebd569ca8f05c6b4a">rb_yield</a>(v);
<a name="l02727"></a>02727                     oes-&gt;<a class="code" href="../../dc/df2/structos__each__struct.html#ad1e7fe74d73812a4290db1f2dc9e894e">num</a>++;
<a name="l02728"></a>02728                 }
<a name="l02729"></a>02729             }
<a name="l02730"></a>02730         }
<a name="l02731"></a>02731     }
<a name="l02732"></a>02732 
<a name="l02733"></a>02733     <span class="keywordflow">return</span> 0;
<a name="l02734"></a>02734 }
<a name="l02735"></a>02735 
<a name="l02736"></a>02736 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02737"></a><a class="code" href="../../d8/d16/gc_8c.html#ad59712e61faa344435188d64327c0afe">02737</a> <a class="code" href="../../d8/d16/gc_8c.html#ad59712e61faa344435188d64327c0afe">os_obj_of</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dc/df2/structos__each__struct.html#aa1e23965467f694c0c7bbea17b43cc53">of</a>)
<a name="l02738"></a>02738 {
<a name="l02739"></a>02739     <span class="keyword">struct </span><a class="code" href="../../dc/df2/structos__each__struct.html">os_each_struct</a> oes;
<a name="l02740"></a>02740 
<a name="l02741"></a>02741     oes.<a class="code" href="../../dc/df2/structos__each__struct.html#ad1e7fe74d73812a4290db1f2dc9e894e">num</a> = 0;
<a name="l02742"></a>02742     oes.<a class="code" href="../../dc/df2/structos__each__struct.html#aa1e23965467f694c0c7bbea17b43cc53">of</a> = of;
<a name="l02743"></a>02743     <a class="code" href="../../d8/d16/gc_8c.html#ac2b65f7b2d778d973bfc7f0bf0c3dc62">rb_objspace_each_objects</a>(<a class="code" href="../../d8/d16/gc_8c.html#aa2798ce349acc96e22ebd43aae05ceba">os_obj_of_i</a>, &amp;oes);
<a name="l02744"></a>02744     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(oes.<a class="code" href="../../dc/df2/structos__each__struct.html#ad1e7fe74d73812a4290db1f2dc9e894e">num</a>);
<a name="l02745"></a>02745 }
<a name="l02746"></a>02746 
<a name="l02747"></a>02747 <span class="comment">/*</span>
<a name="l02748"></a>02748 <span class="comment"> *  call-seq:</span>
<a name="l02749"></a>02749 <span class="comment"> *     ObjectSpace.each_object([module]) {|obj| ... } -&gt; fixnum</span>
<a name="l02750"></a>02750 <span class="comment"> *     ObjectSpace.each_object([module])              -&gt; an_enumerator</span>
<a name="l02751"></a>02751 <span class="comment"> *</span>
<a name="l02752"></a>02752 <span class="comment"> *  Calls the block once for each living, nonimmediate object in this</span>
<a name="l02753"></a>02753 <span class="comment"> *  Ruby process. If &lt;i&gt;module&lt;/i&gt; is specified, calls the block</span>
<a name="l02754"></a>02754 <span class="comment"> *  for only those classes or modules that match (or are a subclass of)</span>
<a name="l02755"></a>02755 <span class="comment"> *  &lt;i&gt;module&lt;/i&gt;. Returns the number of objects found. Immediate</span>
<a name="l02756"></a>02756 <span class="comment"> *  objects (&lt;code&gt;Fixnum&lt;/code&gt;s, &lt;code&gt;Symbol&lt;/code&gt;s</span>
<a name="l02757"></a>02757 <span class="comment"> *  &lt;code&gt;true&lt;/code&gt;, &lt;code&gt;false&lt;/code&gt;, and &lt;code&gt;nil&lt;/code&gt;) are</span>
<a name="l02758"></a>02758 <span class="comment"> *  never returned. In the example below, &lt;code&gt;each_object&lt;/code&gt;</span>
<a name="l02759"></a>02759 <span class="comment"> *  returns both the numbers we defined and several constants defined in</span>
<a name="l02760"></a>02760 <span class="comment"> *  the &lt;code&gt;Math&lt;/code&gt; module.</span>
<a name="l02761"></a>02761 <span class="comment"> *</span>
<a name="l02762"></a>02762 <span class="comment"> *  If no block is given, an enumerator is returned instead.</span>
<a name="l02763"></a>02763 <span class="comment"> *</span>
<a name="l02764"></a>02764 <span class="comment"> *     a = 102.7</span>
<a name="l02765"></a>02765 <span class="comment"> *     b = 95       # Won&apos;t be returned</span>
<a name="l02766"></a>02766 <span class="comment"> *     c = 12345678987654321</span>
<a name="l02767"></a>02767 <span class="comment"> *     count = ObjectSpace.each_object(Numeric) {|x| p x }</span>
<a name="l02768"></a>02768 <span class="comment"> *     puts &quot;Total count: #{count}&quot;</span>
<a name="l02769"></a>02769 <span class="comment"> *</span>
<a name="l02770"></a>02770 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l02771"></a>02771 <span class="comment"> *</span>
<a name="l02772"></a>02772 <span class="comment"> *     12345678987654321</span>
<a name="l02773"></a>02773 <span class="comment"> *     102.7</span>
<a name="l02774"></a>02774 <span class="comment"> *     2.71828182845905</span>
<a name="l02775"></a>02775 <span class="comment"> *     3.14159265358979</span>
<a name="l02776"></a>02776 <span class="comment"> *     2.22044604925031e-16</span>
<a name="l02777"></a>02777 <span class="comment"> *     1.7976931348623157e+308</span>
<a name="l02778"></a>02778 <span class="comment"> *     2.2250738585072e-308</span>
<a name="l02779"></a>02779 <span class="comment"> *     Total count: 7</span>
<a name="l02780"></a>02780 <span class="comment"> *</span>
<a name="l02781"></a>02781 <span class="comment"> */</span>
<a name="l02782"></a>02782 
<a name="l02783"></a>02783 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02784"></a><a class="code" href="../../d8/d16/gc_8c.html#aa8478889497ff9e98752b655c6fbf352">02784</a> <a class="code" href="../../d8/d16/gc_8c.html#aa8478889497ff9e98752b655c6fbf352">os_each_obj</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> os)
<a name="l02785"></a>02785 {
<a name="l02786"></a>02786     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dc/df2/structos__each__struct.html#aa1e23965467f694c0c7bbea17b43cc53">of</a>;
<a name="l02787"></a>02787 
<a name="l02788"></a>02788     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a98b91af598acb64fe8497413ce498766">rb_secure</a>(4);
<a name="l02789"></a>02789     <span class="keywordflow">if</span> (argc == 0) {
<a name="l02790"></a>02790         of = 0;
<a name="l02791"></a>02791     }
<a name="l02792"></a>02792     <span class="keywordflow">else</span> {
<a name="l02793"></a>02793         <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;01&quot;</span>, &amp;of);
<a name="l02794"></a>02794     }
<a name="l02795"></a>02795     <a class="code" href="../../db/d2e/intern_8h.html#ad174dd963d99ac27a67c8ef9cfa1eb58">RETURN_ENUMERATOR</a>(os, 1, &amp;of);
<a name="l02796"></a>02796     <span class="keywordflow">return</span> <a class="code" href="../../d8/d16/gc_8c.html#ad59712e61faa344435188d64327c0afe">os_obj_of</a>(of);
<a name="l02797"></a>02797 }
<a name="l02798"></a>02798 
<a name="l02799"></a>02799 <span class="comment">/*</span>
<a name="l02800"></a>02800 <span class="comment"> *  call-seq:</span>
<a name="l02801"></a>02801 <span class="comment"> *     ObjectSpace.undefine_finalizer(obj)</span>
<a name="l02802"></a>02802 <span class="comment"> *</span>
<a name="l02803"></a>02803 <span class="comment"> *  Removes all finalizers for &lt;i&gt;obj&lt;/i&gt;.</span>
<a name="l02804"></a>02804 <span class="comment"> *</span>
<a name="l02805"></a>02805 <span class="comment"> */</span>
<a name="l02806"></a>02806 
<a name="l02807"></a>02807 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02808"></a><a class="code" href="../../d8/d16/gc_8c.html#ae243ea45416037ff231f619e26c3cf4e">02808</a> <a class="code" href="../../d8/d16/gc_8c.html#ae243ea45416037ff231f619e26c3cf4e">undefine_final</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> os, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj)
<a name="l02809"></a>02809 {
<a name="l02810"></a>02810     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l02811"></a>02811     <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> data = obj;
<a name="l02812"></a>02812     <a class="code" href="../../db/d2e/intern_8h.html#a372d6acb27d271ee4fc2e88c7022c485">rb_check_frozen</a>(obj);
<a name="l02813"></a>02813     <a class="code" href="../../dd/d24/st_8h.html#aa04e4ee0a6e1f19e64f3be4668f41234">st_delete</a>(<a class="code" href="../../d8/d16/gc_8c.html#ad42bffe188d60ed392ba783bf4c5e91b">finalizer_table</a>, &amp;data, 0);
<a name="l02814"></a>02814     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6db7676c6cc4059a7cf021be34f53840">FL_UNSET</a>(obj, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6c5ccf5e4d375da1c8f418ccd41c92bb">FL_FINALIZE</a>);
<a name="l02815"></a>02815     <span class="keywordflow">return</span> obj;
<a name="l02816"></a>02816 }
<a name="l02817"></a>02817 
<a name="l02818"></a>02818 <span class="comment">/*</span>
<a name="l02819"></a>02819 <span class="comment"> *  call-seq:</span>
<a name="l02820"></a>02820 <span class="comment"> *     ObjectSpace.define_finalizer(obj, aProc=proc())</span>
<a name="l02821"></a>02821 <span class="comment"> *</span>
<a name="l02822"></a>02822 <span class="comment"> *  Adds &lt;i&gt;aProc&lt;/i&gt; as a finalizer, to be called after &lt;i&gt;obj&lt;/i&gt;</span>
<a name="l02823"></a>02823 <span class="comment"> *  was destroyed.</span>
<a name="l02824"></a>02824 <span class="comment"> *</span>
<a name="l02825"></a>02825 <span class="comment"> */</span>
<a name="l02826"></a>02826 
<a name="l02827"></a>02827 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02828"></a><a class="code" href="../../d8/d16/gc_8c.html#a5cf74d458d560485d2200996dc4164a8">02828</a> <a class="code" href="../../d8/d16/gc_8c.html#a5cf74d458d560485d2200996dc4164a8">define_final</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> os)
<a name="l02829"></a>02829 {
<a name="l02830"></a>02830     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l02831"></a>02831     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj, block, table;
<a name="l02832"></a>02832     <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> data;
<a name="l02833"></a>02833 
<a name="l02834"></a>02834     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;11&quot;</span>, &amp;obj, &amp;block);
<a name="l02835"></a>02835     <a class="code" href="../../db/d2e/intern_8h.html#a372d6acb27d271ee4fc2e88c7022c485">rb_check_frozen</a>(obj);
<a name="l02836"></a>02836     <span class="keywordflow">if</span> (argc == 1) {
<a name="l02837"></a>02837         block = <a class="code" href="../../db/d2e/intern_8h.html#a7b330d2905c5f0c9a68cef4ebba5c00f">rb_block_proc</a>();
<a name="l02838"></a>02838     }
<a name="l02839"></a>02839     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../db/d2e/intern_8h.html#a5c6c63c2619b8c03df2e173ef1e73846">rb_respond_to</a>(block, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;call&quot;</span>))) {
<a name="l02840"></a>02840         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;wrong type argument %s (should be callable)&quot;</span>,
<a name="l02841"></a>02841                  <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9b4f42ada717bfbe7a78830639476aed">rb_obj_classname</a>(block));
<a name="l02842"></a>02842     }
<a name="l02843"></a>02843     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a26a8e2d0265d8dee3da6aad47a396257">FL_ABLE</a>(obj)) {
<a name="l02844"></a>02844         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;cannot define finalizer for %s&quot;</span>,
<a name="l02845"></a>02845                  <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9b4f42ada717bfbe7a78830639476aed">rb_obj_classname</a>(obj));
<a name="l02846"></a>02846     }
<a name="l02847"></a>02847     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1d4c05021aacd8cab989ff60f95ebe2d">RBASIC</a>(obj)-&gt;flags |= <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6c5ccf5e4d375da1c8f418ccd41c92bb">FL_FINALIZE</a>;
<a name="l02848"></a>02848 
<a name="l02849"></a>02849     block = <a class="code" href="../../dc/dcc/array_8c.html#a8317ecd6a0abb5ad08c50c732f30059b">rb_ary_new3</a>(2, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../d5/d9d/tcltklib_8c.html#a6f520624fabb8332dc98fd223491bf8d">rb_safe_level</a>()), block);
<a name="l02850"></a>02850     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7ae8fa209abf837905d53c1c4be7c75d">OBJ_FREEZE</a>(block);
<a name="l02851"></a>02851 
<a name="l02852"></a>02852     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(<a class="code" href="../../d8/d16/gc_8c.html#ad42bffe188d60ed392ba783bf4c5e91b">finalizer_table</a>, obj, &amp;data)) {
<a name="l02853"></a>02853         table = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)data;
<a name="l02854"></a>02854         <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(table, block);
<a name="l02855"></a>02855     }
<a name="l02856"></a>02856     <span class="keywordflow">else</span> {
<a name="l02857"></a>02857         table = <a class="code" href="../../dc/dcc/array_8c.html#a8317ecd6a0abb5ad08c50c732f30059b">rb_ary_new3</a>(1, block);
<a name="l02858"></a>02858         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1d4c05021aacd8cab989ff60f95ebe2d">RBASIC</a>(table)-&gt;klass = 0;
<a name="l02859"></a>02859         <a class="code" href="../../dd/d24/st_8h.html#aee4e16ae99cd543ddf851107d5ea5408">st_add_direct</a>(<a class="code" href="../../d8/d16/gc_8c.html#ad42bffe188d60ed392ba783bf4c5e91b">finalizer_table</a>, obj, table);
<a name="l02860"></a>02860     }
<a name="l02861"></a>02861     <span class="keywordflow">return</span> block;
<a name="l02862"></a>02862 }
<a name="l02863"></a>02863 
<a name="l02864"></a>02864 <span class="keywordtype">void</span>
<a name="l02865"></a><a class="code" href="../../db/d2e/intern_8h.html#ace72cc778ea5ac44393f7e140cd67851">02865</a> <a class="code" href="../../d8/d16/gc_8c.html#a91b16b02874a4eafdfeb18fb2f33be3b">rb_gc_copy_finalizer</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> dest, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj)
<a name="l02866"></a>02866 {
<a name="l02867"></a>02867     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l02868"></a>02868     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> table;
<a name="l02869"></a>02869     <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> data;
<a name="l02870"></a>02870 
<a name="l02871"></a>02871     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1ae918b6cc84188a9dc6ab545f732e4d">FL_TEST</a>(obj, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6c5ccf5e4d375da1c8f418ccd41c92bb">FL_FINALIZE</a>)) <span class="keywordflow">return</span>;
<a name="l02872"></a>02872     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(<a class="code" href="../../d8/d16/gc_8c.html#ad42bffe188d60ed392ba783bf4c5e91b">finalizer_table</a>, obj, &amp;data)) {
<a name="l02873"></a>02873         table = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)data;
<a name="l02874"></a>02874         <a class="code" href="../../dd/d24/st_8h.html#acdc42c01229b7537ea5a4c6965c7e47a">st_insert</a>(<a class="code" href="../../d8/d16/gc_8c.html#ad42bffe188d60ed392ba783bf4c5e91b">finalizer_table</a>, dest, table);
<a name="l02875"></a>02875     }
<a name="l02876"></a>02876     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a38d7199dc0d1dc7f7207a9b3091c8d0d">FL_SET</a>(dest, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6c5ccf5e4d375da1c8f418ccd41c92bb">FL_FINALIZE</a>);
<a name="l02877"></a>02877 }
<a name="l02878"></a>02878 
<a name="l02879"></a>02879 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02880"></a><a class="code" href="../../d8/d16/gc_8c.html#a4338529aa1ff467674a8a95b9ce45d07">02880</a> <a class="code" href="../../d8/d16/gc_8c.html#a4338529aa1ff467674a8a95b9ce45d07">run_single_final</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l02881"></a>02881 {
<a name="l02882"></a>02882     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../d3/d09/ripper_8y.html#a8187411843a6284ffb964ef3fb9fcab3">args</a> = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *)arg;
<a name="l02883"></a>02883     <a class="code" href="../../db/d2e/intern_8h.html#ae871c8b0e9fb3305829e029cede53001">rb_eval_cmd</a>(args[0], args[1], (<span class="keywordtype">int</span>)args[2]);
<a name="l02884"></a>02884     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02885"></a>02885 }
<a name="l02886"></a>02886 
<a name="l02887"></a>02887 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02888"></a><a class="code" href="../../d8/d16/gc_8c.html#a06250ce0d45ecc9e84030f0286064c78">02888</a> <a class="code" href="../../d8/d16/gc_8c.html#a06250ce0d45ecc9e84030f0286064c78">run_finalizer</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> objid, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> table)
<a name="l02889"></a>02889 {
<a name="l02890"></a>02890     <span class="keywordtype">long</span> i;
<a name="l02891"></a>02891     <span class="keywordtype">int</span> status;
<a name="l02892"></a>02892     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d09/ripper_8y.html#a8187411843a6284ffb964ef3fb9fcab3">args</a>[3];
<a name="l02893"></a>02893 
<a name="l02894"></a>02894     <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(table) &gt; 0) {
<a name="l02895"></a>02895         args[1] = <a class="code" href="../../db/d2e/intern_8h.html#a8ea3742679211f408cb5769de6cf0d46">rb_obj_freeze</a>(<a class="code" href="../../dc/dcc/array_8c.html#a8317ecd6a0abb5ad08c50c732f30059b">rb_ary_new3</a>(1, objid));
<a name="l02896"></a>02896     }
<a name="l02897"></a>02897     <span class="keywordflow">else</span> {
<a name="l02898"></a>02898         args[1] = 0;
<a name="l02899"></a>02899     }
<a name="l02900"></a>02900 
<a name="l02901"></a>02901     args[2] = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)<a class="code" href="../../d5/d9d/tcltklib_8c.html#a6f520624fabb8332dc98fd223491bf8d">rb_safe_level</a>();
<a name="l02902"></a>02902     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(table); i++) {
<a name="l02903"></a>02903         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">final</span> = <a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(table)[i];
<a name="l02904"></a>02904         args[0] = <a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(<span class="keyword">final</span>)[1];
<a name="l02905"></a>02905         args[2] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9444c431b3cb1184e7523fc572f2c758">FIX2INT</a>(<a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(<span class="keyword">final</span>)[0]);
<a name="l02906"></a>02906         status = 0;
<a name="l02907"></a>02907         <a class="code" href="../../d3/d57/eval_8c.html#a6aa7fb1169ed41978a16375b6f921b0e">rb_protect</a>(<a class="code" href="../../d8/d16/gc_8c.html#a4338529aa1ff467674a8a95b9ce45d07">run_single_final</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)args, &amp;status);
<a name="l02908"></a>02908         <span class="keywordflow">if</span> (status)
<a name="l02909"></a>02909             <a class="code" href="../../d3/d57/eval_8c.html#a4484d744216a0afdf26dce14f1190973">rb_set_errinfo</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l02910"></a>02910     }
<a name="l02911"></a>02911 }
<a name="l02912"></a>02912 
<a name="l02913"></a>02913 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02914"></a><a class="code" href="../../d8/d16/gc_8c.html#af529267e0eab924c8d9427304a310794">02914</a> <a class="code" href="../../d8/d16/gc_8c.html#af529267e0eab924c8d9427304a310794">run_final</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj)
<a name="l02915"></a>02915 {
<a name="l02916"></a>02916     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> objid;
<a name="l02917"></a>02917     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad83646c4b210a82fc3d1a1e723ffc931">RUBY_DATA_FUNC</a> free_func = 0;
<a name="l02918"></a>02918     <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, table;
<a name="l02919"></a>02919 
<a name="l02920"></a>02920     objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a3fcb169372e6a22e464737dd3346cbae">final_num</a>--;
<a name="l02921"></a>02921 
<a name="l02922"></a>02922     objid = <a class="code" href="../../d8/d16/gc_8c.html#a56eb26ff20f077eecdca272b83df1652">rb_obj_id</a>(obj);     <span class="comment">/* make obj into id */</span>
<a name="l02923"></a>02923     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1d4c05021aacd8cab989ff60f95ebe2d">RBASIC</a>(obj)-&gt;klass = 0;
<a name="l02924"></a>02924 
<a name="l02925"></a>02925     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac167240ec598e32f5ff3cdb902fb98b9">RTYPEDDATA_P</a>(obj)) {
<a name="l02926"></a>02926         free_func = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa7423675bf99068c658e91a4ba55016c">RTYPEDDATA_TYPE</a>(obj)-&gt;function.dfree;
<a name="l02927"></a>02927     }
<a name="l02928"></a>02928     <span class="keywordflow">else</span> {
<a name="l02929"></a>02929         free_func = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa38eb1376d31aae1fe0b334b9b76f2ef">RDATA</a>(obj)-&gt;dfree;
<a name="l02930"></a>02930     }
<a name="l02931"></a>02931     <span class="keywordflow">if</span> (free_func) {
<a name="l02932"></a>02932         (*free_func)(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#abb509cfdf6560a9f795b1f6932d93691">DATA_PTR</a>(obj));
<a name="l02933"></a>02933     }
<a name="l02934"></a>02934 
<a name="l02935"></a>02935     key = (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)obj;
<a name="l02936"></a>02936     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d24/st_8h.html#aa04e4ee0a6e1f19e64f3be4668f41234">st_delete</a>(<a class="code" href="../../d8/d16/gc_8c.html#ad42bffe188d60ed392ba783bf4c5e91b">finalizer_table</a>, &amp;key, &amp;table)) {
<a name="l02937"></a>02937         <a class="code" href="../../d8/d16/gc_8c.html#a06250ce0d45ecc9e84030f0286064c78">run_finalizer</a>(objspace, objid, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)table);
<a name="l02938"></a>02938     }
<a name="l02939"></a>02939 }
<a name="l02940"></a>02940 
<a name="l02941"></a>02941 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02942"></a><a class="code" href="../../d8/d16/gc_8c.html#a7d391134c224f8807ff34d420811196a">02942</a> <a class="code" href="../../d8/d16/gc_8c.html#a7d391134c224f8807ff34d420811196a">finalize_deferred</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l02943"></a>02943 {
<a name="l02944"></a>02944     <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *p = <a class="code" href="../../d8/d16/gc_8c.html#a39bb37371a2ddda30cc826e790ceda3c">deferred_final_list</a>;
<a name="l02945"></a>02945     <a class="code" href="../../d8/d16/gc_8c.html#a39bb37371a2ddda30cc826e790ceda3c">deferred_final_list</a> = 0;
<a name="l02946"></a>02946 
<a name="l02947"></a>02947     <span class="keywordflow">if</span> (p) {
<a name="l02948"></a>02948         <a class="code" href="../../d8/d16/gc_8c.html#aeb6d71a1da244f134fa6b041f3f0bd8f">finalize_list</a>(objspace, p);
<a name="l02949"></a>02949     }
<a name="l02950"></a>02950 }
<a name="l02951"></a>02951 
<a name="l02952"></a>02952 <span class="keywordtype">void</span>
<a name="l02953"></a><a class="code" href="../../db/d2e/intern_8h.html#acf77a0f360adf8c044d9b5d181376376">02953</a> <a class="code" href="../../d8/d16/gc_8c.html#acf77a0f360adf8c044d9b5d181376376">rb_gc_finalize_deferred</a>(<span class="keywordtype">void</span>)
<a name="l02954"></a>02954 {
<a name="l02955"></a>02955     <a class="code" href="../../d8/d16/gc_8c.html#a7d391134c224f8807ff34d420811196a">finalize_deferred</a>(&amp;rb_objspace);
<a name="l02956"></a>02956 }
<a name="l02957"></a>02957 
<a name="l02958"></a>02958 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02959"></a><a class="code" href="../../d8/d16/gc_8c.html#a60a37c6a33bab7707d47883c6e000ec4">02959</a> <a class="code" href="../../d8/d16/gc_8c.html#a60a37c6a33bab7707d47883c6e000ec4">chain_finalized_object</a>(<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> val, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> arg)
<a name="l02960"></a>02960 {
<a name="l02961"></a>02961     <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *p = (<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *)key, **final_list = (<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> **)arg;
<a name="l02962"></a>02962     <span class="keywordflow">if</span> ((p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a> &amp; (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6c5ccf5e4d375da1c8f418ccd41c92bb">FL_FINALIZE</a>|<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a39ebc82a159cc4776f6ca7037cbd2e26">FL_MARK</a>)) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6c5ccf5e4d375da1c8f418ccd41c92bb">FL_FINALIZE</a>) {
<a name="l02963"></a>02963         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(p) != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ab80c70472770bcae8d33bbf6139262d0">T_ZOMBIE</a>) {
<a name="l02964"></a>02964             p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#af8cb8a1856ec08aeed677584f8930880">free</a>.flags = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a39ebc82a159cc4776f6ca7037cbd2e26">FL_MARK</a> | <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ab80c70472770bcae8d33bbf6139262d0">T_ZOMBIE</a>; <span class="comment">/* remain marked */</span>
<a name="l02965"></a>02965             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa38eb1376d31aae1fe0b334b9b76f2ef">RDATA</a>(p)-&gt;dfree = 0;
<a name="l02966"></a>02966         }
<a name="l02967"></a>02967         p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#af8cb8a1856ec08aeed677584f8930880">free</a>.next = *final_list;
<a name="l02968"></a>02968         *final_list = p;
<a name="l02969"></a>02969     }
<a name="l02970"></a>02970     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>;
<a name="l02971"></a>02971 }
<a name="l02972"></a>02972 
<a name="l02973"></a><a class="code" href="../../d0/d34/structforce__finalize__list.html">02973</a> <span class="keyword">struct </span><a class="code" href="../../d0/d34/structforce__finalize__list.html">force_finalize_list</a> {
<a name="l02974"></a><a class="code" href="../../d0/d34/structforce__finalize__list.html#aab17668e2eaca9e1435f0a32299e2565">02974</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d0/d34/structforce__finalize__list.html#aab17668e2eaca9e1435f0a32299e2565">obj</a>;
<a name="l02975"></a><a class="code" href="../../d0/d34/structforce__finalize__list.html#afdf0bdd173dc1fa44f5b05e574fe7941">02975</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d0/d34/structforce__finalize__list.html#afdf0bdd173dc1fa44f5b05e574fe7941">table</a>;
<a name="l02976"></a><a class="code" href="../../d0/d34/structforce__finalize__list.html#a6f2a710fd3d229d8fcf34b303a10abfd">02976</a>     <span class="keyword">struct </span><a class="code" href="../../d0/d34/structforce__finalize__list.html">force_finalize_list</a> *next;
<a name="l02977"></a>02977 };
<a name="l02978"></a>02978 
<a name="l02979"></a>02979 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02980"></a><a class="code" href="../../d8/d16/gc_8c.html#ab7a583df36b9648f9b0b2df53d25f56a">02980</a> <a class="code" href="../../d8/d16/gc_8c.html#ab7a583df36b9648f9b0b2df53d25f56a">force_chain_object</a>(<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> val, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> arg)
<a name="l02981"></a>02981 {
<a name="l02982"></a>02982     <span class="keyword">struct </span><a class="code" href="../../d0/d34/structforce__finalize__list.html">force_finalize_list</a> **<a class="code" href="../../d7/dc0/parse_8y.html#a71f8b6ffdc0cc58ffd989c3162fb2bcf">prev</a> = (<span class="keyword">struct </span><a class="code" href="../../d0/d34/structforce__finalize__list.html">force_finalize_list</a> **)arg;
<a name="l02983"></a>02983     <span class="keyword">struct </span><a class="code" href="../../d0/d34/structforce__finalize__list.html">force_finalize_list</a> *curr = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac8df5a8a8961bd9e16be385fef28c2f2">ALLOC</a>(<span class="keyword">struct</span> <a class="code" href="../../d0/d34/structforce__finalize__list.html">force_finalize_list</a>);
<a name="l02984"></a>02984     curr-&gt;<a class="code" href="../../d0/d34/structforce__finalize__list.html#aab17668e2eaca9e1435f0a32299e2565">obj</a> = key;
<a name="l02985"></a>02985     curr-&gt;<a class="code" href="../../d0/d34/structforce__finalize__list.html#afdf0bdd173dc1fa44f5b05e574fe7941">table</a> = val;
<a name="l02986"></a>02986     curr-&gt;<a class="code" href="../../d0/d34/structforce__finalize__list.html#a6f2a710fd3d229d8fcf34b303a10abfd">next</a> = *prev;
<a name="l02987"></a>02987     *prev = curr;
<a name="l02988"></a>02988     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>;
<a name="l02989"></a>02989 }
<a name="l02990"></a>02990 
<a name="l02991"></a>02991 <span class="keywordtype">void</span>
<a name="l02992"></a><a class="code" href="../../db/d2e/intern_8h.html#ac23f4325e1613f037383bfa0a925a81e">02992</a> <a class="code" href="../../d8/d16/gc_8c.html#ac23f4325e1613f037383bfa0a925a81e">rb_gc_call_finalizer_at_exit</a>(<span class="keywordtype">void</span>)
<a name="l02993"></a>02993 {
<a name="l02994"></a>02994     <a class="code" href="../../d8/d16/gc_8c.html#a18340727917773260d690cc32eeb7681">rb_objspace_call_finalizer</a>(&amp;rb_objspace);
<a name="l02995"></a>02995 }
<a name="l02996"></a>02996 
<a name="l02997"></a>02997 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02998"></a><a class="code" href="../../d8/d16/gc_8c.html#a18340727917773260d690cc32eeb7681">02998</a> <a class="code" href="../../d8/d16/gc_8c.html#a18340727917773260d690cc32eeb7681">rb_objspace_call_finalizer</a>(<a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace)
<a name="l02999"></a>02999 {
<a name="l03000"></a>03000     <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *p, *pend;
<a name="l03001"></a>03001     <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *final_list = 0;
<a name="l03002"></a>03002     <span class="keywordtype">size_t</span> i;
<a name="l03003"></a>03003 
<a name="l03004"></a>03004     <span class="comment">/* run finalizers */</span>
<a name="l03005"></a>03005     <a class="code" href="../../d8/d16/gc_8c.html#ab33ac0d8116118bd4eb59677ec4c3fe2">rest_sweep</a>(objspace);
<a name="l03006"></a>03006 
<a name="l03007"></a>03007     <span class="keywordflow">do</span> {
<a name="l03008"></a>03008         <span class="comment">/* XXX: this loop will make no sense */</span>
<a name="l03009"></a>03009         <span class="comment">/* because mark will not be removed */</span>
<a name="l03010"></a>03010         <a class="code" href="../../d8/d16/gc_8c.html#a7d391134c224f8807ff34d420811196a">finalize_deferred</a>(objspace);
<a name="l03011"></a>03011         <a class="code" href="../../d8/d16/gc_8c.html#a113604568481126fb9e62cec5ae99257">mark_tbl</a>(objspace, <a class="code" href="../../d8/d16/gc_8c.html#ad42bffe188d60ed392ba783bf4c5e91b">finalizer_table</a>, 0);
<a name="l03012"></a>03012         <a class="code" href="../../dd/d24/st_8h.html#ace5a79870d2800659a653fceeca55262">st_foreach</a>(<a class="code" href="../../d8/d16/gc_8c.html#ad42bffe188d60ed392ba783bf4c5e91b">finalizer_table</a>, <a class="code" href="../../d8/d16/gc_8c.html#a60a37c6a33bab7707d47883c6e000ec4">chain_finalized_object</a>,
<a name="l03013"></a>03013                    (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)&amp;<a class="code" href="../../d8/d16/gc_8c.html#a39bb37371a2ddda30cc826e790ceda3c">deferred_final_list</a>);
<a name="l03014"></a>03014     } <span class="keywordflow">while</span> (<a class="code" href="../../d8/d16/gc_8c.html#a39bb37371a2ddda30cc826e790ceda3c">deferred_final_list</a>);
<a name="l03015"></a>03015     <span class="comment">/* force to run finalizer */</span>
<a name="l03016"></a>03016     <span class="keywordflow">while</span> (<a class="code" href="../../d8/d16/gc_8c.html#ad42bffe188d60ed392ba783bf4c5e91b">finalizer_table</a>-&gt;num_entries) {
<a name="l03017"></a>03017         <span class="keyword">struct </span><a class="code" href="../../d0/d34/structforce__finalize__list.html">force_finalize_list</a> *list = 0;
<a name="l03018"></a>03018         <a class="code" href="../../dd/d24/st_8h.html#ace5a79870d2800659a653fceeca55262">st_foreach</a>(<a class="code" href="../../d8/d16/gc_8c.html#ad42bffe188d60ed392ba783bf4c5e91b">finalizer_table</a>, <a class="code" href="../../d8/d16/gc_8c.html#ab7a583df36b9648f9b0b2df53d25f56a">force_chain_object</a>, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)&amp;list);
<a name="l03019"></a>03019         <span class="keywordflow">while</span> (list) {
<a name="l03020"></a>03020             <span class="keyword">struct </span><a class="code" href="../../d0/d34/structforce__finalize__list.html">force_finalize_list</a> *curr = list;
<a name="l03021"></a>03021             <a class="code" href="../../d8/d16/gc_8c.html#a06250ce0d45ecc9e84030f0286064c78">run_finalizer</a>(objspace, <a class="code" href="../../d8/d16/gc_8c.html#a56eb26ff20f077eecdca272b83df1652">rb_obj_id</a>(curr-&gt;<a class="code" href="../../d0/d34/structforce__finalize__list.html#aab17668e2eaca9e1435f0a32299e2565">obj</a>), curr-&gt;<a class="code" href="../../d0/d34/structforce__finalize__list.html#afdf0bdd173dc1fa44f5b05e574fe7941">table</a>);
<a name="l03022"></a>03022             <a class="code" href="../../dd/d24/st_8h.html#aa04e4ee0a6e1f19e64f3be4668f41234">st_delete</a>(<a class="code" href="../../d8/d16/gc_8c.html#ad42bffe188d60ed392ba783bf4c5e91b">finalizer_table</a>, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>*)&amp;curr-&gt;<a class="code" href="../../d0/d34/structforce__finalize__list.html#aab17668e2eaca9e1435f0a32299e2565">obj</a>, 0);
<a name="l03023"></a>03023             list = curr-&gt;<a class="code" href="../../d0/d34/structforce__finalize__list.html#a6f2a710fd3d229d8fcf34b303a10abfd">next</a>;
<a name="l03024"></a>03024             <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(curr);
<a name="l03025"></a>03025         }
<a name="l03026"></a>03026     }
<a name="l03027"></a>03027 
<a name="l03028"></a>03028     <span class="comment">/* finalizers are part of garbage collection */</span>
<a name="l03029"></a>03029     <a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a>++;
<a name="l03030"></a>03030 
<a name="l03031"></a>03031     <span class="comment">/* run data object&apos;s finalizers */</span>
<a name="l03032"></a>03032     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a>; i++) {
<a name="l03033"></a>03033         p = objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#ad33de4cd59e7ea8cba62c94e024d6829">start</a>; pend = objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a4344f152198021b7a489fbcfbe187f44">end</a>;
<a name="l03034"></a>03034         <span class="keywordflow">while</span> (p &lt; pend) {
<a name="l03035"></a>03035             <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(p) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a55f295817faf14e42b3cff745a7ac706">T_DATA</a> &amp;&amp;
<a name="l03036"></a>03036                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abb509cfdf6560a9f795b1f6932d93691">DATA_PTR</a>(p) &amp;&amp; <a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(p)-&gt;as.data.dfree &amp;&amp;
<a name="l03037"></a>03037                 !<a class="code" href="../../de/de9/vm_8c.html#a7eda924b79844f890f5ba44800c1c520">rb_obj_is_thread</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)p) &amp;&amp; !<a class="code" href="../../d3/de7/thread_8c.html#ae85a523a4fd1c5ab592aae9c624ae0f5">rb_obj_is_mutex</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)p) &amp;&amp;
<a name="l03038"></a>03038                 !<a class="code" href="../../d5/d75/cont_8c.html#aac50fbfa1dd90fd1a398473aaf44714a">rb_obj_is_fiber</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)p)) {
<a name="l03039"></a>03039                 p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#af8cb8a1856ec08aeed677584f8930880">free</a>.flags = 0;
<a name="l03040"></a>03040                 <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac167240ec598e32f5ff3cdb902fb98b9">RTYPEDDATA_P</a>(p)) {
<a name="l03041"></a>03041                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa38eb1376d31aae1fe0b334b9b76f2ef">RDATA</a>(p)-&gt;dfree = <a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(p)-&gt;as.typeddata.type-&gt;function.dfree;
<a name="l03042"></a>03042                 }
<a name="l03043"></a>03043                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(p)-&gt;as.data.dfree == (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad83646c4b210a82fc3d1a1e723ffc931">RUBY_DATA_FUNC</a>)-1) {
<a name="l03044"></a>03044                     <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#abb509cfdf6560a9f795b1f6932d93691">DATA_PTR</a>(p));
<a name="l03045"></a>03045                 }
<a name="l03046"></a>03046                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(p)-&gt;as.data.dfree) {
<a name="l03047"></a>03047                     <a class="code" href="../../d8/d16/gc_8c.html#a240b3f2bf37a7bae8d4f43018cba0387">make_deferred</a>(<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(p));
<a name="l03048"></a>03048                     <a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(p)-&gt;as.free.next = final_list;
<a name="l03049"></a>03049                     final_list = p;
<a name="l03050"></a>03050                 }
<a name="l03051"></a>03051             }
<a name="l03052"></a>03052             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(p) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a>) {
<a name="l03053"></a>03053                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(p)-&gt;as.file.fptr) {
<a name="l03054"></a>03054                     <a class="code" href="../../d8/d16/gc_8c.html#aad601bcf0ca8b959ec5d7327b98e6dbc">make_io_deferred</a>(<a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(p));
<a name="l03055"></a>03055                     <a class="code" href="../../d8/d16/gc_8c.html#a939c65a72b7cac98a462a57983060290">RANY</a>(p)-&gt;as.free.next = final_list;
<a name="l03056"></a>03056                     final_list = p;
<a name="l03057"></a>03057                 }
<a name="l03058"></a>03058             }
<a name="l03059"></a>03059             p++;
<a name="l03060"></a>03060         }
<a name="l03061"></a>03061     }
<a name="l03062"></a>03062     <a class="code" href="../../d8/d16/gc_8c.html#ae52a2424d51749076e150ee5ee728350">during_gc</a> = 0;
<a name="l03063"></a>03063     <span class="keywordflow">if</span> (final_list) {
<a name="l03064"></a>03064         <a class="code" href="../../d8/d16/gc_8c.html#aeb6d71a1da244f134fa6b041f3f0bd8f">finalize_list</a>(objspace, final_list);
<a name="l03065"></a>03065     }
<a name="l03066"></a>03066 
<a name="l03067"></a>03067     <a class="code" href="../../dd/d24/st_8h.html#acb004847ef312373d65bfb0d1a21c5b3">st_free_table</a>(<a class="code" href="../../d8/d16/gc_8c.html#ad42bffe188d60ed392ba783bf4c5e91b">finalizer_table</a>);
<a name="l03068"></a>03068     <a class="code" href="../../d8/d16/gc_8c.html#ad42bffe188d60ed392ba783bf4c5e91b">finalizer_table</a> = 0;
<a name="l03069"></a>03069 }
<a name="l03070"></a>03070 
<a name="l03071"></a>03071 <span class="keywordtype">void</span>
<a name="l03072"></a><a class="code" href="../../db/d2e/intern_8h.html#a7a12ca86b76e272a301173e7661acfea">03072</a> <a class="code" href="../../d8/d16/gc_8c.html#a7a12ca86b76e272a301173e7661acfea">rb_gc</a>(<span class="keywordtype">void</span>)
<a name="l03073"></a>03073 {
<a name="l03074"></a>03074     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l03075"></a>03075     <a class="code" href="../../d8/d16/gc_8c.html#ae40ead8ed1ce1ae638710978a3fc8ff3">garbage_collect</a>(objspace);
<a name="l03076"></a>03076     <a class="code" href="../../d8/d16/gc_8c.html#a7d391134c224f8807ff34d420811196a">finalize_deferred</a>(objspace);
<a name="l03077"></a>03077     <a class="code" href="../../d8/d16/gc_8c.html#a56d5d60ded6c80b927508340f4211373">free_unused_heaps</a>(objspace);
<a name="l03078"></a>03078 }
<a name="l03079"></a>03079 
<a name="l03080"></a>03080 <span class="comment">/*</span>
<a name="l03081"></a>03081 <span class="comment"> *  call-seq:</span>
<a name="l03082"></a>03082 <span class="comment"> *     ObjectSpace._id2ref(object_id) -&gt; an_object</span>
<a name="l03083"></a>03083 <span class="comment"> *</span>
<a name="l03084"></a>03084 <span class="comment"> *  Converts an object id to a reference to the object. May not be</span>
<a name="l03085"></a>03085 <span class="comment"> *  called on an object id passed as a parameter to a finalizer.</span>
<a name="l03086"></a>03086 <span class="comment"> *</span>
<a name="l03087"></a>03087 <span class="comment"> *     s = &quot;I am a string&quot;                    #=&gt; &quot;I am a string&quot;</span>
<a name="l03088"></a>03088 <span class="comment"> *     r = ObjectSpace._id2ref(s.object_id)   #=&gt; &quot;I am a string&quot;</span>
<a name="l03089"></a>03089 <span class="comment"> *     r == s                                 #=&gt; true</span>
<a name="l03090"></a>03090 <span class="comment"> *</span>
<a name="l03091"></a>03091 <span class="comment"> */</span>
<a name="l03092"></a>03092 
<a name="l03093"></a>03093 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03094"></a><a class="code" href="../../d8/d16/gc_8c.html#adb9edc66b7276c11c435f7bfda57bc85">03094</a> <a class="code" href="../../d8/d16/gc_8c.html#adb9edc66b7276c11c435f7bfda57bc85">id2ref</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d0/d34/structforce__finalize__list.html#aab17668e2eaca9e1435f0a32299e2565">obj</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> objid)
<a name="l03095"></a>03095 {
<a name="l03096"></a>03096 <span class="preprocessor">#if SIZEOF_LONG == SIZEOF_VOIDP</span>
<a name="l03097"></a>03097 <span class="preprocessor"></span><span class="preprocessor">#define NUM2PTR(x) NUM2ULONG(x)</span>
<a name="l03098"></a>03098 <span class="preprocessor"></span><span class="preprocessor">#elif SIZEOF_LONG_LONG == SIZEOF_VOIDP</span>
<a name="l03099"></a>03099 <span class="preprocessor"></span><span class="preprocessor">#define NUM2PTR(x) NUM2ULL(x)</span>
<a name="l03100"></a>03100 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l03101"></a>03101 <span class="preprocessor"></span>    <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l03102"></a>03102     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ptr;
<a name="l03103"></a>03103     <span class="keywordtype">void</span> *p0;
<a name="l03104"></a>03104 
<a name="l03105"></a>03105     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a98b91af598acb64fe8497413ce498766">rb_secure</a>(4);
<a name="l03106"></a>03106     ptr = <a class="code" href="../../de/d81/dl_8h.html#a1bfda858388d9fde65ce0debd0b6879c">NUM2PTR</a>(objid);
<a name="l03107"></a>03107     p0 = (<span class="keywordtype">void</span> *)ptr;
<a name="l03108"></a>03108 
<a name="l03109"></a>03109     <span class="keywordflow">if</span> (ptr == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l03110"></a>03110     <span class="keywordflow">if</span> (ptr == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l03111"></a>03111     <span class="keywordflow">if</span> (ptr == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03112"></a>03112     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#acf2fcf97dcf9c7c35452730eb3e2aeb2">FIXNUM_P</a>(ptr)) <span class="keywordflow">return</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)ptr;
<a name="l03113"></a>03113     ptr = objid ^ <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5a54e4921ce5d7fc253339e79eb6f0b7">FIXNUM_FLAG</a>;  <span class="comment">/* unset FIXNUM_FLAG */</span>
<a name="l03114"></a>03114 
<a name="l03115"></a>03115     <span class="keywordflow">if</span> ((ptr % <span class="keyword">sizeof</span>(<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a>)) == (4 &lt;&lt; 2)) {
<a name="l03116"></a>03116         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> symid = ptr / <span class="keyword">sizeof</span>(<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a>);
<a name="l03117"></a>03117         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d11/ripper_8c.html#a877bc58c495643fcf49dc64c44631e72">rb_id2name</a>(symid) == 0)
<a name="l03118"></a>03118             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a5211161e80760c30e2e009ae0bee7be8">rb_eRangeError</a>, <span class="stringliteral">&quot;%p is not symbol id value&quot;</span>, p0);
<a name="l03119"></a>03119         <span class="keywordflow">return</span> <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(symid);
<a name="l03120"></a>03120     }
<a name="l03121"></a>03121 
<a name="l03122"></a>03122     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d16/gc_8c.html#a7cbe2fa2f2f134649873d6cc1bac0238">is_pointer_to_heap</a>(objspace, (<span class="keywordtype">void</span> *)ptr) ||
<a name="l03123"></a>03123         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(ptr) &gt; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a523855de5546c34061e030f4606db3e9">T_FIXNUM</a> || <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(ptr) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a82c8c4569748b9645c958b9eaeaabb81">T_ICLASS</a>) {
<a name="l03124"></a>03124         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a5211161e80760c30e2e009ae0bee7be8">rb_eRangeError</a>, <span class="stringliteral">&quot;%p is not id value&quot;</span>, p0);
<a name="l03125"></a>03125     }
<a name="l03126"></a>03126     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(ptr) == 0 || <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1d4c05021aacd8cab989ff60f95ebe2d">RBASIC</a>(ptr)-&gt;klass == 0) {
<a name="l03127"></a>03127         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a5211161e80760c30e2e009ae0bee7be8">rb_eRangeError</a>, <span class="stringliteral">&quot;%p is recycled object&quot;</span>, p0);
<a name="l03128"></a>03128     }
<a name="l03129"></a>03129     <span class="keywordflow">return</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)ptr;
<a name="l03130"></a>03130 }
<a name="l03131"></a>03131 
<a name="l03132"></a>03132 <span class="comment">/*</span>
<a name="l03133"></a>03133 <span class="comment"> *  Document-method: __id__</span>
<a name="l03134"></a>03134 <span class="comment"> *  Document-method: object_id</span>
<a name="l03135"></a>03135 <span class="comment"> *</span>
<a name="l03136"></a>03136 <span class="comment"> *  call-seq:</span>
<a name="l03137"></a>03137 <span class="comment"> *     obj.__id__       -&gt; fixnum</span>
<a name="l03138"></a>03138 <span class="comment"> *     obj.object_id    -&gt; fixnum</span>
<a name="l03139"></a>03139 <span class="comment"> *</span>
<a name="l03140"></a>03140 <span class="comment"> *  Returns an integer identifier for &lt;i&gt;obj&lt;/i&gt;. The same number will</span>
<a name="l03141"></a>03141 <span class="comment"> *  be returned on all calls to &lt;code&gt;id&lt;/code&gt; for a given object, and</span>
<a name="l03142"></a>03142 <span class="comment"> *  no two active objects will share an id.</span>
<a name="l03143"></a>03143 <span class="comment"> *  &lt;code&gt;Object#object_id&lt;/code&gt; is a different concept from the</span>
<a name="l03144"></a>03144 <span class="comment"> *  &lt;code&gt;:name&lt;/code&gt; notation, which returns the symbol id of</span>
<a name="l03145"></a>03145 <span class="comment"> *  &lt;code&gt;name&lt;/code&gt;. Replaces the deprecated &lt;code&gt;Object#id&lt;/code&gt;.</span>
<a name="l03146"></a>03146 <span class="comment"> */</span>
<a name="l03147"></a>03147 
<a name="l03148"></a>03148 <span class="comment">/*</span>
<a name="l03149"></a>03149 <span class="comment"> *  call-seq:</span>
<a name="l03150"></a>03150 <span class="comment"> *     obj.hash    -&gt; fixnum</span>
<a name="l03151"></a>03151 <span class="comment"> *</span>
<a name="l03152"></a>03152 <span class="comment"> *  Generates a &lt;code&gt;Fixnum&lt;/code&gt; hash value for this object. This</span>
<a name="l03153"></a>03153 <span class="comment"> *  function must have the property that &lt;code&gt;a.eql?(b)&lt;/code&gt; implies</span>
<a name="l03154"></a>03154 <span class="comment"> *  &lt;code&gt;a.hash == b.hash&lt;/code&gt;. The hash value is used by class</span>
<a name="l03155"></a>03155 <span class="comment"> *  &lt;code&gt;Hash&lt;/code&gt;. Any hash value that exceeds the capacity of a</span>
<a name="l03156"></a>03156 <span class="comment"> *  &lt;code&gt;Fixnum&lt;/code&gt; will be truncated before being used.</span>
<a name="l03157"></a>03157 <span class="comment"> */</span>
<a name="l03158"></a>03158 
<a name="l03159"></a>03159 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03160"></a><a class="code" href="../../db/d2e/intern_8h.html#a6b445c73a46da064e2a1fa8a3a248a64">03160</a> <a class="code" href="../../d8/d16/gc_8c.html#a56eb26ff20f077eecdca272b83df1652">rb_obj_id</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d0/d34/structforce__finalize__list.html#aab17668e2eaca9e1435f0a32299e2565">obj</a>)
<a name="l03161"></a>03161 {
<a name="l03162"></a>03162     <span class="comment">/*</span>
<a name="l03163"></a>03163 <span class="comment">     *                32-bit VALUE space</span>
<a name="l03164"></a>03164 <span class="comment">     *          MSB ------------------------ LSB</span>
<a name="l03165"></a>03165 <span class="comment">     *  false   00000000000000000000000000000000</span>
<a name="l03166"></a>03166 <span class="comment">     *  true    00000000000000000000000000000010</span>
<a name="l03167"></a>03167 <span class="comment">     *  nil     00000000000000000000000000000100</span>
<a name="l03168"></a>03168 <span class="comment">     *  undef   00000000000000000000000000000110</span>
<a name="l03169"></a>03169 <span class="comment">     *  symbol  ssssssssssssssssssssssss00001110</span>
<a name="l03170"></a>03170 <span class="comment">     *  object  oooooooooooooooooooooooooooooo00        = 0 (mod sizeof(RVALUE))</span>
<a name="l03171"></a>03171 <span class="comment">     *  fixnum  fffffffffffffffffffffffffffffff1</span>
<a name="l03172"></a>03172 <span class="comment">     *</span>
<a name="l03173"></a>03173 <span class="comment">     *                    object_id space</span>
<a name="l03174"></a>03174 <span class="comment">     *                                       LSB</span>
<a name="l03175"></a>03175 <span class="comment">     *  false   00000000000000000000000000000000</span>
<a name="l03176"></a>03176 <span class="comment">     *  true    00000000000000000000000000000010</span>
<a name="l03177"></a>03177 <span class="comment">     *  nil     00000000000000000000000000000100</span>
<a name="l03178"></a>03178 <span class="comment">     *  undef   00000000000000000000000000000110</span>
<a name="l03179"></a>03179 <span class="comment">     *  symbol   000SSSSSSSSSSSSSSSSSSSSSSSSSSS0        S...S % A = 4 (S...S = s...s * A + 4)</span>
<a name="l03180"></a>03180 <span class="comment">     *  object   oooooooooooooooooooooooooooooo0        o...o % A = 0</span>
<a name="l03181"></a>03181 <span class="comment">     *  fixnum  fffffffffffffffffffffffffffffff1        bignum if required</span>
<a name="l03182"></a>03182 <span class="comment">     *</span>
<a name="l03183"></a>03183 <span class="comment">     *  where A = sizeof(RVALUE)/4</span>
<a name="l03184"></a>03184 <span class="comment">     *</span>
<a name="l03185"></a>03185 <span class="comment">     *  sizeof(RVALUE) is</span>
<a name="l03186"></a>03186 <span class="comment">     *  20 if 32-bit, double is 4-byte aligned</span>
<a name="l03187"></a>03187 <span class="comment">     *  24 if 32-bit, double is 8-byte aligned</span>
<a name="l03188"></a>03188 <span class="comment">     *  40 if 64-bit</span>
<a name="l03189"></a>03189 <span class="comment">     */</span>
<a name="l03190"></a>03190     <span class="keywordflow">if</span> (<a class="code" href="../../dc/d0c/cparse_8c.html#a637bc5a232034ee3fd411f8bef091566">SYMBOL_P</a>(obj)) {
<a name="l03191"></a>03191         <span class="keywordflow">return</span> (<a class="code" href="../../dc/d0c/cparse_8c.html#a73ce5202e6172d3ad0bab7d1e0df9dae">SYM2ID</a>(obj) * <span class="keyword">sizeof</span>(<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a>) + (4 &lt;&lt; 2)) | <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5a54e4921ce5d7fc253339e79eb6f0b7">FIXNUM_FLAG</a>;
<a name="l03192"></a>03192     }
<a name="l03193"></a>03193     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac59489a7ed093e29019047d13e79c009">SPECIAL_CONST_P</a>(obj)) {
<a name="l03194"></a>03194         <span class="keywordflow">return</span> <a class="code" href="../../dc/d0c/cparse_8c.html#af1afba1194a12547a1e65d92abf03b03">LONG2NUM</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac1cf124db1e117ff7d61d608024f63ee">SIGNED_VALUE</a>)obj);
<a name="l03195"></a>03195     }
<a name="l03196"></a>03196     <span class="keywordflow">return</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac1cf124db1e117ff7d61d608024f63ee">SIGNED_VALUE</a>)obj|<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5a54e4921ce5d7fc253339e79eb6f0b7">FIXNUM_FLAG</a>);
<a name="l03197"></a>03197 }
<a name="l03198"></a>03198 
<a name="l03199"></a>03199 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l03200"></a><a class="code" href="../../d8/d16/gc_8c.html#a081ede47c1f2f94045ad4efd298bc9c3">03200</a> <a class="code" href="../../d8/d16/gc_8c.html#a081ede47c1f2f94045ad4efd298bc9c3">set_zero</a>(<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> val, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> arg)
<a name="l03201"></a>03201 {
<a name="l03202"></a>03202     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> k = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)key;
<a name="l03203"></a>03203     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/deb/lex_8c.html#a5541f85ce416df233cce93949f0eeeca">hash</a> = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)arg;
<a name="l03204"></a>03204     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, k, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0));
<a name="l03205"></a>03205     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>;
<a name="l03206"></a>03206 }
<a name="l03207"></a>03207 
<a name="l03208"></a>03208 <span class="comment">/*</span>
<a name="l03209"></a>03209 <span class="comment"> *  call-seq:</span>
<a name="l03210"></a>03210 <span class="comment"> *     ObjectSpace.count_objects([result_hash]) -&gt; hash</span>
<a name="l03211"></a>03211 <span class="comment"> *</span>
<a name="l03212"></a>03212 <span class="comment"> *  Counts objects for each type.</span>
<a name="l03213"></a>03213 <span class="comment"> *</span>
<a name="l03214"></a>03214 <span class="comment"> *  It returns a hash as:</span>
<a name="l03215"></a>03215 <span class="comment"> *  {:TOTAL=&gt;10000, :FREE=&gt;3011, :T_OBJECT=&gt;6, :T_CLASS=&gt;404, ...}</span>
<a name="l03216"></a>03216 <span class="comment"> *</span>
<a name="l03217"></a>03217 <span class="comment"> *  If the optional argument, result_hash, is given,</span>
<a name="l03218"></a>03218 <span class="comment"> *  it is overwritten and returned.</span>
<a name="l03219"></a>03219 <span class="comment"> *  This is intended to avoid probe effect.</span>
<a name="l03220"></a>03220 <span class="comment"> *</span>
<a name="l03221"></a>03221 <span class="comment"> *  The contents of the returned hash is implementation defined.</span>
<a name="l03222"></a>03222 <span class="comment"> *  It may be changed in future.</span>
<a name="l03223"></a>03223 <span class="comment"> *</span>
<a name="l03224"></a>03224 <span class="comment"> *  This method is not expected to work except C Ruby.</span>
<a name="l03225"></a>03225 <span class="comment"> *</span>
<a name="l03226"></a>03226 <span class="comment"> */</span>
<a name="l03227"></a>03227 
<a name="l03228"></a>03228 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03229"></a><a class="code" href="../../d8/d16/gc_8c.html#a0564118b9022b4dd8eabf49431d32a93">03229</a> <a class="code" href="../../d8/d16/gc_8c.html#a0564118b9022b4dd8eabf49431d32a93">count_objects</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> os)
<a name="l03230"></a>03230 {
<a name="l03231"></a>03231     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l03232"></a>03232     <span class="keywordtype">size_t</span> counts[<a class="code" href="../../d7/d6c/md5_8c.html#a2d8a5083a030f6b36bc9a5fe6d71b519">T_MASK</a>+1];
<a name="l03233"></a>03233     <span class="keywordtype">size_t</span> freed = 0;
<a name="l03234"></a>03234     <span class="keywordtype">size_t</span> total = 0;
<a name="l03235"></a>03235     <span class="keywordtype">size_t</span> i;
<a name="l03236"></a>03236     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/deb/lex_8c.html#a5541f85ce416df233cce93949f0eeeca">hash</a>;
<a name="l03237"></a>03237 
<a name="l03238"></a>03238     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;01&quot;</span>, &amp;hash) == 1) {
<a name="l03239"></a>03239         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(hash) != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8357e81bbb60cb41b0a292a90653a5e5">T_HASH</a>)
<a name="l03240"></a>03240             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a565ed9d70f4089e1b4a36e9b3381b8c6">rb_eTypeError</a>, <span class="stringliteral">&quot;non-hash given&quot;</span>);
<a name="l03241"></a>03241     }
<a name="l03242"></a>03242 
<a name="l03243"></a>03243     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="../../d7/d6c/md5_8c.html#a2d8a5083a030f6b36bc9a5fe6d71b519">T_MASK</a>; i++) {
<a name="l03244"></a>03244         counts[i] = 0;
<a name="l03245"></a>03245     }
<a name="l03246"></a>03246 
<a name="l03247"></a>03247     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d16/gc_8c.html#a3a7eaa4eeebccbdae67fa200b033b363">heaps_used</a>; i++) {
<a name="l03248"></a>03248         <a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html">RVALUE</a> *p, *pend;
<a name="l03249"></a>03249 
<a name="l03250"></a>03250         p = objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#ad33de4cd59e7ea8cba62c94e024d6829">start</a>; pend = objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a4344f152198021b7a489fbcfbe187f44">end</a>;
<a name="l03251"></a>03251         <span class="keywordflow">for</span> (;p &lt; pend; p++) {
<a name="l03252"></a>03252             <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a19413c6e861a5646206f44424d71185c">as</a>.<a class="code" href="../../db/d8e/struct_r_v_a_l_u_e.html#a362957992e4b95641a6fad10f5037bcb">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a>) {
<a name="l03253"></a>03253                 counts[<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(p)]++;
<a name="l03254"></a>03254             }
<a name="l03255"></a>03255             <span class="keywordflow">else</span> {
<a name="l03256"></a>03256                 freed++;
<a name="l03257"></a>03257             }
<a name="l03258"></a>03258         }
<a name="l03259"></a>03259         total += objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a9915442cbe889991faa75a1a01422624">sorted</a>[i].<a class="code" href="../../d8/d95/structsorted__heaps__slot.html#a79843785a726ea01bb4683ad9ba055d3">slot</a>-&gt;<a class="code" href="../../da/dda/structheaps__slot.html#aab5626f69fb1dff0779d330d780bd928">limit</a>;
<a name="l03260"></a>03260     }
<a name="l03261"></a>03261 
<a name="l03262"></a>03262     <span class="keywordflow">if</span> (hash == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>) {
<a name="l03263"></a>03263         hash = <a class="code" href="../../d1/d04/hash_8c.html#af1da586524a3a1739fd5b91272037815">rb_hash_new</a>();
<a name="l03264"></a>03264     }
<a name="l03265"></a>03265     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae6e9dfb04b81ecb03ec6c087498521ea">RHASH_EMPTY_P</a>(hash)) {
<a name="l03266"></a>03266         <a class="code" href="../../dd/d24/st_8h.html#ace5a79870d2800659a653fceeca55262">st_foreach</a>(<a class="code" href="../../d9/dee/tkutil_8c.html#ad8dd7fb0cbee1955c393251e8bb97233">RHASH_TBL</a>(hash), <a class="code" href="../../d8/d16/gc_8c.html#a081ede47c1f2f94045ad4efd298bc9c3">set_zero</a>, hash);
<a name="l03267"></a>03267     }
<a name="l03268"></a>03268     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;TOTAL&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(total));
<a name="l03269"></a>03269     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;FREE&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(freed));
<a name="l03270"></a>03270 
<a name="l03271"></a>03271     <span class="keywordflow">for</span> (i = 0; i &lt;= <a class="code" href="../../d7/d6c/md5_8c.html#a2d8a5083a030f6b36bc9a5fe6d71b519">T_MASK</a>; i++) {
<a name="l03272"></a>03272         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>;
<a name="l03273"></a>03273         <span class="keywordflow">switch</span> (i) {
<a name="l03274"></a>03274 <span class="preprocessor">#define COUNT_TYPE(t) case (t): type = ID2SYM(rb_intern(#t)); break;</span>
<a name="l03275"></a>03275 <span class="preprocessor"></span>            <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5efefe46b598af6f98c691fead03682d">T_NONE</a>);
<a name="l03276"></a>03276             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#abed71c72d5c3083041d52ad25630270e">T_OBJECT</a>);
<a name="l03277"></a>03277             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad04c63d175774c6d6e7dfaf0f0a982c9">T_CLASS</a>);
<a name="l03278"></a>03278             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6cdc7dfe8f84777325da08a96ae5f795">T_MODULE</a>);
<a name="l03279"></a>03279             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3d072e0c25cf678e9b8601b957b92eae">T_FLOAT</a>);
<a name="l03280"></a>03280             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a22a8c2a4bbaae9b68f65c9bb92fd4e39">T_STRING</a>);
<a name="l03281"></a>03281             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afd5c1e36d171ecc04514332e8dcf6388">T_REGEXP</a>);
<a name="l03282"></a>03282             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a>);
<a name="l03283"></a>03283             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8357e81bbb60cb41b0a292a90653a5e5">T_HASH</a>);
<a name="l03284"></a>03284             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4853f60a017b2b7a126d3e23db98a954">T_STRUCT</a>);
<a name="l03285"></a>03285             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a41ac74a27dd1eadc2ca86d10590f2163">T_BIGNUM</a>);
<a name="l03286"></a>03286             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a>);
<a name="l03287"></a>03287             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a55f295817faf14e42b3cff745a7ac706">T_DATA</a>);
<a name="l03288"></a>03288             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#acc66e9c9228bc7ad6f292a253ce5fdf4">T_MATCH</a>);
<a name="l03289"></a>03289             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a05f3b14562e8d1e2d09e7a4438c1d2fa">T_COMPLEX</a>);
<a name="l03290"></a>03290             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a804d1259cf2408f16969b2dc06b293fc">T_RATIONAL</a>);
<a name="l03291"></a>03291             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3a7d10c48d5dff0a5d4aa94acb74811a">T_NIL</a>);
<a name="l03292"></a>03292             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7fc7e09f45d0ef129ea29f3a5b0c32b8">T_TRUE</a>);
<a name="l03293"></a>03293             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9ab816c37c9173898ff256b7be9e5ea9">T_FALSE</a>);
<a name="l03294"></a>03294             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9aadbc1e9c456506a4d7eef5cdc787e">T_SYMBOL</a>);
<a name="l03295"></a>03295             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a523855de5546c34061e030f4606db3e9">T_FIXNUM</a>);
<a name="l03296"></a>03296             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa4f8e81f0956ff42a2e18ae2ff115f44">T_UNDEF</a>);
<a name="l03297"></a>03297             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5f1cc49c4da51d5bdffa64be79ff6fb0">T_NODE</a>);
<a name="l03298"></a>03298             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a82c8c4569748b9645c958b9eaeaabb81">T_ICLASS</a>);
<a name="l03299"></a>03299             <a class="code" href="../../d3/d4e/objspace_8c.html#a47838c29131badbfa19a6ee20c55e4b8">COUNT_TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ab80c70472770bcae8d33bbf6139262d0">T_ZOMBIE</a>);
<a name="l03300"></a>03300 <span class="preprocessor">#undef COUNT_TYPE</span>
<a name="l03301"></a>03301 <span class="preprocessor"></span>          <span class="keywordflow">default</span>:              type = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(i); <span class="keywordflow">break</span>;
<a name="l03302"></a>03302         }
<a name="l03303"></a>03303         <span class="keywordflow">if</span> (counts[i])
<a name="l03304"></a>03304             <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, type, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(counts[i]));
<a name="l03305"></a>03305     }
<a name="l03306"></a>03306 
<a name="l03307"></a>03307     <span class="keywordflow">return</span> hash;
<a name="l03308"></a>03308 }
<a name="l03309"></a>03309 
<a name="l03310"></a>03310 <span class="comment">/*</span>
<a name="l03311"></a>03311 <span class="comment"> *  call-seq:</span>
<a name="l03312"></a>03312 <span class="comment"> *     GC.count -&gt; Integer</span>
<a name="l03313"></a>03313 <span class="comment"> *</span>
<a name="l03314"></a>03314 <span class="comment"> *  The number of times GC occurred.</span>
<a name="l03315"></a>03315 <span class="comment"> *</span>
<a name="l03316"></a>03316 <span class="comment"> *  It returns the number of times GC occurred since the process started.</span>
<a name="l03317"></a>03317 <span class="comment"> *</span>
<a name="l03318"></a>03318 <span class="comment"> */</span>
<a name="l03319"></a>03319 
<a name="l03320"></a>03320 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03321"></a><a class="code" href="../../d8/d16/gc_8c.html#a44972f40a83e240e6a68bcf135a80e22">03321</a> <a class="code" href="../../d8/d16/gc_8c.html#a44972f40a83e240e6a68bcf135a80e22">gc_count</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l03322"></a>03322 {
<a name="l03323"></a>03323     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6eb3054f7a740d26c133d34ae6afdf2c">UINT2NUM</a>((&amp;rb_objspace)-&gt;<a class="code" href="../../d5/db5/encoding_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>);
<a name="l03324"></a>03324 }
<a name="l03325"></a>03325 
<a name="l03326"></a>03326 <span class="comment">/*</span>
<a name="l03327"></a>03327 <span class="comment"> *  call-seq:</span>
<a name="l03328"></a>03328 <span class="comment"> *     GC.stat -&gt; Hash</span>
<a name="l03329"></a>03329 <span class="comment"> *</span>
<a name="l03330"></a>03330 <span class="comment"> *  Returns a Hash containing information about the GC.</span>
<a name="l03331"></a>03331 <span class="comment"> *</span>
<a name="l03332"></a>03332 <span class="comment"> *  The hash includes information about internal statistics about GC such as:</span>
<a name="l03333"></a>03333 <span class="comment"> *</span>
<a name="l03334"></a>03334 <span class="comment"> *    {</span>
<a name="l03335"></a>03335 <span class="comment"> *      :count          =&gt; 18,</span>
<a name="l03336"></a>03336 <span class="comment"> *      :heap_used      =&gt; 77,</span>
<a name="l03337"></a>03337 <span class="comment"> *      :heap_length    =&gt; 77,</span>
<a name="l03338"></a>03338 <span class="comment"> *      :heap_increment =&gt; 0,</span>
<a name="l03339"></a>03339 <span class="comment"> *      :heap_live_num  =&gt; 23287,</span>
<a name="l03340"></a>03340 <span class="comment"> *      :heap_free_num  =&gt; 8115,</span>
<a name="l03341"></a>03341 <span class="comment"> *      :heap_final_num =&gt; 0,</span>
<a name="l03342"></a>03342 <span class="comment"> *    }</span>
<a name="l03343"></a>03343 <span class="comment"> *</span>
<a name="l03344"></a>03344 <span class="comment"> *  The contents of the hash are implementation defined and may be changed in</span>
<a name="l03345"></a>03345 <span class="comment"> *  the future.</span>
<a name="l03346"></a>03346 <span class="comment"> *</span>
<a name="l03347"></a>03347 <span class="comment"> *  This method is only expected to work on C Ruby.</span>
<a name="l03348"></a>03348 <span class="comment"> *</span>
<a name="l03349"></a>03349 <span class="comment"> */</span>
<a name="l03350"></a>03350 
<a name="l03351"></a>03351 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03352"></a><a class="code" href="../../d8/d16/gc_8c.html#a4552d09da94fd3d799b8897619502ae7">03352</a> <a class="code" href="../../d8/d16/gc_8c.html#a4552d09da94fd3d799b8897619502ae7">gc_stat</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l03353"></a>03353 {
<a name="l03354"></a>03354     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l03355"></a>03355     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/deb/lex_8c.html#a5541f85ce416df233cce93949f0eeeca">hash</a>;
<a name="l03356"></a>03356 
<a name="l03357"></a>03357     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;01&quot;</span>, &amp;hash) == 1) {
<a name="l03358"></a>03358         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(hash) != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8357e81bbb60cb41b0a292a90653a5e5">T_HASH</a>)
<a name="l03359"></a>03359             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a565ed9d70f4089e1b4a36e9b3381b8c6">rb_eTypeError</a>, <span class="stringliteral">&quot;non-hash given&quot;</span>);
<a name="l03360"></a>03360     }
<a name="l03361"></a>03361 
<a name="l03362"></a>03362     <span class="keywordflow">if</span> (hash == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>) {
<a name="l03363"></a>03363         hash = <a class="code" href="../../d1/d04/hash_8c.html#af1da586524a3a1739fd5b91272037815">rb_hash_new</a>();
<a name="l03364"></a>03364     }
<a name="l03365"></a>03365 
<a name="l03366"></a>03366     <a class="code" href="../../d8/d16/gc_8c.html#ab33ac0d8116118bd4eb59677ec4c3fe2">rest_sweep</a>(objspace);
<a name="l03367"></a>03367 
<a name="l03368"></a>03368     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;count&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#ab44b67a8f5128f8aac3c3c340d91d8dd">count</a>));
<a name="l03369"></a>03369 
<a name="l03370"></a>03370     <span class="comment">/* implementation dependent counters */</span>
<a name="l03371"></a>03371     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;heap_used&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a6a88982f921ff8b85c5c913c7efe723d">used</a>));
<a name="l03372"></a>03372     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;heap_length&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a3705ff04c752801f7cf54eb4d21a764e">length</a>));
<a name="l03373"></a>03373     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;heap_increment&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a8fb2c405ac1e0f78f5b8c66f8500178a">increment</a>));
<a name="l03374"></a>03374     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;heap_live_num&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a18e3fbf186b1889395e01baebaa4d8e5">live_num</a>));
<a name="l03375"></a>03375     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;heap_free_num&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#adae35865d1de5847544a532a63c451fa">free_num</a>));
<a name="l03376"></a>03376     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;heap_final_num&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a0f7c10b7414389846ff9aed2f5a555a7">heap</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#a3fcb169372e6a22e464737dd3346cbae">final_num</a>));
<a name="l03377"></a>03377     <span class="keywordflow">return</span> hash;
<a name="l03378"></a>03378 }
<a name="l03379"></a>03379 
<a name="l03380"></a>03380 
<a name="l03381"></a>03381 <span class="preprocessor">#if CALC_EXACT_MALLOC_SIZE</span>
<a name="l03382"></a>03382 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l03383"></a>03383 <span class="comment"> *  call-seq:</span>
<a name="l03384"></a>03384 <span class="comment"> *     GC.malloc_allocated_size -&gt; Integer</span>
<a name="l03385"></a>03385 <span class="comment"> *</span>
<a name="l03386"></a>03386 <span class="comment"> *  The allocated size by malloc().</span>
<a name="l03387"></a>03387 <span class="comment"> *</span>
<a name="l03388"></a>03388 <span class="comment"> *  It returns the allocated size by malloc().</span>
<a name="l03389"></a>03389 <span class="comment"> */</span>
<a name="l03390"></a>03390 
<a name="l03391"></a>03391 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03392"></a>03392 gc_malloc_allocated_size(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l03393"></a>03393 {
<a name="l03394"></a>03394     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6eb3054f7a740d26c133d34ae6afdf2c">UINT2NUM</a>((&amp;rb_objspace)-&gt;malloc_params.allocated_size);
<a name="l03395"></a>03395 }
<a name="l03396"></a>03396 
<a name="l03397"></a>03397 <span class="comment">/*</span>
<a name="l03398"></a>03398 <span class="comment"> *  call-seq:</span>
<a name="l03399"></a>03399 <span class="comment"> *     GC.malloc_allocations -&gt; Integer</span>
<a name="l03400"></a>03400 <span class="comment"> *</span>
<a name="l03401"></a>03401 <span class="comment"> *  The number of allocated memory object by malloc().</span>
<a name="l03402"></a>03402 <span class="comment"> *</span>
<a name="l03403"></a>03403 <span class="comment"> *  It returns the number of allocated memory object by malloc().</span>
<a name="l03404"></a>03404 <span class="comment"> */</span>
<a name="l03405"></a>03405 
<a name="l03406"></a>03406 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03407"></a>03407 gc_malloc_allocations(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l03408"></a>03408 {
<a name="l03409"></a>03409     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6eb3054f7a740d26c133d34ae6afdf2c">UINT2NUM</a>((&amp;rb_objspace)-&gt;malloc_params.allocations);
<a name="l03410"></a>03410 }
<a name="l03411"></a>03411 <span class="preprocessor">#endif</span>
<a name="l03412"></a>03412 <span class="preprocessor"></span>
<a name="l03413"></a>03413 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03414"></a><a class="code" href="../../d8/d16/gc_8c.html#a8c8be12c00dcde320e317bb9734c9835">03414</a> <a class="code" href="../../d8/d16/gc_8c.html#a8c8be12c00dcde320e317bb9734c9835">gc_profile_record_get</a>(<span class="keywordtype">void</span>)
<a name="l03415"></a>03415 {
<a name="l03416"></a>03416     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> prof;
<a name="l03417"></a>03417     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> gc_profile = <a class="code" href="../../dc/dcc/array_8c.html#a9518114fd36cb4ef4656ec1dc63348c9">rb_ary_new</a>();
<a name="l03418"></a>03418     <span class="keywordtype">size_t</span> i;
<a name="l03419"></a>03419     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = (&amp;rb_objspace);
<a name="l03420"></a>03420 
<a name="l03421"></a>03421     <span class="keywordflow">if</span> (!objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af4e55acafd08b89083723f6d4162c444">run</a>) {
<a name="l03422"></a>03422         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03423"></a>03423     }
<a name="l03424"></a>03424 
<a name="l03425"></a>03425     <span class="keywordflow">for</span> (i =0; i &lt; objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab44b67a8f5128f8aac3c3c340d91d8dd">count</a>; i++) {
<a name="l03426"></a>03426         prof = <a class="code" href="../../d1/d04/hash_8c.html#af1da586524a3a1739fd5b91272037815">rb_hash_new</a>();
<a name="l03427"></a>03427         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(prof, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;GC_TIME&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4affd02e0f0fe17593cd4ecd78cf9064">DBL2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>[i].<a class="code" href="../../d6/dc6/structgc__profile__record.html#afc1b81459304949270edd36a131eb7a8">gc_time</a>));
<a name="l03428"></a>03428         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(prof, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;GC_INVOKE_TIME&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4affd02e0f0fe17593cd4ecd78cf9064">DBL2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>[i].<a class="code" href="../../d6/dc6/structgc__profile__record.html#a3ae440b98bbe58e3dad0230cac016a90">gc_invoke_time</a>));
<a name="l03429"></a>03429         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(prof, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;HEAP_USE_SIZE&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>[i].<a class="code" href="../../d6/dc6/structgc__profile__record.html#aaaefa4991d4ae9d69b46dbbfa8f88133">heap_use_size</a>));
<a name="l03430"></a>03430         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(prof, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;HEAP_TOTAL_SIZE&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>[i].<a class="code" href="../../d6/dc6/structgc__profile__record.html#ae5bc3d7dc6a7b7c52631e5cdaf2e0669">heap_total_size</a>));
<a name="l03431"></a>03431         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(prof, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;HEAP_TOTAL_OBJECTS&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>[i].<a class="code" href="../../d6/dc6/structgc__profile__record.html#ae562b7d7e8cb29fb3eae43c068639bf9">heap_total_objects</a>));
<a name="l03432"></a>03432         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(prof, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;GC_IS_MARKED&quot;</span>)), objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>[i].<a class="code" href="../../d6/dc6/structgc__profile__record.html#acf6cde8485aa059680e91831e10bf4f7">is_marked</a>);
<a name="l03433"></a>03433 <span class="preprocessor">#if GC_PROFILE_MORE_DETAIL</span>
<a name="l03434"></a>03434 <span class="preprocessor"></span>        <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(prof, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;GC_MARK_TIME&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4affd02e0f0fe17593cd4ecd78cf9064">DBL2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>[i].<a class="code" href="../../d6/dc6/structgc__profile__record.html#a83cd092713937e19422e97063c70829a">gc_mark_time</a>));
<a name="l03435"></a>03435         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(prof, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;GC_SWEEP_TIME&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4affd02e0f0fe17593cd4ecd78cf9064">DBL2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>[i].<a class="code" href="../../d6/dc6/structgc__profile__record.html#a92ad4bf645726c16307cbf5252653916">gc_sweep_time</a>));
<a name="l03436"></a>03436         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(prof, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;ALLOCATE_INCREASE&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>[i].<a class="code" href="../../d6/dc6/structgc__profile__record.html#aee8b9e3a45c15c9be61aabe45ef161f9">allocate_increase</a>));
<a name="l03437"></a>03437         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(prof, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;ALLOCATE_LIMIT&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>[i].<a class="code" href="../../d6/dc6/structgc__profile__record.html#ab1f30d8ec1d595e8f93fc8fce684d0f2">allocate_limit</a>));
<a name="l03438"></a>03438         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(prof, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;HEAP_USE_SLOTS&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>[i].<a class="code" href="../../d6/dc6/structgc__profile__record.html#a1e9969385cb8c8e8304d148a969f2f11">heap_use_slots</a>));
<a name="l03439"></a>03439         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(prof, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;HEAP_LIVE_OBJECTS&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>[i].<a class="code" href="../../d6/dc6/structgc__profile__record.html#a2899c8bd7fac2079942cd7cad2f19c41">heap_live_objects</a>));
<a name="l03440"></a>03440         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(prof, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;HEAP_FREE_OBJECTS&quot;</span>)), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af89e74d2dcf3eef15b29fa6015984af3">SIZET2NUM</a>(objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>[i].<a class="code" href="../../d6/dc6/structgc__profile__record.html#a55ade9d92a69df6fd9c9dffacf5d644b">heap_free_objects</a>));
<a name="l03441"></a>03441         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(prof, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;HAVE_FINALIZE&quot;</span>)), objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>[i].<a class="code" href="../../d6/dc6/structgc__profile__record.html#ac64ac9c78efd6644ac99d3c18c63706f">have_finalize</a>);
<a name="l03442"></a>03442 <span class="preprocessor">#endif</span>
<a name="l03443"></a>03443 <span class="preprocessor"></span>        <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(gc_profile, prof);
<a name="l03444"></a>03444     }
<a name="l03445"></a>03445 
<a name="l03446"></a>03446     <span class="keywordflow">return</span> gc_profile;
<a name="l03447"></a>03447 }
<a name="l03448"></a>03448 
<a name="l03449"></a>03449 <span class="comment">/*</span>
<a name="l03450"></a>03450 <span class="comment"> *  call-seq:</span>
<a name="l03451"></a>03451 <span class="comment"> *     GC::Profiler.result -&gt; String</span>
<a name="l03452"></a>03452 <span class="comment"> *</span>
<a name="l03453"></a>03453 <span class="comment"> *  Returns a profile data report such as:</span>
<a name="l03454"></a>03454 <span class="comment"> *</span>
<a name="l03455"></a>03455 <span class="comment"> *    GC 1 invokes.</span>
<a name="l03456"></a>03456 <span class="comment"> *    Index    Invoke Time(sec)       Use Size(byte)     Total Size(byte)         Total Object                    GC time(ms)</span>
<a name="l03457"></a>03457 <span class="comment"> *        1               0.012               159240               212940                10647         0.00000000000001530000</span>
<a name="l03458"></a>03458 <span class="comment"> */</span>
<a name="l03459"></a>03459 
<a name="l03460"></a>03460 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03461"></a><a class="code" href="../../d8/d16/gc_8c.html#a439b696feab8102728d607b0b584f35e">03461</a> <a class="code" href="../../d8/d16/gc_8c.html#a439b696feab8102728d607b0b584f35e">gc_profile_result</a>(<span class="keywordtype">void</span>)
<a name="l03462"></a>03462 {
<a name="l03463"></a>03463     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l03464"></a>03464     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> record;
<a name="l03465"></a>03465     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d8/d90/nkf_8c.html#a5ea5ac7abf5cce39283e422add1067d5">result</a>;
<a name="l03466"></a>03466     <span class="keywordtype">int</span> i, index;
<a name="l03467"></a>03467 
<a name="l03468"></a>03468     record = <a class="code" href="../../d8/d16/gc_8c.html#a8c8be12c00dcde320e317bb9734c9835">gc_profile_record_get</a>();
<a name="l03469"></a>03469     <span class="keywordflow">if</span> (objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af4e55acafd08b89083723f6d4162c444">run</a> &amp;&amp; objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab44b67a8f5128f8aac3c3c340d91d8dd">count</a>) {
<a name="l03470"></a>03470         result = <a class="code" href="../../d9/d2d/sprintf_8c.html#a05c34a91ab36c6a463c861df47808fae">rb_sprintf</a>(<span class="stringliteral">&quot;GC %d invokes.\n&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(<a class="code" href="../../d8/d16/gc_8c.html#a44972f40a83e240e6a68bcf135a80e22">gc_count</a>(0)));
<a name="l03471"></a>03471         index = 1;
<a name="l03472"></a>03472         <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(result, <span class="stringliteral">&quot;Index    Invoke Time(sec)       Use Size(byte)     Total Size(byte)         Total Object                    GC Time(ms)\n&quot;</span>);
<a name="l03473"></a>03473         <span class="keywordflow">for</span> (i = 0; i &lt; (int)<a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(record); i++) {
<a name="l03474"></a>03474             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> r = <a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(record)[i];
<a name="l03475"></a>03475 <span class="preprocessor">#if !GC_PROFILE_MORE_DETAIL</span>
<a name="l03476"></a>03476 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(r, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;GC_IS_MARKED&quot;</span>)))) {
<a name="l03477"></a>03477 <span class="preprocessor">#endif</span>
<a name="l03478"></a>03478 <span class="preprocessor"></span>            <a class="code" href="../../d9/d2d/sprintf_8c.html#a01a3022a41f713613342bbaba9ac9359">rb_str_catf</a>(result, <span class="stringliteral">&quot;%5d %19.3f %20&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2b7b0557dc6cd786df02dafbb51f5292">PRIuSIZE</a><span class="stringliteral">&quot; %20&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2b7b0557dc6cd786df02dafbb51f5292">PRIuSIZE</a><span class="stringliteral">&quot; %20&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2b7b0557dc6cd786df02dafbb51f5292">PRIuSIZE</a><span class="stringliteral">&quot; %30.20f\n&quot;</span>,
<a name="l03479"></a>03479                         index++, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a084521c82d2eb576d63d64bfe6b79642">NUM2DBL</a>(<a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(r, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;GC_INVOKE_TIME&quot;</span>)))),
<a name="l03480"></a>03480                         (<span class="keywordtype">size_t</span>)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa7b5f3993e9c39423dd38f430257d0e7">NUM2SIZET</a>(<a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(r, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;HEAP_USE_SIZE&quot;</span>)))),
<a name="l03481"></a>03481                         (<span class="keywordtype">size_t</span>)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa7b5f3993e9c39423dd38f430257d0e7">NUM2SIZET</a>(<a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(r, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;HEAP_TOTAL_SIZE&quot;</span>)))),
<a name="l03482"></a>03482                         (<span class="keywordtype">size_t</span>)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa7b5f3993e9c39423dd38f430257d0e7">NUM2SIZET</a>(<a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(r, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;HEAP_TOTAL_OBJECTS&quot;</span>)))),
<a name="l03483"></a>03483                         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a084521c82d2eb576d63d64bfe6b79642">NUM2DBL</a>(<a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(r, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;GC_TIME&quot;</span>))))*1000);
<a name="l03484"></a>03484 <span class="preprocessor">#if !GC_PROFILE_MORE_DETAIL</span>
<a name="l03485"></a>03485 <span class="preprocessor"></span>            }
<a name="l03486"></a>03486 <span class="preprocessor">#endif</span>
<a name="l03487"></a>03487 <span class="preprocessor"></span>        }
<a name="l03488"></a>03488 <span class="preprocessor">#if GC_PROFILE_MORE_DETAIL</span>
<a name="l03489"></a>03489 <span class="preprocessor"></span>        <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(result, <span class="stringliteral">&quot;\n\n&quot;</span>);
<a name="l03490"></a>03490         <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(result, <span class="stringliteral">&quot;More detail.\n&quot;</span>);
<a name="l03491"></a>03491         <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(result, <span class="stringliteral">&quot;Index Allocate Increase    Allocate Limit  Use Slot  Have Finalize             Mark Time(ms)            Sweep Time(ms)\n&quot;</span>);
<a name="l03492"></a>03492         index = 1;
<a name="l03493"></a>03493         <span class="keywordflow">for</span> (i = 0; i &lt; (int)<a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(record); i++) {
<a name="l03494"></a>03494             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> r = <a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(record)[i];
<a name="l03495"></a>03495             <a class="code" href="../../d9/d2d/sprintf_8c.html#a01a3022a41f713613342bbaba9ac9359">rb_str_catf</a>(result, <span class="stringliteral">&quot;%5d %17&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2b7b0557dc6cd786df02dafbb51f5292">PRIuSIZE</a><span class="stringliteral">&quot; %17&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2b7b0557dc6cd786df02dafbb51f5292">PRIuSIZE</a><span class="stringliteral">&quot; %9&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2b7b0557dc6cd786df02dafbb51f5292">PRIuSIZE</a><span class="stringliteral">&quot; %14s %25.20f %25.20f\n&quot;</span>,
<a name="l03496"></a>03496                         index++, (<span class="keywordtype">size_t</span>)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa7b5f3993e9c39423dd38f430257d0e7">NUM2SIZET</a>(<a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(r, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;ALLOCATE_INCREASE&quot;</span>)))),
<a name="l03497"></a>03497                         (<span class="keywordtype">size_t</span>)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa7b5f3993e9c39423dd38f430257d0e7">NUM2SIZET</a>(<a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(r, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;ALLOCATE_LIMIT&quot;</span>)))),
<a name="l03498"></a>03498                         (<span class="keywordtype">size_t</span>)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa7b5f3993e9c39423dd38f430257d0e7">NUM2SIZET</a>(<a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(r, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;HEAP_USE_SLOTS&quot;</span>)))),
<a name="l03499"></a>03499                         <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(r, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;HAVE_FINALIZE&quot;</span>)))? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>,
<a name="l03500"></a>03500                         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a084521c82d2eb576d63d64bfe6b79642">NUM2DBL</a>(<a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(r, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;GC_MARK_TIME&quot;</span>))))*1000,
<a name="l03501"></a>03501                         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a084521c82d2eb576d63d64bfe6b79642">NUM2DBL</a>(<a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(r, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;GC_SWEEP_TIME&quot;</span>))))*1000);
<a name="l03502"></a>03502         }
<a name="l03503"></a>03503 <span class="preprocessor">#endif</span>
<a name="l03504"></a>03504 <span class="preprocessor"></span>    }
<a name="l03505"></a>03505     <span class="keywordflow">else</span> {
<a name="l03506"></a>03506         result = <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;&quot;</span>);
<a name="l03507"></a>03507     }
<a name="l03508"></a>03508     <span class="keywordflow">return</span> result;
<a name="l03509"></a>03509 }
<a name="l03510"></a>03510 
<a name="l03511"></a>03511 
<a name="l03512"></a>03512 <span class="comment">/*</span>
<a name="l03513"></a>03513 <span class="comment"> *  call-seq:</span>
<a name="l03514"></a>03514 <span class="comment"> *     GC::Profiler.report</span>
<a name="l03515"></a>03515 <span class="comment"> *     GC::Profiler.report io</span>
<a name="l03516"></a>03516 <span class="comment"> *</span>
<a name="l03517"></a>03517 <span class="comment"> *  Writes the GC::Profiler#result to &lt;tt&gt;$stdout&lt;/tt&gt; or the given IO object.</span>
<a name="l03518"></a>03518 <span class="comment"> *</span>
<a name="l03519"></a>03519 <span class="comment"> */</span>
<a name="l03520"></a>03520 
<a name="l03521"></a>03521 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03522"></a><a class="code" href="../../d8/d16/gc_8c.html#a0d910fe79fd8463f892eb9ca44c46ba9">03522</a> <a class="code" href="../../d8/d16/gc_8c.html#a0d910fe79fd8463f892eb9ca44c46ba9">gc_profile_report</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l03523"></a>03523 {
<a name="l03524"></a>03524     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> out;
<a name="l03525"></a>03525 
<a name="l03526"></a>03526     <span class="keywordflow">if</span> (argc == 0) {
<a name="l03527"></a>03527         out = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>;
<a name="l03528"></a>03528     }
<a name="l03529"></a>03529     <span class="keywordflow">else</span> {
<a name="l03530"></a>03530         <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;01&quot;</span>, &amp;out);
<a name="l03531"></a>03531     }
<a name="l03532"></a>03532     <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(out, <a class="code" href="../../d8/d16/gc_8c.html#a439b696feab8102728d607b0b584f35e">gc_profile_result</a>());
<a name="l03533"></a>03533 
<a name="l03534"></a>03534     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03535"></a>03535 }
<a name="l03536"></a>03536 
<a name="l03537"></a>03537 <span class="comment">/*</span>
<a name="l03538"></a>03538 <span class="comment"> *  call-seq:</span>
<a name="l03539"></a>03539 <span class="comment"> *     GC::Profiler.total_time -&gt; float</span>
<a name="l03540"></a>03540 <span class="comment"> *</span>
<a name="l03541"></a>03541 <span class="comment"> *  The total time used for garbage collection in milliseconds</span>
<a name="l03542"></a>03542 <span class="comment"> */</span>
<a name="l03543"></a>03543 
<a name="l03544"></a>03544 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03545"></a><a class="code" href="../../d8/d16/gc_8c.html#a45b4f76f3f0d29873b7e0f2a4dce390d">03545</a> <a class="code" href="../../d8/d16/gc_8c.html#a45b4f76f3f0d29873b7e0f2a4dce390d">gc_profile_total_time</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l03546"></a>03546 {
<a name="l03547"></a>03547     <span class="keywordtype">double</span> time = 0;
<a name="l03548"></a>03548     <a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace_t</a> *objspace = &amp;rb_objspace;
<a name="l03549"></a>03549     <span class="keywordtype">size_t</span> i;
<a name="l03550"></a>03550 
<a name="l03551"></a>03551     <span class="keywordflow">if</span> (objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af4e55acafd08b89083723f6d4162c444">run</a> &amp;&amp; objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab44b67a8f5128f8aac3c3c340d91d8dd">count</a>) {
<a name="l03552"></a>03552         <span class="keywordflow">for</span> (i = 0; i &lt; objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#ab44b67a8f5128f8aac3c3c340d91d8dd">count</a>; i++) {
<a name="l03553"></a>03553             time += objspace-&gt;<a class="code" href="../../d7/dc0/structrb__objspace.html#a1aaf1b48a1b2c9357b5247af8cebdef5">profile</a>.<a class="code" href="../../d7/dc0/structrb__objspace.html#af27f3c8244568e1ed6fce5dde5213230">record</a>[i].<a class="code" href="../../d6/dc6/structgc__profile__record.html#afc1b81459304949270edd36a131eb7a8">gc_time</a>;
<a name="l03554"></a>03554         }
<a name="l03555"></a>03555     }
<a name="l03556"></a>03556     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4affd02e0f0fe17593cd4ecd78cf9064">DBL2NUM</a>(time);
<a name="l03557"></a>03557 }
<a name="l03558"></a>03558 
<a name="l03559"></a>03559 <span class="comment">/*  Document-class: GC::Profiler</span>
<a name="l03560"></a>03560 <span class="comment"> *</span>
<a name="l03561"></a>03561 <span class="comment"> *  The GC profiler provides access to information on GC runs including time,</span>
<a name="l03562"></a>03562 <span class="comment"> *  length and object space size.</span>
<a name="l03563"></a>03563 <span class="comment"> *</span>
<a name="l03564"></a>03564 <span class="comment"> *  Example:</span>
<a name="l03565"></a>03565 <span class="comment"> *</span>
<a name="l03566"></a>03566 <span class="comment"> *    GC::Profiler.enable</span>
<a name="l03567"></a>03567 <span class="comment"> *</span>
<a name="l03568"></a>03568 <span class="comment"> *    require &apos;rdoc/rdoc&apos;</span>
<a name="l03569"></a>03569 <span class="comment"> *</span>
<a name="l03570"></a>03570 <span class="comment"> *    puts GC::Profiler.result</span>
<a name="l03571"></a>03571 <span class="comment"> *</span>
<a name="l03572"></a>03572 <span class="comment"> *    GC::Profiler.disable</span>
<a name="l03573"></a>03573 <span class="comment"> *</span>
<a name="l03574"></a>03574 <span class="comment"> *  See also GC.count, GC.malloc_allocated_size and GC.malloc_allocations</span>
<a name="l03575"></a>03575 <span class="comment"> */</span>
<a name="l03576"></a>03576 
<a name="l03577"></a>03577 <span class="comment">/*</span>
<a name="l03578"></a>03578 <span class="comment"> *  The &lt;code&gt;GC&lt;/code&gt; module provides an interface to Ruby&apos;s mark and</span>
<a name="l03579"></a>03579 <span class="comment"> *  sweep garbage collection mechanism. Some of the underlying methods</span>
<a name="l03580"></a>03580 <span class="comment"> *  are also available via the ObjectSpace module.</span>
<a name="l03581"></a>03581 <span class="comment"> *</span>
<a name="l03582"></a>03582 <span class="comment"> *  You may obtain information about the operation of the GC through</span>
<a name="l03583"></a>03583 <span class="comment"> *  GC::Profiler.</span>
<a name="l03584"></a>03584 <span class="comment"> */</span>
<a name="l03585"></a>03585 
<a name="l03586"></a>03586 <span class="keywordtype">void</span>
<a name="l03587"></a><a class="code" href="../../d8/d16/gc_8c.html#aaf1d97ba761017df2ab10ea457e2da4e">03587</a> <a class="code" href="../../d8/d16/gc_8c.html#aaf1d97ba761017df2ab10ea457e2da4e">Init_GC</a>(<span class="keywordtype">void</span>)
<a name="l03588"></a>03588 {
<a name="l03589"></a>03589     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> rb_mObSpace;
<a name="l03590"></a>03590     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> rb_mProfiler;
<a name="l03591"></a>03591 
<a name="l03592"></a>03592     rb_mGC = <a class="code" href="../../de/ddf/group__class.html#ga911071d40f9312e49a774ea0e1b12869">rb_define_module</a>(<span class="stringliteral">&quot;GC&quot;</span>);
<a name="l03593"></a>03593     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(rb_mGC, <span class="stringliteral">&quot;start&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a2a2d48737bcaedc111aad7bb6059165d">rb_gc_start</a>, 0);
<a name="l03594"></a>03594     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(rb_mGC, <span class="stringliteral">&quot;enable&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a3cbc64cc9d74c437c08a5dc923d1c7dd">rb_gc_enable</a>, 0);
<a name="l03595"></a>03595     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(rb_mGC, <span class="stringliteral">&quot;disable&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a27a2dbb7307d5ea8e096ce4357f6ece6">rb_gc_disable</a>, 0);
<a name="l03596"></a>03596     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(rb_mGC, <span class="stringliteral">&quot;stress&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#abe778bb43360fd945e9f2dea667f237b">gc_stress_get</a>, 0);
<a name="l03597"></a>03597     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(rb_mGC, <span class="stringliteral">&quot;stress=&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a927a74eab36807709e91a163728fa6b1">gc_stress_set</a>, 1);
<a name="l03598"></a>03598     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(rb_mGC, <span class="stringliteral">&quot;count&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a44972f40a83e240e6a68bcf135a80e22">gc_count</a>, 0);
<a name="l03599"></a>03599     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(rb_mGC, <span class="stringliteral">&quot;stat&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a4552d09da94fd3d799b8897619502ae7">gc_stat</a>, -1);
<a name="l03600"></a>03600     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_mGC, <span class="stringliteral">&quot;garbage_collect&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a2a2d48737bcaedc111aad7bb6059165d">rb_gc_start</a>, 0);
<a name="l03601"></a>03601 
<a name="l03602"></a>03602     rb_mProfiler = <a class="code" href="../../de/ddf/group__class.html#gad0eeed44f413060a2417852168747388">rb_define_module_under</a>(rb_mGC, <span class="stringliteral">&quot;Profiler&quot;</span>);
<a name="l03603"></a>03603     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(rb_mProfiler, <span class="stringliteral">&quot;enabled?&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a666215deb83c1b9b81db945fd4cc4a00">gc_profile_enable_get</a>, 0);
<a name="l03604"></a>03604     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(rb_mProfiler, <span class="stringliteral">&quot;enable&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a38d2d9350a6a56f10d54b6dd184b9529">gc_profile_enable</a>, 0);
<a name="l03605"></a>03605     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(rb_mProfiler, <span class="stringliteral">&quot;disable&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a93630fa8367d4c036ca6be546ef63b17">gc_profile_disable</a>, 0);
<a name="l03606"></a>03606     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(rb_mProfiler, <span class="stringliteral">&quot;clear&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a1224eeec4cd2de1c7104f78a579e63e8">gc_profile_clear</a>, 0);
<a name="l03607"></a>03607     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(rb_mProfiler, <span class="stringliteral">&quot;result&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a439b696feab8102728d607b0b584f35e">gc_profile_result</a>, 0);
<a name="l03608"></a>03608     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(rb_mProfiler, <span class="stringliteral">&quot;report&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a0d910fe79fd8463f892eb9ca44c46ba9">gc_profile_report</a>, -1);
<a name="l03609"></a>03609     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(rb_mProfiler, <span class="stringliteral">&quot;total_time&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a45b4f76f3f0d29873b7e0f2a4dce390d">gc_profile_total_time</a>, 0);
<a name="l03610"></a>03610 
<a name="l03611"></a>03611     rb_mObSpace = <a class="code" href="../../de/ddf/group__class.html#ga911071d40f9312e49a774ea0e1b12869">rb_define_module</a>(<span class="stringliteral">&quot;ObjectSpace&quot;</span>);
<a name="l03612"></a>03612     <a class="code" href="../../d7/d19/group__defmethod.html#gafc7122dde38ecff13de3e9d19a30aaeb" title="Defines a module function for module.">rb_define_module_function</a>(rb_mObSpace, <span class="stringliteral">&quot;each_object&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#aa8478889497ff9e98752b655c6fbf352">os_each_obj</a>, -1);
<a name="l03613"></a>03613     <a class="code" href="../../d7/d19/group__defmethod.html#gafc7122dde38ecff13de3e9d19a30aaeb" title="Defines a module function for module.">rb_define_module_function</a>(rb_mObSpace, <span class="stringliteral">&quot;garbage_collect&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a2a2d48737bcaedc111aad7bb6059165d">rb_gc_start</a>, 0);
<a name="l03614"></a>03614 
<a name="l03615"></a>03615     <a class="code" href="../../d7/d19/group__defmethod.html#gafc7122dde38ecff13de3e9d19a30aaeb" title="Defines a module function for module.">rb_define_module_function</a>(rb_mObSpace, <span class="stringliteral">&quot;define_finalizer&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a5cf74d458d560485d2200996dc4164a8">define_final</a>, -1);
<a name="l03616"></a>03616     <a class="code" href="../../d7/d19/group__defmethod.html#gafc7122dde38ecff13de3e9d19a30aaeb" title="Defines a module function for module.">rb_define_module_function</a>(rb_mObSpace, <span class="stringliteral">&quot;undefine_finalizer&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#ae243ea45416037ff231f619e26c3cf4e">undefine_final</a>, 1);
<a name="l03617"></a>03617 
<a name="l03618"></a>03618     <a class="code" href="../../d7/d19/group__defmethod.html#gafc7122dde38ecff13de3e9d19a30aaeb" title="Defines a module function for module.">rb_define_module_function</a>(rb_mObSpace, <span class="stringliteral">&quot;_id2ref&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#adb9edc66b7276c11c435f7bfda57bc85">id2ref</a>, 1);
<a name="l03619"></a>03619 
<a name="l03620"></a>03620     <a class="code" href="../../d8/d16/gc_8c.html#a5a548be06ee9f1eb5fd707c9d20da90c">nomem_error</a> = <a class="code" href="../../db/dcc/error_8c.html#a4989eeb5742cad6359a2ed77859674de">rb_exc_new3</a>(<a class="code" href="../../db/dcc/error_8c.html#a4f973054529e0ee4d2dfd40d9b6980ab">rb_eNoMemError</a>,
<a name="l03621"></a>03621                               <a class="code" href="../../db/d2e/intern_8h.html#a8ea3742679211f408cb5769de6cf0d46">rb_obj_freeze</a>(<a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;failed to allocate memory&quot;</span>)));
<a name="l03622"></a>03622     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afd75ea0cb81c17e76c73e593d1d8a860">OBJ_TAINT</a>(<a class="code" href="../../d8/d16/gc_8c.html#a5a548be06ee9f1eb5fd707c9d20da90c">nomem_error</a>);
<a name="l03623"></a>03623     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7ae8fa209abf837905d53c1c4be7c75d">OBJ_FREEZE</a>(<a class="code" href="../../d8/d16/gc_8c.html#a5a548be06ee9f1eb5fd707c9d20da90c">nomem_error</a>);
<a name="l03624"></a>03624 
<a name="l03625"></a>03625     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a56629236cdaf6ddac6d05cd5ae21a2b4">rb_cBasicObject</a>, <span class="stringliteral">&quot;__id__&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a56eb26ff20f077eecdca272b83df1652">rb_obj_id</a>, 0);
<a name="l03626"></a>03626     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2f79a80cd4cd92563255889fdcc303b8">rb_mKernel</a>, <span class="stringliteral">&quot;object_id&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a56eb26ff20f077eecdca272b83df1652">rb_obj_id</a>, 0);
<a name="l03627"></a>03627 
<a name="l03628"></a>03628     <a class="code" href="../../d7/d19/group__defmethod.html#gafc7122dde38ecff13de3e9d19a30aaeb" title="Defines a module function for module.">rb_define_module_function</a>(rb_mObSpace, <span class="stringliteral">&quot;count_objects&quot;</span>, <a class="code" href="../../d8/d16/gc_8c.html#a0564118b9022b4dd8eabf49431d32a93">count_objects</a>, -1);
<a name="l03629"></a>03629 
<a name="l03630"></a>03630 <span class="preprocessor">#if CALC_EXACT_MALLOC_SIZE</span>
<a name="l03631"></a>03631 <span class="preprocessor"></span>    <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(rb_mGC, <span class="stringliteral">&quot;malloc_allocated_size&quot;</span>, gc_malloc_allocated_size, 0);
<a name="l03632"></a>03632     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(rb_mGC, <span class="stringliteral">&quot;malloc_allocations&quot;</span>, gc_malloc_allocations, 0);
<a name="l03633"></a>03633 <span class="preprocessor">#endif</span>
<a name="l03634"></a>03634 <span class="preprocessor"></span>}
<a name="l03635"></a>03635 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Mar 2013 for Ruby by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
