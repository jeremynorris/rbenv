<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Ruby: win32/win32.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>win32/win32.c</h1><a href="../../d5/df2/win32_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> *  Copyright (c) 1993, Intergraph Corporation</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> *  You may distribute under the terms of either the GNU General Public</span>
<a name="l00005"></a>00005 <span class="comment"> *  License or the Artistic License, as specified in the perl README file.</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> *  Various Unix compatibility functions and NT specific functions.</span>
<a name="l00008"></a>00008 <span class="comment"> *</span>
<a name="l00009"></a>00009 <span class="comment"> *  Some of this code was derived from the MSDOS port(s) and the OS/2 port.</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> */</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="../../de/de6/ruby_2ruby_8h.html">ruby/ruby.h</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/de3/encoding_8h.html">ruby/encoding.h</a>&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="../../df/da8/dln_8h.html">dln.h</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;process.h&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00019"></a>00019 <span class="comment">/* #include &lt;sys/wait.h&gt; */</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;windows.h&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;winbase.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;wincon.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;share.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;shlobj.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;mbstring.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#if _MSC_VER &gt;= 1400</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span><span class="preprocessor">#include &lt;crtdbg.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;rtcapi.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#endif</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="preprocessor">#ifdef __MINGW32__</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#include &lt;mswsock.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#endif</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="../../dc/db1/win32_8h.html">ruby/win32.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d9c/dir_8h.html">win32/dir.h</a>&quot;</span>
<a name="l00041"></a><a class="code" href="../../d5/df2/win32_8c.html#ad1a5011ecfd52fc9c7a11d1f0fa43936">00041</a> <span class="preprocessor">#define isdirsep(x) ((x) == &apos;/&apos; || (x) == &apos;\\&apos;)</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span>
<a name="l00043"></a>00043 <span class="preprocessor">#undef stat</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor">#undef fclose</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span><span class="preprocessor">#undef close</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span><span class="preprocessor">#undef setsockopt</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span>
<a name="l00048"></a>00048 <span class="preprocessor">#if defined __BORLANDC__</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span><span class="preprocessor">#  define _filbuf _fgetc</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span><span class="preprocessor">#  define _flsbuf _fputc</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span><span class="preprocessor">#  define enough_to_get(n) (--(n) &gt;= 0)</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span><span class="preprocessor">#  define enough_to_put(n) (++(n) &lt; 0)</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00054"></a><a class="code" href="../../d5/df2/win32_8c.html#ae721143a229a1f7815aaecddce571d5f">00054</a> <span class="preprocessor"></span><span class="preprocessor">#  define enough_to_get(n) (--(n) &gt;= 0)</span>
<a name="l00055"></a><a class="code" href="../../d5/df2/win32_8c.html#ae8541ee81feb0e88b3db0d3f62603d96">00055</a> <span class="preprocessor"></span><span class="preprocessor">#  define enough_to_put(n) (--(n) &gt;= 0)</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span>
<a name="l00058"></a>00058 <span class="preprocessor">#ifdef WIN32_DEBUG</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span><span class="preprocessor">#define Debug(something) something</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00061"></a><a class="code" href="../../d5/df2/win32_8c.html#a816d96355638b764185f20ce851407b0">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define Debug(something) </span><span class="comment">/* nothing */</span>
<a name="l00062"></a>00062 <span class="preprocessor">#endif</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>
<a name="l00064"></a><a class="code" href="../../d5/df2/win32_8c.html#a88af3e4725523dc74ce5b925e6f2b1a3">00064</a> <span class="preprocessor">#define TO_SOCKET(x)    _get_osfhandle(x)</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>
<a name="l00066"></a>00066 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../df/dca/struct_child_record.html">ChildRecord</a> *<a class="code" href="../../d5/df2/win32_8c.html#aff4f0f208c5db35376e6c5d76a151801">CreateChild</a>(<span class="keyword">const</span> WCHAR *, <span class="keyword">const</span> WCHAR *, SECURITY_ATTRIBUTES *, HANDLE, HANDLE, HANDLE, <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>);
<a name="l00067"></a>00067 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/df2/win32_8c.html#a6dde4e745374faf9c51029d31f97b9b0">has_redirection</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l00068"></a>00068 <span class="keywordtype">int</span> <a class="code" href="../../dd/d55/thread__win32_8c.html#afbceca1751aaf315d88fd569003dcf5c">rb_w32_wait_events</a>(HANDLE *events, <span class="keywordtype">int</span> num, <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> timeout);
<a name="l00069"></a>00069 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/df2/win32_8c.html#a4611af37727832d276705e41ed08ecb8">rb_w32_open_osfhandle</a>(<a class="code" href="../../dc/db1/win32_8h.html#a0fbe4a4f8dd857ee04923a901f27465f">intptr_t</a> osfhandle, <span class="keywordtype">int</span> flags);
<a name="l00070"></a>00070 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/df2/win32_8c.html#aa6e8114a63a22d89103ef7434a6ae53e">wstati64</a>(<span class="keyword">const</span> WCHAR *path, <span class="keyword">struct</span> stati64 *st);
<a name="l00071"></a>00071 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d5/df2/win32_8c.html#a6819474e0e7018ff2086dd8ac6ba6fed">rb_w32_conv_from_wchar</a>(<span class="keyword">const</span> WCHAR *wstr, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc);
<a name="l00072"></a>00072 
<a name="l00073"></a><a class="code" href="../../d5/df2/win32_8c.html#afa9ee66894f5018b7823a1eb3ec71388">00073</a> <span class="preprocessor">#define RUBY_CRITICAL(expr) do { expr; } while (0)</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>
<a name="l00075"></a>00075 <span class="comment">/* errno mapping */</span>
<a name="l00076"></a>00076 <span class="keyword">static</span> <span class="keyword">struct </span>{
<a name="l00077"></a><a class="code" href="../../d5/df2/win32_8c.html#ae2d1336e4cb955b0b6e438fa8c7a7113">00077</a>     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../d5/df2/win32_8c.html#ae2d1336e4cb955b0b6e438fa8c7a7113">winerr</a>;
<a name="l00078"></a><a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">00078</a>     <span class="keywordtype">int</span> <a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a>;
<a name="l00079"></a>00079 } <a class="code" href="../../d5/df2/win32_8c.html#a8eeb395117b28ddd44211f8d4b7e713e">errmap</a>[] = {
<a name="l00080"></a>00080     {   ERROR_INVALID_FUNCTION,         EINVAL          },
<a name="l00081"></a>00081     {   ERROR_FILE_NOT_FOUND,           ENOENT          },
<a name="l00082"></a>00082     {   ERROR_PATH_NOT_FOUND,           ENOENT          },
<a name="l00083"></a>00083     {   ERROR_TOO_MANY_OPEN_FILES,      EMFILE          },
<a name="l00084"></a>00084     {   ERROR_ACCESS_DENIED,            EACCES          },
<a name="l00085"></a>00085     {   ERROR_INVALID_HANDLE,           EBADF           },
<a name="l00086"></a>00086     {   ERROR_ARENA_TRASHED,            ENOMEM          },
<a name="l00087"></a>00087     {   ERROR_NOT_ENOUGH_MEMORY,        ENOMEM          },
<a name="l00088"></a>00088     {   ERROR_INVALID_BLOCK,            ENOMEM          },
<a name="l00089"></a>00089     {   ERROR_BAD_ENVIRONMENT,          E2BIG           },
<a name="l00090"></a>00090     {   ERROR_BAD_FORMAT,               ENOEXEC         },
<a name="l00091"></a>00091     {   ERROR_INVALID_ACCESS,           EINVAL          },
<a name="l00092"></a>00092     {   ERROR_INVALID_DATA,             EINVAL          },
<a name="l00093"></a>00093     {   ERROR_INVALID_DRIVE,            ENOENT          },
<a name="l00094"></a>00094     {   ERROR_CURRENT_DIRECTORY,        EACCES          },
<a name="l00095"></a>00095     {   ERROR_NOT_SAME_DEVICE,          EXDEV           },
<a name="l00096"></a>00096     {   ERROR_NO_MORE_FILES,            ENOENT          },
<a name="l00097"></a>00097     {   ERROR_WRITE_PROTECT,            EROFS           },
<a name="l00098"></a>00098     {   ERROR_BAD_UNIT,                 ENODEV          },
<a name="l00099"></a>00099     {   ERROR_NOT_READY,                ENXIO           },
<a name="l00100"></a>00100     {   ERROR_BAD_COMMAND,              EACCES          },
<a name="l00101"></a>00101     {   ERROR_CRC,                      EACCES          },
<a name="l00102"></a>00102     {   ERROR_BAD_LENGTH,               EACCES          },
<a name="l00103"></a>00103     {   ERROR_SEEK,                     EIO             },
<a name="l00104"></a>00104     {   ERROR_NOT_DOS_DISK,             EACCES          },
<a name="l00105"></a>00105     {   ERROR_SECTOR_NOT_FOUND,         EACCES          },
<a name="l00106"></a>00106     {   ERROR_OUT_OF_PAPER,             EACCES          },
<a name="l00107"></a>00107     {   ERROR_WRITE_FAULT,              EIO             },
<a name="l00108"></a>00108     {   ERROR_READ_FAULT,               EIO             },
<a name="l00109"></a>00109     {   ERROR_GEN_FAILURE,              EACCES          },
<a name="l00110"></a>00110     {   ERROR_LOCK_VIOLATION,           EACCES          },
<a name="l00111"></a>00111     {   ERROR_SHARING_VIOLATION,        EACCES          },
<a name="l00112"></a>00112     {   ERROR_WRONG_DISK,               EACCES          },
<a name="l00113"></a>00113     {   ERROR_SHARING_BUFFER_EXCEEDED,  EACCES          },
<a name="l00114"></a>00114     {   ERROR_BAD_NETPATH,              ENOENT          },
<a name="l00115"></a>00115     {   ERROR_NETWORK_ACCESS_DENIED,    EACCES          },
<a name="l00116"></a>00116     {   ERROR_BAD_NET_NAME,             ENOENT          },
<a name="l00117"></a>00117     {   ERROR_FILE_EXISTS,              EEXIST          },
<a name="l00118"></a>00118     {   ERROR_CANNOT_MAKE,              EACCES          },
<a name="l00119"></a>00119     {   ERROR_FAIL_I24,                 EACCES          },
<a name="l00120"></a>00120     {   ERROR_INVALID_PARAMETER,        EINVAL          },
<a name="l00121"></a>00121     {   ERROR_NO_PROC_SLOTS,            EAGAIN          },
<a name="l00122"></a>00122     {   ERROR_DRIVE_LOCKED,             EACCES          },
<a name="l00123"></a>00123     {   ERROR_BROKEN_PIPE,              EPIPE           },
<a name="l00124"></a>00124     {   ERROR_DISK_FULL,                ENOSPC          },
<a name="l00125"></a>00125     {   ERROR_INVALID_TARGET_HANDLE,    EBADF           },
<a name="l00126"></a>00126     {   ERROR_INVALID_HANDLE,           EINVAL          },
<a name="l00127"></a>00127     {   ERROR_WAIT_NO_CHILDREN,         ECHILD          },
<a name="l00128"></a>00128     {   ERROR_CHILD_NOT_COMPLETE,       ECHILD          },
<a name="l00129"></a>00129     {   ERROR_DIRECT_ACCESS_HANDLE,     EBADF           },
<a name="l00130"></a>00130     {   ERROR_NEGATIVE_SEEK,            EINVAL          },
<a name="l00131"></a>00131     {   ERROR_SEEK_ON_DEVICE,           EACCES          },
<a name="l00132"></a>00132     {   ERROR_DIR_NOT_EMPTY,            ENOTEMPTY       },
<a name="l00133"></a>00133     {   ERROR_DIRECTORY,                ENOTDIR         },
<a name="l00134"></a>00134     {   ERROR_NOT_LOCKED,               EACCES          },
<a name="l00135"></a>00135     {   ERROR_BAD_PATHNAME,             ENOENT          },
<a name="l00136"></a>00136     {   ERROR_MAX_THRDS_REACHED,        EAGAIN          },
<a name="l00137"></a>00137     {   ERROR_LOCK_FAILED,              EACCES          },
<a name="l00138"></a>00138     {   ERROR_ALREADY_EXISTS,           EEXIST          },
<a name="l00139"></a>00139     {   ERROR_INVALID_STARTING_CODESEG, ENOEXEC         },
<a name="l00140"></a>00140     {   ERROR_INVALID_STACKSEG,         ENOEXEC         },
<a name="l00141"></a>00141     {   ERROR_INVALID_MODULETYPE,       ENOEXEC         },
<a name="l00142"></a>00142     {   ERROR_INVALID_EXE_SIGNATURE,    ENOEXEC         },
<a name="l00143"></a>00143     {   ERROR_EXE_MARKED_INVALID,       ENOEXEC         },
<a name="l00144"></a>00144     {   ERROR_BAD_EXE_FORMAT,           ENOEXEC         },
<a name="l00145"></a>00145     {   ERROR_ITERATED_DATA_EXCEEDS_64k,ENOEXEC         },
<a name="l00146"></a>00146     {   ERROR_INVALID_MINALLOCSIZE,     ENOEXEC         },
<a name="l00147"></a>00147     {   ERROR_DYNLINK_FROM_INVALID_RING,ENOEXEC         },
<a name="l00148"></a>00148     {   ERROR_IOPL_NOT_ENABLED,         ENOEXEC         },
<a name="l00149"></a>00149     {   ERROR_INVALID_SEGDPL,           ENOEXEC         },
<a name="l00150"></a>00150     {   ERROR_AUTODATASEG_EXCEEDS_64k,  ENOEXEC         },
<a name="l00151"></a>00151     {   ERROR_RING2SEG_MUST_BE_MOVABLE, ENOEXEC         },
<a name="l00152"></a>00152     {   ERROR_RELOC_CHAIN_XEEDS_SEGLIM, ENOEXEC         },
<a name="l00153"></a>00153     {   ERROR_INFLOOP_IN_RELOC_CHAIN,   ENOEXEC         },
<a name="l00154"></a>00154     {   ERROR_FILENAME_EXCED_RANGE,     ENOENT          },
<a name="l00155"></a>00155     {   ERROR_NESTING_NOT_ALLOWED,      EAGAIN          },
<a name="l00156"></a>00156 <span class="preprocessor">#ifndef ERROR_PIPE_LOCAL</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span><span class="preprocessor">#define ERROR_PIPE_LOCAL        229L</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00159"></a>00159 <span class="preprocessor"></span>    {   <a class="code" href="../../d5/df2/win32_8c.html#ac1eff060fead89063f1f3b21a84f0935">ERROR_PIPE_LOCAL</a>,               EPIPE           },
<a name="l00160"></a>00160     {   ERROR_BAD_PIPE,                 EPIPE           },
<a name="l00161"></a>00161     {   ERROR_PIPE_BUSY,                EAGAIN          },
<a name="l00162"></a>00162     {   ERROR_NO_DATA,                  EPIPE           },
<a name="l00163"></a>00163     {   ERROR_PIPE_NOT_CONNECTED,       EPIPE           },
<a name="l00164"></a>00164     {   ERROR_OPERATION_ABORTED,        EINTR           },
<a name="l00165"></a>00165     {   ERROR_NOT_ENOUGH_QUOTA,         ENOMEM          },
<a name="l00166"></a>00166     {   ERROR_MOD_NOT_FOUND,            ENOENT          },
<a name="l00167"></a>00167     {   WSAEINTR,                       EINTR           },
<a name="l00168"></a>00168     {   WSAEBADF,                       EBADF           },
<a name="l00169"></a>00169     {   WSAEACCES,                      EACCES          },
<a name="l00170"></a>00170     {   WSAEFAULT,                      EFAULT          },
<a name="l00171"></a>00171     {   WSAEINVAL,                      EINVAL          },
<a name="l00172"></a>00172     {   WSAEMFILE,                      EMFILE          },
<a name="l00173"></a>00173     {   WSAEWOULDBLOCK,                 <a class="code" href="../../dd/d8c/rubysocket_8h.html#a4a3a0b3605fd3b2336455062ee8e25f0">EWOULDBLOCK</a>     },
<a name="l00174"></a>00174     {   WSAEINPROGRESS,                 <a class="code" href="../../dc/db1/win32_8h.html#a6c045d5be06e715cc335784a7320714e">EINPROGRESS</a>     },
<a name="l00175"></a>00175     {   WSAEALREADY,                    <a class="code" href="../../dc/db1/win32_8h.html#aa4ccb54aa806de3e41a8515f06db85d4">EALREADY</a>        },
<a name="l00176"></a>00176     {   WSAENOTSOCK,                    <a class="code" href="../../dc/db1/win32_8h.html#ae34fa7a550ac1c415daa2e114a1c0f38">ENOTSOCK</a>        },
<a name="l00177"></a>00177     {   WSAEDESTADDRREQ,                <a class="code" href="../../dc/db1/win32_8h.html#a0e416d3478cf030e37e90c55d68ad97a">EDESTADDRREQ</a>    },
<a name="l00178"></a>00178     {   WSAEMSGSIZE,                    <a class="code" href="../../dc/db1/win32_8h.html#ae37becfaa095a9df5c5c788bce5aa06f">EMSGSIZE</a>        },
<a name="l00179"></a>00179     {   WSAEPROTOTYPE,                  <a class="code" href="../../dc/db1/win32_8h.html#ae6014faa948366b8321d755204acf755">EPROTOTYPE</a>      },
<a name="l00180"></a>00180     {   WSAENOPROTOOPT,                 <a class="code" href="../../dc/db1/win32_8h.html#acd570f8ab92198653b4459773dc3bca3">ENOPROTOOPT</a>     },
<a name="l00181"></a>00181     {   WSAEPROTONOSUPPORT,             <a class="code" href="../../dc/db1/win32_8h.html#ad581c46fdd4dee9419f60eaff40415e7">EPROTONOSUPPORT</a> },
<a name="l00182"></a>00182     {   WSAESOCKTNOSUPPORT,             <a class="code" href="../../dc/db1/win32_8h.html#a891103a0628442461b41d4d85fb6d945">ESOCKTNOSUPPORT</a> },
<a name="l00183"></a>00183     {   WSAEOPNOTSUPP,                  <a class="code" href="../../dc/db1/win32_8h.html#a4b807895c74cea4d0302bf27725d4b9d">EOPNOTSUPP</a>      },
<a name="l00184"></a>00184     {   WSAEPFNOSUPPORT,                <a class="code" href="../../dc/db1/win32_8h.html#a871b9fabb281dbc2d3b81cb79c163c20">EPFNOSUPPORT</a>    },
<a name="l00185"></a>00185     {   WSAEAFNOSUPPORT,                <a class="code" href="../../dc/db1/win32_8h.html#a4c3a793b4d51cb7dd020af92e536fe21">EAFNOSUPPORT</a>    },
<a name="l00186"></a>00186     {   WSAEADDRINUSE,                  <a class="code" href="../../dc/db1/win32_8h.html#a61676e39b42371c65c3b960a91887b03">EADDRINUSE</a>      },
<a name="l00187"></a>00187     {   WSAEADDRNOTAVAIL,               <a class="code" href="../../dc/db1/win32_8h.html#a556612e55358838192165684c971a44f">EADDRNOTAVAIL</a>   },
<a name="l00188"></a>00188     {   WSAENETDOWN,                    <a class="code" href="../../dc/db1/win32_8h.html#aac51995026fa19cdd0ad84a272304af0">ENETDOWN</a>        },
<a name="l00189"></a>00189     {   WSAENETUNREACH,                 <a class="code" href="../../dc/db1/win32_8h.html#a3f91f1ad503432783c7a5d1481b45419">ENETUNREACH</a>     },
<a name="l00190"></a>00190     {   WSAENETRESET,                   <a class="code" href="../../dc/db1/win32_8h.html#a92750db73ff8e83591c977bbb3a5bea1">ENETRESET</a>       },
<a name="l00191"></a>00191     {   WSAECONNABORTED,                <a class="code" href="../../dc/db1/win32_8h.html#a45342991e001e28bbf87916d92b7e09a">ECONNABORTED</a>    },
<a name="l00192"></a>00192     {   WSAECONNRESET,                  <a class="code" href="../../dc/db1/win32_8h.html#add4258b08af02fbe4590fbaae7260037">ECONNRESET</a>      },
<a name="l00193"></a>00193     {   WSAENOBUFS,                     <a class="code" href="../../dc/db1/win32_8h.html#a9e655f47bfd914a1174f281fc31cf63d">ENOBUFS</a>         },
<a name="l00194"></a>00194     {   WSAEISCONN,                     <a class="code" href="../../dc/db1/win32_8h.html#a164ca8549da7a385e2fe1cba823b9eaf">EISCONN</a>         },
<a name="l00195"></a>00195     {   WSAENOTCONN,                    <a class="code" href="../../dc/db1/win32_8h.html#af23e48762a0676f49d480db91cfd5e4b">ENOTCONN</a>        },
<a name="l00196"></a>00196     {   WSAESHUTDOWN,                   <a class="code" href="../../dc/db1/win32_8h.html#a2a55c5dd8b54ff5aace6c274c6726d68">ESHUTDOWN</a>       },
<a name="l00197"></a>00197     {   WSAETOOMANYREFS,                <a class="code" href="../../dc/db1/win32_8h.html#a10426080250efba47f4aaf254036ff00">ETOOMANYREFS</a>    },
<a name="l00198"></a>00198     {   WSAETIMEDOUT,                   <a class="code" href="../../dc/db1/win32_8h.html#a597718e59a8fc9c4d4ab63f5a34e28b1">ETIMEDOUT</a>       },
<a name="l00199"></a>00199     {   WSAECONNREFUSED,                <a class="code" href="../../dc/db1/win32_8h.html#aad88020b394ef1aa4af2f4ef9b4c8b39">ECONNREFUSED</a>    },
<a name="l00200"></a>00200     {   WSAELOOP,                       <a class="code" href="../../dc/db1/win32_8h.html#a2f78c246352d2bf2f19dc5d43da2f0c9">ELOOP</a>           },
<a name="l00201"></a>00201     {   WSAENAMETOOLONG,                ENAMETOOLONG    },
<a name="l00202"></a>00202     {   WSAEHOSTDOWN,                   <a class="code" href="../../dc/db1/win32_8h.html#aa92bcaf70544db6998f4c503026359c5">EHOSTDOWN</a>       },
<a name="l00203"></a>00203     {   WSAEHOSTUNREACH,                <a class="code" href="../../dc/db1/win32_8h.html#a53e186028fc992c3341ccb0d4d239b24">EHOSTUNREACH</a>    },
<a name="l00204"></a>00204     {   WSAEPROCLIM,                    <a class="code" href="../../dc/db1/win32_8h.html#a801513ca187af849409e07fda8554a83">EPROCLIM</a>        },
<a name="l00205"></a>00205     {   WSAENOTEMPTY,                   ENOTEMPTY       },
<a name="l00206"></a>00206     {   WSAEUSERS,                      <a class="code" href="../../dc/db1/win32_8h.html#a9b153104ed38c8579f009f81bc7b2dc9">EUSERS</a>          },
<a name="l00207"></a>00207     {   WSAEDQUOT,                      <a class="code" href="../../dc/db1/win32_8h.html#aa5a48566b00cf9062d9deeeb0682cdaf">EDQUOT</a>          },
<a name="l00208"></a>00208     {   WSAESTALE,                      <a class="code" href="../../dc/db1/win32_8h.html#a09e189d2214d9fe2847d27bf270ca1d7">ESTALE</a>          },
<a name="l00209"></a>00209     {   WSAEREMOTE,                     <a class="code" href="../../dc/db1/win32_8h.html#a5e1edba49c18fc631dbf54ff53702d4a">EREMOTE</a>         },
<a name="l00210"></a>00210 };
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 <span class="keywordtype">int</span>
<a name="l00213"></a><a class="code" href="../../d5/df2/win32_8c.html#ad283b24d550f25ff3d5ff543b869f529">00213</a> <a class="code" href="../../dc/db1/win32_8h.html#a15f61b7f1beb4f88cca583894dcfefb9">rb_w32_map_errno</a>(<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../d5/df2/win32_8c.html#ae2d1336e4cb955b0b6e438fa8c7a7113">winerr</a>)
<a name="l00214"></a>00214 {
<a name="l00215"></a>00215     <span class="keywordtype">int</span> i;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217     <span class="keywordflow">if</span> (winerr == 0) {
<a name="l00218"></a>00218         <span class="keywordflow">return</span> 0;
<a name="l00219"></a>00219     }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     <span class="keywordflow">for</span> (i = 0; i &lt; (int)(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/df2/win32_8c.html#a8eeb395117b28ddd44211f8d4b7e713e">errmap</a>) / <span class="keyword">sizeof</span>(*<a class="code" href="../../d5/df2/win32_8c.html#a8eeb395117b28ddd44211f8d4b7e713e">errmap</a>)); i++) {
<a name="l00222"></a>00222         <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a8eeb395117b28ddd44211f8d4b7e713e">errmap</a>[i].winerr == winerr) {
<a name="l00223"></a>00223             <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#a8eeb395117b28ddd44211f8d4b7e713e">errmap</a>[i].err;
<a name="l00224"></a>00224         }
<a name="l00225"></a>00225     }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     <span class="keywordflow">if</span> (winerr &gt;= WSABASEERR) {
<a name="l00228"></a>00228         <span class="keywordflow">return</span> winerr;
<a name="l00229"></a>00229     }
<a name="l00230"></a>00230     <span class="keywordflow">return</span> EINVAL;
<a name="l00231"></a>00231 }
<a name="l00232"></a>00232 
<a name="l00233"></a><a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">00233</a> <span class="preprocessor">#define map_errno rb_w32_map_errno</span>
<a name="l00234"></a>00234 <span class="preprocessor"></span>
<a name="l00235"></a><a class="code" href="../../d5/df2/win32_8c.html#adf9f962e6a4b8cba2b38594991132989">00235</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d5/df2/win32_8c.html#adf9f962e6a4b8cba2b38594991132989">NTLoginName</a>;
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="../../d5/df2/win32_8c.html#a70c14a1643ade732f8c0142e05130cb2">00237</a> <span class="keyword">static</span> OSVERSIONINFO <a class="code" href="../../d5/df2/win32_8c.html#a70c14a1643ade732f8c0142e05130cb2">osver</a>;
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00240"></a><a class="code" href="../../d5/df2/win32_8c.html#a9cdc46735a9ae517cf7aa3c5379b0c0c">00240</a> <a class="code" href="../../d5/df2/win32_8c.html#a9cdc46735a9ae517cf7aa3c5379b0c0c">get_version</a>(<span class="keywordtype">void</span>)
<a name="l00241"></a>00241 {
<a name="l00242"></a>00242     memset(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a70c14a1643ade732f8c0142e05130cb2">osver</a>, 0, <span class="keyword">sizeof</span>(OSVERSIONINFO));
<a name="l00243"></a>00243     <a class="code" href="../../d5/df2/win32_8c.html#a70c14a1643ade732f8c0142e05130cb2">osver</a>.dwOSVersionInfoSize = <span class="keyword">sizeof</span>(OSVERSIONINFO);
<a name="l00244"></a>00244     GetVersionEx(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a70c14a1643ade732f8c0142e05130cb2">osver</a>);
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 <span class="preprocessor">#ifdef _M_IX86</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span><a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>
<a name="l00249"></a>00249 rb_w32_osid(<span class="keywordtype">void</span>)
<a name="l00250"></a>00250 {
<a name="l00251"></a>00251     <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#a70c14a1643ade732f8c0142e05130cb2">osver</a>.dwPlatformId;
<a name="l00252"></a>00252 }
<a name="l00253"></a>00253 <span class="preprocessor">#endif</span>
<a name="l00254"></a>00254 <span class="preprocessor"></span>
<a name="l00255"></a>00255 <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>
<a name="l00256"></a><a class="code" href="../../d5/df2/win32_8c.html#affdb842014b69315ef8e742ad2ebe79e">00256</a> <a class="code" href="../../dc/db1/win32_8h.html#affdb842014b69315ef8e742ad2ebe79e">rb_w32_osver</a>(<span class="keywordtype">void</span>)
<a name="l00257"></a>00257 {
<a name="l00258"></a>00258     <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#a70c14a1643ade732f8c0142e05130cb2">osver</a>.dwMajorVersion;
<a name="l00259"></a>00259 }
<a name="l00260"></a>00260 
<a name="l00261"></a><a class="code" href="../../d5/df2/win32_8c.html#aaa9c3231dcc73fc8381f671b588fb13a">00261</a> <span class="preprocessor">#define IsWinNT() rb_w32_iswinnt()</span>
<a name="l00262"></a><a class="code" href="../../d5/df2/win32_8c.html#a612e2ad1adbb621210494d51d634d40d">00262</a> <span class="preprocessor"></span><span class="preprocessor">#define IsWin95() rb_w32_iswin95()</span>
<a name="l00263"></a>00263 <span class="preprocessor"></span><span class="preprocessor">#ifdef WIN95</span>
<a name="l00264"></a>00264 <span class="preprocessor"></span><span class="preprocessor">#define IfWin95(win95, winnt) (IsWin95() ? (win95) : (winnt))</span>
<a name="l00265"></a>00265 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00266"></a><a class="code" href="../../d5/df2/win32_8c.html#a7f3fd3449912cfee8acada6b9307b385">00266</a> <span class="preprocessor"></span><span class="preprocessor">#define IfWin95(win95, winnt) (winnt)</span>
<a name="l00267"></a>00267 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span>
<a name="l00269"></a>00269 HANDLE
<a name="l00270"></a><a class="code" href="../../d5/df2/win32_8c.html#aa3ec0e1dc99cf3ffba4d64fcd3b8e27b">00270</a> <a class="code" href="../../dc/db1/win32_8h.html#aa3ec0e1dc99cf3ffba4d64fcd3b8e27b">GetCurrentThreadHandle</a>(<span class="keywordtype">void</span>)
<a name="l00271"></a>00271 {
<a name="l00272"></a>00272     <span class="keyword">static</span> HANDLE current_process_handle = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00273"></a>00273     HANDLE h;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275     <span class="keywordflow">if</span> (!current_process_handle)
<a name="l00276"></a>00276         current_process_handle = GetCurrentProcess();
<a name="l00277"></a>00277     <span class="keywordflow">if</span> (!DuplicateHandle(current_process_handle, GetCurrentThread(),
<a name="l00278"></a>00278                          current_process_handle, &amp;h,
<a name="l00279"></a>00279                          0, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, DUPLICATE_SAME_ACCESS))
<a name="l00280"></a>00280         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00281"></a>00281     <span class="keywordflow">return</span> h;
<a name="l00282"></a>00282 }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284 <span class="comment">/* simulate flock by locking a range on the file */</span>
<a name="l00285"></a>00285 
<a name="l00286"></a>00286 
<a name="l00287"></a><a class="code" href="../../d5/df2/win32_8c.html#a4975083a786e255dd9bea5ac03429efc">00287</a> <span class="preprocessor">#define LK_ERR(f,i) \</span>
<a name="l00288"></a>00288 <span class="preprocessor">    do {                                                                \</span>
<a name="l00289"></a>00289 <span class="preprocessor">        if (f)                                                          \</span>
<a name="l00290"></a>00290 <span class="preprocessor">            i = 0;                                                      \</span>
<a name="l00291"></a>00291 <span class="preprocessor">        else {                                                          \</span>
<a name="l00292"></a>00292 <span class="preprocessor">            DWORD err = GetLastError();                                 \</span>
<a name="l00293"></a>00293 <span class="preprocessor">            if (err == ERROR_LOCK_VIOLATION || err == ERROR_IO_PENDING) \</span>
<a name="l00294"></a>00294 <span class="preprocessor">                errno = EWOULDBLOCK;                                    \</span>
<a name="l00295"></a>00295 <span class="preprocessor">            else if (err == ERROR_NOT_LOCKED)                           \</span>
<a name="l00296"></a>00296 <span class="preprocessor">                i = 0;                                                  \</span>
<a name="l00297"></a>00297 <span class="preprocessor">            else                                                        \</span>
<a name="l00298"></a>00298 <span class="preprocessor">                errno = map_errno(err);                                 \</span>
<a name="l00299"></a>00299 <span class="preprocessor">        }                                                               \</span>
<a name="l00300"></a>00300 <span class="preprocessor">    } while (0)</span>
<a name="l00301"></a><a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">00301</a> <span class="preprocessor"></span><span class="preprocessor">#define LK_LEN      ULONG_MAX</span>
<a name="l00302"></a>00302 <span class="preprocessor"></span>
<a name="l00303"></a>00303 <span class="keyword">static</span> <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a>
<a name="l00304"></a><a class="code" href="../../d5/df2/win32_8c.html#a10920f4237da8811157a63e5de45c92a">00304</a> <a class="code" href="../../d5/df2/win32_8c.html#a10920f4237da8811157a63e5de45c92a">flock_winnt</a>(<a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a> <span class="keyword">self</span>, <span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a>* <a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>)
<a name="l00305"></a>00305 {
<a name="l00306"></a>00306     OVERLAPPED o;
<a name="l00307"></a>00307     <span class="keywordtype">int</span> i = -1;
<a name="l00308"></a>00308     <span class="keyword">const</span> HANDLE fh = (HANDLE)<span class="keyword">self</span>;
<a name="l00309"></a>00309     <span class="keyword">const</span> <span class="keywordtype">int</span> oper = argc;
<a name="l00310"></a>00310 
<a name="l00311"></a>00311     memset(&amp;o, 0, <span class="keyword">sizeof</span>(o));
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     <span class="keywordflow">switch</span>(oper) {
<a name="l00314"></a>00314       <span class="keywordflow">case</span> <a class="code" href="../../d6/d13/file_8c.html#ab0abca95a2265e7cea4b2e026278a968">LOCK_SH</a>:             <span class="comment">/* shared lock */</span>
<a name="l00315"></a>00315         <a class="code" href="../../d5/df2/win32_8c.html#a4975083a786e255dd9bea5ac03429efc">LK_ERR</a>(LockFileEx(fh, 0, 0, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>, &amp;o), i);
<a name="l00316"></a>00316         <span class="keywordflow">break</span>;
<a name="l00317"></a>00317       <span class="keywordflow">case</span> <a class="code" href="../../d6/d13/file_8c.html#a640585398981aa2bb565dd65ede96778">LOCK_EX</a>:             <span class="comment">/* exclusive lock */</span>
<a name="l00318"></a>00318         <a class="code" href="../../d5/df2/win32_8c.html#a4975083a786e255dd9bea5ac03429efc">LK_ERR</a>(LockFileEx(fh, LOCKFILE_EXCLUSIVE_LOCK, 0, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>, &amp;o), i);
<a name="l00319"></a>00319         <span class="keywordflow">break</span>;
<a name="l00320"></a>00320       <span class="keywordflow">case</span> <a class="code" href="../../d6/d13/file_8c.html#ab0abca95a2265e7cea4b2e026278a968">LOCK_SH</a>|<a class="code" href="../../d6/d13/file_8c.html#a3527dd84628b5a5c2befd2b7f57804c9">LOCK_NB</a>:     <span class="comment">/* non-blocking shared lock */</span>
<a name="l00321"></a>00321         <a class="code" href="../../d5/df2/win32_8c.html#a4975083a786e255dd9bea5ac03429efc">LK_ERR</a>(LockFileEx(fh, LOCKFILE_FAIL_IMMEDIATELY, 0, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>, &amp;o), i);
<a name="l00322"></a>00322         <span class="keywordflow">break</span>;
<a name="l00323"></a>00323       <span class="keywordflow">case</span> <a class="code" href="../../d6/d13/file_8c.html#a640585398981aa2bb565dd65ede96778">LOCK_EX</a>|<a class="code" href="../../d6/d13/file_8c.html#a3527dd84628b5a5c2befd2b7f57804c9">LOCK_NB</a>:     <span class="comment">/* non-blocking exclusive lock */</span>
<a name="l00324"></a>00324         <a class="code" href="../../d5/df2/win32_8c.html#a4975083a786e255dd9bea5ac03429efc">LK_ERR</a>(LockFileEx(fh,
<a name="l00325"></a>00325                           LOCKFILE_EXCLUSIVE_LOCK|LOCKFILE_FAIL_IMMEDIATELY,
<a name="l00326"></a>00326                           0, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>, &amp;o), i);
<a name="l00327"></a>00327         <span class="keywordflow">break</span>;
<a name="l00328"></a>00328       <span class="keywordflow">case</span> <a class="code" href="../../d6/d13/file_8c.html#a2078aa82765907b50b7656067c2e9578">LOCK_UN</a>:             <span class="comment">/* unlock lock */</span>
<a name="l00329"></a>00329       <span class="keywordflow">case</span> <a class="code" href="../../d6/d13/file_8c.html#a2078aa82765907b50b7656067c2e9578">LOCK_UN</a>|<a class="code" href="../../d6/d13/file_8c.html#a3527dd84628b5a5c2befd2b7f57804c9">LOCK_NB</a>:     <span class="comment">/* unlock is always non-blocking, I hope */</span>
<a name="l00330"></a>00330         <a class="code" href="../../d5/df2/win32_8c.html#a4975083a786e255dd9bea5ac03429efc">LK_ERR</a>(UnlockFileEx(fh, 0, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>, &amp;o), i);
<a name="l00331"></a>00331         <span class="keywordflow">break</span>;
<a name="l00332"></a>00332       <span class="keywordflow">default</span>:            <span class="comment">/* unknown */</span>
<a name="l00333"></a>00333         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l00334"></a>00334         <span class="keywordflow">break</span>;
<a name="l00335"></a>00335     }
<a name="l00336"></a>00336     <span class="keywordflow">return</span> i;
<a name="l00337"></a>00337 }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339 <span class="preprocessor">#ifdef WIN95</span>
<a name="l00340"></a>00340 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a>
<a name="l00341"></a>00341 flock_win95(<a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a> <span class="keyword">self</span>, <span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a>* <a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>)
<a name="l00342"></a>00342 {
<a name="l00343"></a>00343     <span class="keywordtype">int</span> i = -1;
<a name="l00344"></a>00344     <span class="keyword">const</span> HANDLE fh = (HANDLE)<span class="keyword">self</span>;
<a name="l00345"></a>00345     <span class="keyword">const</span> <span class="keywordtype">int</span> oper = argc;
<a name="l00346"></a>00346 
<a name="l00347"></a>00347     <span class="keywordflow">switch</span>(oper) {
<a name="l00348"></a>00348       <span class="keywordflow">case</span> <a class="code" href="../../d6/d13/file_8c.html#a640585398981aa2bb565dd65ede96778">LOCK_EX</a>:
<a name="l00349"></a>00349         <span class="keywordflow">do</span> {
<a name="l00350"></a>00350             <a class="code" href="../../d5/df2/win32_8c.html#a4975083a786e255dd9bea5ac03429efc">LK_ERR</a>(LockFile(fh, 0, 0, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>), i);
<a name="l00351"></a>00351         } <span class="keywordflow">while</span> (i &amp;&amp; errno == <a class="code" href="../../dd/d8c/rubysocket_8h.html#a4a3a0b3605fd3b2336455062ee8e25f0">EWOULDBLOCK</a>);
<a name="l00352"></a>00352         <span class="keywordflow">break</span>;
<a name="l00353"></a>00353       <span class="keywordflow">case</span> <a class="code" href="../../d6/d13/file_8c.html#a640585398981aa2bb565dd65ede96778">LOCK_EX</a>|<a class="code" href="../../d6/d13/file_8c.html#a3527dd84628b5a5c2befd2b7f57804c9">LOCK_NB</a>:
<a name="l00354"></a>00354         <a class="code" href="../../d5/df2/win32_8c.html#a4975083a786e255dd9bea5ac03429efc">LK_ERR</a>(LockFile(fh, 0, 0, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>), i);
<a name="l00355"></a>00355         <span class="keywordflow">break</span>;
<a name="l00356"></a>00356       <span class="keywordflow">case</span> <a class="code" href="../../d6/d13/file_8c.html#a2078aa82765907b50b7656067c2e9578">LOCK_UN</a>:
<a name="l00357"></a>00357       <span class="keywordflow">case</span> <a class="code" href="../../d6/d13/file_8c.html#a2078aa82765907b50b7656067c2e9578">LOCK_UN</a>|<a class="code" href="../../d6/d13/file_8c.html#a3527dd84628b5a5c2befd2b7f57804c9">LOCK_NB</a>:
<a name="l00358"></a>00358         <a class="code" href="../../d5/df2/win32_8c.html#a4975083a786e255dd9bea5ac03429efc">LK_ERR</a>(UnlockFile(fh, 0, 0, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>), i);
<a name="l00359"></a>00359         <span class="keywordflow">break</span>;
<a name="l00360"></a>00360       <span class="keywordflow">default</span>:
<a name="l00361"></a>00361         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l00362"></a>00362         <span class="keywordflow">break</span>;
<a name="l00363"></a>00363     }
<a name="l00364"></a>00364     <span class="keywordflow">return</span> i;
<a name="l00365"></a>00365 }
<a name="l00366"></a>00366 <span class="preprocessor">#endif</span>
<a name="l00367"></a>00367 <span class="preprocessor"></span>
<a name="l00368"></a>00368 <span class="preprocessor">#undef LK_ERR</span>
<a name="l00369"></a>00369 <span class="preprocessor"></span>
<a name="l00370"></a>00370 <span class="keywordtype">int</span>
<a name="l00371"></a><a class="code" href="../../d5/df2/win32_8c.html#a954bfeba0518dae539d0511dc328483c">00371</a> <a class="code" href="../../d6/d13/file_8c.html#adfd2c00559413ba0c3cbbaa019401f36">flock</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> oper)
<a name="l00372"></a>00372 {
<a name="l00373"></a>00373 <span class="preprocessor">#ifdef WIN95</span>
<a name="l00374"></a>00374 <span class="preprocessor"></span>    <span class="keyword">static</span> <a class="code" href="../../dc/db1/win32_8h.html#a49db9c26252dd53abc594d9c721df236">asynchronous_func_t</a> locker = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376     <span class="keywordflow">if</span> (!locker) {
<a name="l00377"></a>00377         <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#aaa9c3231dcc73fc8381f671b588fb13a">IsWinNT</a>())
<a name="l00378"></a>00378             locker = <a class="code" href="../../d5/df2/win32_8c.html#a10920f4237da8811157a63e5de45c92a">flock_winnt</a>;
<a name="l00379"></a>00379         <span class="keywordflow">else</span>
<a name="l00380"></a>00380             locker = flock_win95;
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382 <span class="preprocessor">#else</span>
<a name="l00383"></a>00383 <span class="preprocessor"></span>    <span class="keyword">const</span> <a class="code" href="../../dc/db1/win32_8h.html#a49db9c26252dd53abc594d9c721df236">asynchronous_func_t</a> locker = <a class="code" href="../../d5/df2/win32_8c.html#a10920f4237da8811157a63e5de45c92a">flock_winnt</a>;
<a name="l00384"></a>00384 <span class="preprocessor">#endif</span>
<a name="l00385"></a>00385 <span class="preprocessor"></span>
<a name="l00386"></a>00386     <span class="keywordflow">return</span> <a class="code" href="../../dc/db1/win32_8h.html#af3f08931b6e3520982f288af6965f628">rb_w32_asynchronize</a>(locker,
<a name="l00387"></a>00387                               (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)_get_osfhandle(fd), oper, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l00388"></a>00388                               (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)-1);
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 <span class="keyword">static</span> <span class="keyword">inline</span> WCHAR *
<a name="l00392"></a><a class="code" href="../../d5/df2/win32_8c.html#a6328ee8a04b341b66ce8676a6e5a4151">00392</a> <a class="code" href="../../d5/df2/win32_8c.html#a6328ee8a04b341b66ce8676a6e5a4151">translate_wchar</a>(WCHAR *p, <span class="keywordtype">int</span> from, <span class="keywordtype">int</span> to)
<a name="l00393"></a>00393 {
<a name="l00394"></a>00394     <span class="keywordflow">for</span> (; *p; p++) {
<a name="l00395"></a>00395         <span class="keywordflow">if</span> (*p == from)
<a name="l00396"></a>00396             *p = to;
<a name="l00397"></a>00397     }
<a name="l00398"></a>00398     <span class="keywordflow">return</span> p;
<a name="l00399"></a>00399 }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">char</span> *
<a name="l00402"></a><a class="code" href="../../d5/df2/win32_8c.html#a4f27c8c10e28d59b4c43bacbcd2fa76c">00402</a> <a class="code" href="../../d5/df2/win32_8c.html#a4f27c8c10e28d59b4c43bacbcd2fa76c">translate_char</a>(<span class="keywordtype">char</span> *p, <span class="keywordtype">int</span> from, <span class="keywordtype">int</span> to)
<a name="l00403"></a>00403 {
<a name="l00404"></a>00404     <span class="keywordflow">while</span> (*p) {
<a name="l00405"></a>00405         <span class="keywordflow">if</span> ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)*p == from)
<a name="l00406"></a>00406             *p = to;
<a name="l00407"></a>00407         p = <a class="code" href="../../dd/dd0/eval__intern_8h.html#a0892c4ab83ee67ec75cad2debdb5ddbb">CharNext</a>(p);
<a name="l00408"></a>00408     }
<a name="l00409"></a>00409     <span class="keywordflow">return</span> p;
<a name="l00410"></a>00410 }
<a name="l00411"></a>00411 
<a name="l00412"></a>00412 <span class="preprocessor">#ifndef CSIDL_LOCAL_APPDATA</span>
<a name="l00413"></a><a class="code" href="../../d5/df2/win32_8c.html#a86443d3467c24dae3bb85d7a61940c18">00413</a> <span class="preprocessor"></span><span class="preprocessor">#define CSIDL_LOCAL_APPDATA 28</span>
<a name="l00414"></a>00414 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00415"></a>00415 <span class="preprocessor"></span><span class="preprocessor">#ifndef CSIDL_COMMON_APPDATA</span>
<a name="l00416"></a><a class="code" href="../../d5/df2/win32_8c.html#a54662e98df777873978c530904fa7c83">00416</a> <span class="preprocessor"></span><span class="preprocessor">#define CSIDL_COMMON_APPDATA 35</span>
<a name="l00417"></a>00417 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00418"></a>00418 <span class="preprocessor"></span><span class="preprocessor">#ifndef CSIDL_WINDOWS</span>
<a name="l00419"></a><a class="code" href="../../d5/df2/win32_8c.html#ad201e3fa3bff98d2b39f7f4bb812acf5">00419</a> <span class="preprocessor"></span><span class="preprocessor">#define CSIDL_WINDOWS   36</span>
<a name="l00420"></a>00420 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00421"></a>00421 <span class="preprocessor"></span><span class="preprocessor">#ifndef CSIDL_SYSTEM</span>
<a name="l00422"></a><a class="code" href="../../d5/df2/win32_8c.html#a810ec278cc7d61e8f1b0adf2280a9298">00422</a> <span class="preprocessor"></span><span class="preprocessor">#define CSIDL_SYSTEM    37</span>
<a name="l00423"></a>00423 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00424"></a>00424 <span class="preprocessor"></span><span class="preprocessor">#ifndef CSIDL_PROFILE</span>
<a name="l00425"></a><a class="code" href="../../d5/df2/win32_8c.html#a8c5b4bb58da79de9b8113d1abc7f13d1">00425</a> <span class="preprocessor"></span><span class="preprocessor">#define CSIDL_PROFILE 40</span>
<a name="l00426"></a>00426 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00427"></a>00427 <span class="preprocessor"></span>
<a name="l00428"></a>00428 <span class="keyword">static</span> BOOL
<a name="l00429"></a><a class="code" href="../../d5/df2/win32_8c.html#a541ed97dad7c4e74b64ebb4d23df18b7">00429</a> <a class="code" href="../../d5/df2/win32_8c.html#a541ed97dad7c4e74b64ebb4d23df18b7">get_special_folder</a>(<span class="keywordtype">int</span> n, WCHAR *env)
<a name="l00430"></a>00430 {
<a name="l00431"></a>00431     LPITEMIDLIST pidl;
<a name="l00432"></a>00432     LPMALLOC <a class="code" href="../../d4/d71/st_8c.html#a385b96996caa48e6349681cf8036322f">alloc</a>;
<a name="l00433"></a>00433     BOOL f = <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00434"></a>00434     <span class="keywordflow">if</span> (SHGetSpecialFolderLocation(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, n, &amp;pidl) == 0) {
<a name="l00435"></a>00435         f = SHGetPathFromIDListW(pidl, env);
<a name="l00436"></a>00436         SHGetMalloc(&amp;alloc);
<a name="l00437"></a>00437         alloc-&gt;lpVtbl-&gt;Free(alloc, pidl);
<a name="l00438"></a>00438         alloc-&gt;lpVtbl-&gt;Release(alloc);
<a name="l00439"></a>00439     }
<a name="l00440"></a>00440     <span class="keywordflow">return</span> f;
<a name="l00441"></a>00441 }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00444"></a><a class="code" href="../../d5/df2/win32_8c.html#a8d87bbc0e6900e1f333d07c8bcdbef1f">00444</a> <a class="code" href="../../d5/df2/win32_8c.html#a8d87bbc0e6900e1f333d07c8bcdbef1f">regulate_path</a>(WCHAR *path)
<a name="l00445"></a>00445 {
<a name="l00446"></a>00446     WCHAR *p = <a class="code" href="../../d5/df2/win32_8c.html#a6328ee8a04b341b66ce8676a6e5a4151">translate_wchar</a>(path, L<span class="charliteral">&apos;\\&apos;</span>, L<span class="charliteral">&apos;/&apos;</span>);
<a name="l00447"></a>00447     <span class="keywordflow">if</span> (p - path == 2 &amp;&amp; path[1] == L<span class="charliteral">&apos;:&apos;</span>) {
<a name="l00448"></a>00448         *p++ = L<span class="charliteral">&apos;/&apos;</span>;
<a name="l00449"></a>00449         *p = L<span class="charliteral">&apos;\0&apos;</span>;
<a name="l00450"></a>00450     }
<a name="l00451"></a>00451 }
<a name="l00452"></a>00452 
<a name="l00453"></a>00453 <span class="keyword">static</span> FARPROC
<a name="l00454"></a><a class="code" href="../../d5/df2/win32_8c.html#a8ab64e43a3bd89bcdebe1111534a0bfa">00454</a> <a class="code" href="../../d5/df2/win32_8c.html#a8ab64e43a3bd89bcdebe1111534a0bfa">get_proc_address</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *module, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a>, HANDLE *mh)
<a name="l00455"></a>00455 {
<a name="l00456"></a>00456     HANDLE h;
<a name="l00457"></a>00457     FARPROC ptr;
<a name="l00458"></a>00458 
<a name="l00459"></a>00459     <span class="keywordflow">if</span> (mh)
<a name="l00460"></a>00460         h = LoadLibrary(module);
<a name="l00461"></a>00461     <span class="keywordflow">else</span>
<a name="l00462"></a>00462         h = GetModuleHandle(module);
<a name="l00463"></a>00463     <span class="keywordflow">if</span> (!h)
<a name="l00464"></a>00464         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00465"></a>00465 
<a name="l00466"></a>00466     ptr = GetProcAddress(h, func);
<a name="l00467"></a>00467     <span class="keywordflow">if</span> (mh) {
<a name="l00468"></a>00468         <span class="keywordflow">if</span> (ptr)
<a name="l00469"></a>00469             *mh = h;
<a name="l00470"></a>00470         <span class="keywordflow">else</span>
<a name="l00471"></a>00471             FreeLibrary(h);
<a name="l00472"></a>00472     }
<a name="l00473"></a>00473     <span class="keywordflow">return</span> ptr;
<a name="l00474"></a>00474 }
<a name="l00475"></a>00475 
<a name="l00476"></a>00476 <span class="keyword">static</span> UINT
<a name="l00477"></a><a class="code" href="../../d5/df2/win32_8c.html#ae07fb056872df9ee05506865730c2aac">00477</a> <a class="code" href="../../d5/df2/win32_8c.html#ae07fb056872df9ee05506865730c2aac">get_system_directory</a>(WCHAR *path, UINT <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>)
<a name="l00478"></a>00478 {
<a name="l00479"></a>00479     <span class="keyword">typedef</span> UINT WINAPI wgetdir_func(WCHAR*, UINT);
<a name="l00480"></a>00480     FARPROC ptr =
<a name="l00481"></a>00481         <a class="code" href="../../d5/df2/win32_8c.html#a8ab64e43a3bd89bcdebe1111534a0bfa">get_proc_address</a>(<span class="stringliteral">&quot;kernel32&quot;</span>, <span class="stringliteral">&quot;GetSystemWindowsDirectoryW&quot;</span>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00482"></a>00482     <span class="keywordflow">if</span> (ptr)
<a name="l00483"></a>00483         <span class="keywordflow">return</span> (*(wgetdir_func *)ptr)(path, len);
<a name="l00484"></a>00484     <span class="keywordflow">return</span> GetWindowsDirectoryW(path, len);
<a name="l00485"></a>00485 }
<a name="l00486"></a>00486 
<a name="l00487"></a><a class="code" href="../../d5/df2/win32_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">00487</a> <span class="preprocessor">#define numberof(array) (sizeof(array) / sizeof(*array))</span>
<a name="l00488"></a>00488 <span class="preprocessor"></span>
<a name="l00489"></a>00489 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00490"></a><a class="code" href="../../d5/df2/win32_8c.html#a0455c6105c76f1da6abaa67ced07eb90">00490</a> <a class="code" href="../../d5/df2/win32_8c.html#a0455c6105c76f1da6abaa67ced07eb90">rb_w32_special_folder</a>(<span class="keywordtype">int</span> <a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>)
<a name="l00491"></a>00491 {
<a name="l00492"></a>00492     WCHAR path[_MAX_PATH];
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/df2/win32_8c.html#a541ed97dad7c4e74b64ebb4d23df18b7">get_special_folder</a>(type, path)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00495"></a>00495     <a class="code" href="../../d5/df2/win32_8c.html#a8d87bbc0e6900e1f333d07c8bcdbef1f">regulate_path</a>(path);
<a name="l00496"></a>00496     <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#a6819474e0e7018ff2086dd8ac6ba6fed">rb_w32_conv_from_wchar</a>(path, <a class="code" href="../../d5/db5/encoding_8c.html#af99b5328ff8c5511cbccd48fc0fe82bc">rb_filesystem_encoding</a>());
<a name="l00497"></a>00497 }
<a name="l00498"></a>00498 
<a name="l00499"></a>00499 UINT
<a name="l00500"></a><a class="code" href="../../d5/df2/win32_8c.html#a82f2ec24703ef8396b53aea5f33393f8">00500</a> <a class="code" href="../../d5/df2/win32_8c.html#a82f2ec24703ef8396b53aea5f33393f8">rb_w32_system_tmpdir</a>(WCHAR *path, UINT <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>)
<a name="l00501"></a>00501 {
<a name="l00502"></a>00502     <span class="keyword">static</span> <span class="keyword">const</span> WCHAR temp[] = L<span class="stringliteral">&quot;temp&quot;</span>;
<a name="l00503"></a>00503     WCHAR *p;
<a name="l00504"></a>00504 
<a name="l00505"></a>00505     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/df2/win32_8c.html#a541ed97dad7c4e74b64ebb4d23df18b7">get_special_folder</a>(<a class="code" href="../../d5/df2/win32_8c.html#a86443d3467c24dae3bb85d7a61940c18">CSIDL_LOCAL_APPDATA</a>, path)) {
<a name="l00506"></a>00506         <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#ae07fb056872df9ee05506865730c2aac">get_system_directory</a>(path, len)) <span class="keywordflow">return</span> 0;
<a name="l00507"></a>00507     }
<a name="l00508"></a>00508     p = <a class="code" href="../../d5/df2/win32_8c.html#a6328ee8a04b341b66ce8676a6e5a4151">translate_wchar</a>(path, L<span class="charliteral">&apos;\\&apos;</span>, L<span class="charliteral">&apos;/&apos;</span>);
<a name="l00509"></a>00509     <span class="keywordflow">if</span> (*(p - 1) != L<span class="charliteral">&apos;/&apos;</span>) *p++ = L<span class="charliteral">&apos;/&apos;</span>;
<a name="l00510"></a>00510     <span class="keywordflow">if</span> (p - path + <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(temp) &gt;= len) <span class="keywordflow">return</span> 0;
<a name="l00511"></a>00511     memcpy(p, temp, <span class="keyword">sizeof</span>(temp));
<a name="l00512"></a>00512     <span class="keywordflow">return</span> p - path + <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(temp) - 1;
<a name="l00513"></a>00513 }
<a name="l00514"></a>00514 
<a name="l00515"></a>00515 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00516"></a><a class="code" href="../../d5/df2/win32_8c.html#aeba390fc42b3f12a574eacccf81d0faf">00516</a> <a class="code" href="../../d5/df2/win32_8c.html#aeba390fc42b3f12a574eacccf81d0faf">init_env</a>(<span class="keywordtype">void</span>)
<a name="l00517"></a>00517 {
<a name="l00518"></a>00518     <span class="keyword">static</span> <span class="keyword">const</span> WCHAR TMPDIR[] = L<span class="stringliteral">&quot;TMPDIR&quot;</span>;
<a name="l00519"></a>00519     <span class="keyword">struct </span>{WCHAR <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>[6], <a class="code" href="../../df/d73/time_8c.html#a32facebc76371374adf80b7db62a7601">eq</a>, val[_MAX_PATH];} wk;
<a name="l00520"></a>00520     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l00521"></a>00521     BOOL f;
<a name="l00522"></a>00522 <span class="preprocessor">#define env wk.val</span>
<a name="l00523"></a>00523 <span class="preprocessor"></span><span class="preprocessor">#define set_env_val(vname) do { \</span>
<a name="l00524"></a>00524 <span class="preprocessor">        typedef char namesizecheck[numberof(wk.name) &lt; numberof(vname) - 1 ? -1 : 1]; \</span>
<a name="l00525"></a>00525 <span class="preprocessor">        WCHAR *const buf = wk.name + numberof(wk.name) - numberof(vname) + 1; \</span>
<a name="l00526"></a>00526 <span class="preprocessor">        MEMCPY(buf, vname, WCHAR, numberof(vname) - 1); \</span>
<a name="l00527"></a>00527 <span class="preprocessor">        _wputenv(buf); \</span>
<a name="l00528"></a>00528 <span class="preprocessor">    } while (0)</span>
<a name="l00529"></a>00529 <span class="preprocessor"></span>
<a name="l00530"></a>00530     wk.eq = L<span class="charliteral">&apos;=&apos;</span>;
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     <span class="keywordflow">if</span> (!GetEnvironmentVariableW(L<span class="stringliteral">&quot;HOME&quot;</span>, <a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>, <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>))) {
<a name="l00533"></a>00533         f = <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00534"></a>00534         <span class="keywordflow">if</span> (GetEnvironmentVariableW(L<span class="stringliteral">&quot;HOMEDRIVE&quot;</span>, <a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>, <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>)))
<a name="l00535"></a>00535             len = lstrlenW(<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>);
<a name="l00536"></a>00536         <span class="keywordflow">else</span>
<a name="l00537"></a>00537             len = 0;
<a name="l00538"></a>00538         <span class="keywordflow">if</span> (GetEnvironmentVariableW(L<span class="stringliteral">&quot;HOMEPATH&quot;</span>, <a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a> + len, <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>) - len) || len) {
<a name="l00539"></a>00539             f = <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00540"></a>00540         }
<a name="l00541"></a>00541         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GetEnvironmentVariableW(L<span class="stringliteral">&quot;USERPROFILE&quot;</span>, <a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>, <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>))) {
<a name="l00542"></a>00542             f = <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00543"></a>00543         }
<a name="l00544"></a>00544         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a541ed97dad7c4e74b64ebb4d23df18b7">get_special_folder</a>(<a class="code" href="../../d5/df2/win32_8c.html#a8c5b4bb58da79de9b8113d1abc7f13d1">CSIDL_PROFILE</a>, <a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>)) {
<a name="l00545"></a>00545             f = <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00546"></a>00546         }
<a name="l00547"></a>00547         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a541ed97dad7c4e74b64ebb4d23df18b7">get_special_folder</a>(CSIDL_PERSONAL, <a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>)) {
<a name="l00548"></a>00548             f = <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00549"></a>00549         }
<a name="l00550"></a>00550         <span class="keywordflow">if</span> (f) {
<a name="l00551"></a>00551             <a class="code" href="../../d5/df2/win32_8c.html#a8d87bbc0e6900e1f333d07c8bcdbef1f">regulate_path</a>(<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>);
<a name="l00552"></a>00552             <a class="code" href="../../d5/df2/win32_8c.html#ad0bdfb027793fe117b4dbb55b2c79c7d">set_env_val</a>(L<span class="stringliteral">&quot;HOME&quot;</span>);
<a name="l00553"></a>00553         }
<a name="l00554"></a>00554     }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556     <span class="keywordflow">if</span> (!GetEnvironmentVariableW(L<span class="stringliteral">&quot;USER&quot;</span>, <a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>, <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>))) {
<a name="l00557"></a>00557         <span class="keywordflow">if</span> (!GetEnvironmentVariableW(L<span class="stringliteral">&quot;USERNAME&quot;</span>, <a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>, <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>)) &amp;&amp;
<a name="l00558"></a>00558             !GetUserNameW(<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>, (len = <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>), &amp;len))) {
<a name="l00559"></a>00559             <a class="code" href="../../d5/df2/win32_8c.html#adf9f962e6a4b8cba2b38594991132989">NTLoginName</a> = <span class="stringliteral">&quot;&lt;Unknown&gt;&quot;</span>;
<a name="l00560"></a>00560             <span class="keywordflow">return</span>;
<a name="l00561"></a>00561         }
<a name="l00562"></a>00562         <a class="code" href="../../d5/df2/win32_8c.html#ad0bdfb027793fe117b4dbb55b2c79c7d">set_env_val</a>(L<span class="stringliteral">&quot;USER&quot;</span>);
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564     <a class="code" href="../../d5/df2/win32_8c.html#adf9f962e6a4b8cba2b38594991132989">NTLoginName</a> = <a class="code" href="../../d8/d3c/util_8h.html#ad832104a69551cf1e4e347fffa9dc77c">strdup</a>(<a class="code" href="../../dc/db1/win32_8h.html#ab7ab738566effab1d8ce0d8a2540695d">rb_w32_getenv</a>(<span class="stringliteral">&quot;USER&quot;</span>));
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     <span class="keywordflow">if</span> (!GetEnvironmentVariableW(TMPDIR, <a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>, <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>)) &amp;&amp;
<a name="l00567"></a>00567         !GetEnvironmentVariableW(L<span class="stringliteral">&quot;TMP&quot;</span>, <a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>, <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>)) &amp;&amp;
<a name="l00568"></a>00568         !GetEnvironmentVariableW(L<span class="stringliteral">&quot;TEMP&quot;</span>, <a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>, <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>)) &amp;&amp;
<a name="l00569"></a>00569         <a class="code" href="../../d5/df2/win32_8c.html#a82f2ec24703ef8396b53aea5f33393f8">rb_w32_system_tmpdir</a>(<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>, <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>))) {
<a name="l00570"></a>00570         <a class="code" href="../../d5/df2/win32_8c.html#ad0bdfb027793fe117b4dbb55b2c79c7d">set_env_val</a>(TMPDIR);
<a name="l00571"></a>00571     }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573 <span class="preprocessor">#undef env</span>
<a name="l00574"></a>00574 <span class="preprocessor"></span><span class="preprocessor">#undef set_env_val</span>
<a name="l00575"></a>00575 <span class="preprocessor"></span>}
<a name="l00576"></a>00576 
<a name="l00577"></a>00577 
<a name="l00578"></a><a class="code" href="../../d5/df2/win32_8c.html#ad9dc358f685a57946d2fed18cfa8d628">00578</a> <span class="keyword">typedef</span> BOOL (WINAPI *<a class="code" href="../../d5/df2/win32_8c.html#ad9dc358f685a57946d2fed18cfa8d628">cancel_io_t</a>)(HANDLE);
<a name="l00579"></a><a class="code" href="../../d5/df2/win32_8c.html#a87c46885302df4c28bc6825fb195df1f">00579</a> <span class="keyword">static</span> <a class="code" href="../../d5/df2/win32_8c.html#ad9dc358f685a57946d2fed18cfa8d628">cancel_io_t</a> <a class="code" href="../../d5/df2/win32_8c.html#a87c46885302df4c28bc6825fb195df1f">cancel_io</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00580"></a>00580 
<a name="l00581"></a>00581 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00582"></a><a class="code" href="../../d5/df2/win32_8c.html#a1cebd635112727149052ff86964abeac">00582</a> <a class="code" href="../../d5/df2/win32_8c.html#a1cebd635112727149052ff86964abeac">init_func</a>(<span class="keywordtype">void</span>)
<a name="l00583"></a>00583 {
<a name="l00584"></a>00584     <span class="keywordflow">if</span> (!cancel_io)
<a name="l00585"></a>00585         cancel_io = (<a class="code" href="../../d5/df2/win32_8c.html#ad9dc358f685a57946d2fed18cfa8d628">cancel_io_t</a>)<a class="code" href="../../d5/df2/win32_8c.html#a8ab64e43a3bd89bcdebe1111534a0bfa">get_proc_address</a>(<span class="stringliteral">&quot;kernel32&quot;</span>, <span class="stringliteral">&quot;CancelIo&quot;</span>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00586"></a>00586 }
<a name="l00587"></a>00587 
<a name="l00588"></a>00588 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../d5/df2/win32_8c.html#a7bcbc2f82c5031d05ac003ef21f7f900">init_stdhandle</a>(<span class="keywordtype">void</span>);
<a name="l00589"></a>00589 
<a name="l00590"></a>00590 <span class="preprocessor">#if RT_VER &gt;= 80</span>
<a name="l00591"></a>00591 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00592"></a>00592 invalid_parameter(<span class="keyword">const</span> <span class="keywordtype">wchar_t</span> *expr, <span class="keyword">const</span> <span class="keywordtype">wchar_t</span> *<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a>, <span class="keyword">const</span> <span class="keywordtype">wchar_t</span> *file, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> line, <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a> dummy)
<a name="l00593"></a>00593 {
<a name="l00594"></a>00594     <span class="comment">// nothing to do</span>
<a name="l00595"></a>00595 }
<a name="l00596"></a>00596 
<a name="l00597"></a>00597 <span class="keywordtype">int</span> ruby_w32_rtc_error;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 <span class="keyword">static</span> <span class="keywordtype">int</span> __cdecl
<a name="l00600"></a>00600 rtc_error_handler(<span class="keywordtype">int</span> e, <span class="keyword">const</span> <span class="keywordtype">char</span> *src, <span class="keywordtype">int</span> line, <span class="keyword">const</span> <span class="keywordtype">char</span> *exe, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...)
<a name="l00601"></a>00601 {
<a name="l00602"></a>00602     va_list ap;
<a name="l00603"></a>00603     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str;
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     <span class="keywordflow">if</span> (!ruby_w32_rtc_error) <span class="keywordflow">return</span> 0;
<a name="l00606"></a>00606     str = <a class="code" href="../../d9/d2d/sprintf_8c.html#a05c34a91ab36c6a463c861df47808fae">rb_sprintf</a>(<span class="stringliteral">&quot;%s:%d: &quot;</span>, src, line);
<a name="l00607"></a>00607     va_start(ap, fmt);
<a name="l00608"></a>00608     <a class="code" href="../../db/d2e/intern_8h.html#a431fe56e927b571beb0a4b76791368a6">rb_str_vcatf</a>(str, fmt, ap);
<a name="l00609"></a>00609     va_end(ap);
<a name="l00610"></a>00610     <a class="code" href="../../db/d2e/intern_8h.html#a4e3e3ccf959b5db6c125a68e1e1db0a3">rb_str_cat</a>(str, <span class="stringliteral">&quot;\n&quot;</span>, 1);
<a name="l00611"></a>00611     <a class="code" href="../../db/d2e/intern_8h.html#abf2dfce0fb7de77f5fe6ceaf50a23913">rb_write_error2</a>(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str));
<a name="l00612"></a>00612     <span class="keywordflow">return</span> 0;
<a name="l00613"></a>00613 }
<a name="l00614"></a>00614 <span class="preprocessor">#endif</span>
<a name="l00615"></a>00615 <span class="preprocessor"></span>
<a name="l00616"></a><a class="code" href="../../d5/df2/win32_8c.html#aa4d8b1a3d1611dbbc0e99f6875945df4">00616</a> <span class="keyword">static</span> CRITICAL_SECTION <a class="code" href="../../d5/df2/win32_8c.html#aa4d8b1a3d1611dbbc0e99f6875945df4">select_mutex</a>;
<a name="l00617"></a><a class="code" href="../../d5/df2/win32_8c.html#abaa7dc854a1b5a7542399df7bf5a9c0a">00617</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/df2/win32_8c.html#abaa7dc854a1b5a7542399df7bf5a9c0a">NtSocketsInitialized</a> = 0;
<a name="l00618"></a><a class="code" href="../../d5/df2/win32_8c.html#a3b28960d6ace1508c97834715e9d8e9f">00618</a> <span class="keyword">static</span> <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *<a class="code" href="../../d5/df2/win32_8c.html#a3b28960d6ace1508c97834715e9d8e9f">socklist</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00619"></a><a class="code" href="../../d5/df2/win32_8c.html#a444b3d25ec7fda40b0e59571eda10fed">00619</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../d5/df2/win32_8c.html#a444b3d25ec7fda40b0e59571eda10fed">envarea</a>;
<a name="l00620"></a>00620 
<a name="l00621"></a>00621 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00622"></a><a class="code" href="../../d5/df2/win32_8c.html#a85814c3b3039a641a3eb451b354ca988">00622</a> <a class="code" href="../../d5/df2/win32_8c.html#a85814c3b3039a641a3eb451b354ca988">exit_handler</a>(<span class="keywordtype">void</span>)
<a name="l00623"></a>00623 {
<a name="l00624"></a>00624     <span class="keywordflow">if</span> (NtSocketsInitialized) {
<a name="l00625"></a>00625         WSACleanup();
<a name="l00626"></a>00626         <a class="code" href="../../dd/d24/st_8h.html#acb004847ef312373d65bfb0d1a21c5b3">st_free_table</a>(socklist);
<a name="l00627"></a>00627         socklist = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00628"></a>00628         NtSocketsInitialized = 0;
<a name="l00629"></a>00629     }
<a name="l00630"></a>00630     <span class="keywordflow">if</span> (envarea) {
<a name="l00631"></a>00631         FreeEnvironmentStrings(envarea);
<a name="l00632"></a>00632         envarea = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00633"></a>00633     }
<a name="l00634"></a>00634     DeleteCriticalSection(&amp;select_mutex);
<a name="l00635"></a>00635 }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00638"></a><a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">00638</a> <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>(<span class="keywordtype">void</span>)
<a name="l00639"></a>00639 {
<a name="l00640"></a>00640     WORD <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a4fbbbc8d035c85ce83c6f270a2e56012">version</a>;
<a name="l00641"></a>00641     WSADATA retdata;
<a name="l00642"></a>00642 
<a name="l00643"></a>00643     <span class="comment">//</span>
<a name="l00644"></a>00644     <span class="comment">// initalize the winsock interface and insure that it&apos;s</span>
<a name="l00645"></a>00645     <span class="comment">// cleaned up at exit.</span>
<a name="l00646"></a>00646     <span class="comment">//</span>
<a name="l00647"></a>00647     version = MAKEWORD(2, 0);
<a name="l00648"></a>00648     <span class="keywordflow">if</span> (WSAStartup(version, &amp;retdata))
<a name="l00649"></a>00649         <a class="code" href="../../db/dcc/error_8c.html#a643ceabe39fa1f8c99066a321397a115">rb_fatal</a> (<span class="stringliteral">&quot;Unable to locate winsock library!\n&quot;</span>);
<a name="l00650"></a>00650     <span class="keywordflow">if</span> (LOBYTE(retdata.wVersion) != 2)
<a name="l00651"></a>00651         <a class="code" href="../../db/dcc/error_8c.html#a643ceabe39fa1f8c99066a321397a115">rb_fatal</a>(<span class="stringliteral">&quot;could not find version 2 of winsock dll\n&quot;</span>);
<a name="l00652"></a>00652 
<a name="l00653"></a>00653     socklist = <a class="code" href="../../dd/d24/st_8h.html#a955c6e936b9681649ab9ffa4aa741949">st_init_numtable</a>();
<a name="l00654"></a>00654 
<a name="l00655"></a>00655     NtSocketsInitialized = 1;
<a name="l00656"></a>00656 }
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 <span class="comment">//</span>
<a name="l00659"></a>00659 <span class="comment">// Initialization stuff</span>
<a name="l00660"></a>00660 <span class="comment">//</span>
<a name="l00661"></a>00661 <span class="keywordtype">void</span>
<a name="l00662"></a><a class="code" href="../../d5/df2/win32_8c.html#ab5ca609dd4661f044cecf9e74eef0528">00662</a> <a class="code" href="../../d5/df2/win32_8c.html#ab5ca609dd4661f044cecf9e74eef0528">rb_w32_sysinit</a>(<span class="keywordtype">int</span> *argc, <span class="keywordtype">char</span> ***argv)
<a name="l00663"></a>00663 {
<a name="l00664"></a>00664 <span class="preprocessor">#if RT_VER &gt;= 80</span>
<a name="l00665"></a>00665 <span class="preprocessor"></span>    <span class="keyword">static</span> <span class="keywordtype">void</span> set_pioinfo_extra(<span class="keywordtype">void</span>);
<a name="l00666"></a>00666 
<a name="l00667"></a>00667     _CrtSetReportMode(_CRT_ASSERT, 0);
<a name="l00668"></a>00668     _set_invalid_parameter_handler(invalid_parameter);
<a name="l00669"></a>00669     _RTC_SetErrorFunc(rtc_error_handler);
<a name="l00670"></a>00670     set_pioinfo_extra();
<a name="l00671"></a>00671 <span class="preprocessor">#else</span>
<a name="l00672"></a>00672 <span class="preprocessor"></span>    SetErrorMode(SEM_FAILCRITICALERRORS|SEM_NOGPFAULTERRORBOX);
<a name="l00673"></a>00673 <span class="preprocessor">#endif</span>
<a name="l00674"></a>00674 <span class="preprocessor"></span>
<a name="l00675"></a>00675     <a class="code" href="../../d5/df2/win32_8c.html#a9cdc46735a9ae517cf7aa3c5379b0c0c">get_version</a>();
<a name="l00676"></a>00676 
<a name="l00677"></a>00677     <span class="comment">//</span>
<a name="l00678"></a>00678     <span class="comment">// subvert cmd.exe&apos;s feeble attempt at command line parsing</span>
<a name="l00679"></a>00679     <span class="comment">//</span>
<a name="l00680"></a>00680     *argc = <a class="code" href="../../dc/db1/win32_8h.html#aacd9c53bcbb2361cc96afc053c00fe62">rb_w32_cmdvector</a>(GetCommandLine(), argv);
<a name="l00681"></a>00681 
<a name="l00682"></a>00682     <span class="comment">//</span>
<a name="l00683"></a>00683     <span class="comment">// Now set up the correct time stuff</span>
<a name="l00684"></a>00684     <span class="comment">//</span>
<a name="l00685"></a>00685 
<a name="l00686"></a>00686     tzset();
<a name="l00687"></a>00687 
<a name="l00688"></a>00688     <a class="code" href="../../d5/df2/win32_8c.html#aeba390fc42b3f12a574eacccf81d0faf">init_env</a>();
<a name="l00689"></a>00689 
<a name="l00690"></a>00690     <a class="code" href="../../d5/df2/win32_8c.html#a1cebd635112727149052ff86964abeac">init_func</a>();
<a name="l00691"></a>00691 
<a name="l00692"></a>00692     <a class="code" href="../../d5/df2/win32_8c.html#a7bcbc2f82c5031d05ac003ef21f7f900">init_stdhandle</a>();
<a name="l00693"></a>00693 
<a name="l00694"></a>00694     InitializeCriticalSection(&amp;select_mutex);
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     atexit(<a class="code" href="../../d5/df2/win32_8c.html#a85814c3b3039a641a3eb451b354ca988">exit_handler</a>);
<a name="l00697"></a>00697 
<a name="l00698"></a>00698     <span class="comment">// Initialize Winsock</span>
<a name="l00699"></a>00699     <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l00700"></a>00700 }
<a name="l00701"></a>00701 
<a name="l00702"></a>00702 <span class="keywordtype">char</span> *
<a name="l00703"></a><a class="code" href="../../d5/df2/win32_8c.html#a2f548c2e5c81cb4fe54e753f105c55ae">00703</a> <a class="code" href="../../d5/d97/etc_8c.html#a188f761bb917910d27259874fe60236f">getlogin</a>(<span class="keywordtype">void</span>)
<a name="l00704"></a>00704 {
<a name="l00705"></a>00705     <span class="keywordflow">return</span> (<span class="keywordtype">char</span> *)<a class="code" href="../../d5/df2/win32_8c.html#adf9f962e6a4b8cba2b38594991132989">NTLoginName</a>;
<a name="l00706"></a>00706 }
<a name="l00707"></a>00707 
<a name="l00708"></a><a class="code" href="../../d5/df2/win32_8c.html#aaf762ba5effab0ba80b63aa460f8ed50">00708</a> <span class="preprocessor">#define MAXCHILDNUM 256 </span><span class="comment">/* max num of child processes */</span>
<a name="l00709"></a>00709 
<a name="l00710"></a><a class="code" href="../../df/dca/struct_child_record.html">00710</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../df/dca/struct_child_record.html">ChildRecord</a> {
<a name="l00711"></a><a class="code" href="../../df/dca/struct_child_record.html#a6f4d66712210547a5b5631a2c3da9836">00711</a>     HANDLE <a class="code" href="../../df/dca/struct_child_record.html#a6f4d66712210547a5b5631a2c3da9836">hProcess</a>;    <span class="comment">/* process handle */</span>
<a name="l00712"></a><a class="code" href="../../df/dca/struct_child_record.html#a0102701165f7c23d4695251e9d3631fa">00712</a>     rb_pid_t <a class="code" href="../../df/dca/struct_child_record.html#a0102701165f7c23d4695251e9d3631fa">pid</a>;       <span class="comment">/* process id */</span>
<a name="l00713"></a>00713 } <a class="code" href="../../df/dca/struct_child_record.html">ChildRecord</a>[<a class="code" href="../../d5/df2/win32_8c.html#aaf762ba5effab0ba80b63aa460f8ed50">MAXCHILDNUM</a>];
<a name="l00714"></a>00714 
<a name="l00715"></a><a class="code" href="../../d5/df2/win32_8c.html#ae7244715d5ef9f0293bdab6b8c763f97">00715</a> <span class="preprocessor">#define FOREACH_CHILD(v) do { \</span>
<a name="l00716"></a>00716 <span class="preprocessor">    struct ChildRecord* v; \</span>
<a name="l00717"></a>00717 <span class="preprocessor">    for (v = ChildRecord; v &lt; ChildRecord + sizeof(ChildRecord) / sizeof(ChildRecord[0]); ++v)</span>
<a name="l00718"></a><a class="code" href="../../d5/df2/win32_8c.html#aa37aa8528ad37d56f1dcaa74c8ed5fee">00718</a> <span class="preprocessor"></span><span class="preprocessor">#define END_FOREACH_CHILD } while (0)</span>
<a name="l00719"></a>00719 <span class="preprocessor"></span>
<a name="l00720"></a>00720 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../df/dca/struct_child_record.html">ChildRecord</a> *
<a name="l00721"></a><a class="code" href="../../d5/df2/win32_8c.html#a9ec4e65a0248028da434bc880f20a628">00721</a> <a class="code" href="../../d5/df2/win32_8c.html#a9ec4e65a0248028da434bc880f20a628">FindChildSlot</a>(rb_pid_t <a class="code" href="../../df/dca/struct_child_record.html#a0102701165f7c23d4695251e9d3631fa">pid</a>)
<a name="l00722"></a>00722 {
<a name="l00723"></a>00723 
<a name="l00724"></a>00724     <a class="code" href="../../d5/df2/win32_8c.html#ae7244715d5ef9f0293bdab6b8c763f97">FOREACH_CHILD</a>(child) {
<a name="l00725"></a>00725         <span class="keywordflow">if</span> (child-&gt;pid == pid) {
<a name="l00726"></a>00726             <span class="keywordflow">return</span> child;
<a name="l00727"></a>00727         }
<a name="l00728"></a>00728     } <a class="code" href="../../d5/df2/win32_8c.html#aa37aa8528ad37d56f1dcaa74c8ed5fee">END_FOREACH_CHILD</a>;
<a name="l00729"></a>00729     <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00730"></a>00730 }
<a name="l00731"></a>00731 
<a name="l00732"></a>00732 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../df/dca/struct_child_record.html">ChildRecord</a> *
<a name="l00733"></a><a class="code" href="../../d5/df2/win32_8c.html#aa813e17c3b799ae52456ad29a7eeaa37">00733</a> <a class="code" href="../../d5/df2/win32_8c.html#aa813e17c3b799ae52456ad29a7eeaa37">FindChildSlotByHandle</a>(HANDLE h)
<a name="l00734"></a>00734 {
<a name="l00735"></a>00735 
<a name="l00736"></a>00736     <a class="code" href="../../d5/df2/win32_8c.html#ae7244715d5ef9f0293bdab6b8c763f97">FOREACH_CHILD</a>(child) {
<a name="l00737"></a>00737         <span class="keywordflow">if</span> (child-&gt;hProcess == h) {
<a name="l00738"></a>00738             <span class="keywordflow">return</span> child;
<a name="l00739"></a>00739         }
<a name="l00740"></a>00740     } <a class="code" href="../../d5/df2/win32_8c.html#aa37aa8528ad37d56f1dcaa74c8ed5fee">END_FOREACH_CHILD</a>;
<a name="l00741"></a>00741     <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00742"></a>00742 }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00745"></a><a class="code" href="../../d5/df2/win32_8c.html#a28431d738cb14b7d42618df366739f92">00745</a> <a class="code" href="../../d5/df2/win32_8c.html#a28431d738cb14b7d42618df366739f92">CloseChildHandle</a>(<span class="keyword">struct</span> <a class="code" href="../../df/dca/struct_child_record.html">ChildRecord</a> *child)
<a name="l00746"></a>00746 {
<a name="l00747"></a>00747     HANDLE h = child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a6f4d66712210547a5b5631a2c3da9836">hProcess</a>;
<a name="l00748"></a>00748     child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a6f4d66712210547a5b5631a2c3da9836">hProcess</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00749"></a>00749     child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a0102701165f7c23d4695251e9d3631fa">pid</a> = 0;
<a name="l00750"></a>00750     CloseHandle(h);
<a name="l00751"></a>00751 }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../df/dca/struct_child_record.html">ChildRecord</a> *
<a name="l00754"></a><a class="code" href="../../d5/df2/win32_8c.html#a9ccd634e1e5dd06d2e00ca84272ecfce">00754</a> <a class="code" href="../../d5/df2/win32_8c.html#a9ccd634e1e5dd06d2e00ca84272ecfce">FindFreeChildSlot</a>(<span class="keywordtype">void</span>)
<a name="l00755"></a>00755 {
<a name="l00756"></a>00756     <a class="code" href="../../d5/df2/win32_8c.html#ae7244715d5ef9f0293bdab6b8c763f97">FOREACH_CHILD</a>(child) {
<a name="l00757"></a>00757         <span class="keywordflow">if</span> (!child-&gt;pid) {
<a name="l00758"></a>00758             child-&gt;pid = -1;    <span class="comment">/* lock the slot */</span>
<a name="l00759"></a>00759             child-&gt;hProcess = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00760"></a>00760             <span class="keywordflow">return</span> child;
<a name="l00761"></a>00761         }
<a name="l00762"></a>00762     } <a class="code" href="../../d5/df2/win32_8c.html#aa37aa8528ad37d56f1dcaa74c8ed5fee">END_FOREACH_CHILD</a>;
<a name="l00763"></a>00763     <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00764"></a>00764 }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766 
<a name="l00767"></a>00767 <span class="comment">/*</span>
<a name="l00768"></a>00768 <span class="comment">  ruby -lne &apos;BEGIN{$cmds = Hash.new(0); $mask = 1}&apos;</span>
<a name="l00769"></a>00769 <span class="comment">   -e &apos;$cmds[$_.downcase] |= $mask&apos; -e &apos;$mask &lt;&lt;= 1 if ARGF.eof&apos;</span>
<a name="l00770"></a>00770 <span class="comment">   -e &apos;END{$cmds.sort.each{|n,f|puts &quot;    \&quot;\\#{f.to_s(8)}\&quot; #{n.dump} + 1,&quot;}}&apos;</span>
<a name="l00771"></a>00771 <span class="comment">   98cmd ntcmd</span>
<a name="l00772"></a>00772 <span class="comment"> */</span>
<a name="l00773"></a><a class="code" href="../../d5/df2/win32_8c.html#a185e905e3ff22254ff28eb66ba59b96d">00773</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> <a class="code" href="../../d5/df2/win32_8c.html#a185e905e3ff22254ff28eb66ba59b96d">szInternalCmds</a>[] = {
<a name="l00774"></a>00774     <span class="stringliteral">&quot;\2&quot;</span> <span class="stringliteral">&quot;assoc&quot;</span> + 1,
<a name="l00775"></a>00775     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;break&quot;</span> + 1,
<a name="l00776"></a>00776     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;call&quot;</span> + 1,
<a name="l00777"></a>00777     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;cd&quot;</span> + 1,
<a name="l00778"></a>00778     <span class="stringliteral">&quot;\1&quot;</span> <span class="stringliteral">&quot;chcp&quot;</span> + 1,
<a name="l00779"></a>00779     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;chdir&quot;</span> + 1,
<a name="l00780"></a>00780     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;cls&quot;</span> + 1,
<a name="l00781"></a>00781     <span class="stringliteral">&quot;\2&quot;</span> <span class="stringliteral">&quot;color&quot;</span> + 1,
<a name="l00782"></a>00782     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;copy&quot;</span> + 1,
<a name="l00783"></a>00783     <span class="stringliteral">&quot;\1&quot;</span> <span class="stringliteral">&quot;ctty&quot;</span> + 1,
<a name="l00784"></a>00784     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;date&quot;</span> + 1,
<a name="l00785"></a>00785     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;del&quot;</span> + 1,
<a name="l00786"></a>00786     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;dir&quot;</span> + 1,
<a name="l00787"></a>00787     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;echo&quot;</span> + 1,
<a name="l00788"></a>00788     <span class="stringliteral">&quot;\2&quot;</span> <span class="stringliteral">&quot;endlocal&quot;</span> + 1,
<a name="l00789"></a>00789     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;erase&quot;</span> + 1,
<a name="l00790"></a>00790     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;exit&quot;</span> + 1,
<a name="l00791"></a>00791     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;for&quot;</span> + 1,
<a name="l00792"></a>00792     <span class="stringliteral">&quot;\2&quot;</span> <span class="stringliteral">&quot;ftype&quot;</span> + 1,
<a name="l00793"></a>00793     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;goto&quot;</span> + 1,
<a name="l00794"></a>00794     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;if&quot;</span> + 1,
<a name="l00795"></a>00795     <span class="stringliteral">&quot;\1&quot;</span> <span class="stringliteral">&quot;lfnfor&quot;</span> + 1,
<a name="l00796"></a>00796     <span class="stringliteral">&quot;\1&quot;</span> <span class="stringliteral">&quot;lh&quot;</span> + 1,
<a name="l00797"></a>00797     <span class="stringliteral">&quot;\1&quot;</span> <span class="stringliteral">&quot;lock&quot;</span> + 1,
<a name="l00798"></a>00798     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;md&quot;</span> + 1,
<a name="l00799"></a>00799     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;mkdir&quot;</span> + 1,
<a name="l00800"></a>00800     <span class="stringliteral">&quot;\2&quot;</span> <span class="stringliteral">&quot;move&quot;</span> + 1,
<a name="l00801"></a>00801     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;path&quot;</span> + 1,
<a name="l00802"></a>00802     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;pause&quot;</span> + 1,
<a name="l00803"></a>00803     <span class="stringliteral">&quot;\2&quot;</span> <span class="stringliteral">&quot;popd&quot;</span> + 1,
<a name="l00804"></a>00804     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;prompt&quot;</span> + 1,
<a name="l00805"></a>00805     <span class="stringliteral">&quot;\2&quot;</span> <span class="stringliteral">&quot;pushd&quot;</span> + 1,
<a name="l00806"></a>00806     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;rd&quot;</span> + 1,
<a name="l00807"></a>00807     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;rem&quot;</span> + 1,
<a name="l00808"></a>00808     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;ren&quot;</span> + 1,
<a name="l00809"></a>00809     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;rename&quot;</span> + 1,
<a name="l00810"></a>00810     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;rmdir&quot;</span> + 1,
<a name="l00811"></a>00811     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;set&quot;</span> + 1,
<a name="l00812"></a>00812     <span class="stringliteral">&quot;\2&quot;</span> <span class="stringliteral">&quot;setlocal&quot;</span> + 1,
<a name="l00813"></a>00813     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;shift&quot;</span> + 1,
<a name="l00814"></a>00814     <span class="stringliteral">&quot;\2&quot;</span> <span class="stringliteral">&quot;start&quot;</span> + 1,
<a name="l00815"></a>00815     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;time&quot;</span> + 1,
<a name="l00816"></a>00816     <span class="stringliteral">&quot;\2&quot;</span> <span class="stringliteral">&quot;title&quot;</span> + 1,
<a name="l00817"></a>00817     <span class="stringliteral">&quot;\1&quot;</span> <span class="stringliteral">&quot;truename&quot;</span> + 1,
<a name="l00818"></a>00818     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;type&quot;</span> + 1,
<a name="l00819"></a>00819     <span class="stringliteral">&quot;\1&quot;</span> <span class="stringliteral">&quot;unlock&quot;</span> + 1,
<a name="l00820"></a>00820     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;ver&quot;</span> + 1,
<a name="l00821"></a>00821     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;verify&quot;</span> + 1,
<a name="l00822"></a>00822     <span class="stringliteral">&quot;\3&quot;</span> <span class="stringliteral">&quot;vol&quot;</span> + 1,
<a name="l00823"></a>00823 };
<a name="l00824"></a>00824 
<a name="l00825"></a>00825 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00826"></a><a class="code" href="../../d5/df2/win32_8c.html#af2688425e13f20cadfc5fa0db443c054">00826</a> <a class="code" href="../../d5/df2/win32_8c.html#af2688425e13f20cadfc5fa0db443c054">internal_match</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <span class="keyword">const</span> <span class="keywordtype">void</span> *elem)
<a name="l00827"></a>00827 {
<a name="l00828"></a>00828     <span class="keywordflow">return</span> strcmp(key, *(<span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> *)elem);
<a name="l00829"></a>00829 }
<a name="l00830"></a>00830 
<a name="l00831"></a>00831 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00832"></a><a class="code" href="../../d5/df2/win32_8c.html#a912202e60f4fb6c1a8422e3b0b9af151">00832</a> <a class="code" href="../../d5/df2/win32_8c.html#a912202e60f4fb6c1a8422e3b0b9af151">is_command_com</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *interp)
<a name="l00833"></a>00833 {
<a name="l00834"></a>00834     <span class="keywordtype">int</span> i = <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(interp) - 11;
<a name="l00835"></a>00835 
<a name="l00836"></a>00836     <span class="keywordflow">if</span> ((i == 0 || i &gt; 0 &amp;&amp; <a class="code" href="../../d1/ddc/dln_8c.html#ad1a5011ecfd52fc9c7a11d1f0fa43936">isdirsep</a>(interp[i-1])) &amp;&amp;
<a name="l00837"></a>00837         <a class="code" href="../../dc/db1/win32_8h.html#ac99ec3f1036620727a68aa8c25a8963c">strcasecmp</a>(interp+i, <span class="stringliteral">&quot;command.com&quot;</span>) == 0) {
<a name="l00838"></a>00838         <span class="keywordflow">return</span> 1;
<a name="l00839"></a>00839     }
<a name="l00840"></a>00840     <span class="keywordflow">return</span> 0;
<a name="l00841"></a>00841 }
<a name="l00842"></a>00842 
<a name="l00843"></a>00843 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/df2/win32_8c.html#a9506ef30cf1f1c885e7c4c3e089d4fe0">internal_cmd_match</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *cmdname, <span class="keywordtype">int</span> nt);
<a name="l00844"></a>00844 
<a name="l00845"></a>00845 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00846"></a><a class="code" href="../../d5/df2/win32_8c.html#a0fd284a7040995bd5eed6b33a0dc9291">00846</a> <a class="code" href="../../d5/df2/win32_8c.html#a0fd284a7040995bd5eed6b33a0dc9291">is_internal_cmd</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keywordtype">int</span> nt)
<a name="l00847"></a>00847 {
<a name="l00848"></a>00848     <span class="keywordtype">char</span> cmdname[9], *b = cmdname, c;
<a name="l00849"></a>00849 
<a name="l00850"></a>00850     <span class="keywordflow">do</span> {
<a name="l00851"></a>00851         <span class="keywordflow">if</span> (!(c = *cmd++)) <span class="keywordflow">return</span> 0;
<a name="l00852"></a>00852     } <span class="keywordflow">while</span> (isspace(c));
<a name="l00853"></a>00853     <span class="keywordflow">if</span> (c == <span class="charliteral">&apos;@&apos;</span>)
<a name="l00854"></a>00854         <span class="keywordflow">return</span> 1;
<a name="l00855"></a>00855     <span class="keywordflow">while</span> (isalpha(c)) {
<a name="l00856"></a>00856         *b++ = tolower(c);
<a name="l00857"></a>00857         <span class="keywordflow">if</span> (b == cmdname + <span class="keyword">sizeof</span>(cmdname)) <span class="keywordflow">return</span> 0;
<a name="l00858"></a>00858         c = *cmd++;
<a name="l00859"></a>00859     }
<a name="l00860"></a>00860     <span class="keywordflow">if</span> (c == <span class="charliteral">&apos;.&apos;</span>) c = *cmd;
<a name="l00861"></a>00861     <span class="keywordflow">switch</span> (c) {
<a name="l00862"></a>00862       <span class="keywordflow">case</span> <span class="charliteral">&apos;&lt;&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;&gt;&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;|&apos;</span>:
<a name="l00863"></a>00863         <span class="keywordflow">return</span> 1;
<a name="l00864"></a>00864       <span class="keywordflow">case</span> <span class="charliteral">&apos;\0&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos; &apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;\t&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;\n&apos;</span>:
<a name="l00865"></a>00865         <span class="keywordflow">break</span>;
<a name="l00866"></a>00866       <span class="keywordflow">default</span>:
<a name="l00867"></a>00867         <span class="keywordflow">return</span> 0;
<a name="l00868"></a>00868     }
<a name="l00869"></a>00869     *b = 0;
<a name="l00870"></a>00870     <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#a9506ef30cf1f1c885e7c4c3e089d4fe0">internal_cmd_match</a>(cmdname, nt);
<a name="l00871"></a>00871 }
<a name="l00872"></a>00872 
<a name="l00873"></a>00873 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00874"></a><a class="code" href="../../d5/df2/win32_8c.html#a9506ef30cf1f1c885e7c4c3e089d4fe0">00874</a> <a class="code" href="../../d5/df2/win32_8c.html#a9506ef30cf1f1c885e7c4c3e089d4fe0">internal_cmd_match</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *cmdname, <span class="keywordtype">int</span> nt)
<a name="l00875"></a>00875 {
<a name="l00876"></a>00876     <span class="keywordtype">char</span> **nm;
<a name="l00877"></a>00877 
<a name="l00878"></a>00878     nm = bsearch(cmdname, szInternalCmds,
<a name="l00879"></a>00879                  <span class="keyword">sizeof</span>(szInternalCmds) / <span class="keyword">sizeof</span>(*szInternalCmds),
<a name="l00880"></a>00880                  <span class="keyword">sizeof</span>(*szInternalCmds),
<a name="l00881"></a>00881                  <a class="code" href="../../d5/df2/win32_8c.html#af2688425e13f20cadfc5fa0db443c054">internal_match</a>);
<a name="l00882"></a>00882     <span class="keywordflow">if</span> (!nm || !(nm[0][-1] &amp; (nt ? 2 : 1)))
<a name="l00883"></a>00883         <span class="keywordflow">return</span> 0;
<a name="l00884"></a>00884     <span class="keywordflow">return</span> 1;
<a name="l00885"></a>00885 }
<a name="l00886"></a>00886 
<a name="l00887"></a>00887 SOCKET
<a name="l00888"></a><a class="code" href="../../d5/df2/win32_8c.html#a29dcc9f57aa233b7287b6506c8bcf2e5">00888</a> <a class="code" href="../../dc/db1/win32_8h.html#a1955cd10ac395eb8442b50577b1e968e">rb_w32_get_osfhandle</a>(<span class="keywordtype">int</span> fh)
<a name="l00889"></a>00889 {
<a name="l00890"></a>00890     <span class="keywordflow">return</span> _get_osfhandle(fh);
<a name="l00891"></a>00891 }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00894"></a><a class="code" href="../../d5/df2/win32_8c.html#afc137e4bd983d60ca711a8fe5dd27d80">00894</a> <a class="code" href="../../d5/df2/win32_8c.html#afc137e4bd983d60ca711a8fe5dd27d80">join_argv</a>(<span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *<span class="keyword">const</span> *argv, BOOL escape)
<a name="l00895"></a>00895 {
<a name="l00896"></a>00896     <span class="keyword">const</span> <span class="keywordtype">char</span> *p, *s;
<a name="l00897"></a>00897     <span class="keywordtype">char</span> *q, *<span class="keyword">const</span> *t;
<a name="l00898"></a>00898     <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, n, bs, quote;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900     <span class="keywordflow">for</span> (t = argv, q = cmd, len = 0; p = *t; t++) {
<a name="l00901"></a>00901         quote = 0;
<a name="l00902"></a>00902         s = p;
<a name="l00903"></a>00903         <span class="keywordflow">if</span> (!*p || strpbrk(p, <span class="stringliteral">&quot; \t\&quot;&apos;&quot;</span>)) {
<a name="l00904"></a>00904             quote = 1;
<a name="l00905"></a>00905             len++;
<a name="l00906"></a>00906             <span class="keywordflow">if</span> (q) *q++ = <span class="charliteral">&apos;&quot;&apos;</span>;
<a name="l00907"></a>00907         }
<a name="l00908"></a>00908         <span class="keywordflow">for</span> (bs = 0; *p; ++p) {
<a name="l00909"></a>00909             <span class="keywordflow">switch</span> (*p) {
<a name="l00910"></a>00910               <span class="keywordflow">case</span> <span class="charliteral">&apos;\\&apos;</span>:
<a name="l00911"></a>00911                 ++bs;
<a name="l00912"></a>00912                 <span class="keywordflow">break</span>;
<a name="l00913"></a>00913               <span class="keywordflow">case</span> <span class="charliteral">&apos;&quot;&apos;</span>:
<a name="l00914"></a>00914                 len += n = p - s;
<a name="l00915"></a>00915                 <span class="keywordflow">if</span> (q) {
<a name="l00916"></a>00916                     memcpy(q, s, n);
<a name="l00917"></a>00917                     q += n;
<a name="l00918"></a>00918                 }
<a name="l00919"></a>00919                 s = p;
<a name="l00920"></a>00920                 len += ++bs;
<a name="l00921"></a>00921                 <span class="keywordflow">if</span> (q) {
<a name="l00922"></a>00922                     memset(q, <span class="charliteral">&apos;\\&apos;</span>, bs);
<a name="l00923"></a>00923                     q += bs;
<a name="l00924"></a>00924                 }
<a name="l00925"></a>00925                 bs = 0;
<a name="l00926"></a>00926                 <span class="keywordflow">break</span>;
<a name="l00927"></a>00927               <span class="keywordflow">case</span> <span class="charliteral">&apos;&lt;&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;&gt;&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;|&apos;</span>: <span class="keywordflow">case</span> <span class="charliteral">&apos;^&apos;</span>:
<a name="l00928"></a>00928                 <span class="keywordflow">if</span> (escape &amp;&amp; !quote) {
<a name="l00929"></a>00929                     len += (n = p - s) + 1;
<a name="l00930"></a>00930                     <span class="keywordflow">if</span> (q) {
<a name="l00931"></a>00931                         memcpy(q, s, n);
<a name="l00932"></a>00932                         q += n;
<a name="l00933"></a>00933                         *q++ = <span class="charliteral">&apos;^&apos;</span>;
<a name="l00934"></a>00934                     }
<a name="l00935"></a>00935                     s = p;
<a name="l00936"></a>00936                     <span class="keywordflow">break</span>;
<a name="l00937"></a>00937                 }
<a name="l00938"></a>00938               <span class="keywordflow">default</span>:
<a name="l00939"></a>00939                 bs = 0;
<a name="l00940"></a>00940                 p = <a class="code" href="../../dd/dd0/eval__intern_8h.html#a0892c4ab83ee67ec75cad2debdb5ddbb">CharNext</a>(p) - 1;
<a name="l00941"></a>00941                 <span class="keywordflow">break</span>;
<a name="l00942"></a>00942             }
<a name="l00943"></a>00943         }
<a name="l00944"></a>00944         len += (n = p - s) + 1;
<a name="l00945"></a>00945         <span class="keywordflow">if</span> (quote) len++;
<a name="l00946"></a>00946         <span class="keywordflow">if</span> (q) {
<a name="l00947"></a>00947             memcpy(q, s, n);
<a name="l00948"></a>00948             q += n;
<a name="l00949"></a>00949             <span class="keywordflow">if</span> (quote) *q++ = <span class="charliteral">&apos;&quot;&apos;</span>;
<a name="l00950"></a>00950             *q++ = <span class="charliteral">&apos; &apos;</span>;
<a name="l00951"></a>00951         }
<a name="l00952"></a>00952     }
<a name="l00953"></a>00953     <span class="keywordflow">if</span> (q &gt; cmd) --len;
<a name="l00954"></a>00954     <span class="keywordflow">if</span> (q) {
<a name="l00955"></a>00955         <span class="keywordflow">if</span> (q &gt; cmd) --q;
<a name="l00956"></a>00956         *q = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00957"></a>00957     }
<a name="l00958"></a>00958     <span class="keywordflow">return</span> len;
<a name="l00959"></a>00959 }
<a name="l00960"></a>00960 
<a name="l00961"></a>00961 <span class="preprocessor">#ifdef HAVE_SYS_PARAM_H</span>
<a name="l00962"></a>00962 <span class="preprocessor"></span><span class="preprocessor"># include &lt;sys/param.h&gt;</span>
<a name="l00963"></a>00963 <span class="preprocessor">#else</span>
<a name="l00964"></a><a class="code" href="../../d5/df2/win32_8c.html#addfa831c1473e710d2b71b72fd7fcfa5">00964</a> <span class="preprocessor"></span><span class="preprocessor"># define MAXPATHLEN 512</span>
<a name="l00965"></a>00965 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00966"></a>00966 <span class="preprocessor"></span>
<a name="l00967"></a><a class="code" href="../../d5/df2/win32_8c.html#af5ece14f6cf7973ea1f950bac1fe7c2a">00967</a> <span class="preprocessor">#define STRNDUPV(ptr, v, src, len)                                      \</span>
<a name="l00968"></a>00968 <span class="preprocessor">    (((char *)memcpy(((ptr) = ALLOCV((v), (len) + 1)), (src), (len)))[len] = 0)</span>
<a name="l00969"></a>00969 <span class="preprocessor"></span>
<a name="l00970"></a>00970 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00971"></a><a class="code" href="../../d5/df2/win32_8c.html#a0bc64bf7365420f3dcf54c38c272363b">00971</a> <a class="code" href="../../d5/df2/win32_8c.html#a0bc64bf7365420f3dcf54c38c272363b">check_spawn_mode</a>(<span class="keywordtype">int</span> mode)
<a name="l00972"></a>00972 {
<a name="l00973"></a>00973     <span class="keywordflow">switch</span> (mode) {
<a name="l00974"></a>00974       <span class="keywordflow">case</span> <a class="code" href="../../d0/d85/process_8c.html#adbf992dd8dead36444b76290025d0ac9">P_NOWAIT</a>:
<a name="l00975"></a>00975       <span class="keywordflow">case</span> P_OVERLAY:
<a name="l00976"></a>00976         <span class="keywordflow">return</span> 0;
<a name="l00977"></a>00977       <span class="keywordflow">default</span>:
<a name="l00978"></a>00978         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l00979"></a>00979         <span class="keywordflow">return</span> -1;
<a name="l00980"></a>00980     }
<a name="l00981"></a>00981 }
<a name="l00982"></a>00982 
<a name="l00983"></a>00983 <span class="keyword">static</span> rb_pid_t
<a name="l00984"></a><a class="code" href="../../d5/df2/win32_8c.html#a385dcd9d25a2fc5d1225697aee45f1b3">00984</a> <a class="code" href="../../d5/df2/win32_8c.html#a385dcd9d25a2fc5d1225697aee45f1b3">child_result</a>(<span class="keyword">struct</span> <a class="code" href="../../df/dca/struct_child_record.html">ChildRecord</a> *child, <span class="keywordtype">int</span> mode)
<a name="l00985"></a>00985 {
<a name="l00986"></a>00986     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> exitcode;
<a name="l00987"></a>00987 
<a name="l00988"></a>00988     <span class="keywordflow">if</span> (!child) {
<a name="l00989"></a>00989         <span class="keywordflow">return</span> -1;
<a name="l00990"></a>00990     }
<a name="l00991"></a>00991 
<a name="l00992"></a>00992     <span class="keywordflow">switch</span> (mode) {
<a name="l00993"></a>00993       <span class="keywordflow">case</span> <a class="code" href="../../d0/d85/process_8c.html#adbf992dd8dead36444b76290025d0ac9">P_NOWAIT</a>:
<a name="l00994"></a>00994         <span class="keywordflow">return</span> child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a0102701165f7c23d4695251e9d3631fa">pid</a>;
<a name="l00995"></a>00995       <span class="keywordflow">case</span> P_OVERLAY:
<a name="l00996"></a>00996         WaitForSingleObject(child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a6f4d66712210547a5b5631a2c3da9836">hProcess</a>, INFINITE);
<a name="l00997"></a>00997         GetExitCodeProcess(child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a6f4d66712210547a5b5631a2c3da9836">hProcess</a>, &amp;exitcode);
<a name="l00998"></a>00998         <a class="code" href="../../d5/df2/win32_8c.html#a28431d738cb14b7d42618df366739f92">CloseChildHandle</a>(child);
<a name="l00999"></a>00999         _exit(exitcode);
<a name="l01000"></a>01000       <span class="keywordflow">default</span>:
<a name="l01001"></a>01001         <span class="keywordflow">return</span> -1;      <span class="comment">/* not reached */</span>
<a name="l01002"></a>01002     }
<a name="l01003"></a>01003 }
<a name="l01004"></a>01004 
<a name="l01005"></a>01005 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../df/dca/struct_child_record.html">ChildRecord</a> *
<a name="l01006"></a><a class="code" href="../../d5/df2/win32_8c.html#aff4f0f208c5db35376e6c5d76a151801">01006</a> <a class="code" href="../../d5/df2/win32_8c.html#aff4f0f208c5db35376e6c5d76a151801">CreateChild</a>(<span class="keyword">const</span> WCHAR *cmd, <span class="keyword">const</span> WCHAR *prog, SECURITY_ATTRIBUTES *psa,
<a name="l01007"></a>01007             HANDLE hInput, HANDLE hOutput, HANDLE hError, <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> dwCreationFlags)
<a name="l01008"></a>01008 {
<a name="l01009"></a>01009     BOOL fRet;
<a name="l01010"></a>01010     STARTUPINFOW aStartupInfo;
<a name="l01011"></a>01011     PROCESS_INFORMATION aProcessInformation;
<a name="l01012"></a>01012     SECURITY_ATTRIBUTES sa;
<a name="l01013"></a>01013     <span class="keyword">struct </span><a class="code" href="../../df/dca/struct_child_record.html">ChildRecord</a> *child;
<a name="l01014"></a>01014 
<a name="l01015"></a>01015     <span class="keywordflow">if</span> (!cmd &amp;&amp; !prog) {
<a name="l01016"></a>01016         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EFAULT;
<a name="l01017"></a>01017         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01018"></a>01018     }
<a name="l01019"></a>01019 
<a name="l01020"></a>01020     child = <a class="code" href="../../d5/df2/win32_8c.html#a9ccd634e1e5dd06d2e00ca84272ecfce">FindFreeChildSlot</a>();
<a name="l01021"></a>01021     <span class="keywordflow">if</span> (!child) {
<a name="l01022"></a>01022         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EAGAIN;
<a name="l01023"></a>01023         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01024"></a>01024     }
<a name="l01025"></a>01025 
<a name="l01026"></a>01026     <span class="keywordflow">if</span> (!psa) {
<a name="l01027"></a>01027         sa.nLength              = <span class="keyword">sizeof</span> (SECURITY_ATTRIBUTES);
<a name="l01028"></a>01028         sa.lpSecurityDescriptor = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01029"></a>01029         sa.bInheritHandle       = <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01030"></a>01030         psa = &amp;sa;
<a name="l01031"></a>01031     }
<a name="l01032"></a>01032 
<a name="l01033"></a>01033     memset(&amp;aStartupInfo, 0, <span class="keyword">sizeof</span>(aStartupInfo));
<a name="l01034"></a>01034     memset(&amp;aProcessInformation, 0, <span class="keyword">sizeof</span>(aProcessInformation));
<a name="l01035"></a>01035     aStartupInfo.cb = <span class="keyword">sizeof</span>(aStartupInfo);
<a name="l01036"></a>01036     aStartupInfo.dwFlags = STARTF_USESTDHANDLES;
<a name="l01037"></a>01037     <span class="keywordflow">if</span> (hInput) {
<a name="l01038"></a>01038         aStartupInfo.hStdInput  = hInput;
<a name="l01039"></a>01039     }
<a name="l01040"></a>01040     <span class="keywordflow">else</span> {
<a name="l01041"></a>01041         aStartupInfo.hStdInput  = GetStdHandle(STD_INPUT_HANDLE);
<a name="l01042"></a>01042     }
<a name="l01043"></a>01043     <span class="keywordflow">if</span> (hOutput) {
<a name="l01044"></a>01044         aStartupInfo.hStdOutput = hOutput;
<a name="l01045"></a>01045     }
<a name="l01046"></a>01046     <span class="keywordflow">else</span> {
<a name="l01047"></a>01047         aStartupInfo.hStdOutput = GetStdHandle(STD_OUTPUT_HANDLE);
<a name="l01048"></a>01048     }
<a name="l01049"></a>01049     <span class="keywordflow">if</span> (hError) {
<a name="l01050"></a>01050         aStartupInfo.hStdError = hError;
<a name="l01051"></a>01051     }
<a name="l01052"></a>01052     <span class="keywordflow">else</span> {
<a name="l01053"></a>01053         aStartupInfo.hStdError = GetStdHandle(STD_ERROR_HANDLE);
<a name="l01054"></a>01054     }
<a name="l01055"></a>01055 
<a name="l01056"></a>01056     dwCreationFlags |= NORMAL_PRIORITY_CLASS;
<a name="l01057"></a>01057 
<a name="l01058"></a>01058     <span class="keywordflow">if</span> (lstrlenW(cmd) &gt; 32767) {
<a name="l01059"></a>01059         child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a0102701165f7c23d4695251e9d3631fa">pid</a> = 0;         <span class="comment">/* release the slot */</span>
<a name="l01060"></a>01060         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = E2BIG;
<a name="l01061"></a>01061         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01062"></a>01062     }
<a name="l01063"></a>01063 
<a name="l01064"></a>01064     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l01065"></a>01065         fRet = CreateProcessW(prog, (WCHAR *)cmd, psa, psa,
<a name="l01066"></a>01066                               psa-&gt;bInheritHandle, dwCreationFlags, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>,
<a name="l01067"></a>01067                               &amp;aStartupInfo, &amp;aProcessInformation);
<a name="l01068"></a>01068         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l01069"></a>01069     });
<a name="l01070"></a>01070 
<a name="l01071"></a>01071     <span class="keywordflow">if</span> (!fRet) {
<a name="l01072"></a>01072         child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a0102701165f7c23d4695251e9d3631fa">pid</a> = 0;         <span class="comment">/* release the slot */</span>
<a name="l01073"></a>01073         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01074"></a>01074     }
<a name="l01075"></a>01075 
<a name="l01076"></a>01076     CloseHandle(aProcessInformation.hThread);
<a name="l01077"></a>01077 
<a name="l01078"></a>01078     child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a6f4d66712210547a5b5631a2c3da9836">hProcess</a> = aProcessInformation.hProcess;
<a name="l01079"></a>01079     child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a0102701165f7c23d4695251e9d3631fa">pid</a> = (rb_pid_t)aProcessInformation.dwProcessId;
<a name="l01080"></a>01080 
<a name="l01081"></a>01081     <a class="code" href="../../d7/dc0/parse_8y.html#a2ac1143ac343c79cbfa448e30d74fa1c">if</a> (!<a class="code" href="../../d5/df2/win32_8c.html#aaa9c3231dcc73fc8381f671b588fb13a">IsWinNT</a>()) {
<a name="l01082"></a>01082         <span class="comment">/* On Win9x, make pid positive similarly to cygwin and perl */</span>
<a name="l01083"></a>01083         child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a0102701165f7c23d4695251e9d3631fa">pid</a> = -child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a0102701165f7c23d4695251e9d3631fa">pid</a>;
<a name="l01084"></a>01084     }
<a name="l01085"></a>01085 
<a name="l01086"></a>01086     <span class="keywordflow">return</span> child;
<a name="l01087"></a>01087 }
<a name="l01088"></a>01088 
<a name="l01089"></a>01089 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01090"></a><a class="code" href="../../d5/df2/win32_8c.html#a7e1f44758a0c2b0db118e0a169b34f8b">01090</a> <a class="code" href="../../d5/df2/win32_8c.html#a7e1f44758a0c2b0db118e0a169b34f8b">is_batch</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *cmd)
<a name="l01091"></a>01091 {
<a name="l01092"></a>01092     <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(cmd);
<a name="l01093"></a>01093     <span class="keywordflow">if</span> (len &lt;= 4) <span class="keywordflow">return</span> 0;
<a name="l01094"></a>01094     cmd += len - 4;
<a name="l01095"></a>01095     <span class="keywordflow">if</span> (*cmd++ != <span class="charliteral">&apos;.&apos;</span>) <span class="keywordflow">return</span> 0;
<a name="l01096"></a>01096     <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#ac99ec3f1036620727a68aa8c25a8963c">strcasecmp</a>(cmd, <span class="stringliteral">&quot;bat&quot;</span>) == 0) <span class="keywordflow">return</span> 1;
<a name="l01097"></a>01097     <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#ac99ec3f1036620727a68aa8c25a8963c">strcasecmp</a>(cmd, <span class="stringliteral">&quot;cmd&quot;</span>) == 0) <span class="keywordflow">return</span> 1;
<a name="l01098"></a>01098     <span class="keywordflow">return</span> 0;
<a name="l01099"></a>01099 }
<a name="l01100"></a>01100 
<a name="l01101"></a>01101 <span class="keyword">static</span> UINT <a class="code" href="../../d5/df2/win32_8c.html#a2bd9363d2fc1e7ea0c1efdaa51cee2ce">filecp</a>(<span class="keywordtype">void</span>);
<a name="l01102"></a>01102 <span class="keyword">static</span> WCHAR *<a class="code" href="../../d5/df2/win32_8c.html#a9a69d9d479103ada5b1083da796eb1d1">mbstr_to_wstr</a>(UINT, <span class="keyword">const</span> <span class="keywordtype">char</span> *, <span class="keywordtype">int</span>, <span class="keywordtype">long</span> *);
<a name="l01103"></a>01103 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="../../d5/df2/win32_8c.html#a954a9f23b00ab03c6d64626592743fe1">wstr_to_mbstr</a>(UINT, <span class="keyword">const</span> WCHAR *, <span class="keywordtype">int</span>, <span class="keywordtype">long</span> *);
<a name="l01104"></a><a class="code" href="../../d5/df2/win32_8c.html#a78aebdf486fd66af6d3cce1bc37016b7">01104</a> <span class="preprocessor">#define acp_to_wstr(str, plen) mbstr_to_wstr(CP_ACP, str, -1, plen)</span>
<a name="l01105"></a><a class="code" href="../../d5/df2/win32_8c.html#aa66011d936ab2a588f4bb527da52ca64">01105</a> <span class="preprocessor"></span><span class="preprocessor">#define wstr_to_acp(str, plen) wstr_to_mbstr(CP_ACP, str, -1, plen)</span>
<a name="l01106"></a><a class="code" href="../../d5/df2/win32_8c.html#ad33d311f649154599e920240e3900a59">01106</a> <span class="preprocessor"></span><span class="preprocessor">#define filecp_to_wstr(str, plen) mbstr_to_wstr(filecp(), str, -1, plen)</span>
<a name="l01107"></a><a class="code" href="../../d5/df2/win32_8c.html#abee1c044ffcd4af5eb42fcdc58091e53">01107</a> <span class="preprocessor"></span><span class="preprocessor">#define wstr_to_filecp(str, plen) wstr_to_mbstr(filecp(), str, -1, plen)</span>
<a name="l01108"></a><a class="code" href="../../d5/df2/win32_8c.html#a41003a1382888cc771e290746769eb13">01108</a> <span class="preprocessor"></span><span class="preprocessor">#define utf8_to_wstr(str, plen) mbstr_to_wstr(CP_UTF8, str, -1, plen)</span>
<a name="l01109"></a><a class="code" href="../../d5/df2/win32_8c.html#a868edb6acaedb7965634f88e11a6f23d">01109</a> <span class="preprocessor"></span><span class="preprocessor">#define wstr_to_utf8(str, plen) wstr_to_mbstr(CP_UTF8, str, -1, plen)</span>
<a name="l01110"></a>01110 <span class="preprocessor"></span>
<a name="l01111"></a>01111 rb_pid_t
<a name="l01112"></a><a class="code" href="../../d5/df2/win32_8c.html#ab2279f2011fc528935f456e7f0ff2830">01112</a> <a class="code" href="../../dc/db1/win32_8h.html#ae94bfda820ed3539b29e9fdba5babdb7">rb_w32_spawn</a>(<span class="keywordtype">int</span> mode, <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keyword">const</span> <span class="keywordtype">char</span> *prog)
<a name="l01113"></a>01113 {
<a name="l01114"></a>01114     <span class="keywordtype">char</span> <a class="code" href="../../d7/d1e/dln__find_8c.html#ac5db579e4fad392fab4cc5f012c79f5f">fbuf</a>[<a class="code" href="../../d1/ddc/dln_8c.html#addfa831c1473e710d2b71b72fd7fcfa5">MAXPATHLEN</a>];
<a name="l01115"></a>01115     <span class="keywordtype">char</span> *p = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01116"></a>01116     <span class="keyword">const</span> <span class="keywordtype">char</span> *shell = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01117"></a>01117     WCHAR *wcmd, *wshell;
<a name="l01118"></a>01118     rb_pid_t ret;
<a name="l01119"></a>01119     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v = 0;
<a name="l01120"></a>01120     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v2 = 0;
<a name="l01121"></a>01121 
<a name="l01122"></a>01122     <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a0bc64bf7365420f3dcf54c38c272363b">check_spawn_mode</a>(mode)) <span class="keywordflow">return</span> -1;
<a name="l01123"></a>01123 
<a name="l01124"></a>01124     <span class="keywordflow">if</span> (prog) {
<a name="l01125"></a>01125         <span class="keywordflow">if</span> (!(p = <a class="code" href="../../df/da8/dln_8h.html#a61cc6b2d75908f5dfde8e260f5cc3e8e">dln_find_exe_r</a>(prog, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, fbuf, <span class="keyword">sizeof</span>(fbuf)))) {
<a name="l01126"></a>01126             shell = prog;
<a name="l01127"></a>01127         }
<a name="l01128"></a>01128         <span class="keywordflow">else</span> {
<a name="l01129"></a>01129             shell = p;
<a name="l01130"></a>01130             <a class="code" href="../../d5/df2/win32_8c.html#a4f27c8c10e28d59b4c43bacbcd2fa76c">translate_char</a>(p, <span class="charliteral">&apos;/&apos;</span>, <span class="charliteral">&apos;\\&apos;</span>);
<a name="l01131"></a>01131         }
<a name="l01132"></a>01132     }
<a name="l01133"></a>01133     <span class="keywordflow">else</span> {
<a name="l01134"></a>01134         <span class="keywordtype">int</span> redir = -1;
<a name="l01135"></a>01135         <span class="keywordtype">int</span> nt;
<a name="l01136"></a>01136         <span class="keywordflow">while</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae8cdc17e44905c826bddf416b7bf621c">ISSPACE</a>(*cmd)) cmd++;
<a name="l01137"></a>01137         <span class="keywordflow">if</span> ((shell = <a class="code" href="../../de/d32/dir_8c.html#aee28fd8a0e40b6d958f7d20348e45368">getenv</a>(<span class="stringliteral">&quot;RUBYSHELL&quot;</span>)) &amp;&amp; (redir = <a class="code" href="../../d5/df2/win32_8c.html#a6dde4e745374faf9c51029d31f97b9b0">has_redirection</a>(cmd))) {
<a name="l01138"></a>01138             <span class="keywordtype">char</span> *tmp = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7e07f4f937d300a4f0509b0c26526716">ALLOCV</a>(v, <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(shell) + <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(cmd) + <span class="keyword">sizeof</span>(<span class="stringliteral">&quot; -c &quot;</span>) + 2);
<a name="l01139"></a>01139             sprintf(tmp, <span class="stringliteral">&quot;%s -c \&quot;%s\&quot;&quot;</span>, shell, cmd);
<a name="l01140"></a>01140             cmd = tmp;
<a name="l01141"></a>01141         }
<a name="l01142"></a>01142         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((shell = <a class="code" href="../../de/d32/dir_8c.html#aee28fd8a0e40b6d958f7d20348e45368">getenv</a>(<span class="stringliteral">&quot;COMSPEC&quot;</span>)) &amp;&amp;
<a name="l01143"></a>01143                  (nt = !<a class="code" href="../../d5/df2/win32_8c.html#a912202e60f4fb6c1a8422e3b0b9af151">is_command_com</a>(shell),
<a name="l01144"></a>01144                   (redir &lt; 0 ? <a class="code" href="../../d5/df2/win32_8c.html#a6dde4e745374faf9c51029d31f97b9b0">has_redirection</a>(cmd) : redir) ||
<a name="l01145"></a>01145                   <a class="code" href="../../d5/df2/win32_8c.html#a0fd284a7040995bd5eed6b33a0dc9291">is_internal_cmd</a>(cmd, nt))) {
<a name="l01146"></a>01146             <span class="keywordtype">char</span> *tmp = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7e07f4f937d300a4f0509b0c26526716">ALLOCV</a>(v, <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(shell) + <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(cmd) + <span class="keyword">sizeof</span>(<span class="stringliteral">&quot; /c &quot;</span>) + (nt ? 2 : 0));
<a name="l01147"></a>01147             sprintf(tmp, nt ? <span class="stringliteral">&quot;%s /c \&quot;%s\&quot;&quot;</span> : <span class="stringliteral">&quot;%s /c %s&quot;</span>, shell, cmd);
<a name="l01148"></a>01148             cmd = tmp;
<a name="l01149"></a>01149         }
<a name="l01150"></a>01150         <span class="keywordflow">else</span> {
<a name="l01151"></a>01151             <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = 0, quote = (*cmd == <span class="charliteral">&apos;&quot;&apos;</span>) ? <span class="charliteral">&apos;&quot;&apos;</span> : (*cmd == <span class="charliteral">&apos;\&apos;&apos;</span>) ? <span class="charliteral">&apos;\&apos;&apos;</span> : 0;
<a name="l01152"></a>01152             <span class="keywordflow">for</span> (prog = cmd + !!quote;; prog = <a class="code" href="../../dd/dd0/eval__intern_8h.html#a0892c4ab83ee67ec75cad2debdb5ddbb">CharNext</a>(prog)) {
<a name="l01153"></a>01153                 <span class="keywordflow">if</span> (!*prog) {
<a name="l01154"></a>01154                     len = prog - cmd;
<a name="l01155"></a>01155                     shell = cmd;
<a name="l01156"></a>01156                     <span class="keywordflow">break</span>;
<a name="l01157"></a>01157                 }
<a name="l01158"></a>01158                 <span class="keywordflow">if</span> ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)*prog == quote) {
<a name="l01159"></a>01159                     len = prog++ - cmd - 1;
<a name="l01160"></a>01160                     <a class="code" href="../../d5/df2/win32_8c.html#af5ece14f6cf7973ea1f950bac1fe7c2a">STRNDUPV</a>(p, v2, cmd + 1, len);
<a name="l01161"></a>01161                     shell = p;
<a name="l01162"></a>01162                     <span class="keywordflow">break</span>;
<a name="l01163"></a>01163                 }
<a name="l01164"></a>01164                 <span class="keywordflow">if</span> (quote) <span class="keywordflow">continue</span>;
<a name="l01165"></a>01165                 <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae8cdc17e44905c826bddf416b7bf621c">ISSPACE</a>(*prog) || <a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(<span class="stringliteral">&quot;&lt;&gt;|*?\&quot;&quot;</span>, *prog)) {
<a name="l01166"></a>01166                     len = prog - cmd;
<a name="l01167"></a>01167                     <a class="code" href="../../d5/df2/win32_8c.html#af5ece14f6cf7973ea1f950bac1fe7c2a">STRNDUPV</a>(p, v2, cmd, len);
<a name="l01168"></a>01168                     shell = p;
<a name="l01169"></a>01169                     <span class="keywordflow">break</span>;
<a name="l01170"></a>01170                 }
<a name="l01171"></a>01171             }
<a name="l01172"></a>01172             shell = <a class="code" href="../../df/da8/dln_8h.html#a61cc6b2d75908f5dfde8e260f5cc3e8e">dln_find_exe_r</a>(shell, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, fbuf, <span class="keyword">sizeof</span>(fbuf));
<a name="l01173"></a>01173             <span class="keywordflow">if</span> (!shell) {
<a name="l01174"></a>01174                 shell = p ? p : cmd;
<a name="l01175"></a>01175             }
<a name="l01176"></a>01176             <span class="keywordflow">else</span> {
<a name="l01177"></a>01177                 len = <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(shell);
<a name="l01178"></a>01178                 <span class="keywordflow">if</span> (<a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(shell, <span class="charliteral">&apos; &apos;</span>)) quote = -1;
<a name="l01179"></a>01179                 <span class="keywordflow">if</span> (shell == fbuf) {
<a name="l01180"></a>01180                     p = fbuf;
<a name="l01181"></a>01181                 }
<a name="l01182"></a>01182                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (shell != p &amp;&amp; <a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(shell, <span class="charliteral">&apos;/&apos;</span>)) {
<a name="l01183"></a>01183                     <a class="code" href="../../d5/df2/win32_8c.html#af5ece14f6cf7973ea1f950bac1fe7c2a">STRNDUPV</a>(p, v2, shell, len);
<a name="l01184"></a>01184                     shell = p;
<a name="l01185"></a>01185                 }
<a name="l01186"></a>01186                 <span class="keywordflow">if</span> (p) <a class="code" href="../../d5/df2/win32_8c.html#a4f27c8c10e28d59b4c43bacbcd2fa76c">translate_char</a>(p, <span class="charliteral">&apos;/&apos;</span>, <span class="charliteral">&apos;\\&apos;</span>);
<a name="l01187"></a>01187                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a7e1f44758a0c2b0db118e0a169b34f8b">is_batch</a>(shell)) {
<a name="l01188"></a>01188                     <span class="keywordtype">int</span> alen = <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(prog);
<a name="l01189"></a>01189                     cmd = p = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7e07f4f937d300a4f0509b0c26526716">ALLOCV</a>(v, len + alen + (quote ? 2 : 0) + 1);
<a name="l01190"></a>01190                     <span class="keywordflow">if</span> (quote) *p++ = <span class="charliteral">&apos;&quot;&apos;</span>;
<a name="l01191"></a>01191                     memcpy(p, shell, len);
<a name="l01192"></a>01192                     p += len;
<a name="l01193"></a>01193                     <span class="keywordflow">if</span> (quote) *p++ = <span class="charliteral">&apos;&quot;&apos;</span>;
<a name="l01194"></a>01194                     memcpy(p, prog, alen + 1);
<a name="l01195"></a>01195                     shell = 0;
<a name="l01196"></a>01196                 }
<a name="l01197"></a>01197             }
<a name="l01198"></a>01198         }
<a name="l01199"></a>01199     }
<a name="l01200"></a>01200 
<a name="l01201"></a>01201     <span class="comment">/* assume ACP */</span>
<a name="l01202"></a>01202     wcmd = cmd ? <a class="code" href="../../d5/df2/win32_8c.html#a78aebdf486fd66af6d3cce1bc37016b7">acp_to_wstr</a>(cmd, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) : <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01203"></a>01203     <span class="keywordflow">if</span> (v) <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a13424d6f6efe4c7cf2f032744a04e51c">ALLOCV_END</a>(v);
<a name="l01204"></a>01204     wshell = shell ? <a class="code" href="../../d5/df2/win32_8c.html#a78aebdf486fd66af6d3cce1bc37016b7">acp_to_wstr</a>(shell, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) : <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01205"></a>01205     <span class="keywordflow">if</span> (v2) <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a13424d6f6efe4c7cf2f032744a04e51c">ALLOCV_END</a>(v2);
<a name="l01206"></a>01206 
<a name="l01207"></a>01207     ret = <a class="code" href="../../d5/df2/win32_8c.html#a385dcd9d25a2fc5d1225697aee45f1b3">child_result</a>(<a class="code" href="../../d5/df2/win32_8c.html#aff4f0f208c5db35376e6c5d76a151801">CreateChild</a>(wcmd, wshell, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0), mode);
<a name="l01208"></a>01208     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wshell);
<a name="l01209"></a>01209     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wcmd);
<a name="l01210"></a>01210     <span class="keywordflow">return</span> ret;
<a name="l01211"></a>01211 }
<a name="l01212"></a>01212 
<a name="l01213"></a>01213 rb_pid_t
<a name="l01214"></a><a class="code" href="../../d5/df2/win32_8c.html#a3094e6ea536edc64967428e2901365cd">01214</a> <a class="code" href="../../dc/db1/win32_8h.html#a5431e54710874f971979ccb3b2728556">rb_w32_aspawn_flags</a>(<span class="keywordtype">int</span> mode, <span class="keyword">const</span> <span class="keywordtype">char</span> *prog, <span class="keywordtype">char</span> *<span class="keyword">const</span> *argv, <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> flags)
<a name="l01215"></a>01215 {
<a name="l01216"></a>01216     <span class="keywordtype">int</span> c_switch = 0;
<a name="l01217"></a>01217     <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l01218"></a>01218     BOOL ntcmd = <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, tmpnt;
<a name="l01219"></a>01219     <span class="keyword">const</span> <span class="keywordtype">char</span> *shell;
<a name="l01220"></a>01220     <span class="keywordtype">char</span> *cmd, <a class="code" href="../../d7/d1e/dln__find_8c.html#ac5db579e4fad392fab4cc5f012c79f5f">fbuf</a>[<a class="code" href="../../d1/ddc/dln_8c.html#addfa831c1473e710d2b71b72fd7fcfa5">MAXPATHLEN</a>];
<a name="l01221"></a>01221     WCHAR *wcmd, *wprog;
<a name="l01222"></a>01222     rb_pid_t ret;
<a name="l01223"></a>01223     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v = 0;
<a name="l01224"></a>01224 
<a name="l01225"></a>01225     <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a0bc64bf7365420f3dcf54c38c272363b">check_spawn_mode</a>(mode)) <span class="keywordflow">return</span> -1;
<a name="l01226"></a>01226 
<a name="l01227"></a>01227     <span class="keywordflow">if</span> (!prog) prog = argv[0];
<a name="l01228"></a>01228     <span class="keywordflow">if</span> ((shell = <a class="code" href="../../de/d32/dir_8c.html#aee28fd8a0e40b6d958f7d20348e45368">getenv</a>(<span class="stringliteral">&quot;COMSPEC&quot;</span>)) &amp;&amp;
<a name="l01229"></a>01229         <a class="code" href="../../d5/df2/win32_8c.html#a9506ef30cf1f1c885e7c4c3e089d4fe0">internal_cmd_match</a>(prog, tmpnt = !<a class="code" href="../../d5/df2/win32_8c.html#a912202e60f4fb6c1a8422e3b0b9af151">is_command_com</a>(shell))) {
<a name="l01230"></a>01230         ntcmd = tmpnt;
<a name="l01231"></a>01231         prog = shell;
<a name="l01232"></a>01232         c_switch = 1;
<a name="l01233"></a>01233     }
<a name="l01234"></a>01234     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((cmd = <a class="code" href="../../df/da8/dln_8h.html#a61cc6b2d75908f5dfde8e260f5cc3e8e">dln_find_exe_r</a>(prog, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, fbuf, <span class="keyword">sizeof</span>(fbuf)))) {
<a name="l01235"></a>01235         <span class="keywordflow">if</span> (cmd == prog) <a class="code" href="../../d3/d90/missing_8h.html#ae18161b919a8cf237d27f8aac700d80c">strlcpy</a>(cmd = fbuf, prog, <span class="keyword">sizeof</span>(fbuf));
<a name="l01236"></a>01236         <a class="code" href="../../d5/df2/win32_8c.html#a4f27c8c10e28d59b4c43bacbcd2fa76c">translate_char</a>(cmd, <span class="charliteral">&apos;/&apos;</span>, <span class="charliteral">&apos;\\&apos;</span>);
<a name="l01237"></a>01237         prog = cmd;
<a name="l01238"></a>01238     }
<a name="l01239"></a>01239     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(prog, <span class="charliteral">&apos;/&apos;</span>)) {
<a name="l01240"></a>01240         len = <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(prog);
<a name="l01241"></a>01241         <span class="keywordflow">if</span> (len &lt; <span class="keyword">sizeof</span>(fbuf))
<a name="l01242"></a>01242             <a class="code" href="../../d3/d90/missing_8h.html#ae18161b919a8cf237d27f8aac700d80c">strlcpy</a>(cmd = fbuf, prog, <span class="keyword">sizeof</span>(fbuf));
<a name="l01243"></a>01243         <span class="keywordflow">else</span>
<a name="l01244"></a>01244             <a class="code" href="../../d5/df2/win32_8c.html#af5ece14f6cf7973ea1f950bac1fe7c2a">STRNDUPV</a>(cmd, v, prog, len);
<a name="l01245"></a>01245         <a class="code" href="../../d5/df2/win32_8c.html#a4f27c8c10e28d59b4c43bacbcd2fa76c">translate_char</a>(cmd, <span class="charliteral">&apos;/&apos;</span>, <span class="charliteral">&apos;\\&apos;</span>);
<a name="l01246"></a>01246         prog = cmd;
<a name="l01247"></a>01247     }
<a name="l01248"></a>01248     <span class="keywordflow">if</span> (c_switch || <a class="code" href="../../d5/df2/win32_8c.html#a7e1f44758a0c2b0db118e0a169b34f8b">is_batch</a>(prog)) {
<a name="l01249"></a>01249         <span class="keywordtype">char</span> *progs[2];
<a name="l01250"></a>01250         progs[0] = (<span class="keywordtype">char</span> *)prog;
<a name="l01251"></a>01251         progs[1] = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01252"></a>01252         len = <a class="code" href="../../d5/df2/win32_8c.html#afc137e4bd983d60ca711a8fe5dd27d80">join_argv</a>(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, progs, ntcmd);
<a name="l01253"></a>01253         <span class="keywordflow">if</span> (c_switch) len += 3;
<a name="l01254"></a>01254         <span class="keywordflow">else</span> ++argv;
<a name="l01255"></a>01255         <span class="keywordflow">if</span> (argv[0]) len += <a class="code" href="../../d5/df2/win32_8c.html#afc137e4bd983d60ca711a8fe5dd27d80">join_argv</a>(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, argv, ntcmd);
<a name="l01256"></a>01256         cmd = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7e07f4f937d300a4f0509b0c26526716">ALLOCV</a>(v, len);
<a name="l01257"></a>01257         <a class="code" href="../../d5/df2/win32_8c.html#afc137e4bd983d60ca711a8fe5dd27d80">join_argv</a>(cmd, progs, ntcmd);
<a name="l01258"></a>01258         <span class="keywordflow">if</span> (c_switch) <a class="code" href="../../d3/d90/missing_8h.html#aaf5a91beb98482ed8f426c921a4493a1">strlcat</a>(cmd, <span class="stringliteral">&quot; /c&quot;</span>, len);
<a name="l01259"></a>01259         <span class="keywordflow">if</span> (argv[0]) <a class="code" href="../../d5/df2/win32_8c.html#afc137e4bd983d60ca711a8fe5dd27d80">join_argv</a>(cmd + <a class="code" href="../../d3/d90/missing_8h.html#aaf5a91beb98482ed8f426c921a4493a1">strlcat</a>(cmd, <span class="stringliteral">&quot; &quot;</span>, len), argv, ntcmd);
<a name="l01260"></a>01260         prog = c_switch ? shell : 0;
<a name="l01261"></a>01261     }
<a name="l01262"></a>01262     <span class="keywordflow">else</span> {
<a name="l01263"></a>01263         len = <a class="code" href="../../d5/df2/win32_8c.html#afc137e4bd983d60ca711a8fe5dd27d80">join_argv</a>(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, argv, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01264"></a>01264         cmd = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7e07f4f937d300a4f0509b0c26526716">ALLOCV</a>(v, len);
<a name="l01265"></a>01265         <a class="code" href="../../d5/df2/win32_8c.html#afc137e4bd983d60ca711a8fe5dd27d80">join_argv</a>(cmd, argv, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l01266"></a>01266     }
<a name="l01267"></a>01267 
<a name="l01268"></a>01268     <span class="comment">/* assume ACP */</span>
<a name="l01269"></a>01269     wcmd = cmd ? <a class="code" href="../../d5/df2/win32_8c.html#a78aebdf486fd66af6d3cce1bc37016b7">acp_to_wstr</a>(cmd, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) : <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01270"></a>01270     <span class="keywordflow">if</span> (v) <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a13424d6f6efe4c7cf2f032744a04e51c">ALLOCV_END</a>(v);
<a name="l01271"></a>01271     wprog = prog ? <a class="code" href="../../d5/df2/win32_8c.html#a78aebdf486fd66af6d3cce1bc37016b7">acp_to_wstr</a>(prog, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) : <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01272"></a>01272 
<a name="l01273"></a>01273     ret = <a class="code" href="../../d5/df2/win32_8c.html#a385dcd9d25a2fc5d1225697aee45f1b3">child_result</a>(<a class="code" href="../../d5/df2/win32_8c.html#aff4f0f208c5db35376e6c5d76a151801">CreateChild</a>(wcmd, wprog, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, flags), mode);
<a name="l01274"></a>01274     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wprog);
<a name="l01275"></a>01275     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wcmd);
<a name="l01276"></a>01276     <span class="keywordflow">return</span> ret;
<a name="l01277"></a>01277 }
<a name="l01278"></a>01278 
<a name="l01279"></a>01279 rb_pid_t
<a name="l01280"></a><a class="code" href="../../d5/df2/win32_8c.html#a75032001f87ef001d626af57781db615">01280</a> <a class="code" href="../../dc/db1/win32_8h.html#a4d7623fc5298f802f41339ee53761064">rb_w32_aspawn</a>(<span class="keywordtype">int</span> mode, <span class="keyword">const</span> <span class="keywordtype">char</span> *prog, <span class="keywordtype">char</span> *<span class="keyword">const</span> *argv)
<a name="l01281"></a>01281 {
<a name="l01282"></a>01282     <span class="keywordflow">return</span> <a class="code" href="../../dc/db1/win32_8h.html#a5431e54710874f971979ccb3b2728556">rb_w32_aspawn_flags</a>(mode, prog, argv, 0);
<a name="l01283"></a>01283 }
<a name="l01284"></a>01284 
<a name="l01285"></a>01285 <span class="comment">/* License: Artistic or GPL */</span>
<a name="l01286"></a><a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">01286</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">_NtCmdLineElement</a> {
<a name="l01287"></a><a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a25656ebfd0cdaa2b6b48e8e1018c3d4f">01287</a>     <span class="keyword">struct </span><a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">_NtCmdLineElement</a> *<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a25656ebfd0cdaa2b6b48e8e1018c3d4f">next</a>;
<a name="l01288"></a><a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a3352d2fc1025974f1d839a05b8a18502">01288</a>     <span class="keywordtype">char</span> *str;
<a name="l01289"></a><a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#af5e967afdfaec80132319631a715c293">01289</a>     <span class="keywordtype">int</span> <a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#af5e967afdfaec80132319631a715c293">len</a>;
<a name="l01290"></a><a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a9fb9e83b09dfdcf61ab456dd2c1349a9">01290</a>     <span class="keywordtype">int</span> <a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a9fb9e83b09dfdcf61ab456dd2c1349a9">flags</a>;
<a name="l01291"></a>01291 } <a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">NtCmdLineElement</a>;
<a name="l01292"></a>01292 
<a name="l01293"></a>01293 <span class="comment">//</span>
<a name="l01294"></a>01294 <span class="comment">// Possible values for flags</span>
<a name="l01295"></a>01295 <span class="comment">//</span>
<a name="l01296"></a>01296 
<a name="l01297"></a><a class="code" href="../../d5/df2/win32_8c.html#ae69e4452f935ceaf745b6720f66acfb0">01297</a> <span class="preprocessor">#define NTGLOB   0x1    // element contains a wildcard</span>
<a name="l01298"></a><a class="code" href="../../d5/df2/win32_8c.html#a3dd3eaed2d5f81dd85d1067f6063e88f">01298</a> <span class="preprocessor"></span><span class="preprocessor">#define NTMALLOC 0x2    // string in element was malloc&apos;ed</span>
<a name="l01299"></a><a class="code" href="../../d5/df2/win32_8c.html#a88c2ff0b3e935d0177b8f06cf9bd9372">01299</a> <span class="preprocessor"></span><span class="preprocessor">#define NTSTRING 0x4    // element contains a quoted string</span>
<a name="l01300"></a>01300 <span class="preprocessor"></span>
<a name="l01301"></a>01301 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01302"></a><a class="code" href="../../d5/df2/win32_8c.html#a5b14319917940c35d782fe8445810274">01302</a> <a class="code" href="../../d5/df2/win32_8c.html#a5b14319917940c35d782fe8445810274">insert</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> vinfo, <span class="keywordtype">void</span> *enc)
<a name="l01303"></a>01303 {
<a name="l01304"></a>01304     <a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">NtCmdLineElement</a> *tmpcurr;
<a name="l01305"></a>01305     <a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">NtCmdLineElement</a> ***tail = (<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">NtCmdLineElement</a> ***)vinfo;
<a name="l01306"></a>01306 
<a name="l01307"></a>01307     tmpcurr = (<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">NtCmdLineElement</a> *)<a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">NtCmdLineElement</a>));
<a name="l01308"></a>01308     <span class="keywordflow">if</span> (!tmpcurr) <span class="keywordflow">return</span> -1;
<a name="l01309"></a>01309     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a56d620b94b668ed7665d1616b2c54e48">MEMZERO</a>(tmpcurr, <a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">NtCmdLineElement</a>, 1);
<a name="l01310"></a>01310     tmpcurr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#af5e967afdfaec80132319631a715c293">len</a> = <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(path);
<a name="l01311"></a>01311     tmpcurr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a3352d2fc1025974f1d839a05b8a18502">str</a> = <a class="code" href="../../d8/d3c/util_8h.html#ad832104a69551cf1e4e347fffa9dc77c">strdup</a>(path);
<a name="l01312"></a>01312     <span class="keywordflow">if</span> (!tmpcurr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a3352d2fc1025974f1d839a05b8a18502">str</a>) <span class="keywordflow">return</span> -1;
<a name="l01313"></a>01313     tmpcurr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a9fb9e83b09dfdcf61ab456dd2c1349a9">flags</a> |= <a class="code" href="../../d5/df2/win32_8c.html#a3dd3eaed2d5f81dd85d1067f6063e88f">NTMALLOC</a>;
<a name="l01314"></a>01314     **tail = tmpcurr;
<a name="l01315"></a>01315     *tail = &amp;tmpcurr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a25656ebfd0cdaa2b6b48e8e1018c3d4f">next</a>;
<a name="l01316"></a>01316 
<a name="l01317"></a>01317     <span class="keywordflow">return</span> 0;
<a name="l01318"></a>01318 }
<a name="l01319"></a>01319 
<a name="l01320"></a>01320 
<a name="l01321"></a>01321 <span class="keyword">static</span> <a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">NtCmdLineElement</a> **
<a name="l01322"></a><a class="code" href="../../d5/df2/win32_8c.html#a3231beb3c55c5609e66d3effb3aee9de">01322</a> <a class="code" href="../../d5/df2/win32_8c.html#a3231beb3c55c5609e66d3effb3aee9de">cmdglob</a>(<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">NtCmdLineElement</a> *patt, <a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">NtCmdLineElement</a> **tail)
<a name="l01323"></a>01323 {
<a name="l01324"></a>01324     <span class="keywordtype">char</span> buffer[<a class="code" href="../../d1/ddc/dln_8c.html#addfa831c1473e710d2b71b72fd7fcfa5">MAXPATHLEN</a>], *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a> = buffer;
<a name="l01325"></a>01325     <span class="keywordtype">char</span> *p;
<a name="l01326"></a>01326     <a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">NtCmdLineElement</a> **<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a> = tail;
<a name="l01327"></a>01327     <span class="keywordtype">int</span> status;
<a name="l01328"></a>01328 
<a name="l01329"></a>01329     <span class="keywordflow">if</span> (patt-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#af5e967afdfaec80132319631a715c293">len</a> &gt;= <a class="code" href="../../d1/ddc/dln_8c.html#addfa831c1473e710d2b71b72fd7fcfa5">MAXPATHLEN</a>)
<a name="l01330"></a>01330         <span class="keywordflow">if</span> (!(buf = <a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(patt-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#af5e967afdfaec80132319631a715c293">len</a> + 1))) <span class="keywordflow">return</span> 0;
<a name="l01331"></a>01331 
<a name="l01332"></a>01332     <a class="code" href="../../d3/d90/missing_8h.html#ae18161b919a8cf237d27f8aac700d80c">strlcpy</a>(buf, patt-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a3352d2fc1025974f1d839a05b8a18502">str</a>, patt-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#af5e967afdfaec80132319631a715c293">len</a> + 1);
<a name="l01333"></a>01333     buf[patt-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#af5e967afdfaec80132319631a715c293">len</a>] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01334"></a>01334     <span class="keywordflow">for</span> (p = buf; *p; p = <a class="code" href="../../dd/dd0/eval__intern_8h.html#a0892c4ab83ee67ec75cad2debdb5ddbb">CharNext</a>(p))
<a name="l01335"></a>01335         <span class="keywordflow">if</span> (*p == <span class="charliteral">&apos;\\&apos;</span>)
<a name="l01336"></a>01336             *p = <span class="charliteral">&apos;/&apos;</span>;
<a name="l01337"></a>01337     status = <a class="code" href="../../de/d32/dir_8c.html#adf064ef5ec23d7da524484a07cbf1fa6">ruby_brace_glob</a>(buf, 0, <a class="code" href="../../d5/df2/win32_8c.html#a5b14319917940c35d782fe8445810274">insert</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;tail);
<a name="l01338"></a>01338     <span class="keywordflow">if</span> (buf != buffer)
<a name="l01339"></a>01339         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(buf);
<a name="l01340"></a>01340 
<a name="l01341"></a>01341     <span class="keywordflow">if</span> (status || last == tail) <span class="keywordflow">return</span> 0;
<a name="l01342"></a>01342     <span class="keywordflow">if</span> (patt-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a9fb9e83b09dfdcf61ab456dd2c1349a9">flags</a> &amp; <a class="code" href="../../d5/df2/win32_8c.html#a3dd3eaed2d5f81dd85d1067f6063e88f">NTMALLOC</a>)
<a name="l01343"></a>01343         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(patt-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a3352d2fc1025974f1d839a05b8a18502">str</a>);
<a name="l01344"></a>01344     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(patt);
<a name="l01345"></a>01345     <span class="keywordflow">return</span> tail;
<a name="l01346"></a>01346 }
<a name="l01347"></a>01347 
<a name="l01348"></a>01348 <span class="comment">//</span>
<a name="l01349"></a>01349 <span class="comment">// Check a command string to determine if it has I/O redirection</span>
<a name="l01350"></a>01350 <span class="comment">// characters that require it to be executed by a command interpreter</span>
<a name="l01351"></a>01351 <span class="comment">//</span>
<a name="l01352"></a>01352 
<a name="l01353"></a>01353 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01354"></a><a class="code" href="../../d5/df2/win32_8c.html#a6dde4e745374faf9c51029d31f97b9b0">01354</a> <a class="code" href="../../d5/df2/win32_8c.html#a6dde4e745374faf9c51029d31f97b9b0">has_redirection</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *cmd)
<a name="l01355"></a>01355 {
<a name="l01356"></a>01356     <span class="keywordtype">char</span> quote = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01357"></a>01357     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr;
<a name="l01358"></a>01358 
<a name="l01359"></a>01359     <span class="comment">//</span>
<a name="l01360"></a>01360     <span class="comment">// Scan the string, looking for redirection characters (&lt; or &gt;), pipe</span>
<a name="l01361"></a>01361     <span class="comment">// character (|) or newline (\n) that are not in a quoted string</span>
<a name="l01362"></a>01362     <span class="comment">//</span>
<a name="l01363"></a>01363 
<a name="l01364"></a>01364     <span class="keywordflow">for</span> (ptr = cmd; *ptr;) {
<a name="l01365"></a>01365         <span class="keywordflow">switch</span> (*ptr) {
<a name="l01366"></a>01366           <span class="keywordflow">case</span> <span class="charliteral">&apos;\&apos;&apos;</span>:
<a name="l01367"></a>01367           <span class="keywordflow">case</span> <span class="charliteral">&apos;\&quot;&apos;</span>:
<a name="l01368"></a>01368             <span class="keywordflow">if</span> (!quote)
<a name="l01369"></a>01369                 quote = *ptr;
<a name="l01370"></a>01370             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (quote == *ptr)
<a name="l01371"></a>01371                 quote = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01372"></a>01372             ptr++;
<a name="l01373"></a>01373             <span class="keywordflow">break</span>;
<a name="l01374"></a>01374 
<a name="l01375"></a>01375           <span class="keywordflow">case</span> <span class="charliteral">&apos;&gt;&apos;</span>:
<a name="l01376"></a>01376           <span class="keywordflow">case</span> <span class="charliteral">&apos;&lt;&apos;</span>:
<a name="l01377"></a>01377           <span class="keywordflow">case</span> <span class="charliteral">&apos;|&apos;</span>:
<a name="l01378"></a>01378           <span class="keywordflow">case</span> <span class="charliteral">&apos;&amp;&apos;</span>:
<a name="l01379"></a>01379           <span class="keywordflow">case</span> <span class="charliteral">&apos;\n&apos;</span>:
<a name="l01380"></a>01380             <span class="keywordflow">if</span> (!quote)
<a name="l01381"></a>01381                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01382"></a>01382             ptr++;
<a name="l01383"></a>01383             <span class="keywordflow">break</span>;
<a name="l01384"></a>01384 
<a name="l01385"></a>01385           <span class="keywordflow">case</span> <span class="charliteral">&apos;%&apos;</span>:
<a name="l01386"></a>01386             <span class="keywordflow">if</span> (*++ptr != <span class="charliteral">&apos;_&apos;</span> &amp;&amp; !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afe0bf9496b5e0ecf253fb86072ee7ecf">ISALPHA</a>(*ptr)) <span class="keywordflow">break</span>;
<a name="l01387"></a>01387             <span class="keywordflow">while</span> (*++ptr == <span class="charliteral">&apos;_&apos;</span> || <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8c0056118f585fa052e0f76e3198db6a">ISALNUM</a>(*ptr));
<a name="l01388"></a>01388             <span class="keywordflow">if</span> (*ptr++ == <span class="charliteral">&apos;%&apos;</span>) <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01389"></a>01389             <span class="keywordflow">break</span>;
<a name="l01390"></a>01390 
<a name="l01391"></a>01391           <span class="keywordflow">case</span> <span class="charliteral">&apos;\\&apos;</span>:
<a name="l01392"></a>01392             ptr++;
<a name="l01393"></a>01393           <span class="keywordflow">default</span>:
<a name="l01394"></a>01394             ptr = <a class="code" href="../../dd/dd0/eval__intern_8h.html#a0892c4ab83ee67ec75cad2debdb5ddbb">CharNext</a>(ptr);
<a name="l01395"></a>01395             <span class="keywordflow">break</span>;
<a name="l01396"></a>01396         }
<a name="l01397"></a>01397     }
<a name="l01398"></a>01398     <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01399"></a>01399 }
<a name="l01400"></a>01400 
<a name="l01401"></a>01401 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">char</span> *
<a name="l01402"></a><a class="code" href="../../d5/df2/win32_8c.html#ad4a6f6b588846d24a45ba827d24caeb3">01402</a> <a class="code" href="../../d5/df2/win32_8c.html#ad4a6f6b588846d24a45ba827d24caeb3">skipspace</a>(<span class="keywordtype">char</span> *ptr)
<a name="l01403"></a>01403 {
<a name="l01404"></a>01404     <span class="keywordflow">while</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae8cdc17e44905c826bddf416b7bf621c">ISSPACE</a>(*ptr))
<a name="l01405"></a>01405         ptr++;
<a name="l01406"></a>01406     <span class="keywordflow">return</span> ptr;
<a name="l01407"></a>01407 }
<a name="l01408"></a>01408 
<a name="l01409"></a>01409 <span class="keywordtype">int</span>
<a name="l01410"></a><a class="code" href="../../d5/df2/win32_8c.html#af938d87b5d70d6514f168b2ef21cedc6">01410</a> <a class="code" href="../../dc/db1/win32_8h.html#aacd9c53bcbb2361cc96afc053c00fe62">rb_w32_cmdvector</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> ***vec)
<a name="l01411"></a>01411 {
<a name="l01412"></a>01412     <span class="keywordtype">int</span> globbing, <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l01413"></a>01413     <span class="keywordtype">int</span> elements, strsz, done;
<a name="l01414"></a>01414     <span class="keywordtype">int</span> slashes, escape;
<a name="l01415"></a>01415     <span class="keywordtype">char</span> *ptr, *base, *buffer, *cmdline;
<a name="l01416"></a>01416     <span class="keywordtype">char</span> **vptr;
<a name="l01417"></a>01417     <span class="keywordtype">char</span> quote;
<a name="l01418"></a>01418     <a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">NtCmdLineElement</a> *curr, **tail;
<a name="l01419"></a>01419     <a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">NtCmdLineElement</a> *cmdhead = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, **cmdtail = &amp;cmdhead;
<a name="l01420"></a>01420 
<a name="l01421"></a>01421     <span class="comment">//</span>
<a name="l01422"></a>01422     <span class="comment">// just return if we don&apos;t have a command line</span>
<a name="l01423"></a>01423     <span class="comment">//</span>
<a name="l01424"></a>01424 
<a name="l01425"></a>01425     <span class="keywordflow">while</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae8cdc17e44905c826bddf416b7bf621c">ISSPACE</a>(*cmd))
<a name="l01426"></a>01426         cmd++;
<a name="l01427"></a>01427     <span class="keywordflow">if</span> (!*cmd) {
<a name="l01428"></a>01428         *vec = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01429"></a>01429         <span class="keywordflow">return</span> 0;
<a name="l01430"></a>01430     }
<a name="l01431"></a>01431 
<a name="l01432"></a>01432     ptr = cmdline = <a class="code" href="../../d8/d3c/util_8h.html#ad832104a69551cf1e4e347fffa9dc77c">strdup</a>(cmd);
<a name="l01433"></a>01433 
<a name="l01434"></a>01434     <span class="comment">//</span>
<a name="l01435"></a>01435     <span class="comment">// Ok, parse the command line, building a list of CmdLineElements.</span>
<a name="l01436"></a>01436     <span class="comment">// When we&apos;ve finished, and it&apos;s an input command (meaning that it&apos;s</span>
<a name="l01437"></a>01437     <span class="comment">// the processes argv), we&apos;ll do globing and then build the argument</span>
<a name="l01438"></a>01438     <span class="comment">// vector.</span>
<a name="l01439"></a>01439     <span class="comment">// The outer loop does one interation for each element seen.</span>
<a name="l01440"></a>01440     <span class="comment">// The inner loop does one interation for each character in the element.</span>
<a name="l01441"></a>01441     <span class="comment">//</span>
<a name="l01442"></a>01442 
<a name="l01443"></a>01443     <span class="keywordflow">while</span> (*(ptr = <a class="code" href="../../d5/df2/win32_8c.html#ad4a6f6b588846d24a45ba827d24caeb3">skipspace</a>(ptr))) {
<a name="l01444"></a>01444         base = ptr;
<a name="l01445"></a>01445         quote = slashes = globbing = escape = 0;
<a name="l01446"></a>01446         <span class="keywordflow">for</span> (done = 0; !done &amp;&amp; *ptr; ) {
<a name="l01447"></a>01447             <span class="comment">//</span>
<a name="l01448"></a>01448             <span class="comment">// Switch on the current character. We only care about the</span>
<a name="l01449"></a>01449             <span class="comment">// white-space characters, the  wild-card characters, and the</span>
<a name="l01450"></a>01450             <span class="comment">// quote characters.</span>
<a name="l01451"></a>01451             <span class="comment">//</span>
<a name="l01452"></a>01452 
<a name="l01453"></a>01453             <span class="keywordflow">switch</span> (*ptr) {
<a name="l01454"></a>01454               <span class="keywordflow">case</span> <span class="charliteral">&apos;\\&apos;</span>:
<a name="l01455"></a>01455                 <span class="keywordflow">if</span> (quote != <span class="charliteral">&apos;\&apos;&apos;</span>) slashes++;
<a name="l01456"></a>01456                 <span class="keywordflow">break</span>;
<a name="l01457"></a>01457 
<a name="l01458"></a>01458               <span class="keywordflow">case</span> <span class="charliteral">&apos; &apos;</span>:
<a name="l01459"></a>01459               <span class="keywordflow">case</span> <span class="charliteral">&apos;\t&apos;</span>:
<a name="l01460"></a>01460               <span class="keywordflow">case</span> <span class="charliteral">&apos;\n&apos;</span>:
<a name="l01461"></a>01461                 <span class="comment">//</span>
<a name="l01462"></a>01462                 <span class="comment">// if we&apos;re not in a string, then we&apos;re finished with this</span>
<a name="l01463"></a>01463                 <span class="comment">// element</span>
<a name="l01464"></a>01464                 <span class="comment">//</span>
<a name="l01465"></a>01465 
<a name="l01466"></a>01466                 <span class="keywordflow">if</span> (!quote) {
<a name="l01467"></a>01467                     *ptr = 0;
<a name="l01468"></a>01468                     done = 1;
<a name="l01469"></a>01469                 }
<a name="l01470"></a>01470                 <span class="keywordflow">break</span>;
<a name="l01471"></a>01471 
<a name="l01472"></a>01472               <span class="keywordflow">case</span> <span class="charliteral">&apos;*&apos;</span>:
<a name="l01473"></a>01473               <span class="keywordflow">case</span> <span class="charliteral">&apos;?&apos;</span>:
<a name="l01474"></a>01474               <span class="keywordflow">case</span> <span class="charliteral">&apos;[&apos;</span>:
<a name="l01475"></a>01475               <span class="keywordflow">case</span> <span class="charliteral">&apos;{&apos;</span>:
<a name="l01476"></a>01476                 <span class="comment">//</span>
<a name="l01477"></a>01477                 <span class="comment">// record the fact that this element has a wildcard character</span>
<a name="l01478"></a>01478                 <span class="comment">// N.B. Don&apos;t glob if inside a single quoted string</span>
<a name="l01479"></a>01479                 <span class="comment">//</span>
<a name="l01480"></a>01480 
<a name="l01481"></a>01481                 <span class="keywordflow">if</span> (quote != <span class="charliteral">&apos;\&apos;&apos;</span>)
<a name="l01482"></a>01482                     globbing++;
<a name="l01483"></a>01483                 slashes = 0;
<a name="l01484"></a>01484                 <span class="keywordflow">break</span>;
<a name="l01485"></a>01485 
<a name="l01486"></a>01486               <span class="keywordflow">case</span> <span class="charliteral">&apos;\&apos;&apos;</span>:
<a name="l01487"></a>01487               <span class="keywordflow">case</span> <span class="charliteral">&apos;\&quot;&apos;</span>:
<a name="l01488"></a>01488                 <span class="comment">//</span>
<a name="l01489"></a>01489                 <span class="comment">// if we&apos;re already in a string, see if this is the</span>
<a name="l01490"></a>01490                 <span class="comment">// terminating close-quote. If it is, we&apos;re finished with</span>
<a name="l01491"></a>01491                 <span class="comment">// the string, but not neccessarily with the element.</span>
<a name="l01492"></a>01492                 <span class="comment">// If we&apos;re not already in a string, start one.</span>
<a name="l01493"></a>01493                 <span class="comment">//</span>
<a name="l01494"></a>01494 
<a name="l01495"></a>01495                 <span class="keywordflow">if</span> (!(slashes &amp; 1)) {
<a name="l01496"></a>01496                     <span class="keywordflow">if</span> (!quote)
<a name="l01497"></a>01497                         quote = *ptr;
<a name="l01498"></a>01498                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (quote == *ptr) {
<a name="l01499"></a>01499                         <span class="keywordflow">if</span> (quote == <span class="charliteral">&apos;&quot;&apos;</span> &amp;&amp; quote == ptr[1])
<a name="l01500"></a>01500                             ptr++;
<a name="l01501"></a>01501                         quote = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01502"></a>01502                     }
<a name="l01503"></a>01503                 }
<a name="l01504"></a>01504                 escape++;
<a name="l01505"></a>01505                 slashes = 0;
<a name="l01506"></a>01506                 <span class="keywordflow">break</span>;
<a name="l01507"></a>01507 
<a name="l01508"></a>01508               <span class="keywordflow">default</span>:
<a name="l01509"></a>01509                 ptr = <a class="code" href="../../dd/dd0/eval__intern_8h.html#a0892c4ab83ee67ec75cad2debdb5ddbb">CharNext</a>(ptr);
<a name="l01510"></a>01510                 slashes = 0;
<a name="l01511"></a>01511                 <span class="keywordflow">continue</span>;
<a name="l01512"></a>01512             }
<a name="l01513"></a>01513             ptr++;
<a name="l01514"></a>01514         }
<a name="l01515"></a>01515 
<a name="l01516"></a>01516         <span class="comment">//</span>
<a name="l01517"></a>01517         <span class="comment">// when we get here, we&apos;ve got a pair of pointers to the element,</span>
<a name="l01518"></a>01518         <span class="comment">// base and ptr. Base points to the start of the element while ptr</span>
<a name="l01519"></a>01519         <span class="comment">// points to the character following the element.</span>
<a name="l01520"></a>01520         <span class="comment">//</span>
<a name="l01521"></a>01521 
<a name="l01522"></a>01522         len = ptr - base;
<a name="l01523"></a>01523         <span class="keywordflow">if</span> (done) --len;
<a name="l01524"></a>01524 
<a name="l01525"></a>01525         <span class="comment">//</span>
<a name="l01526"></a>01526         <span class="comment">// if it&apos;s an input vector element and it&apos;s enclosed by quotes,</span>
<a name="l01527"></a>01527         <span class="comment">// we can remove them.</span>
<a name="l01528"></a>01528         <span class="comment">//</span>
<a name="l01529"></a>01529 
<a name="l01530"></a>01530         <span class="keywordflow">if</span> (escape) {
<a name="l01531"></a>01531             <span class="keywordtype">char</span> *p = base, c;
<a name="l01532"></a>01532             slashes = quote = 0;
<a name="l01533"></a>01533             <span class="keywordflow">while</span> (p &lt; base + len) {
<a name="l01534"></a>01534                 <span class="keywordflow">switch</span> (c = *p) {
<a name="l01535"></a>01535                   <span class="keywordflow">case</span> <span class="charliteral">&apos;\\&apos;</span>:
<a name="l01536"></a>01536                     p++;
<a name="l01537"></a>01537                     <span class="keywordflow">if</span> (quote != <span class="charliteral">&apos;\&apos;&apos;</span>) slashes++;
<a name="l01538"></a>01538                     <span class="keywordflow">break</span>;
<a name="l01539"></a>01539 
<a name="l01540"></a>01540                   <span class="keywordflow">case</span> <span class="charliteral">&apos;\&apos;&apos;</span>:
<a name="l01541"></a>01541                   <span class="keywordflow">case</span> <span class="charliteral">&apos;&quot;&apos;</span>:
<a name="l01542"></a>01542                     <span class="keywordflow">if</span> (!(slashes &amp; 1) &amp;&amp; quote &amp;&amp; quote != c) {
<a name="l01543"></a>01543                         p++;
<a name="l01544"></a>01544                         slashes = 0;
<a name="l01545"></a>01545                         <span class="keywordflow">break</span>;
<a name="l01546"></a>01546                     }
<a name="l01547"></a>01547                     memcpy(p - ((slashes + 1) &gt;&gt; 1), p + (~slashes &amp; 1),
<a name="l01548"></a>01548                            base + len - p);
<a name="l01549"></a>01549                     len -= ((slashes + 1) &gt;&gt; 1) + (~slashes &amp; 1);
<a name="l01550"></a>01550                     p -= (slashes + 1) &gt;&gt; 1;
<a name="l01551"></a>01551                     <span class="keywordflow">if</span> (!(slashes &amp; 1)) {
<a name="l01552"></a>01552                         <span class="keywordflow">if</span> (quote) {
<a name="l01553"></a>01553                             <span class="keywordflow">if</span> (quote == <span class="charliteral">&apos;&quot;&apos;</span> &amp;&amp; quote == *p)
<a name="l01554"></a>01554                                 p++;
<a name="l01555"></a>01555                             quote = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01556"></a>01556                         }
<a name="l01557"></a>01557                         <span class="keywordflow">else</span>
<a name="l01558"></a>01558                             quote = c;
<a name="l01559"></a>01559                     }
<a name="l01560"></a>01560                     <span class="keywordflow">else</span>
<a name="l01561"></a>01561                         p++;
<a name="l01562"></a>01562                     slashes = 0;
<a name="l01563"></a>01563                     <span class="keywordflow">break</span>;
<a name="l01564"></a>01564 
<a name="l01565"></a>01565                   <span class="keywordflow">default</span>:
<a name="l01566"></a>01566                     p = <a class="code" href="../../dd/dd0/eval__intern_8h.html#a0892c4ab83ee67ec75cad2debdb5ddbb">CharNext</a>(p);
<a name="l01567"></a>01567                     slashes = 0;
<a name="l01568"></a>01568                     <span class="keywordflow">break</span>;
<a name="l01569"></a>01569                 }
<a name="l01570"></a>01570             }
<a name="l01571"></a>01571         }
<a name="l01572"></a>01572 
<a name="l01573"></a>01573         curr = (<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">NtCmdLineElement</a> *)<a class="code" href="../../d5/d11/ripper_8c.html#a84beef8cc122add35118ec7cd35286c4">calloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html">NtCmdLineElement</a>), 1);
<a name="l01574"></a>01574         <span class="keywordflow">if</span> (!curr) <span class="keywordflow">goto</span> do_nothing;
<a name="l01575"></a>01575         curr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a3352d2fc1025974f1d839a05b8a18502">str</a> = base;
<a name="l01576"></a>01576         curr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#af5e967afdfaec80132319631a715c293">len</a> = len;
<a name="l01577"></a>01577 
<a name="l01578"></a>01578         <span class="keywordflow">if</span> (globbing &amp;&amp; (tail = <a class="code" href="../../d5/df2/win32_8c.html#a3231beb3c55c5609e66d3effb3aee9de">cmdglob</a>(curr, cmdtail))) {
<a name="l01579"></a>01579             cmdtail = tail;
<a name="l01580"></a>01580         }
<a name="l01581"></a>01581         <span class="keywordflow">else</span> {
<a name="l01582"></a>01582             *cmdtail = curr;
<a name="l01583"></a>01583             cmdtail = &amp;curr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a25656ebfd0cdaa2b6b48e8e1018c3d4f">next</a>;
<a name="l01584"></a>01584         }
<a name="l01585"></a>01585     }
<a name="l01586"></a>01586 
<a name="l01587"></a>01587     <span class="comment">//</span>
<a name="l01588"></a>01588     <span class="comment">// Almost done!</span>
<a name="l01589"></a>01589     <span class="comment">// Count up the elements, then allocate space for a vector of pointers</span>
<a name="l01590"></a>01590     <span class="comment">// (argv) and a string table for the elements.</span>
<a name="l01591"></a>01591     <span class="comment">//</span>
<a name="l01592"></a>01592 
<a name="l01593"></a>01593     <span class="keywordflow">for</span> (elements = 0, strsz = 0, curr = cmdhead; curr; curr = curr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a25656ebfd0cdaa2b6b48e8e1018c3d4f">next</a>) {
<a name="l01594"></a>01594         elements++;
<a name="l01595"></a>01595         strsz += (curr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#af5e967afdfaec80132319631a715c293">len</a> + 1);
<a name="l01596"></a>01596     }
<a name="l01597"></a>01597 
<a name="l01598"></a>01598     len = (elements+1)*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *) + strsz;
<a name="l01599"></a>01599     buffer = (<span class="keywordtype">char</span> *)<a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(len);
<a name="l01600"></a>01600     <span class="keywordflow">if</span> (!buffer) {
<a name="l01601"></a>01601       do_nothing:
<a name="l01602"></a>01602         <span class="keywordflow">while</span> (curr = cmdhead) {
<a name="l01603"></a>01603             cmdhead = curr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a25656ebfd0cdaa2b6b48e8e1018c3d4f">next</a>;
<a name="l01604"></a>01604             <span class="keywordflow">if</span> (curr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a9fb9e83b09dfdcf61ab456dd2c1349a9">flags</a> &amp; <a class="code" href="../../d5/df2/win32_8c.html#a3dd3eaed2d5f81dd85d1067f6063e88f">NTMALLOC</a>) <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(curr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a3352d2fc1025974f1d839a05b8a18502">str</a>);
<a name="l01605"></a>01605             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(curr);
<a name="l01606"></a>01606         }
<a name="l01607"></a>01607         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(cmdline);
<a name="l01608"></a>01608         <span class="keywordflow">for</span> (vptr = *vec; *vptr; ++vptr);
<a name="l01609"></a>01609         <span class="keywordflow">return</span> vptr - *vec;
<a name="l01610"></a>01610     }
<a name="l01611"></a>01611 
<a name="l01612"></a>01612     <span class="comment">//</span>
<a name="l01613"></a>01613     <span class="comment">// make vptr point to the start of the buffer</span>
<a name="l01614"></a>01614     <span class="comment">// and ptr point to the area we&apos;ll consider the string table.</span>
<a name="l01615"></a>01615     <span class="comment">//</span>
<a name="l01616"></a>01616     <span class="comment">//   buffer (*vec)</span>
<a name="l01617"></a>01617     <span class="comment">//   |</span>
<a name="l01618"></a>01618     <span class="comment">//   V       ^---------------------V</span>
<a name="l01619"></a>01619     <span class="comment">//   +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+</span>
<a name="l01620"></a>01620     <span class="comment">//   |   |       | ....  | NULL  |   | ..... |\0 |   | ..... |\0 |...</span>
<a name="l01621"></a>01621     <span class="comment">//   +---+---+---+---+---+---+---+---+---+---+---+---+---+---+---+</span>
<a name="l01622"></a>01622     <span class="comment">//   |-  elements+1             -| ^ 1st element   ^ 2nd element</span>
<a name="l01623"></a>01623 
<a name="l01624"></a>01624     vptr = (<span class="keywordtype">char</span> **) buffer;
<a name="l01625"></a>01625 
<a name="l01626"></a>01626     ptr = buffer + (elements+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *);
<a name="l01627"></a>01627 
<a name="l01628"></a>01628     <span class="keywordflow">while</span> (curr = cmdhead) {
<a name="l01629"></a>01629         <a class="code" href="../../d3/d90/missing_8h.html#ae18161b919a8cf237d27f8aac700d80c">strlcpy</a>(ptr, curr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a3352d2fc1025974f1d839a05b8a18502">str</a>, curr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#af5e967afdfaec80132319631a715c293">len</a> + 1);
<a name="l01630"></a>01630         *vptr++ = ptr;
<a name="l01631"></a>01631         ptr += curr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#af5e967afdfaec80132319631a715c293">len</a> + 1;
<a name="l01632"></a>01632         cmdhead = curr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a25656ebfd0cdaa2b6b48e8e1018c3d4f">next</a>;
<a name="l01633"></a>01633         <span class="keywordflow">if</span> (curr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a9fb9e83b09dfdcf61ab456dd2c1349a9">flags</a> &amp; <a class="code" href="../../d5/df2/win32_8c.html#a3dd3eaed2d5f81dd85d1067f6063e88f">NTMALLOC</a>) <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(curr-&gt;<a class="code" href="../../d9/d3f/struct___nt_cmd_line_element.html#a3352d2fc1025974f1d839a05b8a18502">str</a>);
<a name="l01634"></a>01634         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(curr);
<a name="l01635"></a>01635     }
<a name="l01636"></a>01636     *vptr = 0;
<a name="l01637"></a>01637 
<a name="l01638"></a>01638     *vec = (<span class="keywordtype">char</span> **) buffer;
<a name="l01639"></a>01639     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(cmdline);
<a name="l01640"></a>01640     <span class="keywordflow">return</span> elements;
<a name="l01641"></a>01641 }
<a name="l01642"></a>01642 
<a name="l01643"></a>01643 <span class="comment">//</span>
<a name="l01644"></a>01644 <span class="comment">// UNIX compatible directory access functions for NT</span>
<a name="l01645"></a>01645 <span class="comment">//</span>
<a name="l01646"></a>01646 
<a name="l01647"></a><a class="code" href="../../d5/df2/win32_8c.html#a306ffcae7edd4e8e4f5779ad8359ee1c">01647</a> <span class="preprocessor">#define PATHLEN 1024</span>
<a name="l01648"></a>01648 <span class="preprocessor"></span>
<a name="l01649"></a>01649 <span class="comment">//</span>
<a name="l01650"></a>01650 <span class="comment">// The idea here is to read all the directory names into a string table</span>
<a name="l01651"></a>01651 <span class="comment">// (separated by nulls) and when one of the other dir functions is called</span>
<a name="l01652"></a>01652 <span class="comment">// return the pointer to the current file name.</span>
<a name="l01653"></a>01653 <span class="comment">//</span>
<a name="l01654"></a>01654 
<a name="l01655"></a><a class="code" href="../../d5/df2/win32_8c.html#a98024277b48ef9c4a65e73b2ba75f162">01655</a> <span class="preprocessor">#define GetBit(bits, i) ((bits)[(i) / CHAR_BIT] &amp;  (1 &lt;&lt; (i) % CHAR_BIT))</span>
<a name="l01656"></a><a class="code" href="../../d5/df2/win32_8c.html#a24e9a52e2f9282a56091d84c93f554df">01656</a> <span class="preprocessor"></span><span class="preprocessor">#define SetBit(bits, i) ((bits)[(i) / CHAR_BIT] |= (1 &lt;&lt; (i) % CHAR_BIT))</span>
<a name="l01657"></a>01657 <span class="preprocessor"></span>
<a name="l01658"></a><a class="code" href="../../d5/df2/win32_8c.html#a14fc4415922447a0fba361748c812a9a">01658</a> <span class="preprocessor">#define BitOfIsDir(n) ((n) * 2)</span>
<a name="l01659"></a><a class="code" href="../../d5/df2/win32_8c.html#aad22df59bee1fc8c8d2185fc084a317f">01659</a> <span class="preprocessor"></span><span class="preprocessor">#define BitOfIsRep(n) ((n) * 2 + 1)</span>
<a name="l01660"></a><a class="code" href="../../d5/df2/win32_8c.html#a52b3618f623797bff5e19ab95fbcc7e5">01660</a> <span class="preprocessor"></span><span class="preprocessor">#define DIRENT_PER_CHAR (CHAR_BIT / 2)</span>
<a name="l01661"></a>01661 <span class="preprocessor"></span>
<a name="l01662"></a>01662 <span class="keyword">static</span> HANDLE
<a name="l01663"></a><a class="code" href="../../d5/df2/win32_8c.html#a8648c0d7bdfe57ccc5eb14a3c8e2f372">01663</a> <a class="code" href="../../d5/df2/win32_8c.html#a8648c0d7bdfe57ccc5eb14a3c8e2f372">open_dir_handle</a>(<span class="keyword">const</span> WCHAR *filename, WIN32_FIND_DATAW *fd)
<a name="l01664"></a>01664 {
<a name="l01665"></a>01665     HANDLE fh;
<a name="l01666"></a>01666     <span class="keyword">static</span> <span class="keyword">const</span> WCHAR wildcard[] = L<span class="stringliteral">&quot;\\*&quot;</span>;
<a name="l01667"></a>01667     WCHAR *scanname;
<a name="l01668"></a>01668     WCHAR *p;
<a name="l01669"></a>01669     <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l01670"></a>01670     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v;
<a name="l01671"></a>01671 
<a name="l01672"></a>01672     <span class="comment">//</span>
<a name="l01673"></a>01673     <span class="comment">// Create the search pattern</span>
<a name="l01674"></a>01674     <span class="comment">//</span>
<a name="l01675"></a>01675     len = lstrlenW(filename);
<a name="l01676"></a>01676     scanname = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa2fd9cb81f5d1422607583906d085a11">ALLOCV_N</a>(WCHAR, v, len + <span class="keyword">sizeof</span>(wildcard) / <span class="keyword">sizeof</span>(WCHAR));
<a name="l01677"></a>01677     lstrcpyW(scanname, filename);
<a name="l01678"></a>01678     p = CharPrevW(scanname, scanname + len);
<a name="l01679"></a>01679     <span class="keywordflow">if</span> (*p == L<span class="charliteral">&apos;/&apos;</span> || *p == L<span class="charliteral">&apos;\\&apos;</span> || *p == L<span class="charliteral">&apos;:&apos;</span>)
<a name="l01680"></a>01680         lstrcatW(scanname, wildcard + 1);
<a name="l01681"></a>01681     <span class="keywordflow">else</span>
<a name="l01682"></a>01682         lstrcatW(scanname, wildcard);
<a name="l01683"></a>01683 
<a name="l01684"></a>01684     <span class="comment">//</span>
<a name="l01685"></a>01685     <span class="comment">// do the FindFirstFile call</span>
<a name="l01686"></a>01686     <span class="comment">//</span>
<a name="l01687"></a>01687     fh = FindFirstFileW(scanname, fd);
<a name="l01688"></a>01688     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a13424d6f6efe4c7cf2f032744a04e51c">ALLOCV_END</a>(v);
<a name="l01689"></a>01689     <span class="keywordflow">if</span> (fh == INVALID_HANDLE_VALUE) {
<a name="l01690"></a>01690         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l01691"></a>01691     }
<a name="l01692"></a>01692     <span class="keywordflow">return</span> fh;
<a name="l01693"></a>01693 }
<a name="l01694"></a>01694 
<a name="l01695"></a>01695 <span class="keyword">static</span> <a class="code" href="../../d9/d31/struct_d_i_r.html">DIR</a> *
<a name="l01696"></a><a class="code" href="../../d5/df2/win32_8c.html#accc2699dfe09ed5b34d2f8c37d7ac3c3">01696</a> <a class="code" href="../../d5/df2/win32_8c.html#accc2699dfe09ed5b34d2f8c37d7ac3c3">opendir_internal</a>(WCHAR *wpath, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename)
<a name="l01697"></a>01697 {
<a name="l01698"></a>01698     <span class="keyword">struct </span>stati64 sbuf;
<a name="l01699"></a>01699     WIN32_FIND_DATAW fd;
<a name="l01700"></a>01700     HANDLE fh;
<a name="l01701"></a>01701     <a class="code" href="../../d9/d31/struct_d_i_r.html">DIR</a> *p;
<a name="l01702"></a>01702     <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l01703"></a>01703     <span class="keywordtype">long</span> idx;
<a name="l01704"></a>01704     WCHAR *tmpW;
<a name="l01705"></a>01705     <span class="keywordtype">char</span> *tmp;
<a name="l01706"></a>01706 
<a name="l01707"></a>01707     <span class="comment">//</span>
<a name="l01708"></a>01708     <span class="comment">// check to see if we&apos;ve got a directory</span>
<a name="l01709"></a>01709     <span class="comment">//</span>
<a name="l01710"></a>01710     <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#aa6e8114a63a22d89103ef7434a6ae53e">wstati64</a>(wpath, &amp;sbuf) &lt; 0) {
<a name="l01711"></a>01711         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01712"></a>01712     }
<a name="l01713"></a>01713     <span class="keywordflow">if</span> (!(sbuf.st_mode &amp; S_IFDIR) &amp;&amp;
<a name="l01714"></a>01714         (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afe0bf9496b5e0ecf253fb86072ee7ecf">ISALPHA</a>(filename[0]) || filename[1] != <span class="charliteral">&apos;:&apos;</span> || filename[2] != <span class="charliteral">&apos;\0&apos;</span> ||
<a name="l01715"></a>01715          ((1 &lt;&lt; ((filename[0] &amp; 0x5f) - <span class="charliteral">&apos;A&apos;</span>)) &amp; GetLogicalDrives()) == 0)) {
<a name="l01716"></a>01716         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ENOTDIR;
<a name="l01717"></a>01717         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01718"></a>01718     }
<a name="l01719"></a>01719     fh = <a class="code" href="../../d5/df2/win32_8c.html#a8648c0d7bdfe57ccc5eb14a3c8e2f372">open_dir_handle</a>(wpath, &amp;fd);
<a name="l01720"></a>01720     <span class="keywordflow">if</span> (fh == INVALID_HANDLE_VALUE) {
<a name="l01721"></a>01721         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01722"></a>01722     }
<a name="l01723"></a>01723 
<a name="l01724"></a>01724     <span class="comment">//</span>
<a name="l01725"></a>01725     <span class="comment">// Get us a DIR structure</span>
<a name="l01726"></a>01726     <span class="comment">//</span>
<a name="l01727"></a>01727     p = <a class="code" href="../../d5/d11/ripper_8c.html#a84beef8cc122add35118ec7cd35286c4">calloc</a>(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d31/struct_d_i_r.html">DIR</a>), 1);
<a name="l01728"></a>01728     <span class="keywordflow">if</span> (p == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01729"></a>01729         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01730"></a>01730 
<a name="l01731"></a>01731     idx = 0;
<a name="l01732"></a>01732 
<a name="l01733"></a>01733     <span class="comment">//</span>
<a name="l01734"></a>01734     <span class="comment">// loop finding all the files that match the wildcard</span>
<a name="l01735"></a>01735     <span class="comment">// (which should be all of them in this directory!).</span>
<a name="l01736"></a>01736     <span class="comment">// the variable idx should point one past the null terminator</span>
<a name="l01737"></a>01737     <span class="comment">// of the previous string found.</span>
<a name="l01738"></a>01738     <span class="comment">//</span>
<a name="l01739"></a>01739     <span class="keywordflow">do</span> {
<a name="l01740"></a>01740         len = lstrlenW(fd.cFileName) + 1;
<a name="l01741"></a>01741 
<a name="l01742"></a>01742         <span class="comment">//</span>
<a name="l01743"></a>01743         <span class="comment">// bump the string table size by enough for the</span>
<a name="l01744"></a>01744         <span class="comment">// new name and it&apos;s null terminator</span>
<a name="l01745"></a>01745         <span class="comment">//</span>
<a name="l01746"></a>01746         tmpW = <a class="code" href="../../d5/d11/ripper_8c.html#a1b739878adcdb46fb5d209af7ce79628">realloc</a>(p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#af36b4f06bbb89007becb69eca09e0eaf">start</a>, (idx + len) * <span class="keyword">sizeof</span>(WCHAR));
<a name="l01747"></a>01747         <span class="keywordflow">if</span> (!tmpW) {
<a name="l01748"></a>01748           error:
<a name="l01749"></a>01749             <a class="code" href="../../df/d9c/dir_8h.html#ae31bf3ef5ed353b53d0d70067fe861a1">rb_w32_closedir</a>(p);
<a name="l01750"></a>01750             FindClose(fh);
<a name="l01751"></a>01751             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ENOMEM;
<a name="l01752"></a>01752             <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01753"></a>01753         }
<a name="l01754"></a>01754 
<a name="l01755"></a>01755         p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#af36b4f06bbb89007becb69eca09e0eaf">start</a> = tmpW;
<a name="l01756"></a>01756         memcpy(&amp;p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#af36b4f06bbb89007becb69eca09e0eaf">start</a>[idx], fd.cFileName, len * <span class="keyword">sizeof</span>(WCHAR));
<a name="l01757"></a>01757 
<a name="l01758"></a>01758         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a6ae4cf8b0903426e5aea21eb678c962a">nfiles</a> % <a class="code" href="../../d5/df2/win32_8c.html#a52b3618f623797bff5e19ab95fbcc7e5">DIRENT_PER_CHAR</a> == 0) {
<a name="l01759"></a>01759             tmp = <a class="code" href="../../d5/d11/ripper_8c.html#a1b739878adcdb46fb5d209af7ce79628">realloc</a>(p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a14d5e24384ed343d5ea9f2a314228457">bits</a>, p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a6ae4cf8b0903426e5aea21eb678c962a">nfiles</a> / <a class="code" href="../../d5/df2/win32_8c.html#a52b3618f623797bff5e19ab95fbcc7e5">DIRENT_PER_CHAR</a> + 1);
<a name="l01760"></a>01760             <span class="keywordflow">if</span> (!tmp)
<a name="l01761"></a>01761                 <span class="keywordflow">goto</span> error;
<a name="l01762"></a>01762             p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a14d5e24384ed343d5ea9f2a314228457">bits</a> = tmp;
<a name="l01763"></a>01763             p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a14d5e24384ed343d5ea9f2a314228457">bits</a>[p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a6ae4cf8b0903426e5aea21eb678c962a">nfiles</a> / <a class="code" href="../../d5/df2/win32_8c.html#a52b3618f623797bff5e19ab95fbcc7e5">DIRENT_PER_CHAR</a>] = 0;
<a name="l01764"></a>01764         }
<a name="l01765"></a>01765         <span class="keywordflow">if</span> (fd.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY)
<a name="l01766"></a>01766             <a class="code" href="../../d5/df2/win32_8c.html#a24e9a52e2f9282a56091d84c93f554df">SetBit</a>(p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a14d5e24384ed343d5ea9f2a314228457">bits</a>, <a class="code" href="../../d5/df2/win32_8c.html#a14fc4415922447a0fba361748c812a9a">BitOfIsDir</a>(p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a6ae4cf8b0903426e5aea21eb678c962a">nfiles</a>));
<a name="l01767"></a>01767         <span class="keywordflow">if</span> (fd.dwFileAttributes &amp; FILE_ATTRIBUTE_REPARSE_POINT)
<a name="l01768"></a>01768             <a class="code" href="../../d5/df2/win32_8c.html#a24e9a52e2f9282a56091d84c93f554df">SetBit</a>(p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a14d5e24384ed343d5ea9f2a314228457">bits</a>, <a class="code" href="../../d5/df2/win32_8c.html#aad22df59bee1fc8c8d2185fc084a317f">BitOfIsRep</a>(p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a6ae4cf8b0903426e5aea21eb678c962a">nfiles</a>));
<a name="l01769"></a>01769 
<a name="l01770"></a>01770         p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a6ae4cf8b0903426e5aea21eb678c962a">nfiles</a>++;
<a name="l01771"></a>01771         idx += len;
<a name="l01772"></a>01772     } <span class="keywordflow">while</span> (FindNextFileW(fh, &amp;fd));
<a name="l01773"></a>01773     FindClose(fh);
<a name="l01774"></a>01774     p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a6ba3b7600df9c5c3fd0d1343df724c99">size</a> = idx;
<a name="l01775"></a>01775     p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#afb088781163bc6e8829de9e805e8994d">curr</a> = p-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#af36b4f06bbb89007becb69eca09e0eaf">start</a>;
<a name="l01776"></a>01776     <span class="keywordflow">return</span> p;
<a name="l01777"></a>01777 }
<a name="l01778"></a>01778 
<a name="l01779"></a>01779 <span class="keyword">static</span> <span class="keyword">inline</span> UINT
<a name="l01780"></a><a class="code" href="../../d5/df2/win32_8c.html#a2bd9363d2fc1e7ea0c1efdaa51cee2ce">01780</a> <a class="code" href="../../d5/df2/win32_8c.html#a2bd9363d2fc1e7ea0c1efdaa51cee2ce">filecp</a>(<span class="keywordtype">void</span>)
<a name="l01781"></a>01781 {
<a name="l01782"></a>01782     UINT cp = AreFileApisANSI() ? CP_ACP : CP_OEMCP;
<a name="l01783"></a>01783     <span class="keywordflow">return</span> cp;
<a name="l01784"></a>01784 }
<a name="l01785"></a>01785 
<a name="l01786"></a>01786 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l01787"></a><a class="code" href="../../d5/df2/win32_8c.html#a954a9f23b00ab03c6d64626592743fe1">01787</a> <a class="code" href="../../d5/df2/win32_8c.html#a954a9f23b00ab03c6d64626592743fe1">wstr_to_mbstr</a>(UINT cp, <span class="keyword">const</span> WCHAR *wstr, <span class="keywordtype">int</span> clen, <span class="keywordtype">long</span> *plen)
<a name="l01788"></a>01788 {
<a name="l01789"></a>01789     <span class="keywordtype">char</span> *ptr;
<a name="l01790"></a>01790     <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = WideCharToMultiByte(cp, 0, wstr, clen, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) - 1;
<a name="l01791"></a>01791     <span class="keywordflow">if</span> (!(ptr = <a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(len + 1))) <span class="keywordflow">return</span> 0;
<a name="l01792"></a>01792     WideCharToMultiByte(cp, 0, wstr, clen, ptr, len + 1, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01793"></a>01793     <span class="keywordflow">if</span> (plen) *plen = len;
<a name="l01794"></a>01794     <span class="keywordflow">return</span> ptr;
<a name="l01795"></a>01795 }
<a name="l01796"></a>01796 
<a name="l01797"></a>01797 <span class="keyword">static</span> WCHAR *
<a name="l01798"></a><a class="code" href="../../d5/df2/win32_8c.html#a9a69d9d479103ada5b1083da796eb1d1">01798</a> <a class="code" href="../../d5/df2/win32_8c.html#a9a69d9d479103ada5b1083da796eb1d1">mbstr_to_wstr</a>(UINT cp, <span class="keyword">const</span> <span class="keywordtype">char</span> *str, <span class="keywordtype">int</span> clen, <span class="keywordtype">long</span> *plen)
<a name="l01799"></a>01799 {
<a name="l01800"></a>01800     WCHAR *ptr;
<a name="l01801"></a>01801     <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = MultiByteToWideChar(cp, 0, str, clen, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0) - 1;
<a name="l01802"></a>01802     <span class="keywordflow">if</span> (!(ptr = <a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(WCHAR) * (len + 1)))) <span class="keywordflow">return</span> 0;
<a name="l01803"></a>01803     MultiByteToWideChar(cp, 0, str, clen, ptr, len + 1);
<a name="l01804"></a>01804     <span class="keywordflow">if</span> (plen) *plen = len;
<a name="l01805"></a>01805     <span class="keywordflow">return</span> ptr;
<a name="l01806"></a>01806 }
<a name="l01807"></a>01807 
<a name="l01808"></a>01808 <a class="code" href="../../d9/d31/struct_d_i_r.html">DIR</a> *
<a name="l01809"></a><a class="code" href="../../d5/df2/win32_8c.html#aab8aa62265ba2071b2ce5b853d5c3e6c">01809</a> <a class="code" href="../../df/d9c/dir_8h.html#a6fbbac53e52f16243012e2be7501ab28">rb_w32_opendir</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename)
<a name="l01810"></a>01810 {
<a name="l01811"></a>01811     <a class="code" href="../../d9/d31/struct_d_i_r.html">DIR</a> *ret;
<a name="l01812"></a>01812     WCHAR *wpath = <a class="code" href="../../d5/df2/win32_8c.html#ad33d311f649154599e920240e3900a59">filecp_to_wstr</a>(filename, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01813"></a>01813     <span class="keywordflow">if</span> (!wpath)
<a name="l01814"></a>01814         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01815"></a>01815     ret = <a class="code" href="../../d5/df2/win32_8c.html#accc2699dfe09ed5b34d2f8c37d7ac3c3">opendir_internal</a>(wpath, filename);
<a name="l01816"></a>01816     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wpath);
<a name="l01817"></a>01817     <span class="keywordflow">return</span> ret;
<a name="l01818"></a>01818 }
<a name="l01819"></a>01819 
<a name="l01820"></a>01820 <a class="code" href="../../d9/d31/struct_d_i_r.html">DIR</a> *
<a name="l01821"></a><a class="code" href="../../d5/df2/win32_8c.html#aa3cae8864a6cbed641be0012506efef6">01821</a> <a class="code" href="../../df/d9c/dir_8h.html#a43e78130a7661f04acbec77862bfd2fa">rb_w32_uopendir</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *filename)
<a name="l01822"></a>01822 {
<a name="l01823"></a>01823     <a class="code" href="../../d9/d31/struct_d_i_r.html">DIR</a> *ret;
<a name="l01824"></a>01824     WCHAR *wpath = <a class="code" href="../../d5/df2/win32_8c.html#a41003a1382888cc771e290746769eb13">utf8_to_wstr</a>(filename, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01825"></a>01825     <span class="keywordflow">if</span> (!wpath)
<a name="l01826"></a>01826         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01827"></a>01827     ret = <a class="code" href="../../d5/df2/win32_8c.html#accc2699dfe09ed5b34d2f8c37d7ac3c3">opendir_internal</a>(wpath, filename);
<a name="l01828"></a>01828     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wpath);
<a name="l01829"></a>01829     <span class="keywordflow">return</span> ret;
<a name="l01830"></a>01830 }
<a name="l01831"></a>01831 
<a name="l01832"></a>01832 <span class="comment">//</span>
<a name="l01833"></a>01833 <span class="comment">// Move to next entry</span>
<a name="l01834"></a>01834 <span class="comment">//</span>
<a name="l01835"></a>01835 
<a name="l01836"></a>01836 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01837"></a><a class="code" href="../../d5/df2/win32_8c.html#a8ac8f7d81f6a67d441408ba7316ffd1f">01837</a> <a class="code" href="../../d5/df2/win32_8c.html#a8ac8f7d81f6a67d441408ba7316ffd1f">move_to_next_entry</a>(<a class="code" href="../../d9/d31/struct_d_i_r.html">DIR</a> *dirp)
<a name="l01838"></a>01838 {
<a name="l01839"></a>01839     <span class="keywordflow">if</span> (dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#afb088781163bc6e8829de9e805e8994d">curr</a>) {
<a name="l01840"></a>01840         dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#ae0b803d36935a053b7f993adbaefc6dc">loc</a>++;
<a name="l01841"></a>01841         dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#afb088781163bc6e8829de9e805e8994d">curr</a> += lstrlenW(dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#afb088781163bc6e8829de9e805e8994d">curr</a>) + 1;
<a name="l01842"></a>01842         <span class="keywordflow">if</span> (dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#afb088781163bc6e8829de9e805e8994d">curr</a> &gt;= (dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#af36b4f06bbb89007becb69eca09e0eaf">start</a> + dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a6ba3b7600df9c5c3fd0d1343df724c99">size</a>)) {
<a name="l01843"></a>01843             dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#afb088781163bc6e8829de9e805e8994d">curr</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01844"></a>01844         }
<a name="l01845"></a>01845     }
<a name="l01846"></a>01846 }
<a name="l01847"></a>01847 
<a name="l01848"></a>01848 <span class="comment">//</span>
<a name="l01849"></a>01849 <span class="comment">// Readdir just returns the current string pointer and bumps the</span>
<a name="l01850"></a>01850 <span class="comment">// string pointer to the next entry.</span>
<a name="l01851"></a>01851 <span class="comment">//</span>
<a name="l01852"></a>01852 <span class="keyword">static</span> BOOL
<a name="l01853"></a><a class="code" href="../../d5/df2/win32_8c.html#a043c29181627d8346cd57f879d28cdff">01853</a> <a class="code" href="../../d5/df2/win32_8c.html#a043c29181627d8346cd57f879d28cdff">win32_direct_conv</a>(<span class="keyword">const</span> WCHAR *file, <span class="keyword">struct</span> <a class="code" href="../../d5/dac/structdirect.html">direct</a> *entry, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *dummy)
<a name="l01854"></a>01854 {
<a name="l01855"></a>01855     <span class="keywordflow">if</span> (!(entry-&gt;<a class="code" href="../../d5/dac/structdirect.html#acf4ed12c8f83667a3381bae6b363eb16">d_name</a> = <a class="code" href="../../d5/df2/win32_8c.html#abee1c044ffcd4af5eb42fcdc58091e53">wstr_to_filecp</a>(file, &amp;entry-&gt;<a class="code" href="../../d5/dac/structdirect.html#a33b96ffecc596c93555caa62a4a2b9c9">d_namlen</a>)))
<a name="l01856"></a>01856         <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01857"></a>01857     <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01858"></a>01858 }
<a name="l01859"></a>01859 
<a name="l01860"></a>01860 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01861"></a><a class="code" href="../../d5/df2/win32_8c.html#a6819474e0e7018ff2086dd8ac6ba6fed">01861</a> <a class="code" href="../../d5/df2/win32_8c.html#a6819474e0e7018ff2086dd8ac6ba6fed">rb_w32_conv_from_wchar</a>(<span class="keyword">const</span> WCHAR *wstr, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc)
<a name="l01862"></a>01862 {
<a name="l01863"></a>01863     <span class="keyword">static</span> <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *utf16 = (<a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *)-1;
<a name="l01864"></a>01864     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> src;
<a name="l01865"></a>01865 
<a name="l01866"></a>01866     <span class="keywordflow">if</span> (utf16 == (<a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *)-1) {
<a name="l01867"></a>01867         utf16 = <a class="code" href="../../d5/db5/encoding_8c.html#a67638c695b4079ca5f4b6b4cc22ab27a">rb_enc_find</a>(<span class="stringliteral">&quot;UTF-16LE&quot;</span>);
<a name="l01868"></a>01868         <span class="keywordflow">if</span> (utf16 == <a class="code" href="../../d5/db5/encoding_8c.html#a767d777810f0d48add93857b52057262">rb_ascii8bit_encoding</a>())
<a name="l01869"></a>01869             utf16 = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01870"></a>01870     }
<a name="l01871"></a>01871     <span class="keywordflow">if</span> (!utf16)
<a name="l01872"></a>01872         <span class="comment">/* maybe miniruby */</span>
<a name="l01873"></a>01873         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01874"></a>01874 
<a name="l01875"></a>01875     src = <a class="code" href="../../d5/de3/encoding_8h.html#a6707b730597e0e614213beb11670aca2">rb_enc_str_new</a>((<span class="keywordtype">char</span> *)wstr, lstrlenW(wstr) * <span class="keyword">sizeof</span>(WCHAR), utf16);
<a name="l01876"></a>01876     <span class="keywordflow">return</span> <a class="code" href="../../d5/de3/encoding_8h.html#a92c4c79471eb00ba915287505a118401">rb_str_encode</a>(src, <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(enc), <a class="code" href="../../d5/de3/encoding_8h.html#a4f8674ffeb3e7e562628f54ff0a10f4e">ECONV_UNDEF_REPLACE</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l01877"></a>01877 }
<a name="l01878"></a>01878 
<a name="l01879"></a>01879 <span class="keywordtype">char</span> *
<a name="l01880"></a><a class="code" href="../../d5/df2/win32_8c.html#a187fd94fa44a749fbc1c597a4975c625">01880</a> <a class="code" href="../../d5/df2/win32_8c.html#a187fd94fa44a749fbc1c597a4975c625">rb_w32_conv_from_wstr</a>(<span class="keyword">const</span> WCHAR *wstr, <span class="keywordtype">long</span> *lenp, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc)
<a name="l01881"></a>01881 {
<a name="l01882"></a>01882     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str = <a class="code" href="../../d5/df2/win32_8c.html#a6819474e0e7018ff2086dd8ac6ba6fed">rb_w32_conv_from_wchar</a>(wstr, enc);
<a name="l01883"></a>01883     <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l01884"></a>01884     <span class="keywordtype">char</span> *ptr;
<a name="l01885"></a>01885 
<a name="l01886"></a>01886     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str)) <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#abee1c044ffcd4af5eb42fcdc58091e53">wstr_to_filecp</a>(wstr, lenp);
<a name="l01887"></a>01887     *lenp = len = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str);
<a name="l01888"></a>01888     memcpy(ptr = <a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(len + 1), <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), len);
<a name="l01889"></a>01889     ptr[len] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01890"></a>01890     <span class="keywordflow">return</span> ptr;
<a name="l01891"></a>01891 }
<a name="l01892"></a>01892 
<a name="l01893"></a>01893 <span class="keyword">static</span> BOOL
<a name="l01894"></a><a class="code" href="../../d5/df2/win32_8c.html#afb3f05818f48f671eba1fb4f78e1637d">01894</a> <a class="code" href="../../d5/df2/win32_8c.html#afb3f05818f48f671eba1fb4f78e1637d">ruby_direct_conv</a>(<span class="keyword">const</span> WCHAR *file, <span class="keyword">struct</span> <a class="code" href="../../d5/dac/structdirect.html">direct</a> *entry, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc)
<a name="l01895"></a>01895 {
<a name="l01896"></a>01896     <span class="keywordflow">if</span> (!(entry-&gt;<a class="code" href="../../d5/dac/structdirect.html#acf4ed12c8f83667a3381bae6b363eb16">d_name</a> = <a class="code" href="../../d5/df2/win32_8c.html#a187fd94fa44a749fbc1c597a4975c625">rb_w32_conv_from_wstr</a>(file, &amp;entry-&gt;<a class="code" href="../../d5/dac/structdirect.html#a33b96ffecc596c93555caa62a4a2b9c9">d_namlen</a>, enc)))
<a name="l01897"></a>01897         <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01898"></a>01898     <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01899"></a>01899 }
<a name="l01900"></a>01900 
<a name="l01901"></a>01901 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../d5/dac/structdirect.html">direct</a> *
<a name="l01902"></a><a class="code" href="../../d5/df2/win32_8c.html#a01e7499089289618df185ff9295d5a40">01902</a> <a class="code" href="../../d5/df2/win32_8c.html#a01e7499089289618df185ff9295d5a40">readdir_internal</a>(<a class="code" href="../../d9/d31/struct_d_i_r.html">DIR</a> *dirp, BOOL (*conv)(<span class="keyword">const</span> WCHAR *, <span class="keyword">struct</span> <a class="code" href="../../d5/dac/structdirect.html">direct</a> *, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *), <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc)
<a name="l01903"></a>01903 {
<a name="l01904"></a>01904     <span class="keyword">static</span> <span class="keywordtype">int</span> dummy = 0;
<a name="l01905"></a>01905 
<a name="l01906"></a>01906     <span class="keywordflow">if</span> (dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#afb088781163bc6e8829de9e805e8994d">curr</a>) {
<a name="l01907"></a>01907 
<a name="l01908"></a>01908         <span class="comment">//</span>
<a name="l01909"></a>01909         <span class="comment">// first set up the structure to return</span>
<a name="l01910"></a>01910         <span class="comment">//</span>
<a name="l01911"></a>01911         <span class="keywordflow">if</span> (dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#aff39c7581dc05e2a0647780b13cd3dc4">dirstr</a>.<a class="code" href="../../d5/dac/structdirect.html#acf4ed12c8f83667a3381bae6b363eb16">d_name</a>)
<a name="l01912"></a>01912             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#aff39c7581dc05e2a0647780b13cd3dc4">dirstr</a>.<a class="code" href="../../d5/dac/structdirect.html#acf4ed12c8f83667a3381bae6b363eb16">d_name</a>);
<a name="l01913"></a>01913         conv(dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#afb088781163bc6e8829de9e805e8994d">curr</a>, &amp;dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#aff39c7581dc05e2a0647780b13cd3dc4">dirstr</a>, enc);
<a name="l01914"></a>01914 
<a name="l01915"></a>01915         <span class="comment">//</span>
<a name="l01916"></a>01916         <span class="comment">// Fake inode</span>
<a name="l01917"></a>01917         <span class="comment">//</span>
<a name="l01918"></a>01918         dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#aff39c7581dc05e2a0647780b13cd3dc4">dirstr</a>.<a class="code" href="../../d5/dac/structdirect.html#a5717813345de0db3a18b767264ba4357">d_ino</a> = dummy++;
<a name="l01919"></a>01919 
<a name="l01920"></a>01920         <span class="comment">//</span>
<a name="l01921"></a>01921         <span class="comment">// Attributes</span>
<a name="l01922"></a>01922         <span class="comment">//</span>
<a name="l01923"></a>01923         dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#aff39c7581dc05e2a0647780b13cd3dc4">dirstr</a>.<a class="code" href="../../d5/dac/structdirect.html#a6cd4950a8aa3c77f57521f9f61a4419c">d_isdir</a> = <a class="code" href="../../d5/df2/win32_8c.html#a98024277b48ef9c4a65e73b2ba75f162">GetBit</a>(dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a14d5e24384ed343d5ea9f2a314228457">bits</a>, <a class="code" href="../../d5/df2/win32_8c.html#a14fc4415922447a0fba361748c812a9a">BitOfIsDir</a>(dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#ae0b803d36935a053b7f993adbaefc6dc">loc</a>));
<a name="l01924"></a>01924         dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#aff39c7581dc05e2a0647780b13cd3dc4">dirstr</a>.<a class="code" href="../../d5/dac/structdirect.html#a93f9919adba6547f51bd2f2a016c6499">d_isrep</a> = <a class="code" href="../../d5/df2/win32_8c.html#a98024277b48ef9c4a65e73b2ba75f162">GetBit</a>(dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a14d5e24384ed343d5ea9f2a314228457">bits</a>, <a class="code" href="../../d5/df2/win32_8c.html#aad22df59bee1fc8c8d2185fc084a317f">BitOfIsRep</a>(dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#ae0b803d36935a053b7f993adbaefc6dc">loc</a>));
<a name="l01925"></a>01925 
<a name="l01926"></a>01926         <span class="comment">//</span>
<a name="l01927"></a>01927         <span class="comment">// Now set up for the next call to readdir</span>
<a name="l01928"></a>01928         <span class="comment">//</span>
<a name="l01929"></a>01929 
<a name="l01930"></a>01930         <a class="code" href="../../d5/df2/win32_8c.html#a8ac8f7d81f6a67d441408ba7316ffd1f">move_to_next_entry</a>(dirp);
<a name="l01931"></a>01931 
<a name="l01932"></a>01932         <span class="keywordflow">return</span> &amp;(dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#aff39c7581dc05e2a0647780b13cd3dc4">dirstr</a>);
<a name="l01933"></a>01933 
<a name="l01934"></a>01934     }
<a name="l01935"></a>01935     <span class="keywordflow">else</span>
<a name="l01936"></a>01936         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01937"></a>01937 }
<a name="l01938"></a>01938 
<a name="l01939"></a>01939 <span class="keyword">struct </span><a class="code" href="../../d5/dac/structdirect.html">direct</a>  *
<a name="l01940"></a><a class="code" href="../../d5/df2/win32_8c.html#abd1e5d044bcae0553aff99aafc6336e4">01940</a> <a class="code" href="../../df/d9c/dir_8h.html#a9956bcdb5cd691e5ab6a7790cdb65ebc">rb_w32_readdir</a>(<a class="code" href="../../d9/d31/struct_d_i_r.html">DIR</a> *dirp)
<a name="l01941"></a>01941 {
<a name="l01942"></a>01942     <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#a01e7499089289618df185ff9295d5a40">readdir_internal</a>(dirp, <a class="code" href="../../d5/df2/win32_8c.html#a043c29181627d8346cd57f879d28cdff">win32_direct_conv</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01943"></a>01943 }
<a name="l01944"></a>01944 
<a name="l01945"></a>01945 <span class="keyword">struct </span><a class="code" href="../../d5/dac/structdirect.html">direct</a>  *
<a name="l01946"></a><a class="code" href="../../d5/df2/win32_8c.html#a1a5eef9d6b60e6786a7f0764ab1e03e4">01946</a> <a class="code" href="../../df/d9c/dir_8h.html#a28875c807a4c819daa057c7d031edab9">rb_w32_readdir_with_enc</a>(<a class="code" href="../../d9/d31/struct_d_i_r.html">DIR</a> *dirp, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc)
<a name="l01947"></a>01947 {
<a name="l01948"></a>01948     <span class="keywordflow">if</span> (enc == <a class="code" href="../../d5/db5/encoding_8c.html#a767d777810f0d48add93857b52057262">rb_ascii8bit_encoding</a>())
<a name="l01949"></a>01949         <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#a01e7499089289618df185ff9295d5a40">readdir_internal</a>(dirp, <a class="code" href="../../d5/df2/win32_8c.html#a043c29181627d8346cd57f879d28cdff">win32_direct_conv</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01950"></a>01950     <span class="keywordflow">else</span>
<a name="l01951"></a>01951         <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#a01e7499089289618df185ff9295d5a40">readdir_internal</a>(dirp, <a class="code" href="../../d5/df2/win32_8c.html#afb3f05818f48f671eba1fb4f78e1637d">ruby_direct_conv</a>, enc);
<a name="l01952"></a>01952 }
<a name="l01953"></a>01953 
<a name="l01954"></a>01954 <span class="comment">//</span>
<a name="l01955"></a>01955 <span class="comment">// Telldir returns the current string pointer position</span>
<a name="l01956"></a>01956 <span class="comment">//</span>
<a name="l01957"></a>01957 
<a name="l01958"></a>01958 <span class="keywordtype">long</span>
<a name="l01959"></a><a class="code" href="../../d5/df2/win32_8c.html#a4d0ad30099abf2815a4bfc5354d688bd">01959</a> <a class="code" href="../../df/d9c/dir_8h.html#a55b4c5821e3bdca9028633bdbd9a6f47">rb_w32_telldir</a>(<a class="code" href="../../d9/d31/struct_d_i_r.html">DIR</a> *dirp)
<a name="l01960"></a>01960 {
<a name="l01961"></a>01961     <span class="keywordflow">return</span> dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#ae0b803d36935a053b7f993adbaefc6dc">loc</a>;
<a name="l01962"></a>01962 }
<a name="l01963"></a>01963 
<a name="l01964"></a>01964 <span class="comment">//</span>
<a name="l01965"></a>01965 <span class="comment">// Seekdir moves the string pointer to a previously saved position</span>
<a name="l01966"></a>01966 <span class="comment">// (Saved by telldir).</span>
<a name="l01967"></a>01967 
<a name="l01968"></a>01968 <span class="keywordtype">void</span>
<a name="l01969"></a><a class="code" href="../../d5/df2/win32_8c.html#a8c0dca945c86868edb6e778afdcb9b45">01969</a> <a class="code" href="../../df/d9c/dir_8h.html#a09ed50afd6d17881e995838d7c2fdf8b">rb_w32_seekdir</a>(<a class="code" href="../../d9/d31/struct_d_i_r.html">DIR</a> *dirp, <span class="keywordtype">long</span> loc)
<a name="l01970"></a>01970 {
<a name="l01971"></a>01971     <span class="keywordflow">if</span> (dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#ae0b803d36935a053b7f993adbaefc6dc">loc</a> &gt; loc) <a class="code" href="../../df/d9c/dir_8h.html#af7a405ca7458c56adbe01725dd7a4697">rb_w32_rewinddir</a>(dirp);
<a name="l01972"></a>01972 
<a name="l01973"></a>01973     <span class="keywordflow">while</span> (dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#afb088781163bc6e8829de9e805e8994d">curr</a> &amp;&amp; dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#ae0b803d36935a053b7f993adbaefc6dc">loc</a> &lt; loc) {
<a name="l01974"></a>01974         <a class="code" href="../../d5/df2/win32_8c.html#a8ac8f7d81f6a67d441408ba7316ffd1f">move_to_next_entry</a>(dirp);
<a name="l01975"></a>01975     }
<a name="l01976"></a>01976 }
<a name="l01977"></a>01977 
<a name="l01978"></a>01978 <span class="comment">//</span>
<a name="l01979"></a>01979 <span class="comment">// Rewinddir resets the string pointer to the start</span>
<a name="l01980"></a>01980 <span class="comment">//</span>
<a name="l01981"></a>01981 
<a name="l01982"></a>01982 <span class="keywordtype">void</span>
<a name="l01983"></a><a class="code" href="../../d5/df2/win32_8c.html#a60307c3091e3a38419018d4568fe1207">01983</a> <a class="code" href="../../df/d9c/dir_8h.html#af7a405ca7458c56adbe01725dd7a4697">rb_w32_rewinddir</a>(<a class="code" href="../../d9/d31/struct_d_i_r.html">DIR</a> *dirp)
<a name="l01984"></a>01984 {
<a name="l01985"></a>01985     dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#afb088781163bc6e8829de9e805e8994d">curr</a> = dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#af36b4f06bbb89007becb69eca09e0eaf">start</a>;
<a name="l01986"></a>01986     dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#ae0b803d36935a053b7f993adbaefc6dc">loc</a> = 0;
<a name="l01987"></a>01987 }
<a name="l01988"></a>01988 
<a name="l01989"></a>01989 <span class="comment">//</span>
<a name="l01990"></a>01990 <span class="comment">// This just free&apos;s the memory allocated by opendir</span>
<a name="l01991"></a>01991 <span class="comment">//</span>
<a name="l01992"></a>01992 
<a name="l01993"></a>01993 <span class="keywordtype">void</span>
<a name="l01994"></a><a class="code" href="../../d5/df2/win32_8c.html#a73f8ba37b52101d0e1cb6bf1572f3379">01994</a> <a class="code" href="../../df/d9c/dir_8h.html#ae31bf3ef5ed353b53d0d70067fe861a1">rb_w32_closedir</a>(<a class="code" href="../../d9/d31/struct_d_i_r.html">DIR</a> *dirp)
<a name="l01995"></a>01995 {
<a name="l01996"></a>01996     <span class="keywordflow">if</span> (dirp) {
<a name="l01997"></a>01997         <span class="keywordflow">if</span> (dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#aff39c7581dc05e2a0647780b13cd3dc4">dirstr</a>.<a class="code" href="../../d5/dac/structdirect.html#acf4ed12c8f83667a3381bae6b363eb16">d_name</a>)
<a name="l01998"></a>01998             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#aff39c7581dc05e2a0647780b13cd3dc4">dirstr</a>.<a class="code" href="../../d5/dac/structdirect.html#acf4ed12c8f83667a3381bae6b363eb16">d_name</a>);
<a name="l01999"></a>01999         <span class="keywordflow">if</span> (dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#af36b4f06bbb89007becb69eca09e0eaf">start</a>)
<a name="l02000"></a>02000             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#af36b4f06bbb89007becb69eca09e0eaf">start</a>);
<a name="l02001"></a>02001         <span class="keywordflow">if</span> (dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a14d5e24384ed343d5ea9f2a314228457">bits</a>)
<a name="l02002"></a>02002             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(dirp-&gt;<a class="code" href="../../d9/d31/struct_d_i_r.html#a14d5e24384ed343d5ea9f2a314228457">bits</a>);
<a name="l02003"></a>02003         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(dirp);
<a name="l02004"></a>02004     }
<a name="l02005"></a>02005 }
<a name="l02006"></a>02006 
<a name="l02007"></a>02007 <span class="preprocessor">#if (defined _MT || defined __MSVCRT__) &amp;&amp; !defined __BORLANDC__</span>
<a name="l02008"></a>02008 <span class="preprocessor"></span><span class="preprocessor">#define MSVCRT_THREADS</span>
<a name="l02009"></a>02009 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l02010"></a>02010 <span class="preprocessor"></span><span class="preprocessor">#ifdef MSVCRT_THREADS</span>
<a name="l02011"></a>02011 <span class="preprocessor"></span><span class="preprocessor"># define MTHREAD_ONLY(x) x</span>
<a name="l02012"></a>02012 <span class="preprocessor"></span><span class="preprocessor"># define STHREAD_ONLY(x)</span>
<a name="l02013"></a>02013 <span class="preprocessor"></span><span class="preprocessor">#elif defined(__BORLANDC__)</span>
<a name="l02014"></a>02014 <span class="preprocessor"></span><span class="preprocessor"># define MTHREAD_ONLY(x)</span>
<a name="l02015"></a>02015 <span class="preprocessor"></span><span class="preprocessor"># define STHREAD_ONLY(x)</span>
<a name="l02016"></a>02016 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l02017"></a><a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">02017</a> <span class="preprocessor"></span><span class="preprocessor"># define MTHREAD_ONLY(x)</span>
<a name="l02018"></a><a class="code" href="../../d5/df2/win32_8c.html#a624a5e46b2ca8b21fad79b130a2b1b8c">02018</a> <span class="preprocessor"></span><span class="preprocessor"># define STHREAD_ONLY(x) x</span>
<a name="l02019"></a>02019 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l02020"></a>02020 <span class="preprocessor"></span>
<a name="l02021"></a><a class="code" href="../../d4/d6b/structioinfo.html">02021</a> <span class="keyword">typedef</span> <span class="keyword">struct  </span>{
<a name="l02022"></a><a class="code" href="../../d4/d6b/structioinfo.html#a0078c30ec66583d800efb990d9b0abf7">02022</a>     <a class="code" href="../../dc/db1/win32_8h.html#a0fbe4a4f8dd857ee04923a901f27465f">intptr_t</a> osfhnd;    <span class="comment">/* underlying OS file HANDLE */</span>
<a name="l02023"></a><a class="code" href="../../d4/d6b/structioinfo.html#a05f53c6e27bf84e006907aafb37ad658">02023</a>     <span class="keywordtype">char</span> osfile;        <span class="comment">/* attributes of file (e.g., open in text mode?) */</span>
<a name="l02024"></a><a class="code" href="../../d4/d6b/structioinfo.html#a2daf7216924d5c027f887f8f3f9640cc">02024</a>     <span class="keywordtype">char</span> pipech;        <span class="comment">/* one char buffer for handles opened on pipes */</span>
<a name="l02025"></a>02025 <span class="preprocessor">#ifdef MSVCRT_THREADS</span>
<a name="l02026"></a>02026 <span class="preprocessor"></span>    <span class="keywordtype">int</span> lockinitflag;
<a name="l02027"></a>02027     CRITICAL_SECTION lock;
<a name="l02028"></a>02028 <span class="preprocessor">#endif</span>
<a name="l02029"></a>02029 <span class="preprocessor"></span><span class="preprocessor">#if RT_VER &gt;= 80</span>
<a name="l02030"></a>02030 <span class="preprocessor"></span>    <span class="keywordtype">char</span> textmode;
<a name="l02031"></a>02031     <span class="keywordtype">char</span> pipech2[2];
<a name="l02032"></a>02032 <span class="preprocessor">#endif</span>
<a name="l02033"></a>02033 <span class="preprocessor"></span>}       <a class="code" href="../../d4/d6b/structioinfo.html">ioinfo</a>;
<a name="l02034"></a>02034 
<a name="l02035"></a>02035 <span class="preprocessor">#if !defined _CRTIMP || defined __MINGW32__</span>
<a name="l02036"></a>02036 <span class="preprocessor"></span><span class="preprocessor">#undef _CRTIMP</span>
<a name="l02037"></a><a class="code" href="../../d5/df2/win32_8c.html#ada40f105e9210d5c140cb1036d87d7f3">02037</a> <span class="preprocessor"></span><span class="preprocessor">#define _CRTIMP __declspec(dllimport)</span>
<a name="l02038"></a>02038 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l02039"></a>02039 <span class="preprocessor"></span>
<a name="l02040"></a>02040 <span class="preprocessor">#if !defined(__BORLANDC__)</span>
<a name="l02041"></a><a class="code" href="../../d5/df2/win32_8c.html#a1c77d62498731e92ffde9952f00f3fdd">02041</a> <span class="preprocessor"></span>EXTERN_C <a class="code" href="../../d5/df2/win32_8c.html#ada40f105e9210d5c140cb1036d87d7f3">_CRTIMP</a> <a class="code" href="../../d4/d6b/structioinfo.html">ioinfo</a> * <a class="code" href="../../d5/df2/win32_8c.html#a1c77d62498731e92ffde9952f00f3fdd">__pioinfo</a>[];
<a name="l02042"></a>02042 
<a name="l02043"></a><a class="code" href="../../d5/df2/win32_8c.html#acf01e8de9fe696e267a12472969ba04c">02043</a> <span class="preprocessor">#define IOINFO_L2E                      5</span>
<a name="l02044"></a><a class="code" href="../../d5/df2/win32_8c.html#aabcc0f23ea3e38297954ffc196d8c03b">02044</a> <span class="preprocessor"></span><span class="preprocessor">#define IOINFO_ARRAY_ELTS       (1 &lt;&lt; IOINFO_L2E)</span>
<a name="l02045"></a><a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">02045</a> <span class="preprocessor"></span><span class="preprocessor">#define _pioinfo(i)     ((ioinfo*)((char*)(__pioinfo[i &gt;&gt; IOINFO_L2E]) + (i &amp; (IOINFO_ARRAY_ELTS - 1)) * (sizeof(ioinfo) + pioinfo_extra)))</span>
<a name="l02046"></a><a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">02046</a> <span class="preprocessor"></span><span class="preprocessor">#define _osfhnd(i)  (_pioinfo(i)-&gt;osfhnd)</span>
<a name="l02047"></a><a class="code" href="../../d5/df2/win32_8c.html#a90ead473a170c01aed0fff5c736650f6">02047</a> <span class="preprocessor"></span><span class="preprocessor">#define _osfile(i)  (_pioinfo(i)-&gt;osfile)</span>
<a name="l02048"></a><a class="code" href="../../d5/df2/win32_8c.html#a6a067097e14e1dfcd98e8868bcdfb780">02048</a> <span class="preprocessor"></span><span class="preprocessor">#define _pipech(i)  (_pioinfo(i)-&gt;pipech)</span>
<a name="l02049"></a>02049 <span class="preprocessor"></span>
<a name="l02050"></a>02050 <span class="preprocessor">#if RT_VER &gt;= 80</span>
<a name="l02051"></a>02051 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="../../d5/df2/win32_8c.html#af074b4308cc44cba134559a4e1e50e7a">pioinfo_extra</a> = 0;        <span class="comment">/* workaround for VC++8 SP1 */</span>
<a name="l02052"></a>02052 
<a name="l02053"></a>02053 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02054"></a>02054 set_pioinfo_extra(<span class="keywordtype">void</span>)
<a name="l02055"></a>02055 {
<a name="l02056"></a>02056     <span class="keywordtype">int</span> fd;
<a name="l02057"></a>02057 
<a name="l02058"></a>02058     fd = _open(<span class="stringliteral">&quot;NUL&quot;</span>, O_RDONLY);
<a name="l02059"></a>02059     <span class="keywordflow">for</span> (pioinfo_extra = 0; pioinfo_extra &lt;= 64; pioinfo_extra += <span class="keyword">sizeof</span>(<span class="keywordtype">void</span> *)) {
<a name="l02060"></a>02060         <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd) == _get_osfhandle(fd)) {
<a name="l02061"></a>02061             <span class="keywordflow">break</span>;
<a name="l02062"></a>02062         }
<a name="l02063"></a>02063     }
<a name="l02064"></a>02064     _close(fd);
<a name="l02065"></a>02065 
<a name="l02066"></a>02066     <span class="keywordflow">if</span> (pioinfo_extra &gt; 64) {
<a name="l02067"></a>02067         <span class="comment">/* not found, maybe something wrong... */</span>
<a name="l02068"></a>02068         pioinfo_extra = 0;
<a name="l02069"></a>02069     }
<a name="l02070"></a>02070 }
<a name="l02071"></a>02071 <span class="preprocessor">#else</span>
<a name="l02072"></a><a class="code" href="../../d5/df2/win32_8c.html#af074b4308cc44cba134559a4e1e50e7a">02072</a> <span class="preprocessor"></span><span class="preprocessor">#define pioinfo_extra 0</span>
<a name="l02073"></a>02073 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l02074"></a>02074 <span class="preprocessor"></span>
<a name="l02075"></a><a class="code" href="../../d5/df2/win32_8c.html#ac603bb260657b14e80a08ea0a4f7d72e">02075</a> <span class="preprocessor">#define _set_osfhnd(fh, osfh) (void)(_osfhnd(fh) = osfh)</span>
<a name="l02076"></a><a class="code" href="../../d5/df2/win32_8c.html#a3c63b8defb8d22dccc0c068b3ba6f529">02076</a> <span class="preprocessor"></span><span class="preprocessor">#define _set_osflags(fh, flags) (_osfile(fh) = (flags))</span>
<a name="l02077"></a>02077 <span class="preprocessor"></span>
<a name="l02078"></a><a class="code" href="../../d5/df2/win32_8c.html#a781db24a3e3e56cf3176b85e4c87bf14">02078</a> <span class="preprocessor">#define FOPEN                   0x01    </span><span class="comment">/* file handle open */</span>
<a name="l02079"></a><a class="code" href="../../d5/df2/win32_8c.html#a2fd2fbb4f27ad49ab4292a131a83e27e">02079</a> <span class="preprocessor">#define FEOFLAG                 0x02    </span><span class="comment">/* end of file has been encountered */</span>
<a name="l02080"></a><a class="code" href="../../d5/df2/win32_8c.html#a645a937257c47fd9dd7d8ff239bfad0e">02080</a> <span class="preprocessor">#define FPIPE                   0x08    </span><span class="comment">/* file handle refers to a pipe */</span>
<a name="l02081"></a><a class="code" href="../../d5/df2/win32_8c.html#a9275d22eeeb493620a559a000c210798">02081</a> <span class="preprocessor">#define FNOINHERIT              0x10    </span><span class="comment">/* file handle opened O_NOINHERIT */</span>
<a name="l02082"></a><a class="code" href="../../d5/df2/win32_8c.html#aa336842f710119bfdab086f34efac63c">02082</a> <span class="preprocessor">#define FAPPEND                 0x20    </span><span class="comment">/* file handle opened O_APPEND */</span>
<a name="l02083"></a><a class="code" href="../../d5/df2/win32_8c.html#a9b8e31e24fbc8c8b6223c6130d90999b">02083</a> <span class="preprocessor">#define FDEV                    0x40    </span><span class="comment">/* file handle refers to device */</span>
<a name="l02084"></a><a class="code" href="../../d5/df2/win32_8c.html#ad16d3314e1ed1f0124d728efbd474ad4">02084</a> <span class="preprocessor">#define FTEXT                   0x80    </span><span class="comment">/* file handle is in text mode */</span>
<a name="l02085"></a>02085 
<a name="l02086"></a>02086 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d0a/io_8c.html#a963dc023d760a24b0e23ce29bb583732">is_socket</a>(SOCKET);
<a name="l02087"></a>02087 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d5/df2/win32_8c.html#acb2b68f9f5f884aa1eb0112208debda7">is_console</a>(SOCKET);
<a name="l02088"></a>02088 
<a name="l02089"></a>02089 <span class="keywordtype">int</span>
<a name="l02090"></a><a class="code" href="../../d5/df2/win32_8c.html#addf0171c9e2a256fbfd43e5b3dc31029">02090</a> <a class="code" href="../../dc/db1/win32_8h.html#a995b902a153b39b230bcabde5c07f919">rb_w32_io_cancelable_p</a>(<span class="keywordtype">int</span> fd)
<a name="l02091"></a>02091 {
<a name="l02092"></a>02092     <span class="keywordflow">return</span> cancel_io != <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; (<a class="code" href="../../df/d0a/io_8c.html#a963dc023d760a24b0e23ce29bb583732">is_socket</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(fd)) || !<a class="code" href="../../d5/df2/win32_8c.html#acb2b68f9f5f884aa1eb0112208debda7">is_console</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(fd)));
<a name="l02093"></a>02093 }
<a name="l02094"></a>02094 
<a name="l02095"></a>02095 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02096"></a><a class="code" href="../../d5/df2/win32_8c.html#a4611af37727832d276705e41ed08ecb8">02096</a> <a class="code" href="../../d5/df2/win32_8c.html#a4611af37727832d276705e41ed08ecb8">rb_w32_open_osfhandle</a>(<a class="code" href="../../dc/db1/win32_8h.html#a0fbe4a4f8dd857ee04923a901f27465f">intptr_t</a> osfhandle, <span class="keywordtype">int</span> flags)
<a name="l02097"></a>02097 {
<a name="l02098"></a>02098     <span class="keywordtype">int</span> fh;
<a name="l02099"></a>02099     <span class="keywordtype">char</span> fileflags;             <span class="comment">/* _osfile flags */</span>
<a name="l02100"></a>02100     HANDLE hF;
<a name="l02101"></a>02101 
<a name="l02102"></a>02102     <span class="comment">/* copy relevant flags from second parameter */</span>
<a name="l02103"></a>02103     fileflags = <a class="code" href="../../d5/df2/win32_8c.html#a9b8e31e24fbc8c8b6223c6130d90999b">FDEV</a>;
<a name="l02104"></a>02104 
<a name="l02105"></a>02105     <span class="keywordflow">if</span> (flags &amp; O_APPEND)
<a name="l02106"></a>02106         fileflags |= <a class="code" href="../../d5/df2/win32_8c.html#aa336842f710119bfdab086f34efac63c">FAPPEND</a>;
<a name="l02107"></a>02107 
<a name="l02108"></a>02108     <span class="keywordflow">if</span> (flags &amp; O_TEXT)
<a name="l02109"></a>02109         fileflags |= <a class="code" href="../../d5/df2/win32_8c.html#ad16d3314e1ed1f0124d728efbd474ad4">FTEXT</a>;
<a name="l02110"></a>02110 
<a name="l02111"></a>02111     <span class="keywordflow">if</span> (flags &amp; O_NOINHERIT)
<a name="l02112"></a>02112         fileflags |= <a class="code" href="../../d5/df2/win32_8c.html#a9275d22eeeb493620a559a000c210798">FNOINHERIT</a>;
<a name="l02113"></a>02113 
<a name="l02114"></a>02114     <span class="comment">/* attempt to allocate a C Runtime file handle */</span>
<a name="l02115"></a>02115     hF = CreateFile(<span class="stringliteral">&quot;NUL&quot;</span>, 0, 0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, OPEN_ALWAYS, 0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02116"></a>02116     fh = _open_osfhandle((<a class="code" href="../../dc/db1/win32_8h.html#a0fbe4a4f8dd857ee04923a901f27465f">intptr_t</a>)hF, 0);
<a name="l02117"></a>02117     CloseHandle(hF);
<a name="l02118"></a>02118     <span class="keywordflow">if</span> (fh == -1) {
<a name="l02119"></a>02119         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EMFILE;         <span class="comment">/* too many open files */</span>
<a name="l02120"></a>02120         _doserrno = 0L;         <span class="comment">/* not an OS error */</span>
<a name="l02121"></a>02121     }
<a name="l02122"></a>02122     <span class="keywordflow">else</span> {
<a name="l02123"></a>02123 
<a name="l02124"></a>02124         <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(EnterCriticalSection(&amp;(<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fh)-&gt;lock)));
<a name="l02125"></a>02125         <span class="comment">/* the file is open. now, set the info in _osfhnd array */</span>
<a name="l02126"></a>02126         <a class="code" href="../../d5/df2/win32_8c.html#ac603bb260657b14e80a08ea0a4f7d72e">_set_osfhnd</a>(fh, osfhandle);
<a name="l02127"></a>02127 
<a name="l02128"></a>02128         fileflags |= <a class="code" href="../../d5/df2/win32_8c.html#a781db24a3e3e56cf3176b85e4c87bf14">FOPEN</a>;             <span class="comment">/* mark as open */</span>
<a name="l02129"></a>02129 
<a name="l02130"></a>02130         <a class="code" href="../../d5/df2/win32_8c.html#a3c63b8defb8d22dccc0c068b3ba6f529">_set_osflags</a>(fh, fileflags); <span class="comment">/* set osfile entry */</span>
<a name="l02131"></a>02131         <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fh)-&gt;lock));
<a name="l02132"></a>02132     }
<a name="l02133"></a>02133     <span class="keywordflow">return</span> fh;                  <span class="comment">/* return handle */</span>
<a name="l02134"></a>02134 }
<a name="l02135"></a>02135 
<a name="l02136"></a>02136 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02137"></a><a class="code" href="../../d5/df2/win32_8c.html#a7bcbc2f82c5031d05ac003ef21f7f900">02137</a> <a class="code" href="../../d5/df2/win32_8c.html#a7bcbc2f82c5031d05ac003ef21f7f900">init_stdhandle</a>(<span class="keywordtype">void</span>)
<a name="l02138"></a>02138 {
<a name="l02139"></a>02139     <span class="keywordtype">int</span> nullfd = -1;
<a name="l02140"></a>02140     <span class="keywordtype">int</span> keep = 0;
<a name="l02141"></a>02141 <span class="preprocessor">#define open_null(fd)                                           \</span>
<a name="l02142"></a>02142 <span class="preprocessor">    (((nullfd &lt; 0) ?                                            \</span>
<a name="l02143"></a>02143 <span class="preprocessor">      (nullfd = open(&quot;NUL&quot;, O_RDWR)) : 0),              \</span>
<a name="l02144"></a>02144 <span class="preprocessor">     ((nullfd == (fd)) ? (keep = 1) : dup2(nullfd, fd)),        \</span>
<a name="l02145"></a>02145 <span class="preprocessor">     (fd))</span>
<a name="l02146"></a>02146 <span class="preprocessor"></span>
<a name="l02147"></a>02147     <span class="keywordflow">if</span> (<a class="code" href="../../da/d50/vsnprintf_8c.html#a7aa82a32f4ad97a0107302dae80a2b1e">fileno</a>(stdin) &lt; 0) {
<a name="l02148"></a>02148         stdin-&gt;_file = <a class="code" href="../../d5/df2/win32_8c.html#a1094d53162b8c2a89b465264e91bd3cf">open_null</a>(0);
<a name="l02149"></a>02149     }
<a name="l02150"></a>02150     <span class="keywordflow">else</span> {
<a name="l02151"></a>02151         setmode(<a class="code" href="../../da/d50/vsnprintf_8c.html#a7aa82a32f4ad97a0107302dae80a2b1e">fileno</a>(stdin), <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>);
<a name="l02152"></a>02152     }
<a name="l02153"></a>02153     <span class="keywordflow">if</span> (<a class="code" href="../../da/d50/vsnprintf_8c.html#a7aa82a32f4ad97a0107302dae80a2b1e">fileno</a>(stdout) &lt; 0) {
<a name="l02154"></a>02154         stdout-&gt;_file = <a class="code" href="../../d5/df2/win32_8c.html#a1094d53162b8c2a89b465264e91bd3cf">open_null</a>(1);
<a name="l02155"></a>02155     }
<a name="l02156"></a>02156     <span class="keywordflow">if</span> (<a class="code" href="../../da/d50/vsnprintf_8c.html#a7aa82a32f4ad97a0107302dae80a2b1e">fileno</a>(stderr) &lt; 0) {
<a name="l02157"></a>02157         stderr-&gt;_file = <a class="code" href="../../d5/df2/win32_8c.html#a1094d53162b8c2a89b465264e91bd3cf">open_null</a>(2);
<a name="l02158"></a>02158     }
<a name="l02159"></a>02159     <span class="keywordflow">if</span> (nullfd &gt;= 0 &amp;&amp; !keep) close(nullfd);
<a name="l02160"></a>02160     setvbuf(stderr, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, _IONBF, 0);
<a name="l02161"></a>02161 }
<a name="l02162"></a>02162 <span class="preprocessor">#else</span>
<a name="l02163"></a>02163 <span class="preprocessor"></span>
<a name="l02164"></a>02164 <span class="preprocessor">#define _set_osfhnd(fh, osfh) (void)((fh), (osfh))</span>
<a name="l02165"></a>02165 <span class="preprocessor"></span><span class="preprocessor">#define _set_osflags(fh, flags) (void)((fh), (flags))</span>
<a name="l02166"></a>02166 <span class="preprocessor"></span>
<a name="l02167"></a>02167 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02168"></a>02168 <a class="code" href="../../d5/df2/win32_8c.html#a7bcbc2f82c5031d05ac003ef21f7f900">init_stdhandle</a>(<span class="keywordtype">void</span>)
<a name="l02169"></a>02169 {
<a name="l02170"></a>02170 }
<a name="l02171"></a>02171 <span class="preprocessor">#endif</span>
<a name="l02172"></a>02172 <span class="preprocessor"></span>
<a name="l02173"></a>02173 <span class="preprocessor">#ifdef __BORLANDC__</span>
<a name="l02174"></a>02174 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02175"></a>02175 <a class="code" href="../../d5/df2/win32_8c.html#a4611af37727832d276705e41ed08ecb8">rb_w32_open_osfhandle</a>(<a class="code" href="../../dc/db1/win32_8h.html#a0fbe4a4f8dd857ee04923a901f27465f">intptr_t</a> osfhandle, <span class="keywordtype">int</span> flags)
<a name="l02176"></a>02176 {
<a name="l02177"></a>02177     <span class="keywordtype">int</span> fd = _open_osfhandle(osfhandle, flags);
<a name="l02178"></a>02178     <span class="keywordflow">if</span> (fd == -1) {
<a name="l02179"></a>02179         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EMFILE;         <span class="comment">/* too many open files */</span>
<a name="l02180"></a>02180         _doserrno = 0L;         <span class="comment">/* not an OS error */</span>
<a name="l02181"></a>02181     }
<a name="l02182"></a>02182     <span class="keywordflow">return</span> fd;
<a name="l02183"></a>02183 }
<a name="l02184"></a>02184 <span class="preprocessor">#endif</span>
<a name="l02185"></a>02185 <span class="preprocessor"></span>
<a name="l02186"></a>02186 <span class="preprocessor">#undef getsockopt</span>
<a name="l02187"></a>02187 <span class="preprocessor"></span>
<a name="l02188"></a>02188 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02189"></a><a class="code" href="../../d5/df2/win32_8c.html#ae68d041f2a89ee9bd19821ef30b29d6c">02189</a> <a class="code" href="../../df/d0a/io_8c.html#a963dc023d760a24b0e23ce29bb583732">is_socket</a>(SOCKET sock)
<a name="l02190"></a>02190 {
<a name="l02191"></a>02191     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(socklist, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)sock, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))
<a name="l02192"></a>02192         <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02193"></a>02193     <span class="keywordflow">else</span>
<a name="l02194"></a>02194         <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02195"></a>02195 }
<a name="l02196"></a>02196 
<a name="l02197"></a>02197 <span class="keywordtype">int</span>
<a name="l02198"></a><a class="code" href="../../d5/df2/win32_8c.html#ab216cc35920aa6d81afe200f27ffed3f">02198</a> <a class="code" href="../../dc/db1/win32_8h.html#a18c476eddf995031a14c536a70aa5820">rb_w32_is_socket</a>(<span class="keywordtype">int</span> fd)
<a name="l02199"></a>02199 {
<a name="l02200"></a>02200     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a963dc023d760a24b0e23ce29bb583732">is_socket</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(fd));
<a name="l02201"></a>02201 }
<a name="l02202"></a>02202 
<a name="l02203"></a>02203 <span class="comment">//</span>
<a name="l02204"></a>02204 <span class="comment">// Since the errors returned by the socket error function</span>
<a name="l02205"></a>02205 <span class="comment">// WSAGetLastError() are not known by the library routine strerror</span>
<a name="l02206"></a>02206 <span class="comment">// we have to roll our own.</span>
<a name="l02207"></a>02207 <span class="comment">//</span>
<a name="l02208"></a>02208 
<a name="l02209"></a>02209 <span class="preprocessor">#undef strerror</span>
<a name="l02210"></a>02210 <span class="preprocessor"></span>
<a name="l02211"></a>02211 <span class="keywordtype">char</span> *
<a name="l02212"></a><a class="code" href="../../d5/df2/win32_8c.html#a0d829bcc1fb808382e81323c4098a1eb">02212</a> <a class="code" href="../../dc/db1/win32_8h.html#a94ab663c6f5feedb7fdc4fa454a71060">rb_w32_strerror</a>(<span class="keywordtype">int</span> e)
<a name="l02213"></a>02213 {
<a name="l02214"></a>02214     <span class="keyword">static</span> <span class="keywordtype">char</span> buffer[512];
<a name="l02215"></a>02215     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> source = 0;
<a name="l02216"></a>02216     <span class="keywordtype">char</span> *p;
<a name="l02217"></a>02217 
<a name="l02218"></a>02218 <span class="preprocessor">#if defined __BORLANDC__ &amp;&amp; defined ENOTEMPTY // _sys_errlist is broken</span>
<a name="l02219"></a>02219 <span class="preprocessor"></span>    <span class="keywordflow">switch</span> (e) {
<a name="l02220"></a>02220       <span class="keywordflow">case</span> ENAMETOOLONG:
<a name="l02221"></a>02221         <span class="keywordflow">return</span> <span class="stringliteral">&quot;Filename too long&quot;</span>;
<a name="l02222"></a>02222       <span class="keywordflow">case</span> ENOTEMPTY:
<a name="l02223"></a>02223         <span class="keywordflow">return</span> <span class="stringliteral">&quot;Directory not empty&quot;</span>;
<a name="l02224"></a>02224     }
<a name="l02225"></a>02225 <span class="preprocessor">#endif</span>
<a name="l02226"></a>02226 <span class="preprocessor"></span>
<a name="l02227"></a>02227     <span class="keywordflow">if</span> (e &lt; 0 || e &gt; <a class="code" href="../../d5/d04/strerror_8c.html#a560e1e3acaca1d09a7eddcdb528ed92e">sys_nerr</a>) {
<a name="l02228"></a>02228         <span class="keywordflow">if</span> (e &lt; 0)
<a name="l02229"></a>02229             e = GetLastError();
<a name="l02230"></a>02230 <span class="preprocessor">#if WSAEWOULDBLOCK != EWOULDBLOCK</span>
<a name="l02231"></a>02231 <span class="preprocessor"></span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (e &gt;= <a class="code" href="../../dc/db1/win32_8h.html#a61676e39b42371c65c3b960a91887b03">EADDRINUSE</a> &amp;&amp; e &lt;= <a class="code" href="../../dd/d8c/rubysocket_8h.html#a4a3a0b3605fd3b2336455062ee8e25f0">EWOULDBLOCK</a>) {
<a name="l02232"></a>02232             <span class="keyword">static</span> <span class="keywordtype">int</span> s = -1;
<a name="l02233"></a>02233             <span class="keywordtype">int</span> i;
<a name="l02234"></a>02234             <span class="keywordflow">if</span> (s &lt; 0)
<a name="l02235"></a>02235                 <span class="keywordflow">for</span> (s = 0; s &lt; (int)(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/df2/win32_8c.html#a8eeb395117b28ddd44211f8d4b7e713e">errmap</a>)/<span class="keyword">sizeof</span>(*<a class="code" href="../../d5/df2/win32_8c.html#a8eeb395117b28ddd44211f8d4b7e713e">errmap</a>)); s++)
<a name="l02236"></a>02236                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a8eeb395117b28ddd44211f8d4b7e713e">errmap</a>[s].<a class="code" href="../../d5/df2/win32_8c.html#ae2d1336e4cb955b0b6e438fa8c7a7113">winerr</a> == WSAEWOULDBLOCK)
<a name="l02237"></a>02237                         <span class="keywordflow">break</span>;
<a name="l02238"></a>02238             <span class="keywordflow">for</span> (i = s; i &lt; (int)(<span class="keyword">sizeof</span>(<a class="code" href="../../d5/df2/win32_8c.html#a8eeb395117b28ddd44211f8d4b7e713e">errmap</a>)/<span class="keyword">sizeof</span>(*errmap)); i++)
<a name="l02239"></a>02239                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a8eeb395117b28ddd44211f8d4b7e713e">errmap</a>[i].<a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a> == e) {
<a name="l02240"></a>02240                     e = <a class="code" href="../../d5/df2/win32_8c.html#a8eeb395117b28ddd44211f8d4b7e713e">errmap</a>[i].winerr;
<a name="l02241"></a>02241                     <span class="keywordflow">break</span>;
<a name="l02242"></a>02242                 }
<a name="l02243"></a>02243         }
<a name="l02244"></a>02244 <span class="preprocessor">#endif</span>
<a name="l02245"></a>02245 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (FormatMessage(FORMAT_MESSAGE_FROM_SYSTEM |
<a name="l02246"></a>02246                           FORMAT_MESSAGE_IGNORE_INSERTS, &amp;source, e,
<a name="l02247"></a>02247                           MAKELANGID(LANG_ENGLISH, SUBLANG_ENGLISH_US),
<a name="l02248"></a>02248                           buffer, <span class="keyword">sizeof</span>(buffer), <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) == 0 &amp;&amp;
<a name="l02249"></a>02249             FormatMessage(FORMAT_MESSAGE_FROM_SYSTEM |
<a name="l02250"></a>02250                           FORMAT_MESSAGE_IGNORE_INSERTS, &amp;source, e, 0,
<a name="l02251"></a>02251                           buffer, <span class="keyword">sizeof</span>(buffer), <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) == 0)
<a name="l02252"></a>02252             <a class="code" href="../../d3/d90/missing_8h.html#ae18161b919a8cf237d27f8aac700d80c">strlcpy</a>(buffer, <span class="stringliteral">&quot;Unknown Error&quot;</span>, <span class="keyword">sizeof</span>(buffer));
<a name="l02253"></a>02253     }
<a name="l02254"></a>02254     <span class="keywordflow">else</span>
<a name="l02255"></a>02255         <a class="code" href="../../d3/d90/missing_8h.html#ae18161b919a8cf237d27f8aac700d80c">strlcpy</a>(buffer, <a class="code" href="../../d3/d90/missing_8h.html#afd46339e0e35acab03772ba959071313">strerror</a>(e), <span class="keyword">sizeof</span>(buffer));
<a name="l02256"></a>02256 
<a name="l02257"></a>02257     p = buffer;
<a name="l02258"></a>02258     <span class="keywordflow">while</span> ((p = strpbrk(p, <span class="stringliteral">&quot;\r\n&quot;</span>)) != <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l02259"></a>02259         <a class="code" href="../../d3/d90/missing_8h.html#a809a3e9326a0d3e5aa549b17085b057d">memmove</a>(p, p + 1, <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(p));
<a name="l02260"></a>02260     }
<a name="l02261"></a>02261     <span class="keywordflow">return</span> buffer;
<a name="l02262"></a>02262 }
<a name="l02263"></a>02263 
<a name="l02264"></a>02264 <span class="comment">//</span>
<a name="l02265"></a>02265 <span class="comment">// various stubs</span>
<a name="l02266"></a>02266 <span class="comment">//</span>
<a name="l02267"></a>02267 
<a name="l02268"></a>02268 
<a name="l02269"></a>02269 <span class="comment">// Ownership</span>
<a name="l02270"></a>02270 <span class="comment">//</span>
<a name="l02271"></a>02271 <span class="comment">// Just pretend that everyone is a superuser. NT will let us know if</span>
<a name="l02272"></a>02272 <span class="comment">// we don&apos;t really have permission to do something.</span>
<a name="l02273"></a>02273 <span class="comment">//</span>
<a name="l02274"></a>02274 
<a name="l02275"></a><a class="code" href="../../d5/df2/win32_8c.html#a831d805b09c0a53d82eda46406ff6639">02275</a> <span class="preprocessor">#define ROOT_UID        0</span>
<a name="l02276"></a><a class="code" href="../../d5/df2/win32_8c.html#abe87a1fda55b0594dfe813e9f504ebfd">02276</a> <span class="preprocessor"></span><span class="preprocessor">#define ROOT_GID        0</span>
<a name="l02277"></a>02277 <span class="preprocessor"></span>
<a name="l02278"></a>02278 rb_uid_t
<a name="l02279"></a><a class="code" href="../../d5/df2/win32_8c.html#a2a3c17f15a0d34a8bba3277bfef2f56b">02279</a> <a class="code" href="../../dc/db1/win32_8h.html#a2a3c17f15a0d34a8bba3277bfef2f56b">getuid</a>(<span class="keywordtype">void</span>)
<a name="l02280"></a>02280 {
<a name="l02281"></a>02281         <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#a831d805b09c0a53d82eda46406ff6639">ROOT_UID</a>;
<a name="l02282"></a>02282 }
<a name="l02283"></a>02283 
<a name="l02284"></a>02284 rb_uid_t
<a name="l02285"></a><a class="code" href="../../d5/df2/win32_8c.html#a562a0feffc13c71832ee590ba902deed">02285</a> <a class="code" href="../../dc/db1/win32_8h.html#a562a0feffc13c71832ee590ba902deed">geteuid</a>(<span class="keywordtype">void</span>)
<a name="l02286"></a>02286 {
<a name="l02287"></a>02287         <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#a831d805b09c0a53d82eda46406ff6639">ROOT_UID</a>;
<a name="l02288"></a>02288 }
<a name="l02289"></a>02289 
<a name="l02290"></a>02290 rb_gid_t
<a name="l02291"></a><a class="code" href="../../d5/df2/win32_8c.html#aff700a9c53273ce5d774f5e9bfd706d3">02291</a> <a class="code" href="../../dc/db1/win32_8h.html#aff700a9c53273ce5d774f5e9bfd706d3">getgid</a>(<span class="keywordtype">void</span>)
<a name="l02292"></a>02292 {
<a name="l02293"></a>02293         <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#abe87a1fda55b0594dfe813e9f504ebfd">ROOT_GID</a>;
<a name="l02294"></a>02294 }
<a name="l02295"></a>02295 
<a name="l02296"></a>02296 rb_gid_t
<a name="l02297"></a><a class="code" href="../../d5/df2/win32_8c.html#aadcb5f82638d8002839ca37508e43616">02297</a> <a class="code" href="../../dc/db1/win32_8h.html#aadcb5f82638d8002839ca37508e43616">getegid</a>(<span class="keywordtype">void</span>)
<a name="l02298"></a>02298 {
<a name="l02299"></a>02299     <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#abe87a1fda55b0594dfe813e9f504ebfd">ROOT_GID</a>;
<a name="l02300"></a>02300 }
<a name="l02301"></a>02301 
<a name="l02302"></a>02302 <span class="keywordtype">int</span>
<a name="l02303"></a><a class="code" href="../../d5/df2/win32_8c.html#ae913f55261b102e4a38067ed5e7a6249">02303</a> <a class="code" href="../../dc/db1/win32_8h.html#a3bef852c94b7745f63a32a875dab7869">setuid</a>(rb_uid_t uid)
<a name="l02304"></a>02304 {
<a name="l02305"></a>02305     <span class="keywordflow">return</span> (uid == <a class="code" href="../../d5/df2/win32_8c.html#a831d805b09c0a53d82eda46406ff6639">ROOT_UID</a> ? 0 : -1);
<a name="l02306"></a>02306 }
<a name="l02307"></a>02307 
<a name="l02308"></a>02308 <span class="keywordtype">int</span>
<a name="l02309"></a><a class="code" href="../../d5/df2/win32_8c.html#a10842cdb4863687ce89650db8e65a036">02309</a> <a class="code" href="../../dc/db1/win32_8h.html#a2ba8bd3d878047e56a5117752c9aae82">setgid</a>(rb_gid_t gid)
<a name="l02310"></a>02310 {
<a name="l02311"></a>02311     <span class="keywordflow">return</span> (gid == <a class="code" href="../../d5/df2/win32_8c.html#abe87a1fda55b0594dfe813e9f504ebfd">ROOT_GID</a> ? 0 : -1);
<a name="l02312"></a>02312 }
<a name="l02313"></a>02313 
<a name="l02314"></a>02314 <span class="comment">//</span>
<a name="l02315"></a>02315 <span class="comment">// File system stuff</span>
<a name="l02316"></a>02316 <span class="comment">//</span>
<a name="l02317"></a>02317 
<a name="l02318"></a>02318 <span class="keywordtype">int</span>
<a name="l02319"></a><a class="code" href="../../d5/df2/win32_8c.html#a2e64a40a05a857b22b4f58740cedcbf4">02319</a> <a class="code" href="../../dc/db1/win32_8h.html#ae3a230c65883ec8edc50e3a09ca80003">ioctl</a>(<span class="keywordtype">int</span> i, <span class="keywordtype">int</span> u, ...)
<a name="l02320"></a>02320 {
<a name="l02321"></a>02321     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l02322"></a>02322     <span class="keywordflow">return</span> -1;
<a name="l02323"></a>02323 }
<a name="l02324"></a>02324 
<a name="l02325"></a>02325 <span class="keywordtype">void</span>
<a name="l02326"></a><a class="code" href="../../d5/df2/win32_8c.html#a919c1b87762840a46fd437f06cd85fb3">02326</a> <a class="code" href="../../dc/db1/win32_8h.html#a695175c69ad9dfdc814a6cc5dcd2ff94">rb_w32_fdset</a>(<span class="keywordtype">int</span> fd, fd_set *<span class="keyword">set</span>)
<a name="l02327"></a>02327 {
<a name="l02328"></a>02328     <a class="code" href="../../dc/db1/win32_8h.html#ac9a6234e30e3cb64542eca6dab921a93">FD_SET</a>(fd, <span class="keyword">set</span>);
<a name="l02329"></a>02329 }
<a name="l02330"></a>02330 
<a name="l02331"></a>02331 <span class="preprocessor">#undef FD_CLR</span>
<a name="l02332"></a>02332 <span class="preprocessor"></span>
<a name="l02333"></a>02333 <span class="keywordtype">void</span>
<a name="l02334"></a><a class="code" href="../../d5/df2/win32_8c.html#afb934b9f4d15b11a6bc6347450249d50">02334</a> <a class="code" href="../../dc/db1/win32_8h.html#a3b10db5e2732454c87aedf4f7c0417fe">rb_w32_fdclr</a>(<span class="keywordtype">int</span> fd, fd_set *<span class="keyword">set</span>)
<a name="l02335"></a>02335 {
<a name="l02336"></a>02336     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l02337"></a>02337     SOCKET s = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(fd);
<a name="l02338"></a>02338 
<a name="l02339"></a>02339     <span class="keywordflow">for</span> (i = 0; i &lt; <span class="keyword">set</span>-&gt;fd_count; i++) {
<a name="l02340"></a>02340         <span class="keywordflow">if</span> (set-&gt;fd_array[i] == s) {
<a name="l02341"></a>02341             <a class="code" href="../../d3/d90/missing_8h.html#a809a3e9326a0d3e5aa549b17085b057d">memmove</a>(&amp;set-&gt;fd_array[i], &amp;set-&gt;fd_array[i+1],
<a name="l02342"></a>02342                     <span class="keyword">sizeof</span>(set-&gt;fd_array[0]) * (--set-&gt;fd_count - i));
<a name="l02343"></a>02343             <span class="keywordflow">break</span>;
<a name="l02344"></a>02344         }
<a name="l02345"></a>02345     }
<a name="l02346"></a>02346 }
<a name="l02347"></a>02347 
<a name="l02348"></a>02348 <span class="preprocessor">#undef FD_ISSET</span>
<a name="l02349"></a>02349 <span class="preprocessor"></span>
<a name="l02350"></a>02350 <span class="keywordtype">int</span>
<a name="l02351"></a><a class="code" href="../../d5/df2/win32_8c.html#af18eb50a232118a029082cdacb91e9e8">02351</a> <a class="code" href="../../dc/db1/win32_8h.html#a65d70007cd25261edc953fcb5419a090">rb_w32_fdisset</a>(<span class="keywordtype">int</span> fd, fd_set *<span class="keyword">set</span>)
<a name="l02352"></a>02352 {
<a name="l02353"></a>02353     <span class="keywordtype">int</span> ret;
<a name="l02354"></a>02354     SOCKET s = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(fd);
<a name="l02355"></a>02355     <span class="keywordflow">if</span> (s == (SOCKET)INVALID_HANDLE_VALUE)
<a name="l02356"></a>02356         <span class="keywordflow">return</span> 0;
<a name="l02357"></a>02357     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>(ret = __WSAFDIsSet(s, <span class="keyword">set</span>));
<a name="l02358"></a>02358     <span class="keywordflow">return</span> ret;
<a name="l02359"></a>02359 }
<a name="l02360"></a>02360 
<a name="l02361"></a>02361 <span class="keywordtype">void</span>
<a name="l02362"></a><a class="code" href="../../d5/df2/win32_8c.html#a7dc582c0420017978d03962c13a5cc3c">02362</a> <a class="code" href="../../d5/df2/win32_8c.html#a7dc582c0420017978d03962c13a5cc3c">rb_w32_fd_copy</a>(<a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> *dst, <span class="keyword">const</span> fd_set *src, <span class="keywordtype">int</span> <a class="code" href="../../d1/d6f/date__strftime_8c.html#aa5d960354774dc177393b360c0f90aa9">max</a>)
<a name="l02363"></a>02363 {
<a name="l02364"></a>02364     max = <a class="code" href="../../d1/d6f/date__strftime_8c.html#a2f2bf96d77a187bd4446b4ba3864470d">min</a>(src-&gt;fd_count, (UINT)max);
<a name="l02365"></a>02365     <span class="keywordflow">if</span> ((UINT)dst-&gt;capa &lt; (UINT)max) {
<a name="l02366"></a>02366         dst-&gt;capa = (src-&gt;fd_count / <a class="code" href="../../dc/d92/fd__setsize_8c.html#a86c5dbf5a99358e288f573d6a1e0873f">FD_SETSIZE</a> + 1) * <a class="code" href="../../dc/d92/fd__setsize_8c.html#a86c5dbf5a99358e288f573d6a1e0873f">FD_SETSIZE</a>;
<a name="l02367"></a>02367         dst-&gt;fdset = <a class="code" href="../../d8/db0/defines_8h.html#a40740062faf2d95d4935112447c464ef">xrealloc</a>(dst-&gt;fdset, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) + <span class="keyword">sizeof</span>(SOCKET) * dst-&gt;capa);
<a name="l02368"></a>02368     }
<a name="l02369"></a>02369 
<a name="l02370"></a>02370     memcpy(dst-&gt;fdset-&gt;fd_array, src-&gt;fd_array,
<a name="l02371"></a>02371            max * <span class="keyword">sizeof</span>(src-&gt;fd_array[0]));
<a name="l02372"></a>02372     dst-&gt;fdset-&gt;fd_count = src-&gt;fd_count;
<a name="l02373"></a>02373 }
<a name="l02374"></a>02374 
<a name="l02375"></a>02375 <span class="comment">/* License: Ruby&apos;s */</span>
<a name="l02376"></a>02376 <span class="keywordtype">void</span>
<a name="l02377"></a><a class="code" href="../../d5/df2/win32_8c.html#a2446577e6533cc8a1a2168bdce910025">02377</a> <a class="code" href="../../d5/df2/win32_8c.html#a2446577e6533cc8a1a2168bdce910025">rb_w32_fd_dup</a>(<a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> *dst, <span class="keyword">const</span> <a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> *src)
<a name="l02378"></a>02378 {
<a name="l02379"></a>02379     <span class="keywordflow">if</span> ((UINT)dst-&gt;capa &lt; src-&gt;fdset-&gt;fd_count) {
<a name="l02380"></a>02380         dst-&gt;capa = (src-&gt;fdset-&gt;fd_count / <a class="code" href="../../dc/d92/fd__setsize_8c.html#a86c5dbf5a99358e288f573d6a1e0873f">FD_SETSIZE</a> + 1) * <a class="code" href="../../dc/d92/fd__setsize_8c.html#a86c5dbf5a99358e288f573d6a1e0873f">FD_SETSIZE</a>;
<a name="l02381"></a>02381         dst-&gt;fdset = <a class="code" href="../../d8/db0/defines_8h.html#a40740062faf2d95d4935112447c464ef">xrealloc</a>(dst-&gt;fdset, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) + <span class="keyword">sizeof</span>(SOCKET) * dst-&gt;capa);
<a name="l02382"></a>02382     }
<a name="l02383"></a>02383 
<a name="l02384"></a>02384     memcpy(dst-&gt;fdset-&gt;fd_array, src-&gt;fdset-&gt;fd_array,
<a name="l02385"></a>02385            src-&gt;fdset-&gt;fd_count * <span class="keyword">sizeof</span>(src-&gt;fdset-&gt;fd_array[0]));
<a name="l02386"></a>02386     dst-&gt;fdset-&gt;fd_count = src-&gt;fdset-&gt;fd_count;
<a name="l02387"></a>02387 }
<a name="l02388"></a>02388 
<a name="l02389"></a>02389 <span class="comment">//</span>
<a name="l02390"></a>02390 <span class="comment">// Networking trampolines</span>
<a name="l02391"></a>02391 <span class="comment">// These are used to avoid socket startup/shutdown overhead in case</span>
<a name="l02392"></a>02392 <span class="comment">// the socket routines aren&apos;t used.</span>
<a name="l02393"></a>02393 <span class="comment">//</span>
<a name="l02394"></a>02394 
<a name="l02395"></a>02395 <span class="preprocessor">#undef select</span>
<a name="l02396"></a>02396 <span class="preprocessor"></span>
<a name="l02397"></a>02397 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02398"></a><a class="code" href="../../d5/df2/win32_8c.html#a327fd5616806a4506d8a1105dcd8edd8">02398</a> <a class="code" href="../../d5/df2/win32_8c.html#a327fd5616806a4506d8a1105dcd8edd8">extract_fd</a>(<a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> *dst, fd_set *src, <span class="keywordtype">int</span> (*<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a>)(SOCKET))
<a name="l02399"></a>02399 {
<a name="l02400"></a>02400     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> s = 0;
<a name="l02401"></a>02401     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> m = 0;
<a name="l02402"></a>02402     <span class="keywordflow">if</span> (!src) <span class="keywordflow">return</span> 0;
<a name="l02403"></a>02403 
<a name="l02404"></a>02404     <span class="keywordflow">while</span> (s &lt; src-&gt;fd_count) {
<a name="l02405"></a>02405         SOCKET fd = src-&gt;fd_array[s];
<a name="l02406"></a>02406 
<a name="l02407"></a>02407         <span class="keywordflow">if</span> (!<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a> || (*<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a>)(fd)) {
<a name="l02408"></a>02408             <span class="keywordflow">if</span> (dst) { <span class="comment">/* move it to dst */</span>
<a name="l02409"></a>02409                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d;
<a name="l02410"></a>02410 
<a name="l02411"></a>02411                 <span class="keywordflow">for</span> (d = 0; d &lt; dst-&gt;fdset-&gt;fd_count; d++) {
<a name="l02412"></a>02412                     <span class="keywordflow">if</span> (dst-&gt;fdset-&gt;fd_array[d] == fd)
<a name="l02413"></a>02413                         <span class="keywordflow">break</span>;
<a name="l02414"></a>02414                 }
<a name="l02415"></a>02415                 <span class="keywordflow">if</span> (d == dst-&gt;fdset-&gt;fd_count) {
<a name="l02416"></a>02416                     <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)dst-&gt;fdset-&gt;fd_count &gt;= dst-&gt;capa) {
<a name="l02417"></a>02417                         dst-&gt;capa = (dst-&gt;fdset-&gt;fd_count / <a class="code" href="../../dc/d92/fd__setsize_8c.html#a86c5dbf5a99358e288f573d6a1e0873f">FD_SETSIZE</a> + 1) * <a class="code" href="../../dc/d92/fd__setsize_8c.html#a86c5dbf5a99358e288f573d6a1e0873f">FD_SETSIZE</a>;
<a name="l02418"></a>02418                         dst-&gt;fdset = <a class="code" href="../../d8/db0/defines_8h.html#a40740062faf2d95d4935112447c464ef">xrealloc</a>(dst-&gt;fdset, <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) + <span class="keyword">sizeof</span>(SOCKET) * dst-&gt;capa);
<a name="l02419"></a>02419                     }
<a name="l02420"></a>02420                     dst-&gt;fdset-&gt;fd_array[dst-&gt;fdset-&gt;fd_count++] = fd;
<a name="l02421"></a>02421                 }
<a name="l02422"></a>02422                 <a class="code" href="../../d3/d90/missing_8h.html#a809a3e9326a0d3e5aa549b17085b057d">memmove</a>(
<a name="l02423"></a>02423                     &amp;src-&gt;fd_array[s],
<a name="l02424"></a>02424                     &amp;src-&gt;fd_array[s+1],
<a name="l02425"></a>02425                     <span class="keyword">sizeof</span>(src-&gt;fd_array[0]) * (--src-&gt;fd_count - s));
<a name="l02426"></a>02426             }
<a name="l02427"></a>02427             <span class="keywordflow">else</span> {
<a name="l02428"></a>02428                 m++;
<a name="l02429"></a>02429                 s++;
<a name="l02430"></a>02430             }
<a name="l02431"></a>02431         }
<a name="l02432"></a>02432         <span class="keywordflow">else</span> s++;
<a name="l02433"></a>02433     }
<a name="l02434"></a>02434 
<a name="l02435"></a>02435     <span class="keywordflow">return</span> dst ? dst-&gt;fdset-&gt;fd_count : m;
<a name="l02436"></a>02436 }
<a name="l02437"></a>02437 
<a name="l02438"></a>02438 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02439"></a><a class="code" href="../../d5/df2/win32_8c.html#ac4c197c22f7c370272b2ffb19788c164">02439</a> <a class="code" href="../../d5/df2/win32_8c.html#ac4c197c22f7c370272b2ffb19788c164">copy_fd</a>(fd_set *dst, fd_set *src)
<a name="l02440"></a>02440 {
<a name="l02441"></a>02441     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> s;
<a name="l02442"></a>02442     <span class="keywordflow">if</span> (!src || !dst) <span class="keywordflow">return</span> 0;
<a name="l02443"></a>02443 
<a name="l02444"></a>02444     <span class="keywordflow">for</span> (s = 0; s &lt; src-&gt;fd_count; ++s) {
<a name="l02445"></a>02445         SOCKET fd = src-&gt;fd_array[s];
<a name="l02446"></a>02446         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> d;
<a name="l02447"></a>02447         <span class="keywordflow">for</span> (d = 0; d &lt; dst-&gt;fd_count; ++d) {
<a name="l02448"></a>02448             <span class="keywordflow">if</span> (dst-&gt;fd_array[d] == fd)
<a name="l02449"></a>02449                 <span class="keywordflow">break</span>;
<a name="l02450"></a>02450         }
<a name="l02451"></a>02451         <span class="keywordflow">if</span> (d == dst-&gt;fd_count &amp;&amp; d &lt; <a class="code" href="../../dc/d92/fd__setsize_8c.html#a86c5dbf5a99358e288f573d6a1e0873f">FD_SETSIZE</a>) {
<a name="l02452"></a>02452             dst-&gt;fd_array[dst-&gt;fd_count++] = fd;
<a name="l02453"></a>02453         }
<a name="l02454"></a>02454     }
<a name="l02455"></a>02455 
<a name="l02456"></a>02456     <span class="keywordflow">return</span> dst-&gt;fd_count;
<a name="l02457"></a>02457 }
<a name="l02458"></a>02458 
<a name="l02459"></a>02459 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02460"></a><a class="code" href="../../d5/df2/win32_8c.html#aea60d7c68a4c34f7052a44db6b74aa73">02460</a> <a class="code" href="../../d5/df2/win32_8c.html#aea60d7c68a4c34f7052a44db6b74aa73">is_not_socket</a>(SOCKET sock)
<a name="l02461"></a>02461 {
<a name="l02462"></a>02462     <span class="keywordflow">return</span> !<a class="code" href="../../df/d0a/io_8c.html#a963dc023d760a24b0e23ce29bb583732">is_socket</a>(sock);
<a name="l02463"></a>02463 }
<a name="l02464"></a>02464 
<a name="l02465"></a>02465 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02466"></a><a class="code" href="../../d5/df2/win32_8c.html#aae87081661bbfa9650434e9ba87a8fb5">02466</a> <a class="code" href="../../d5/df2/win32_8c.html#aae87081661bbfa9650434e9ba87a8fb5">is_pipe</a>(SOCKET sock) <span class="comment">/* DONT call this for SOCKET! it clains it is PIPE. */</span>
<a name="l02467"></a>02467 {
<a name="l02468"></a>02468     <span class="keywordtype">int</span> ret;
<a name="l02469"></a>02469 
<a name="l02470"></a>02470     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l02471"></a>02471         ret = (GetFileType((HANDLE)sock) == FILE_TYPE_PIPE);
<a name="l02472"></a>02472     });
<a name="l02473"></a>02473 
<a name="l02474"></a>02474     <span class="keywordflow">return</span> ret;
<a name="l02475"></a>02475 }
<a name="l02476"></a>02476 
<a name="l02477"></a>02477 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02478"></a><a class="code" href="../../d5/df2/win32_8c.html#acd292cf81a1c2c59827a8792703cf428">02478</a> <a class="code" href="../../d5/df2/win32_8c.html#acd292cf81a1c2c59827a8792703cf428">is_readable_pipe</a>(SOCKET sock) <span class="comment">/* call this for pipe only */</span>
<a name="l02479"></a>02479 {
<a name="l02480"></a>02480     <span class="keywordtype">int</span> ret;
<a name="l02481"></a>02481     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> n = 0;
<a name="l02482"></a>02482 
<a name="l02483"></a>02483     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>(
<a name="l02484"></a>02484         <span class="keywordflow">if</span> (PeekNamedPipe((HANDLE)sock, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;n, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l02485"></a>02485             ret = (n &gt; 0);
<a name="l02486"></a>02486         }
<a name="l02487"></a>02487         <span class="keywordflow">else</span> {
<a name="l02488"></a>02488             ret = (GetLastError() == ERROR_BROKEN_PIPE); <span class="comment">/* pipe was closed */</span>
<a name="l02489"></a>02489         }
<a name="l02490"></a>02490     );
<a name="l02491"></a>02491 
<a name="l02492"></a>02492     <span class="keywordflow">return</span> ret;
<a name="l02493"></a>02493 }
<a name="l02494"></a>02494 
<a name="l02495"></a>02495 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02496"></a><a class="code" href="../../d5/df2/win32_8c.html#acb2b68f9f5f884aa1eb0112208debda7">02496</a> <a class="code" href="../../d5/df2/win32_8c.html#acb2b68f9f5f884aa1eb0112208debda7">is_console</a>(SOCKET sock) <span class="comment">/* DONT call this for SOCKET! */</span>
<a name="l02497"></a>02497 {
<a name="l02498"></a>02498     <span class="keywordtype">int</span> ret;
<a name="l02499"></a>02499     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> n = 0;
<a name="l02500"></a>02500     INPUT_RECORD ir;
<a name="l02501"></a>02501 
<a name="l02502"></a>02502     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>(
<a name="l02503"></a>02503         ret = (PeekConsoleInput((HANDLE)sock, &amp;ir, 1, &amp;n))
<a name="l02504"></a>02504     );
<a name="l02505"></a>02505 
<a name="l02506"></a>02506     <span class="keywordflow">return</span> ret;
<a name="l02507"></a>02507 }
<a name="l02508"></a>02508 
<a name="l02509"></a>02509 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02510"></a><a class="code" href="../../d5/df2/win32_8c.html#ace89b7ec5e5ed5ad7e3e98a9f56c93c3">02510</a> <a class="code" href="../../d5/df2/win32_8c.html#ace89b7ec5e5ed5ad7e3e98a9f56c93c3">is_readable_console</a>(SOCKET sock) <span class="comment">/* call this for console only */</span>
<a name="l02511"></a>02511 {
<a name="l02512"></a>02512     <span class="keywordtype">int</span> ret = 0;
<a name="l02513"></a>02513     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> n = 0;
<a name="l02514"></a>02514     INPUT_RECORD ir;
<a name="l02515"></a>02515 
<a name="l02516"></a>02516     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>(
<a name="l02517"></a>02517         <span class="keywordflow">if</span> (PeekConsoleInput((HANDLE)sock, &amp;ir, 1, &amp;n) &amp;&amp; n &gt; 0) {
<a name="l02518"></a>02518             <span class="keywordflow">if</span> (ir.EventType == KEY_EVENT &amp;&amp; ir.Event.KeyEvent.bKeyDown &amp;&amp;
<a name="l02519"></a>02519                 ir.Event.KeyEvent.uChar.AsciiChar) {
<a name="l02520"></a>02520                 ret = 1;
<a name="l02521"></a>02521             }
<a name="l02522"></a>02522             <span class="keywordflow">else</span> {
<a name="l02523"></a>02523                 ReadConsoleInput((HANDLE)sock, &amp;ir, 1, &amp;n);
<a name="l02524"></a>02524             }
<a name="l02525"></a>02525         }
<a name="l02526"></a>02526     );
<a name="l02527"></a>02527 
<a name="l02528"></a>02528     <span class="keywordflow">return</span> ret;
<a name="l02529"></a>02529 }
<a name="l02530"></a>02530 
<a name="l02531"></a>02531 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02532"></a><a class="code" href="../../d5/df2/win32_8c.html#a928f8e8dad3c92c2037dff68608a0788">02532</a> <a class="code" href="../../d5/df2/win32_8c.html#a928f8e8dad3c92c2037dff68608a0788">is_invalid_handle</a>(SOCKET sock)
<a name="l02533"></a>02533 {
<a name="l02534"></a>02534     <span class="keywordflow">return</span> (HANDLE)sock == INVALID_HANDLE_VALUE;
<a name="l02535"></a>02535 }
<a name="l02536"></a>02536 
<a name="l02537"></a>02537 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02538"></a><a class="code" href="../../d5/df2/win32_8c.html#a7b3617ecf5305415b8c048238ecbf259">02538</a> <a class="code" href="../../d5/df2/win32_8c.html#a7b3617ecf5305415b8c048238ecbf259">do_select</a>(<span class="keywordtype">int</span> nfds, fd_set *rd, fd_set *wr, fd_set *ex,
<a name="l02539"></a>02539             <span class="keyword">struct</span> <a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> *timeout)
<a name="l02540"></a>02540 {
<a name="l02541"></a>02541     <span class="keywordtype">int</span> r = 0;
<a name="l02542"></a>02542 
<a name="l02543"></a>02543     <span class="keywordflow">if</span> (nfds == 0) {
<a name="l02544"></a>02544         <span class="keywordflow">if</span> (timeout)
<a name="l02545"></a>02545             <a class="code" href="../../dc/db1/win32_8h.html#a2e942b300acf219df592259316a4ee5e">rb_w32_sleep</a>(timeout-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> * 1000 + timeout-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> / 1000);
<a name="l02546"></a>02546         <span class="keywordflow">else</span>
<a name="l02547"></a>02547             <a class="code" href="../../dc/db1/win32_8h.html#a2e942b300acf219df592259316a4ee5e">rb_w32_sleep</a>(INFINITE);
<a name="l02548"></a>02548     }
<a name="l02549"></a>02549     <span class="keywordflow">else</span> {
<a name="l02550"></a>02550         <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>(
<a name="l02551"></a>02551             EnterCriticalSection(&amp;select_mutex);
<a name="l02552"></a>02552             r = select(nfds, rd, wr, ex, timeout);
<a name="l02553"></a>02553             LeaveCriticalSection(&amp;select_mutex);
<a name="l02554"></a>02554             <span class="keywordflow">if</span> (r == SOCKET_ERROR) {
<a name="l02555"></a>02555                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l02556"></a>02556                 r = -1;
<a name="l02557"></a>02557             }
<a name="l02558"></a>02558         );
<a name="l02559"></a>02559     }
<a name="l02560"></a>02560 
<a name="l02561"></a>02561     <span class="keywordflow">return</span> r;
<a name="l02562"></a>02562 }
<a name="l02563"></a>02563 
<a name="l02564"></a>02564 <span class="comment">/*</span>
<a name="l02565"></a>02565 <span class="comment"> * rest -= wait</span>
<a name="l02566"></a>02566 <span class="comment"> * return 0 if rest is smaller than wait.</span>
<a name="l02567"></a>02567 <span class="comment"> */</span>
<a name="l02568"></a>02568 <span class="keywordtype">int</span>
<a name="l02569"></a><a class="code" href="../../d5/df2/win32_8c.html#ac963a05659d51e65f30a1b3e8c6f414b">02569</a> <a class="code" href="../../dc/db1/win32_8h.html#ac963a05659d51e65f30a1b3e8c6f414b">rb_w32_time_subtract</a>(<span class="keyword">struct</span> <a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> *rest, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> *<a class="code" href="../../d5/df2/win32_8c.html#a6655447bab00753d59759423bf28e22e">wait</a>)
<a name="l02570"></a>02570 {
<a name="l02571"></a>02571     <span class="keywordflow">if</span> (rest-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> &lt; wait-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a>) {
<a name="l02572"></a>02572         <span class="keywordflow">return</span> 0;
<a name="l02573"></a>02573     }
<a name="l02574"></a>02574     <span class="keywordflow">while</span> (rest-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> &lt; wait-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a>) {
<a name="l02575"></a>02575         <span class="keywordflow">if</span> (rest-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> &lt;= wait-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a>) {
<a name="l02576"></a>02576             <span class="keywordflow">return</span> 0;
<a name="l02577"></a>02577         }
<a name="l02578"></a>02578         rest-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> -= 1;
<a name="l02579"></a>02579         rest-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> += 1000 * 1000;
<a name="l02580"></a>02580     }
<a name="l02581"></a>02581     rest-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> -= wait-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a>;
<a name="l02582"></a>02582     rest-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> -= wait-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a>;
<a name="l02583"></a>02583     <span class="keywordflow">return</span> rest-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> != 0 || rest-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> != 0;
<a name="l02584"></a>02584 }
<a name="l02585"></a>02585 
<a name="l02586"></a>02586 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l02587"></a><a class="code" href="../../d5/df2/win32_8c.html#a1df9c3a712f5defb50a2bca650f283e8">02587</a> <a class="code" href="../../d5/df2/win32_8c.html#a1df9c3a712f5defb50a2bca650f283e8">compare</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> *t1, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> *t2)
<a name="l02588"></a>02588 {
<a name="l02589"></a>02589     <span class="keywordflow">if</span> (t1-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> &lt; t2-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a>)
<a name="l02590"></a>02590         <span class="keywordflow">return</span> -1;
<a name="l02591"></a>02591     <span class="keywordflow">if</span> (t1-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> &gt; t2-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a>)
<a name="l02592"></a>02592         <span class="keywordflow">return</span> 1;
<a name="l02593"></a>02593     <span class="keywordflow">if</span> (t1-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> &lt; t2-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a>)
<a name="l02594"></a>02594         <span class="keywordflow">return</span> -1;
<a name="l02595"></a>02595     <span class="keywordflow">if</span> (t1-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> &gt; t2-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a>)
<a name="l02596"></a>02596         <span class="keywordflow">return</span> 1;
<a name="l02597"></a>02597     <span class="keywordflow">return</span> 0;
<a name="l02598"></a>02598 }
<a name="l02599"></a>02599 
<a name="l02600"></a>02600 <span class="preprocessor">#undef Sleep</span>
<a name="l02601"></a>02601 <span class="preprocessor"></span>
<a name="l02602"></a>02602 <span class="keywordtype">int</span> <a class="code" href="../../dd/d55/thread__win32_8c.html#ac6833fd36955dd1028df31aa5cfa7036">rb_w32_check_interrupt</a>(<span class="keywordtype">void</span> *);     <span class="comment">/* @internal */</span>
<a name="l02603"></a>02603 
<a name="l02604"></a>02604 <span class="comment">/* @internal */</span>
<a name="l02605"></a>02605 <span class="keywordtype">int</span>
<a name="l02606"></a><a class="code" href="../../d5/df2/win32_8c.html#a046b28af9a4994c9552100f40d5e8480">02606</a> <a class="code" href="../../dd/d55/thread__win32_8c.html#aee02c8bcc7c78b0f0a55d4a084b4a792">rb_w32_select_with_thread</a>(<span class="keywordtype">int</span> nfds, fd_set *rd, fd_set *wr, fd_set *ex,
<a name="l02607"></a>02607                           <span class="keyword">struct</span> <a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> *timeout, <span class="keywordtype">void</span> *th)
<a name="l02608"></a>02608 {
<a name="l02609"></a>02609     <span class="keywordtype">int</span> r;
<a name="l02610"></a>02610     <a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> pipe_rd;
<a name="l02611"></a>02611     <a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> cons_rd;
<a name="l02612"></a>02612     <a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> else_rd;
<a name="l02613"></a>02613     <a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> else_wr;
<a name="l02614"></a>02614     <a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> except;
<a name="l02615"></a>02615     <span class="keywordtype">int</span> nonsock = 0;
<a name="l02616"></a>02616     <span class="keyword">struct </span><a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> limit = {0, 0};
<a name="l02617"></a>02617 
<a name="l02618"></a>02618     <span class="keywordflow">if</span> (nfds &lt; 0 || (timeout &amp;&amp; (timeout-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> &lt; 0 || timeout-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> &lt; 0))) {
<a name="l02619"></a>02619         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l02620"></a>02620         <span class="keywordflow">return</span> -1;
<a name="l02621"></a>02621     }
<a name="l02622"></a>02622 
<a name="l02623"></a>02623     <span class="keywordflow">if</span> (timeout) {
<a name="l02624"></a>02624         <span class="keywordflow">if</span> (timeout-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> &lt; 0 ||
<a name="l02625"></a>02625             timeout-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> &lt; 0 ||
<a name="l02626"></a>02626             timeout-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> &gt;= 1000000) {
<a name="l02627"></a>02627             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l02628"></a>02628             <span class="keywordflow">return</span> -1;
<a name="l02629"></a>02629         }
<a name="l02630"></a>02630         <a class="code" href="../../dc/db1/win32_8h.html#a091a762f60d91b0f5441d9520dc2079c">gettimeofday</a>(&amp;limit, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02631"></a>02631         limit.<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> += timeout-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a>;
<a name="l02632"></a>02632         limit.<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> += timeout-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a>;
<a name="l02633"></a>02633         <span class="keywordflow">if</span> (limit.<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> &gt;= 1000000) {
<a name="l02634"></a>02634             limit.<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> -= 1000000;
<a name="l02635"></a>02635             limit.<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a>++;
<a name="l02636"></a>02636         }
<a name="l02637"></a>02637     }
<a name="l02638"></a>02638 
<a name="l02639"></a>02639     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l02640"></a>02640         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l02641"></a>02641     }
<a name="l02642"></a>02642 
<a name="l02643"></a>02643     <span class="comment">// assume else_{rd,wr} (other than socket, pipe reader, console reader)</span>
<a name="l02644"></a>02644     <span class="comment">// are always readable/writable. but this implementation still has</span>
<a name="l02645"></a>02645     <span class="comment">// problem. if pipe&apos;s buffer is full, writing to pipe will block</span>
<a name="l02646"></a>02646     <span class="comment">// until some data is read from pipe. but ruby is single threaded system,</span>
<a name="l02647"></a>02647     <span class="comment">// so whole system will be blocked forever.</span>
<a name="l02648"></a>02648 
<a name="l02649"></a>02649     <a class="code" href="../../db/d2e/intern_8h.html#af5c7e378da9f236d57683a79c526ccd6">rb_fd_init</a>(&amp;else_rd);
<a name="l02650"></a>02650     nonsock += <a class="code" href="../../d5/df2/win32_8c.html#a327fd5616806a4506d8a1105dcd8edd8">extract_fd</a>(&amp;else_rd, rd, <a class="code" href="../../d5/df2/win32_8c.html#aea60d7c68a4c34f7052a44db6b74aa73">is_not_socket</a>);
<a name="l02651"></a>02651 
<a name="l02652"></a>02652     <a class="code" href="../../db/d2e/intern_8h.html#af5c7e378da9f236d57683a79c526ccd6">rb_fd_init</a>(&amp;else_wr);
<a name="l02653"></a>02653     nonsock += <a class="code" href="../../d5/df2/win32_8c.html#a327fd5616806a4506d8a1105dcd8edd8">extract_fd</a>(&amp;else_wr, wr, <a class="code" href="../../d5/df2/win32_8c.html#aea60d7c68a4c34f7052a44db6b74aa73">is_not_socket</a>);
<a name="l02654"></a>02654 
<a name="l02655"></a>02655     <span class="comment">// check invalid handles</span>
<a name="l02656"></a>02656     <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a327fd5616806a4506d8a1105dcd8edd8">extract_fd</a>(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, else_rd.fdset, <a class="code" href="../../d5/df2/win32_8c.html#a928f8e8dad3c92c2037dff68608a0788">is_invalid_handle</a>) &gt; 0 ||
<a name="l02657"></a>02657         <a class="code" href="../../d5/df2/win32_8c.html#a327fd5616806a4506d8a1105dcd8edd8">extract_fd</a>(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, else_wr.fdset, <a class="code" href="../../d5/df2/win32_8c.html#a928f8e8dad3c92c2037dff68608a0788">is_invalid_handle</a>) &gt; 0) {
<a name="l02658"></a>02658         <a class="code" href="../../db/d2e/intern_8h.html#af5ba60171ec45c289183e9fa3e829b8a">rb_fd_term</a>(&amp;else_wr);
<a name="l02659"></a>02659         <a class="code" href="../../db/d2e/intern_8h.html#af5ba60171ec45c289183e9fa3e829b8a">rb_fd_term</a>(&amp;else_rd);
<a name="l02660"></a>02660         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EBADF;
<a name="l02661"></a>02661         <span class="keywordflow">return</span> -1;
<a name="l02662"></a>02662     }
<a name="l02663"></a>02663 
<a name="l02664"></a>02664     <a class="code" href="../../db/d2e/intern_8h.html#af5c7e378da9f236d57683a79c526ccd6">rb_fd_init</a>(&amp;pipe_rd);
<a name="l02665"></a>02665     <a class="code" href="../../d5/df2/win32_8c.html#a327fd5616806a4506d8a1105dcd8edd8">extract_fd</a>(&amp;pipe_rd, else_rd.fdset, <a class="code" href="../../d5/df2/win32_8c.html#aae87081661bbfa9650434e9ba87a8fb5">is_pipe</a>); <span class="comment">// should not call is_pipe for socket</span>
<a name="l02666"></a>02666 
<a name="l02667"></a>02667     <a class="code" href="../../db/d2e/intern_8h.html#af5c7e378da9f236d57683a79c526ccd6">rb_fd_init</a>(&amp;cons_rd);
<a name="l02668"></a>02668     <a class="code" href="../../d5/df2/win32_8c.html#a327fd5616806a4506d8a1105dcd8edd8">extract_fd</a>(&amp;cons_rd, else_rd.fdset, <a class="code" href="../../d5/df2/win32_8c.html#acb2b68f9f5f884aa1eb0112208debda7">is_console</a>); <span class="comment">// ditto</span>
<a name="l02669"></a>02669 
<a name="l02670"></a>02670     <a class="code" href="../../db/d2e/intern_8h.html#af5c7e378da9f236d57683a79c526ccd6">rb_fd_init</a>(&amp;except);
<a name="l02671"></a>02671     <a class="code" href="../../d5/df2/win32_8c.html#a327fd5616806a4506d8a1105dcd8edd8">extract_fd</a>(&amp;except, ex, <a class="code" href="../../d5/df2/win32_8c.html#aea60d7c68a4c34f7052a44db6b74aa73">is_not_socket</a>); <span class="comment">// drop only</span>
<a name="l02672"></a>02672 
<a name="l02673"></a>02673     r = 0;
<a name="l02674"></a>02674     <span class="keywordflow">if</span> (rd &amp;&amp; (<span class="keywordtype">int</span>)rd-&gt;fd_count &gt; r) r = (int)rd-&gt;fd_count;
<a name="l02675"></a>02675     <a class="code" href="../../d7/dc0/parse_8y.html#a2ac1143ac343c79cbfa448e30d74fa1c">if</a> (wr &amp;&amp; (<span class="keywordtype">int</span>)wr-&gt;fd_count &gt; r) r = (<span class="keywordtype">int</span>)wr-&gt;fd_count;
<a name="l02676"></a>02676     <span class="keywordflow">if</span> (ex &amp;&amp; (<span class="keywordtype">int</span>)ex-&gt;fd_count &gt; r) r = (<span class="keywordtype">int</span>)ex-&gt;fd_count;
<a name="l02677"></a>02677     <span class="keywordflow">if</span> (nfds &gt; r) nfds = r;
<a name="l02678"></a>02678 
<a name="l02679"></a>02679     {
<a name="l02680"></a>02680         <span class="keyword">struct </span><a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> rest;
<a name="l02681"></a>02681         <span class="keyword">struct </span><a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> wait;
<a name="l02682"></a>02682         <span class="keyword">struct </span><a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> zero;
<a name="l02683"></a>02683         wait.<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> = 0; wait.<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> = 10 * 1000; <span class="comment">// 10ms</span>
<a name="l02684"></a>02684         zero.<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> = 0; zero.<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> = 0;         <span class="comment">//  0ms</span>
<a name="l02685"></a>02685         <span class="keywordflow">for</span> (;;) {
<a name="l02686"></a>02686             <span class="keywordflow">if</span> (th &amp;&amp; <a class="code" href="../../dd/d55/thread__win32_8c.html#ac6833fd36955dd1028df31aa5cfa7036">rb_w32_check_interrupt</a>(th) != WAIT_TIMEOUT) {
<a name="l02687"></a>02687                 r = -1;
<a name="l02688"></a>02688                 <span class="keywordflow">break</span>;
<a name="l02689"></a>02689             }
<a name="l02690"></a>02690             <span class="keywordflow">if</span> (nonsock) {
<a name="l02691"></a>02691                 <span class="comment">// modifying {else,pipe,cons}_rd is safe because</span>
<a name="l02692"></a>02692                 <span class="comment">// if they are modified, function returns immediately.</span>
<a name="l02693"></a>02693                 <a class="code" href="../../d5/df2/win32_8c.html#a327fd5616806a4506d8a1105dcd8edd8">extract_fd</a>(&amp;else_rd, pipe_rd.fdset, <a class="code" href="../../d5/df2/win32_8c.html#acd292cf81a1c2c59827a8792703cf428">is_readable_pipe</a>);
<a name="l02694"></a>02694                 <a class="code" href="../../d5/df2/win32_8c.html#a327fd5616806a4506d8a1105dcd8edd8">extract_fd</a>(&amp;else_rd, cons_rd.fdset, <a class="code" href="../../d5/df2/win32_8c.html#ace89b7ec5e5ed5ad7e3e98a9f56c93c3">is_readable_console</a>);
<a name="l02695"></a>02695             }
<a name="l02696"></a>02696 
<a name="l02697"></a>02697             <span class="keywordflow">if</span> (else_rd.fdset-&gt;fd_count || else_wr.fdset-&gt;fd_count) {
<a name="l02698"></a>02698                 r = <a class="code" href="../../d5/df2/win32_8c.html#a7b3617ecf5305415b8c048238ecbf259">do_select</a>(nfds, rd, wr, ex, &amp;zero); <span class="comment">// polling</span>
<a name="l02699"></a>02699                 <span class="keywordflow">if</span> (r &lt; 0) <span class="keywordflow">break</span>; <span class="comment">// XXX: should I ignore error and return signaled handles?</span>
<a name="l02700"></a>02700                 r += <a class="code" href="../../d5/df2/win32_8c.html#ac4c197c22f7c370272b2ffb19788c164">copy_fd</a>(rd, else_rd.fdset);
<a name="l02701"></a>02701                 r += <a class="code" href="../../d5/df2/win32_8c.html#ac4c197c22f7c370272b2ffb19788c164">copy_fd</a>(wr, else_wr.fdset);
<a name="l02702"></a>02702                 <span class="keywordflow">if</span> (ex)
<a name="l02703"></a>02703                     r += ex-&gt;fd_count;
<a name="l02704"></a>02704                 <span class="keywordflow">break</span>;
<a name="l02705"></a>02705             }
<a name="l02706"></a>02706             <span class="keywordflow">else</span> {
<a name="l02707"></a>02707                 <span class="keyword">struct </span><a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> *dowait = &amp;wait;
<a name="l02708"></a>02708 
<a name="l02709"></a>02709                 fd_set orig_rd;
<a name="l02710"></a>02710                 fd_set orig_wr;
<a name="l02711"></a>02711                 fd_set orig_ex;
<a name="l02712"></a>02712 
<a name="l02713"></a>02713                 FD_ZERO(&amp;orig_rd);
<a name="l02714"></a>02714                 FD_ZERO(&amp;orig_wr);
<a name="l02715"></a>02715                 FD_ZERO(&amp;orig_ex);
<a name="l02716"></a>02716 
<a name="l02717"></a>02717                 <span class="keywordflow">if</span> (rd) <a class="code" href="../../d5/df2/win32_8c.html#ac4c197c22f7c370272b2ffb19788c164">copy_fd</a>(&amp;orig_rd, rd);
<a name="l02718"></a>02718                 <span class="keywordflow">if</span> (wr) <a class="code" href="../../d5/df2/win32_8c.html#ac4c197c22f7c370272b2ffb19788c164">copy_fd</a>(&amp;orig_wr, wr);
<a name="l02719"></a>02719                 <span class="keywordflow">if</span> (ex) <a class="code" href="../../d5/df2/win32_8c.html#ac4c197c22f7c370272b2ffb19788c164">copy_fd</a>(&amp;orig_ex, ex);
<a name="l02720"></a>02720                 r = <a class="code" href="../../d5/df2/win32_8c.html#a7b3617ecf5305415b8c048238ecbf259">do_select</a>(nfds, rd, wr, ex, &amp;zero); <span class="comment">// polling</span>
<a name="l02721"></a>02721                 <span class="keywordflow">if</span> (r != 0) <span class="keywordflow">break</span>; <span class="comment">// signaled or error</span>
<a name="l02722"></a>02722                 <span class="keywordflow">if</span> (rd) <a class="code" href="../../d5/df2/win32_8c.html#ac4c197c22f7c370272b2ffb19788c164">copy_fd</a>(rd, &amp;orig_rd);
<a name="l02723"></a>02723                 <span class="keywordflow">if</span> (wr) <a class="code" href="../../d5/df2/win32_8c.html#ac4c197c22f7c370272b2ffb19788c164">copy_fd</a>(wr, &amp;orig_wr);
<a name="l02724"></a>02724                 <span class="keywordflow">if</span> (ex) <a class="code" href="../../d5/df2/win32_8c.html#ac4c197c22f7c370272b2ffb19788c164">copy_fd</a>(ex, &amp;orig_ex);
<a name="l02725"></a>02725 
<a name="l02726"></a>02726                 <span class="keywordflow">if</span> (timeout) {
<a name="l02727"></a>02727                     <span class="keyword">struct </span><a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> now;
<a name="l02728"></a>02728                     <a class="code" href="../../dc/db1/win32_8h.html#a091a762f60d91b0f5441d9520dc2079c">gettimeofday</a>(&amp;now, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02729"></a>02729                     rest = limit;
<a name="l02730"></a>02730                     <span class="keywordflow">if</span> (!<a class="code" href="../../dc/db1/win32_8h.html#ac963a05659d51e65f30a1b3e8c6f414b">rb_w32_time_subtract</a>(&amp;rest, &amp;now)) <span class="keywordflow">break</span>;
<a name="l02731"></a>02731                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a1df9c3a712f5defb50a2bca650f283e8">compare</a>(&amp;rest, &amp;wait) &lt; 0) dowait = &amp;rest;
<a name="l02732"></a>02732                 }
<a name="l02733"></a>02733                 Sleep(dowait-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> * 1000 + dowait-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> / 1000);
<a name="l02734"></a>02734             }
<a name="l02735"></a>02735         }
<a name="l02736"></a>02736     }
<a name="l02737"></a>02737 
<a name="l02738"></a>02738     <a class="code" href="../../db/d2e/intern_8h.html#af5ba60171ec45c289183e9fa3e829b8a">rb_fd_term</a>(&amp;except);
<a name="l02739"></a>02739     <a class="code" href="../../db/d2e/intern_8h.html#af5ba60171ec45c289183e9fa3e829b8a">rb_fd_term</a>(&amp;cons_rd);
<a name="l02740"></a>02740     <a class="code" href="../../db/d2e/intern_8h.html#af5ba60171ec45c289183e9fa3e829b8a">rb_fd_term</a>(&amp;pipe_rd);
<a name="l02741"></a>02741     <a class="code" href="../../db/d2e/intern_8h.html#af5ba60171ec45c289183e9fa3e829b8a">rb_fd_term</a>(&amp;else_wr);
<a name="l02742"></a>02742     <a class="code" href="../../db/d2e/intern_8h.html#af5ba60171ec45c289183e9fa3e829b8a">rb_fd_term</a>(&amp;else_rd);
<a name="l02743"></a>02743 
<a name="l02744"></a>02744     <span class="keywordflow">return</span> r;
<a name="l02745"></a>02745 }
<a name="l02746"></a>02746 
<a name="l02747"></a>02747 <span class="keywordtype">int</span> WSAAPI
<a name="l02748"></a><a class="code" href="../../d5/df2/win32_8c.html#a0de0f3eee9e9cd25914126c43afbbb07">02748</a> <a class="code" href="../../dc/db1/win32_8h.html#a56d0d606c1c7f312901fcdd7fd9ed9cf">rb_w32_select</a>(<span class="keywordtype">int</span> nfds, fd_set *rd, fd_set *wr, fd_set *ex,
<a name="l02749"></a>02749               <span class="keyword">struct</span> <a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> *timeout)
<a name="l02750"></a>02750 {
<a name="l02751"></a>02751     <span class="keywordflow">return</span> <a class="code" href="../../dd/d55/thread__win32_8c.html#aee02c8bcc7c78b0f0a55d4a084b4a792">rb_w32_select_with_thread</a>(nfds, rd, wr, ex, timeout, 0);
<a name="l02752"></a>02752 }
<a name="l02753"></a>02753 
<a name="l02754"></a>02754 <span class="keyword">static</span> FARPROC
<a name="l02755"></a><a class="code" href="../../d5/df2/win32_8c.html#a4409d6ff23e91d6b8933321cb313c10b">02755</a> <a class="code" href="../../d5/df2/win32_8c.html#a4409d6ff23e91d6b8933321cb313c10b">get_wsa_extension_function</a>(SOCKET s, GUID *guid)
<a name="l02756"></a>02756 {
<a name="l02757"></a>02757     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> dmy;
<a name="l02758"></a>02758     FARPROC ptr = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02759"></a>02759 
<a name="l02760"></a>02760     WSAIoctl(s, SIO_GET_EXTENSION_FUNCTION_POINTER, guid, <span class="keyword">sizeof</span>(*guid),
<a name="l02761"></a>02761              &amp;ptr, <span class="keyword">sizeof</span>(ptr), &amp;dmy, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02762"></a>02762     <span class="keywordflow">if</span> (!ptr)
<a name="l02763"></a>02763         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ENOSYS;
<a name="l02764"></a>02764     <span class="keywordflow">return</span> ptr;
<a name="l02765"></a>02765 }
<a name="l02766"></a>02766 
<a name="l02767"></a>02767 <span class="preprocessor">#undef accept</span>
<a name="l02768"></a>02768 <span class="preprocessor"></span>
<a name="l02769"></a>02769 <span class="keywordtype">int</span> WSAAPI
<a name="l02770"></a><a class="code" href="../../d5/df2/win32_8c.html#a97f72abe7c2c3bdbfb5acd8d131c395d">02770</a> <a class="code" href="../../dc/db1/win32_8h.html#a0c8a8cd82b247f5906286bb075682f54">rb_w32_accept</a>(<span class="keywordtype">int</span> s, <span class="keyword">struct</span> sockaddr *addr, <span class="keywordtype">int</span> *addrlen)
<a name="l02771"></a>02771 {
<a name="l02772"></a>02772     SOCKET r;
<a name="l02773"></a>02773     <span class="keywordtype">int</span> fd;
<a name="l02774"></a>02774 
<a name="l02775"></a>02775     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l02776"></a>02776         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l02777"></a>02777     }
<a name="l02778"></a>02778     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l02779"></a>02779         HANDLE h = CreateFile(<span class="stringliteral">&quot;NUL&quot;</span>, 0, 0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, OPEN_ALWAYS, 0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02780"></a>02780         fd = <a class="code" href="../../d5/df2/win32_8c.html#a4611af37727832d276705e41ed08ecb8">rb_w32_open_osfhandle</a>((<a class="code" href="../../dc/db1/win32_8h.html#a0fbe4a4f8dd857ee04923a901f27465f">intptr_t</a>)h, O_RDWR|<a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>|O_NOINHERIT);
<a name="l02781"></a>02781         <span class="keywordflow">if</span> (fd != -1) {
<a name="l02782"></a>02782             r = accept(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(s), addr, addrlen);
<a name="l02783"></a>02783             <span class="keywordflow">if</span> (r != INVALID_SOCKET) {
<a name="l02784"></a>02784                 <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(EnterCriticalSection(&amp;(<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock)));
<a name="l02785"></a>02785                 <a class="code" href="../../d5/df2/win32_8c.html#ac603bb260657b14e80a08ea0a4f7d72e">_set_osfhnd</a>(fd, r);
<a name="l02786"></a>02786                 <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l02787"></a>02787                 CloseHandle(h);
<a name="l02788"></a>02788                 <a class="code" href="../../dd/d24/st_8h.html#acdc42c01229b7537ea5a4c6965c7e47a">st_insert</a>(socklist, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)r, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)0);
<a name="l02789"></a>02789             }
<a name="l02790"></a>02790             <span class="keywordflow">else</span> {
<a name="l02791"></a>02791                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l02792"></a>02792                 close(fd);
<a name="l02793"></a>02793                 fd = -1;
<a name="l02794"></a>02794             }
<a name="l02795"></a>02795         }
<a name="l02796"></a>02796         <span class="keywordflow">else</span>
<a name="l02797"></a>02797             CloseHandle(h);
<a name="l02798"></a>02798     });
<a name="l02799"></a>02799     <span class="keywordflow">return</span> fd;
<a name="l02800"></a>02800 }
<a name="l02801"></a>02801 
<a name="l02802"></a>02802 <span class="preprocessor">#undef bind</span>
<a name="l02803"></a>02803 <span class="preprocessor"></span>
<a name="l02804"></a>02804 <span class="keywordtype">int</span> WSAAPI
<a name="l02805"></a><a class="code" href="../../d5/df2/win32_8c.html#a92274f8f443a37851335ab4d495a5ba6">02805</a> <a class="code" href="../../dc/db1/win32_8h.html#a5549594481f9750e20055805fa45a18f">rb_w32_bind</a>(<span class="keywordtype">int</span> s, <span class="keyword">const</span> <span class="keyword">struct</span> sockaddr *addr, <span class="keywordtype">int</span> addrlen)
<a name="l02806"></a>02806 {
<a name="l02807"></a>02807     <span class="keywordtype">int</span> r;
<a name="l02808"></a>02808 
<a name="l02809"></a>02809     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l02810"></a>02810         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l02811"></a>02811     }
<a name="l02812"></a>02812     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l02813"></a>02813         r = bind(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(s), addr, addrlen);
<a name="l02814"></a>02814         <span class="keywordflow">if</span> (r == SOCKET_ERROR)
<a name="l02815"></a>02815             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l02816"></a>02816     });
<a name="l02817"></a>02817     <span class="keywordflow">return</span> r;
<a name="l02818"></a>02818 }
<a name="l02819"></a>02819 
<a name="l02820"></a>02820 <span class="preprocessor">#undef connect</span>
<a name="l02821"></a>02821 <span class="preprocessor"></span>
<a name="l02822"></a>02822 <span class="keywordtype">int</span> WSAAPI
<a name="l02823"></a><a class="code" href="../../d5/df2/win32_8c.html#a75904609d350ab27d773878ec193291a">02823</a> <a class="code" href="../../dc/db1/win32_8h.html#a6f26c2ede3c45cb12ec9cf2bba659310">rb_w32_connect</a>(<span class="keywordtype">int</span> s, <span class="keyword">const</span> <span class="keyword">struct</span> sockaddr *addr, <span class="keywordtype">int</span> addrlen)
<a name="l02824"></a>02824 {
<a name="l02825"></a>02825     <span class="keywordtype">int</span> r;
<a name="l02826"></a>02826     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l02827"></a>02827         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l02828"></a>02828     }
<a name="l02829"></a>02829     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l02830"></a>02830         r = connect(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(s), addr, addrlen);
<a name="l02831"></a>02831         <span class="keywordflow">if</span> (r == SOCKET_ERROR) {
<a name="l02832"></a>02832             <span class="keywordtype">int</span> <a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a> = WSAGetLastError();
<a name="l02833"></a>02833             <span class="keywordflow">if</span> (err != WSAEWOULDBLOCK)
<a name="l02834"></a>02834                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(err);
<a name="l02835"></a>02835             <span class="keywordflow">else</span>
<a name="l02836"></a>02836                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../dc/db1/win32_8h.html#a6c045d5be06e715cc335784a7320714e">EINPROGRESS</a>;
<a name="l02837"></a>02837         }
<a name="l02838"></a>02838     });
<a name="l02839"></a>02839     <span class="keywordflow">return</span> r;
<a name="l02840"></a>02840 }
<a name="l02841"></a>02841 
<a name="l02842"></a>02842 
<a name="l02843"></a>02843 <span class="preprocessor">#undef getpeername</span>
<a name="l02844"></a>02844 <span class="preprocessor"></span>
<a name="l02845"></a>02845 <span class="keywordtype">int</span> WSAAPI
<a name="l02846"></a><a class="code" href="../../d5/df2/win32_8c.html#a799a970683979979f2d0beb6581a440b">02846</a> <a class="code" href="../../dc/db1/win32_8h.html#abaa0992dfb367f25d0362b98ecacf037">rb_w32_getpeername</a>(<span class="keywordtype">int</span> s, <span class="keyword">struct</span> sockaddr *addr, <span class="keywordtype">int</span> *addrlen)
<a name="l02847"></a>02847 {
<a name="l02848"></a>02848     <span class="keywordtype">int</span> r;
<a name="l02849"></a>02849     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l02850"></a>02850         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l02851"></a>02851     }
<a name="l02852"></a>02852     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l02853"></a>02853         r = getpeername(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(s), addr, addrlen);
<a name="l02854"></a>02854         <span class="keywordflow">if</span> (r == SOCKET_ERROR)
<a name="l02855"></a>02855             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l02856"></a>02856     });
<a name="l02857"></a>02857     <span class="keywordflow">return</span> r;
<a name="l02858"></a>02858 }
<a name="l02859"></a>02859 
<a name="l02860"></a>02860 <span class="preprocessor">#undef getsockname</span>
<a name="l02861"></a>02861 <span class="preprocessor"></span>
<a name="l02862"></a>02862 <span class="keywordtype">int</span> WSAAPI
<a name="l02863"></a><a class="code" href="../../d5/df2/win32_8c.html#abbb787e1f41d089625649a3320107cc7">02863</a> <a class="code" href="../../dc/db1/win32_8h.html#aee436f26c7a97f3d1608f6c70e50d632">rb_w32_getsockname</a>(<span class="keywordtype">int</span> s, <span class="keyword">struct</span> sockaddr *addr, <span class="keywordtype">int</span> *addrlen)
<a name="l02864"></a>02864 {
<a name="l02865"></a>02865     <span class="keywordtype">int</span> r;
<a name="l02866"></a>02866     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l02867"></a>02867         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l02868"></a>02868     }
<a name="l02869"></a>02869     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l02870"></a>02870         r = getsockname(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(s), addr, addrlen);
<a name="l02871"></a>02871         <span class="keywordflow">if</span> (r == SOCKET_ERROR)
<a name="l02872"></a>02872             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l02873"></a>02873     });
<a name="l02874"></a>02874     <span class="keywordflow">return</span> r;
<a name="l02875"></a>02875 }
<a name="l02876"></a>02876 
<a name="l02877"></a>02877 <span class="keywordtype">int</span> WSAAPI
<a name="l02878"></a><a class="code" href="../../d5/df2/win32_8c.html#a4d2781f102a4d338963304a2d5bc3402">02878</a> <a class="code" href="../../dc/db1/win32_8h.html#aa7745b3ad62432b69699e191e9f8585d">rb_w32_getsockopt</a>(<span class="keywordtype">int</span> s, <span class="keywordtype">int</span> level, <span class="keywordtype">int</span> optname, <span class="keywordtype">char</span> *optval, <span class="keywordtype">int</span> *optlen)
<a name="l02879"></a>02879 {
<a name="l02880"></a>02880     <span class="keywordtype">int</span> r;
<a name="l02881"></a>02881     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l02882"></a>02882         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l02883"></a>02883     }
<a name="l02884"></a>02884     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l02885"></a>02885         r = getsockopt(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(s), level, optname, optval, optlen);
<a name="l02886"></a>02886         <span class="keywordflow">if</span> (r == SOCKET_ERROR)
<a name="l02887"></a>02887             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l02888"></a>02888     });
<a name="l02889"></a>02889     <span class="keywordflow">return</span> r;
<a name="l02890"></a>02890 }
<a name="l02891"></a>02891 
<a name="l02892"></a>02892 <span class="preprocessor">#undef ioctlsocket</span>
<a name="l02893"></a>02893 <span class="preprocessor"></span>
<a name="l02894"></a>02894 <span class="keywordtype">int</span> WSAAPI
<a name="l02895"></a><a class="code" href="../../d5/df2/win32_8c.html#ad573f153140e546a7c16254cadbc3248">02895</a> <a class="code" href="../../dc/db1/win32_8h.html#a5c57eb752f36cdcc76207d2538b94b4e">rb_w32_ioctlsocket</a>(<span class="keywordtype">int</span> s, <span class="keywordtype">long</span> cmd, <a class="code" href="../../da/d50/vsnprintf_8c.html#aaf12d2783d89167480b76853da8ba5e1">u_long</a> *argp)
<a name="l02896"></a>02896 {
<a name="l02897"></a>02897     <span class="keywordtype">int</span> r;
<a name="l02898"></a>02898     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l02899"></a>02899         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l02900"></a>02900     }
<a name="l02901"></a>02901     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l02902"></a>02902         r = ioctlsocket(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(s), cmd, argp);
<a name="l02903"></a>02903         <span class="keywordflow">if</span> (r == SOCKET_ERROR)
<a name="l02904"></a>02904             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l02905"></a>02905     });
<a name="l02906"></a>02906     <span class="keywordflow">return</span> r;
<a name="l02907"></a>02907 }
<a name="l02908"></a>02908 
<a name="l02909"></a>02909 <span class="preprocessor">#undef listen</span>
<a name="l02910"></a>02910 <span class="preprocessor"></span>
<a name="l02911"></a>02911 <span class="keywordtype">int</span> WSAAPI
<a name="l02912"></a><a class="code" href="../../d5/df2/win32_8c.html#a09547c699a6ff79062876402883a1d17">02912</a> <a class="code" href="../../dc/db1/win32_8h.html#a657b0e5850efbc87734ad80fc0257006">rb_w32_listen</a>(<span class="keywordtype">int</span> s, <span class="keywordtype">int</span> backlog)
<a name="l02913"></a>02913 {
<a name="l02914"></a>02914     <span class="keywordtype">int</span> r;
<a name="l02915"></a>02915     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l02916"></a>02916         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l02917"></a>02917     }
<a name="l02918"></a>02918     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l02919"></a>02919         r = listen(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(s), backlog);
<a name="l02920"></a>02920         <span class="keywordflow">if</span> (r == SOCKET_ERROR)
<a name="l02921"></a>02921             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l02922"></a>02922     });
<a name="l02923"></a>02923     <span class="keywordflow">return</span> r;
<a name="l02924"></a>02924 }
<a name="l02925"></a>02925 
<a name="l02926"></a>02926 <span class="preprocessor">#undef recv</span>
<a name="l02927"></a>02927 <span class="preprocessor"></span><span class="preprocessor">#undef recvfrom</span>
<a name="l02928"></a>02928 <span class="preprocessor"></span><span class="preprocessor">#undef send</span>
<a name="l02929"></a>02929 <span class="preprocessor"></span><span class="preprocessor">#undef sendto</span>
<a name="l02930"></a>02930 <span class="preprocessor"></span>
<a name="l02931"></a>02931 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02932"></a><a class="code" href="../../d5/df2/win32_8c.html#a8a18a2ea747dae45d045c3d8a49115a1">02932</a> <a class="code" href="../../d5/df2/win32_8c.html#a8a18a2ea747dae45d045c3d8a49115a1">finish_overlapped_socket</a>(SOCKET s, WSAOVERLAPPED *wol, <span class="keywordtype">int</span> <a class="code" href="../../d8/d90/nkf_8c.html#a5ea5ac7abf5cce39283e422add1067d5">result</a>, <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> *<a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l02933"></a>02933 {
<a name="l02934"></a>02934     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> flg;
<a name="l02935"></a>02935     <span class="keywordtype">int</span> <a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a>;
<a name="l02936"></a>02936 
<a name="l02937"></a>02937     <span class="keywordflow">if</span> (result != SOCKET_ERROR)
<a name="l02938"></a>02938         *len = size;
<a name="l02939"></a>02939     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((err = WSAGetLastError()) == WSA_IO_PENDING) {
<a name="l02940"></a>02940         <span class="keywordflow">switch</span> (<a class="code" href="../../dc/db1/win32_8h.html#a2da86cc53904a673b2b18547d63700f6">rb_w32_wait_events_blocking</a>(&amp;wol-&gt;hEvent, 1, INFINITE)) {
<a name="l02941"></a>02941           <span class="keywordflow">case</span> WAIT_OBJECT_0:
<a name="l02942"></a>02942             <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>(
<a name="l02943"></a>02943                 result = WSAGetOverlappedResult(s, wol, &amp;size, <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, &amp;flg)
<a name="l02944"></a>02944                 );
<a name="l02945"></a>02945             <span class="keywordflow">if</span> (result) {
<a name="l02946"></a>02946                 *len = size;
<a name="l02947"></a>02947                 <span class="keywordflow">break</span>;
<a name="l02948"></a>02948             }
<a name="l02949"></a>02949             <span class="comment">/* thru */</span>
<a name="l02950"></a>02950           <span class="keywordflow">default</span>:
<a name="l02951"></a>02951             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l02952"></a>02952             <span class="comment">/* thru */</span>
<a name="l02953"></a>02953           <span class="keywordflow">case</span> WAIT_OBJECT_0 + 1:
<a name="l02954"></a>02954             <span class="comment">/* interrupted */</span>
<a name="l02955"></a>02955             *len = -1;
<a name="l02956"></a>02956             <a class="code" href="../../d5/df2/win32_8c.html#a87c46885302df4c28bc6825fb195df1f">cancel_io</a>((HANDLE)s);
<a name="l02957"></a>02957             <span class="keywordflow">break</span>;
<a name="l02958"></a>02958         }
<a name="l02959"></a>02959     }
<a name="l02960"></a>02960     <span class="keywordflow">else</span> {
<a name="l02961"></a>02961         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(err);
<a name="l02962"></a>02962         *len = -1;
<a name="l02963"></a>02963     }
<a name="l02964"></a>02964     CloseHandle(wol-&gt;hEvent);
<a name="l02965"></a>02965 
<a name="l02966"></a>02966     <span class="keywordflow">return</span> result;
<a name="l02967"></a>02967 }
<a name="l02968"></a>02968 
<a name="l02969"></a>02969 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02970"></a><a class="code" href="../../d5/df2/win32_8c.html#afd2d034d3ab2feb08f8f481b9d1c2d10">02970</a> <a class="code" href="../../d5/df2/win32_8c.html#afd2d034d3ab2feb08f8f481b9d1c2d10">overlapped_socket_io</a>(BOOL <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a5a3887dd3455e820d89b736f9b4de18b">input</a>, <span class="keywordtype">int</span> fd, <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>, <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <span class="keywordtype">int</span> flags,
<a name="l02971"></a>02971                      <span class="keyword">struct</span> sockaddr *addr, <span class="keywordtype">int</span> *addrlen)
<a name="l02972"></a>02972 {
<a name="l02973"></a>02973     <span class="keywordtype">int</span> r;
<a name="l02974"></a>02974     <span class="keywordtype">int</span> ret;
<a name="l02975"></a>02975     <span class="keywordtype">int</span> mode;
<a name="l02976"></a>02976     <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> data;
<a name="l02977"></a>02977     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> flg;
<a name="l02978"></a>02978     WSAOVERLAPPED wol;
<a name="l02979"></a>02979     WSABUF wbuf;
<a name="l02980"></a>02980     SOCKET s;
<a name="l02981"></a>02981 
<a name="l02982"></a>02982     <span class="keywordflow">if</span> (!NtSocketsInitialized)
<a name="l02983"></a>02983         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l02984"></a>02984 
<a name="l02985"></a>02985     s = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(fd);
<a name="l02986"></a>02986     <a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(socklist, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)s, &amp;data);
<a name="l02987"></a>02987     mode = (int)data;
<a name="l02988"></a>02988     <span class="keywordflow">if</span> (!cancel_io || (mode &amp; <a class="code" href="../../dc/db1/win32_8h.html#a39d33ce33804efd4d52606d59071c6d8">O_NONBLOCK</a>)) {
<a name="l02989"></a>02989         <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l02990"></a>02990             <span class="keywordflow">if</span> (input) {
<a name="l02991"></a>02991                 <span class="keywordflow">if</span> (addr &amp;&amp; addrlen)
<a name="l02992"></a>02992                     r = recvfrom(s, buf, len, flags, addr, addrlen);
<a name="l02993"></a>02993                 <span class="keywordflow">else</span>
<a name="l02994"></a>02994                     r = recv(s, buf, len, flags);
<a name="l02995"></a>02995             }
<a name="l02996"></a>02996             <span class="keywordflow">else</span> {
<a name="l02997"></a>02997                 <span class="keywordflow">if</span> (addr &amp;&amp; addrlen)
<a name="l02998"></a>02998                     r = sendto(s, buf, len, flags, addr, *addrlen);
<a name="l02999"></a>02999                 <span class="keywordflow">else</span>
<a name="l03000"></a>03000                     r = send(s, buf, len, flags);
<a name="l03001"></a>03001             }
<a name="l03002"></a>03002             <span class="keywordflow">if</span> (r == SOCKET_ERROR)
<a name="l03003"></a>03003                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l03004"></a>03004         });
<a name="l03005"></a>03005     }
<a name="l03006"></a>03006     <span class="keywordflow">else</span> {
<a name="l03007"></a>03007         <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>;
<a name="l03008"></a>03008         <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> rlen;
<a name="l03009"></a>03009         wbuf.len = len;
<a name="l03010"></a>03010         wbuf.buf = buf;
<a name="l03011"></a>03011         memset(&amp;wol, 0, <span class="keyword">sizeof</span>(wol));
<a name="l03012"></a>03012         <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03013"></a>03013             wol.hEvent = CreateEvent(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03014"></a>03014             <span class="keywordflow">if</span> (input) {
<a name="l03015"></a>03015                 flg = flags;
<a name="l03016"></a>03016                 <span class="keywordflow">if</span> (addr &amp;&amp; addrlen)
<a name="l03017"></a>03017                     ret = WSARecvFrom(s, &amp;wbuf, 1, &amp;size, &amp;flg, addr, addrlen,
<a name="l03018"></a>03018                                       &amp;wol, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03019"></a>03019                 <span class="keywordflow">else</span>
<a name="l03020"></a>03020                     ret = WSARecv(s, &amp;wbuf, 1, &amp;size, &amp;flg, &amp;wol, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03021"></a>03021             }
<a name="l03022"></a>03022             <span class="keywordflow">else</span> {
<a name="l03023"></a>03023                 <span class="keywordflow">if</span> (addr &amp;&amp; addrlen)
<a name="l03024"></a>03024                     ret = WSASendTo(s, &amp;wbuf, 1, &amp;size, flags, addr, *addrlen,
<a name="l03025"></a>03025                                     &amp;wol, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03026"></a>03026                 <span class="keywordflow">else</span>
<a name="l03027"></a>03027                     ret = WSASend(s, &amp;wbuf, 1, &amp;size, flags, &amp;wol, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03028"></a>03028             }
<a name="l03029"></a>03029         });
<a name="l03030"></a>03030 
<a name="l03031"></a>03031         <a class="code" href="../../d5/df2/win32_8c.html#a8a18a2ea747dae45d045c3d8a49115a1">finish_overlapped_socket</a>(s, &amp;wol, ret, &amp;rlen, size);
<a name="l03032"></a>03032         r = (int)rlen;
<a name="l03033"></a>03033     }
<a name="l03034"></a>03034 
<a name="l03035"></a>03035     <span class="keywordflow">return</span> r;
<a name="l03036"></a>03036 }
<a name="l03037"></a>03037 
<a name="l03038"></a>03038 <span class="keywordtype">int</span> WSAAPI
<a name="l03039"></a><a class="code" href="../../d5/df2/win32_8c.html#aa7eb9526a9d2508481ce77c26e910cec">03039</a> <a class="code" href="../../dc/db1/win32_8h.html#a4efbaac71d987aea996bee8a5b0f739a">rb_w32_recv</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>, <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <span class="keywordtype">int</span> flags)
<a name="l03040"></a>03040 {
<a name="l03041"></a>03041     <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#afd2d034d3ab2feb08f8f481b9d1c2d10">overlapped_socket_io</a>(<a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, fd, buf, len, flags, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03042"></a>03042 }
<a name="l03043"></a>03043 
<a name="l03044"></a>03044 <span class="keywordtype">int</span> WSAAPI
<a name="l03045"></a><a class="code" href="../../d5/df2/win32_8c.html#ae1b681c8faa59ed87c4b0a2f4383df00">03045</a> <a class="code" href="../../dc/db1/win32_8h.html#ae8bec837f46f6575680e4dd1d7d774a2">rb_w32_recvfrom</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>, <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <span class="keywordtype">int</span> flags,
<a name="l03046"></a>03046                 <span class="keyword">struct</span> sockaddr *from, <span class="keywordtype">int</span> *fromlen)
<a name="l03047"></a>03047 {
<a name="l03048"></a>03048     <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#afd2d034d3ab2feb08f8f481b9d1c2d10">overlapped_socket_io</a>(<a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, fd, buf, len, flags, from, fromlen);
<a name="l03049"></a>03049 }
<a name="l03050"></a>03050 
<a name="l03051"></a>03051 <span class="keywordtype">int</span> WSAAPI
<a name="l03052"></a><a class="code" href="../../d5/df2/win32_8c.html#a8d26fa99dbd6017189584c7018b39cf8">03052</a> <a class="code" href="../../dc/db1/win32_8h.html#a4fcc16a6694fcba033dc9b5933f8fc00">rb_w32_send</a>(<span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>, <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <span class="keywordtype">int</span> flags)
<a name="l03053"></a>03053 {
<a name="l03054"></a>03054     <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#afd2d034d3ab2feb08f8f481b9d1c2d10">overlapped_socket_io</a>(<a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, fd, (<span class="keywordtype">char</span> *)buf, len, flags, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03055"></a>03055 }
<a name="l03056"></a>03056 
<a name="l03057"></a>03057 <span class="keywordtype">int</span> WSAAPI
<a name="l03058"></a><a class="code" href="../../d5/df2/win32_8c.html#ab79221973847eeb0d113982212f5290f">03058</a> <a class="code" href="../../dc/db1/win32_8h.html#a07d9e2b41d9fcca04ae5ffd504f56a88">rb_w32_sendto</a>(<span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>, <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <span class="keywordtype">int</span> flags,
<a name="l03059"></a>03059               <span class="keyword">const</span> <span class="keyword">struct</span> sockaddr *to, <span class="keywordtype">int</span> tolen)
<a name="l03060"></a>03060 {
<a name="l03061"></a>03061     <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#afd2d034d3ab2feb08f8f481b9d1c2d10">overlapped_socket_io</a>(<a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, fd, (<span class="keywordtype">char</span> *)buf, len, flags,
<a name="l03062"></a>03062                                 (<span class="keyword">struct</span> sockaddr *)to, &amp;tolen);
<a name="l03063"></a>03063 }
<a name="l03064"></a>03064 
<a name="l03065"></a>03065 <span class="preprocessor">#if !defined(MSG_TRUNC) &amp;&amp; !defined(__MINGW32__)</span>
<a name="l03066"></a><a class="code" href="../../d2/da6/struct_w_s_a_m_s_g.html">03066</a> <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l03067"></a><a class="code" href="../../d2/da6/struct_w_s_a_m_s_g.html#a97c2892cbe230fddfb5596c40b5abd18">03067</a>     SOCKADDR *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>;
<a name="l03068"></a><a class="code" href="../../d2/da6/struct_w_s_a_m_s_g.html#a6c293f28fa1aa83eab9b4466a45c72c1">03068</a>     <span class="keywordtype">int</span> namelen;
<a name="l03069"></a><a class="code" href="../../d2/da6/struct_w_s_a_m_s_g.html#a7ec528a83ad35fbe6590276149a5d1c4">03069</a>     WSABUF *lpBuffers;
<a name="l03070"></a><a class="code" href="../../d2/da6/struct_w_s_a_m_s_g.html#afc3d86ea70984ebfac1fc2025bdc5b0f">03070</a>     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> dwBufferCount;
<a name="l03071"></a><a class="code" href="../../d2/da6/struct_w_s_a_m_s_g.html#a856e7ce26ffd707b22b240366f0630a5">03071</a>     WSABUF Control;
<a name="l03072"></a><a class="code" href="../../d2/da6/struct_w_s_a_m_s_g.html#a58f33d40b23ef4c7bb1bd66acae547c8">03072</a>     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> dwFlags;
<a name="l03073"></a>03073 } <a class="code" href="../../d2/da6/struct_w_s_a_m_s_g.html">WSAMSG</a>;
<a name="l03074"></a>03074 <span class="preprocessor">#endif</span>
<a name="l03075"></a>03075 <span class="preprocessor"></span><span class="preprocessor">#ifndef WSAID_WSARECVMSG</span>
<a name="l03076"></a><a class="code" href="../../d5/df2/win32_8c.html#a98d95b9fc26fa54bfa2c0c618ea6ac20">03076</a> <span class="preprocessor"></span><span class="preprocessor">#define WSAID_WSARECVMSG {0xf689d7c8,0x6f1f,0x436b,{0x8a,0x53,0xe5,0x4f,0xe3,0x51,0xc3,0x22}}</span>
<a name="l03077"></a>03077 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l03078"></a>03078 <span class="preprocessor"></span><span class="preprocessor">#ifndef WSAID_WSASENDMSG</span>
<a name="l03079"></a><a class="code" href="../../d5/df2/win32_8c.html#a63b892ef58069d31779644cbaa93bfc3">03079</a> <span class="preprocessor"></span><span class="preprocessor">#define WSAID_WSASENDMSG {0xa441e712,0x754f,0x43ca,{0x84,0xa7,0x0d,0xee,0x44,0xcf,0x60,0x6d}}</span>
<a name="l03080"></a>03080 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l03081"></a>03081 <span class="preprocessor"></span>
<a name="l03082"></a><a class="code" href="../../d5/df2/win32_8c.html#ad61aed0992c8caa65c04bdbb1bca1bb5">03082</a> <span class="preprocessor">#define msghdr_to_wsamsg(msg, wsamsg) \</span>
<a name="l03083"></a>03083 <span class="preprocessor">    do { \</span>
<a name="l03084"></a>03084 <span class="preprocessor">        int i; \</span>
<a name="l03085"></a>03085 <span class="preprocessor">        (wsamsg)-&gt;name = (msg)-&gt;msg_name; \</span>
<a name="l03086"></a>03086 <span class="preprocessor">        (wsamsg)-&gt;namelen = (msg)-&gt;msg_namelen; \</span>
<a name="l03087"></a>03087 <span class="preprocessor">        (wsamsg)-&gt;lpBuffers = ALLOCA_N(WSABUF, (msg)-&gt;msg_iovlen); \</span>
<a name="l03088"></a>03088 <span class="preprocessor">        (wsamsg)-&gt;dwBufferCount = (msg)-&gt;msg_iovlen; \</span>
<a name="l03089"></a>03089 <span class="preprocessor">        for (i = 0; i &lt; (msg)-&gt;msg_iovlen; ++i) { \</span>
<a name="l03090"></a>03090 <span class="preprocessor">            (wsamsg)-&gt;lpBuffers[i].buf = (msg)-&gt;msg_iov[i].iov_base; \</span>
<a name="l03091"></a>03091 <span class="preprocessor">            (wsamsg)-&gt;lpBuffers[i].len = (msg)-&gt;msg_iov[i].iov_len; \</span>
<a name="l03092"></a>03092 <span class="preprocessor">        } \</span>
<a name="l03093"></a>03093 <span class="preprocessor">        (wsamsg)-&gt;Control.buf = (msg)-&gt;msg_control; \</span>
<a name="l03094"></a>03094 <span class="preprocessor">        (wsamsg)-&gt;Control.len = (msg)-&gt;msg_controllen; \</span>
<a name="l03095"></a>03095 <span class="preprocessor">        (wsamsg)-&gt;dwFlags = (msg)-&gt;msg_flags; \</span>
<a name="l03096"></a>03096 <span class="preprocessor">    } while (0)</span>
<a name="l03097"></a>03097 <span class="preprocessor"></span>
<a name="l03098"></a>03098 <span class="keywordtype">int</span>
<a name="l03099"></a><a class="code" href="../../d5/df2/win32_8c.html#a9c899fc41812c9ce794ee10a4f61a0dd">03099</a> <a class="code" href="../../dc/db1/win32_8h.html#a256d6b1cfde9bfb7073fec395dd327f5">recvmsg</a>(<span class="keywordtype">int</span> fd, <span class="keyword">struct</span> <a class="code" href="../../d1/d4e/structmsghdr.html">msghdr</a> *<a class="code" href="../../d5/d04/strerror_8c.html#ae4f3f55be5de649fd367081b9d1b4b0c">msg</a>, <span class="keywordtype">int</span> flags)
<a name="l03100"></a>03100 {
<a name="l03101"></a>03101     <span class="keyword">typedef</span> int (WSAAPI *WSARecvMsg_t)(SOCKET, <a class="code" href="../../d2/da6/struct_w_s_a_m_s_g.html">WSAMSG</a> *, <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> *, WSAOVERLAPPED *, LPWSAOVERLAPPED_COMPLETION_ROUTINE);
<a name="l03102"></a>03102     <span class="keyword">static</span> WSARecvMsg_t pWSARecvMsg = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03103"></a>03103     WSAMSG wsamsg;
<a name="l03104"></a>03104     SOCKET s;
<a name="l03105"></a>03105     <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> data;
<a name="l03106"></a>03106     <span class="keywordtype">int</span> mode;
<a name="l03107"></a>03107     DWORD <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l03108"></a>03108     <span class="keywordtype">int</span> ret;
<a name="l03109"></a>03109 
<a name="l03110"></a>03110     <span class="keywordflow">if</span> (!NtSocketsInitialized)
<a name="l03111"></a>03111         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l03112"></a>03112 
<a name="l03113"></a>03113     s = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(fd);
<a name="l03114"></a>03114 
<a name="l03115"></a>03115     <span class="keywordflow">if</span> (!pWSARecvMsg) {
<a name="l03116"></a>03116         <span class="keyword">static</span> GUID guid = <a class="code" href="../../d5/df2/win32_8c.html#a98d95b9fc26fa54bfa2c0c618ea6ac20">WSAID_WSARECVMSG</a>;
<a name="l03117"></a>03117         pWSARecvMsg = (WSARecvMsg_t)<a class="code" href="../../d5/df2/win32_8c.html#a4409d6ff23e91d6b8933321cb313c10b">get_wsa_extension_function</a>(s, &amp;guid);
<a name="l03118"></a>03118         <span class="keywordflow">if</span> (!pWSARecvMsg)
<a name="l03119"></a>03119             <span class="keywordflow">return</span> -1;
<a name="l03120"></a>03120     }
<a name="l03121"></a>03121 
<a name="l03122"></a>03122     <a class="code" href="../../d5/df2/win32_8c.html#ad61aed0992c8caa65c04bdbb1bca1bb5">msghdr_to_wsamsg</a>(msg, &amp;wsamsg);
<a name="l03123"></a>03123     wsamsg.<a class="code" href="../../d2/da6/struct_w_s_a_m_s_g.html#a58f33d40b23ef4c7bb1bd66acae547c8">dwFlags</a> |= flags;
<a name="l03124"></a>03124 
<a name="l03125"></a>03125     <a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(socklist, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)s, &amp;data);
<a name="l03126"></a>03126     mode = (int)data;
<a name="l03127"></a>03127     <span class="keywordflow">if</span> (!cancel_io || (mode &amp; <a class="code" href="../../dc/db1/win32_8h.html#a39d33ce33804efd4d52606d59071c6d8">O_NONBLOCK</a>)) {
<a name="l03128"></a>03128         <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03129"></a>03129             <span class="keywordflow">if</span> ((ret = pWSARecvMsg(s, &amp;wsamsg, &amp;len, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) == SOCKET_ERROR) {
<a name="l03130"></a>03130                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l03131"></a>03131                 len = -1;
<a name="l03132"></a>03132             }
<a name="l03133"></a>03133         });
<a name="l03134"></a>03134     }
<a name="l03135"></a>03135     <span class="keywordflow">else</span> {
<a name="l03136"></a>03136         DWORD <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>;
<a name="l03137"></a>03137         WSAOVERLAPPED wol;
<a name="l03138"></a>03138         memset(&amp;wol, 0, <span class="keyword">sizeof</span>(wol));
<a name="l03139"></a>03139         <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03140"></a>03140             wol.hEvent = CreateEvent(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03141"></a>03141             ret = pWSARecvMsg(s, &amp;wsamsg, &amp;size, &amp;wol, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03142"></a>03142         });
<a name="l03143"></a>03143 
<a name="l03144"></a>03144         ret = <a class="code" href="../../d5/df2/win32_8c.html#a8a18a2ea747dae45d045c3d8a49115a1">finish_overlapped_socket</a>(s, &amp;wol, ret, &amp;len, size);
<a name="l03145"></a>03145     }
<a name="l03146"></a>03146     <span class="keywordflow">if</span> (ret == SOCKET_ERROR)
<a name="l03147"></a>03147         <span class="keywordflow">return</span> -1;
<a name="l03148"></a>03148 
<a name="l03149"></a>03149     <span class="comment">/* WSAMSG to msghdr */</span>
<a name="l03150"></a>03150     msg-&gt;<a class="code" href="../../d1/d4e/structmsghdr.html#a691a8866b21c7083974a2ff1e7987ce1">msg_name</a> = wsamsg.<a class="code" href="../../d2/da6/struct_w_s_a_m_s_g.html#a97c2892cbe230fddfb5596c40b5abd18">name</a>;
<a name="l03151"></a>03151     msg-&gt;<a class="code" href="../../d1/d4e/structmsghdr.html#a8d5b5be3ce710ed39fc66824757407ff">msg_namelen</a> = wsamsg.<a class="code" href="../../d2/da6/struct_w_s_a_m_s_g.html#a6c293f28fa1aa83eab9b4466a45c72c1">namelen</a>;
<a name="l03152"></a>03152     msg-&gt;<a class="code" href="../../d1/d4e/structmsghdr.html#a9e8ff97d402c99551cbfd564e9e10a74">msg_flags</a> = wsamsg.<a class="code" href="../../d2/da6/struct_w_s_a_m_s_g.html#a58f33d40b23ef4c7bb1bd66acae547c8">dwFlags</a>;
<a name="l03153"></a>03153 
<a name="l03154"></a>03154     <span class="keywordflow">return</span> len;
<a name="l03155"></a>03155 }
<a name="l03156"></a>03156 
<a name="l03157"></a>03157 <span class="keywordtype">int</span>
<a name="l03158"></a><a class="code" href="../../d5/df2/win32_8c.html#a31425b0d1519cf6615e455f123580702">03158</a> <a class="code" href="../../dc/db1/win32_8h.html#a572dee55eb30bcdc62ef201644157580">sendmsg</a>(<span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../d1/d4e/structmsghdr.html">msghdr</a> *<a class="code" href="../../d5/d04/strerror_8c.html#ae4f3f55be5de649fd367081b9d1b4b0c">msg</a>, <span class="keywordtype">int</span> flags)
<a name="l03159"></a>03159 {
<a name="l03160"></a>03160     <span class="keyword">typedef</span> int (WSAAPI *WSASendMsg_t)(SOCKET, <span class="keyword">const</span> <a class="code" href="../../d2/da6/struct_w_s_a_m_s_g.html">WSAMSG</a> *, <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>, DWORD *, WSAOVERLAPPED *, LPWSAOVERLAPPED_COMPLETION_ROUTINE);
<a name="l03161"></a>03161     <span class="keyword">static</span> WSASendMsg_t pWSASendMsg = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03162"></a>03162     WSAMSG wsamsg;
<a name="l03163"></a>03163     SOCKET s;
<a name="l03164"></a>03164     <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> data;
<a name="l03165"></a>03165     <span class="keywordtype">int</span> mode;
<a name="l03166"></a>03166     DWORD <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l03167"></a>03167     <span class="keywordtype">int</span> ret;
<a name="l03168"></a>03168 
<a name="l03169"></a>03169     <span class="keywordflow">if</span> (!NtSocketsInitialized)
<a name="l03170"></a>03170         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l03171"></a>03171 
<a name="l03172"></a>03172     s = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(fd);
<a name="l03173"></a>03173 
<a name="l03174"></a>03174     <span class="keywordflow">if</span> (!pWSASendMsg) {
<a name="l03175"></a>03175         <span class="keyword">static</span> GUID guid = <a class="code" href="../../d5/df2/win32_8c.html#a63b892ef58069d31779644cbaa93bfc3">WSAID_WSASENDMSG</a>;
<a name="l03176"></a>03176         pWSASendMsg = (WSASendMsg_t)<a class="code" href="../../d5/df2/win32_8c.html#a4409d6ff23e91d6b8933321cb313c10b">get_wsa_extension_function</a>(s, &amp;guid);
<a name="l03177"></a>03177         <span class="keywordflow">if</span> (!pWSASendMsg)
<a name="l03178"></a>03178             <span class="keywordflow">return</span> -1;
<a name="l03179"></a>03179     }
<a name="l03180"></a>03180 
<a name="l03181"></a>03181     <a class="code" href="../../d5/df2/win32_8c.html#ad61aed0992c8caa65c04bdbb1bca1bb5">msghdr_to_wsamsg</a>(msg, &amp;wsamsg);
<a name="l03182"></a>03182 
<a name="l03183"></a>03183     <a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(socklist, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)s, &amp;data);
<a name="l03184"></a>03184     mode = (int)data;
<a name="l03185"></a>03185     <span class="keywordflow">if</span> (!cancel_io || (mode &amp; <a class="code" href="../../dc/db1/win32_8h.html#a39d33ce33804efd4d52606d59071c6d8">O_NONBLOCK</a>)) {
<a name="l03186"></a>03186         <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03187"></a>03187             <span class="keywordflow">if</span> ((ret = pWSASendMsg(s, &amp;wsamsg, flags, &amp;len, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) == SOCKET_ERROR) {
<a name="l03188"></a>03188                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l03189"></a>03189                 len = -1;
<a name="l03190"></a>03190             }
<a name="l03191"></a>03191         });
<a name="l03192"></a>03192     }
<a name="l03193"></a>03193     <span class="keywordflow">else</span> {
<a name="l03194"></a>03194         DWORD <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>;
<a name="l03195"></a>03195         WSAOVERLAPPED wol;
<a name="l03196"></a>03196         memset(&amp;wol, 0, <span class="keyword">sizeof</span>(wol));
<a name="l03197"></a>03197         <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03198"></a>03198             wol.hEvent = CreateEvent(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03199"></a>03199             ret = pWSASendMsg(s, &amp;wsamsg, flags, &amp;size, &amp;wol, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03200"></a>03200         });
<a name="l03201"></a>03201 
<a name="l03202"></a>03202         <a class="code" href="../../d5/df2/win32_8c.html#a8a18a2ea747dae45d045c3d8a49115a1">finish_overlapped_socket</a>(s, &amp;wol, ret, &amp;len, size);
<a name="l03203"></a>03203     }
<a name="l03204"></a>03204 
<a name="l03205"></a>03205     <span class="keywordflow">return</span> len;
<a name="l03206"></a>03206 }
<a name="l03207"></a>03207 
<a name="l03208"></a>03208 <span class="preprocessor">#undef setsockopt</span>
<a name="l03209"></a>03209 <span class="preprocessor"></span>
<a name="l03210"></a>03210 <span class="keywordtype">int</span> WSAAPI
<a name="l03211"></a><a class="code" href="../../d5/df2/win32_8c.html#a68247cba4362e4c1969d814376fbe79e">03211</a> <a class="code" href="../../dc/db1/win32_8h.html#aa950e43dcf2f0b140d02025659c55aae">rb_w32_setsockopt</a>(<span class="keywordtype">int</span> s, <span class="keywordtype">int</span> level, <span class="keywordtype">int</span> optname, <span class="keyword">const</span> <span class="keywordtype">char</span> *optval, <span class="keywordtype">int</span> optlen)
<a name="l03212"></a>03212 {
<a name="l03213"></a>03213     <span class="keywordtype">int</span> r;
<a name="l03214"></a>03214     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l03215"></a>03215         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l03216"></a>03216     }
<a name="l03217"></a>03217     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03218"></a>03218         r = setsockopt(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(s), level, optname, optval, optlen);
<a name="l03219"></a>03219         <span class="keywordflow">if</span> (r == SOCKET_ERROR)
<a name="l03220"></a>03220             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l03221"></a>03221     });
<a name="l03222"></a>03222     <span class="keywordflow">return</span> r;
<a name="l03223"></a>03223 }
<a name="l03224"></a>03224 
<a name="l03225"></a>03225 <span class="preprocessor">#undef shutdown</span>
<a name="l03226"></a>03226 <span class="preprocessor"></span>
<a name="l03227"></a>03227 <span class="keywordtype">int</span> WSAAPI
<a name="l03228"></a><a class="code" href="../../d5/df2/win32_8c.html#a0c3379c04967762a36a824934eda3847">03228</a> <a class="code" href="../../dc/db1/win32_8h.html#a67f9e65032b440f712580f8b845a10df">rb_w32_shutdown</a>(<span class="keywordtype">int</span> s, <span class="keywordtype">int</span> how)
<a name="l03229"></a>03229 {
<a name="l03230"></a>03230     <span class="keywordtype">int</span> r;
<a name="l03231"></a>03231     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l03232"></a>03232         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l03233"></a>03233     }
<a name="l03234"></a>03234     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03235"></a>03235         r = <a class="code" href="../../df/d0a/io_8c.html#a0db1bf6a85e45f4d6ead85a2fc43c871">shutdown</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(s), how);
<a name="l03236"></a>03236         <span class="keywordflow">if</span> (r == SOCKET_ERROR)
<a name="l03237"></a>03237             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l03238"></a>03238     });
<a name="l03239"></a>03239     <span class="keywordflow">return</span> r;
<a name="l03240"></a>03240 }
<a name="l03241"></a>03241 
<a name="l03242"></a>03242 <span class="keyword">static</span> SOCKET
<a name="l03243"></a><a class="code" href="../../d5/df2/win32_8c.html#ab29f076152eb3c04881f770aca6bb67f">03243</a> <a class="code" href="../../d5/df2/win32_8c.html#ab29f076152eb3c04881f770aca6bb67f">open_ifs_socket</a>(<span class="keywordtype">int</span> af, <span class="keywordtype">int</span> <a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>, <span class="keywordtype">int</span> protocol)
<a name="l03244"></a>03244 {
<a name="l03245"></a>03245     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> proto_buffers_len = 0;
<a name="l03246"></a>03246     <span class="keywordtype">int</span> error_code;
<a name="l03247"></a>03247     SOCKET out = INVALID_SOCKET;
<a name="l03248"></a>03248 
<a name="l03249"></a>03249     <span class="keywordflow">if</span> (WSAEnumProtocols(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;proto_buffers_len) == SOCKET_ERROR) {
<a name="l03250"></a>03250         error_code = WSAGetLastError();
<a name="l03251"></a>03251         <span class="keywordflow">if</span> (error_code == WSAENOBUFS) {
<a name="l03252"></a>03252             WSAPROTOCOL_INFO *proto_buffers;
<a name="l03253"></a>03253             <span class="keywordtype">int</span> protocols_available = 0;
<a name="l03254"></a>03254 
<a name="l03255"></a>03255             proto_buffers = (WSAPROTOCOL_INFO *)<a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(proto_buffers_len);
<a name="l03256"></a>03256             <span class="keywordflow">if</span> (!proto_buffers) {
<a name="l03257"></a>03257                 WSASetLastError(WSA_NOT_ENOUGH_MEMORY);
<a name="l03258"></a>03258                 <span class="keywordflow">return</span> INVALID_SOCKET;
<a name="l03259"></a>03259             }
<a name="l03260"></a>03260 
<a name="l03261"></a>03261             protocols_available =
<a name="l03262"></a>03262                 WSAEnumProtocols(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, proto_buffers, &amp;proto_buffers_len);
<a name="l03263"></a>03263             <span class="keywordflow">if</span> (protocols_available != SOCKET_ERROR) {
<a name="l03264"></a>03264                 <span class="keywordtype">int</span> i;
<a name="l03265"></a>03265                 <span class="keywordflow">for</span> (i = 0; i &lt; protocols_available; i++) {
<a name="l03266"></a>03266                     <span class="keywordflow">if</span> ((af != <a class="code" href="../../d6/d07/sockport_8h.html#ae77ae24b14b7b7f294f3e04121173f12">AF_UNSPEC</a> &amp;&amp; af != proto_buffers[i].iAddressFamily) ||
<a name="l03267"></a>03267                         (type != proto_buffers[i].iSocketType) ||
<a name="l03268"></a>03268                         (protocol != 0 &amp;&amp; protocol != proto_buffers[i].iProtocol))
<a name="l03269"></a>03269                         <span class="keywordflow">continue</span>;
<a name="l03270"></a>03270 
<a name="l03271"></a>03271                     <span class="keywordflow">if</span> ((proto_buffers[i].dwServiceFlags1 &amp; XP1_IFS_HANDLES) == 0)
<a name="l03272"></a>03272                         <span class="keywordflow">continue</span>;
<a name="l03273"></a>03273 
<a name="l03274"></a>03274                     out = WSASocket(af, type, protocol, &amp;(proto_buffers[i]), 0,
<a name="l03275"></a>03275                                     WSA_FLAG_OVERLAPPED);
<a name="l03276"></a>03276                     <span class="keywordflow">break</span>;
<a name="l03277"></a>03277                 }
<a name="l03278"></a>03278                 <span class="keywordflow">if</span> (out == INVALID_SOCKET)
<a name="l03279"></a>03279                     out = WSASocket(af, type, protocol, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, 0);
<a name="l03280"></a>03280             }
<a name="l03281"></a>03281 
<a name="l03282"></a>03282             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(proto_buffers);
<a name="l03283"></a>03283         }
<a name="l03284"></a>03284     }
<a name="l03285"></a>03285 
<a name="l03286"></a>03286     <span class="keywordflow">return</span> out;
<a name="l03287"></a>03287 }
<a name="l03288"></a>03288 
<a name="l03289"></a>03289 <span class="preprocessor">#undef socket</span>
<a name="l03290"></a>03290 <span class="preprocessor"></span>
<a name="l03291"></a>03291 <span class="keywordtype">int</span> WSAAPI
<a name="l03292"></a><a class="code" href="../../d5/df2/win32_8c.html#a07fd9b99edfa96a4ead0a67c16c7c22b">03292</a> <a class="code" href="../../dc/db1/win32_8h.html#a6bc5c5c008d42c493612098e8cc9c764">rb_w32_socket</a>(<span class="keywordtype">int</span> af, <span class="keywordtype">int</span> <a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>, <span class="keywordtype">int</span> protocol)
<a name="l03293"></a>03293 {
<a name="l03294"></a>03294     SOCKET s;
<a name="l03295"></a>03295     <span class="keywordtype">int</span> fd;
<a name="l03296"></a>03296 
<a name="l03297"></a>03297     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l03298"></a>03298         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l03299"></a>03299     }
<a name="l03300"></a>03300     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03301"></a>03301         s = <a class="code" href="../../d5/df2/win32_8c.html#ab29f076152eb3c04881f770aca6bb67f">open_ifs_socket</a>(af, type, protocol);
<a name="l03302"></a>03302         <span class="keywordflow">if</span> (s == INVALID_SOCKET) {
<a name="l03303"></a>03303             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l03304"></a>03304             fd = -1;
<a name="l03305"></a>03305         }
<a name="l03306"></a>03306         <span class="keywordflow">else</span> {
<a name="l03307"></a>03307             fd = <a class="code" href="../../d5/df2/win32_8c.html#a4611af37727832d276705e41ed08ecb8">rb_w32_open_osfhandle</a>(s, O_RDWR|<a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>|O_NOINHERIT);
<a name="l03308"></a>03308             <span class="keywordflow">if</span> (fd != -1)
<a name="l03309"></a>03309                 <a class="code" href="../../dd/d24/st_8h.html#acdc42c01229b7537ea5a4c6965c7e47a">st_insert</a>(socklist, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)s, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)0);
<a name="l03310"></a>03310             <span class="keywordflow">else</span>
<a name="l03311"></a>03311                 closesocket(s);
<a name="l03312"></a>03312         }
<a name="l03313"></a>03313     });
<a name="l03314"></a>03314     <span class="keywordflow">return</span> fd;
<a name="l03315"></a>03315 }
<a name="l03316"></a>03316 
<a name="l03317"></a>03317 <span class="preprocessor">#undef gethostbyaddr</span>
<a name="l03318"></a>03318 <span class="preprocessor"></span>
<a name="l03319"></a>03319 <span class="keyword">struct </span>hostent * WSAAPI
<a name="l03320"></a><a class="code" href="../../d5/df2/win32_8c.html#af7fd1915365ab6567681cef391f2eae6">03320</a> <a class="code" href="../../dc/db1/win32_8h.html#a51fea660caea399449c96d77165737d9">rb_w32_gethostbyaddr</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *addr, <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <span class="keywordtype">int</span> <a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>)
<a name="l03321"></a>03321 {
<a name="l03322"></a>03322     <span class="keyword">struct </span>hostent *r;
<a name="l03323"></a>03323     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l03324"></a>03324         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l03325"></a>03325     }
<a name="l03326"></a>03326     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03327"></a>03327         r = gethostbyaddr(addr, len, type);
<a name="l03328"></a>03328         <span class="keywordflow">if</span> (r == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03329"></a>03329             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l03330"></a>03330     });
<a name="l03331"></a>03331     <span class="keywordflow">return</span> r;
<a name="l03332"></a>03332 }
<a name="l03333"></a>03333 
<a name="l03334"></a>03334 <span class="preprocessor">#undef gethostbyname</span>
<a name="l03335"></a>03335 <span class="preprocessor"></span>
<a name="l03336"></a>03336 <span class="keyword">struct </span>hostent * WSAAPI
<a name="l03337"></a><a class="code" href="../../d5/df2/win32_8c.html#a7334d1cee678ef3d7e50d7e010e564e1">03337</a> <a class="code" href="../../dc/db1/win32_8h.html#ae9053d8747bc80e03af154db8368d67b">rb_w32_gethostbyname</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)
<a name="l03338"></a>03338 {
<a name="l03339"></a>03339     <span class="keyword">struct </span>hostent *r;
<a name="l03340"></a>03340     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l03341"></a>03341         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l03342"></a>03342     }
<a name="l03343"></a>03343     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03344"></a>03344         r = gethostbyname(name);
<a name="l03345"></a>03345         <span class="keywordflow">if</span> (r == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03346"></a>03346             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l03347"></a>03347     });
<a name="l03348"></a>03348     <span class="keywordflow">return</span> r;
<a name="l03349"></a>03349 }
<a name="l03350"></a>03350 
<a name="l03351"></a>03351 <span class="preprocessor">#undef gethostname</span>
<a name="l03352"></a>03352 <span class="preprocessor"></span>
<a name="l03353"></a>03353 <span class="keywordtype">int</span> WSAAPI
<a name="l03354"></a><a class="code" href="../../d5/df2/win32_8c.html#a9403dd49b77337cd0c5f2c17604e9921">03354</a> <a class="code" href="../../dc/db1/win32_8h.html#a2eb9b9406c2cde62b91f5bff97051b03">rb_w32_gethostname</a>(<span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>)
<a name="l03355"></a>03355 {
<a name="l03356"></a>03356     <span class="keywordtype">int</span> r;
<a name="l03357"></a>03357     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l03358"></a>03358         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l03359"></a>03359     }
<a name="l03360"></a>03360     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03361"></a>03361         r = gethostname(name, len);
<a name="l03362"></a>03362         <span class="keywordflow">if</span> (r == SOCKET_ERROR)
<a name="l03363"></a>03363             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l03364"></a>03364     });
<a name="l03365"></a>03365     <span class="keywordflow">return</span> r;
<a name="l03366"></a>03366 }
<a name="l03367"></a>03367 
<a name="l03368"></a>03368 <span class="preprocessor">#undef getprotobyname</span>
<a name="l03369"></a>03369 <span class="preprocessor"></span>
<a name="l03370"></a>03370 <span class="keyword">struct </span>protoent * WSAAPI
<a name="l03371"></a><a class="code" href="../../d5/df2/win32_8c.html#a2252a4641c373204f69292f471c7dbac">03371</a> <a class="code" href="../../dc/db1/win32_8h.html#a6fc2cb9ca53cf1d76fc89d81a3243807">rb_w32_getprotobyname</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)
<a name="l03372"></a>03372 {
<a name="l03373"></a>03373     <span class="keyword">struct </span>protoent *r;
<a name="l03374"></a>03374     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l03375"></a>03375         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l03376"></a>03376     }
<a name="l03377"></a>03377     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03378"></a>03378         r = getprotobyname(name);
<a name="l03379"></a>03379         <span class="keywordflow">if</span> (r == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03380"></a>03380             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l03381"></a>03381     });
<a name="l03382"></a>03382     <span class="keywordflow">return</span> r;
<a name="l03383"></a>03383 }
<a name="l03384"></a>03384 
<a name="l03385"></a>03385 <span class="preprocessor">#undef getprotobynumber</span>
<a name="l03386"></a>03386 <span class="preprocessor"></span>
<a name="l03387"></a>03387 <span class="keyword">struct </span>protoent * WSAAPI
<a name="l03388"></a><a class="code" href="../../d5/df2/win32_8c.html#a34595d50310dce8fcc93441059a6b727">03388</a> <a class="code" href="../../dc/db1/win32_8h.html#a94aeabf0fe257328710305c7ee7d7d18">rb_w32_getprotobynumber</a>(<span class="keywordtype">int</span> num)
<a name="l03389"></a>03389 {
<a name="l03390"></a>03390     <span class="keyword">struct </span>protoent *r;
<a name="l03391"></a>03391     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l03392"></a>03392         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l03393"></a>03393     }
<a name="l03394"></a>03394     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03395"></a>03395         r = getprotobynumber(num);
<a name="l03396"></a>03396         <span class="keywordflow">if</span> (r == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03397"></a>03397             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l03398"></a>03398     });
<a name="l03399"></a>03399     <span class="keywordflow">return</span> r;
<a name="l03400"></a>03400 }
<a name="l03401"></a>03401 
<a name="l03402"></a>03402 <span class="preprocessor">#undef getservbyname</span>
<a name="l03403"></a>03403 <span class="preprocessor"></span>
<a name="l03404"></a>03404 <span class="keyword">struct </span>servent * WSAAPI
<a name="l03405"></a><a class="code" href="../../d5/df2/win32_8c.html#a28cd48f01a95d13d07abb747096b205c">03405</a> <a class="code" href="../../dc/db1/win32_8h.html#a903d39ee78b33bc80dea698e6bcd8d6e">rb_w32_getservbyname</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dd/d78/sdbm_8h.html#aacac89d131c6cbb876539c74747c8c50">proto</a>)
<a name="l03406"></a>03406 {
<a name="l03407"></a>03407     <span class="keyword">struct </span>servent *r;
<a name="l03408"></a>03408     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l03409"></a>03409         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l03410"></a>03410     }
<a name="l03411"></a>03411     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03412"></a>03412         r = getservbyname(name, proto);
<a name="l03413"></a>03413         <span class="keywordflow">if</span> (r == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03414"></a>03414             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l03415"></a>03415     });
<a name="l03416"></a>03416     <span class="keywordflow">return</span> r;
<a name="l03417"></a>03417 }
<a name="l03418"></a>03418 
<a name="l03419"></a>03419 <span class="preprocessor">#undef getservbyport</span>
<a name="l03420"></a>03420 <span class="preprocessor"></span>
<a name="l03421"></a>03421 <span class="keyword">struct </span>servent * WSAAPI
<a name="l03422"></a><a class="code" href="../../d5/df2/win32_8c.html#a2cc81369f56920c781a0e1a7b489f4c6">03422</a> <a class="code" href="../../dc/db1/win32_8h.html#a62c4ae7f88a7ee6d305f6c50e5bbabfe">rb_w32_getservbyport</a>(<span class="keywordtype">int</span> port, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dd/d78/sdbm_8h.html#aacac89d131c6cbb876539c74747c8c50">proto</a>)
<a name="l03423"></a>03423 {
<a name="l03424"></a>03424     <span class="keyword">struct </span>servent *r;
<a name="l03425"></a>03425     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l03426"></a>03426         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l03427"></a>03427     }
<a name="l03428"></a>03428     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03429"></a>03429         r = getservbyport(port, proto);
<a name="l03430"></a>03430         <span class="keywordflow">if</span> (r == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l03431"></a>03431             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l03432"></a>03432     });
<a name="l03433"></a>03433     <span class="keywordflow">return</span> r;
<a name="l03434"></a>03434 }
<a name="l03435"></a>03435 
<a name="l03436"></a>03436 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l03437"></a><a class="code" href="../../d5/df2/win32_8c.html#a30e3564db46c2c65cd9c253bf8dec489">03437</a> <a class="code" href="../../d5/df2/win32_8c.html#a30e3564db46c2c65cd9c253bf8dec489">socketpair_internal</a>(<span class="keywordtype">int</span> af, <span class="keywordtype">int</span> <a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>, <span class="keywordtype">int</span> protocol, SOCKET *sv)
<a name="l03438"></a>03438 {
<a name="l03439"></a>03439     SOCKET svr = INVALID_SOCKET, r = INVALID_SOCKET, w = INVALID_SOCKET;
<a name="l03440"></a>03440     <span class="keyword">struct </span>sockaddr_in sock_in4;
<a name="l03441"></a>03441 <span class="preprocessor">#ifdef INET6</span>
<a name="l03442"></a>03442 <span class="preprocessor"></span>    <span class="keyword">struct </span>sockaddr_in6 sock_in6;
<a name="l03443"></a>03443 <span class="preprocessor">#endif</span>
<a name="l03444"></a>03444 <span class="preprocessor"></span>    <span class="keyword">struct </span>sockaddr *addr;
<a name="l03445"></a>03445     <span class="keywordtype">int</span> ret = -1;
<a name="l03446"></a>03446     <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l03447"></a>03447 
<a name="l03448"></a>03448     <span class="keywordflow">if</span> (!NtSocketsInitialized) {
<a name="l03449"></a>03449         <a class="code" href="../../d5/df2/win32_8c.html#afbcf80e28aa93da44e69f649a4b5a454">StartSockets</a>();
<a name="l03450"></a>03450     }
<a name="l03451"></a>03451 
<a name="l03452"></a>03452     <span class="keywordflow">switch</span> (af) {
<a name="l03453"></a>03453       <span class="keywordflow">case</span> AF_INET:
<a name="l03454"></a>03454 <span class="preprocessor">#if defined PF_INET &amp;&amp; PF_INET != AF_INET</span>
<a name="l03455"></a>03455 <span class="preprocessor"></span>      <span class="keywordflow">case</span> <a class="code" href="../../d6/d07/sockport_8h.html#a3f5da0b5be27fe31ec7cc11bfa8d1a25">PF_INET</a>:
<a name="l03456"></a>03456 <span class="preprocessor">#endif</span>
<a name="l03457"></a>03457 <span class="preprocessor"></span>        sock_in4.sin_family = AF_INET;
<a name="l03458"></a>03458         sock_in4.sin_port = 0;
<a name="l03459"></a>03459         sock_in4.sin_addr.s_addr = htonl(INADDR_LOOPBACK);
<a name="l03460"></a>03460         addr = (<span class="keyword">struct </span>sockaddr *)&amp;sock_in4;
<a name="l03461"></a>03461         len = <span class="keyword">sizeof</span>(sock_in4);
<a name="l03462"></a>03462         <span class="keywordflow">break</span>;
<a name="l03463"></a>03463 <span class="preprocessor">#ifdef INET6</span>
<a name="l03464"></a>03464 <span class="preprocessor"></span>      <span class="keywordflow">case</span> AF_INET6:
<a name="l03465"></a>03465         memset(&amp;sock_in6, 0, <span class="keyword">sizeof</span>(sock_in6));
<a name="l03466"></a>03466         sock_in6.sin6_family = AF_INET6;
<a name="l03467"></a>03467         sock_in6.sin6_addr = IN6ADDR_LOOPBACK_INIT;
<a name="l03468"></a>03468         addr = (<span class="keyword">struct </span>sockaddr *)&amp;sock_in6;
<a name="l03469"></a>03469         len = <span class="keyword">sizeof</span>(sock_in6);
<a name="l03470"></a>03470         <span class="keywordflow">break</span>;
<a name="l03471"></a>03471 <span class="preprocessor">#endif</span>
<a name="l03472"></a>03472 <span class="preprocessor"></span>      <span class="keywordflow">default</span>:
<a name="l03473"></a>03473         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../dc/db1/win32_8h.html#a4c3a793b4d51cb7dd020af92e536fe21">EAFNOSUPPORT</a>;
<a name="l03474"></a>03474         <span class="keywordflow">return</span> -1;
<a name="l03475"></a>03475     }
<a name="l03476"></a>03476     <span class="keywordflow">if</span> (type != SOCK_STREAM) {
<a name="l03477"></a>03477         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../dc/db1/win32_8h.html#ae6014faa948366b8321d755204acf755">EPROTOTYPE</a>;
<a name="l03478"></a>03478         <span class="keywordflow">return</span> -1;
<a name="l03479"></a>03479     }
<a name="l03480"></a>03480 
<a name="l03481"></a>03481     sv[0] = (SOCKET)INVALID_HANDLE_VALUE;
<a name="l03482"></a>03482     sv[1] = (SOCKET)INVALID_HANDLE_VALUE;
<a name="l03483"></a>03483     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03484"></a>03484         <span class="keywordflow">do</span> {
<a name="l03485"></a>03485             svr = <a class="code" href="../../d5/df2/win32_8c.html#ab29f076152eb3c04881f770aca6bb67f">open_ifs_socket</a>(af, type, protocol);
<a name="l03486"></a>03486             <span class="keywordflow">if</span> (svr == INVALID_SOCKET)
<a name="l03487"></a>03487                 <span class="keywordflow">break</span>;
<a name="l03488"></a>03488             <span class="keywordflow">if</span> (bind(svr, addr, len) &lt; 0)
<a name="l03489"></a>03489                 <span class="keywordflow">break</span>;
<a name="l03490"></a>03490             <span class="keywordflow">if</span> (getsockname(svr, addr, &amp;len) &lt; 0)
<a name="l03491"></a>03491                 <span class="keywordflow">break</span>;
<a name="l03492"></a>03492             <span class="keywordflow">if</span> (type == SOCK_STREAM)
<a name="l03493"></a>03493                 listen(svr, 5);
<a name="l03494"></a>03494 
<a name="l03495"></a>03495             w = <a class="code" href="../../d5/df2/win32_8c.html#ab29f076152eb3c04881f770aca6bb67f">open_ifs_socket</a>(af, type, protocol);
<a name="l03496"></a>03496             <span class="keywordflow">if</span> (w == INVALID_SOCKET)
<a name="l03497"></a>03497                 <span class="keywordflow">break</span>;
<a name="l03498"></a>03498             <span class="keywordflow">if</span> (connect(w, addr, len) &lt; 0)
<a name="l03499"></a>03499                 <span class="keywordflow">break</span>;
<a name="l03500"></a>03500 
<a name="l03501"></a>03501             r = accept(svr, addr, &amp;len);
<a name="l03502"></a>03502             <span class="keywordflow">if</span> (r == INVALID_SOCKET)
<a name="l03503"></a>03503                 <span class="keywordflow">break</span>;
<a name="l03504"></a>03504 
<a name="l03505"></a>03505             ret = 0;
<a name="l03506"></a>03506         } <span class="keywordflow">while</span> (0);
<a name="l03507"></a>03507 
<a name="l03508"></a>03508         <span class="keywordflow">if</span> (ret &lt; 0) {
<a name="l03509"></a>03509             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l03510"></a>03510             <span class="keywordflow">if</span> (r != INVALID_SOCKET)
<a name="l03511"></a>03511                 closesocket(r);
<a name="l03512"></a>03512             <span class="keywordflow">if</span> (w != INVALID_SOCKET)
<a name="l03513"></a>03513                 closesocket(w);
<a name="l03514"></a>03514         }
<a name="l03515"></a>03515         <span class="keywordflow">else</span> {
<a name="l03516"></a>03516             sv[0] = r;
<a name="l03517"></a>03517             sv[1] = w;
<a name="l03518"></a>03518         }
<a name="l03519"></a>03519         <span class="keywordflow">if</span> (svr != INVALID_SOCKET)
<a name="l03520"></a>03520             closesocket(svr);
<a name="l03521"></a>03521     });
<a name="l03522"></a>03522 
<a name="l03523"></a>03523     <span class="keywordflow">return</span> ret;
<a name="l03524"></a>03524 }
<a name="l03525"></a>03525 
<a name="l03526"></a>03526 <span class="keywordtype">int</span>
<a name="l03527"></a><a class="code" href="../../d5/df2/win32_8c.html#a093e17cd90966a5d2eda8d9f6576167f">03527</a> <a class="code" href="../../dc/db1/win32_8h.html#ac548cc035ef35e10189bb7e626a9ef7c">rb_w32_socketpair</a>(<span class="keywordtype">int</span> af, <span class="keywordtype">int</span> <a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>, <span class="keywordtype">int</span> protocol, <span class="keywordtype">int</span> *sv)
<a name="l03528"></a>03528 {
<a name="l03529"></a>03529     SOCKET pair[2];
<a name="l03530"></a>03530 
<a name="l03531"></a>03531     <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a30e3564db46c2c65cd9c253bf8dec489">socketpair_internal</a>(af, type, protocol, pair) &lt; 0)
<a name="l03532"></a>03532         <span class="keywordflow">return</span> -1;
<a name="l03533"></a>03533     sv[0] = <a class="code" href="../../d5/df2/win32_8c.html#a4611af37727832d276705e41ed08ecb8">rb_w32_open_osfhandle</a>(pair[0], O_RDWR|<a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>|O_NOINHERIT);
<a name="l03534"></a>03534     <span class="keywordflow">if</span> (sv[0] == -1) {
<a name="l03535"></a>03535         closesocket(pair[0]);
<a name="l03536"></a>03536         closesocket(pair[1]);
<a name="l03537"></a>03537         <span class="keywordflow">return</span> -1;
<a name="l03538"></a>03538     }
<a name="l03539"></a>03539     sv[1] = <a class="code" href="../../d5/df2/win32_8c.html#a4611af37727832d276705e41ed08ecb8">rb_w32_open_osfhandle</a>(pair[1], O_RDWR|<a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>|O_NOINHERIT);
<a name="l03540"></a>03540     <span class="keywordflow">if</span> (sv[1] == -1) {
<a name="l03541"></a>03541         <a class="code" href="../../dc/db1/win32_8h.html#a03de7302ffcf75f0ab994c28c94302ff">rb_w32_close</a>(sv[0]);
<a name="l03542"></a>03542         closesocket(pair[1]);
<a name="l03543"></a>03543         <span class="keywordflow">return</span> -1;
<a name="l03544"></a>03544     }
<a name="l03545"></a>03545     <a class="code" href="../../dd/d24/st_8h.html#acdc42c01229b7537ea5a4c6965c7e47a">st_insert</a>(socklist, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)pair[0], (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)0);
<a name="l03546"></a>03546     <a class="code" href="../../dd/d24/st_8h.html#acdc42c01229b7537ea5a4c6965c7e47a">st_insert</a>(socklist, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)pair[1], (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)0);
<a name="l03547"></a>03547 
<a name="l03548"></a>03548     <span class="keywordflow">return</span> 0;
<a name="l03549"></a>03549 }
<a name="l03550"></a>03550 
<a name="l03551"></a>03551 <span class="comment">//</span>
<a name="l03552"></a>03552 <span class="comment">// Networking stubs</span>
<a name="l03553"></a>03553 <span class="comment">//</span>
<a name="l03554"></a>03554 
<a name="l03555"></a><a class="code" href="../../d5/df2/win32_8c.html#accc64bf7bad3dd2a6b683c10533aa076">03555</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/df2/win32_8c.html#accc64bf7bad3dd2a6b683c10533aa076">endhostent</a>(<span class="keywordtype">void</span>) {}
<a name="l03556"></a><a class="code" href="../../d5/df2/win32_8c.html#a9c23830b9c634ac761f3f2daa3e6b724">03556</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/df2/win32_8c.html#a9c23830b9c634ac761f3f2daa3e6b724">endnetent</a>(<span class="keywordtype">void</span>) {}
<a name="l03557"></a><a class="code" href="../../d5/df2/win32_8c.html#a3ac0597abceec2060997db1355d462f8">03557</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/df2/win32_8c.html#a3ac0597abceec2060997db1355d462f8">endprotoent</a>(<span class="keywordtype">void</span>) {}
<a name="l03558"></a><a class="code" href="../../d5/df2/win32_8c.html#adf81140af263bf72a02dc4a484e98d6a">03558</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/df2/win32_8c.html#adf81140af263bf72a02dc4a484e98d6a">endservent</a>(<span class="keywordtype">void</span>) {}
<a name="l03559"></a>03559 
<a name="l03560"></a><a class="code" href="../../d5/df2/win32_8c.html#a04cb2700d674e7c7e3fe3e395de2f2c6">03560</a> <span class="keyword">struct </span>netent *<a class="code" href="../../d5/df2/win32_8c.html#a04cb2700d674e7c7e3fe3e395de2f2c6">getnetent</a> (<span class="keywordtype">void</span>) {<span class="keywordflow">return</span> (<span class="keyword">struct</span> netent *) <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;}
<a name="l03561"></a>03561 
<a name="l03562"></a><a class="code" href="../../d5/df2/win32_8c.html#a7667824228c0c263e894e622c50338f3">03562</a> <span class="keyword">struct </span>netent *<a class="code" href="../../d5/df2/win32_8c.html#a7667824228c0c263e894e622c50338f3">getnetbyaddr</a>(<span class="keywordtype">long</span> net, <span class="keywordtype">int</span> <a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>) {<span class="keywordflow">return</span> (<span class="keyword">struct</span> netent *)<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;}
<a name="l03563"></a>03563 
<a name="l03564"></a><a class="code" href="../../d5/df2/win32_8c.html#ad0d9f7d549a38aa35d00a08bc94623f5">03564</a> <span class="keyword">struct </span>netent *<a class="code" href="../../d5/df2/win32_8c.html#ad0d9f7d549a38aa35d00a08bc94623f5">getnetbyname</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>) {<span class="keywordflow">return</span> (<span class="keyword">struct</span> netent *)<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;}
<a name="l03565"></a>03565 
<a name="l03566"></a><a class="code" href="../../d5/df2/win32_8c.html#aca0da70657afbc3e723990bb229deec3">03566</a> <span class="keyword">struct </span>protoent *<a class="code" href="../../d5/df2/win32_8c.html#aca0da70657afbc3e723990bb229deec3">getprotoent</a> (<span class="keywordtype">void</span>) {<span class="keywordflow">return</span> (<span class="keyword">struct</span> protoent *) <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;}
<a name="l03567"></a>03567 
<a name="l03568"></a><a class="code" href="../../d5/df2/win32_8c.html#afd06d9ae2e6af4d81ac1d1551e074cb6">03568</a> <span class="keyword">struct </span>servent *<a class="code" href="../../d5/df2/win32_8c.html#afd06d9ae2e6af4d81ac1d1551e074cb6">getservent</a> (<span class="keywordtype">void</span>) {<span class="keywordflow">return</span> (<span class="keyword">struct</span> servent *) <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;}
<a name="l03569"></a>03569 
<a name="l03570"></a><a class="code" href="../../d5/df2/win32_8c.html#ad3c7650e6d2bc3c27f9f089af05ee481">03570</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/df2/win32_8c.html#ad3c7650e6d2bc3c27f9f089af05ee481">sethostent</a> (<span class="keywordtype">int</span> stayopen) {}
<a name="l03571"></a>03571 
<a name="l03572"></a><a class="code" href="../../d5/df2/win32_8c.html#a0a2c07c88b888c1c181e8f277f53aee9">03572</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/df2/win32_8c.html#a0a2c07c88b888c1c181e8f277f53aee9">setnetent</a> (<span class="keywordtype">int</span> stayopen) {}
<a name="l03573"></a>03573 
<a name="l03574"></a><a class="code" href="../../d5/df2/win32_8c.html#a6a806414e4ae5bffb09e3a1d25d8db75">03574</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/df2/win32_8c.html#a6a806414e4ae5bffb09e3a1d25d8db75">setprotoent</a> (<span class="keywordtype">int</span> stayopen) {}
<a name="l03575"></a>03575 
<a name="l03576"></a><a class="code" href="../../d5/df2/win32_8c.html#ab2238818a534ce99ec4b5f4a22b659da">03576</a> <span class="keywordtype">void</span> <a class="code" href="../../d5/df2/win32_8c.html#ab2238818a534ce99ec4b5f4a22b659da">setservent</a> (<span class="keywordtype">int</span> stayopen) {}
<a name="l03577"></a>03577 
<a name="l03578"></a>03578 <span class="keywordtype">int</span>
<a name="l03579"></a><a class="code" href="../../d5/df2/win32_8c.html#ad39ebe4c4767eaa9a680777400cfaafe">03579</a> <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> cmd, ...)
<a name="l03580"></a>03580 {
<a name="l03581"></a>03581     SOCKET sock = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(fd);
<a name="l03582"></a>03582     va_list va;
<a name="l03583"></a>03583     <span class="keywordtype">int</span> arg;
<a name="l03584"></a>03584     <span class="keywordtype">int</span> ret;
<a name="l03585"></a>03585     <span class="keywordtype">int</span> flag = 0;
<a name="l03586"></a>03586     <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> data;
<a name="l03587"></a>03587     <a class="code" href="../../da/d50/vsnprintf_8c.html#aaf12d2783d89167480b76853da8ba5e1">u_long</a> ioctlArg;
<a name="l03588"></a>03588 
<a name="l03589"></a>03589     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a963dc023d760a24b0e23ce29bb583732">is_socket</a>(sock)) {
<a name="l03590"></a>03590         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EBADF;
<a name="l03591"></a>03591         <span class="keywordflow">return</span> -1;
<a name="l03592"></a>03592     }
<a name="l03593"></a>03593     <span class="keywordflow">if</span> (cmd != <a class="code" href="../../dc/db1/win32_8h.html#af2939853c650561d3495ed40f68f6249">F_SETFL</a>) {
<a name="l03594"></a>03594         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l03595"></a>03595         <span class="keywordflow">return</span> -1;
<a name="l03596"></a>03596     }
<a name="l03597"></a>03597 
<a name="l03598"></a>03598     va_start(va, cmd);
<a name="l03599"></a>03599     arg = va_arg(va, <span class="keywordtype">int</span>);
<a name="l03600"></a>03600     va_end(va);
<a name="l03601"></a>03601     <a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(socklist, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)sock, &amp;data);
<a name="l03602"></a>03602     flag = (int)data;
<a name="l03603"></a>03603     <span class="keywordflow">if</span> (arg &amp; <a class="code" href="../../dc/db1/win32_8h.html#a39d33ce33804efd4d52606d59071c6d8">O_NONBLOCK</a>) {
<a name="l03604"></a>03604         flag |= O_NONBLOCK;
<a name="l03605"></a>03605         ioctlArg = 1;
<a name="l03606"></a>03606     }
<a name="l03607"></a>03607     <span class="keywordflow">else</span> {
<a name="l03608"></a>03608         flag &amp;= ~O_NONBLOCK;
<a name="l03609"></a>03609         ioctlArg = 0;
<a name="l03610"></a>03610     }
<a name="l03611"></a>03611     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03612"></a>03612         ret = ioctlsocket(sock, FIONBIO, &amp;ioctlArg);
<a name="l03613"></a>03613         <span class="keywordflow">if</span> (ret == 0)
<a name="l03614"></a>03614             <a class="code" href="../../dd/d24/st_8h.html#acdc42c01229b7537ea5a4c6965c7e47a">st_insert</a>(socklist, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)sock, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)flag);
<a name="l03615"></a>03615         <span class="keywordflow">else</span>
<a name="l03616"></a>03616             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l03617"></a>03617     });
<a name="l03618"></a>03618 
<a name="l03619"></a>03619     <span class="keywordflow">return</span> ret;
<a name="l03620"></a>03620 }
<a name="l03621"></a>03621 
<a name="l03622"></a>03622 <span class="preprocessor">#ifndef WNOHANG</span>
<a name="l03623"></a>03623 <span class="preprocessor"></span><span class="preprocessor">#define WNOHANG -1</span>
<a name="l03624"></a>03624 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l03625"></a>03625 <span class="preprocessor"></span>
<a name="l03626"></a>03626 <span class="keyword">static</span> rb_pid_t
<a name="l03627"></a><a class="code" href="../../d5/df2/win32_8c.html#a3ae2185f5f49b38208c0acac97182888">03627</a> <a class="code" href="../../d5/df2/win32_8c.html#a3ae2185f5f49b38208c0acac97182888">poll_child_status</a>(<span class="keyword">struct</span> <a class="code" href="../../df/dca/struct_child_record.html">ChildRecord</a> *child, <span class="keywordtype">int</span> *stat_loc)
<a name="l03628"></a>03628 {
<a name="l03629"></a>03629     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> exitcode;
<a name="l03630"></a>03630     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a>;
<a name="l03631"></a>03631 
<a name="l03632"></a>03632     <span class="keywordflow">if</span> (!GetExitCodeProcess(child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a6f4d66712210547a5b5631a2c3da9836">hProcess</a>, &amp;exitcode)) {
<a name="l03633"></a>03633         <span class="comment">/* If an error occured, return immediatly. */</span>
<a name="l03634"></a>03634     error_exit:
<a name="l03635"></a>03635         err = GetLastError();
<a name="l03636"></a>03636         <span class="keywordflow">if</span> (err == ERROR_INVALID_PARAMETER)
<a name="l03637"></a>03637             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ECHILD;
<a name="l03638"></a>03638         <span class="keywordflow">else</span> {
<a name="l03639"></a>03639             <span class="keywordflow">if</span> (GetLastError() == ERROR_INVALID_HANDLE)
<a name="l03640"></a>03640                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l03641"></a>03641             <span class="keywordflow">else</span>
<a name="l03642"></a>03642                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l03643"></a>03643         }
<a name="l03644"></a>03644         <a class="code" href="../../d5/df2/win32_8c.html#a28431d738cb14b7d42618df366739f92">CloseChildHandle</a>(child);
<a name="l03645"></a>03645         <span class="keywordflow">return</span> -1;
<a name="l03646"></a>03646     }
<a name="l03647"></a>03647     <span class="keywordflow">if</span> (exitcode != STILL_ACTIVE) {
<a name="l03648"></a>03648         rb_pid_t pid;
<a name="l03649"></a>03649         <span class="comment">/* If already died, wait process&apos;s real termination. */</span>
<a name="l03650"></a>03650         <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#a2da86cc53904a673b2b18547d63700f6">rb_w32_wait_events_blocking</a>(&amp;child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a6f4d66712210547a5b5631a2c3da9836">hProcess</a>, 1, INFINITE) != WAIT_OBJECT_0) {
<a name="l03651"></a>03651             <span class="keywordflow">goto</span> error_exit;
<a name="l03652"></a>03652         }
<a name="l03653"></a>03653         pid = child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a0102701165f7c23d4695251e9d3631fa">pid</a>;
<a name="l03654"></a>03654         <a class="code" href="../../d5/df2/win32_8c.html#a28431d738cb14b7d42618df366739f92">CloseChildHandle</a>(child);
<a name="l03655"></a>03655         <span class="keywordflow">if</span> (stat_loc) *stat_loc = exitcode &lt;&lt; 8;
<a name="l03656"></a>03656         <span class="keywordflow">return</span> pid;
<a name="l03657"></a>03657     }
<a name="l03658"></a>03658     <span class="keywordflow">return</span> 0;
<a name="l03659"></a>03659 }
<a name="l03660"></a>03660 
<a name="l03661"></a>03661 rb_pid_t
<a name="l03662"></a><a class="code" href="../../d5/df2/win32_8c.html#abeffb5949abce176b467c584f0463c3f">03662</a> <a class="code" href="../../dc/db1/win32_8h.html#a2b9a9e62a9cce5e6e25a66488e6290a4">waitpid</a>(rb_pid_t pid, <span class="keywordtype">int</span> *stat_loc, <span class="keywordtype">int</span> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ad2d8a938168dc85041b2bac532a7cf75">options</a>)
<a name="l03663"></a>03663 {
<a name="l03664"></a>03664     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> timeout;
<a name="l03665"></a>03665 
<a name="l03666"></a>03666     <span class="keywordflow">if</span> (options == <a class="code" href="../../dc/db1/win32_8h.html#afa288d86b242c3005425a9c0f1682544">WNOHANG</a>) {
<a name="l03667"></a>03667         timeout = 0;
<a name="l03668"></a>03668     }
<a name="l03669"></a>03669     <span class="keywordflow">else</span> {
<a name="l03670"></a>03670         timeout = INFINITE;
<a name="l03671"></a>03671     }
<a name="l03672"></a>03672 
<a name="l03673"></a>03673     <span class="keywordflow">if</span> (pid == -1) {
<a name="l03674"></a>03674         <span class="keywordtype">int</span> <a class="code" href="../../d5/db5/encoding_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a> = 0;
<a name="l03675"></a>03675         <span class="keywordtype">int</span> ret;
<a name="l03676"></a>03676         HANDLE events[<a class="code" href="../../d5/df2/win32_8c.html#aaf762ba5effab0ba80b63aa460f8ed50">MAXCHILDNUM</a>];
<a name="l03677"></a>03677 
<a name="l03678"></a>03678         <a class="code" href="../../d5/df2/win32_8c.html#ae7244715d5ef9f0293bdab6b8c763f97">FOREACH_CHILD</a>(child) {
<a name="l03679"></a>03679             <span class="keywordflow">if</span> (!child-&gt;pid || child-&gt;pid &lt; 0) <span class="keywordflow">continue</span>;
<a name="l03680"></a>03680             <span class="keywordflow">if</span> ((pid = <a class="code" href="../../d5/df2/win32_8c.html#a3ae2185f5f49b38208c0acac97182888">poll_child_status</a>(child, stat_loc))) <span class="keywordflow">return</span> pid;
<a name="l03681"></a>03681             events[count++] = child-&gt;hProcess;
<a name="l03682"></a>03682         } <a class="code" href="../../d5/df2/win32_8c.html#aa37aa8528ad37d56f1dcaa74c8ed5fee">END_FOREACH_CHILD</a>;
<a name="l03683"></a>03683         <span class="keywordflow">if</span> (!count) {
<a name="l03684"></a>03684             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ECHILD;
<a name="l03685"></a>03685             <span class="keywordflow">return</span> -1;
<a name="l03686"></a>03686         }
<a name="l03687"></a>03687 
<a name="l03688"></a>03688         ret = <a class="code" href="../../dc/db1/win32_8h.html#a2da86cc53904a673b2b18547d63700f6">rb_w32_wait_events_blocking</a>(events, count, timeout);
<a name="l03689"></a>03689         <span class="keywordflow">if</span> (ret == WAIT_TIMEOUT) <span class="keywordflow">return</span> 0;
<a name="l03690"></a>03690         <span class="keywordflow">if</span> ((ret -= WAIT_OBJECT_0) == count) {
<a name="l03691"></a>03691             <span class="keywordflow">return</span> -1;
<a name="l03692"></a>03692         }
<a name="l03693"></a>03693         <span class="keywordflow">if</span> (ret &gt; count) {
<a name="l03694"></a>03694             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l03695"></a>03695             <span class="keywordflow">return</span> -1;
<a name="l03696"></a>03696         }
<a name="l03697"></a>03697 
<a name="l03698"></a>03698         <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#a3ae2185f5f49b38208c0acac97182888">poll_child_status</a>(<a class="code" href="../../d5/df2/win32_8c.html#aa813e17c3b799ae52456ad29a7eeaa37">FindChildSlotByHandle</a>(events[ret]), stat_loc);
<a name="l03699"></a>03699     }
<a name="l03700"></a>03700     <span class="keywordflow">else</span> {
<a name="l03701"></a>03701         <span class="keyword">struct </span><a class="code" href="../../df/dca/struct_child_record.html">ChildRecord</a>* child = <a class="code" href="../../d5/df2/win32_8c.html#a9ec4e65a0248028da434bc880f20a628">FindChildSlot</a>(pid);
<a name="l03702"></a>03702         <span class="keywordflow">if</span> (!child) {
<a name="l03703"></a>03703             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ECHILD;
<a name="l03704"></a>03704             <span class="keywordflow">return</span> -1;
<a name="l03705"></a>03705         }
<a name="l03706"></a>03706 
<a name="l03707"></a>03707         <span class="keywordflow">while</span> (!(pid = <a class="code" href="../../d5/df2/win32_8c.html#a3ae2185f5f49b38208c0acac97182888">poll_child_status</a>(child, stat_loc))) {
<a name="l03708"></a>03708             <span class="comment">/* wait... */</span>
<a name="l03709"></a>03709             <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#a2da86cc53904a673b2b18547d63700f6">rb_w32_wait_events_blocking</a>(&amp;child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a6f4d66712210547a5b5631a2c3da9836">hProcess</a>, 1, timeout) != WAIT_OBJECT_0) {
<a name="l03710"></a>03710                 <span class="comment">/* still active */</span>
<a name="l03711"></a>03711                 pid = 0;
<a name="l03712"></a>03712                 <span class="keywordflow">break</span>;
<a name="l03713"></a>03713             }
<a name="l03714"></a>03714         }
<a name="l03715"></a>03715     }
<a name="l03716"></a>03716 
<a name="l03717"></a>03717     <span class="keywordflow">return</span> pid;
<a name="l03718"></a>03718 }
<a name="l03719"></a>03719 
<a name="l03720"></a>03720 <span class="preprocessor">#include &lt;sys/timeb.h&gt;</span>
<a name="l03721"></a>03721 
<a name="l03722"></a>03722 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l03723"></a><a class="code" href="../../d5/df2/win32_8c.html#abaacd3c9dbb744ba975e70353c19dd6b">03723</a> <a class="code" href="../../d5/df2/win32_8c.html#abaacd3c9dbb744ba975e70353c19dd6b">filetime_to_timeval</a>(<span class="keyword">const</span> FILETIME* ft, <span class="keyword">struct</span> <a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> *tv)
<a name="l03724"></a>03724 {
<a name="l03725"></a>03725     ULARGE_INTEGER tmp;
<a name="l03726"></a>03726     <span class="keywordtype">unsigned</span> LONG_LONG <a class="code" href="../../df/d73/time_8c.html#aa1b1fd9418512be0ed145132439b7bd9">lt</a>;
<a name="l03727"></a>03727 
<a name="l03728"></a>03728     tmp.LowPart = ft-&gt;dwLowDateTime;
<a name="l03729"></a>03729     tmp.HighPart = ft-&gt;dwHighDateTime;
<a name="l03730"></a>03730     lt = tmp.QuadPart;
<a name="l03731"></a>03731 
<a name="l03732"></a>03732     <span class="comment">/* lt is now 100-nanosec intervals since 1601/01/01 00:00:00 UTC,</span>
<a name="l03733"></a>03733 <span class="comment">       convert it into UNIX time (since 1970/01/01 00:00:00 UTC).</span>
<a name="l03734"></a>03734 <span class="comment">       the first leap second is at 1972/06/30, so we doesn&apos;t need to think</span>
<a name="l03735"></a>03735 <span class="comment">       about it. */</span>
<a name="l03736"></a>03736     lt /= 10;   <span class="comment">/* to usec */</span>
<a name="l03737"></a>03737     lt -= (LONG_LONG)((1970-1601)*365.2425) * 24 * 60 * 60 * 1000 * 1000;
<a name="l03738"></a>03738 
<a name="l03739"></a>03739     tv-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> = (<a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a>)(lt / (1000 * 1000));
<a name="l03740"></a>03740     tv-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> = (<a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a>)(lt % (1000 * 1000));
<a name="l03741"></a>03741 
<a name="l03742"></a>03742     <span class="keywordflow">return</span> tv-&gt;<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> &gt; 0 ? 0 : -1;
<a name="l03743"></a>03743 }
<a name="l03744"></a>03744 
<a name="l03745"></a>03745 <span class="keywordtype">int</span> _cdecl
<a name="l03746"></a><a class="code" href="../../d5/df2/win32_8c.html#ad3d490e44700fe021c0f3d60210a056e">03746</a> <a class="code" href="../../dc/db1/win32_8h.html#a091a762f60d91b0f5441d9520dc2079c">gettimeofday</a>(<span class="keyword">struct</span> <a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> *tv, <span class="keyword">struct</span> <a class="code" href="../../de/dc1/structtimezone.html">timezone</a> *tz)
<a name="l03747"></a>03747 {
<a name="l03748"></a>03748     FILETIME ft;
<a name="l03749"></a>03749 
<a name="l03750"></a>03750     GetSystemTimeAsFileTime(&amp;ft);
<a name="l03751"></a>03751     <a class="code" href="../../d5/df2/win32_8c.html#abaacd3c9dbb744ba975e70353c19dd6b">filetime_to_timeval</a>(&amp;ft, tv);
<a name="l03752"></a>03752 
<a name="l03753"></a>03753     <span class="keywordflow">return</span> 0;
<a name="l03754"></a>03754 }
<a name="l03755"></a>03755 
<a name="l03756"></a>03756 <span class="keywordtype">char</span> *
<a name="l03757"></a><a class="code" href="../../d5/df2/win32_8c.html#acb682eb00ab21e583729209599022cd1">03757</a> <a class="code" href="../../dc/db1/win32_8h.html#a10b8b3b9a4d856b6c3e1f89c2158e90c">rb_w32_getcwd</a>(<span class="keywordtype">char</span> *buffer, <span class="keywordtype">int</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l03758"></a>03758 {
<a name="l03759"></a>03759     <span class="keywordtype">char</span> *p = buffer;
<a name="l03760"></a>03760     <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l03761"></a>03761 
<a name="l03762"></a>03762     len = GetCurrentDirectory(0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03763"></a>03763     <span class="keywordflow">if</span> (!len) {
<a name="l03764"></a>03764         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l03765"></a>03765         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03766"></a>03766     }
<a name="l03767"></a>03767 
<a name="l03768"></a>03768     <span class="keywordflow">if</span> (p) {
<a name="l03769"></a>03769         <span class="keywordflow">if</span> (size &lt; len) {
<a name="l03770"></a>03770             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ERANGE;
<a name="l03771"></a>03771             <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03772"></a>03772         }
<a name="l03773"></a>03773     }
<a name="l03774"></a>03774     <span class="keywordflow">else</span> {
<a name="l03775"></a>03775         p = <a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(len);
<a name="l03776"></a>03776         size = len;
<a name="l03777"></a>03777         <span class="keywordflow">if</span> (!p) {
<a name="l03778"></a>03778             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ENOMEM;
<a name="l03779"></a>03779             <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03780"></a>03780         }
<a name="l03781"></a>03781     }
<a name="l03782"></a>03782 
<a name="l03783"></a>03783     <span class="keywordflow">if</span> (!GetCurrentDirectory(size, p)) {
<a name="l03784"></a>03784         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l03785"></a>03785         <span class="keywordflow">if</span> (!buffer)
<a name="l03786"></a>03786             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(p);
<a name="l03787"></a>03787         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03788"></a>03788     }
<a name="l03789"></a>03789 
<a name="l03790"></a>03790     <a class="code" href="../../d5/df2/win32_8c.html#a4f27c8c10e28d59b4c43bacbcd2fa76c">translate_char</a>(p, <span class="charliteral">&apos;\\&apos;</span>, <span class="charliteral">&apos;/&apos;</span>);
<a name="l03791"></a>03791 
<a name="l03792"></a>03792     <span class="keywordflow">return</span> p;
<a name="l03793"></a>03793 }
<a name="l03794"></a>03794 
<a name="l03795"></a>03795 <span class="keywordtype">int</span>
<a name="l03796"></a><a class="code" href="../../d5/df2/win32_8c.html#ac785eca6fbc0f53d04c0ca9b6fbba7d0">03796</a> <a class="code" href="../../dc/db1/win32_8h.html#ac7c7a6988eecb59569de9f51115a1df3">chown</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> owner, <span class="keywordtype">int</span> group)
<a name="l03797"></a>03797 {
<a name="l03798"></a>03798     <span class="keywordflow">return</span> 0;
<a name="l03799"></a>03799 }
<a name="l03800"></a>03800 
<a name="l03801"></a>03801 <span class="keywordtype">int</span>
<a name="l03802"></a><a class="code" href="../../d5/df2/win32_8c.html#a3c190f1ea0dd1ed4c468018fc3c2bfb9">03802</a> <a class="code" href="../../dc/db1/win32_8h.html#a4856ef766f0416e9a3ab1208195c3ab3">rb_w32_uchown</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> owner, <span class="keywordtype">int</span> group)
<a name="l03803"></a>03803 {
<a name="l03804"></a>03804     <span class="keywordflow">return</span> 0;
<a name="l03805"></a>03805 }
<a name="l03806"></a>03806 
<a name="l03807"></a>03807 <span class="keywordtype">int</span>
<a name="l03808"></a><a class="code" href="../../d5/df2/win32_8c.html#a17629c5f27ae250d924b74b1789e3b27">03808</a> <a class="code" href="../../dc/db1/win32_8h.html#a6edea8ed9aecaef5fc4762da7ec641ff">kill</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/dca/struct_child_record.html#a0102701165f7c23d4695251e9d3631fa">pid</a>, <span class="keywordtype">int</span> sig)
<a name="l03809"></a>03809 {
<a name="l03810"></a>03810     <span class="keywordtype">int</span> ret = 0;
<a name="l03811"></a>03811     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a>;
<a name="l03812"></a>03812 
<a name="l03813"></a>03813     <span class="keywordflow">if</span> (pid &lt; 0 || pid == 0 &amp;&amp; sig != <a class="code" href="../../dc/db1/win32_8h.html#a487309e3e9e0527535644115204a639a">SIGINT</a>) {
<a name="l03814"></a>03814         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l03815"></a>03815         <span class="keywordflow">return</span> -1;
<a name="l03816"></a>03816     }
<a name="l03817"></a>03817 
<a name="l03818"></a>03818     (void)<a class="code" href="../../d5/df2/win32_8c.html#a7f3fd3449912cfee8acada6b9307b385">IfWin95</a>(pid = -pid, 0);
<a name="l03819"></a>03819     <span class="keywordflow">if</span> ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)pid == GetCurrentProcessId() &amp;&amp;
<a name="l03820"></a>03820         (sig != 0 &amp;&amp; sig != <a class="code" href="../../dc/db1/win32_8h.html#addd8dcd406ce514ab3b4f576a5343d42">SIGKILL</a>)) {
<a name="l03821"></a>03821         <span class="keywordflow">if</span> ((ret = <span class="keyword">raise</span>(sig)) != 0) {
<a name="l03822"></a>03822             <span class="comment">/* MSVCRT doesn&apos;t set errno... */</span>
<a name="l03823"></a>03823             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l03824"></a>03824         }
<a name="l03825"></a>03825         <span class="keywordflow">return</span> ret;
<a name="l03826"></a>03826     }
<a name="l03827"></a>03827 
<a name="l03828"></a>03828     <span class="keywordflow">switch</span> (sig) {
<a name="l03829"></a>03829       <span class="keywordflow">case</span> 0:
<a name="l03830"></a>03830         <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03831"></a>03831             HANDLE hProc =
<a name="l03832"></a>03832                 OpenProcess(PROCESS_QUERY_INFORMATION, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)pid);
<a name="l03833"></a>03833             <span class="keywordflow">if</span> (hProc == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || hProc == INVALID_HANDLE_VALUE) {
<a name="l03834"></a>03834                 <span class="keywordflow">if</span> (GetLastError() == ERROR_INVALID_PARAMETER) {
<a name="l03835"></a>03835                     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ESRCH;
<a name="l03836"></a>03836                 }
<a name="l03837"></a>03837                 <span class="keywordflow">else</span> {
<a name="l03838"></a>03838                     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d4/db0/__sdbm_8c.html#add669d31505a077f769cff8e66c780b3">EPERM</a>;
<a name="l03839"></a>03839                 }
<a name="l03840"></a>03840                 ret = -1;
<a name="l03841"></a>03841             }
<a name="l03842"></a>03842             <span class="keywordflow">else</span> {
<a name="l03843"></a>03843                 CloseHandle(hProc);
<a name="l03844"></a>03844             }
<a name="l03845"></a>03845         });
<a name="l03846"></a>03846         <span class="keywordflow">break</span>;
<a name="l03847"></a>03847 
<a name="l03848"></a>03848       <span class="keywordflow">case</span> <a class="code" href="../../dc/db1/win32_8h.html#a487309e3e9e0527535644115204a639a">SIGINT</a>:
<a name="l03849"></a>03849         <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03850"></a>03850             <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> ctrlEvent = CTRL_C_EVENT;
<a name="l03851"></a>03851             <span class="keywordflow">if</span> (pid != 0) {
<a name="l03852"></a>03852                 <span class="comment">/* CTRL+C signal cannot be generated for process groups.</span>
<a name="l03853"></a>03853 <span class="comment">                 * Instead, we use CTRL+BREAK signal. */</span>
<a name="l03854"></a>03854                 ctrlEvent = CTRL_BREAK_EVENT;
<a name="l03855"></a>03855             }
<a name="l03856"></a>03856             <span class="keywordflow">if</span> (!GenerateConsoleCtrlEvent(ctrlEvent, (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)pid)) {
<a name="l03857"></a>03857                 <span class="keywordflow">if</span> ((err = GetLastError()) == 0)
<a name="l03858"></a>03858                     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d4/db0/__sdbm_8c.html#add669d31505a077f769cff8e66c780b3">EPERM</a>;
<a name="l03859"></a>03859                 <span class="keywordflow">else</span>
<a name="l03860"></a>03860                     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l03861"></a>03861                 ret = -1;
<a name="l03862"></a>03862             }
<a name="l03863"></a>03863         });
<a name="l03864"></a>03864         <span class="keywordflow">break</span>;
<a name="l03865"></a>03865 
<a name="l03866"></a>03866       <span class="keywordflow">case</span> <a class="code" href="../../dc/db1/win32_8h.html#addd8dcd406ce514ab3b4f576a5343d42">SIGKILL</a>:
<a name="l03867"></a>03867         <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l03868"></a>03868             HANDLE hProc;
<a name="l03869"></a>03869             <span class="keyword">struct </span><a class="code" href="../../df/dca/struct_child_record.html">ChildRecord</a>* child = <a class="code" href="../../d5/df2/win32_8c.html#a9ec4e65a0248028da434bc880f20a628">FindChildSlot</a>(pid);
<a name="l03870"></a>03870             <span class="keywordflow">if</span> (child) {
<a name="l03871"></a>03871                 hProc = child-&gt;<a class="code" href="../../df/dca/struct_child_record.html#a6f4d66712210547a5b5631a2c3da9836">hProcess</a>;
<a name="l03872"></a>03872             }
<a name="l03873"></a>03873             <span class="keywordflow">else</span> {
<a name="l03874"></a>03874                 hProc = OpenProcess(PROCESS_TERMINATE | PROCESS_QUERY_INFORMATION, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)pid);
<a name="l03875"></a>03875             }
<a name="l03876"></a>03876             <span class="keywordflow">if</span> (hProc == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || hProc == INVALID_HANDLE_VALUE) {
<a name="l03877"></a>03877                 <span class="keywordflow">if</span> (GetLastError() == ERROR_INVALID_PARAMETER) {
<a name="l03878"></a>03878                     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ESRCH;
<a name="l03879"></a>03879                 }
<a name="l03880"></a>03880                 <span class="keywordflow">else</span> {
<a name="l03881"></a>03881                     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d4/db0/__sdbm_8c.html#add669d31505a077f769cff8e66c780b3">EPERM</a>;
<a name="l03882"></a>03882                 }
<a name="l03883"></a>03883                 ret = -1;
<a name="l03884"></a>03884             }
<a name="l03885"></a>03885             <span class="keywordflow">else</span> {
<a name="l03886"></a>03886                 <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> status;
<a name="l03887"></a>03887                 <span class="keywordflow">if</span> (!GetExitCodeProcess(hProc, &amp;status)) {
<a name="l03888"></a>03888                     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l03889"></a>03889                     ret = -1;
<a name="l03890"></a>03890                 }
<a name="l03891"></a>03891                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (status == STILL_ACTIVE) {
<a name="l03892"></a>03892                     <span class="keywordflow">if</span> (!TerminateProcess(hProc, 0)) {
<a name="l03893"></a>03893                         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d4/db0/__sdbm_8c.html#add669d31505a077f769cff8e66c780b3">EPERM</a>;
<a name="l03894"></a>03894                         ret = -1;
<a name="l03895"></a>03895                     }
<a name="l03896"></a>03896                 }
<a name="l03897"></a>03897                 <span class="keywordflow">else</span> {
<a name="l03898"></a>03898                     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ESRCH;
<a name="l03899"></a>03899                     ret = -1;
<a name="l03900"></a>03900                 }
<a name="l03901"></a>03901                 <span class="keywordflow">if</span> (!child) {
<a name="l03902"></a>03902                     CloseHandle(hProc);
<a name="l03903"></a>03903                 }
<a name="l03904"></a>03904             }
<a name="l03905"></a>03905         });
<a name="l03906"></a>03906         <span class="keywordflow">break</span>;
<a name="l03907"></a>03907 
<a name="l03908"></a>03908       <span class="keywordflow">default</span>:
<a name="l03909"></a>03909         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l03910"></a>03910         ret = -1;
<a name="l03911"></a>03911         <span class="keywordflow">break</span>;
<a name="l03912"></a>03912     }
<a name="l03913"></a>03913 
<a name="l03914"></a>03914     <span class="keywordflow">return</span> ret;
<a name="l03915"></a>03915 }
<a name="l03916"></a>03916 
<a name="l03917"></a>03917 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l03918"></a><a class="code" href="../../d5/df2/win32_8c.html#a10c67f0c2eb2da18b7bbc93c871fdcf6">03918</a> <a class="code" href="../../d5/df2/win32_8c.html#a10c67f0c2eb2da18b7bbc93c871fdcf6">wlink</a>(<span class="keyword">const</span> WCHAR *from, <span class="keyword">const</span> WCHAR *to)
<a name="l03919"></a>03919 {
<a name="l03920"></a>03920     <span class="keyword">typedef</span> BOOL (WINAPI link_func)(LPCWSTR, LPCWSTR, LPSECURITY_ATTRIBUTES);
<a name="l03921"></a>03921     <span class="keyword">static</span> link_func *pCreateHardLinkW = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03922"></a>03922     <span class="keyword">static</span> <span class="keywordtype">int</span> myerrno = 0;
<a name="l03923"></a>03923 
<a name="l03924"></a>03924     <span class="keywordflow">if</span> (!pCreateHardLinkW &amp;&amp; !myerrno) {
<a name="l03925"></a>03925         pCreateHardLinkW = (link_func *)<a class="code" href="../../d5/df2/win32_8c.html#a8ab64e43a3bd89bcdebe1111534a0bfa">get_proc_address</a>(<span class="stringliteral">&quot;kernel32&quot;</span>, <span class="stringliteral">&quot;CreateHardLinkW&quot;</span>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l03926"></a>03926         <span class="keywordflow">if</span> (!pCreateHardLinkW)
<a name="l03927"></a>03927             myerrno = ENOSYS;
<a name="l03928"></a>03928     }
<a name="l03929"></a>03929     <span class="keywordflow">if</span> (!pCreateHardLinkW) {
<a name="l03930"></a>03930         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = myerrno;
<a name="l03931"></a>03931         <span class="keywordflow">return</span> -1;
<a name="l03932"></a>03932     }
<a name="l03933"></a>03933 
<a name="l03934"></a>03934     <span class="keywordflow">if</span> (!pCreateHardLinkW(to, from, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l03935"></a>03935         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l03936"></a>03936         <span class="keywordflow">return</span> -1;
<a name="l03937"></a>03937     }
<a name="l03938"></a>03938 
<a name="l03939"></a>03939     <span class="keywordflow">return</span> 0;
<a name="l03940"></a>03940 }
<a name="l03941"></a>03941 
<a name="l03942"></a>03942 <span class="keywordtype">int</span>
<a name="l03943"></a><a class="code" href="../../d5/df2/win32_8c.html#a48bff2852b273b2bee75a6b8b3fc1094">03943</a> <a class="code" href="../../dc/db1/win32_8h.html#a4acaae57904f3a240e97426a0dbdf186">rb_w32_ulink</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *from, <span class="keyword">const</span> <span class="keywordtype">char</span> *to)
<a name="l03944"></a>03944 {
<a name="l03945"></a>03945     WCHAR *wfrom;
<a name="l03946"></a>03946     WCHAR *wto;
<a name="l03947"></a>03947     <span class="keywordtype">int</span> ret;
<a name="l03948"></a>03948 
<a name="l03949"></a>03949     <span class="keywordflow">if</span> (!(wfrom = <a class="code" href="../../d5/df2/win32_8c.html#a41003a1382888cc771e290746769eb13">utf8_to_wstr</a>(from, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l03950"></a>03950         <span class="keywordflow">return</span> -1;
<a name="l03951"></a>03951     <span class="keywordflow">if</span> (!(wto = <a class="code" href="../../d5/df2/win32_8c.html#a41003a1382888cc771e290746769eb13">utf8_to_wstr</a>(to, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {
<a name="l03952"></a>03952         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wfrom);
<a name="l03953"></a>03953         <span class="keywordflow">return</span> -1;
<a name="l03954"></a>03954     }
<a name="l03955"></a>03955     ret = <a class="code" href="../../d5/df2/win32_8c.html#a10c67f0c2eb2da18b7bbc93c871fdcf6">wlink</a>(wfrom, wto);
<a name="l03956"></a>03956     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wto);
<a name="l03957"></a>03957     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wfrom);
<a name="l03958"></a>03958     <span class="keywordflow">return</span> ret;
<a name="l03959"></a>03959 }
<a name="l03960"></a>03960 
<a name="l03961"></a>03961 <span class="keywordtype">int</span>
<a name="l03962"></a><a class="code" href="../../d5/df2/win32_8c.html#a8233c41ed351c60f0cb9b8d53d79fe81">03962</a> <a class="code" href="../../dc/db1/win32_8h.html#a9f0ffa429d1a466322fb9b5bb084f828">link</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *from, <span class="keyword">const</span> <span class="keywordtype">char</span> *to)
<a name="l03963"></a>03963 {
<a name="l03964"></a>03964     WCHAR *wfrom;
<a name="l03965"></a>03965     WCHAR *wto;
<a name="l03966"></a>03966     <span class="keywordtype">int</span> ret;
<a name="l03967"></a>03967 
<a name="l03968"></a>03968     <span class="keywordflow">if</span> (!(wfrom = <a class="code" href="../../d5/df2/win32_8c.html#ad33d311f649154599e920240e3900a59">filecp_to_wstr</a>(from, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l03969"></a>03969         <span class="keywordflow">return</span> -1;
<a name="l03970"></a>03970     <span class="keywordflow">if</span> (!(wto = <a class="code" href="../../d5/df2/win32_8c.html#ad33d311f649154599e920240e3900a59">filecp_to_wstr</a>(to, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {
<a name="l03971"></a>03971         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wfrom);
<a name="l03972"></a>03972         <span class="keywordflow">return</span> -1;
<a name="l03973"></a>03973     }
<a name="l03974"></a>03974     ret = <a class="code" href="../../d5/df2/win32_8c.html#a10c67f0c2eb2da18b7bbc93c871fdcf6">wlink</a>(wfrom, wto);
<a name="l03975"></a>03975     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wto);
<a name="l03976"></a>03976     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wfrom);
<a name="l03977"></a>03977     <span class="keywordflow">return</span> ret;
<a name="l03978"></a>03978 }
<a name="l03979"></a>03979 
<a name="l03980"></a>03980 <span class="keywordtype">int</span>
<a name="l03981"></a><a class="code" href="../../d5/df2/win32_8c.html#a6655447bab00753d59759423bf28e22e">03981</a> <a class="code" href="../../d5/df2/win32_8c.html#a6655447bab00753d59759423bf28e22e">wait</a>(<span class="keywordtype">int</span> *status)
<a name="l03982"></a>03982 {
<a name="l03983"></a>03983     <span class="keywordflow">return</span> <a class="code" href="../../dc/db1/win32_8h.html#a2b9a9e62a9cce5e6e25a66488e6290a4">waitpid</a>(-1, status, 0);
<a name="l03984"></a>03984 }
<a name="l03985"></a>03985 
<a name="l03986"></a>03986 <span class="keywordtype">char</span> *
<a name="l03987"></a><a class="code" href="../../d5/df2/win32_8c.html#a4846780b2bb4ebca26bace881008b633">03987</a> <a class="code" href="../../dc/db1/win32_8h.html#ab7ab738566effab1d8ce0d8a2540695d">rb_w32_getenv</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)
<a name="l03988"></a>03988 {
<a name="l03989"></a>03989     <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(name);
<a name="l03990"></a>03990     <span class="keywordtype">char</span> *<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>;
<a name="l03991"></a>03991 
<a name="l03992"></a>03992     <span class="keywordflow">if</span> (len == 0) <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03993"></a>03993     <span class="keywordflow">if</span> (envarea) FreeEnvironmentStrings(envarea);
<a name="l03994"></a>03994     envarea = GetEnvironmentStrings();
<a name="l03995"></a>03995     <span class="keywordflow">if</span> (!envarea) {
<a name="l03996"></a>03996         <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l03997"></a>03997         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03998"></a>03998     }
<a name="l03999"></a>03999 
<a name="l04000"></a>04000     <span class="keywordflow">for</span> (env = envarea; *env; env += <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(env) + 1)
<a name="l04001"></a>04001         <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#aba00036f71bb67f8600b239a39cf5ec9">strncasecmp</a>(env, name, len) == 0 &amp;&amp; *(env + len) == <span class="charliteral">&apos;=&apos;</span>)
<a name="l04002"></a>04002             <span class="keywordflow">return</span> env + len + 1;
<a name="l04003"></a>04003 
<a name="l04004"></a>04004     <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04005"></a>04005 }
<a name="l04006"></a>04006 
<a name="l04007"></a>04007 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l04008"></a><a class="code" href="../../d5/df2/win32_8c.html#a4944539ec5538361a2b6dc4e7278eeb5">04008</a> <a class="code" href="../../d5/df2/win32_8c.html#a4944539ec5538361a2b6dc4e7278eeb5">wrename</a>(<span class="keyword">const</span> WCHAR *oldpath, <span class="keyword">const</span> WCHAR *newpath)
<a name="l04009"></a>04009 {
<a name="l04010"></a>04010     <span class="keywordtype">int</span> res = 0;
<a name="l04011"></a>04011     <span class="keywordtype">int</span> oldatts;
<a name="l04012"></a>04012     <span class="keywordtype">int</span> newatts;
<a name="l04013"></a>04013 
<a name="l04014"></a>04014     oldatts = GetFileAttributesW(oldpath);
<a name="l04015"></a>04015     newatts = GetFileAttributesW(newpath);
<a name="l04016"></a>04016 
<a name="l04017"></a>04017     <span class="keywordflow">if</span> (oldatts == -1) {
<a name="l04018"></a>04018         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l04019"></a>04019         <span class="keywordflow">return</span> -1;
<a name="l04020"></a>04020     }
<a name="l04021"></a>04021 
<a name="l04022"></a>04022     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l04023"></a>04023         <span class="keywordflow">if</span> (newatts != -1 &amp;&amp; newatts &amp; FILE_ATTRIBUTE_READONLY)
<a name="l04024"></a>04024             SetFileAttributesW(newpath, newatts &amp; ~ FILE_ATTRIBUTE_READONLY);
<a name="l04025"></a>04025 
<a name="l04026"></a>04026         <span class="keywordflow">if</span> (!MoveFileW(oldpath, newpath))
<a name="l04027"></a>04027             res = -1;
<a name="l04028"></a>04028 
<a name="l04029"></a>04029         <span class="keywordflow">if</span> (res) {
<a name="l04030"></a>04030             <span class="keywordflow">switch</span> (GetLastError()) {
<a name="l04031"></a>04031               <span class="keywordflow">case</span> ERROR_ALREADY_EXISTS:
<a name="l04032"></a>04032               <span class="keywordflow">case</span> ERROR_FILE_EXISTS:
<a name="l04033"></a>04033                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#aaa9c3231dcc73fc8381f671b588fb13a">IsWinNT</a>()) {
<a name="l04034"></a>04034                     <span class="keywordflow">if</span> (MoveFileExW(oldpath, newpath, MOVEFILE_REPLACE_EXISTING))
<a name="l04035"></a>04035                         res = 0;
<a name="l04036"></a>04036                 }
<a name="l04037"></a>04037                 <span class="keywordflow">else</span> {
<a name="l04038"></a>04038                     <span class="keywordflow">for</span> (;;) {
<a name="l04039"></a>04039                         <span class="keywordflow">if</span> (!DeleteFileW(newpath) &amp;&amp; GetLastError() != ERROR_FILE_NOT_FOUND)
<a name="l04040"></a>04040                             <span class="keywordflow">break</span>;
<a name="l04041"></a>04041                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (MoveFileW(oldpath, newpath)) {
<a name="l04042"></a>04042                             res = 0;
<a name="l04043"></a>04043                             <span class="keywordflow">break</span>;
<a name="l04044"></a>04044                         }
<a name="l04045"></a>04045                     }
<a name="l04046"></a>04046                 }
<a name="l04047"></a>04047             }
<a name="l04048"></a>04048         }
<a name="l04049"></a>04049 
<a name="l04050"></a>04050         <span class="keywordflow">if</span> (res)
<a name="l04051"></a>04051             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l04052"></a>04052         <span class="keywordflow">else</span>
<a name="l04053"></a>04053             SetFileAttributesW(newpath, oldatts);
<a name="l04054"></a>04054     });
<a name="l04055"></a>04055 
<a name="l04056"></a>04056     <span class="keywordflow">return</span> res;
<a name="l04057"></a>04057 }
<a name="l04058"></a>04058 
<a name="l04059"></a><a class="code" href="../../d5/df2/win32_8c.html#adbafcc7df22870b089af2f33f24a4703">04059</a> <span class="keywordtype">int</span> <a class="code" href="../../dc/db1/win32_8h.html#adcfac29efe8d2e02b6b8ce09f95ffbe1">rb_w32_urename</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *from, <span class="keyword">const</span> <span class="keywordtype">char</span> *to)
<a name="l04060"></a>04060 {
<a name="l04061"></a>04061     WCHAR *wfrom;
<a name="l04062"></a>04062     WCHAR *wto;
<a name="l04063"></a>04063     <span class="keywordtype">int</span> ret = -1;
<a name="l04064"></a>04064 
<a name="l04065"></a>04065     <span class="keywordflow">if</span> (!(wfrom = <a class="code" href="../../d5/df2/win32_8c.html#a41003a1382888cc771e290746769eb13">utf8_to_wstr</a>(from, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l04066"></a>04066         <span class="keywordflow">return</span> -1;
<a name="l04067"></a>04067     <span class="keywordflow">if</span> (!(wto = <a class="code" href="../../d5/df2/win32_8c.html#a41003a1382888cc771e290746769eb13">utf8_to_wstr</a>(to, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {
<a name="l04068"></a>04068         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wfrom);
<a name="l04069"></a>04069         <span class="keywordflow">return</span> -1;
<a name="l04070"></a>04070     }
<a name="l04071"></a>04071     ret = <a class="code" href="../../d5/df2/win32_8c.html#a4944539ec5538361a2b6dc4e7278eeb5">wrename</a>(wfrom, wto);
<a name="l04072"></a>04072     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wto);
<a name="l04073"></a>04073     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wfrom);
<a name="l04074"></a>04074     <span class="keywordflow">return</span> ret;
<a name="l04075"></a>04075 }
<a name="l04076"></a>04076 
<a name="l04077"></a><a class="code" href="../../d5/df2/win32_8c.html#af325a0d281f110277a387518efb093e5">04077</a> <span class="keywordtype">int</span> <a class="code" href="../../dc/db1/win32_8h.html#a1d5488313f84de5a7783b3cb029392c7">rb_w32_rename</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *from, <span class="keyword">const</span> <span class="keywordtype">char</span> *to)
<a name="l04078"></a>04078 {
<a name="l04079"></a>04079     WCHAR *wfrom;
<a name="l04080"></a>04080     WCHAR *wto;
<a name="l04081"></a>04081     <span class="keywordtype">int</span> ret = -1;
<a name="l04082"></a>04082 
<a name="l04083"></a>04083     <span class="keywordflow">if</span> (!(wfrom = <a class="code" href="../../d5/df2/win32_8c.html#ad33d311f649154599e920240e3900a59">filecp_to_wstr</a>(from, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l04084"></a>04084         <span class="keywordflow">return</span> -1;
<a name="l04085"></a>04085     <span class="keywordflow">if</span> (!(wto = <a class="code" href="../../d5/df2/win32_8c.html#ad33d311f649154599e920240e3900a59">filecp_to_wstr</a>(to, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>))) {
<a name="l04086"></a>04086         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wfrom);
<a name="l04087"></a>04087         <span class="keywordflow">return</span> -1;
<a name="l04088"></a>04088     }
<a name="l04089"></a>04089     ret = <a class="code" href="../../d5/df2/win32_8c.html#a4944539ec5538361a2b6dc4e7278eeb5">wrename</a>(wfrom, wto);
<a name="l04090"></a>04090     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wto);
<a name="l04091"></a>04091     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wfrom);
<a name="l04092"></a>04092     <span class="keywordflow">return</span> ret;
<a name="l04093"></a>04093 }
<a name="l04094"></a>04094 
<a name="l04095"></a>04095 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l04096"></a><a class="code" href="../../d5/df2/win32_8c.html#ae1417da91fbabfcd1da2379da2a5a886">04096</a> <a class="code" href="../../d5/df2/win32_8c.html#ae1417da91fbabfcd1da2379da2a5a886">isUNCRoot</a>(<span class="keyword">const</span> WCHAR *path)
<a name="l04097"></a>04097 {
<a name="l04098"></a>04098     <span class="keywordflow">if</span> (path[0] == L<span class="charliteral">&apos;\\&apos;</span> &amp;&amp; path[1] == L<span class="charliteral">&apos;\\&apos;</span>) {
<a name="l04099"></a>04099         <span class="keyword">const</span> WCHAR *p;
<a name="l04100"></a>04100         <span class="keywordflow">for</span> (p = path + 2; *p; p++) {
<a name="l04101"></a>04101             <span class="keywordflow">if</span> (*p == L<span class="charliteral">&apos;\\&apos;</span>)
<a name="l04102"></a>04102                 <span class="keywordflow">break</span>;
<a name="l04103"></a>04103         }
<a name="l04104"></a>04104         <span class="keywordflow">if</span> (p[0] &amp;&amp; p[1]) {
<a name="l04105"></a>04105             <span class="keywordflow">for</span> (p++; *p; p++) {
<a name="l04106"></a>04106                 <span class="keywordflow">if</span> (*p == L<span class="charliteral">&apos;\\&apos;</span>)
<a name="l04107"></a>04107                     <span class="keywordflow">break</span>;
<a name="l04108"></a>04108             }
<a name="l04109"></a>04109             <span class="keywordflow">if</span> (!p[0] || !p[1] || (p[1] == L<span class="charliteral">&apos;.&apos;</span> &amp;&amp; !p[2]))
<a name="l04110"></a>04110                 <span class="keywordflow">return</span> 1;
<a name="l04111"></a>04111         }
<a name="l04112"></a>04112     }
<a name="l04113"></a>04113     <span class="keywordflow">return</span> 0;
<a name="l04114"></a>04114 }
<a name="l04115"></a>04115 
<a name="l04116"></a><a class="code" href="../../d5/df2/win32_8c.html#a03d725823b982ab30ed96f1b9c90f4e1">04116</a> <span class="preprocessor">#define COPY_STAT(src, dest, size_cast) do {    \</span>
<a name="l04117"></a>04117 <span class="preprocessor">        (dest).st_dev   = (src).st_dev;         \</span>
<a name="l04118"></a>04118 <span class="preprocessor">        (dest).st_ino   = (src).st_ino;         \</span>
<a name="l04119"></a>04119 <span class="preprocessor">        (dest).st_mode  = (src).st_mode;        \</span>
<a name="l04120"></a>04120 <span class="preprocessor">        (dest).st_nlink = (src).st_nlink;       \</span>
<a name="l04121"></a>04121 <span class="preprocessor">        (dest).st_uid   = (src).st_uid;         \</span>
<a name="l04122"></a>04122 <span class="preprocessor">        (dest).st_gid   = (src).st_gid;         \</span>
<a name="l04123"></a>04123 <span class="preprocessor">        (dest).st_rdev  = (src).st_rdev;        \</span>
<a name="l04124"></a>04124 <span class="preprocessor">        (dest).st_size  = size_cast(src).st_size; \</span>
<a name="l04125"></a>04125 <span class="preprocessor">        (dest).st_atime = (src).st_atime;       \</span>
<a name="l04126"></a>04126 <span class="preprocessor">        (dest).st_mtime = (src).st_mtime;       \</span>
<a name="l04127"></a>04127 <span class="preprocessor">        (dest).st_ctime = (src).st_ctime;       \</span>
<a name="l04128"></a>04128 <span class="preprocessor">    } while (0)</span>
<a name="l04129"></a>04129 <span class="preprocessor"></span>
<a name="l04130"></a>04130 <span class="keyword">static</span> <a class="code" href="../../d3/d90/missing_8h.html#a7157cbb87d46be33f7f913fa09144900">time_t</a> <a class="code" href="../../d5/df2/win32_8c.html#aef3c6de535492777b2f174f1c8631a4d">filetime_to_unixtime</a>(<span class="keyword">const</span> FILETIME *ft);
<a name="l04131"></a>04131 
<a name="l04132"></a>04132 <span class="preprocessor">#undef fstat</span>
<a name="l04133"></a>04133 <span class="preprocessor"></span><span class="keywordtype">int</span>
<a name="l04134"></a><a class="code" href="../../d5/df2/win32_8c.html#aa8e3da07b82f43db94f9786274c6c8f8">04134</a> <a class="code" href="../../dc/db1/win32_8h.html#a88552a4582be41a4352b85da8a874ed4">rb_w32_fstat</a>(<span class="keywordtype">int</span> fd, <span class="keyword">struct</span> <a class="code" href="../../dc/db1/win32_8h.html#a4feaac5e1913330bded57b059061965b">stat</a> *st)
<a name="l04135"></a>04135 {
<a name="l04136"></a>04136     BY_HANDLE_FILE_INFORMATION info;
<a name="l04137"></a>04137     <span class="keywordtype">int</span> ret = <a class="code" href="../../dc/db1/win32_8h.html#a8a2cf46df7f7017617df85cdb0afdc64">fstat</a>(fd, st);
<a name="l04138"></a>04138 
<a name="l04139"></a>04139     <span class="keywordflow">if</span> (ret) <span class="keywordflow">return</span> ret;
<a name="l04140"></a>04140 <span class="preprocessor">#ifdef __BORLANDC__</span>
<a name="l04141"></a>04141 <span class="preprocessor"></span>    st-&gt;st_mode &amp;= ~(<a class="code" href="../../dc/db1/win32_8h.html#ae6774871a90d9442f00abe18b87fee6e">S_IWGRP</a> | <a class="code" href="../../d6/d13/file_8c.html#a5303f49f26293acdb9533756c78322fb">S_IWOTH</a>);
<a name="l04142"></a>04142 <span class="preprocessor">#endif</span>
<a name="l04143"></a>04143 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (GetFileInformationByHandle((HANDLE)_get_osfhandle(fd), &amp;info)) {
<a name="l04144"></a>04144 <span class="preprocessor">#ifdef __BORLANDC__</span>
<a name="l04145"></a>04145 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!(info.dwFileAttributes &amp; FILE_ATTRIBUTE_READONLY)) {
<a name="l04146"></a>04146             st-&gt;st_mode |= <a class="code" href="../../dc/db1/win32_8h.html#ad70001754261c15a1bdc8e876c6d09d7">S_IWUSR</a>;
<a name="l04147"></a>04147         }
<a name="l04148"></a>04148 <span class="preprocessor">#endif</span>
<a name="l04149"></a>04149 <span class="preprocessor"></span>        st-&gt;st_atime = <a class="code" href="../../d5/df2/win32_8c.html#aef3c6de535492777b2f174f1c8631a4d">filetime_to_unixtime</a>(&amp;info.ftLastAccessTime);
<a name="l04150"></a>04150         st-&gt;st_mtime = <a class="code" href="../../d5/df2/win32_8c.html#aef3c6de535492777b2f174f1c8631a4d">filetime_to_unixtime</a>(&amp;info.ftLastWriteTime);
<a name="l04151"></a>04151         st-&gt;st_ctime = <a class="code" href="../../d5/df2/win32_8c.html#aef3c6de535492777b2f174f1c8631a4d">filetime_to_unixtime</a>(&amp;info.ftCreationTime);
<a name="l04152"></a>04152     }
<a name="l04153"></a>04153     <span class="keywordflow">return</span> ret;
<a name="l04154"></a>04154 }
<a name="l04155"></a>04155 
<a name="l04156"></a>04156 <span class="keywordtype">int</span>
<a name="l04157"></a><a class="code" href="../../d5/df2/win32_8c.html#ae1d2ff966352a11f77b005a6d6c1afb9">04157</a> <a class="code" href="../../dc/db1/win32_8h.html#a4836e53e52ad4338b85a5a1cb1be730d">rb_w32_fstati64</a>(<span class="keywordtype">int</span> fd, <span class="keyword">struct</span> stati64 *st)
<a name="l04158"></a>04158 {
<a name="l04159"></a>04159     BY_HANDLE_FILE_INFORMATION info;
<a name="l04160"></a>04160     <span class="keyword">struct </span><a class="code" href="../../dc/db1/win32_8h.html#a4feaac5e1913330bded57b059061965b">stat</a> tmp;
<a name="l04161"></a>04161     <span class="keywordtype">int</span> ret = <a class="code" href="../../dc/db1/win32_8h.html#a8a2cf46df7f7017617df85cdb0afdc64">fstat</a>(fd, &amp;tmp);
<a name="l04162"></a>04162 
<a name="l04163"></a>04163     <span class="keywordflow">if</span> (ret) <span class="keywordflow">return</span> ret;
<a name="l04164"></a>04164 <span class="preprocessor">#ifdef __BORLANDC__</span>
<a name="l04165"></a>04165 <span class="preprocessor"></span>    tmp.st_mode &amp;= ~(<a class="code" href="../../dc/db1/win32_8h.html#ae6774871a90d9442f00abe18b87fee6e">S_IWGRP</a> | <a class="code" href="../../d6/d13/file_8c.html#a5303f49f26293acdb9533756c78322fb">S_IWOTH</a>);
<a name="l04166"></a>04166 <span class="preprocessor">#endif</span>
<a name="l04167"></a>04167 <span class="preprocessor"></span>    <a class="code" href="../../d5/df2/win32_8c.html#a03d725823b982ab30ed96f1b9c90f4e1">COPY_STAT</a>(tmp, *st, +);
<a name="l04168"></a>04168     <span class="keywordflow">if</span> (GetFileInformationByHandle((HANDLE)_get_osfhandle(fd), &amp;info)) {
<a name="l04169"></a>04169 <span class="preprocessor">#ifdef __BORLANDC__</span>
<a name="l04170"></a>04170 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!(info.dwFileAttributes &amp; FILE_ATTRIBUTE_READONLY)) {
<a name="l04171"></a>04171             st-&gt;st_mode |= <a class="code" href="../../dc/db1/win32_8h.html#ad70001754261c15a1bdc8e876c6d09d7">S_IWUSR</a>;
<a name="l04172"></a>04172         }
<a name="l04173"></a>04173 <span class="preprocessor">#endif</span>
<a name="l04174"></a>04174 <span class="preprocessor"></span>        st-&gt;st_size = ((__int64)info.nFileSizeHigh &lt;&lt; 32) | info.nFileSizeLow;
<a name="l04175"></a>04175         st-&gt;st_atime = <a class="code" href="../../d5/df2/win32_8c.html#aef3c6de535492777b2f174f1c8631a4d">filetime_to_unixtime</a>(&amp;info.ftLastAccessTime);
<a name="l04176"></a>04176         st-&gt;st_mtime = <a class="code" href="../../d5/df2/win32_8c.html#aef3c6de535492777b2f174f1c8631a4d">filetime_to_unixtime</a>(&amp;info.ftLastWriteTime);
<a name="l04177"></a>04177         st-&gt;st_ctime = <a class="code" href="../../d5/df2/win32_8c.html#aef3c6de535492777b2f174f1c8631a4d">filetime_to_unixtime</a>(&amp;info.ftCreationTime);
<a name="l04178"></a>04178     }
<a name="l04179"></a>04179     <span class="keywordflow">return</span> ret;
<a name="l04180"></a>04180 }
<a name="l04181"></a>04181 
<a name="l04182"></a>04182 <span class="keyword">static</span> <a class="code" href="../../d3/d90/missing_8h.html#a7157cbb87d46be33f7f913fa09144900">time_t</a>
<a name="l04183"></a><a class="code" href="../../d5/df2/win32_8c.html#aef3c6de535492777b2f174f1c8631a4d">04183</a> <a class="code" href="../../d5/df2/win32_8c.html#aef3c6de535492777b2f174f1c8631a4d">filetime_to_unixtime</a>(<span class="keyword">const</span> FILETIME *ft)
<a name="l04184"></a>04184 {
<a name="l04185"></a>04185     <span class="keyword">struct </span><a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> tv;
<a name="l04186"></a>04186 
<a name="l04187"></a>04187     <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#abaacd3c9dbb744ba975e70353c19dd6b">filetime_to_timeval</a>(ft, &amp;tv) == (<a class="code" href="../../d3/d90/missing_8h.html#a7157cbb87d46be33f7f913fa09144900">time_t</a>)-1)
<a name="l04188"></a>04188         <span class="keywordflow">return</span> 0;
<a name="l04189"></a>04189     <span class="keywordflow">else</span>
<a name="l04190"></a>04190         <span class="keywordflow">return</span> tv.<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a>;
<a name="l04191"></a>04191 }
<a name="l04192"></a>04192 
<a name="l04193"></a>04193 <span class="keyword">static</span> <span class="keywordtype">unsigned</span>
<a name="l04194"></a><a class="code" href="../../d5/df2/win32_8c.html#a149ef612577763ed905d8f70cac1b0fc">04194</a> <a class="code" href="../../d5/df2/win32_8c.html#a149ef612577763ed905d8f70cac1b0fc">fileattr_to_unixmode</a>(<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> attr, <span class="keyword">const</span> WCHAR *path)
<a name="l04195"></a>04195 {
<a name="l04196"></a>04196     <span class="keywordtype">unsigned</span> mode = 0;
<a name="l04197"></a>04197 
<a name="l04198"></a>04198     <span class="keywordflow">if</span> (attr &amp; FILE_ATTRIBUTE_READONLY) {
<a name="l04199"></a>04199         mode |= S_IREAD;
<a name="l04200"></a>04200     }
<a name="l04201"></a>04201     <span class="keywordflow">else</span> {
<a name="l04202"></a>04202         mode |= S_IREAD | S_IWRITE | <a class="code" href="../../dc/db1/win32_8h.html#ad70001754261c15a1bdc8e876c6d09d7">S_IWUSR</a>;
<a name="l04203"></a>04203     }
<a name="l04204"></a>04204 
<a name="l04205"></a>04205     <span class="keywordflow">if</span> (attr &amp; FILE_ATTRIBUTE_DIRECTORY) {
<a name="l04206"></a>04206         mode |= S_IFDIR | S_IEXEC;
<a name="l04207"></a>04207     }
<a name="l04208"></a>04208     <span class="keywordflow">else</span> {
<a name="l04209"></a>04209         mode |= S_IFREG;
<a name="l04210"></a>04210     }
<a name="l04211"></a>04211 
<a name="l04212"></a>04212     <span class="keywordflow">if</span> (path &amp;&amp; (mode &amp; S_IFREG)) {
<a name="l04213"></a>04213         <span class="keyword">const</span> WCHAR *end = path + lstrlenW(path);
<a name="l04214"></a>04214         <span class="keywordflow">while</span> (path &lt; end) {
<a name="l04215"></a>04215             end = CharPrevW(path, end);
<a name="l04216"></a>04216             <span class="keywordflow">if</span> (*end == L<span class="charliteral">&apos;.&apos;</span>) {
<a name="l04217"></a>04217                 <span class="keywordflow">if</span> ((_wcsicmp(end, L<span class="stringliteral">&quot;.bat&quot;</span>) == 0) ||
<a name="l04218"></a>04218                     (_wcsicmp(end, L<span class="stringliteral">&quot;.cmd&quot;</span>) == 0) ||
<a name="l04219"></a>04219                     (_wcsicmp(end, L<span class="stringliteral">&quot;.com&quot;</span>) == 0) ||
<a name="l04220"></a>04220                     (_wcsicmp(end, L<span class="stringliteral">&quot;.exe&quot;</span>) == 0)) {
<a name="l04221"></a>04221                     mode |= S_IEXEC;
<a name="l04222"></a>04222                 }
<a name="l04223"></a>04223                 <span class="keywordflow">break</span>;
<a name="l04224"></a>04224             }
<a name="l04225"></a>04225         }
<a name="l04226"></a>04226     }
<a name="l04227"></a>04227 
<a name="l04228"></a>04228     mode |= (mode &amp; 0700) &gt;&gt; 3;
<a name="l04229"></a>04229     mode |= (mode &amp; 0700) &gt;&gt; 6;
<a name="l04230"></a>04230 
<a name="l04231"></a>04231     <span class="keywordflow">return</span> mode;
<a name="l04232"></a>04232 }
<a name="l04233"></a>04233 
<a name="l04234"></a>04234 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l04235"></a><a class="code" href="../../d5/df2/win32_8c.html#a50071c8939be943374a1b797c0072b7a">04235</a> <a class="code" href="../../d5/df2/win32_8c.html#a50071c8939be943374a1b797c0072b7a">check_valid_dir</a>(<span class="keyword">const</span> WCHAR *path)
<a name="l04236"></a>04236 {
<a name="l04237"></a>04237     WIN32_FIND_DATAW fd;
<a name="l04238"></a>04238     HANDLE fh;
<a name="l04239"></a>04239 
<a name="l04240"></a>04240     <span class="comment">/* GetFileAttributes() determines &quot;...&quot; as directory. */</span>
<a name="l04241"></a>04241     <span class="comment">/* We recheck it by FindFirstFile(). */</span>
<a name="l04242"></a>04242     <span class="keywordflow">if</span> (wcsstr(path, L<span class="stringliteral">&quot;...&quot;</span>) == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l04243"></a>04243         <span class="keywordflow">return</span> 0;
<a name="l04244"></a>04244 
<a name="l04245"></a>04245     fh = <a class="code" href="../../d5/df2/win32_8c.html#a8648c0d7bdfe57ccc5eb14a3c8e2f372">open_dir_handle</a>(path, &amp;fd);
<a name="l04246"></a>04246     <span class="keywordflow">if</span> (fh == INVALID_HANDLE_VALUE)
<a name="l04247"></a>04247         <span class="keywordflow">return</span> -1;
<a name="l04248"></a>04248     FindClose(fh);
<a name="l04249"></a>04249     <span class="keywordflow">return</span> 0;
<a name="l04250"></a>04250 }
<a name="l04251"></a>04251 
<a name="l04252"></a>04252 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l04253"></a><a class="code" href="../../d5/df2/win32_8c.html#af90f2ad3a7a0a6239838a6a0b1ea191c">04253</a> <a class="code" href="../../d5/df2/win32_8c.html#af90f2ad3a7a0a6239838a6a0b1ea191c">winnt_stat</a>(<span class="keyword">const</span> WCHAR *path, <span class="keyword">struct</span> stati64 *st)
<a name="l04254"></a>04254 {
<a name="l04255"></a>04255     HANDLE h;
<a name="l04256"></a>04256     WIN32_FIND_DATAW wfd;
<a name="l04257"></a>04257     WIN32_FILE_ATTRIBUTE_DATA wfa;
<a name="l04258"></a>04258 
<a name="l04259"></a>04259     memset(st, 0, <span class="keyword">sizeof</span>(*st));
<a name="l04260"></a>04260     st-&gt;st_nlink = 1;
<a name="l04261"></a>04261 
<a name="l04262"></a>04262     <span class="keywordflow">if</span> (wcspbrk(path, L<span class="stringliteral">&quot;?*&quot;</span>)) {
<a name="l04263"></a>04263         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ENOENT;
<a name="l04264"></a>04264         <span class="keywordflow">return</span> -1;
<a name="l04265"></a>04265     }
<a name="l04266"></a>04266     <span class="keywordflow">if</span> (GetFileAttributesExW(path, GetFileExInfoStandard, (<span class="keywordtype">void</span>*)&amp;wfa)) {
<a name="l04267"></a>04267         <span class="keywordflow">if</span> (wfa.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY) {
<a name="l04268"></a>04268             <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a50071c8939be943374a1b797c0072b7a">check_valid_dir</a>(path)) <span class="keywordflow">return</span> -1;
<a name="l04269"></a>04269             st-&gt;st_size = 0;
<a name="l04270"></a>04270         }
<a name="l04271"></a>04271         <span class="keywordflow">else</span> {
<a name="l04272"></a>04272             st-&gt;st_size = ((__int64)wfa.nFileSizeHigh &lt;&lt; 32) | wfa.nFileSizeLow;
<a name="l04273"></a>04273         }
<a name="l04274"></a>04274         st-&gt;st_mode  = <a class="code" href="../../d5/df2/win32_8c.html#a149ef612577763ed905d8f70cac1b0fc">fileattr_to_unixmode</a>(wfa.dwFileAttributes, path);
<a name="l04275"></a>04275         st-&gt;st_atime = <a class="code" href="../../d5/df2/win32_8c.html#aef3c6de535492777b2f174f1c8631a4d">filetime_to_unixtime</a>(&amp;wfa.ftLastAccessTime);
<a name="l04276"></a>04276         st-&gt;st_mtime = <a class="code" href="../../d5/df2/win32_8c.html#aef3c6de535492777b2f174f1c8631a4d">filetime_to_unixtime</a>(&amp;wfa.ftLastWriteTime);
<a name="l04277"></a>04277         st-&gt;st_ctime = <a class="code" href="../../d5/df2/win32_8c.html#aef3c6de535492777b2f174f1c8631a4d">filetime_to_unixtime</a>(&amp;wfa.ftCreationTime);
<a name="l04278"></a>04278     }
<a name="l04279"></a>04279     <span class="keywordflow">else</span> {
<a name="l04280"></a>04280         <span class="comment">/* GetFileAttributesEx failed; check why. */</span>
<a name="l04281"></a>04281         <span class="keywordtype">int</span> e = GetLastError();
<a name="l04282"></a>04282 
<a name="l04283"></a>04283         <span class="keywordflow">if</span> ((e == ERROR_FILE_NOT_FOUND) || (e == ERROR_INVALID_NAME)
<a name="l04284"></a>04284             || (e == ERROR_PATH_NOT_FOUND || (e == ERROR_BAD_NETPATH))) {
<a name="l04285"></a>04285             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(e);
<a name="l04286"></a>04286             <span class="keywordflow">return</span> -1;
<a name="l04287"></a>04287         }
<a name="l04288"></a>04288 
<a name="l04289"></a>04289         <span class="comment">/* Fall back to FindFirstFile for ERROR_SHARING_VIOLATION */</span>
<a name="l04290"></a>04290         h = FindFirstFileW(path, &amp;wfd);
<a name="l04291"></a>04291         <span class="keywordflow">if</span> (h != INVALID_HANDLE_VALUE) {
<a name="l04292"></a>04292             FindClose(h);
<a name="l04293"></a>04293             st-&gt;st_mode  = <a class="code" href="../../d5/df2/win32_8c.html#a149ef612577763ed905d8f70cac1b0fc">fileattr_to_unixmode</a>(wfd.dwFileAttributes, path);
<a name="l04294"></a>04294             st-&gt;st_atime = <a class="code" href="../../d5/df2/win32_8c.html#aef3c6de535492777b2f174f1c8631a4d">filetime_to_unixtime</a>(&amp;wfd.ftLastAccessTime);
<a name="l04295"></a>04295             st-&gt;st_mtime = <a class="code" href="../../d5/df2/win32_8c.html#aef3c6de535492777b2f174f1c8631a4d">filetime_to_unixtime</a>(&amp;wfd.ftLastWriteTime);
<a name="l04296"></a>04296             st-&gt;st_ctime = <a class="code" href="../../d5/df2/win32_8c.html#aef3c6de535492777b2f174f1c8631a4d">filetime_to_unixtime</a>(&amp;wfd.ftCreationTime);
<a name="l04297"></a>04297             st-&gt;st_size = ((__int64)wfd.nFileSizeHigh &lt;&lt; 32) | wfd.nFileSizeLow;
<a name="l04298"></a>04298         }
<a name="l04299"></a>04299         <span class="keywordflow">else</span> {
<a name="l04300"></a>04300             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l04301"></a>04301             <span class="keywordflow">return</span> -1;
<a name="l04302"></a>04302         }
<a name="l04303"></a>04303     }
<a name="l04304"></a>04304 
<a name="l04305"></a>04305     st-&gt;st_dev = st-&gt;st_rdev = (iswalpha(path[0]) &amp;&amp; path[1] == L<span class="charliteral">&apos;:&apos;</span>) ?
<a name="l04306"></a>04306         towupper(path[0]) - L<span class="charliteral">&apos;A&apos;</span> : _getdrive() - 1;
<a name="l04307"></a>04307 
<a name="l04308"></a>04308     <span class="keywordflow">return</span> 0;
<a name="l04309"></a>04309 }
<a name="l04310"></a>04310 
<a name="l04311"></a>04311 <span class="preprocessor">#ifdef WIN95</span>
<a name="l04312"></a>04312 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l04313"></a>04313 <a class="code" href="../../d5/df2/win32_8c.html#a39e45ee0096ba1b8c7076ff5b8a99b9e">win95_stat</a>(<span class="keyword">const</span> WCHAR *path, <span class="keyword">struct</span> stati64 *st)
<a name="l04314"></a>04314 {
<a name="l04315"></a>04315     <span class="keywordtype">int</span> ret = _wstati64(path, st);
<a name="l04316"></a>04316     <span class="keywordflow">if</span> (ret) <span class="keywordflow">return</span> ret;
<a name="l04317"></a>04317     <span class="keywordflow">if</span> (st-&gt;st_mode &amp; S_IFDIR) {
<a name="l04318"></a>04318         <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#a50071c8939be943374a1b797c0072b7a">check_valid_dir</a>(path);
<a name="l04319"></a>04319     }
<a name="l04320"></a>04320     <span class="keywordflow">return</span> 0;
<a name="l04321"></a>04321 }
<a name="l04322"></a>04322 <span class="preprocessor">#else</span>
<a name="l04323"></a><a class="code" href="../../d5/df2/win32_8c.html#a39e45ee0096ba1b8c7076ff5b8a99b9e">04323</a> <span class="preprocessor"></span><span class="preprocessor">#define win95_stat(path, st) -1</span>
<a name="l04324"></a>04324 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l04325"></a>04325 <span class="preprocessor"></span>
<a name="l04326"></a>04326 <span class="keywordtype">int</span>
<a name="l04327"></a><a class="code" href="../../d5/df2/win32_8c.html#a4d35749591359c0fa07b02d18de80eee">04327</a> <a class="code" href="../../dc/db1/win32_8h.html#a8fd6eec8d901b4e1b199170ffd09a31d">rb_w32_stat</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keyword">struct</span> <a class="code" href="../../dc/db1/win32_8h.html#a4feaac5e1913330bded57b059061965b">stat</a> *st)
<a name="l04328"></a>04328 {
<a name="l04329"></a>04329     <span class="keyword">struct </span>stati64 tmp;
<a name="l04330"></a>04330 
<a name="l04331"></a>04331     <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#a757f3c96af3781bf2a04f0c62a5b5514">rb_w32_stati64</a>(path, &amp;tmp)) <span class="keywordflow">return</span> -1;
<a name="l04332"></a>04332     <a class="code" href="../../d5/df2/win32_8c.html#a03d725823b982ab30ed96f1b9c90f4e1">COPY_STAT</a>(tmp, *st, (_off_t));
<a name="l04333"></a>04333     <span class="keywordflow">return</span> 0;
<a name="l04334"></a>04334 }
<a name="l04335"></a>04335 
<a name="l04336"></a>04336 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l04337"></a><a class="code" href="../../d5/df2/win32_8c.html#aa6e8114a63a22d89103ef7434a6ae53e">04337</a> <a class="code" href="../../d5/df2/win32_8c.html#aa6e8114a63a22d89103ef7434a6ae53e">wstati64</a>(<span class="keyword">const</span> WCHAR *path, <span class="keyword">struct</span> stati64 *st)
<a name="l04338"></a>04338 {
<a name="l04339"></a>04339     <span class="keyword">const</span> WCHAR *p;
<a name="l04340"></a>04340     WCHAR *buf1, *s, *end;
<a name="l04341"></a>04341     <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>;
<a name="l04342"></a>04342     <span class="keywordtype">int</span> ret;
<a name="l04343"></a>04343     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v;
<a name="l04344"></a>04344 
<a name="l04345"></a>04345     <span class="keywordflow">if</span> (!path || !st) {
<a name="l04346"></a>04346         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EFAULT;
<a name="l04347"></a>04347         <span class="keywordflow">return</span> -1;
<a name="l04348"></a>04348     }
<a name="l04349"></a>04349     size = lstrlenW(path) + 2;
<a name="l04350"></a>04350     buf1 = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa2fd9cb81f5d1422607583906d085a11">ALLOCV_N</a>(WCHAR, v, size);
<a name="l04351"></a>04351     <span class="keywordflow">for</span> (p = path, s = buf1; *p; p++, s++) {
<a name="l04352"></a>04352         <span class="keywordflow">if</span> (*p == L<span class="charliteral">&apos;/&apos;</span>)
<a name="l04353"></a>04353             *s = L<span class="charliteral">&apos;\\&apos;</span>;
<a name="l04354"></a>04354         <span class="keywordflow">else</span>
<a name="l04355"></a>04355             *s = *p;
<a name="l04356"></a>04356     }
<a name="l04357"></a>04357     *s = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04358"></a>04358     len = s - buf1;
<a name="l04359"></a>04359     <span class="keywordflow">if</span> (!len || L<span class="charliteral">&apos;\&quot;&apos;</span> == *(--s)) {
<a name="l04360"></a>04360         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ENOENT;
<a name="l04361"></a>04361         <span class="keywordflow">return</span> -1;
<a name="l04362"></a>04362     }
<a name="l04363"></a>04363     end = buf1 + len - 1;
<a name="l04364"></a>04364 
<a name="l04365"></a>04365     <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#ae1417da91fbabfcd1da2379da2a5a886">isUNCRoot</a>(buf1)) {
<a name="l04366"></a>04366         <span class="keywordflow">if</span> (*end == L<span class="charliteral">&apos;.&apos;</span>)
<a name="l04367"></a>04367             *end = L<span class="charliteral">&apos;\0&apos;</span>;
<a name="l04368"></a>04368         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*end != L<span class="charliteral">&apos;\\&apos;</span>)
<a name="l04369"></a>04369             lstrcatW(buf1, L<span class="stringliteral">&quot;\\&quot;</span>);
<a name="l04370"></a>04370     }
<a name="l04371"></a>04371     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*end == L<span class="charliteral">&apos;\\&apos;</span> || (buf1 + 1 == end &amp;&amp; *end == L<span class="charliteral">&apos;:&apos;</span>))
<a name="l04372"></a>04372         lstrcatW(buf1, L<span class="stringliteral">&quot;.&quot;</span>);
<a name="l04373"></a>04373 
<a name="l04374"></a>04374     ret = <a class="code" href="../../d5/df2/win32_8c.html#aaa9c3231dcc73fc8381f671b588fb13a">IsWinNT</a>() ? <a class="code" href="../../d5/df2/win32_8c.html#af90f2ad3a7a0a6239838a6a0b1ea191c">winnt_stat</a>(buf1, st) : <a class="code" href="../../d5/df2/win32_8c.html#a39e45ee0096ba1b8c7076ff5b8a99b9e">win95_stat</a>(buf1, st);
<a name="l04375"></a>04375     <span class="keywordflow">if</span> (ret == 0) {
<a name="l04376"></a>04376         st-&gt;st_mode &amp;= ~(<a class="code" href="../../dc/db1/win32_8h.html#ae6774871a90d9442f00abe18b87fee6e">S_IWGRP</a> | <a class="code" href="../../d6/d13/file_8c.html#a5303f49f26293acdb9533756c78322fb">S_IWOTH</a>);
<a name="l04377"></a>04377     }
<a name="l04378"></a>04378     <span class="keywordflow">if</span> (v)
<a name="l04379"></a>04379         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a13424d6f6efe4c7cf2f032744a04e51c">ALLOCV_END</a>(v);
<a name="l04380"></a>04380 
<a name="l04381"></a>04381     <span class="keywordflow">return</span> ret;
<a name="l04382"></a>04382 }
<a name="l04383"></a>04383 
<a name="l04384"></a>04384 <span class="keywordtype">int</span>
<a name="l04385"></a><a class="code" href="../../d5/df2/win32_8c.html#aa79a615c5596868699024d5bf4234bdb">04385</a> <a class="code" href="../../dc/db1/win32_8h.html#abb172aaa3b14f9c60daf129b5dec5e5b">rb_w32_ustati64</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keyword">struct</span> stati64 *st)
<a name="l04386"></a>04386 {
<a name="l04387"></a>04387     WCHAR *wpath;
<a name="l04388"></a>04388     <span class="keywordtype">int</span> ret;
<a name="l04389"></a>04389 
<a name="l04390"></a>04390     <span class="keywordflow">if</span> (!(wpath = <a class="code" href="../../d5/df2/win32_8c.html#a41003a1382888cc771e290746769eb13">utf8_to_wstr</a>(path, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l04391"></a>04391         <span class="keywordflow">return</span> -1;
<a name="l04392"></a>04392     ret = <a class="code" href="../../d5/df2/win32_8c.html#aa6e8114a63a22d89103ef7434a6ae53e">wstati64</a>(wpath, st);
<a name="l04393"></a>04393     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wpath);
<a name="l04394"></a>04394     <span class="keywordflow">return</span> ret;
<a name="l04395"></a>04395 }
<a name="l04396"></a>04396 
<a name="l04397"></a>04397 <span class="keywordtype">int</span>
<a name="l04398"></a><a class="code" href="../../d5/df2/win32_8c.html#a818afa5bc3a1356476c70fd8dd4d8ee6">04398</a> <a class="code" href="../../dc/db1/win32_8h.html#a757f3c96af3781bf2a04f0c62a5b5514">rb_w32_stati64</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keyword">struct</span> stati64 *st)
<a name="l04399"></a>04399 {
<a name="l04400"></a>04400     WCHAR *wpath;
<a name="l04401"></a>04401     <span class="keywordtype">int</span> ret;
<a name="l04402"></a>04402 
<a name="l04403"></a>04403     <span class="keywordflow">if</span> (!(wpath = <a class="code" href="../../d5/df2/win32_8c.html#ad33d311f649154599e920240e3900a59">filecp_to_wstr</a>(path, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l04404"></a>04404         <span class="keywordflow">return</span> -1;
<a name="l04405"></a>04405     ret = <a class="code" href="../../d5/df2/win32_8c.html#aa6e8114a63a22d89103ef7434a6ae53e">wstati64</a>(wpath, st);
<a name="l04406"></a>04406     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wpath);
<a name="l04407"></a>04407     <span class="keywordflow">return</span> ret;
<a name="l04408"></a>04408 }
<a name="l04409"></a>04409 
<a name="l04410"></a>04410 <span class="keywordtype">int</span>
<a name="l04411"></a><a class="code" href="../../d5/df2/win32_8c.html#abe1e4daac1df7f1d1dfe38c12205ac28">04411</a> <a class="code" href="../../dc/db1/win32_8h.html#a07f427aabd6bbbb83c6bd19e34cb8b75">rb_w32_access</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> mode)
<a name="l04412"></a>04412 {
<a name="l04413"></a>04413     <span class="keyword">struct </span>stati64 stat;
<a name="l04414"></a>04414     <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#a757f3c96af3781bf2a04f0c62a5b5514">rb_w32_stati64</a>(path, &amp;stat) != 0)
<a name="l04415"></a>04415         <span class="keywordflow">return</span> -1;
<a name="l04416"></a>04416     mode &lt;&lt;= 6;
<a name="l04417"></a>04417     <span class="keywordflow">if</span> ((stat.st_mode &amp; mode) != mode) {
<a name="l04418"></a>04418         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EACCES;
<a name="l04419"></a>04419         <span class="keywordflow">return</span> -1;
<a name="l04420"></a>04420     }
<a name="l04421"></a>04421     <span class="keywordflow">return</span> 0;
<a name="l04422"></a>04422 }
<a name="l04423"></a>04423 
<a name="l04424"></a>04424 <span class="keywordtype">int</span>
<a name="l04425"></a><a class="code" href="../../d5/df2/win32_8c.html#a649dd865ed4a65a4a7c90076ce58a713">04425</a> <a class="code" href="../../dc/db1/win32_8h.html#a5c0e38c2d1cd092fe01b59c41260aaa4">rb_w32_uaccess</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> mode)
<a name="l04426"></a>04426 {
<a name="l04427"></a>04427     <span class="keyword">struct </span>stati64 stat;
<a name="l04428"></a>04428     <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#abb172aaa3b14f9c60daf129b5dec5e5b">rb_w32_ustati64</a>(path, &amp;stat) != 0)
<a name="l04429"></a>04429         <span class="keywordflow">return</span> -1;
<a name="l04430"></a>04430     mode &lt;&lt;= 6;
<a name="l04431"></a>04431     <span class="keywordflow">if</span> ((stat.st_mode &amp; mode) != mode) {
<a name="l04432"></a>04432         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EACCES;
<a name="l04433"></a>04433         <span class="keywordflow">return</span> -1;
<a name="l04434"></a>04434     }
<a name="l04435"></a>04435     <span class="keywordflow">return</span> 0;
<a name="l04436"></a>04436 }
<a name="l04437"></a>04437 
<a name="l04438"></a>04438 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l04439"></a><a class="code" href="../../d5/df2/win32_8c.html#ac6fa0551d1dbd042b05dce928de6ac9d">04439</a> <a class="code" href="../../d5/df2/win32_8c.html#ac6fa0551d1dbd042b05dce928de6ac9d">rb_chsize</a>(HANDLE h, <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l04440"></a>04440 {
<a name="l04441"></a>04441     <span class="keywordtype">long</span> upos, lpos, usize, lsize, uend, lend;
<a name="l04442"></a>04442     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> end;
<a name="l04443"></a>04443     <span class="keywordtype">int</span> ret = -1;
<a name="l04444"></a>04444     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> e;
<a name="l04445"></a>04445 
<a name="l04446"></a>04446     <span class="keywordflow">if</span> (((lpos = SetFilePointer(h, 0, (upos = 0, &amp;upos), <a class="code" href="../../df/d0a/io_8c.html#a4c8d0b76b470ba65a43ca46a88320f39">SEEK_CUR</a>)) == -1L &amp;&amp;
<a name="l04447"></a>04447          (e = GetLastError())) ||
<a name="l04448"></a>04448         ((lend = GetFileSize(h, (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> *)&amp;uend)) == -1L &amp;&amp; (e = GetLastError()))) {
<a name="l04449"></a>04449         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(e);
<a name="l04450"></a>04450         <span class="keywordflow">return</span> -1;
<a name="l04451"></a>04451     }
<a name="l04452"></a>04452     end = ((<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)uend &lt;&lt; 32) | (<span class="keywordtype">unsigned</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a>)lend;
<a name="l04453"></a>04453     usize = (<a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a>)(size &gt;&gt; 32);
<a name="l04454"></a>04454     lsize = (<a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a>)size;
<a name="l04455"></a>04455     <span class="keywordflow">if</span> (SetFilePointer(h, lsize, &amp;usize, <a class="code" href="../../df/d0a/io_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">SEEK_SET</a>) == (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)-1L &amp;&amp;
<a name="l04456"></a>04456         (e = GetLastError())) {
<a name="l04457"></a>04457         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(e);
<a name="l04458"></a>04458     }
<a name="l04459"></a>04459     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!SetEndOfFile(h)) {
<a name="l04460"></a>04460         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l04461"></a>04461     }
<a name="l04462"></a>04462     <span class="keywordflow">else</span> {
<a name="l04463"></a>04463         ret = 0;
<a name="l04464"></a>04464     }
<a name="l04465"></a>04465     SetFilePointer(h, lpos, &amp;upos, <a class="code" href="../../df/d0a/io_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">SEEK_SET</a>);
<a name="l04466"></a>04466     <span class="keywordflow">return</span> ret;
<a name="l04467"></a>04467 }
<a name="l04468"></a>04468 
<a name="l04469"></a>04469 <span class="keywordtype">int</span>
<a name="l04470"></a><a class="code" href="../../d5/df2/win32_8c.html#a395d112fd7811f17d48d702b711dac9a">04470</a> <a class="code" href="../../dc/db1/win32_8h.html#a395d112fd7811f17d48d702b711dac9a">rb_w32_truncate</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> length)
<a name="l04471"></a>04471 {
<a name="l04472"></a>04472     HANDLE h;
<a name="l04473"></a>04473     <span class="keywordtype">int</span> ret;
<a name="l04474"></a>04474 <span class="preprocessor">#ifdef WIN95</span>
<a name="l04475"></a>04475 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a612e2ad1adbb621210494d51d634d40d">IsWin95</a>()) {
<a name="l04476"></a>04476         <span class="keywordtype">int</span> fd = open(path, O_WRONLY), e = 0;
<a name="l04477"></a>04477         <span class="keywordflow">if</span> (fd == -1) <span class="keywordflow">return</span> -1;
<a name="l04478"></a>04478         ret = chsize(fd, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)length);
<a name="l04479"></a>04479         <span class="keywordflow">if</span> (ret == -1) e = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l04480"></a>04480         close(fd);
<a name="l04481"></a>04481         <span class="keywordflow">if</span> (ret == -1) <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = e;
<a name="l04482"></a>04482         <span class="keywordflow">return</span> ret;
<a name="l04483"></a>04483     }
<a name="l04484"></a>04484 <span class="preprocessor">#endif</span>
<a name="l04485"></a>04485 <span class="preprocessor"></span>    h = CreateFile(path, GENERIC_WRITE, 0, 0, OPEN_EXISTING, 0, 0);
<a name="l04486"></a>04486     <span class="keywordflow">if</span> (h == INVALID_HANDLE_VALUE) {
<a name="l04487"></a>04487         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l04488"></a>04488         <span class="keywordflow">return</span> -1;
<a name="l04489"></a>04489     }
<a name="l04490"></a>04490     ret = <a class="code" href="../../d5/df2/win32_8c.html#ac6fa0551d1dbd042b05dce928de6ac9d">rb_chsize</a>(h, length);
<a name="l04491"></a>04491     CloseHandle(h);
<a name="l04492"></a>04492     <span class="keywordflow">return</span> ret;
<a name="l04493"></a>04493 }
<a name="l04494"></a>04494 
<a name="l04495"></a>04495 <span class="keywordtype">int</span>
<a name="l04496"></a><a class="code" href="../../d5/df2/win32_8c.html#a13d93a5f80fba3938f6523460872bf2c">04496</a> <a class="code" href="../../dc/db1/win32_8h.html#a13d93a5f80fba3938f6523460872bf2c">rb_w32_ftruncate</a>(<span class="keywordtype">int</span> fd, <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> length)
<a name="l04497"></a>04497 {
<a name="l04498"></a>04498     HANDLE h;
<a name="l04499"></a>04499 
<a name="l04500"></a>04500 <span class="preprocessor">#ifdef WIN95</span>
<a name="l04501"></a>04501 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a612e2ad1adbb621210494d51d634d40d">IsWin95</a>()) {
<a name="l04502"></a>04502         <span class="keywordflow">return</span> chsize(fd, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)length);
<a name="l04503"></a>04503     }
<a name="l04504"></a>04504 <span class="preprocessor">#endif</span>
<a name="l04505"></a>04505 <span class="preprocessor"></span>    h = (HANDLE)_get_osfhandle(fd);
<a name="l04506"></a>04506     <span class="keywordflow">if</span> (h == (HANDLE)-1) <span class="keywordflow">return</span> -1;
<a name="l04507"></a>04507     <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#ac6fa0551d1dbd042b05dce928de6ac9d">rb_chsize</a>(h, length);
<a name="l04508"></a>04508 }
<a name="l04509"></a>04509 
<a name="l04510"></a>04510 <span class="preprocessor">#ifdef __BORLANDC__</span>
<a name="l04511"></a>04511 <span class="preprocessor"></span><a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>
<a name="l04512"></a>04512 _filelengthi64(<span class="keywordtype">int</span> fd)
<a name="l04513"></a>04513 {
<a name="l04514"></a>04514     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> u, l;
<a name="l04515"></a>04515     <span class="keywordtype">int</span> e;
<a name="l04516"></a>04516 
<a name="l04517"></a>04517     l = GetFileSize((HANDLE)_get_osfhandle(fd), &amp;u);
<a name="l04518"></a>04518     <span class="keywordflow">if</span> (l == (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)-1L &amp;&amp; (e = GetLastError())) {
<a name="l04519"></a>04519         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(e);
<a name="l04520"></a>04520         <span class="keywordflow">return</span> (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1;
<a name="l04521"></a>04521     }
<a name="l04522"></a>04522     <span class="keywordflow">return</span> ((<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)u &lt;&lt; 32) | l;
<a name="l04523"></a>04523 }
<a name="l04524"></a>04524 
<a name="l04525"></a>04525 <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>
<a name="l04526"></a>04526 _lseeki64(<span class="keywordtype">int</span> fd, <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> offset, <span class="keywordtype">int</span> whence)
<a name="l04527"></a>04527 {
<a name="l04528"></a>04528     <span class="keywordtype">long</span> u, l;
<a name="l04529"></a>04529     <span class="keywordtype">int</span> e;
<a name="l04530"></a>04530     HANDLE h = (HANDLE)_get_osfhandle(fd);
<a name="l04531"></a>04531 
<a name="l04532"></a>04532     <span class="keywordflow">if</span> (!h) {
<a name="l04533"></a>04533         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EBADF;
<a name="l04534"></a>04534         <span class="keywordflow">return</span> -1;
<a name="l04535"></a>04535     }
<a name="l04536"></a>04536     u = (<a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a>)(offset &gt;&gt; 32);
<a name="l04537"></a>04537     <span class="keywordflow">if</span> ((l = SetFilePointer(h, (<span class="keywordtype">long</span>)offset, &amp;u, whence)) == -1L &amp;&amp;
<a name="l04538"></a>04538         (e = GetLastError())) {
<a name="l04539"></a>04539         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(e);
<a name="l04540"></a>04540         <span class="keywordflow">return</span> -1;
<a name="l04541"></a>04541     }
<a name="l04542"></a>04542     <span class="keywordflow">return</span> ((<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)u &lt;&lt; 32) | l;
<a name="l04543"></a>04543 }
<a name="l04544"></a>04544 <span class="preprocessor">#endif</span>
<a name="l04545"></a>04545 <span class="preprocessor"></span>
<a name="l04546"></a>04546 <span class="keywordtype">int</span>
<a name="l04547"></a><a class="code" href="../../d5/df2/win32_8c.html#a819f057285a278044b6bc6e66dff2f2f">04547</a> <a class="code" href="../../dc/db1/win32_8h.html#a227875b8399b0589b1124555d3ae4007">fseeko</a>(<a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *stream, <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> offset, <span class="keywordtype">int</span> whence)
<a name="l04548"></a>04548 {
<a name="l04549"></a>04549     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> pos;
<a name="l04550"></a>04550     <span class="keywordflow">switch</span> (whence) {
<a name="l04551"></a>04551       <span class="keywordflow">case</span> <a class="code" href="../../df/d0a/io_8c.html#a4c8d0b76b470ba65a43ca46a88320f39">SEEK_CUR</a>:
<a name="l04552"></a>04552         <span class="keywordflow">if</span> (fgetpos(stream, (fpos_t *)&amp;pos))
<a name="l04553"></a>04553             <span class="keywordflow">return</span> -1;
<a name="l04554"></a>04554         pos += offset;
<a name="l04555"></a>04555         <span class="keywordflow">break</span>;
<a name="l04556"></a>04556       <span class="keywordflow">case</span> <a class="code" href="../../df/d0a/io_8c.html#ad2a2e6c114780c3071efd24f16c7f7d8">SEEK_END</a>:
<a name="l04557"></a>04557         <span class="keywordflow">if</span> ((pos = _filelengthi64(<a class="code" href="../../da/d50/vsnprintf_8c.html#a7aa82a32f4ad97a0107302dae80a2b1e">fileno</a>(stream))) == (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1)
<a name="l04558"></a>04558             <span class="keywordflow">return</span> -1;
<a name="l04559"></a>04559         pos += offset;
<a name="l04560"></a>04560         <span class="keywordflow">break</span>;
<a name="l04561"></a>04561       <span class="keywordflow">default</span>:
<a name="l04562"></a>04562         pos = offset;
<a name="l04563"></a>04563         <span class="keywordflow">break</span>;
<a name="l04564"></a>04564     }
<a name="l04565"></a>04565     <span class="keywordflow">return</span> fsetpos(stream, (fpos_t *)&amp;pos);
<a name="l04566"></a>04566 }
<a name="l04567"></a>04567 
<a name="l04568"></a>04568 <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>
<a name="l04569"></a><a class="code" href="../../d5/df2/win32_8c.html#af0c2f6dc1b3fecde2bce418f07e14ac3">04569</a> <a class="code" href="../../dc/db1/win32_8h.html#af0c2f6dc1b3fecde2bce418f07e14ac3">rb_w32_ftello</a>(<a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *stream)
<a name="l04570"></a>04570 {
<a name="l04571"></a>04571     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> pos;
<a name="l04572"></a>04572     <span class="keywordflow">if</span> (fgetpos(stream, (fpos_t *)&amp;pos)) <span class="keywordflow">return</span> (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1;
<a name="l04573"></a>04573     <span class="keywordflow">return</span> pos;
<a name="l04574"></a>04574 }
<a name="l04575"></a>04575 
<a name="l04576"></a>04576 <span class="keyword">static</span> <span class="keywordtype">long</span>
<a name="l04577"></a><a class="code" href="../../d5/df2/win32_8c.html#aa86b7f090873eecc33467907d53229ba">04577</a> <a class="code" href="../../d5/df2/win32_8c.html#aa86b7f090873eecc33467907d53229ba">filetime_to_clock</a>(FILETIME *ft)
<a name="l04578"></a>04578 {
<a name="l04579"></a>04579     __int64 qw = ft-&gt;dwHighDateTime;
<a name="l04580"></a>04580     qw &lt;&lt;= 32;
<a name="l04581"></a>04581     qw |= ft-&gt;dwLowDateTime;
<a name="l04582"></a>04582     qw /= 10000;  <span class="comment">/* File time ticks at 0.1uS, clock at 1mS */</span>
<a name="l04583"></a>04583     <span class="keywordflow">return</span> (<span class="keywordtype">long</span>) qw;
<a name="l04584"></a>04584 }
<a name="l04585"></a>04585 
<a name="l04586"></a>04586 <span class="keywordtype">int</span>
<a name="l04587"></a><a class="code" href="../../d5/df2/win32_8c.html#a13eaa89e0125f3cc02f0ababdbf299b5">04587</a> <a class="code" href="../../dc/db1/win32_8h.html#ad76b743e948c3e5b761a1afd507d683c">rb_w32_times</a>(<span class="keyword">struct</span> <a class="code" href="../../d8/d15/structtms.html">tms</a> *tmbuf)
<a name="l04588"></a>04588 {
<a name="l04589"></a>04589     FILETIME create, exit, kernel, user;
<a name="l04590"></a>04590 
<a name="l04591"></a>04591     <span class="keywordflow">if</span> (GetProcessTimes(GetCurrentProcess(),&amp;create, &amp;exit, &amp;kernel, &amp;user)) {
<a name="l04592"></a>04592         tmbuf-&gt;<a class="code" href="../../d8/d15/structtms.html#ad8ae5a90f521f9e4083dbf6425d65527">tms_utime</a> = <a class="code" href="../../d5/df2/win32_8c.html#aa86b7f090873eecc33467907d53229ba">filetime_to_clock</a>(&amp;user);
<a name="l04593"></a>04593         tmbuf-&gt;<a class="code" href="../../d8/d15/structtms.html#a5b7db9be4a3c65f4454cb67355ab0829">tms_stime</a> = <a class="code" href="../../d5/df2/win32_8c.html#aa86b7f090873eecc33467907d53229ba">filetime_to_clock</a>(&amp;kernel);
<a name="l04594"></a>04594         tmbuf-&gt;<a class="code" href="../../d8/d15/structtms.html#a685e684365dd2cc86fc03f57361d4147">tms_cutime</a> = 0;
<a name="l04595"></a>04595         tmbuf-&gt;<a class="code" href="../../d8/d15/structtms.html#ae3b3d7b3dfbd068da1fce9afea9c406c">tms_cstime</a> = 0;
<a name="l04596"></a>04596     }
<a name="l04597"></a>04597     <span class="keywordflow">else</span> {
<a name="l04598"></a>04598         tmbuf-&gt;<a class="code" href="../../d8/d15/structtms.html#ad8ae5a90f521f9e4083dbf6425d65527">tms_utime</a> = clock();
<a name="l04599"></a>04599         tmbuf-&gt;<a class="code" href="../../d8/d15/structtms.html#a5b7db9be4a3c65f4454cb67355ab0829">tms_stime</a> = 0;
<a name="l04600"></a>04600         tmbuf-&gt;<a class="code" href="../../d8/d15/structtms.html#a685e684365dd2cc86fc03f57361d4147">tms_cutime</a> = 0;
<a name="l04601"></a>04601         tmbuf-&gt;<a class="code" href="../../d8/d15/structtms.html#ae3b3d7b3dfbd068da1fce9afea9c406c">tms_cstime</a> = 0;
<a name="l04602"></a>04602     }
<a name="l04603"></a>04603     <span class="keywordflow">return</span> 0;
<a name="l04604"></a>04604 }
<a name="l04605"></a>04605 
<a name="l04606"></a><a class="code" href="../../d5/df2/win32_8c.html#a9fb31310ef953db0b184e336b585f269">04606</a> <span class="preprocessor">#define yield_once() Sleep(0)</span>
<a name="l04607"></a><a class="code" href="../../d5/df2/win32_8c.html#a71ab67c039228751b373cb85ee291f84">04607</a> <span class="preprocessor"></span><span class="preprocessor">#define yield_until(condition) do yield_once(); while (!(condition))</span>
<a name="l04608"></a>04608 <span class="preprocessor"></span>
<a name="l04609"></a>04609 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l04610"></a><a class="code" href="../../d5/df2/win32_8c.html#af9a032dab8bca5a88dc6e5b985797211">04610</a> <a class="code" href="../../d5/df2/win32_8c.html#af9a032dab8bca5a88dc6e5b985797211">catch_interrupt</a>(<span class="keywordtype">void</span>)
<a name="l04611"></a>04611 {
<a name="l04612"></a>04612     <a class="code" href="../../d5/df2/win32_8c.html#a9fb31310ef953db0b184e336b585f269">yield_once</a>();
<a name="l04613"></a>04613     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>(<a class="code" href="../../dd/d55/thread__win32_8c.html#afbceca1751aaf315d88fd569003dcf5c">rb_w32_wait_events</a>(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, 0));
<a name="l04614"></a>04614 }
<a name="l04615"></a>04615 
<a name="l04616"></a>04616 <span class="preprocessor">#if defined __BORLANDC__</span>
<a name="l04617"></a>04617 <span class="preprocessor"></span><span class="preprocessor">#undef read</span>
<a name="l04618"></a>04618 <span class="preprocessor"></span><span class="keywordtype">int</span>
<a name="l04619"></a>04619 read(<span class="keywordtype">int</span> fd, <span class="keywordtype">void</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l04620"></a>04620 {
<a name="l04621"></a>04621     <span class="keywordtype">int</span> ret = _read(fd, buf, size);
<a name="l04622"></a>04622     <span class="keywordflow">if</span> ((ret &lt; 0) &amp;&amp; (errno == EPIPE)) {
<a name="l04623"></a>04623         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0;
<a name="l04624"></a>04624         ret = 0;
<a name="l04625"></a>04625     }
<a name="l04626"></a>04626     <a class="code" href="../../d5/df2/win32_8c.html#af9a032dab8bca5a88dc6e5b985797211">catch_interrupt</a>();
<a name="l04627"></a>04627     <span class="keywordflow">return</span> ret;
<a name="l04628"></a>04628 }
<a name="l04629"></a>04629 <span class="preprocessor">#endif</span>
<a name="l04630"></a>04630 <span class="preprocessor"></span>
<a name="l04631"></a>04631 <span class="preprocessor">#undef fgetc</span>
<a name="l04632"></a>04632 <span class="preprocessor"></span><span class="keywordtype">int</span>
<a name="l04633"></a><a class="code" href="../../d5/df2/win32_8c.html#a719ff1062454c45bb9c524e3619d5bda">04633</a> <a class="code" href="../../dc/db1/win32_8h.html#a82f8c07c64039e3ecf3b8d4c4f584975">rb_w32_getc</a>(<a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a>* stream)
<a name="l04634"></a>04634 {
<a name="l04635"></a>04635     <span class="keywordtype">int</span> c;
<a name="l04636"></a>04636     <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#ae721143a229a1f7815aaecddce571d5f">enough_to_get</a>(stream-&gt;FILE_COUNT)) {
<a name="l04637"></a>04637         c = (<span class="keywordtype">unsigned</span> char)*stream-&gt;FILE_READPTR++;
<a name="l04638"></a>04638     }
<a name="l04639"></a>04639     <span class="keywordflow">else</span> {
<a name="l04640"></a>04640         c = _filbuf(stream);
<a name="l04641"></a>04641 <span class="preprocessor">#if defined __BORLANDC__</span>
<a name="l04642"></a>04642 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((c == <a class="code" href="../../da/d50/vsnprintf_8c.html#a59adc4c82490d23754cd39c2fb99b0da">EOF</a>) &amp;&amp; (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EPIPE)) {
<a name="l04643"></a>04643             <a class="code" href="../../da/d50/vsnprintf_8c.html#a051c0f9053d3c767ebaa3bedee5521f9">clearerr</a>(stream);
<a name="l04644"></a>04644         }
<a name="l04645"></a>04645 <span class="preprocessor">#endif</span>
<a name="l04646"></a>04646 <span class="preprocessor"></span>        <a class="code" href="../../d5/df2/win32_8c.html#af9a032dab8bca5a88dc6e5b985797211">catch_interrupt</a>();
<a name="l04647"></a>04647     }
<a name="l04648"></a>04648     <span class="keywordflow">return</span> c;
<a name="l04649"></a>04649 }
<a name="l04650"></a>04650 
<a name="l04651"></a>04651 <span class="preprocessor">#undef fputc</span>
<a name="l04652"></a>04652 <span class="preprocessor"></span><span class="keywordtype">int</span>
<a name="l04653"></a><a class="code" href="../../d5/df2/win32_8c.html#a70646f2c38638e79e086016365a1c457">04653</a> <a class="code" href="../../dc/db1/win32_8h.html#a73ba0c3bc0f7bcd7043c74107d7aec4a">rb_w32_putc</a>(<span class="keywordtype">int</span> c, <a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a>* stream)
<a name="l04654"></a>04654 {
<a name="l04655"></a>04655     <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#ae8541ee81feb0e88b3db0d3f62603d96">enough_to_put</a>(stream-&gt;FILE_COUNT)) {
<a name="l04656"></a>04656         c = (<span class="keywordtype">unsigned</span> char)(*stream-&gt;FILE_READPTR++ = (<span class="keywordtype">char</span>)c);
<a name="l04657"></a>04657     }
<a name="l04658"></a>04658     <span class="keywordflow">else</span> {
<a name="l04659"></a>04659         c = _flsbuf(c, stream);
<a name="l04660"></a>04660         <a class="code" href="../../d5/df2/win32_8c.html#af9a032dab8bca5a88dc6e5b985797211">catch_interrupt</a>();
<a name="l04661"></a>04661     }
<a name="l04662"></a>04662     <span class="keywordflow">return</span> c;
<a name="l04663"></a>04663 }
<a name="l04664"></a>04664 
<a name="l04665"></a><a class="code" href="../../d3/dfc/structasynchronous__arg__t.html">04665</a> <span class="keyword">struct </span><a class="code" href="../../d3/dfc/structasynchronous__arg__t.html">asynchronous_arg_t</a> {
<a name="l04666"></a>04666     <span class="comment">/* output field */</span>
<a name="l04667"></a><a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#ae6feaae2ba2a6653a45d0cae90aec567">04667</a>     <span class="keywordtype">void</span>* <a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#ae6feaae2ba2a6653a45d0cae90aec567">stackaddr</a>;
<a name="l04668"></a><a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#ab42b3d821123392cc393751769266c8f">04668</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#ab42b3d821123392cc393751769266c8f">errnum</a>;
<a name="l04669"></a>04669 
<a name="l04670"></a>04670     <span class="comment">/* input field */</span>
<a name="l04671"></a>04671     <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a> (*<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#aa35a49b3713d2be825a598b6a1b36a9e">func</a>)(<a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a> <span class="keyword">self</span>, <span class="keywordtype">int</span> argc, <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a>* argv);
<a name="l04672"></a><a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#ae7bf1b7e7eaa5ae19662cb27c37b253c">04672</a>     <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a> <span class="keyword">self</span>;
<a name="l04673"></a><a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#a8150e238a61b0b69e93c0e5d7a314c01">04673</a>     <span class="keywordtype">int</span> argc;
<a name="l04674"></a><a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#a3b9b0e6dca6c44d4d8efc6664b51ec13">04674</a>     <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a>* argv;
<a name="l04675"></a>04675 };
<a name="l04676"></a>04676 
<a name="l04677"></a>04677 <span class="keyword">static</span> <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> WINAPI
<a name="l04678"></a><a class="code" href="../../d5/df2/win32_8c.html#a7d1a703f2c1ed5260bff169c451335e8">04678</a> <a class="code" href="../../d5/df2/win32_8c.html#a7d1a703f2c1ed5260bff169c451335e8">call_asynchronous</a>(PVOID argp)
<a name="l04679"></a>04679 {
<a name="l04680"></a>04680     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> ret;
<a name="l04681"></a>04681     <span class="keyword">struct </span><a class="code" href="../../d3/dfc/structasynchronous__arg__t.html">asynchronous_arg_t</a> *arg = argp;
<a name="l04682"></a>04682     arg-&gt;<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#ae6feaae2ba2a6653a45d0cae90aec567">stackaddr</a> = &amp;argp;
<a name="l04683"></a>04683     ret = (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)arg-&gt;<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#aa35a49b3713d2be825a598b6a1b36a9e">func</a>(arg-&gt;<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#ae7bf1b7e7eaa5ae19662cb27c37b253c">self</a>, arg-&gt;<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#a8150e238a61b0b69e93c0e5d7a314c01">argc</a>, arg-&gt;<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#a3b9b0e6dca6c44d4d8efc6664b51ec13">argv</a>);
<a name="l04684"></a>04684     arg-&gt;<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#ab42b3d821123392cc393751769266c8f">errnum</a> = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l04685"></a>04685     <span class="keywordflow">return</span> ret;
<a name="l04686"></a>04686 }
<a name="l04687"></a>04687 
<a name="l04688"></a>04688 <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a>
<a name="l04689"></a><a class="code" href="../../d5/df2/win32_8c.html#af3f08931b6e3520982f288af6965f628">04689</a> <a class="code" href="../../dc/db1/win32_8h.html#af3f08931b6e3520982f288af6965f628">rb_w32_asynchronize</a>(<a class="code" href="../../dc/db1/win32_8h.html#a49db9c26252dd53abc594d9c721df236">asynchronous_func_t</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a>, <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a> <span class="keyword">self</span>,
<a name="l04690"></a>04690                     <span class="keywordtype">int</span> argc, <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a>* argv, <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a> intrval)
<a name="l04691"></a>04691 {
<a name="l04692"></a>04692     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> val;
<a name="l04693"></a>04693     BOOL interrupted = <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04694"></a>04694     HANDLE thr;
<a name="l04695"></a>04695 
<a name="l04696"></a>04696     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l04697"></a>04697         <span class="keyword">struct </span><a class="code" href="../../d3/dfc/structasynchronous__arg__t.html">asynchronous_arg_t</a> arg;
<a name="l04698"></a>04698 
<a name="l04699"></a>04699         arg.<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#ae6feaae2ba2a6653a45d0cae90aec567">stackaddr</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04700"></a>04700         arg.<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#ab42b3d821123392cc393751769266c8f">errnum</a> = 0;
<a name="l04701"></a>04701         arg.<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#aa35a49b3713d2be825a598b6a1b36a9e">func</a> = func;
<a name="l04702"></a>04702         arg.<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#ae7bf1b7e7eaa5ae19662cb27c37b253c">self</a> = <span class="keyword">self</span>;
<a name="l04703"></a>04703         arg.<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#a8150e238a61b0b69e93c0e5d7a314c01">argc</a> = argc;
<a name="l04704"></a>04704         arg.<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#a3b9b0e6dca6c44d4d8efc6664b51ec13">argv</a> = argv;
<a name="l04705"></a>04705 
<a name="l04706"></a>04706         thr = CreateThread(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, <a class="code" href="../../d5/df2/win32_8c.html#a7d1a703f2c1ed5260bff169c451335e8">call_asynchronous</a>, &amp;arg, 0, &amp;val);
<a name="l04707"></a>04707 
<a name="l04708"></a>04708         <span class="keywordflow">if</span> (thr) {
<a name="l04709"></a>04709             <a class="code" href="../../d5/df2/win32_8c.html#a71ab67c039228751b373cb85ee291f84">yield_until</a>(arg.<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#ae6feaae2ba2a6653a45d0cae90aec567">stackaddr</a>);
<a name="l04710"></a>04710 
<a name="l04711"></a>04711             <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#a2da86cc53904a673b2b18547d63700f6">rb_w32_wait_events_blocking</a>(&amp;thr, 1, INFINITE) != WAIT_OBJECT_0) {
<a name="l04712"></a>04712                 interrupted = <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04713"></a>04713 
<a name="l04714"></a>04714                 <span class="keywordflow">if</span> (TerminateThread(thr, intrval)) {
<a name="l04715"></a>04715                     <a class="code" href="../../d5/df2/win32_8c.html#a9fb31310ef953db0b184e336b585f269">yield_once</a>();
<a name="l04716"></a>04716                 }
<a name="l04717"></a>04717             }
<a name="l04718"></a>04718 
<a name="l04719"></a>04719             GetExitCodeThread(thr, &amp;val);
<a name="l04720"></a>04720             CloseHandle(thr);
<a name="l04721"></a>04721 
<a name="l04722"></a>04722             <span class="keywordflow">if</span> (interrupted) {
<a name="l04723"></a>04723                 <span class="comment">/* must release stack of killed thread, why doesn&apos;t Windows? */</span>
<a name="l04724"></a>04724                 MEMORY_BASIC_INFORMATION m;
<a name="l04725"></a>04725 
<a name="l04726"></a>04726                 memset(&amp;m, 0, <span class="keyword">sizeof</span>(m));
<a name="l04727"></a>04727                 <span class="keywordflow">if</span> (!VirtualQuery(arg.<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#ae6feaae2ba2a6653a45d0cae90aec567">stackaddr</a>, &amp;m, <span class="keyword">sizeof</span>(m))) {
<a name="l04728"></a>04728                     <a class="code" href="../../d5/df2/win32_8c.html#a816d96355638b764185f20ce851407b0">Debug</a>(fprintf(stderr, <span class="stringliteral">&quot;couldn&apos;t get stack base:%p:%d\n&quot;</span>,
<a name="l04729"></a>04729                                   arg.<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#ae6feaae2ba2a6653a45d0cae90aec567">stackaddr</a>, GetLastError()));
<a name="l04730"></a>04730                 }
<a name="l04731"></a>04731                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!VirtualFree(m.AllocationBase, 0, MEM_RELEASE)) {
<a name="l04732"></a>04732                     <a class="code" href="../../d5/df2/win32_8c.html#a816d96355638b764185f20ce851407b0">Debug</a>(fprintf(stderr, <span class="stringliteral">&quot;couldn&apos;t release stack:%p:%d\n&quot;</span>,
<a name="l04733"></a>04733                                   m.AllocationBase, GetLastError()));
<a name="l04734"></a>04734                 }
<a name="l04735"></a>04735                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINTR;
<a name="l04736"></a>04736             }
<a name="l04737"></a>04737             <span class="keywordflow">else</span> {
<a name="l04738"></a>04738                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = arg.<a class="code" href="../../d3/dfc/structasynchronous__arg__t.html#ab42b3d821123392cc393751769266c8f">errnum</a>;
<a name="l04739"></a>04739             }
<a name="l04740"></a>04740         }
<a name="l04741"></a>04741     });
<a name="l04742"></a>04742 
<a name="l04743"></a>04743     <span class="keywordflow">if</span> (!thr) {
<a name="l04744"></a>04744         <a class="code" href="../../db/dcc/error_8c.html#a643ceabe39fa1f8c99066a321397a115">rb_fatal</a>(<span class="stringliteral">&quot;failed to launch waiter thread:%ld&quot;</span>, GetLastError());
<a name="l04745"></a>04745     }
<a name="l04746"></a>04746 
<a name="l04747"></a>04747     <span class="keywordflow">return</span> val;
<a name="l04748"></a>04748 }
<a name="l04749"></a>04749 
<a name="l04750"></a>04750 <span class="keywordtype">char</span> **
<a name="l04751"></a><a class="code" href="../../d5/df2/win32_8c.html#aedf011f736007a12cb42536cb4ae376f">04751</a> <a class="code" href="../../dc/db1/win32_8h.html#aedf011f736007a12cb42536cb4ae376f">rb_w32_get_environ</a>(<span class="keywordtype">void</span>)
<a name="l04752"></a>04752 {
<a name="l04753"></a>04753     <span class="keywordtype">char</span> *envtop, *<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>;
<a name="l04754"></a>04754     <span class="keywordtype">char</span> **myenvtop, **myenv;
<a name="l04755"></a>04755     <span class="keywordtype">int</span> num;
<a name="l04756"></a>04756 
<a name="l04757"></a>04757     <span class="comment">/*</span>
<a name="l04758"></a>04758 <span class="comment">     * We avoid values started with `=&apos;. If you want to deal those values,</span>
<a name="l04759"></a>04759 <span class="comment">     * change this function, and some functions in hash.c which recognize</span>
<a name="l04760"></a>04760 <span class="comment">     * `=&apos; as delimiter or rb_w32_getenv() and ruby_setenv().</span>
<a name="l04761"></a>04761 <span class="comment">     * CygWin deals these values by changing first `=&apos; to &apos;!&apos;. But we don&apos;t</span>
<a name="l04762"></a>04762 <span class="comment">     * use such trick and follow cmd.exe&apos;s way that just doesn&apos;t show these</span>
<a name="l04763"></a>04763 <span class="comment">     * values.</span>
<a name="l04764"></a>04764 <span class="comment">     * (U.N. 2001-11-15)</span>
<a name="l04765"></a>04765 <span class="comment">     */</span>
<a name="l04766"></a>04766     envtop = GetEnvironmentStrings();
<a name="l04767"></a>04767     <span class="keywordflow">for</span> (env = envtop, num = 0; *env; env += <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(env) + 1)
<a name="l04768"></a>04768         <span class="keywordflow">if</span> (*env != <span class="charliteral">&apos;=&apos;</span>) num++;
<a name="l04769"></a>04769 
<a name="l04770"></a>04770     myenvtop = (<span class="keywordtype">char</span> **)<a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *) * (num + 1));
<a name="l04771"></a>04771     <span class="keywordflow">for</span> (env = envtop, myenv = myenvtop; *env; env += <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(env) + 1) {
<a name="l04772"></a>04772         <span class="keywordflow">if</span> (*env != <span class="charliteral">&apos;=&apos;</span>) {
<a name="l04773"></a>04773             <span class="keywordflow">if</span> (!(*myenv = <a class="code" href="../../d8/d3c/util_8h.html#ad832104a69551cf1e4e347fffa9dc77c">strdup</a>(env))) {
<a name="l04774"></a>04774                 <span class="keywordflow">break</span>;
<a name="l04775"></a>04775             }
<a name="l04776"></a>04776             myenv++;
<a name="l04777"></a>04777         }
<a name="l04778"></a>04778     }
<a name="l04779"></a>04779     *myenv = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04780"></a>04780     FreeEnvironmentStrings(envtop);
<a name="l04781"></a>04781 
<a name="l04782"></a>04782     <span class="keywordflow">return</span> myenvtop;
<a name="l04783"></a>04783 }
<a name="l04784"></a>04784 
<a name="l04785"></a>04785 <span class="keywordtype">void</span>
<a name="l04786"></a><a class="code" href="../../d5/df2/win32_8c.html#a6f3b8c08ccb8f57255993ba8298abbd0">04786</a> <a class="code" href="../../dc/db1/win32_8h.html#a1980ed6d93d0d05322bf44c5da29d738">rb_w32_free_environ</a>(<span class="keywordtype">char</span> **env)
<a name="l04787"></a>04787 {
<a name="l04788"></a>04788     <span class="keywordtype">char</span> **t = env;
<a name="l04789"></a>04789 
<a name="l04790"></a>04790     <span class="keywordflow">while</span> (*t) <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(*t++);
<a name="l04791"></a>04791     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(env);
<a name="l04792"></a>04792 }
<a name="l04793"></a>04793 
<a name="l04794"></a>04794 rb_pid_t
<a name="l04795"></a><a class="code" href="../../d5/df2/win32_8c.html#a9a677fe7b1042899e0dd677732ef4dcd">04795</a> <a class="code" href="../../dc/db1/win32_8h.html#a9a677fe7b1042899e0dd677732ef4dcd">rb_w32_getpid</a>(<span class="keywordtype">void</span>)
<a name="l04796"></a>04796 {
<a name="l04797"></a>04797     rb_pid_t pid;
<a name="l04798"></a>04798 
<a name="l04799"></a>04799     pid = GetCurrentProcessId();
<a name="l04800"></a>04800 
<a name="l04801"></a>04801     (void)<a class="code" href="../../d5/df2/win32_8c.html#a7f3fd3449912cfee8acada6b9307b385">IfWin95</a>(pid = -pid, 0);
<a name="l04802"></a>04802 
<a name="l04803"></a>04803     <span class="keywordflow">return</span> pid;
<a name="l04804"></a>04804 }
<a name="l04805"></a>04805 
<a name="l04806"></a>04806 
<a name="l04807"></a>04807 rb_pid_t
<a name="l04808"></a><a class="code" href="../../d5/df2/win32_8c.html#a8cc82cce92d22aafb29f7fd1bb34503b">04808</a> <a class="code" href="../../dc/db1/win32_8h.html#a8cc82cce92d22aafb29f7fd1bb34503b">rb_w32_getppid</a>(<span class="keywordtype">void</span>)
<a name="l04809"></a>04809 {
<a name="l04810"></a>04810     <span class="keyword">typedef</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a> (WINAPI query_func)(HANDLE, int, <span class="keywordtype">void</span> *, <a class="code" href="../../d2/d99/win32ole_8c.html#a516d92a41f815ad3c448380a9aa3e4d0">ULONG</a>, ULONG *);
<a name="l04811"></a>04811     <span class="keyword">static</span> query_func *pNtQueryInformationProcess = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04812"></a>04812     rb_pid_t ppid = 0;
<a name="l04813"></a>04813 
<a name="l04814"></a>04814     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/df2/win32_8c.html#a612e2ad1adbb621210494d51d634d40d">IsWin95</a>() &amp;&amp; <a class="code" href="../../dc/db1/win32_8h.html#affdb842014b69315ef8e742ad2ebe79e">rb_w32_osver</a>() &gt;= 5) {
<a name="l04815"></a>04815         <span class="keywordflow">if</span> (!pNtQueryInformationProcess)
<a name="l04816"></a>04816             pNtQueryInformationProcess = (query_func *)<a class="code" href="../../d5/df2/win32_8c.html#a8ab64e43a3bd89bcdebe1111534a0bfa">get_proc_address</a>(<span class="stringliteral">&quot;ntdll.dll&quot;</span>, <span class="stringliteral">&quot;NtQueryInformationProcess&quot;</span>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l04817"></a>04817         <span class="keywordflow">if</span> (pNtQueryInformationProcess) {
<a name="l04818"></a>04818             <span class="keyword">struct </span>{
<a name="l04819"></a>04819                 <span class="keywordtype">long</span> ExitStatus;
<a name="l04820"></a>04820                 <span class="keywordtype">void</span>* PebBaseAddress;
<a name="l04821"></a>04821                 <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a> AffinityMask;
<a name="l04822"></a>04822                 <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a> BasePriority;
<a name="l04823"></a>04823                 <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a> UniqueProcessId;
<a name="l04824"></a>04824                 <a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a> ParentProcessId;
<a name="l04825"></a>04825             } pbi;
<a name="l04826"></a>04826             ULONG <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l04827"></a>04827             <span class="keywordtype">long</span> ret = pNtQueryInformationProcess(GetCurrentProcess(), 0, &amp;pbi, <span class="keyword">sizeof</span>(pbi), &amp;len);
<a name="l04828"></a>04828             <span class="keywordflow">if</span> (!ret) {
<a name="l04829"></a>04829                 ppid = pbi.ParentProcessId;
<a name="l04830"></a>04830             }
<a name="l04831"></a>04831         }
<a name="l04832"></a>04832     }
<a name="l04833"></a>04833 
<a name="l04834"></a>04834     <span class="keywordflow">return</span> ppid;
<a name="l04835"></a>04835 }
<a name="l04836"></a>04836 
<a name="l04837"></a>04837 <span class="keywordtype">int</span>
<a name="l04838"></a><a class="code" href="../../d5/df2/win32_8c.html#ac429fe8ff714db00ba667db54d2a3166">04838</a> <a class="code" href="../../dc/db1/win32_8h.html#ae2af5c2247f2a2d4d03a641748ff064d">rb_w32_uopen</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> oflag, ...)
<a name="l04839"></a>04839 {
<a name="l04840"></a>04840     WCHAR *wfile;
<a name="l04841"></a>04841     <span class="keywordtype">int</span> ret;
<a name="l04842"></a>04842     <span class="keywordtype">int</span> pmode;
<a name="l04843"></a>04843 
<a name="l04844"></a>04844     va_list arg;
<a name="l04845"></a>04845     va_start(arg, oflag);
<a name="l04846"></a>04846     pmode = va_arg(arg, <span class="keywordtype">int</span>);
<a name="l04847"></a>04847     va_end(arg);
<a name="l04848"></a>04848 
<a name="l04849"></a>04849     <span class="keywordflow">if</span> (!(wfile = <a class="code" href="../../d5/df2/win32_8c.html#a41003a1382888cc771e290746769eb13">utf8_to_wstr</a>(file, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l04850"></a>04850         <span class="keywordflow">return</span> -1;
<a name="l04851"></a>04851     ret = <a class="code" href="../../dc/db1/win32_8h.html#af768858b0bc7d6895bb337a565430698">rb_w32_wopen</a>(wfile, oflag, pmode);
<a name="l04852"></a>04852     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wfile);
<a name="l04853"></a>04853     <span class="keywordflow">return</span> ret;
<a name="l04854"></a>04854 }
<a name="l04855"></a>04855 
<a name="l04856"></a>04856 <span class="keywordtype">int</span>
<a name="l04857"></a><a class="code" href="../../d5/df2/win32_8c.html#ae5a8dde3535586991d26f5df286bdb45">04857</a> <a class="code" href="../../dc/db1/win32_8h.html#a77ece6bf33136a6f6922eb78ac7fe4bf">rb_w32_open</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> oflag, ...)
<a name="l04858"></a>04858 {
<a name="l04859"></a>04859     WCHAR *wfile;
<a name="l04860"></a>04860     <span class="keywordtype">int</span> ret;
<a name="l04861"></a>04861     <span class="keywordtype">int</span> pmode;
<a name="l04862"></a>04862 
<a name="l04863"></a>04863     va_list arg;
<a name="l04864"></a>04864     va_start(arg, oflag);
<a name="l04865"></a>04865     pmode = va_arg(arg, <span class="keywordtype">int</span>);
<a name="l04866"></a>04866     va_end(arg);
<a name="l04867"></a>04867 
<a name="l04868"></a>04868     <span class="keywordflow">if</span> ((oflag &amp; O_TEXT) || !(oflag &amp; <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>))
<a name="l04869"></a>04869         <span class="keywordflow">return</span> _open(file, oflag, pmode);
<a name="l04870"></a>04870 
<a name="l04871"></a>04871     <span class="keywordflow">if</span> (!(wfile = <a class="code" href="../../d5/df2/win32_8c.html#ad33d311f649154599e920240e3900a59">filecp_to_wstr</a>(file, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l04872"></a>04872         <span class="keywordflow">return</span> -1;
<a name="l04873"></a>04873     ret = <a class="code" href="../../dc/db1/win32_8h.html#af768858b0bc7d6895bb337a565430698">rb_w32_wopen</a>(wfile, oflag, pmode);
<a name="l04874"></a>04874     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wfile);
<a name="l04875"></a>04875     <span class="keywordflow">return</span> ret;
<a name="l04876"></a>04876 }
<a name="l04877"></a>04877 
<a name="l04878"></a>04878 <span class="keywordtype">int</span>
<a name="l04879"></a><a class="code" href="../../d5/df2/win32_8c.html#a41f98e1c42e53a2104fa3d474ce72d09">04879</a> <a class="code" href="../../dc/db1/win32_8h.html#af768858b0bc7d6895bb337a565430698">rb_w32_wopen</a>(<span class="keyword">const</span> WCHAR *file, <span class="keywordtype">int</span> oflag, ...)
<a name="l04880"></a>04880 {
<a name="l04881"></a>04881     <span class="keywordtype">char</span> flags = 0;
<a name="l04882"></a>04882     <span class="keywordtype">int</span> fd;
<a name="l04883"></a>04883     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../dc/db1/win32_8h.html#aa8812b8cc4378b0ec4f8281ba22a17e0">access</a>;
<a name="l04884"></a>04884     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> create;
<a name="l04885"></a>04885     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> attr = FILE_ATTRIBUTE_NORMAL;
<a name="l04886"></a>04886     SECURITY_ATTRIBUTES sec;
<a name="l04887"></a>04887     HANDLE h;
<a name="l04888"></a>04888 
<a name="l04889"></a>04889     <span class="keywordflow">if</span> ((oflag &amp; O_TEXT) || !(oflag &amp; <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>)) {
<a name="l04890"></a>04890         va_list arg;
<a name="l04891"></a>04891         <span class="keywordtype">int</span> pmode;
<a name="l04892"></a>04892         va_start(arg, oflag);
<a name="l04893"></a>04893         pmode = va_arg(arg, <span class="keywordtype">int</span>);
<a name="l04894"></a>04894         va_end(arg);
<a name="l04895"></a>04895         <span class="keywordflow">return</span> _wopen(file, oflag, pmode);
<a name="l04896"></a>04896     }
<a name="l04897"></a>04897 
<a name="l04898"></a>04898     sec.nLength = <span class="keyword">sizeof</span>(sec);
<a name="l04899"></a>04899     sec.lpSecurityDescriptor = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04900"></a>04900     <span class="keywordflow">if</span> (oflag &amp; O_NOINHERIT) {
<a name="l04901"></a>04901         sec.bInheritHandle = <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l04902"></a>04902         flags |= <a class="code" href="../../d5/df2/win32_8c.html#a9275d22eeeb493620a559a000c210798">FNOINHERIT</a>;
<a name="l04903"></a>04903     }
<a name="l04904"></a>04904     <span class="keywordflow">else</span> {
<a name="l04905"></a>04905         sec.bInheritHandle = <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l04906"></a>04906     }
<a name="l04907"></a>04907     oflag &amp;= ~O_NOINHERIT;
<a name="l04908"></a>04908 
<a name="l04909"></a>04909     <span class="comment">/* always open with binary mode */</span>
<a name="l04910"></a>04910     oflag &amp;= ~(O_BINARY | O_TEXT);
<a name="l04911"></a>04911 
<a name="l04912"></a>04912     <span class="keywordflow">switch</span> (oflag &amp; (O_RDWR | O_RDONLY | O_WRONLY)) {
<a name="l04913"></a>04913       <span class="keywordflow">case</span> O_RDWR:
<a name="l04914"></a>04914         access = GENERIC_READ | GENERIC_WRITE;
<a name="l04915"></a>04915         <span class="keywordflow">break</span>;
<a name="l04916"></a>04916       <span class="keywordflow">case</span> O_RDONLY:
<a name="l04917"></a>04917         access = GENERIC_READ;
<a name="l04918"></a>04918         <span class="keywordflow">break</span>;
<a name="l04919"></a>04919       <span class="keywordflow">case</span> O_WRONLY:
<a name="l04920"></a>04920         access = GENERIC_WRITE;
<a name="l04921"></a>04921         <span class="keywordflow">break</span>;
<a name="l04922"></a>04922       <span class="keywordflow">default</span>:
<a name="l04923"></a>04923         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l04924"></a>04924         <span class="keywordflow">return</span> -1;
<a name="l04925"></a>04925     }
<a name="l04926"></a>04926     oflag &amp;= ~(O_RDWR | O_RDONLY | O_WRONLY);
<a name="l04927"></a>04927 
<a name="l04928"></a>04928     <span class="keywordflow">switch</span> (oflag &amp; (O_CREAT | O_EXCL | O_TRUNC)) {
<a name="l04929"></a>04929       <span class="keywordflow">case</span> O_CREAT:
<a name="l04930"></a>04930         create = OPEN_ALWAYS;
<a name="l04931"></a>04931         <span class="keywordflow">break</span>;
<a name="l04932"></a>04932       <span class="keywordflow">case</span> 0:
<a name="l04933"></a>04933       <span class="keywordflow">case</span> O_EXCL:
<a name="l04934"></a>04934         create = OPEN_EXISTING;
<a name="l04935"></a>04935         <span class="keywordflow">break</span>;
<a name="l04936"></a>04936       <span class="keywordflow">case</span> O_CREAT | O_EXCL:
<a name="l04937"></a>04937       <span class="keywordflow">case</span> O_CREAT | O_EXCL | O_TRUNC:
<a name="l04938"></a>04938         create = CREATE_NEW;
<a name="l04939"></a>04939         <span class="keywordflow">break</span>;
<a name="l04940"></a>04940       <span class="keywordflow">case</span> O_TRUNC:
<a name="l04941"></a>04941       <span class="keywordflow">case</span> O_TRUNC | O_EXCL:
<a name="l04942"></a>04942         create = TRUNCATE_EXISTING;
<a name="l04943"></a>04943         <span class="keywordflow">break</span>;
<a name="l04944"></a>04944       <span class="keywordflow">case</span> O_CREAT | O_TRUNC:
<a name="l04945"></a>04945         create = CREATE_ALWAYS;
<a name="l04946"></a>04946         <span class="keywordflow">break</span>;
<a name="l04947"></a>04947       <span class="keywordflow">default</span>:
<a name="l04948"></a>04948         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l04949"></a>04949         <span class="keywordflow">return</span> -1;
<a name="l04950"></a>04950     }
<a name="l04951"></a>04951     <span class="keywordflow">if</span> (oflag &amp; O_CREAT) {
<a name="l04952"></a>04952         va_list arg;
<a name="l04953"></a>04953         <span class="keywordtype">int</span> pmode;
<a name="l04954"></a>04954         va_start(arg, oflag);
<a name="l04955"></a>04955         pmode = va_arg(arg, <span class="keywordtype">int</span>);
<a name="l04956"></a>04956         va_end(arg);
<a name="l04957"></a>04957         <span class="comment">/* TODO: we need to check umask here, but it&apos;s not exported... */</span>
<a name="l04958"></a>04958         <span class="keywordflow">if</span> (!(pmode &amp; S_IWRITE))
<a name="l04959"></a>04959             attr = FILE_ATTRIBUTE_READONLY;
<a name="l04960"></a>04960     }
<a name="l04961"></a>04961     oflag &amp;= ~(O_CREAT | O_EXCL | O_TRUNC);
<a name="l04962"></a>04962 
<a name="l04963"></a>04963     <span class="keywordflow">if</span> (oflag &amp; O_TEMPORARY) {
<a name="l04964"></a>04964         attr |= FILE_FLAG_DELETE_ON_CLOSE;
<a name="l04965"></a>04965         access |= DELETE;
<a name="l04966"></a>04966     }
<a name="l04967"></a>04967     oflag &amp;= ~O_TEMPORARY;
<a name="l04968"></a>04968 
<a name="l04969"></a>04969     <span class="keywordflow">if</span> (oflag &amp; _O_SHORT_LIVED)
<a name="l04970"></a>04970         attr |= FILE_ATTRIBUTE_TEMPORARY;
<a name="l04971"></a>04971     oflag &amp;= ~_O_SHORT_LIVED;
<a name="l04972"></a>04972 
<a name="l04973"></a>04973     <span class="keywordflow">switch</span> (oflag &amp; (O_SEQUENTIAL | O_RANDOM)) {
<a name="l04974"></a>04974       <span class="keywordflow">case</span> 0:
<a name="l04975"></a>04975         <span class="keywordflow">break</span>;
<a name="l04976"></a>04976       <span class="keywordflow">case</span> O_SEQUENTIAL:
<a name="l04977"></a>04977         attr |= FILE_FLAG_SEQUENTIAL_SCAN;
<a name="l04978"></a>04978         <span class="keywordflow">break</span>;
<a name="l04979"></a>04979       <span class="keywordflow">case</span> O_RANDOM:
<a name="l04980"></a>04980         attr |= FILE_FLAG_RANDOM_ACCESS;
<a name="l04981"></a>04981         <span class="keywordflow">break</span>;
<a name="l04982"></a>04982       <span class="keywordflow">default</span>:
<a name="l04983"></a>04983         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l04984"></a>04984         <span class="keywordflow">return</span> -1;
<a name="l04985"></a>04985     }
<a name="l04986"></a>04986     oflag &amp;= ~(O_SEQUENTIAL | O_RANDOM);
<a name="l04987"></a>04987 
<a name="l04988"></a>04988     <span class="keywordflow">if</span> (oflag &amp; ~O_APPEND) {
<a name="l04989"></a>04989         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l04990"></a>04990         <span class="keywordflow">return</span> -1;
<a name="l04991"></a>04991     }
<a name="l04992"></a>04992 
<a name="l04993"></a>04993     <span class="comment">/* allocate a C Runtime file handle */</span>
<a name="l04994"></a>04994     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l04995"></a>04995         h = CreateFile(<span class="stringliteral">&quot;NUL&quot;</span>, 0, 0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, OPEN_ALWAYS, 0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l04996"></a>04996         fd = _open_osfhandle((<a class="code" href="../../dc/db1/win32_8h.html#a0fbe4a4f8dd857ee04923a901f27465f">intptr_t</a>)h, 0);
<a name="l04997"></a>04997         CloseHandle(h);
<a name="l04998"></a>04998     });
<a name="l04999"></a>04999     <span class="keywordflow">if</span> (fd == -1) {
<a name="l05000"></a>05000         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EMFILE;
<a name="l05001"></a>05001         <span class="keywordflow">return</span> -1;
<a name="l05002"></a>05002     }
<a name="l05003"></a>05003     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l05004"></a>05004         <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(EnterCriticalSection(&amp;(<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock)));
<a name="l05005"></a>05005         <a class="code" href="../../d5/df2/win32_8c.html#ac603bb260657b14e80a08ea0a4f7d72e">_set_osfhnd</a>(fd, (<a class="code" href="../../dc/db1/win32_8h.html#a0fbe4a4f8dd857ee04923a901f27465f">intptr_t</a>)INVALID_HANDLE_VALUE);
<a name="l05006"></a>05006         <a class="code" href="../../d5/df2/win32_8c.html#a3c63b8defb8d22dccc0c068b3ba6f529">_set_osflags</a>(fd, 0);
<a name="l05007"></a>05007 
<a name="l05008"></a>05008         h = CreateFileW(file, access, FILE_SHARE_READ | FILE_SHARE_WRITE, &amp;sec,
<a name="l05009"></a>05009                         create, attr, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05010"></a>05010         <span class="keywordflow">if</span> (h == INVALID_HANDLE_VALUE) {
<a name="l05011"></a>05011             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l05012"></a>05012             <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05013"></a>05013             fd = -1;
<a name="l05014"></a>05014             <span class="keywordflow">goto</span> quit;
<a name="l05015"></a>05015         }
<a name="l05016"></a>05016 
<a name="l05017"></a>05017         <span class="keywordflow">switch</span> (GetFileType(h)) {
<a name="l05018"></a>05018           <span class="keywordflow">case</span> FILE_TYPE_CHAR:
<a name="l05019"></a>05019             flags |= <a class="code" href="../../d5/df2/win32_8c.html#a9b8e31e24fbc8c8b6223c6130d90999b">FDEV</a>;
<a name="l05020"></a>05020             <span class="keywordflow">break</span>;
<a name="l05021"></a>05021           <span class="keywordflow">case</span> FILE_TYPE_PIPE:
<a name="l05022"></a>05022             flags |= <a class="code" href="../../d5/df2/win32_8c.html#a645a937257c47fd9dd7d8ff239bfad0e">FPIPE</a>;
<a name="l05023"></a>05023             <span class="keywordflow">break</span>;
<a name="l05024"></a>05024           <span class="keywordflow">case</span> FILE_TYPE_UNKNOWN:
<a name="l05025"></a>05025             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l05026"></a>05026             CloseHandle(h);
<a name="l05027"></a>05027             <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05028"></a>05028             fd = -1;
<a name="l05029"></a>05029             <span class="keywordflow">goto</span> quit;
<a name="l05030"></a>05030         }
<a name="l05031"></a>05031         <span class="keywordflow">if</span> (!(flags &amp; (<a class="code" href="../../d5/df2/win32_8c.html#a9b8e31e24fbc8c8b6223c6130d90999b">FDEV</a> | <a class="code" href="../../d5/df2/win32_8c.html#a645a937257c47fd9dd7d8ff239bfad0e">FPIPE</a>)) &amp;&amp; (oflag &amp; O_APPEND))
<a name="l05032"></a>05032             flags |= <a class="code" href="../../d5/df2/win32_8c.html#aa336842f710119bfdab086f34efac63c">FAPPEND</a>;
<a name="l05033"></a>05033 
<a name="l05034"></a>05034         <a class="code" href="../../d5/df2/win32_8c.html#ac603bb260657b14e80a08ea0a4f7d72e">_set_osfhnd</a>(fd, (<a class="code" href="../../dc/db1/win32_8h.html#a0fbe4a4f8dd857ee04923a901f27465f">intptr_t</a>)h);
<a name="l05035"></a>05035         <a class="code" href="../../d5/df2/win32_8c.html#a90ead473a170c01aed0fff5c736650f6">_osfile</a>(fd) = flags | <a class="code" href="../../d5/df2/win32_8c.html#a781db24a3e3e56cf3176b85e4c87bf14">FOPEN</a>;
<a name="l05036"></a>05036 
<a name="l05037"></a>05037         <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05038"></a>05038       quit:
<a name="l05039"></a>05039         ;
<a name="l05040"></a>05040     });
<a name="l05041"></a>05041 
<a name="l05042"></a>05042     <span class="keywordflow">return</span> fd;
<a name="l05043"></a>05043 }
<a name="l05044"></a>05044 
<a name="l05045"></a>05045 <span class="keywordtype">int</span>
<a name="l05046"></a><a class="code" href="../../d5/df2/win32_8c.html#abdb134eb8142736c333fe5bd1ee4204b">05046</a> <a class="code" href="../../dc/db1/win32_8h.html#a0c170622d3c0f469aad2a3c24e7a65d6">rb_w32_fclose</a>(<a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *fp)
<a name="l05047"></a>05047 {
<a name="l05048"></a>05048     <span class="keywordtype">int</span> fd = <a class="code" href="../../da/d50/vsnprintf_8c.html#a7aa82a32f4ad97a0107302dae80a2b1e">fileno</a>(fp);
<a name="l05049"></a>05049     SOCKET sock = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(fd);
<a name="l05050"></a>05050     <span class="keywordtype">int</span> save_errno = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l05051"></a>05051 
<a name="l05052"></a>05052     <span class="keywordflow">if</span> (fflush(fp)) <span class="keywordflow">return</span> -1;
<a name="l05053"></a>05053     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a963dc023d760a24b0e23ce29bb583732">is_socket</a>(sock)) {
<a name="l05054"></a>05054         UnlockFile((HANDLE)sock, 0, 0, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>);
<a name="l05055"></a>05055         <span class="keywordflow">return</span> fclose(fp);
<a name="l05056"></a>05056     }
<a name="l05057"></a>05057     <a class="code" href="../../d5/df2/win32_8c.html#ac603bb260657b14e80a08ea0a4f7d72e">_set_osfhnd</a>(fd, (SOCKET)INVALID_HANDLE_VALUE);
<a name="l05058"></a>05058     fclose(fp);
<a name="l05059"></a>05059     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = save_errno;
<a name="l05060"></a>05060     <span class="keywordflow">if</span> (closesocket(sock) == SOCKET_ERROR) {
<a name="l05061"></a>05061         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l05062"></a>05062         <span class="keywordflow">return</span> -1;
<a name="l05063"></a>05063     }
<a name="l05064"></a>05064     <span class="keywordflow">return</span> 0;
<a name="l05065"></a>05065 }
<a name="l05066"></a>05066 
<a name="l05067"></a>05067 <span class="keywordtype">int</span>
<a name="l05068"></a><a class="code" href="../../d5/df2/win32_8c.html#a5bc684545342d6d143570e4e45a3c2cd">05068</a> <a class="code" href="../../dc/db1/win32_8h.html#afe578cd102f929525eee8b17a98d6efa">rb_w32_pipe</a>(<span class="keywordtype">int</span> fds[2])
<a name="l05069"></a>05069 {
<a name="l05070"></a>05070     <span class="keyword">static</span> <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> serial = 0;
<a name="l05071"></a>05071     <span class="keywordtype">char</span> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>[] = <span class="stringliteral">&quot;\\\\.\\pipe\\ruby0000000000000000-0000000000000000&quot;</span>;
<a name="l05072"></a>05072     <span class="keywordtype">char</span> *p;
<a name="l05073"></a>05073     SECURITY_ATTRIBUTES sec;
<a name="l05074"></a>05074     HANDLE hRead, hWrite, h;
<a name="l05075"></a>05075     <span class="keywordtype">int</span> fdRead, fdWrite;
<a name="l05076"></a>05076     <span class="keywordtype">int</span> ret;
<a name="l05077"></a>05077 
<a name="l05078"></a>05078     <span class="comment">/* if doesn&apos;t have CancelIo, use default pipe function */</span>
<a name="l05079"></a>05079     <span class="keywordflow">if</span> (!cancel_io)
<a name="l05080"></a>05080         <span class="keywordflow">return</span> _pipe(fds, 65536L, _O_NOINHERIT);
<a name="l05081"></a>05081 
<a name="l05082"></a>05082     p = <a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(name, <span class="charliteral">&apos;0&apos;</span>);
<a name="l05083"></a>05083     <a class="code" href="../../d7/d72/subst_8h.html#aa367b75c5aed883fef5befbdf04835a4">snprintf</a>(p, <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(p) + 1, <span class="stringliteral">&quot;%&quot;</span>PRI_PIDT_PREFIX<span class="stringliteral">&quot;x-%lx&quot;</span>, <a class="code" href="../../dc/db1/win32_8h.html#a9a677fe7b1042899e0dd677732ef4dcd">rb_w32_getpid</a>(), serial++);
<a name="l05084"></a>05084 
<a name="l05085"></a>05085     sec.nLength = <span class="keyword">sizeof</span>(sec);
<a name="l05086"></a>05086     sec.lpSecurityDescriptor = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05087"></a>05087     sec.bInheritHandle = <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l05088"></a>05088 
<a name="l05089"></a>05089     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l05090"></a>05090         hRead = CreateNamedPipe(name, PIPE_ACCESS_DUPLEX | FILE_FLAG_OVERLAPPED,
<a name="l05091"></a>05091                                 0, 2, 65536, 65536, 0, &amp;sec);
<a name="l05092"></a>05092     });
<a name="l05093"></a>05093     <span class="keywordflow">if</span> (hRead == INVALID_HANDLE_VALUE) {
<a name="l05094"></a>05094         <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a> = GetLastError();
<a name="l05095"></a>05095         <span class="keywordflow">if</span> (err == ERROR_PIPE_BUSY)
<a name="l05096"></a>05096             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EMFILE;
<a name="l05097"></a>05097         <span class="keywordflow">else</span>
<a name="l05098"></a>05098             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l05099"></a>05099         <span class="keywordflow">return</span> -1;
<a name="l05100"></a>05100     }
<a name="l05101"></a>05101 
<a name="l05102"></a>05102     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l05103"></a>05103         hWrite = CreateFile(name, GENERIC_READ | GENERIC_WRITE, 0, &amp;sec,
<a name="l05104"></a>05104                             OPEN_EXISTING, FILE_FLAG_OVERLAPPED, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05105"></a>05105     });
<a name="l05106"></a>05106     <span class="keywordflow">if</span> (hWrite == INVALID_HANDLE_VALUE) {
<a name="l05107"></a>05107         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l05108"></a>05108         CloseHandle(hRead);
<a name="l05109"></a>05109         <span class="keywordflow">return</span> -1;
<a name="l05110"></a>05110     }
<a name="l05111"></a>05111 
<a name="l05112"></a>05112     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>(<span class="keywordflow">do</span> {
<a name="l05113"></a>05113         ret = 0;
<a name="l05114"></a>05114         h = CreateFile(<span class="stringliteral">&quot;NUL&quot;</span>, 0, 0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, OPEN_ALWAYS, 0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05115"></a>05115         fdRead = _open_osfhandle((<a class="code" href="../../dc/db1/win32_8h.html#a0fbe4a4f8dd857ee04923a901f27465f">intptr_t</a>)h, 0);
<a name="l05116"></a>05116         CloseHandle(h);
<a name="l05117"></a>05117         <span class="keywordflow">if</span> (fdRead == -1) {
<a name="l05118"></a>05118             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EMFILE;
<a name="l05119"></a>05119             CloseHandle(hWrite);
<a name="l05120"></a>05120             CloseHandle(hRead);
<a name="l05121"></a>05121             ret = -1;
<a name="l05122"></a>05122             <span class="keywordflow">break</span>;
<a name="l05123"></a>05123         }
<a name="l05124"></a>05124 
<a name="l05125"></a>05125         <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(EnterCriticalSection(&amp;(<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fdRead)-&gt;lock)));
<a name="l05126"></a>05126         <a class="code" href="../../d5/df2/win32_8c.html#ac603bb260657b14e80a08ea0a4f7d72e">_set_osfhnd</a>(fdRead, (<a class="code" href="../../dc/db1/win32_8h.html#a0fbe4a4f8dd857ee04923a901f27465f">intptr_t</a>)hRead);
<a name="l05127"></a>05127         <a class="code" href="../../d5/df2/win32_8c.html#a3c63b8defb8d22dccc0c068b3ba6f529">_set_osflags</a>(fdRead, <a class="code" href="../../d5/df2/win32_8c.html#a781db24a3e3e56cf3176b85e4c87bf14">FOPEN</a> | <a class="code" href="../../d5/df2/win32_8c.html#a645a937257c47fd9dd7d8ff239bfad0e">FPIPE</a> | <a class="code" href="../../d5/df2/win32_8c.html#a9275d22eeeb493620a559a000c210798">FNOINHERIT</a>);
<a name="l05128"></a>05128         <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;(<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fdRead)-&gt;lock)));
<a name="l05129"></a>05129     } <span class="keywordflow">while</span> (0));
<a name="l05130"></a>05130     <span class="keywordflow">if</span> (ret)
<a name="l05131"></a>05131         <span class="keywordflow">return</span> ret;
<a name="l05132"></a>05132 
<a name="l05133"></a>05133     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>(<span class="keywordflow">do</span> {
<a name="l05134"></a>05134         h = CreateFile(<span class="stringliteral">&quot;NUL&quot;</span>, 0, 0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, OPEN_ALWAYS, 0, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05135"></a>05135         fdWrite = _open_osfhandle((<a class="code" href="../../dc/db1/win32_8h.html#a0fbe4a4f8dd857ee04923a901f27465f">intptr_t</a>)h, 0);
<a name="l05136"></a>05136         CloseHandle(h);
<a name="l05137"></a>05137         <span class="keywordflow">if</span> (fdWrite == -1) {
<a name="l05138"></a>05138             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EMFILE;
<a name="l05139"></a>05139             CloseHandle(hWrite);
<a name="l05140"></a>05140             ret = -1;
<a name="l05141"></a>05141             <span class="keywordflow">break</span>;
<a name="l05142"></a>05142         }
<a name="l05143"></a>05143         <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(EnterCriticalSection(&amp;(<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fdWrite)-&gt;lock)));
<a name="l05144"></a>05144         <a class="code" href="../../d5/df2/win32_8c.html#ac603bb260657b14e80a08ea0a4f7d72e">_set_osfhnd</a>(fdWrite, (<a class="code" href="../../dc/db1/win32_8h.html#a0fbe4a4f8dd857ee04923a901f27465f">intptr_t</a>)hWrite);
<a name="l05145"></a>05145         <a class="code" href="../../d5/df2/win32_8c.html#a3c63b8defb8d22dccc0c068b3ba6f529">_set_osflags</a>(fdWrite, <a class="code" href="../../d5/df2/win32_8c.html#a781db24a3e3e56cf3176b85e4c87bf14">FOPEN</a> | <a class="code" href="../../d5/df2/win32_8c.html#a645a937257c47fd9dd7d8ff239bfad0e">FPIPE</a> | <a class="code" href="../../d5/df2/win32_8c.html#a9275d22eeeb493620a559a000c210798">FNOINHERIT</a>);
<a name="l05146"></a>05146         <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;(<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fdWrite)-&gt;lock)));
<a name="l05147"></a>05147     } <span class="keywordflow">while</span> (0));
<a name="l05148"></a>05148     <span class="keywordflow">if</span> (ret) {
<a name="l05149"></a>05149         <a class="code" href="../../dc/db1/win32_8h.html#a03de7302ffcf75f0ab994c28c94302ff">rb_w32_close</a>(fdRead);
<a name="l05150"></a>05150         <span class="keywordflow">return</span> ret;
<a name="l05151"></a>05151     }
<a name="l05152"></a>05152 
<a name="l05153"></a>05153     fds[0] = fdRead;
<a name="l05154"></a>05154     fds[1] = fdWrite;
<a name="l05155"></a>05155 
<a name="l05156"></a>05156     <span class="keywordflow">return</span> 0;
<a name="l05157"></a>05157 }
<a name="l05158"></a>05158 
<a name="l05159"></a>05159 <span class="keywordtype">int</span>
<a name="l05160"></a><a class="code" href="../../d5/df2/win32_8c.html#ae4c1e0a8b9193a9708ba0047128b6179">05160</a> <a class="code" href="../../dc/db1/win32_8h.html#a03de7302ffcf75f0ab994c28c94302ff">rb_w32_close</a>(<span class="keywordtype">int</span> fd)
<a name="l05161"></a>05161 {
<a name="l05162"></a>05162     SOCKET sock = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(fd);
<a name="l05163"></a>05163     <span class="keywordtype">int</span> save_errno = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l05164"></a>05164     <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>;
<a name="l05165"></a>05165 
<a name="l05166"></a>05166     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a963dc023d760a24b0e23ce29bb583732">is_socket</a>(sock)) {
<a name="l05167"></a>05167         UnlockFile((HANDLE)sock, 0, 0, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>, <a class="code" href="../../d5/df2/win32_8c.html#a804d2777e40747a6def708314f79446a">LK_LEN</a>);
<a name="l05168"></a>05168         <span class="keywordflow">return</span> _close(fd);
<a name="l05169"></a>05169     }
<a name="l05170"></a>05170     <a class="code" href="../../d5/df2/win32_8c.html#ac603bb260657b14e80a08ea0a4f7d72e">_set_osfhnd</a>(fd, (SOCKET)INVALID_HANDLE_VALUE);
<a name="l05171"></a>05171     key = (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)sock;
<a name="l05172"></a>05172     <a class="code" href="../../dd/d24/st_8h.html#aa04e4ee0a6e1f19e64f3be4668f41234">st_delete</a>(socklist, &amp;key, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05173"></a>05173     sock = (SOCKET)key;
<a name="l05174"></a>05174     _close(fd);
<a name="l05175"></a>05175     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = save_errno;
<a name="l05176"></a>05176     <span class="keywordflow">if</span> (closesocket(sock) == SOCKET_ERROR) {
<a name="l05177"></a>05177         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(WSAGetLastError());
<a name="l05178"></a>05178         <span class="keywordflow">return</span> -1;
<a name="l05179"></a>05179     }
<a name="l05180"></a>05180     <span class="keywordflow">return</span> 0;
<a name="l05181"></a>05181 }
<a name="l05182"></a>05182 
<a name="l05183"></a>05183 <span class="preprocessor">#undef read</span>
<a name="l05184"></a>05184 <span class="preprocessor"></span>ssize_t
<a name="l05185"></a><a class="code" href="../../d5/df2/win32_8c.html#a1e653878ba74dbd50303c7bda56e13c0">05185</a> <a class="code" href="../../dc/db1/win32_8h.html#a60bd67ac946e992620ac79e6f8ccce3a">rb_w32_read</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">void</span> *buf, <span class="keywordtype">size_t</span> size)
<a name="l05186"></a>05186 {
<a name="l05187"></a>05187     SOCKET sock = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(fd);
<a name="l05188"></a>05188     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> read;
<a name="l05189"></a>05189     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../d5/df2/win32_8c.html#a6655447bab00753d59759423bf28e22e">wait</a>;
<a name="l05190"></a>05190     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a>;
<a name="l05191"></a>05191     <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l05192"></a>05192     <span class="keywordtype">size_t</span> ret;
<a name="l05193"></a>05193     OVERLAPPED ol, *pol = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05194"></a>05194     BOOL isconsole;
<a name="l05195"></a>05195     BOOL islineinput = <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l05196"></a>05196     <span class="keywordtype">int</span> start = 0;
<a name="l05197"></a>05197 
<a name="l05198"></a>05198     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a963dc023d760a24b0e23ce29bb583732">is_socket</a>(sock))
<a name="l05199"></a>05199         <span class="keywordflow">return</span> <a class="code" href="../../dc/db1/win32_8h.html#a4efbaac71d987aea996bee8a5b0f739a">rb_w32_recv</a>(fd, buf, size, 0);
<a name="l05200"></a>05200 
<a name="l05201"></a>05201     <span class="comment">// validate fd by using _get_osfhandle() because we cannot access _nhandle</span>
<a name="l05202"></a>05202     <span class="keywordflow">if</span> (_get_osfhandle(fd) == -1) {
<a name="l05203"></a>05203         <span class="keywordflow">return</span> -1;
<a name="l05204"></a>05204     }
<a name="l05205"></a>05205 
<a name="l05206"></a>05206     <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a90ead473a170c01aed0fff5c736650f6">_osfile</a>(fd) &amp; <a class="code" href="../../d5/df2/win32_8c.html#ad16d3314e1ed1f0124d728efbd474ad4">FTEXT</a>) {
<a name="l05207"></a>05207         <span class="keywordflow">return</span> _read(fd, buf, size);
<a name="l05208"></a>05208     }
<a name="l05209"></a>05209 
<a name="l05210"></a>05210     <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(EnterCriticalSection(&amp;(<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock)));
<a name="l05211"></a>05211 
<a name="l05212"></a>05212     <span class="keywordflow">if</span> (!size || <a class="code" href="../../d5/df2/win32_8c.html#a90ead473a170c01aed0fff5c736650f6">_osfile</a>(fd) &amp; <a class="code" href="../../d5/df2/win32_8c.html#a2fd2fbb4f27ad49ab4292a131a83e27e">FEOFLAG</a>) {
<a name="l05213"></a>05213         <a class="code" href="../../d5/df2/win32_8c.html#a3c63b8defb8d22dccc0c068b3ba6f529">_set_osflags</a>(fd, <a class="code" href="../../d5/df2/win32_8c.html#a90ead473a170c01aed0fff5c736650f6">_osfile</a>(fd) &amp; ~FEOFLAG);
<a name="l05214"></a>05214         <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05215"></a>05215         <span class="keywordflow">return</span> 0;
<a name="l05216"></a>05216     }
<a name="l05217"></a>05217 
<a name="l05218"></a>05218     ret = 0;
<a name="l05219"></a>05219     isconsole = <a class="code" href="../../d5/df2/win32_8c.html#acb2b68f9f5f884aa1eb0112208debda7">is_console</a>(<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd));
<a name="l05220"></a>05220     <span class="keywordflow">if</span> (isconsole) {
<a name="l05221"></a>05221         <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> mode;
<a name="l05222"></a>05222         GetConsoleMode((HANDLE)<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd),&amp;mode);
<a name="l05223"></a>05223         islineinput = (mode &amp; ENABLE_LINE_INPUT) != 0;
<a name="l05224"></a>05224     }
<a name="l05225"></a>05225   retry:
<a name="l05226"></a>05226     <span class="comment">/* get rid of console reading bug */</span>
<a name="l05227"></a>05227     <span class="keywordflow">if</span> (isconsole) {
<a name="l05228"></a>05228         <span class="keywordflow">if</span> (start)
<a name="l05229"></a>05229             len = 1;
<a name="l05230"></a>05230         <span class="keywordflow">else</span> {
<a name="l05231"></a>05231             len = 0;
<a name="l05232"></a>05232             start = 1;
<a name="l05233"></a>05233         }
<a name="l05234"></a>05234     }
<a name="l05235"></a>05235     <span class="keywordflow">else</span>
<a name="l05236"></a>05236         len = size;
<a name="l05237"></a>05237     size -= len;
<a name="l05238"></a>05238 
<a name="l05239"></a>05239     <span class="comment">/* if have cancel_io, use Overlapped I/O */</span>
<a name="l05240"></a>05240     <span class="keywordflow">if</span> (cancel_io) {
<a name="l05241"></a>05241         memset(&amp;ol, 0, <span class="keyword">sizeof</span>(ol));
<a name="l05242"></a>05242         <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/df2/win32_8c.html#a90ead473a170c01aed0fff5c736650f6">_osfile</a>(fd) &amp; (<a class="code" href="../../d5/df2/win32_8c.html#a9b8e31e24fbc8c8b6223c6130d90999b">FDEV</a> | <a class="code" href="../../d5/df2/win32_8c.html#a645a937257c47fd9dd7d8ff239bfad0e">FPIPE</a>))) {
<a name="l05243"></a>05243             LONG high = 0;
<a name="l05244"></a>05244             <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> low = SetFilePointer((HANDLE)<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd), 0, &amp;high,
<a name="l05245"></a>05245                                        FILE_CURRENT);
<a name="l05246"></a>05246 <span class="preprocessor">#ifndef INVALID_SET_FILE_POINTER</span>
<a name="l05247"></a>05247 <span class="preprocessor"></span><span class="preprocessor">#define INVALID_SET_FILE_POINTER ((DWORD)-1)</span>
<a name="l05248"></a>05248 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l05249"></a>05249 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (low == <a class="code" href="../../d5/df2/win32_8c.html#a3242e600d18ba66007c0c24c04e701e2">INVALID_SET_FILE_POINTER</a>) {
<a name="l05250"></a>05250                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l05251"></a>05251                 <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05252"></a>05252                 <span class="keywordflow">return</span> -1;
<a name="l05253"></a>05253             }
<a name="l05254"></a>05254             ol.Offset = low;
<a name="l05255"></a>05255             ol.OffsetHigh = high;
<a name="l05256"></a>05256         }
<a name="l05257"></a>05257         ol.hEvent = CreateEvent(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05258"></a>05258         <span class="keywordflow">if</span> (!ol.hEvent) {
<a name="l05259"></a>05259             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l05260"></a>05260             <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05261"></a>05261             <span class="keywordflow">return</span> -1;
<a name="l05262"></a>05262         }
<a name="l05263"></a>05263 
<a name="l05264"></a>05264         pol = &amp;ol;
<a name="l05265"></a>05265     }
<a name="l05266"></a>05266 
<a name="l05267"></a>05267     <span class="keywordflow">if</span> (!ReadFile((HANDLE)<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd), buf, len, &amp;read, pol)) {
<a name="l05268"></a>05268         err = GetLastError();
<a name="l05269"></a>05269         <span class="keywordflow">if</span> (err != ERROR_IO_PENDING) {
<a name="l05270"></a>05270             <span class="keywordflow">if</span> (pol) CloseHandle(ol.hEvent);
<a name="l05271"></a>05271             <span class="keywordflow">if</span> (err == ERROR_ACCESS_DENIED)
<a name="l05272"></a>05272                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EBADF;
<a name="l05273"></a>05273             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == ERROR_BROKEN_PIPE || err == ERROR_HANDLE_EOF) {
<a name="l05274"></a>05274                 <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05275"></a>05275                 <span class="keywordflow">return</span> 0;
<a name="l05276"></a>05276             }
<a name="l05277"></a>05277             <span class="keywordflow">else</span>
<a name="l05278"></a>05278                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(err);
<a name="l05279"></a>05279 
<a name="l05280"></a>05280             <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05281"></a>05281             <span class="keywordflow">return</span> -1;
<a name="l05282"></a>05282         }
<a name="l05283"></a>05283 
<a name="l05284"></a>05284         <span class="keywordflow">if</span> (pol) {
<a name="l05285"></a>05285             wait = <a class="code" href="../../dc/db1/win32_8h.html#a2da86cc53904a673b2b18547d63700f6">rb_w32_wait_events_blocking</a>(&amp;ol.hEvent, 1, INFINITE);
<a name="l05286"></a>05286             <span class="keywordflow">if</span> (wait != WAIT_OBJECT_0) {
<a name="l05287"></a>05287                 <span class="keywordflow">if</span> (wait == WAIT_OBJECT_0 + 1)
<a name="l05288"></a>05288                     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINTR;
<a name="l05289"></a>05289                 <span class="keywordflow">else</span>
<a name="l05290"></a>05290                     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l05291"></a>05291                 CloseHandle(ol.hEvent);
<a name="l05292"></a>05292                 <a class="code" href="../../d5/df2/win32_8c.html#a87c46885302df4c28bc6825fb195df1f">cancel_io</a>((HANDLE)<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd));
<a name="l05293"></a>05293                 <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05294"></a>05294                 <span class="keywordflow">return</span> -1;
<a name="l05295"></a>05295             }
<a name="l05296"></a>05296 
<a name="l05297"></a>05297             <span class="keywordflow">if</span> (!GetOverlappedResult((HANDLE)<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd), &amp;ol, &amp;read, <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) &amp;&amp;
<a name="l05298"></a>05298                 (err = GetLastError()) != ERROR_HANDLE_EOF) {
<a name="l05299"></a>05299                 <span class="keywordtype">int</span> ret = 0;
<a name="l05300"></a>05300                 <span class="keywordflow">if</span> (err != ERROR_BROKEN_PIPE) {
<a name="l05301"></a>05301                     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(err);
<a name="l05302"></a>05302                     ret = -1;
<a name="l05303"></a>05303                 }
<a name="l05304"></a>05304                 CloseHandle(ol.hEvent);
<a name="l05305"></a>05305                 <a class="code" href="../../d5/df2/win32_8c.html#a87c46885302df4c28bc6825fb195df1f">cancel_io</a>((HANDLE)<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd));
<a name="l05306"></a>05306                 <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05307"></a>05307                 <span class="keywordflow">return</span> ret;
<a name="l05308"></a>05308             }
<a name="l05309"></a>05309         }
<a name="l05310"></a>05310     }
<a name="l05311"></a>05311 
<a name="l05312"></a>05312     <span class="keywordflow">if</span> (pol) {
<a name="l05313"></a>05313         CloseHandle(ol.hEvent);
<a name="l05314"></a>05314 
<a name="l05315"></a>05315         <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/df2/win32_8c.html#a90ead473a170c01aed0fff5c736650f6">_osfile</a>(fd) &amp; (<a class="code" href="../../d5/df2/win32_8c.html#a9b8e31e24fbc8c8b6223c6130d90999b">FDEV</a> | <a class="code" href="../../d5/df2/win32_8c.html#a645a937257c47fd9dd7d8ff239bfad0e">FPIPE</a>))) {
<a name="l05316"></a>05316             LONG high = ol.OffsetHigh;
<a name="l05317"></a>05317             <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> low = ol.Offset + read;
<a name="l05318"></a>05318             <span class="keywordflow">if</span> (low &lt; ol.Offset)
<a name="l05319"></a>05319                 ++high;
<a name="l05320"></a>05320             SetFilePointer((HANDLE)<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd), low, &amp;high, FILE_BEGIN);
<a name="l05321"></a>05321         }
<a name="l05322"></a>05322     }
<a name="l05323"></a>05323 
<a name="l05324"></a>05324     ret += read;
<a name="l05325"></a>05325     <span class="keywordflow">if</span> (read &gt;= len) {
<a name="l05326"></a>05326         buf = (<span class="keywordtype">char</span> *)buf + read;
<a name="l05327"></a>05327         <span class="keywordflow">if</span> (!(isconsole &amp;&amp; len == 1 &amp;&amp; (!islineinput || *((<span class="keywordtype">char</span> *)buf - 1) == <span class="charliteral">&apos;\n&apos;</span>)) &amp;&amp; size &gt; 0)
<a name="l05328"></a>05328             <span class="keywordflow">goto</span> retry;
<a name="l05329"></a>05329     }
<a name="l05330"></a>05330     <span class="keywordflow">if</span> (read == 0)
<a name="l05331"></a>05331         <a class="code" href="../../d5/df2/win32_8c.html#a3c63b8defb8d22dccc0c068b3ba6f529">_set_osflags</a>(fd, <a class="code" href="../../d5/df2/win32_8c.html#a90ead473a170c01aed0fff5c736650f6">_osfile</a>(fd) | FEOFLAG);
<a name="l05332"></a>05332 
<a name="l05333"></a>05333 
<a name="l05334"></a>05334     <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05335"></a>05335 
<a name="l05336"></a>05336     <span class="keywordflow">return</span> ret;
<a name="l05337"></a>05337 }
<a name="l05338"></a>05338 
<a name="l05339"></a>05339 <span class="preprocessor">#undef write</span>
<a name="l05340"></a>05340 <span class="preprocessor"></span>ssize_t
<a name="l05341"></a><a class="code" href="../../d5/df2/win32_8c.html#a2a49eedb320efa97ebb7fdccb42d6849">05341</a> <a class="code" href="../../dc/db1/win32_8h.html#aad52311e1bf2d0cd59a0dc525df418c0">rb_w32_write</a>(<span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keywordtype">void</span> *buf, <span class="keywordtype">size_t</span> size)
<a name="l05342"></a>05342 {
<a name="l05343"></a>05343     SOCKET sock = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(fd);
<a name="l05344"></a>05344     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> written;
<a name="l05345"></a>05345     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../d5/df2/win32_8c.html#a6655447bab00753d59759423bf28e22e">wait</a>;
<a name="l05346"></a>05346     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> <a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a>;
<a name="l05347"></a>05347     <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l05348"></a>05348     <span class="keywordtype">size_t</span> ret;
<a name="l05349"></a>05349     OVERLAPPED ol, *pol = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05350"></a>05350 
<a name="l05351"></a>05351     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a963dc023d760a24b0e23ce29bb583732">is_socket</a>(sock))
<a name="l05352"></a>05352         <span class="keywordflow">return</span> <a class="code" href="../../dc/db1/win32_8h.html#a4fcc16a6694fcba033dc9b5933f8fc00">rb_w32_send</a>(fd, buf, size, 0);
<a name="l05353"></a>05353 
<a name="l05354"></a>05354     <span class="comment">// validate fd by using _get_osfhandle() because we cannot access _nhandle</span>
<a name="l05355"></a>05355     <span class="keywordflow">if</span> (_get_osfhandle(fd) == -1) {
<a name="l05356"></a>05356         <span class="keywordflow">return</span> -1;
<a name="l05357"></a>05357     }
<a name="l05358"></a>05358 
<a name="l05359"></a>05359     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/df2/win32_8c.html#a90ead473a170c01aed0fff5c736650f6">_osfile</a>(fd) &amp; <a class="code" href="../../d5/df2/win32_8c.html#ad16d3314e1ed1f0124d728efbd474ad4">FTEXT</a>) &amp;&amp;
<a name="l05360"></a>05360         (!(<a class="code" href="../../d5/df2/win32_8c.html#a90ead473a170c01aed0fff5c736650f6">_osfile</a>(fd) &amp; <a class="code" href="../../d5/df2/win32_8c.html#a645a937257c47fd9dd7d8ff239bfad0e">FPIPE</a>) || fd == <a class="code" href="../../da/d50/vsnprintf_8c.html#a7aa82a32f4ad97a0107302dae80a2b1e">fileno</a>(stdout) || fd == <a class="code" href="../../da/d50/vsnprintf_8c.html#a7aa82a32f4ad97a0107302dae80a2b1e">fileno</a>(stderr))) {
<a name="l05361"></a>05361         <span class="keywordflow">return</span> _write(fd, buf, size);
<a name="l05362"></a>05362     }
<a name="l05363"></a>05363 
<a name="l05364"></a>05364     <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(EnterCriticalSection(&amp;(<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock)));
<a name="l05365"></a>05365 
<a name="l05366"></a>05366     <span class="keywordflow">if</span> (!size || <a class="code" href="../../d5/df2/win32_8c.html#a90ead473a170c01aed0fff5c736650f6">_osfile</a>(fd) &amp; <a class="code" href="../../d5/df2/win32_8c.html#a2fd2fbb4f27ad49ab4292a131a83e27e">FEOFLAG</a>) {
<a name="l05367"></a>05367         <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05368"></a>05368         <span class="keywordflow">return</span> 0;
<a name="l05369"></a>05369     }
<a name="l05370"></a>05370 
<a name="l05371"></a>05371     ret = 0;
<a name="l05372"></a>05372   retry:
<a name="l05373"></a>05373     <span class="comment">/* get rid of console writing bug */</span>
<a name="l05374"></a>05374     len = (<a class="code" href="../../d5/df2/win32_8c.html#a90ead473a170c01aed0fff5c736650f6">_osfile</a>(fd) &amp; <a class="code" href="../../d5/df2/win32_8c.html#a9b8e31e24fbc8c8b6223c6130d90999b">FDEV</a>) ? <a class="code" href="../../d1/d6f/date__strftime_8c.html#a2f2bf96d77a187bd4446b4ba3864470d">min</a>(32 * 1024, size) : size;
<a name="l05375"></a>05375     size -= len;
<a name="l05376"></a>05376 
<a name="l05377"></a>05377     <span class="comment">/* if have cancel_io, use Overlapped I/O */</span>
<a name="l05378"></a>05378     <span class="keywordflow">if</span> (cancel_io) {
<a name="l05379"></a>05379         memset(&amp;ol, 0, <span class="keyword">sizeof</span>(ol));
<a name="l05380"></a>05380         <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/df2/win32_8c.html#a90ead473a170c01aed0fff5c736650f6">_osfile</a>(fd) &amp; (<a class="code" href="../../d5/df2/win32_8c.html#a9b8e31e24fbc8c8b6223c6130d90999b">FDEV</a> | FPIPE))) {
<a name="l05381"></a>05381             LONG high = 0;
<a name="l05382"></a>05382             <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> method = <a class="code" href="../../d5/df2/win32_8c.html#a90ead473a170c01aed0fff5c736650f6">_osfile</a>(fd) &amp; <a class="code" href="../../d5/df2/win32_8c.html#aa336842f710119bfdab086f34efac63c">FAPPEND</a> ? FILE_END : FILE_CURRENT;
<a name="l05383"></a>05383             <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> low = SetFilePointer((HANDLE)<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd), 0, &amp;high, method);
<a name="l05384"></a>05384 <span class="preprocessor">#ifndef INVALID_SET_FILE_POINTER</span>
<a name="l05385"></a>05385 <span class="preprocessor"></span><span class="preprocessor">#define INVALID_SET_FILE_POINTER ((DWORD)-1)</span>
<a name="l05386"></a>05386 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l05387"></a>05387 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (low == <a class="code" href="../../d5/df2/win32_8c.html#a3242e600d18ba66007c0c24c04e701e2">INVALID_SET_FILE_POINTER</a>) {
<a name="l05388"></a>05388                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l05389"></a>05389                 <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05390"></a>05390                 <span class="keywordflow">return</span> -1;
<a name="l05391"></a>05391             }
<a name="l05392"></a>05392             ol.Offset = low;
<a name="l05393"></a>05393             ol.OffsetHigh = high;
<a name="l05394"></a>05394         }
<a name="l05395"></a>05395         ol.hEvent = CreateEvent(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05396"></a>05396         <span class="keywordflow">if</span> (!ol.hEvent) {
<a name="l05397"></a>05397             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l05398"></a>05398             <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05399"></a>05399             <span class="keywordflow">return</span> -1;
<a name="l05400"></a>05400         }
<a name="l05401"></a>05401 
<a name="l05402"></a>05402         pol = &amp;ol;
<a name="l05403"></a>05403     }
<a name="l05404"></a>05404 
<a name="l05405"></a>05405     <span class="keywordflow">if</span> (!WriteFile((HANDLE)<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd), buf, len, &amp;written, pol)) {
<a name="l05406"></a>05406         err = GetLastError();
<a name="l05407"></a>05407         <span class="keywordflow">if</span> (err != ERROR_IO_PENDING) {
<a name="l05408"></a>05408             <span class="keywordflow">if</span> (pol) CloseHandle(ol.hEvent);
<a name="l05409"></a>05409             <span class="keywordflow">if</span> (err == ERROR_ACCESS_DENIED)
<a name="l05410"></a>05410                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EBADF;
<a name="l05411"></a>05411             <span class="keywordflow">else</span>
<a name="l05412"></a>05412                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(err);
<a name="l05413"></a>05413 
<a name="l05414"></a>05414             <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05415"></a>05415             <span class="keywordflow">return</span> -1;
<a name="l05416"></a>05416         }
<a name="l05417"></a>05417 
<a name="l05418"></a>05418         <span class="keywordflow">if</span> (pol) {
<a name="l05419"></a>05419             wait = <a class="code" href="../../dc/db1/win32_8h.html#a2da86cc53904a673b2b18547d63700f6">rb_w32_wait_events_blocking</a>(&amp;ol.hEvent, 1, INFINITE);
<a name="l05420"></a>05420             <span class="keywordflow">if</span> (wait != WAIT_OBJECT_0) {
<a name="l05421"></a>05421                 <span class="keywordflow">if</span> (wait == WAIT_OBJECT_0 + 1)
<a name="l05422"></a>05422                     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINTR;
<a name="l05423"></a>05423                 <span class="keywordflow">else</span>
<a name="l05424"></a>05424                     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l05425"></a>05425                 CloseHandle(ol.hEvent);
<a name="l05426"></a>05426                 <a class="code" href="../../d5/df2/win32_8c.html#a87c46885302df4c28bc6825fb195df1f">cancel_io</a>((HANDLE)<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd));
<a name="l05427"></a>05427                 <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05428"></a>05428                 <span class="keywordflow">return</span> -1;
<a name="l05429"></a>05429             }
<a name="l05430"></a>05430 
<a name="l05431"></a>05431             <span class="keywordflow">if</span> (!GetOverlappedResult((HANDLE)<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd), &amp;ol, &amp;written,
<a name="l05432"></a>05432                                      <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>)) {
<a name="l05433"></a>05433                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(err);
<a name="l05434"></a>05434                 CloseHandle(ol.hEvent);
<a name="l05435"></a>05435                 <a class="code" href="../../d5/df2/win32_8c.html#a87c46885302df4c28bc6825fb195df1f">cancel_io</a>((HANDLE)<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd));
<a name="l05436"></a>05436                 <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05437"></a>05437                 <span class="keywordflow">return</span> -1;
<a name="l05438"></a>05438             }
<a name="l05439"></a>05439         }
<a name="l05440"></a>05440     }
<a name="l05441"></a>05441 
<a name="l05442"></a>05442     <span class="keywordflow">if</span> (pol) {
<a name="l05443"></a>05443         CloseHandle(ol.hEvent);
<a name="l05444"></a>05444 
<a name="l05445"></a>05445         <span class="keywordflow">if</span> (!(<a class="code" href="../../d5/df2/win32_8c.html#a90ead473a170c01aed0fff5c736650f6">_osfile</a>(fd) &amp; (<a class="code" href="../../d5/df2/win32_8c.html#a9b8e31e24fbc8c8b6223c6130d90999b">FDEV</a> | FPIPE))) {
<a name="l05446"></a>05446             LONG high = ol.OffsetHigh;
<a name="l05447"></a>05447             <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> low = ol.Offset + written;
<a name="l05448"></a>05448             <span class="keywordflow">if</span> (low &lt; ol.Offset)
<a name="l05449"></a>05449                 ++high;
<a name="l05450"></a>05450             SetFilePointer((HANDLE)<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd), low, &amp;high, FILE_BEGIN);
<a name="l05451"></a>05451         }
<a name="l05452"></a>05452     }
<a name="l05453"></a>05453 
<a name="l05454"></a>05454     ret += written;
<a name="l05455"></a>05455     <span class="keywordflow">if</span> (written == len) {
<a name="l05456"></a>05456         buf = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)buf + len;
<a name="l05457"></a>05457         <span class="keywordflow">if</span> (size &gt; 0)
<a name="l05458"></a>05458             <span class="keywordflow">goto</span> retry;
<a name="l05459"></a>05459     }
<a name="l05460"></a>05460 
<a name="l05461"></a>05461     <a class="code" href="../../d5/df2/win32_8c.html#a03e5dcbaf303e683369b6e4a431b2163">MTHREAD_ONLY</a>(LeaveCriticalSection(&amp;<a class="code" href="../../d5/df2/win32_8c.html#a4f7107157abc525071f7b6141c4e161f">_pioinfo</a>(fd)-&gt;lock));
<a name="l05462"></a>05462 
<a name="l05463"></a>05463     <span class="keywordflow">return</span> ret;
<a name="l05464"></a>05464 }
<a name="l05465"></a>05465 
<a name="l05466"></a>05466 <span class="keywordtype">long</span>
<a name="l05467"></a><a class="code" href="../../d5/df2/win32_8c.html#af76e9ec0ab6983671ab9e3b74dd88fb7">05467</a> <a class="code" href="../../dc/db1/win32_8h.html#a07475740ddb9ed55ea0ae009c5007254">rb_w32_write_console</a>(<a class="code" href="../../dc/db1/win32_8h.html#a728e973c799f206f0151c8a3bd1e5699">uintptr_t</a> strarg, <span class="keywordtype">int</span> fd)
<a name="l05468"></a>05468 {
<a name="l05469"></a>05469     <span class="keyword">static</span> <span class="keywordtype">int</span> disable;
<a name="l05470"></a>05470     HANDLE handle;
<a name="l05471"></a>05471     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> dwMode, reslen;
<a name="l05472"></a>05472     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str = strarg;
<a name="l05473"></a>05473 
<a name="l05474"></a>05474     <span class="keywordflow">if</span> (disable) <span class="keywordflow">return</span> -1L;
<a name="l05475"></a>05475     handle = (HANDLE)<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd);
<a name="l05476"></a>05476     <span class="keywordflow">if</span> (!GetConsoleMode(handle, &amp;dwMode) ||
<a name="l05477"></a>05477         !<a class="code" href="../../d5/de3/encoding_8h.html#a3e28fc72b6e64a4ace21bace4a1bf040">rb_econv_has_convpath_p</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(<a class="code" href="../../d5/db5/encoding_8c.html#ac21ed764f3b39453b6a848dd64a19585">rb_enc_get</a>(str)), <span class="stringliteral">&quot;UTF-16LE&quot;</span>))
<a name="l05478"></a>05478         <span class="keywordflow">return</span> -1L;
<a name="l05479"></a>05479 
<a name="l05480"></a>05480     str = <a class="code" href="../../d5/de3/encoding_8h.html#a92c4c79471eb00ba915287505a118401">rb_str_encode</a>(str, <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(<a class="code" href="../../d5/db5/encoding_8c.html#a67638c695b4079ca5f4b6b4cc22ab27a">rb_enc_find</a>(<span class="stringliteral">&quot;UTF-16LE&quot;</span>)),
<a name="l05481"></a>05481                         <a class="code" href="../../d5/de3/encoding_8h.html#a6ebf7f037784cbfd05d0d7930532f796">ECONV_INVALID_REPLACE</a>|<a class="code" href="../../d5/de3/encoding_8h.html#a4f8674ffeb3e7e562628f54ff0a10f4e">ECONV_UNDEF_REPLACE</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l05482"></a>05482     <span class="keywordflow">if</span> (!WriteConsoleW(handle, (LPWSTR)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str)/2,
<a name="l05483"></a>05483                        &amp;reslen, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) {
<a name="l05484"></a>05484         <span class="keywordflow">if</span> (GetLastError() == ERROR_CALL_NOT_IMPLEMENTED)
<a name="l05485"></a>05485             disable = <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l05486"></a>05486         <span class="keywordflow">return</span> -1L;
<a name="l05487"></a>05487     }
<a name="l05488"></a>05488     <span class="keywordflow">return</span> (<span class="keywordtype">long</span>)reslen;
<a name="l05489"></a>05489 }
<a name="l05490"></a>05490 
<a name="l05491"></a>05491 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l05492"></a><a class="code" href="../../d5/df2/win32_8c.html#a9c4018bb6fbdb2ec69c404c7bdef342b">05492</a> <a class="code" href="../../d5/df2/win32_8c.html#a9c4018bb6fbdb2ec69c404c7bdef342b">unixtime_to_filetime</a>(<a class="code" href="../../d3/d90/missing_8h.html#a7157cbb87d46be33f7f913fa09144900">time_t</a> time, FILETIME *ft)
<a name="l05493"></a>05493 {
<a name="l05494"></a>05494     ULARGE_INTEGER tmp;
<a name="l05495"></a>05495 
<a name="l05496"></a>05496     tmp.QuadPart = ((LONG_LONG)time + (LONG_LONG)((1970-1601)*365.2425) * 24 * 60 * 60) * 10 * 1000 * 1000;
<a name="l05497"></a>05497     ft-&gt;dwLowDateTime = tmp.LowPart;
<a name="l05498"></a>05498     ft-&gt;dwHighDateTime = tmp.HighPart;
<a name="l05499"></a>05499     <span class="keywordflow">return</span> 0;
<a name="l05500"></a>05500 }
<a name="l05501"></a>05501 
<a name="l05502"></a>05502 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l05503"></a><a class="code" href="../../d5/df2/win32_8c.html#a7b93d46fab0199a8c3dae43b29a13674">05503</a> <a class="code" href="../../d5/df2/win32_8c.html#a7b93d46fab0199a8c3dae43b29a13674">wutime</a>(<span class="keyword">const</span> WCHAR *path, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../dd/d29/structutimbuf.html">utimbuf</a> *times)
<a name="l05504"></a>05504 {
<a name="l05505"></a>05505     HANDLE hFile;
<a name="l05506"></a>05506     FILETIME atime, mtime;
<a name="l05507"></a>05507     <span class="keyword">struct </span>stati64 stat;
<a name="l05508"></a>05508     <span class="keywordtype">int</span> ret = 0;
<a name="l05509"></a>05509 
<a name="l05510"></a>05510     <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#aa6e8114a63a22d89103ef7434a6ae53e">wstati64</a>(path, &amp;stat)) {
<a name="l05511"></a>05511         <span class="keywordflow">return</span> -1;
<a name="l05512"></a>05512     }
<a name="l05513"></a>05513 
<a name="l05514"></a>05514     <span class="keywordflow">if</span> (times) {
<a name="l05515"></a>05515         <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a9c4018bb6fbdb2ec69c404c7bdef342b">unixtime_to_filetime</a>(times-&gt;<a class="code" href="../../dd/d29/structutimbuf.html#afdebe113b695234a308aea9868969441">actime</a>, &amp;atime)) {
<a name="l05516"></a>05516             <span class="keywordflow">return</span> -1;
<a name="l05517"></a>05517         }
<a name="l05518"></a>05518         <span class="keywordflow">if</span> (<a class="code" href="../../d5/df2/win32_8c.html#a9c4018bb6fbdb2ec69c404c7bdef342b">unixtime_to_filetime</a>(times-&gt;<a class="code" href="../../dd/d29/structutimbuf.html#a7898fd28225a4c3c2802df9fa0c1e69e">modtime</a>, &amp;mtime)) {
<a name="l05519"></a>05519             <span class="keywordflow">return</span> -1;
<a name="l05520"></a>05520         }
<a name="l05521"></a>05521     }
<a name="l05522"></a>05522     <span class="keywordflow">else</span> {
<a name="l05523"></a>05523         GetSystemTimeAsFileTime(&amp;atime);
<a name="l05524"></a>05524         mtime = atime;
<a name="l05525"></a>05525     }
<a name="l05526"></a>05526 
<a name="l05527"></a>05527     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l05528"></a>05528         <span class="keyword">const</span> <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> attr = GetFileAttributesW(path);
<a name="l05529"></a>05529         <span class="keywordflow">if</span> (attr != (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)-1 &amp;&amp; (attr &amp; FILE_ATTRIBUTE_READONLY))
<a name="l05530"></a>05530             SetFileAttributesW(path, attr &amp; ~FILE_ATTRIBUTE_READONLY);
<a name="l05531"></a>05531         hFile = CreateFileW(path, GENERIC_WRITE, 0, 0, OPEN_EXISTING,
<a name="l05532"></a>05532                             <a class="code" href="../../d5/df2/win32_8c.html#a612e2ad1adbb621210494d51d634d40d">IsWin95</a>() ? 0 : FILE_FLAG_BACKUP_SEMANTICS, 0);
<a name="l05533"></a>05533         <span class="keywordflow">if</span> (hFile == INVALID_HANDLE_VALUE) {
<a name="l05534"></a>05534             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l05535"></a>05535             ret = -1;
<a name="l05536"></a>05536         }
<a name="l05537"></a>05537         <span class="keywordflow">else</span> {
<a name="l05538"></a>05538             <span class="keywordflow">if</span> (!SetFileTime(hFile, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;atime, &amp;mtime)) {
<a name="l05539"></a>05539                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l05540"></a>05540                 ret = -1;
<a name="l05541"></a>05541             }
<a name="l05542"></a>05542             CloseHandle(hFile);
<a name="l05543"></a>05543         }
<a name="l05544"></a>05544         <span class="keywordflow">if</span> (attr != (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)-1 &amp;&amp; (attr &amp; FILE_ATTRIBUTE_READONLY))
<a name="l05545"></a>05545             SetFileAttributesW(path, attr);
<a name="l05546"></a>05546     });
<a name="l05547"></a>05547 
<a name="l05548"></a>05548     <span class="keywordflow">return</span> ret;
<a name="l05549"></a>05549 }
<a name="l05550"></a>05550 
<a name="l05551"></a>05551 <span class="keywordtype">int</span>
<a name="l05552"></a><a class="code" href="../../d5/df2/win32_8c.html#a5de06e045075fe8bf9eb340cec554233">05552</a> <a class="code" href="../../dc/db1/win32_8h.html#a4e1fe73c7375a4d213c410ca2f936b0f">rb_w32_uutime</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../dd/d29/structutimbuf.html">utimbuf</a> *times)
<a name="l05553"></a>05553 {
<a name="l05554"></a>05554     WCHAR *wpath;
<a name="l05555"></a>05555     <span class="keywordtype">int</span> ret;
<a name="l05556"></a>05556 
<a name="l05557"></a>05557     <span class="keywordflow">if</span> (!(wpath = <a class="code" href="../../d5/df2/win32_8c.html#a41003a1382888cc771e290746769eb13">utf8_to_wstr</a>(path, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l05558"></a>05558         <span class="keywordflow">return</span> -1;
<a name="l05559"></a>05559     ret = <a class="code" href="../../d5/df2/win32_8c.html#a7b93d46fab0199a8c3dae43b29a13674">wutime</a>(wpath, times);
<a name="l05560"></a>05560     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wpath);
<a name="l05561"></a>05561     <span class="keywordflow">return</span> ret;
<a name="l05562"></a>05562 }
<a name="l05563"></a>05563 
<a name="l05564"></a>05564 <span class="keywordtype">int</span>
<a name="l05565"></a><a class="code" href="../../d5/df2/win32_8c.html#a655441c266064a252d20d87cd4871701">05565</a> <a class="code" href="../../dc/db1/win32_8h.html#ae59de53f5f1442e3ba74a4a2f7706c8b">rb_w32_utime</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="../../dd/d29/structutimbuf.html">utimbuf</a> *times)
<a name="l05566"></a>05566 {
<a name="l05567"></a>05567     WCHAR *wpath;
<a name="l05568"></a>05568     <span class="keywordtype">int</span> ret;
<a name="l05569"></a>05569 
<a name="l05570"></a>05570     <span class="keywordflow">if</span> (!(wpath = <a class="code" href="../../d5/df2/win32_8c.html#ad33d311f649154599e920240e3900a59">filecp_to_wstr</a>(path, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l05571"></a>05571         <span class="keywordflow">return</span> -1;
<a name="l05572"></a>05572     ret = <a class="code" href="../../d5/df2/win32_8c.html#a7b93d46fab0199a8c3dae43b29a13674">wutime</a>(wpath, times);
<a name="l05573"></a>05573     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wpath);
<a name="l05574"></a>05574     <span class="keywordflow">return</span> ret;
<a name="l05575"></a>05575 }
<a name="l05576"></a>05576 
<a name="l05577"></a>05577 <span class="keywordtype">int</span>
<a name="l05578"></a><a class="code" href="../../d5/df2/win32_8c.html#a5271adada20b77374c5b000a7b29849d">05578</a> <a class="code" href="../../dc/db1/win32_8h.html#a208c5e067569bd4ea8c7688156f6826c">rb_w32_uchdir</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l05579"></a>05579 {
<a name="l05580"></a>05580     WCHAR *wpath;
<a name="l05581"></a>05581     <span class="keywordtype">int</span> ret;
<a name="l05582"></a>05582 
<a name="l05583"></a>05583     <span class="keywordflow">if</span> (!(wpath = <a class="code" href="../../d5/df2/win32_8c.html#a41003a1382888cc771e290746769eb13">utf8_to_wstr</a>(path, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l05584"></a>05584         <span class="keywordflow">return</span> -1;
<a name="l05585"></a>05585     ret = _wchdir(wpath);
<a name="l05586"></a>05586     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wpath);
<a name="l05587"></a>05587     <span class="keywordflow">return</span> ret;
<a name="l05588"></a>05588 }
<a name="l05589"></a>05589 
<a name="l05590"></a>05590 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l05591"></a><a class="code" href="../../d5/df2/win32_8c.html#a1f3b83050d7efc47001be750b5b89ccc">05591</a> <a class="code" href="../../d5/df2/win32_8c.html#a1f3b83050d7efc47001be750b5b89ccc">wmkdir</a>(<span class="keyword">const</span> WCHAR *wpath, <span class="keywordtype">int</span> mode)
<a name="l05592"></a>05592 {
<a name="l05593"></a>05593     <span class="keywordtype">int</span> ret = -1;
<a name="l05594"></a>05594 
<a name="l05595"></a>05595     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>(<span class="keywordflow">do</span> {
<a name="l05596"></a>05596         <span class="keywordflow">if</span> (CreateDirectoryW(wpath, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) == <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l05597"></a>05597             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l05598"></a>05598             <span class="keywordflow">break</span>;
<a name="l05599"></a>05599         }
<a name="l05600"></a>05600         <span class="keywordflow">if</span> (_wchmod(wpath, mode) == -1) {
<a name="l05601"></a>05601             RemoveDirectoryW(wpath);
<a name="l05602"></a>05602             <span class="keywordflow">break</span>;
<a name="l05603"></a>05603         }
<a name="l05604"></a>05604         ret = 0;
<a name="l05605"></a>05605     } <span class="keywordflow">while</span> (0));
<a name="l05606"></a>05606     <span class="keywordflow">return</span> ret;
<a name="l05607"></a>05607 }
<a name="l05608"></a>05608 
<a name="l05609"></a>05609 <span class="keywordtype">int</span>
<a name="l05610"></a><a class="code" href="../../d5/df2/win32_8c.html#a415e29c7cfc41c5da14443916676de67">05610</a> <a class="code" href="../../dc/db1/win32_8h.html#ad345dcb785658b67d3d341e44a13b9da">rb_w32_umkdir</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> mode)
<a name="l05611"></a>05611 {
<a name="l05612"></a>05612     WCHAR *wpath;
<a name="l05613"></a>05613     <span class="keywordtype">int</span> ret;
<a name="l05614"></a>05614 
<a name="l05615"></a>05615     <span class="keywordflow">if</span> (!(wpath = <a class="code" href="../../d5/df2/win32_8c.html#a41003a1382888cc771e290746769eb13">utf8_to_wstr</a>(path, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l05616"></a>05616         <span class="keywordflow">return</span> -1;
<a name="l05617"></a>05617     ret = <a class="code" href="../../d5/df2/win32_8c.html#a1f3b83050d7efc47001be750b5b89ccc">wmkdir</a>(wpath, mode);
<a name="l05618"></a>05618     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wpath);
<a name="l05619"></a>05619     <span class="keywordflow">return</span> ret;
<a name="l05620"></a>05620 }
<a name="l05621"></a>05621 
<a name="l05622"></a>05622 <span class="keywordtype">int</span>
<a name="l05623"></a><a class="code" href="../../d5/df2/win32_8c.html#a2a12254ce2694984306f00090ffb214b">05623</a> <a class="code" href="../../dc/db1/win32_8h.html#a70426e41f78ca45ff6484d38ef7c6ce0">rb_w32_mkdir</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> mode)
<a name="l05624"></a>05624 {
<a name="l05625"></a>05625     WCHAR *wpath;
<a name="l05626"></a>05626     <span class="keywordtype">int</span> ret;
<a name="l05627"></a>05627 
<a name="l05628"></a>05628     <span class="keywordflow">if</span> (!(wpath = <a class="code" href="../../d5/df2/win32_8c.html#ad33d311f649154599e920240e3900a59">filecp_to_wstr</a>(path, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l05629"></a>05629         <span class="keywordflow">return</span> -1;
<a name="l05630"></a>05630     ret = <a class="code" href="../../d5/df2/win32_8c.html#a1f3b83050d7efc47001be750b5b89ccc">wmkdir</a>(wpath, mode);
<a name="l05631"></a>05631     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wpath);
<a name="l05632"></a>05632     <span class="keywordflow">return</span> ret;
<a name="l05633"></a>05633 }
<a name="l05634"></a>05634 
<a name="l05635"></a>05635 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l05636"></a><a class="code" href="../../d5/df2/win32_8c.html#a0cfac5dd0dcba0a0dd37b0949aad2c50">05636</a> <a class="code" href="../../d5/df2/win32_8c.html#a0cfac5dd0dcba0a0dd37b0949aad2c50">wrmdir</a>(<span class="keyword">const</span> WCHAR *wpath)
<a name="l05637"></a>05637 {
<a name="l05638"></a>05638     <span class="keywordtype">int</span> ret = 0;
<a name="l05639"></a>05639     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l05640"></a>05640         <span class="keyword">const</span> <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> attr = GetFileAttributesW(wpath);
<a name="l05641"></a>05641         <span class="keywordflow">if</span> (attr != (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)-1 &amp;&amp; (attr &amp; FILE_ATTRIBUTE_READONLY)) {
<a name="l05642"></a>05642             SetFileAttributesW(wpath, attr &amp; ~FILE_ATTRIBUTE_READONLY);
<a name="l05643"></a>05643         }
<a name="l05644"></a>05644         <span class="keywordflow">if</span> (RemoveDirectoryW(wpath) == <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l05645"></a>05645             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l05646"></a>05646             ret = -1;
<a name="l05647"></a>05647             <span class="keywordflow">if</span> (attr != (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)-1 &amp;&amp; (attr &amp; FILE_ATTRIBUTE_READONLY)) {
<a name="l05648"></a>05648                 SetFileAttributesW(wpath, attr);
<a name="l05649"></a>05649             }
<a name="l05650"></a>05650         }
<a name="l05651"></a>05651     });
<a name="l05652"></a>05652     <span class="keywordflow">return</span> ret;
<a name="l05653"></a>05653 }
<a name="l05654"></a>05654 
<a name="l05655"></a>05655 <span class="keywordtype">int</span>
<a name="l05656"></a><a class="code" href="../../d5/df2/win32_8c.html#a8e079681e47c4b68767211b297738d7a">05656</a> <a class="code" href="../../dc/db1/win32_8h.html#afe7f3405b443bdf2fe55aea337d2be38">rb_w32_rmdir</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l05657"></a>05657 {
<a name="l05658"></a>05658     WCHAR *wpath;
<a name="l05659"></a>05659     <span class="keywordtype">int</span> ret;
<a name="l05660"></a>05660 
<a name="l05661"></a>05661     <span class="keywordflow">if</span> (!(wpath = <a class="code" href="../../d5/df2/win32_8c.html#ad33d311f649154599e920240e3900a59">filecp_to_wstr</a>(path, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l05662"></a>05662         <span class="keywordflow">return</span> -1;
<a name="l05663"></a>05663     ret = <a class="code" href="../../d5/df2/win32_8c.html#a0cfac5dd0dcba0a0dd37b0949aad2c50">wrmdir</a>(wpath);
<a name="l05664"></a>05664     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wpath);
<a name="l05665"></a>05665     <span class="keywordflow">return</span> ret;
<a name="l05666"></a>05666 }
<a name="l05667"></a>05667 
<a name="l05668"></a>05668 <span class="keywordtype">int</span>
<a name="l05669"></a><a class="code" href="../../d5/df2/win32_8c.html#a9dda1d9d5b61d7e5c2eb9020f95839a1">05669</a> <a class="code" href="../../dc/db1/win32_8h.html#a7bef851bc011ec0e58350c041bf4c4ca">rb_w32_urmdir</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l05670"></a>05670 {
<a name="l05671"></a>05671     WCHAR *wpath;
<a name="l05672"></a>05672     <span class="keywordtype">int</span> ret;
<a name="l05673"></a>05673 
<a name="l05674"></a>05674     <span class="keywordflow">if</span> (!(wpath = <a class="code" href="../../d5/df2/win32_8c.html#a41003a1382888cc771e290746769eb13">utf8_to_wstr</a>(path, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l05675"></a>05675         <span class="keywordflow">return</span> -1;
<a name="l05676"></a>05676     ret = <a class="code" href="../../d5/df2/win32_8c.html#a0cfac5dd0dcba0a0dd37b0949aad2c50">wrmdir</a>(wpath);
<a name="l05677"></a>05677     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wpath);
<a name="l05678"></a>05678     <span class="keywordflow">return</span> ret;
<a name="l05679"></a>05679 }
<a name="l05680"></a>05680 
<a name="l05681"></a>05681 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l05682"></a><a class="code" href="../../d5/df2/win32_8c.html#a5827d5053a21855ac68bd01e8c348f49">05682</a> <a class="code" href="../../d5/df2/win32_8c.html#a5827d5053a21855ac68bd01e8c348f49">wunlink</a>(<span class="keyword">const</span> WCHAR *path)
<a name="l05683"></a>05683 {
<a name="l05684"></a>05684     <span class="keywordtype">int</span> ret = 0;
<a name="l05685"></a>05685     <a class="code" href="../../d0/de9/rubysig_8h.html#ab4abb546445db7773e8a37f554c2de0b">RUBY_CRITICAL</a>({
<a name="l05686"></a>05686         <span class="keyword">const</span> <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> attr = GetFileAttributesW(path);
<a name="l05687"></a>05687         <span class="keywordflow">if</span> (attr != (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)-1 &amp;&amp; (attr &amp; FILE_ATTRIBUTE_READONLY)) {
<a name="l05688"></a>05688             SetFileAttributesW(path, attr &amp; ~FILE_ATTRIBUTE_READONLY);
<a name="l05689"></a>05689         }
<a name="l05690"></a>05690         <span class="keywordflow">if</span> (!DeleteFileW(path)) {
<a name="l05691"></a>05691             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../d5/df2/win32_8c.html#a3db6c94a84ecd99d770d807ea4ebf39d">map_errno</a>(GetLastError());
<a name="l05692"></a>05692             ret = -1;
<a name="l05693"></a>05693             <span class="keywordflow">if</span> (attr != (<a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a>)-1 &amp;&amp; (attr &amp; FILE_ATTRIBUTE_READONLY)) {
<a name="l05694"></a>05694                 SetFileAttributesW(path, attr);
<a name="l05695"></a>05695             }
<a name="l05696"></a>05696         }
<a name="l05697"></a>05697     });
<a name="l05698"></a>05698     <span class="keywordflow">return</span> ret;
<a name="l05699"></a>05699 }
<a name="l05700"></a>05700 
<a name="l05701"></a>05701 <span class="keywordtype">int</span>
<a name="l05702"></a><a class="code" href="../../d5/df2/win32_8c.html#ad604f8f64268d720de1cc982a856b9f0">05702</a> <a class="code" href="../../dc/db1/win32_8h.html#a995efcb30d3f067c7e25c8bd9f3d61aa">rb_w32_uunlink</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l05703"></a>05703 {
<a name="l05704"></a>05704     WCHAR *wpath;
<a name="l05705"></a>05705     <span class="keywordtype">int</span> ret;
<a name="l05706"></a>05706 
<a name="l05707"></a>05707     <span class="keywordflow">if</span> (!(wpath = <a class="code" href="../../d5/df2/win32_8c.html#a41003a1382888cc771e290746769eb13">utf8_to_wstr</a>(path, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l05708"></a>05708         <span class="keywordflow">return</span> -1;
<a name="l05709"></a>05709     ret = <a class="code" href="../../d5/df2/win32_8c.html#a5827d5053a21855ac68bd01e8c348f49">wunlink</a>(wpath);
<a name="l05710"></a>05710     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wpath);
<a name="l05711"></a>05711     <span class="keywordflow">return</span> ret;
<a name="l05712"></a>05712 }
<a name="l05713"></a>05713 
<a name="l05714"></a>05714 <span class="keywordtype">int</span>
<a name="l05715"></a><a class="code" href="../../d5/df2/win32_8c.html#a81464c187517f7470015b2721db47803">05715</a> <a class="code" href="../../dc/db1/win32_8h.html#a40c5bc86236c982946e02520c1e55b5c">rb_w32_unlink</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l05716"></a>05716 {
<a name="l05717"></a>05717     WCHAR *wpath;
<a name="l05718"></a>05718     <span class="keywordtype">int</span> ret;
<a name="l05719"></a>05719 
<a name="l05720"></a>05720     <span class="keywordflow">if</span> (!(wpath = <a class="code" href="../../d5/df2/win32_8c.html#ad33d311f649154599e920240e3900a59">filecp_to_wstr</a>(path, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l05721"></a>05721         <span class="keywordflow">return</span> -1;
<a name="l05722"></a>05722     ret = <a class="code" href="../../d5/df2/win32_8c.html#a5827d5053a21855ac68bd01e8c348f49">wunlink</a>(wpath);
<a name="l05723"></a>05723     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wpath);
<a name="l05724"></a>05724     <span class="keywordflow">return</span> ret;
<a name="l05725"></a>05725 }
<a name="l05726"></a>05726 
<a name="l05727"></a>05727 <span class="keywordtype">int</span>
<a name="l05728"></a><a class="code" href="../../d5/df2/win32_8c.html#a571a4be25649ebfae0444b9cc78d64e4">05728</a> <a class="code" href="../../dc/db1/win32_8h.html#a2cca3572ef20fd92a13c96c673f31ba0">rb_w32_uchmod</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> mode)
<a name="l05729"></a>05729 {
<a name="l05730"></a>05730     WCHAR *wpath;
<a name="l05731"></a>05731     <span class="keywordtype">int</span> ret;
<a name="l05732"></a>05732 
<a name="l05733"></a>05733     <span class="keywordflow">if</span> (!(wpath = <a class="code" href="../../d5/df2/win32_8c.html#a41003a1382888cc771e290746769eb13">utf8_to_wstr</a>(path, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)))
<a name="l05734"></a>05734         <span class="keywordflow">return</span> -1;
<a name="l05735"></a>05735     ret = _wchmod(wpath, mode);
<a name="l05736"></a>05736     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(wpath);
<a name="l05737"></a>05737     <span class="keywordflow">return</span> ret;
<a name="l05738"></a>05738 }
<a name="l05739"></a>05739 
<a name="l05740"></a>05740 <span class="preprocessor">#if !defined(__BORLANDC__)</span>
<a name="l05741"></a>05741 <span class="preprocessor"></span><span class="keywordtype">int</span>
<a name="l05742"></a><a class="code" href="../../d5/df2/win32_8c.html#a2f4a5cb02496aa390df5a650b4ba2cf2">05742</a> <a class="code" href="../../dc/db1/win32_8h.html#ae9638954c74179c02d7ee5f8634e9a96">rb_w32_isatty</a>(<span class="keywordtype">int</span> fd)
<a name="l05743"></a>05743 {
<a name="l05744"></a>05744     <a class="code" href="../../d2/d99/win32ole_8c.html#a2ec0aeb209eda20f4bef5d50ce5a7417">DWORD</a> mode;
<a name="l05745"></a>05745 
<a name="l05746"></a>05746     <span class="comment">// validate fd by using _get_osfhandle() because we cannot access _nhandle</span>
<a name="l05747"></a>05747     <span class="keywordflow">if</span> (_get_osfhandle(fd) == -1) {
<a name="l05748"></a>05748         <span class="keywordflow">return</span> 0;
<a name="l05749"></a>05749     }
<a name="l05750"></a>05750     <span class="keywordflow">if</span> (!GetConsoleMode((HANDLE)<a class="code" href="../../d5/df2/win32_8c.html#a072b7be0b12a98dedb1c280471cf47e2">_osfhnd</a>(fd), &amp;mode)) {
<a name="l05751"></a>05751         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ENOTTY;
<a name="l05752"></a>05752         <span class="keywordflow">return</span> 0;
<a name="l05753"></a>05753     }
<a name="l05754"></a>05754     <span class="keywordflow">return</span> 1;
<a name="l05755"></a>05755 }
<a name="l05756"></a>05756 <span class="preprocessor">#endif</span>
<a name="l05757"></a>05757 <span class="preprocessor"></span>
<a name="l05758"></a>05758 <span class="comment">//</span>
<a name="l05759"></a>05759 <span class="comment">// Fix bcc32&apos;s stdio bug</span>
<a name="l05760"></a>05760 <span class="comment">//</span>
<a name="l05761"></a>05761 
<a name="l05762"></a>05762 <span class="preprocessor">#ifdef __BORLANDC__</span>
<a name="l05763"></a>05763 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l05764"></a>05764 too_many_files(<span class="keywordtype">void</span>)
<a name="l05765"></a>05765 {
<a name="l05766"></a>05766     <a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *f;
<a name="l05767"></a>05767     <span class="keywordflow">for</span> (f = _streams; f &lt; _streams + _nfile; f++) {
<a name="l05768"></a>05768         <span class="keywordflow">if</span> (f-&gt;fd &lt; 0) <span class="keywordflow">return</span> 0;
<a name="l05769"></a>05769     }
<a name="l05770"></a>05770     <span class="keywordflow">return</span> 1;
<a name="l05771"></a>05771 }
<a name="l05772"></a>05772 
<a name="l05773"></a>05773 <span class="preprocessor">#undef fopen</span>
<a name="l05774"></a>05774 <span class="preprocessor"></span><a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *
<a name="l05775"></a>05775 rb_w32_fopen(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keyword">const</span> <span class="keywordtype">char</span> *mode)
<a name="l05776"></a>05776 {
<a name="l05777"></a>05777     <a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *f = (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0, fopen(path, mode));
<a name="l05778"></a>05778     <span class="keywordflow">if</span> (f == NULL &amp;&amp; errno == 0) {
<a name="l05779"></a>05779         <span class="keywordflow">if</span> (too_many_files())
<a name="l05780"></a>05780             errno = EMFILE;
<a name="l05781"></a>05781     }
<a name="l05782"></a>05782     <span class="keywordflow">return</span> f;
<a name="l05783"></a>05783 }
<a name="l05784"></a>05784 
<a name="l05785"></a>05785 <a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *
<a name="l05786"></a>05786 rb_w32_fdopen(<span class="keywordtype">int</span> handle, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>)
<a name="l05787"></a>05787 {
<a name="l05788"></a>05788     <a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *f = (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0, _fdopen(handle, (<span class="keywordtype">char</span> *)type));
<a name="l05789"></a>05789     <span class="keywordflow">if</span> (f == NULL &amp;&amp; errno == 0) {
<a name="l05790"></a>05790         <span class="keywordflow">if</span> (handle &lt; 0)
<a name="l05791"></a>05791             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EBADF;
<a name="l05792"></a>05792         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (too_many_files())
<a name="l05793"></a>05793             errno = EMFILE;
<a name="l05794"></a>05794     }
<a name="l05795"></a>05795     <span class="keywordflow">return</span> f;
<a name="l05796"></a>05796 }
<a name="l05797"></a>05797 
<a name="l05798"></a>05798 <a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *
<a name="l05799"></a>05799 rb_w32_fsopen(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keyword">const</span> <span class="keywordtype">char</span> *mode, <span class="keywordtype">int</span> shflags)
<a name="l05800"></a>05800 {
<a name="l05801"></a>05801     <a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *f = (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0, _fsopen(path, mode, shflags));
<a name="l05802"></a>05802     <span class="keywordflow">if</span> (f == NULL &amp;&amp; errno == 0) {
<a name="l05803"></a>05803         <span class="keywordflow">if</span> (too_many_files())
<a name="l05804"></a>05804             errno = EMFILE;
<a name="l05805"></a>05805     }
<a name="l05806"></a>05806     <span class="keywordflow">return</span> f;
<a name="l05807"></a>05807 }
<a name="l05808"></a>05808 <span class="preprocessor">#endif</span>
<a name="l05809"></a>05809 <span class="preprocessor"></span>
<a name="l05810"></a>05810 <span class="preprocessor">#if defined(_MSC_VER) &amp;&amp; RT_VER &lt;= 60</span>
<a name="l05811"></a>05811 <span class="preprocessor"></span><span class="keyword">extern</span> <span class="keywordtype">long</span> _ftol(<span class="keywordtype">double</span>);
<a name="l05812"></a>05812 <span class="keywordtype">long</span>
<a name="l05813"></a>05813 _ftol2(<span class="keywordtype">double</span> d)
<a name="l05814"></a>05814 {
<a name="l05815"></a>05815     <span class="keywordflow">return</span> _ftol(d);
<a name="l05816"></a>05816 }
<a name="l05817"></a>05817 <span class="keywordtype">long</span>
<a name="l05818"></a>05818 _ftol2_sse(<span class="keywordtype">double</span> d)
<a name="l05819"></a>05819 {
<a name="l05820"></a>05820     <span class="keywordflow">return</span> _ftol(d);
<a name="l05821"></a>05821 }
<a name="l05822"></a>05822 <span class="preprocessor">#endif</span>
<a name="l05823"></a>05823 <span class="preprocessor"></span>
<a name="l05824"></a>05824 <span class="preprocessor">#ifndef signbit</span>
<a name="l05825"></a>05825 <span class="preprocessor"></span><span class="keywordtype">int</span>
<a name="l05826"></a><a class="code" href="../../d5/df2/win32_8c.html#a884f85e61d7a91827e8b9b024e099261">05826</a> <a class="code" href="../../d3/d90/missing_8h.html#a67a4a1547ffbaeabfa58b9773d5bc9bc">signbit</a>(<span class="keywordtype">double</span> x)
<a name="l05827"></a>05827 {
<a name="l05828"></a>05828     <span class="keywordtype">int</span> *ip = (<span class="keywordtype">int</span> *)(&amp;x + 1) - 1;
<a name="l05829"></a>05829     <span class="keywordflow">return</span> *ip &lt; 0;
<a name="l05830"></a>05830 }
<a name="l05831"></a>05831 <span class="preprocessor">#endif</span>
<a name="l05832"></a>05832 <span class="preprocessor"></span>
<a name="l05833"></a>05833 <span class="keywordtype">char</span> * WSAAPI
<a name="l05834"></a><a class="code" href="../../d5/df2/win32_8c.html#aa4e3cad6cfdf3e9f4febfc608777fa31">05834</a> <a class="code" href="../../dc/db1/win32_8h.html#ae257cc8445fd30696ec0f081f58c3ac6">rb_w32_inet_ntop</a>(<span class="keywordtype">int</span> af, <span class="keywordtype">void</span> *addr, <span class="keywordtype">char</span> *numaddr, <span class="keywordtype">size_t</span> numaddr_len)
<a name="l05835"></a>05835 {
<a name="l05836"></a>05836     <span class="keyword">typedef</span> <span class="keywordtype">char</span> *(WSAAPI inet_ntop_t)(<span class="keywordtype">int</span>, <span class="keywordtype">void</span> *, <span class="keywordtype">char</span> *, <span class="keywordtype">size_t</span>);
<a name="l05837"></a>05837     inet_ntop_t *pInetNtop;
<a name="l05838"></a>05838     pInetNtop = (inet_ntop_t *)<a class="code" href="../../d5/df2/win32_8c.html#a8ab64e43a3bd89bcdebe1111534a0bfa">get_proc_address</a>(<span class="stringliteral">&quot;ws2_32&quot;</span>, <span class="stringliteral">&quot;inet_ntop&quot;</span>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05839"></a>05839     <span class="keywordflow">if</span>(pInetNtop){
<a name="l05840"></a>05840        <span class="keywordflow">return</span> pInetNtop(af,addr,numaddr,numaddr_len);
<a name="l05841"></a>05841     }<span class="keywordflow">else</span>{
<a name="l05842"></a>05842        <span class="keyword">struct </span>in_addr in;
<a name="l05843"></a>05843        memcpy(&amp;in.s_addr, addr, <span class="keyword">sizeof</span>(in.s_addr));
<a name="l05844"></a>05844        <a class="code" href="../../d7/d72/subst_8h.html#aa367b75c5aed883fef5befbdf04835a4">snprintf</a>(numaddr, numaddr_len, <span class="stringliteral">&quot;%s&quot;</span>, inet_ntoa(in));
<a name="l05845"></a>05845     }
<a name="l05846"></a>05846     <span class="keywordflow">return</span> numaddr;
<a name="l05847"></a>05847 }
<a name="l05848"></a>05848 
<a name="l05849"></a>05849 <span class="keywordtype">char</span>
<a name="l05850"></a><a class="code" href="../../d5/df2/win32_8c.html#a9250e3bd83ca870e79c7d3ad33e9d27e">05850</a> <a class="code" href="../../dc/db1/win32_8h.html#a19b8f86a8d75136012efa0bec39a169d">rb_w32_fd_is_text</a>(<span class="keywordtype">int</span> fd) {
<a name="l05851"></a>05851     <span class="keywordflow">return</span> <a class="code" href="../../d5/df2/win32_8c.html#a90ead473a170c01aed0fff5c736650f6">_osfile</a>(fd) &amp; <a class="code" href="../../d5/df2/win32_8c.html#ad16d3314e1ed1f0124d728efbd474ad4">FTEXT</a>;
<a name="l05852"></a>05852 }
<a name="l05853"></a>05853 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Mar 2013 for Ruby by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
