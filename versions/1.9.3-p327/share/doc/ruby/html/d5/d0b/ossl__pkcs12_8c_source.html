<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Ruby: ext/openssl/ossl_pkcs12.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>ext/openssl/ossl_pkcs12.c</h1><a href="../../d5/d0b/ossl__pkcs12_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * This program is licenced under the same licence as Ruby.</span>
<a name="l00003"></a>00003 <span class="comment"> * (See the file &apos;LICENCE&apos;.)</span>
<a name="l00004"></a>00004 <span class="comment"> * $Id: ossl_pkcs12.c 32199 2011-06-22 08:41:08Z emboss $</span>
<a name="l00005"></a>00005 <span class="comment"> */</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dac/ossl_8h.html">ossl.h</a>&quot;</span>
<a name="l00007"></a>00007 
<a name="l00008"></a><a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#ac01ac0ef8c6cb61c505b62b957490242">00008</a> <span class="preprocessor">#define WrapPKCS12(klass, obj, p12) do { \</span>
<a name="l00009"></a>00009 <span class="preprocessor">    if(!(p12)) ossl_raise(rb_eRuntimeError, &quot;PKCS12 wasn&apos;t initialized.&quot;); \</span>
<a name="l00010"></a>00010 <span class="preprocessor">    (obj) = Data_Wrap_Struct((klass), 0, PKCS12_free, (p12)); \</span>
<a name="l00011"></a>00011 <span class="preprocessor">} while (0)</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span>
<a name="l00013"></a><a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a2f255bd761caf7eb4a36f1f6084cd393">00013</a> <span class="preprocessor">#define GetPKCS12(obj, p12) do { \</span>
<a name="l00014"></a>00014 <span class="preprocessor">    Data_Get_Struct((obj), PKCS12, (p12)); \</span>
<a name="l00015"></a>00015 <span class="preprocessor">    if(!(p12)) ossl_raise(rb_eRuntimeError, &quot;PKCS12 wasn&apos;t initialized.&quot;); \</span>
<a name="l00016"></a>00016 <span class="preprocessor">} while (0)</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span>
<a name="l00018"></a><a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a66e3358174dd8deaa7a33c0955df792f">00018</a> <span class="preprocessor">#define SafeGetPKCS12(obj, p12) do { \</span>
<a name="l00019"></a>00019 <span class="preprocessor">    OSSL_Check_Kind((obj), cPKCS12); \</span>
<a name="l00020"></a>00020 <span class="preprocessor">    GetPKCS12((obj), (p12)); \</span>
<a name="l00021"></a>00021 <span class="preprocessor">} while (0)</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span>
<a name="l00023"></a><a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#aa6997cdd5db93145a109b03cbdbab712">00023</a> <span class="preprocessor">#define ossl_pkcs12_set_key(o,v)      rb_iv_set((o), &quot;@key&quot;, (v))</span>
<a name="l00024"></a><a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a5e35cc49a48f734313da273ac506cfa0">00024</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_pkcs12_set_cert(o,v)     rb_iv_set((o), &quot;@certificate&quot;, (v))</span>
<a name="l00025"></a><a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a364521724fb966e030821dfbd0bb9c98">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_pkcs12_set_ca_certs(o,v) rb_iv_set((o), &quot;@ca_certs&quot;, (v))</span>
<a name="l00026"></a><a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#aaa97fa2f6ecc8eb65c5020f9a97cff7f">00026</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_pkcs12_get_key(o)        rb_iv_get((o), &quot;@key&quot;)</span>
<a name="l00027"></a><a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a084c57cc7c5e14a03524d203cb24c649">00027</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_pkcs12_get_cert(o)       rb_iv_get((o), &quot;@certificate&quot;)</span>
<a name="l00028"></a><a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a61001297fc0e8db342729f8c9013f836">00028</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_pkcs12_get_ca_certs(o)   rb_iv_get((o), &quot;@ca_certs&quot;)</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span>
<a name="l00030"></a>00030 <span class="comment">/*</span>
<a name="l00031"></a>00031 <span class="comment"> * Classes</span>
<a name="l00032"></a>00032 <span class="comment"> */</span>
<a name="l00033"></a><a class="code" href="../../dd/dc6/ossl__pkcs12_8h.html#a04f7f6590f5359bc63d524a31b3230a1">00033</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a04f7f6590f5359bc63d524a31b3230a1">cPKCS12</a>;
<a name="l00034"></a><a class="code" href="../../dd/dc6/ossl__pkcs12_8h.html#a412ac40becdf0c63988e5d4d3dc76db4">00034</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a412ac40becdf0c63988e5d4d3dc76db4">ePKCS12Error</a>;
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="comment">/*</span>
<a name="l00037"></a>00037 <span class="comment"> * Private</span>
<a name="l00038"></a>00038 <span class="comment"> */</span>
<a name="l00039"></a>00039 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00040"></a><a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a24c909631e21916ac9645de2cf16187c">00040</a> <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a24c909631e21916ac9645de2cf16187c">ossl_pkcs12_s_allocate</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass)
<a name="l00041"></a>00041 {
<a name="l00042"></a>00042     PKCS12 *p12;
<a name="l00043"></a>00043     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj;
<a name="l00044"></a>00044 
<a name="l00045"></a>00045     <span class="keywordflow">if</span>(!(p12 = PKCS12_new())) <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a412ac40becdf0c63988e5d4d3dc76db4">ePKCS12Error</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00046"></a>00046     <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#ac01ac0ef8c6cb61c505b62b957490242">WrapPKCS12</a>(klass, obj, p12);
<a name="l00047"></a>00047 
<a name="l00048"></a>00048     <span class="keywordflow">return</span> obj;
<a name="l00049"></a>00049 }
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="comment">/*</span>
<a name="l00052"></a>00052 <span class="comment"> * call-seq:</span>
<a name="l00053"></a>00053 <span class="comment"> *    PKCS12.create(pass, name, key, cert [, ca, [, key_pbe [, cert_pbe [, key_iter [, mac_iter [, keytype]]]]]])</span>
<a name="l00054"></a>00054 <span class="comment"> *</span>
<a name="l00055"></a>00055 <span class="comment"> * === Parameters</span>
<a name="l00056"></a>00056 <span class="comment"> * * +pass+ - string</span>
<a name="l00057"></a>00057 <span class="comment"> * * +name+ - A string describing the key.</span>
<a name="l00058"></a>00058 <span class="comment"> * * +key+ - Any PKey.</span>
<a name="l00059"></a>00059 <span class="comment"> * * +cert+ - A X509::Certificate.</span>
<a name="l00060"></a>00060 <span class="comment"> * * * The public_key portion of the certificate must contain a valid public key.</span>
<a name="l00061"></a>00061 <span class="comment"> * * * The not_before and not_after fields must be filled in.</span>
<a name="l00062"></a>00062 <span class="comment"> * * +ca+ - An optional array of X509::Certificate&apos;s.</span>
<a name="l00063"></a>00063 <span class="comment"> * * +key_pbe+ - string</span>
<a name="l00064"></a>00064 <span class="comment"> * * +cert_pbe+ - string</span>
<a name="l00065"></a>00065 <span class="comment"> * * +key_iter+ - integer</span>
<a name="l00066"></a>00066 <span class="comment"> * * +mac_iter+ - integer</span>
<a name="l00067"></a>00067 <span class="comment"> * * +keytype+ - An integer representing an MSIE specific extension.</span>
<a name="l00068"></a>00068 <span class="comment"> *</span>
<a name="l00069"></a>00069 <span class="comment"> * Any optional arguments may be supplied as nil to preserve the OpenSSL defaults.</span>
<a name="l00070"></a>00070 <span class="comment"> *</span>
<a name="l00071"></a>00071 <span class="comment"> * See the OpenSSL documentation for PKCS12_create().</span>
<a name="l00072"></a>00072 <span class="comment"> */</span>
<a name="l00073"></a>00073 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00074"></a><a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a3b845b1b307ac9a0253a773add3cadb2">00074</a> <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a3b845b1b307ac9a0253a773add3cadb2">ossl_pkcs12_s_create</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l00075"></a>00075 {
<a name="l00076"></a>00076     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> pass, <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, pkey, cert, ca, key_nid, cert_nid, key_iter, mac_iter, keytype;
<a name="l00077"></a>00077     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj;
<a name="l00078"></a>00078     <span class="keywordtype">char</span> *passphrase, *friendlyname;
<a name="l00079"></a>00079     EVP_PKEY *<a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>;
<a name="l00080"></a>00080     X509 *x509;
<a name="l00081"></a>00081     <a class="code" href="../../d5/dac/ossl_8h.html#afdc9179e243623337e07f01bf1404a8c">STACK_OF</a>(X509) *x509s;
<a name="l00082"></a>00082     <span class="keywordtype">int</span> nkey = 0, ncert = 0, kiter = 0, miter = 0, ktype = 0;
<a name="l00083"></a>00083     PKCS12 *p12;
<a name="l00084"></a>00084 
<a name="l00085"></a>00085     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;46&quot;</span>, &amp;pass, &amp;name, &amp;pkey, &amp;cert, &amp;ca, &amp;key_nid, &amp;cert_nid, &amp;key_iter, &amp;mac_iter, &amp;keytype);
<a name="l00086"></a>00086     passphrase = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(pass) ? <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2665a51abbd5b49c15abff3df00fa9db">StringValuePtr</a>(pass);
<a name="l00087"></a>00087     friendlyname = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(name) ? <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2665a51abbd5b49c15abff3df00fa9db">StringValuePtr</a>(name);
<a name="l00088"></a>00088     key = <a class="code" href="../../d1/df0/ossl__pkey_8c.html#a53f3f8bd4cdc335d16faaaa63f2e76da">GetPKeyPtr</a>(pkey);
<a name="l00089"></a>00089     x509 = <a class="code" href="../../d3/da1/ossl__x509_8h.html#a55515b14c48c1afa36b99c1f5c6cc38d">GetX509CertPtr</a>(cert);
<a name="l00090"></a>00090     x509s = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(ca) ? <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> : ossl_x509_ary2sk(ca);
<a name="l00091"></a>00091 <span class="comment">/* TODO: make a VALUE to nid function */</span>
<a name="l00092"></a>00092     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(key_nid)) {
<a name="l00093"></a>00093         <span class="keywordflow">if</span> ((nkey = OBJ_txt2nid(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2665a51abbd5b49c15abff3df00fa9db">StringValuePtr</a>(key_nid))) == NID_undef)
<a name="l00094"></a>00094             <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;Unknown PBE algorithm %s&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2665a51abbd5b49c15abff3df00fa9db">StringValuePtr</a>(key_nid));
<a name="l00095"></a>00095     }
<a name="l00096"></a>00096     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(cert_nid)) {
<a name="l00097"></a>00097         <span class="keywordflow">if</span> ((ncert = OBJ_txt2nid(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2665a51abbd5b49c15abff3df00fa9db">StringValuePtr</a>(cert_nid))) == NID_undef)
<a name="l00098"></a>00098             <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;Unknown PBE algorithm %s&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2665a51abbd5b49c15abff3df00fa9db">StringValuePtr</a>(cert_nid));
<a name="l00099"></a>00099     }
<a name="l00100"></a>00100     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(key_iter))
<a name="l00101"></a>00101         kiter = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(key_iter);
<a name="l00102"></a>00102     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(mac_iter))
<a name="l00103"></a>00103         miter = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(mac_iter);
<a name="l00104"></a>00104     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(keytype))
<a name="l00105"></a>00105         ktype = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(keytype);
<a name="l00106"></a>00106 
<a name="l00107"></a>00107     p12 = PKCS12_create(passphrase, friendlyname, key, x509, x509s,
<a name="l00108"></a>00108                         nkey, ncert, kiter, miter, ktype);
<a name="l00109"></a>00109     sk_X509_pop_free(x509s, X509_free);
<a name="l00110"></a>00110     <span class="keywordflow">if</span>(!p12) <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a412ac40becdf0c63988e5d4d3dc76db4">ePKCS12Error</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00111"></a>00111     <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#ac01ac0ef8c6cb61c505b62b957490242">WrapPKCS12</a>(<a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a04f7f6590f5359bc63d524a31b3230a1">cPKCS12</a>, obj, p12);
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#aa6997cdd5db93145a109b03cbdbab712">ossl_pkcs12_set_key</a>(obj, pkey);
<a name="l00114"></a>00114     <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a5e35cc49a48f734313da273ac506cfa0">ossl_pkcs12_set_cert</a>(obj, cert);
<a name="l00115"></a>00115     <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a364521724fb966e030821dfbd0bb9c98">ossl_pkcs12_set_ca_certs</a>(obj, ca);
<a name="l00116"></a>00116 
<a name="l00117"></a>00117     <span class="keywordflow">return</span> obj;
<a name="l00118"></a>00118 }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 <span class="comment">/*</span>
<a name="l00121"></a>00121 <span class="comment"> * call-seq:</span>
<a name="l00122"></a>00122 <span class="comment"> *    PKCS12.new -&gt; pkcs12</span>
<a name="l00123"></a>00123 <span class="comment"> *    PKCS12.new(str) -&gt; pkcs12</span>
<a name="l00124"></a>00124 <span class="comment"> *    PKCS12.new(str, pass) -&gt; pkcs12</span>
<a name="l00125"></a>00125 <span class="comment"> *</span>
<a name="l00126"></a>00126 <span class="comment"> * === Parameters</span>
<a name="l00127"></a>00127 <span class="comment"> * * +str+ - Must be a DER encoded PKCS12 string.</span>
<a name="l00128"></a>00128 <span class="comment"> * * +pass+ - string</span>
<a name="l00129"></a>00129 <span class="comment"> */</span>
<a name="l00130"></a>00130 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00131"></a><a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a485650dc3f6a33ee0daa061f5945d2ad">00131</a> <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a485650dc3f6a33ee0daa061f5945d2ad">ossl_pkcs12_initialize</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133     BIO *in;
<a name="l00134"></a>00134     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg, pass, pkey, cert, ca;
<a name="l00135"></a>00135     <span class="keywordtype">char</span> *passphrase;
<a name="l00136"></a>00136     EVP_PKEY *<a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>;
<a name="l00137"></a>00137     X509 *x509;
<a name="l00138"></a>00138     <a class="code" href="../../d5/dac/ossl_8h.html#afdc9179e243623337e07f01bf1404a8c">STACK_OF</a>(X509) *x509s = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00139"></a>00139     <span class="keywordtype">int</span> st = 0;
<a name="l00140"></a>00140     PKCS12 *pkcs = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abb509cfdf6560a9f795b1f6932d93691">DATA_PTR</a>(<span class="keyword">self</span>);
<a name="l00141"></a>00141 
<a name="l00142"></a>00142     <span class="keywordflow">if</span>(<a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;02&quot;</span>, &amp;arg, &amp;pass) == 0) <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l00143"></a>00143     passphrase = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(pass) ? <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2665a51abbd5b49c15abff3df00fa9db">StringValuePtr</a>(pass);
<a name="l00144"></a>00144     in = <a class="code" href="../../d8/d44/ossl__bio_8c.html#a9d80ad383915c7bff6492ba5de6916c7">ossl_obj2bio</a>(arg);
<a name="l00145"></a>00145     d2i_PKCS12_bio(in, &amp;pkcs);
<a name="l00146"></a>00146     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abb509cfdf6560a9f795b1f6932d93691">DATA_PTR</a>(<span class="keyword">self</span>) = pkcs;
<a name="l00147"></a>00147     BIO_free(in);
<a name="l00148"></a>00148 
<a name="l00149"></a>00149     pkey = cert = ca = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00150"></a>00150     <span class="keywordflow">if</span>(!PKCS12_parse(pkcs, passphrase, &amp;key, &amp;x509, &amp;x509s))
<a name="l00151"></a>00151         <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a412ac40becdf0c63988e5d4d3dc76db4">ePKCS12Error</a>, <span class="stringliteral">&quot;PKCS12_parse&quot;</span>);
<a name="l00152"></a>00152     pkey = <a class="code" href="../../d3/d57/eval_8c.html#a6aa7fb1169ed41978a16375b6f921b0e">rb_protect</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>(*)<a class="code" href="../../df/da8/dln_8h.html#a10087a068d10eaadb8f9bb9200cd619a">_</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)))<a class="code" href="../../d1/df0/ossl__pkey_8c.html#adccca3ae08164929e686269feab5ac75">ossl_pkey_new</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)key,
<a name="l00153"></a>00153                       &amp;st); <span class="comment">/* NO DUP */</span>
<a name="l00154"></a>00154     <span class="keywordflow">if</span>(st) <span class="keywordflow">goto</span> <a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a>;
<a name="l00155"></a>00155     cert = <a class="code" href="../../d3/d57/eval_8c.html#a6aa7fb1169ed41978a16375b6f921b0e">rb_protect</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>(*)<a class="code" href="../../df/da8/dln_8h.html#a10087a068d10eaadb8f9bb9200cd619a">_</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)))<a class="code" href="../../d3/da1/ossl__x509_8h.html#a184d6a1deb119e3bcf024e29f5da20b8">ossl_x509_new</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)x509, &amp;st);
<a name="l00156"></a>00156     <span class="keywordflow">if</span>(st) <span class="keywordflow">goto</span> <a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a>;
<a name="l00157"></a>00157     <span class="keywordflow">if</span>(x509s){
<a name="l00158"></a>00158         ca =
<a name="l00159"></a>00159             <a class="code" href="../../d3/d57/eval_8c.html#a6aa7fb1169ed41978a16375b6f921b0e">rb_protect</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>(*)<a class="code" href="../../df/da8/dln_8h.html#a10087a068d10eaadb8f9bb9200cd619a">_</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)))<a class="code" href="../../d5/dac/ossl_8h.html#a37a341591470799ab2fe739e28996b53">ossl_x509_sk2ary</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)x509s, &amp;st);
<a name="l00160"></a>00160         <span class="keywordflow">if</span>(st) <span class="keywordflow">goto</span> <a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a>;
<a name="l00161"></a>00161     }
<a name="l00162"></a>00162 
<a name="l00163"></a>00163   <a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a>:
<a name="l00164"></a>00164     X509_free(x509);
<a name="l00165"></a>00165     sk_X509_pop_free(x509s, X509_free);
<a name="l00166"></a>00166     <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#aa6997cdd5db93145a109b03cbdbab712">ossl_pkcs12_set_key</a>(<span class="keyword">self</span>, pkey);
<a name="l00167"></a>00167     <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a5e35cc49a48f734313da273ac506cfa0">ossl_pkcs12_set_cert</a>(<span class="keyword">self</span>, cert);
<a name="l00168"></a>00168     <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a364521724fb966e030821dfbd0bb9c98">ossl_pkcs12_set_ca_certs</a>(<span class="keyword">self</span>, ca);
<a name="l00169"></a>00169     <span class="keywordflow">if</span>(st) <a class="code" href="../../d3/d57/eval_8c.html#ae48d70c45901eab8b89fb181fc9d1f3b">rb_jump_tag</a>(st);
<a name="l00170"></a>00170 
<a name="l00171"></a>00171     <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l00172"></a>00172 }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00175"></a><a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#ae8542d1649d7d9bd543d17079f5da68c">00175</a> <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#ae8542d1649d7d9bd543d17079f5da68c">ossl_pkcs12_to_der</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l00176"></a>00176 {
<a name="l00177"></a>00177     PKCS12 *p12;
<a name="l00178"></a>00178     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str;
<a name="l00179"></a>00179     <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l00180"></a>00180     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p;
<a name="l00181"></a>00181 
<a name="l00182"></a>00182     <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a2f255bd761caf7eb4a36f1f6084cd393">GetPKCS12</a>(<span class="keyword">self</span>, p12);
<a name="l00183"></a>00183     <span class="keywordflow">if</span>((len = i2d_PKCS12(p12, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)) &lt;= 0)
<a name="l00184"></a>00184         <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a412ac40becdf0c63988e5d4d3dc76db4">ePKCS12Error</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00185"></a>00185     str = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(0, len);
<a name="l00186"></a>00186     p = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str);
<a name="l00187"></a>00187     <span class="keywordflow">if</span>(i2d_PKCS12(p12, &amp;p) &lt;= 0)
<a name="l00188"></a>00188         <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a412ac40becdf0c63988e5d4d3dc76db4">ePKCS12Error</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00189"></a>00189     <a class="code" href="../../d5/dac/ossl_8h.html#a431715aee3496301a0a7bcbc760928e2">ossl_str_adjust</a>(str, p);
<a name="l00190"></a>00190 
<a name="l00191"></a>00191     <span class="keywordflow">return</span> str;
<a name="l00192"></a>00192 }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194 <span class="keywordtype">void</span>
<a name="l00195"></a><a class="code" href="../../dd/dc6/ossl__pkcs12_8h.html#a83a44baab2697aad96fb452ffaa8bad0">00195</a> <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a05d86b6dc82dbb56fb7c2fb6782343f6">Init_ossl_pkcs12</a>()
<a name="l00196"></a>00196 {
<a name="l00197"></a>00197     <span class="comment">/*</span>
<a name="l00198"></a>00198 <span class="comment">     * Defines a file format commonly used to store private keys with</span>
<a name="l00199"></a>00199 <span class="comment">     * accompanying public key certificates, protected with a password-based</span>
<a name="l00200"></a>00200 <span class="comment">     * symmetric key.</span>
<a name="l00201"></a>00201 <span class="comment">     */</span>
<a name="l00202"></a>00202     <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a04f7f6590f5359bc63d524a31b3230a1">cPKCS12</a> = <a class="code" href="../../de/ddf/group__class.html#ga5266deadce0318d830a1e63c0933b898" title="Defines a class under the namespace of outer.">rb_define_class_under</a>(<a class="code" href="../../d4/d3c/ossl_8c.html#a19a5e8aeedd7c99b95bb894a7663fcb9">mOSSL</a>, <span class="stringliteral">&quot;PKCS12&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a57c96ead3ef230b4838e65fe037c346e">rb_cObject</a>);
<a name="l00203"></a>00203     <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a412ac40becdf0c63988e5d4d3dc76db4">ePKCS12Error</a> = <a class="code" href="../../de/ddf/group__class.html#ga5266deadce0318d830a1e63c0933b898" title="Defines a class under the namespace of outer.">rb_define_class_under</a>(<a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a04f7f6590f5359bc63d524a31b3230a1">cPKCS12</a>, <span class="stringliteral">&quot;PKCS12Error&quot;</span>, <a class="code" href="../../d4/d3c/ossl_8c.html#aea0de3b19cf8085effab72943bddc56e">eOSSLError</a>);
<a name="l00204"></a>00204     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a04f7f6590f5359bc63d524a31b3230a1">cPKCS12</a>, <span class="stringliteral">&quot;create&quot;</span>, <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a3b845b1b307ac9a0253a773add3cadb2">ossl_pkcs12_s_create</a>, -1);
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <a class="code" href="../../db/d2e/intern_8h.html#a6c99ed7f070458b961026d43d27d0642">rb_define_alloc_func</a>(<a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a04f7f6590f5359bc63d524a31b3230a1">cPKCS12</a>, <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a24c909631e21916ac9645de2cf16187c">ossl_pkcs12_s_allocate</a>);
<a name="l00207"></a>00207     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a04f7f6590f5359bc63d524a31b3230a1">cPKCS12</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;key&quot;</span>), 1, 0, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l00208"></a>00208     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a04f7f6590f5359bc63d524a31b3230a1">cPKCS12</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;certificate&quot;</span>), 1, 0, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l00209"></a>00209     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a04f7f6590f5359bc63d524a31b3230a1">cPKCS12</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;ca_certs&quot;</span>), 1, 0, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l00210"></a>00210     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a04f7f6590f5359bc63d524a31b3230a1">cPKCS12</a>, <span class="stringliteral">&quot;initialize&quot;</span>, <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a485650dc3f6a33ee0daa061f5945d2ad">ossl_pkcs12_initialize</a>, -1);
<a name="l00211"></a>00211     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#a04f7f6590f5359bc63d524a31b3230a1">cPKCS12</a>, <span class="stringliteral">&quot;to_der&quot;</span>, <a class="code" href="../../d5/d0b/ossl__pkcs12_8c.html#ae8542d1649d7d9bd543d17079f5da68c">ossl_pkcs12_to_der</a>, 0);
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Mar 2013 for Ruby by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
