<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Ruby: ext/openssl/ossl_ssl.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>ext/openssl/ossl_ssl.c</h1><a href="../../dc/dd1/ossl__ssl_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * $Id: ossl_ssl.c 34524 2012-02-09 17:04:41Z emboss $</span>
<a name="l00003"></a>00003 <span class="comment"> * &apos;OpenSSL for Ruby&apos; project</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 2000-2002  GOTOU Yuuzou &lt;gotoyuzo@notwork.org&gt;</span>
<a name="l00005"></a>00005 <span class="comment"> * Copyright (C) 2001-2002  Michal Rokos &lt;m.rokos@sh.cvut.cz&gt;</span>
<a name="l00006"></a>00006 <span class="comment"> * Copyright (C) 2001-2007  Technorama Ltd. &lt;oss-ruby@technorama.net&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> * All rights reserved.</span>
<a name="l00008"></a>00008 <span class="comment"> */</span>
<a name="l00009"></a>00009 <span class="comment">/*</span>
<a name="l00010"></a>00010 <span class="comment"> * This program is licenced under the same licence as Ruby.</span>
<a name="l00011"></a>00011 <span class="comment"> * (See the file &apos;LICENCE&apos;.)</span>
<a name="l00012"></a>00012 <span class="comment"> */</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/dac/ossl_8h.html">ossl.h</a>&quot;</span>
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="preprocessor">#if defined(HAVE_UNISTD_H)</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span><span class="preprocessor">#  include &lt;unistd.h&gt;</span> <span class="comment">/* for read(), and write() */</span>
<a name="l00017"></a>00017 <span class="preprocessor">#endif</span>
<a name="l00018"></a>00018 <span class="preprocessor"></span>
<a name="l00019"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4a2674d41b5b6475f47df2e14782e7fd">00019</a> <span class="preprocessor">#define numberof(ary) (int)(sizeof(ary)/sizeof((ary)[0]))</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span>
<a name="l00021"></a>00021 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span><span class="preprocessor">#  define TO_SOCKET(s) _get_osfhandle(s)</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00024"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">00024</a> <span class="preprocessor"></span><span class="preprocessor">#  define TO_SOCKET(s) (s)</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span>
<a name="l00027"></a><a class="code" href="../../d6/d43/ossl__ssl_8h.html#a1a50f2b264a326ebc8f9920f504bafca">00027</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a1a50f2b264a326ebc8f9920f504bafca">mSSL</a>;
<a name="l00028"></a><a class="code" href="../../d6/d43/ossl__ssl_8h.html#aaddd3f0e816a05c29463ce994f6bdb62">00028</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>;
<a name="l00029"></a><a class="code" href="../../d6/d43/ossl__ssl_8h.html#a39b1539ca074b4dd907ca7d916711d09">00029</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>;
<a name="l00030"></a><a class="code" href="../../d6/d43/ossl__ssl_8h.html#a8e2efd629e0dd3a51cd973477bb1f050">00030</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>;
<a name="l00031"></a>00031 
<a name="l00032"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a97bb295213b9c5d7dfba0ebe6daaf9a2">00032</a> <span class="preprocessor">#define ossl_sslctx_set_cert(o,v)        rb_iv_set((o),&quot;@cert&quot;,(v))</span>
<a name="l00033"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a05b8395893d59bfa87f94ea48e8de717">00033</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_set_key(o,v)         rb_iv_set((o),&quot;@key&quot;,(v))</span>
<a name="l00034"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#abe0d701b7a1fb484942ec170fac61cb2">00034</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_set_client_ca(o,v)   rb_iv_set((o),&quot;@client_ca&quot;,(v))</span>
<a name="l00035"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#af59fb566bcf941118c6977f118272dc9">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_set_ca_file(o,v)     rb_iv_set((o),&quot;@ca_file&quot;,(v))</span>
<a name="l00036"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a2ba2a3ba178f2e459aab5551616ce5ab">00036</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_set_ca_path(o,v)     rb_iv_set((o),&quot;@ca_path&quot;,(v))</span>
<a name="l00037"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aff7f0a44736af13aed395d12c94b8932">00037</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_set_timeout(o,v)     rb_iv_set((o),&quot;@timeout&quot;,(v))</span>
<a name="l00038"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a7a2538d85846e4f38ed31d1e9a545857">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_set_verify_mode(o,v) rb_iv_set((o),&quot;@verify_mode&quot;,(v))</span>
<a name="l00039"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a1b265a60dd68ad56343470f01d98c3b6">00039</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_set_verify_dep(o,v)  rb_iv_set((o),&quot;@verify_depth&quot;,(v))</span>
<a name="l00040"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a0005bada39a8788643990abfbafd8891">00040</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_set_verify_cb(o,v)   rb_iv_set((o),&quot;@verify_callback&quot;,(v))</span>
<a name="l00041"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a082639efd86358f30d3628950f64e229">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_set_options(o,v)     rb_iv_set((o),&quot;@options&quot;,(v))</span>
<a name="l00042"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaec3f3be501ba79708653b7a171c8852">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_set_cert_store(o,v)  rb_iv_set((o),&quot;@cert_store&quot;,(v))</span>
<a name="l00043"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#af8ce41a1cfe953aa69087e425e1b0f6f">00043</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_set_extra_cert(o,v)  rb_iv_set((o),&quot;@extra_chain_cert&quot;,(v))</span>
<a name="l00044"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aca8b6d768bad2349c899f32a7d11523a">00044</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_set_client_cert_cb(o,v) rb_iv_set((o),&quot;@client_cert_cb&quot;,(v))</span>
<a name="l00045"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a108216cda928f8c2fb5a12e527f89a54">00045</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_set_tmp_dh_cb(o,v)   rb_iv_set((o),&quot;@tmp_dh_callback&quot;,(v))</span>
<a name="l00046"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3cbdf4fa26cc7477f3971b63ff143937">00046</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_set_sess_id_ctx(o, v) rb_iv_get((o),&quot;@session_id_context&quot;(v))</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span>
<a name="l00048"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a7b2bf221f148fe933e5fc34f04a19668">00048</a> <span class="preprocessor">#define ossl_sslctx_get_cert(o)          rb_iv_get((o),&quot;@cert&quot;)</span>
<a name="l00049"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ae83ec2cb54d4893a6cf1fcd42698445c">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_get_key(o)           rb_iv_get((o),&quot;@key&quot;)</span>
<a name="l00050"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac8a5a1026e7b5753a3d9199e808b0333">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_get_client_ca(o)     rb_iv_get((o),&quot;@client_ca&quot;)</span>
<a name="l00051"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaf5865bdc04646bea192cf2900a12ef6">00051</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_get_ca_file(o)       rb_iv_get((o),&quot;@ca_file&quot;)</span>
<a name="l00052"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa758d07e2e1aaa6788f9862ad3caae32">00052</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_get_ca_path(o)       rb_iv_get((o),&quot;@ca_path&quot;)</span>
<a name="l00053"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#abdab56f62d167c25d2ace16bdcd94a11">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_get_timeout(o)       rb_iv_get((o),&quot;@timeout&quot;)</span>
<a name="l00054"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a931b2ba7eefcf64cdc616471a2e90535">00054</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_get_verify_mode(o)   rb_iv_get((o),&quot;@verify_mode&quot;)</span>
<a name="l00055"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a155c6f87c8aa46afd68504e671d423f6">00055</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_get_verify_dep(o)    rb_iv_get((o),&quot;@verify_depth&quot;)</span>
<a name="l00056"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ae99561e321fe7e94c26f7ec64a349e6f">00056</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_get_verify_cb(o)     rb_iv_get((o),&quot;@verify_callback&quot;)</span>
<a name="l00057"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a10e09afba71f9c132d3aeae0c5932c28">00057</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_get_options(o)       rb_iv_get((o),&quot;@options&quot;)</span>
<a name="l00058"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a89833107651e8d088fce43ce090458a7">00058</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_get_cert_store(o)    rb_iv_get((o),&quot;@cert_store&quot;)</span>
<a name="l00059"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#abee8ae69d9430f3caec0f7835d642da8">00059</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_get_extra_cert(o)    rb_iv_get((o),&quot;@extra_chain_cert&quot;)</span>
<a name="l00060"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac394fa7178094ea01cb9a542f2029186">00060</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_get_client_cert_cb(o) rb_iv_get((o),&quot;@client_cert_cb&quot;)</span>
<a name="l00061"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a13e3d231cd90b2bd6acb78ad87703ee4">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_get_tmp_dh_cb(o)     rb_iv_get((o),&quot;@tmp_dh_callback&quot;)</span>
<a name="l00062"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a54bc993206b0cd89221acc9ef401d9e0">00062</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_sslctx_get_sess_id_ctx(o)   rb_iv_get((o),&quot;@session_id_context&quot;)</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>
<a name="l00064"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5ae403957d62ab583a9a4e1b2432b413">00064</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5ae403957d62ab583a9a4e1b2432b413">ossl_sslctx_attrs</a>[] = {
<a name="l00065"></a>00065     <span class="stringliteral">&quot;cert&quot;</span>, <span class="stringliteral">&quot;key&quot;</span>, <span class="stringliteral">&quot;client_ca&quot;</span>, <span class="stringliteral">&quot;ca_file&quot;</span>, <span class="stringliteral">&quot;ca_path&quot;</span>,
<a name="l00066"></a>00066     <span class="stringliteral">&quot;timeout&quot;</span>, <span class="stringliteral">&quot;verify_mode&quot;</span>, <span class="stringliteral">&quot;verify_depth&quot;</span>,
<a name="l00067"></a>00067     <span class="stringliteral">&quot;verify_callback&quot;</span>, <span class="stringliteral">&quot;options&quot;</span>, <span class="stringliteral">&quot;cert_store&quot;</span>, <span class="stringliteral">&quot;extra_chain_cert&quot;</span>,
<a name="l00068"></a>00068     <span class="stringliteral">&quot;client_cert_cb&quot;</span>, <span class="stringliteral">&quot;tmp_dh_callback&quot;</span>, <span class="stringliteral">&quot;session_id_context&quot;</span>,
<a name="l00069"></a>00069     <span class="stringliteral">&quot;session_get_cb&quot;</span>, <span class="stringliteral">&quot;session_new_cb&quot;</span>, <span class="stringliteral">&quot;session_remove_cb&quot;</span>,
<a name="l00070"></a>00070 <span class="preprocessor">#ifdef HAVE_SSL_SET_TLSEXT_HOST_NAME</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>    <span class="stringliteral">&quot;servername_cb&quot;</span>,
<a name="l00072"></a>00072 <span class="preprocessor">#endif</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>};
<a name="l00074"></a>00074 
<a name="l00075"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a98c4ad64d4c521ae11e9f683e4ee1ee4">00075</a> <span class="preprocessor">#define ossl_ssl_get_io(o)           rb_iv_get((o),&quot;@io&quot;)</span>
<a name="l00076"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa73bafb5706de8b7d1935a999154bd44">00076</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_ssl_get_ctx(o)          rb_iv_get((o),&quot;@context&quot;)</span>
<a name="l00077"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3c0cac493742b64fd81feb634e972194">00077</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_ssl_get_sync_close(o)   rb_iv_get((o),&quot;@sync_close&quot;)</span>
<a name="l00078"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3a31e5605c1f61fd48a7b0cb71c77d17">00078</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_ssl_get_x509(o)         rb_iv_get((o),&quot;@x509&quot;)</span>
<a name="l00079"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a6e78813264108fa71cbe726a9916a423">00079</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_ssl_get_key(o)          rb_iv_get((o),&quot;@key&quot;)</span>
<a name="l00080"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a56650d6ac203d59afbd0bd7e59c3c57e">00080</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_ssl_get_tmp_dh(o)       rb_iv_get((o),&quot;@tmp_dh&quot;)</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span>
<a name="l00082"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a54b5c781ff92bd6866ee9a29393d49a7">00082</a> <span class="preprocessor">#define ossl_ssl_set_io(o,v)         rb_iv_set((o),&quot;@io&quot;,(v))</span>
<a name="l00083"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a11ce601a226355c361beb71d991d5280">00083</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_ssl_set_ctx(o,v)        rb_iv_set((o),&quot;@context&quot;,(v))</span>
<a name="l00084"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a0f1610b40201c60d82658d6349d29ecd">00084</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_ssl_set_sync_close(o,v) rb_iv_set((o),&quot;@sync_close&quot;,(v))</span>
<a name="l00085"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a1c29c56ece1c74c11ce1d9ceb7d04077">00085</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_ssl_set_x509(o,v)       rb_iv_set((o),&quot;@x509&quot;,(v))</span>
<a name="l00086"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8db20bf2431993d2e08bf69969a02112">00086</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_ssl_set_key(o,v)        rb_iv_set((o),&quot;@key&quot;,(v))</span>
<a name="l00087"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a9c9755838b4f2c55845c824e73875eb4">00087</a> <span class="preprocessor"></span><span class="preprocessor">#define ossl_ssl_set_tmp_dh(o,v)     rb_iv_set((o),&quot;@tmp_dh&quot;,(v))</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span>
<a name="l00089"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a02caefbd07ae556c8228598db1740394">00089</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a02caefbd07ae556c8228598db1740394">ossl_ssl_attr_readers</a>[] = { <span class="stringliteral">&quot;io&quot;</span>, <span class="stringliteral">&quot;context&quot;</span>, };
<a name="l00090"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5582a20bc90c9fc49657d33bf3a187c8">00090</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5582a20bc90c9fc49657d33bf3a187c8">ossl_ssl_attrs</a>[] = {
<a name="l00091"></a>00091 <span class="preprocessor">#ifdef HAVE_SSL_SET_TLSEXT_HOST_NAME</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span>    <span class="stringliteral">&quot;hostname&quot;</span>,
<a name="l00093"></a>00093 <span class="preprocessor">#endif</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span>    <span class="stringliteral">&quot;sync_close&quot;</span>,
<a name="l00095"></a>00095 };
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a03b3aad781a6c9b2f9b8a7f3c319f97e">00097</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a03b3aad781a6c9b2f9b8a7f3c319f97e">ID_callback_state</a>;
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="comment">/*</span>
<a name="l00100"></a>00100 <span class="comment"> * SSLContext class</span>
<a name="l00101"></a>00101 <span class="comment"> */</span>
<a name="l00102"></a>00102 <span class="keyword">struct </span>{
<a name="l00103"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8f8f80d37794cde9472343e4487ba3eb">00103</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>;
<a name="l00104"></a>00104     SSL_METHOD *(*func)(void);
<a name="l00105"></a>00105 } <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aba4cc5eb530917e91bf5b03c9c3231e9">ossl_ssl_method_tab</a>[] = {
<a name="l00106"></a>00106 <span class="preprocessor">#define OSSL_SSL_METHOD_ENTRY(name) { #name, (SSL_METHOD *(*)(void))name##_method }</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span>    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5644064c8581407ff69ad5da869d1b92">OSSL_SSL_METHOD_ENTRY</a>(TLSv1),
<a name="l00108"></a>00108     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5644064c8581407ff69ad5da869d1b92">OSSL_SSL_METHOD_ENTRY</a>(TLSv1_server),
<a name="l00109"></a>00109     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5644064c8581407ff69ad5da869d1b92">OSSL_SSL_METHOD_ENTRY</a>(TLSv1_client),
<a name="l00110"></a>00110 <span class="preprocessor">#if defined(HAVE_SSLV2_METHOD) &amp;&amp; defined(HAVE_SSLV2_SERVER_METHOD) &amp;&amp; \</span>
<a name="l00111"></a>00111 <span class="preprocessor">        defined(HAVE_SSLV2_CLIENT_METHOD)</span>
<a name="l00112"></a>00112 <span class="preprocessor"></span>    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5644064c8581407ff69ad5da869d1b92">OSSL_SSL_METHOD_ENTRY</a>(SSLv2),
<a name="l00113"></a>00113     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5644064c8581407ff69ad5da869d1b92">OSSL_SSL_METHOD_ENTRY</a>(SSLv2_server),
<a name="l00114"></a>00114     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5644064c8581407ff69ad5da869d1b92">OSSL_SSL_METHOD_ENTRY</a>(SSLv2_client),
<a name="l00115"></a>00115 <span class="preprocessor">#endif</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span>    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5644064c8581407ff69ad5da869d1b92">OSSL_SSL_METHOD_ENTRY</a>(SSLv3),
<a name="l00117"></a>00117     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5644064c8581407ff69ad5da869d1b92">OSSL_SSL_METHOD_ENTRY</a>(SSLv3_server),
<a name="l00118"></a>00118     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5644064c8581407ff69ad5da869d1b92">OSSL_SSL_METHOD_ENTRY</a>(SSLv3_client),
<a name="l00119"></a>00119     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5644064c8581407ff69ad5da869d1b92">OSSL_SSL_METHOD_ENTRY</a>(SSLv23),
<a name="l00120"></a>00120     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5644064c8581407ff69ad5da869d1b92">OSSL_SSL_METHOD_ENTRY</a>(SSLv23_server),
<a name="l00121"></a>00121     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5644064c8581407ff69ad5da869d1b92">OSSL_SSL_METHOD_ENTRY</a>(SSLv23_client),
<a name="l00122"></a>00122 <span class="preprocessor">#undef OSSL_SSL_METHOD_ENTRY</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span>};
<a name="l00124"></a>00124 
<a name="l00125"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaccb4c51a7650ead12e74e5ce071750f">00125</a> <span class="keywordtype">int</span> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaccb4c51a7650ead12e74e5ce071750f">ossl_ssl_ex_vcb_idx</a>;
<a name="l00126"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaff04e7fef2f53f2151d8bdbf5bd431a">00126</a> <span class="keywordtype">int</span> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaff04e7fef2f53f2151d8bdbf5bd431a">ossl_ssl_ex_store_p</a>;
<a name="l00127"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa3c26a2268bba8099b8b629b9808d267">00127</a> <span class="keywordtype">int</span> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa3c26a2268bba8099b8b629b9808d267">ossl_ssl_ex_ptr_idx</a>;
<a name="l00128"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39218e865ef8154ca806c6514b3d4c25">00128</a> <span class="keywordtype">int</span> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39218e865ef8154ca806c6514b3d4c25">ossl_ssl_ex_client_cert_cb_idx</a>;
<a name="l00129"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac71ee4a16f11ab58ff8bb63bfb489bf8">00129</a> <span class="keywordtype">int</span> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac71ee4a16f11ab58ff8bb63bfb489bf8">ossl_ssl_ex_tmp_dh_callback_idx</a>;
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00132"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a82ae4b7a009543266d07178d0bb121c7">00132</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a82ae4b7a009543266d07178d0bb121c7">ossl_sslctx_free</a>(SSL_CTX *ctx)
<a name="l00133"></a>00133 {
<a name="l00134"></a>00134     <span class="keywordflow">if</span>(ctx &amp;&amp; SSL_CTX_get_ex_data(ctx, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaff04e7fef2f53f2151d8bdbf5bd431a">ossl_ssl_ex_store_p</a>)== (<span class="keywordtype">void</span>*)1)
<a name="l00135"></a>00135         ctx-&gt;cert_store = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00136"></a>00136     SSL_CTX_free(ctx);
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00140"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aea74e08ab004bc87346542e4dd79ae6a">00140</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aea74e08ab004bc87346542e4dd79ae6a">ossl_sslctx_s_alloc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass)
<a name="l00141"></a>00141 {
<a name="l00142"></a>00142     SSL_CTX *ctx;
<a name="l00143"></a>00143     <span class="keywordtype">long</span> mode = SSL_MODE_ENABLE_PARTIAL_WRITE;
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 <span class="preprocessor">#ifdef SSL_MODE_RELEASE_BUFFERS</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span>    mode |= SSL_MODE_RELEASE_BUFFERS;
<a name="l00147"></a>00147 <span class="preprocessor">#endif</span>
<a name="l00148"></a>00148 <span class="preprocessor"></span>
<a name="l00149"></a>00149     ctx = SSL_CTX_new(SSLv23_method());
<a name="l00150"></a>00150     <span class="keywordflow">if</span> (!ctx) {
<a name="l00151"></a>00151         <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;SSL_CTX_new:&quot;</span>);
<a name="l00152"></a>00152     }
<a name="l00153"></a>00153     SSL_CTX_set_mode(ctx, mode);
<a name="l00154"></a>00154     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a27705a261a9addb9ed4cb65dd5a61b1c">Data_Wrap_Struct</a>(klass, 0, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a82ae4b7a009543266d07178d0bb121c7">ossl_sslctx_free</a>, ctx);
<a name="l00155"></a>00155 }
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 <span class="comment">/*</span>
<a name="l00158"></a>00158 <span class="comment"> * call-seq:</span>
<a name="l00159"></a>00159 <span class="comment"> *    ctx.ssl_version = :TLSv1</span>
<a name="l00160"></a>00160 <span class="comment"> *    ctx.ssl_version = &quot;SSLv23_client&quot;</span>
<a name="l00161"></a>00161 <span class="comment"> *</span>
<a name="l00162"></a>00162 <span class="comment"> * You can get a list of valid versions with OpenSSL::SSL::SSLContext::METHODS</span>
<a name="l00163"></a>00163 <span class="comment"> */</span>
<a name="l00164"></a>00164 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00165"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3dbbe34597520e716de2838ed40737a9">00165</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3dbbe34597520e716de2838ed40737a9">ossl_sslctx_set_ssl_version</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ssl_method)
<a name="l00166"></a>00166 {
<a name="l00167"></a>00167     SSL_METHOD *method = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00168"></a>00168     <span class="keyword">const</span> <span class="keywordtype">char</span> *s;
<a name="l00169"></a>00169     <span class="keywordtype">int</span> i;
<a name="l00170"></a>00170 
<a name="l00171"></a>00171     SSL_CTX *ctx;
<a name="l00172"></a>00172     <span class="keywordflow">if</span>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(ssl_method) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9aadbc1e9c456506a4d7eef5cdc787e">T_SYMBOL</a>)
<a name="l00173"></a>00173         s = <a class="code" href="../../d5/d11/ripper_8c.html#a877bc58c495643fcf49dc64c44631e72">rb_id2name</a>(<a class="code" href="../../dc/d0c/cparse_8c.html#a73ce5202e6172d3ad0bab7d1e0df9dae">SYM2ID</a>(ssl_method));
<a name="l00174"></a>00174     <span class="keywordflow">else</span>
<a name="l00175"></a>00175         s =  <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2665a51abbd5b49c15abff3df00fa9db">StringValuePtr</a>(ssl_method);
<a name="l00176"></a>00176     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aba4cc5eb530917e91bf5b03c9c3231e9">ossl_ssl_method_tab</a>); i++) {
<a name="l00177"></a>00177         <span class="keywordflow">if</span> (strcmp(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aba4cc5eb530917e91bf5b03c9c3231e9">ossl_ssl_method_tab</a>[i].<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, s) == 0) {
<a name="l00178"></a>00178             method = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aba4cc5eb530917e91bf5b03c9c3231e9">ossl_ssl_method_tab</a>[i].func();
<a name="l00179"></a>00179             <span class="keywordflow">break</span>;
<a name="l00180"></a>00180         }
<a name="l00181"></a>00181     }
<a name="l00182"></a>00182     <span class="keywordflow">if</span> (!method) {
<a name="l00183"></a>00183         <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;unknown SSL method `%s&apos;.&quot;</span>, s);
<a name="l00184"></a>00184     }
<a name="l00185"></a>00185     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL_CTX, ctx);
<a name="l00186"></a>00186     <span class="keywordflow">if</span> (SSL_CTX_set_ssl_version(ctx, method) != 1) {
<a name="l00187"></a>00187         <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;SSL_CTX_set_ssl_version:&quot;</span>);
<a name="l00188"></a>00188     }
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <span class="keywordflow">return</span> ssl_method;
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="comment">/*</span>
<a name="l00194"></a>00194 <span class="comment"> * call-seq:</span>
<a name="l00195"></a>00195 <span class="comment"> *    SSLContext.new =&gt; ctx</span>
<a name="l00196"></a>00196 <span class="comment"> *    SSLContext.new(:TLSv1) =&gt; ctx</span>
<a name="l00197"></a>00197 <span class="comment"> *    SSLContext.new(&quot;SSLv23_client&quot;) =&gt; ctx</span>
<a name="l00198"></a>00198 <span class="comment"> *</span>
<a name="l00199"></a>00199 <span class="comment"> * You can get a list of valid methods with OpenSSL::SSL::SSLContext::METHODS</span>
<a name="l00200"></a>00200 <span class="comment"> */</span>
<a name="l00201"></a>00201 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00202"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a68e432887535b249e207d9ea6a51baeb">00202</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a68e432887535b249e207d9ea6a51baeb">ossl_sslctx_initialize</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l00203"></a>00203 {
<a name="l00204"></a>00204     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ssl_method;
<a name="l00205"></a>00205     <span class="keywordtype">int</span> i;
<a name="l00206"></a>00206 
<a name="l00207"></a>00207     <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5ae403957d62ab583a9a4e1b2432b413">ossl_sslctx_attrs</a>); i++){
<a name="l00208"></a>00208         <span class="keywordtype">char</span> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>[32];
<a name="l00209"></a>00209         <a class="code" href="../../d7/d72/subst_8h.html#aa367b75c5aed883fef5befbdf04835a4">snprintf</a>(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;@%s&quot;</span>, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5ae403957d62ab583a9a4e1b2432b413">ossl_sslctx_attrs</a>[i]);
<a name="l00210"></a>00210         <a class="code" href="../../db/d2e/intern_8h.html#a7e5b0d4c40fecb26c1ac946f674a690e">rb_iv_set</a>(<span class="keyword">self</span>, buf, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l00211"></a>00211     }
<a name="l00212"></a>00212     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;01&quot;</span>, &amp;ssl_method) == 0){
<a name="l00213"></a>00213         <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3dbbe34597520e716de2838ed40737a9">ossl_sslctx_set_ssl_version</a>(<span class="keyword">self</span>, ssl_method);
<a name="l00216"></a>00216 
<a name="l00217"></a>00217     <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l00218"></a>00218 }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00221"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab7e312b827e196a306a1dab8c97915e3">00221</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab7e312b827e196a306a1dab8c97915e3">ossl_call_client_cert_cb</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj)
<a name="l00222"></a>00222 {
<a name="l00223"></a>00223     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> cb, ary, cert, <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>;
<a name="l00224"></a>00224     SSL *ssl;
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(obj, SSL, ssl);
<a name="l00227"></a>00227     cb = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)SSL_get_ex_data(ssl, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39218e865ef8154ca806c6514b3d4c25">ossl_ssl_ex_client_cert_cb_idx</a>);
<a name="l00228"></a>00228     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(cb)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l00229"></a>00229     ary = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(cb, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;call&quot;</span>), 1, obj);
<a name="l00230"></a>00230     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad5a1e03b0a66824f95f6aaf07b4a4052">Check_Type</a>(ary, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a>);
<a name="l00231"></a>00231     <a class="code" href="../../d3/da1/ossl__x509_8h.html#a55515b14c48c1afa36b99c1f5c6cc38d">GetX509CertPtr</a>(cert = <a class="code" href="../../dc/dcc/array_8c.html#ae3c2ac6c88e666d5418855114eb8bcf8">rb_ary_entry</a>(ary, 0));
<a name="l00232"></a>00232     <a class="code" href="../../d1/df0/ossl__pkey_8c.html#a53f3f8bd4cdc335d16faaaa63f2e76da">GetPKeyPtr</a>(key = <a class="code" href="../../dc/dcc/array_8c.html#ae3c2ac6c88e666d5418855114eb8bcf8">rb_ary_entry</a>(ary, 1));
<a name="l00233"></a>00233     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a1c29c56ece1c74c11ce1d9ceb7d04077">ossl_ssl_set_x509</a>(obj, cert);
<a name="l00234"></a>00234     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8db20bf2431993d2e08bf69969a02112">ossl_ssl_set_key</a>(obj, key);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l00237"></a>00237 }
<a name="l00238"></a>00238 
<a name="l00239"></a>00239 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00240"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a93326260dee7e9a5194d2e95a286b700">00240</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a93326260dee7e9a5194d2e95a286b700">ossl_client_cert_cb</a>(SSL *ssl, X509 **x509, EVP_PKEY **pkey)
<a name="l00241"></a>00241 {
<a name="l00242"></a>00242     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj, success;
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     obj = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)SSL_get_ex_data(ssl, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa3c26a2268bba8099b8b629b9808d267">ossl_ssl_ex_ptr_idx</a>);
<a name="l00245"></a>00245     success = <a class="code" href="../../d3/d57/eval_8c.html#a6aa7fb1169ed41978a16375b6f921b0e">rb_protect</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>(*)<a class="code" href="../../df/da8/dln_8h.html#a10087a068d10eaadb8f9bb9200cd619a">_</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)))<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab7e312b827e196a306a1dab8c97915e3">ossl_call_client_cert_cb</a>,
<a name="l00246"></a>00246                          obj, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00247"></a>00247     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(success)) <span class="keywordflow">return</span> 0;
<a name="l00248"></a>00248     *x509 = <a class="code" href="../../d3/da1/ossl__x509_8h.html#a54a79f5180da5555cc1f49215d7f8ee7">DupX509CertPtr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3a31e5605c1f61fd48a7b0cb71c77d17">ossl_ssl_get_x509</a>(obj));
<a name="l00249"></a>00249     *pkey = <a class="code" href="../../d1/df0/ossl__pkey_8c.html#a18c4f3b29024155ac854560b45c53e12">DupPKeyPtr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a6e78813264108fa71cbe726a9916a423">ossl_ssl_get_key</a>(obj));
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     <span class="keywordflow">return</span> 1;
<a name="l00252"></a>00252 }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254 <span class="preprocessor">#if !defined(OPENSSL_NO_DH)</span>
<a name="l00255"></a>00255 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00256"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a54880f2f728b15503edf10c0478ac3ef">00256</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a54880f2f728b15503edf10c0478ac3ef">ossl_call_tmp_dh_callback</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../d3/d09/ripper_8y.html#a8187411843a6284ffb964ef3fb9fcab3">args</a>)
<a name="l00257"></a>00257 {
<a name="l00258"></a>00258     SSL *ssl;
<a name="l00259"></a>00259     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> cb, dh;
<a name="l00260"></a>00260     EVP_PKEY *pkey;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(args[0], SSL, ssl);
<a name="l00263"></a>00263     cb = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)SSL_get_ex_data(ssl, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac71ee4a16f11ab58ff8bb63bfb489bf8">ossl_ssl_ex_tmp_dh_callback_idx</a>);
<a name="l00264"></a>00264     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(cb)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l00265"></a>00265     dh = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(cb, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;call&quot;</span>), 3, args[0], args[1], args[2]);
<a name="l00266"></a>00266     pkey = <a class="code" href="../../d1/df0/ossl__pkey_8c.html#a53f3f8bd4cdc335d16faaaa63f2e76da">GetPKeyPtr</a>(dh);
<a name="l00267"></a>00267     <span class="keywordflow">if</span> (EVP_PKEY_type(pkey-&gt;type) != EVP_PKEY_DH) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l00268"></a>00268     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a9c9755838b4f2c55845c824e73875eb4">ossl_ssl_set_tmp_dh</a>(args[0], dh);
<a name="l00269"></a>00269 
<a name="l00270"></a>00270     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l00271"></a>00271 }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 <span class="keyword">static</span> DH*
<a name="l00274"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a499d784c4d1f274bfc445d94d86deeff">00274</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a499d784c4d1f274bfc445d94d86deeff">ossl_tmp_dh_callback</a>(SSL *ssl, <span class="keywordtype">int</span> is_export, <span class="keywordtype">int</span> keylength)
<a name="l00275"></a>00275 {
<a name="l00276"></a>00276     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d09/ripper_8y.html#a8187411843a6284ffb964ef3fb9fcab3">args</a>[3], success;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278     args[0] = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)SSL_get_ex_data(ssl, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa3c26a2268bba8099b8b629b9808d267">ossl_ssl_ex_ptr_idx</a>);
<a name="l00279"></a>00279     args[1] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(is_export);
<a name="l00280"></a>00280     args[2] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(keylength);
<a name="l00281"></a>00281     success = <a class="code" href="../../d3/d57/eval_8c.html#a6aa7fb1169ed41978a16375b6f921b0e">rb_protect</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>(*)<a class="code" href="../../df/da8/dln_8h.html#a10087a068d10eaadb8f9bb9200cd619a">_</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)))<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a54880f2f728b15503edf10c0478ac3ef">ossl_call_tmp_dh_callback</a>,
<a name="l00282"></a>00282                          (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)args, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00283"></a>00283     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(success)) <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     <span class="keywordflow">return</span> <a class="code" href="../../d1/df0/ossl__pkey_8c.html#a53f3f8bd4cdc335d16faaaa63f2e76da">GetPKeyPtr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a56650d6ac203d59afbd0bd7e59c3c57e">ossl_ssl_get_tmp_dh</a>(args[0]))-&gt;pkey.dh;
<a name="l00286"></a>00286 }
<a name="l00287"></a>00287 
<a name="l00288"></a>00288 <span class="keyword">static</span> DH*
<a name="l00289"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8d183e95e3f6286275cb160b942a9da6">00289</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8d183e95e3f6286275cb160b942a9da6">ossl_default_tmp_dh_callback</a>(SSL *ssl, <span class="keywordtype">int</span> is_export, <span class="keywordtype">int</span> keylength)
<a name="l00290"></a>00290 {
<a name="l00291"></a>00291     <a class="code" href="../../db/dcc/error_8c.html#afd461c64916576849b159b21a26123da">rb_warning</a>(<span class="stringliteral">&quot;using default DH parameters.&quot;</span>);
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     <span class="keywordflow">switch</span>(keylength){
<a name="l00294"></a>00294     <span class="keywordflow">case</span> 512:
<a name="l00295"></a>00295         <span class="keywordflow">return</span> <a class="code" href="../../db/d3c/ossl__pkey_8h.html#ac0c52f96ca4dc66d795fa94c0cae88e9">OSSL_DEFAULT_DH_512</a>;
<a name="l00296"></a>00296     <span class="keywordflow">case</span> 1024:
<a name="l00297"></a>00297         <span class="keywordflow">return</span> <a class="code" href="../../db/d3c/ossl__pkey_8h.html#a39901482dbb3131546ca3ded236c9808">OSSL_DEFAULT_DH_1024</a>;
<a name="l00298"></a>00298     }
<a name="l00299"></a>00299     <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00300"></a>00300 }
<a name="l00301"></a>00301 <span class="preprocessor">#endif </span><span class="comment">/* OPENSSL_NO_DH */</span>
<a name="l00302"></a>00302 
<a name="l00303"></a>00303 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00304"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5624418c2f05a0ef02fc32528aa1a246">00304</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5624418c2f05a0ef02fc32528aa1a246">ossl_ssl_verify_callback</a>(<span class="keywordtype">int</span> preverify_ok, X509_STORE_CTX *ctx)
<a name="l00305"></a>00305 {
<a name="l00306"></a>00306     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> cb;
<a name="l00307"></a>00307     SSL *ssl;
<a name="l00308"></a>00308 
<a name="l00309"></a>00309     ssl = X509_STORE_CTX_get_ex_data(ctx, SSL_get_ex_data_X509_STORE_CTX_idx());
<a name="l00310"></a>00310     cb = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)SSL_get_ex_data(ssl, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaccb4c51a7650ead12e74e5ce071750f">ossl_ssl_ex_vcb_idx</a>);
<a name="l00311"></a>00311     X509_STORE_CTX_set_ex_data(ctx, <a class="code" href="../../d4/d3c/ossl_8c.html#ab6231b977f487e531fd6152683a284c0">ossl_verify_cb_idx</a>, (<span class="keywordtype">void</span>*)cb);
<a name="l00312"></a>00312     <span class="keywordflow">return</span> <a class="code" href="../../d4/d3c/ossl_8c.html#ae7be9bb701ed3b84be1692979fef9cd8">ossl_verify_cb</a>(preverify_ok, ctx);
<a name="l00313"></a>00313 }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00316"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a6d0fc618de79de4537dec1d738d33d4b">00316</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a6d0fc618de79de4537dec1d738d33d4b">ossl_call_session_get_cb</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary)
<a name="l00317"></a>00317 {
<a name="l00318"></a>00318     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ssl_obj, sslctx_obj, cb;
<a name="l00319"></a>00319 
<a name="l00320"></a>00320     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad5a1e03b0a66824f95f6aaf07b4a4052">Check_Type</a>(ary, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a>);
<a name="l00321"></a>00321     ssl_obj = <a class="code" href="../../dc/dcc/array_8c.html#ae3c2ac6c88e666d5418855114eb8bcf8">rb_ary_entry</a>(ary, 0);
<a name="l00322"></a>00322 
<a name="l00323"></a>00323     sslctx_obj = <a class="code" href="../../db/d2e/intern_8h.html#ad05f3639fd927a08b07d12e2960936d4">rb_iv_get</a>(ssl_obj, <span class="stringliteral">&quot;@context&quot;</span>);
<a name="l00324"></a>00324     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(sslctx_obj)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00325"></a>00325     cb = <a class="code" href="../../db/d2e/intern_8h.html#ad05f3639fd927a08b07d12e2960936d4">rb_iv_get</a>(sslctx_obj, <span class="stringliteral">&quot;@session_get_cb&quot;</span>);
<a name="l00326"></a>00326     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(cb)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00327"></a>00327 
<a name="l00328"></a>00328     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(cb, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;call&quot;</span>), 1, ary);
<a name="l00329"></a>00329 }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331 <span class="comment">/* this method is currently only called for servers (in OpenSSL &lt;= 0.9.8e) */</span>
<a name="l00332"></a>00332 <span class="keyword">static</span> SSL_SESSION *
<a name="l00333"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a2191472f9b551578a6df87dde0c41bb0">00333</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a2191472f9b551578a6df87dde0c41bb0">ossl_sslctx_session_get_cb</a>(SSL *ssl, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>, <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <span class="keywordtype">int</span> *copy)
<a name="l00334"></a>00334 {
<a name="l00335"></a>00335     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary, ssl_obj, ret_obj;
<a name="l00336"></a>00336     SSL_SESSION *sess;
<a name="l00337"></a>00337     <span class="keywordtype">void</span> *ptr;
<a name="l00338"></a>00338     <span class="keywordtype">int</span> <a class="code" href="../../d5/d1d/gb18030_8c.html#adc6e5733fc3c22f0a7b2914188c49c90">state</a> = 0;
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     <a class="code" href="../../d5/dac/ossl_8h.html#af24156a85e9b3ac1aaac2d61976ea93a">OSSL_Debug</a>(<span class="stringliteral">&quot;SSL SESSION get callback entered&quot;</span>);
<a name="l00341"></a>00341     <span class="keywordflow">if</span> ((ptr = SSL_get_ex_data(ssl, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa3c26a2268bba8099b8b629b9808d267">ossl_ssl_ex_ptr_idx</a>)) == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00342"></a>00342         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00343"></a>00343     ssl_obj = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)ptr;
<a name="l00344"></a>00344     ary = <a class="code" href="../../dc/dcc/array_8c.html#a43a7bd246935ab63c233b4ae34d61d75">rb_ary_new2</a>(2);
<a name="l00345"></a>00345     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, ssl_obj);
<a name="l00346"></a>00346     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *)buf, len));
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     ret_obj = <a class="code" href="../../d3/d57/eval_8c.html#a6aa7fb1169ed41978a16375b6f921b0e">rb_protect</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>(*)<a class="code" href="../../df/da8/dln_8h.html#a10087a068d10eaadb8f9bb9200cd619a">_</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)))<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a6d0fc618de79de4537dec1d738d33d4b">ossl_call_session_get_cb</a>, ary, &amp;state);
<a name="l00349"></a>00349     <span class="keywordflow">if</span> (state) {
<a name="l00350"></a>00350         <a class="code" href="../../db/d2e/intern_8h.html#acee88ad0375c8a9080e2283db494d257">rb_ivar_set</a>(ssl_obj, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a03b3aad781a6c9b2f9b8a7f3c319f97e">ID_callback_state</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(state));
<a name="l00351"></a>00351         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00352"></a>00352     }
<a name="l00353"></a>00353     <span class="keywordflow">if</span> (!<a class="code" href="../../db/d2e/intern_8h.html#a04d0862c584bd79f66702d353af335af">rb_obj_is_instance_of</a>(ret_obj, <a class="code" href="../../d6/d43/ossl__ssl_8h.html#a2bb42334f6801434ef9338a41ec62781">cSSLSession</a>))
<a name="l00354"></a>00354         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00355"></a>00355 
<a name="l00356"></a>00356     <a class="code" href="../../d6/d43/ossl__ssl_8h.html#a6a2c50eb14ed3451daff1fdad90d23e8">SafeGetSSLSession</a>(ret_obj, sess);
<a name="l00357"></a>00357     *copy = 1;
<a name="l00358"></a>00358 
<a name="l00359"></a>00359     <span class="keywordflow">return</span> sess;
<a name="l00360"></a>00360 }
<a name="l00361"></a>00361 
<a name="l00362"></a>00362 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00363"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa1234fb47ece3e748f9989c573411809">00363</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa1234fb47ece3e748f9989c573411809">ossl_call_session_new_cb</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary)
<a name="l00364"></a>00364 {
<a name="l00365"></a>00365     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ssl_obj, sslctx_obj, cb;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad5a1e03b0a66824f95f6aaf07b4a4052">Check_Type</a>(ary, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a>);
<a name="l00368"></a>00368     ssl_obj = <a class="code" href="../../dc/dcc/array_8c.html#ae3c2ac6c88e666d5418855114eb8bcf8">rb_ary_entry</a>(ary, 0);
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     sslctx_obj = <a class="code" href="../../db/d2e/intern_8h.html#ad05f3639fd927a08b07d12e2960936d4">rb_iv_get</a>(ssl_obj, <span class="stringliteral">&quot;@context&quot;</span>);
<a name="l00371"></a>00371     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(sslctx_obj)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00372"></a>00372     cb = <a class="code" href="../../db/d2e/intern_8h.html#ad05f3639fd927a08b07d12e2960936d4">rb_iv_get</a>(sslctx_obj, <span class="stringliteral">&quot;@session_new_cb&quot;</span>);
<a name="l00373"></a>00373     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(cb)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(cb, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;call&quot;</span>), 1, ary);
<a name="l00376"></a>00376 }
<a name="l00377"></a>00377 
<a name="l00378"></a>00378 <span class="comment">/* return 1 normal.  return 0 removes the session */</span>
<a name="l00379"></a>00379 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00380"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa312cab965f94195468bd936790a7a7f">00380</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa312cab965f94195468bd936790a7a7f">ossl_sslctx_session_new_cb</a>(SSL *ssl, SSL_SESSION *sess)
<a name="l00381"></a>00381 {
<a name="l00382"></a>00382     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary, ssl_obj, sess_obj, ret_obj;
<a name="l00383"></a>00383     <span class="keywordtype">void</span> *ptr;
<a name="l00384"></a>00384     <span class="keywordtype">int</span> <a class="code" href="../../d5/d1d/gb18030_8c.html#adc6e5733fc3c22f0a7b2914188c49c90">state</a> = 0;
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     <a class="code" href="../../d5/dac/ossl_8h.html#af24156a85e9b3ac1aaac2d61976ea93a">OSSL_Debug</a>(<span class="stringliteral">&quot;SSL SESSION new callback entered&quot;</span>);
<a name="l00387"></a>00387 
<a name="l00388"></a>00388     <span class="keywordflow">if</span> ((ptr = SSL_get_ex_data(ssl, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa3c26a2268bba8099b8b629b9808d267">ossl_ssl_ex_ptr_idx</a>)) == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00389"></a>00389         <span class="keywordflow">return</span> 1;
<a name="l00390"></a>00390     ssl_obj = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)ptr;
<a name="l00391"></a>00391     sess_obj = <a class="code" href="../../db/d2e/intern_8h.html#a4419d9ed52af0d0dbdcb02f491b1d88d">rb_obj_alloc</a>(<a class="code" href="../../d6/d43/ossl__ssl_8h.html#a2bb42334f6801434ef9338a41ec62781">cSSLSession</a>);
<a name="l00392"></a>00392     CRYPTO_add(&amp;sess-&gt;references, 1, CRYPTO_LOCK_SSL_SESSION);
<a name="l00393"></a>00393     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abb509cfdf6560a9f795b1f6932d93691">DATA_PTR</a>(sess_obj) = sess;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     ary = <a class="code" href="../../dc/dcc/array_8c.html#a43a7bd246935ab63c233b4ae34d61d75">rb_ary_new2</a>(2);
<a name="l00396"></a>00396     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, ssl_obj);
<a name="l00397"></a>00397     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, sess_obj);
<a name="l00398"></a>00398 
<a name="l00399"></a>00399     ret_obj = <a class="code" href="../../d3/d57/eval_8c.html#a6aa7fb1169ed41978a16375b6f921b0e">rb_protect</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>(*)<a class="code" href="../../df/da8/dln_8h.html#a10087a068d10eaadb8f9bb9200cd619a">_</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)))<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa1234fb47ece3e748f9989c573411809">ossl_call_session_new_cb</a>, ary, &amp;state);
<a name="l00400"></a>00400     <span class="keywordflow">if</span> (state) {
<a name="l00401"></a>00401         <a class="code" href="../../db/d2e/intern_8h.html#acee88ad0375c8a9080e2283db494d257">rb_ivar_set</a>(ssl_obj, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a03b3aad781a6c9b2f9b8a7f3c319f97e">ID_callback_state</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(state));
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="comment">/*</span>
<a name="l00405"></a>00405 <span class="comment">     * return 0 which means to OpenSSL that the the session is still</span>
<a name="l00406"></a>00406 <span class="comment">     * valid (since we created Ruby Session object) and was not freed by us</span>
<a name="l00407"></a>00407 <span class="comment">     * with SSL_SESSION_free(). Call SSLContext#remove_session(sess) in</span>
<a name="l00408"></a>00408 <span class="comment">     * session_get_cb block if you don&apos;t want OpenSSL to cache the session</span>
<a name="l00409"></a>00409 <span class="comment">     * internally.</span>
<a name="l00410"></a>00410 <span class="comment">     */</span>
<a name="l00411"></a>00411     <span class="keywordflow">return</span> 0;
<a name="l00412"></a>00412 }
<a name="l00413"></a>00413 
<a name="l00414"></a>00414 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00415"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a7aada6e0022f3c16df40485ec487713e">00415</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a7aada6e0022f3c16df40485ec487713e">ossl_call_session_remove_cb</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary)
<a name="l00416"></a>00416 {
<a name="l00417"></a>00417     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> sslctx_obj, cb;
<a name="l00418"></a>00418 
<a name="l00419"></a>00419     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad5a1e03b0a66824f95f6aaf07b4a4052">Check_Type</a>(ary, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a>);
<a name="l00420"></a>00420     sslctx_obj = <a class="code" href="../../dc/dcc/array_8c.html#ae3c2ac6c88e666d5418855114eb8bcf8">rb_ary_entry</a>(ary, 0);
<a name="l00421"></a>00421 
<a name="l00422"></a>00422     cb = <a class="code" href="../../db/d2e/intern_8h.html#ad05f3639fd927a08b07d12e2960936d4">rb_iv_get</a>(sslctx_obj, <span class="stringliteral">&quot;@session_remove_cb&quot;</span>);
<a name="l00423"></a>00423     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(cb)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00424"></a>00424 
<a name="l00425"></a>00425     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(cb, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;call&quot;</span>), 1, ary);
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00429"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ae3b7ba474eef4f00a03f7bbb441df423">00429</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ae3b7ba474eef4f00a03f7bbb441df423">ossl_sslctx_session_remove_cb</a>(SSL_CTX *ctx, SSL_SESSION *sess)
<a name="l00430"></a>00430 {
<a name="l00431"></a>00431     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary, sslctx_obj, sess_obj, ret_obj;
<a name="l00432"></a>00432     <span class="keywordtype">void</span> *ptr;
<a name="l00433"></a>00433     <span class="keywordtype">int</span> <a class="code" href="../../d5/d1d/gb18030_8c.html#adc6e5733fc3c22f0a7b2914188c49c90">state</a> = 0;
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     <a class="code" href="../../d5/dac/ossl_8h.html#af24156a85e9b3ac1aaac2d61976ea93a">OSSL_Debug</a>(<span class="stringliteral">&quot;SSL SESSION remove callback entered&quot;</span>);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437     <span class="keywordflow">if</span> ((ptr = SSL_CTX_get_ex_data(ctx, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa3c26a2268bba8099b8b629b9808d267">ossl_ssl_ex_ptr_idx</a>)) == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l00438"></a>00438         <span class="keywordflow">return</span>;
<a name="l00439"></a>00439     sslctx_obj = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)ptr;
<a name="l00440"></a>00440     sess_obj = <a class="code" href="../../db/d2e/intern_8h.html#a4419d9ed52af0d0dbdcb02f491b1d88d">rb_obj_alloc</a>(<a class="code" href="../../d6/d43/ossl__ssl_8h.html#a2bb42334f6801434ef9338a41ec62781">cSSLSession</a>);
<a name="l00441"></a>00441     CRYPTO_add(&amp;sess-&gt;references, 1, CRYPTO_LOCK_SSL_SESSION);
<a name="l00442"></a>00442     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abb509cfdf6560a9f795b1f6932d93691">DATA_PTR</a>(sess_obj) = sess;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     ary = <a class="code" href="../../dc/dcc/array_8c.html#a43a7bd246935ab63c233b4ae34d61d75">rb_ary_new2</a>(2);
<a name="l00445"></a>00445     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, sslctx_obj);
<a name="l00446"></a>00446     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, sess_obj);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448     ret_obj = <a class="code" href="../../d3/d57/eval_8c.html#a6aa7fb1169ed41978a16375b6f921b0e">rb_protect</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>(*)<a class="code" href="../../df/da8/dln_8h.html#a10087a068d10eaadb8f9bb9200cd619a">_</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)))<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a7aada6e0022f3c16df40485ec487713e">ossl_call_session_remove_cb</a>, ary, &amp;state);
<a name="l00449"></a>00449     <span class="keywordflow">if</span> (state) {
<a name="l00450"></a>00450 <span class="comment">/*</span>
<a name="l00451"></a>00451 <span class="comment">  the SSL_CTX is frozen, nowhere to save state.</span>
<a name="l00452"></a>00452 <span class="comment">  there is no common accessor method to check it either.</span>
<a name="l00453"></a>00453 <span class="comment">        rb_ivar_set(sslctx_obj, ID_callback_state, INT2NUM(state));</span>
<a name="l00454"></a>00454 <span class="comment">*/</span>
<a name="l00455"></a>00455     }
<a name="l00456"></a>00456 }
<a name="l00457"></a>00457 
<a name="l00458"></a>00458 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00459"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#abdb45512cdaade2e46a2a7effdeb56f5">00459</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#abdb45512cdaade2e46a2a7effdeb56f5">ossl_sslctx_add_extra_chain_cert_i</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> i, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l00460"></a>00460 {
<a name="l00461"></a>00461     X509 *x509;
<a name="l00462"></a>00462     SSL_CTX *ctx;
<a name="l00463"></a>00463 
<a name="l00464"></a>00464     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(arg, SSL_CTX, ctx);
<a name="l00465"></a>00465     x509 = <a class="code" href="../../d3/da1/ossl__x509_8h.html#a54a79f5180da5555cc1f49215d7f8ee7">DupX509CertPtr</a>(i);
<a name="l00466"></a>00466     <span class="keywordflow">if</span>(!SSL_CTX_add_extra_chain_cert(ctx, x509)){
<a name="l00467"></a>00467         <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00468"></a>00468     }
<a name="l00469"></a>00469 
<a name="l00470"></a>00470     <span class="keywordflow">return</span> i;
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aee593ff89ad5d4eaeeb4948555ad5f3e">ossl_sslctx_setup</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>);
<a name="l00474"></a>00474 
<a name="l00475"></a>00475 <span class="preprocessor">#ifdef HAVE_SSL_SET_TLSEXT_HOST_NAME</span>
<a name="l00476"></a>00476 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00477"></a>00477 ossl_call_servername_cb(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary)
<a name="l00478"></a>00478 {
<a name="l00479"></a>00479     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ssl_obj, sslctx_obj, cb, ret_obj;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad5a1e03b0a66824f95f6aaf07b4a4052">Check_Type</a>(ary, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a>);
<a name="l00482"></a>00482     ssl_obj = <a class="code" href="../../dc/dcc/array_8c.html#ae3c2ac6c88e666d5418855114eb8bcf8">rb_ary_entry</a>(ary, 0);
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     sslctx_obj = <a class="code" href="../../db/d2e/intern_8h.html#ad05f3639fd927a08b07d12e2960936d4">rb_iv_get</a>(ssl_obj, <span class="stringliteral">&quot;@context&quot;</span>);
<a name="l00485"></a>00485     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(sslctx_obj)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00486"></a>00486     cb = <a class="code" href="../../db/d2e/intern_8h.html#ad05f3639fd927a08b07d12e2960936d4">rb_iv_get</a>(sslctx_obj, <span class="stringliteral">&quot;@servername_cb&quot;</span>);
<a name="l00487"></a>00487     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(cb)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00488"></a>00488 
<a name="l00489"></a>00489     ret_obj = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(cb, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;call&quot;</span>), 1, ary);
<a name="l00490"></a>00490     <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#a6e65fc310dd65ebd60d68ada991da6f6">rb_obj_is_kind_of</a>(ret_obj, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>)) {
<a name="l00491"></a>00491         SSL *ssl;
<a name="l00492"></a>00492         SSL_CTX *ctx2;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494         <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aee593ff89ad5d4eaeeb4948555ad5f3e">ossl_sslctx_setup</a>(ret_obj);
<a name="l00495"></a>00495         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(ssl_obj, SSL, ssl);
<a name="l00496"></a>00496         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(ret_obj, SSL_CTX, ctx2);
<a name="l00497"></a>00497         SSL_set_SSL_CTX(ssl, ctx2);
<a name="l00498"></a>00498     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(ret_obj)) {
<a name="l00499"></a>00499             <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;servername_cb must return an OpenSSL::SSL::SSLContext object or nil&quot;</span>);
<a name="l00500"></a>00500     }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502     <span class="keywordflow">return</span> ret_obj;
<a name="l00503"></a>00503 }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00506"></a>00506 ssl_servername_cb(SSL *ssl, <span class="keywordtype">int</span> *ad, <span class="keywordtype">void</span> *arg)
<a name="l00507"></a>00507 {
<a name="l00508"></a>00508     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary, ssl_obj, ret_obj;
<a name="l00509"></a>00509     <span class="keywordtype">void</span> *ptr;
<a name="l00510"></a>00510     <span class="keywordtype">int</span> <a class="code" href="../../d5/d1d/gb18030_8c.html#adc6e5733fc3c22f0a7b2914188c49c90">state</a> = 0;
<a name="l00511"></a>00511     <span class="keyword">const</span> <span class="keywordtype">char</span> *servername = SSL_get_servername(ssl, TLSEXT_NAMETYPE_host_name);
<a name="l00512"></a>00512 
<a name="l00513"></a>00513     <span class="keywordflow">if</span> (!servername)
<a name="l00514"></a>00514         <span class="keywordflow">return</span> SSL_TLSEXT_ERR_OK;
<a name="l00515"></a>00515 
<a name="l00516"></a>00516     <span class="keywordflow">if</span> ((ptr = SSL_get_ex_data(ssl, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa3c26a2268bba8099b8b629b9808d267">ossl_ssl_ex_ptr_idx</a>)) == NULL)
<a name="l00517"></a>00517         <span class="keywordflow">return</span> SSL_TLSEXT_ERR_ALERT_FATAL;
<a name="l00518"></a>00518     ssl_obj = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)ptr;
<a name="l00519"></a>00519     ary = <a class="code" href="../../dc/dcc/array_8c.html#a43a7bd246935ab63c233b4ae34d61d75">rb_ary_new2</a>(2);
<a name="l00520"></a>00520     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, ssl_obj);
<a name="l00521"></a>00521     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(servername));
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     ret_obj = <a class="code" href="../../d3/d57/eval_8c.html#a6aa7fb1169ed41978a16375b6f921b0e">rb_protect</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>(*)<a class="code" href="../../df/da8/dln_8h.html#a10087a068d10eaadb8f9bb9200cd619a">_</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)))ossl_call_servername_cb, ary, &amp;state);
<a name="l00524"></a>00524     <span class="keywordflow">if</span> (state) {
<a name="l00525"></a>00525         <a class="code" href="../../db/d2e/intern_8h.html#acee88ad0375c8a9080e2283db494d257">rb_ivar_set</a>(ssl_obj, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a03b3aad781a6c9b2f9b8a7f3c319f97e">ID_callback_state</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(state));
<a name="l00526"></a>00526         <span class="keywordflow">return</span> SSL_TLSEXT_ERR_ALERT_FATAL;
<a name="l00527"></a>00527     }
<a name="l00528"></a>00528 
<a name="l00529"></a>00529     <span class="keywordflow">return</span> SSL_TLSEXT_ERR_OK;
<a name="l00530"></a>00530 }
<a name="l00531"></a>00531 <span class="preprocessor">#endif</span>
<a name="l00532"></a>00532 <span class="preprocessor"></span>
<a name="l00533"></a>00533 <span class="comment">/*</span>
<a name="l00534"></a>00534 <span class="comment"> * call-seq:</span>
<a name="l00535"></a>00535 <span class="comment"> *    ctx.setup =&gt; Qtrue # first time</span>
<a name="l00536"></a>00536 <span class="comment"> *    ctx.setup =&gt; nil # thereafter</span>
<a name="l00537"></a>00537 <span class="comment"> *</span>
<a name="l00538"></a>00538 <span class="comment"> * This method is called automatically when a new SSLSocket is created.</span>
<a name="l00539"></a>00539 <span class="comment"> * Normally you do not need to call this method (unless you are writing an</span>
<a name="l00540"></a>00540 <span class="comment"> * extension in C).</span>
<a name="l00541"></a>00541 <span class="comment"> */</span>
<a name="l00542"></a>00542 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00543"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aee593ff89ad5d4eaeeb4948555ad5f3e">00543</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aee593ff89ad5d4eaeeb4948555ad5f3e">ossl_sslctx_setup</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l00544"></a>00544 {
<a name="l00545"></a>00545     SSL_CTX *ctx;
<a name="l00546"></a>00546     X509 *cert = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *client_ca = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00547"></a>00547     X509_STORE *store;
<a name="l00548"></a>00548     EVP_PKEY *<a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00549"></a>00549     <span class="keywordtype">char</span> *ca_path = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, *ca_file = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00550"></a>00550     <span class="keywordtype">int</span> i, verify_mode;
<a name="l00551"></a>00551     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553     <span class="keywordflow">if</span>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a73db79f74bad2fb5258a2ae7ee6ef117">OBJ_FROZEN</a>(<span class="keyword">self</span>)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00554"></a>00554     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL_CTX, ctx);
<a name="l00555"></a>00555 
<a name="l00556"></a>00556 <span class="preprocessor">#if !defined(OPENSSL_NO_DH)</span>
<a name="l00557"></a>00557 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a13e3d231cd90b2bd6acb78ad87703ee4">ossl_sslctx_get_tmp_dh_cb</a>(<span class="keyword">self</span>))){
<a name="l00558"></a>00558         SSL_CTX_set_tmp_dh_callback(ctx, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a499d784c4d1f274bfc445d94d86deeff">ossl_tmp_dh_callback</a>);
<a name="l00559"></a>00559     }
<a name="l00560"></a>00560     <span class="keywordflow">else</span>{
<a name="l00561"></a>00561         SSL_CTX_set_tmp_dh_callback(ctx, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8d183e95e3f6286275cb160b942a9da6">ossl_default_tmp_dh_callback</a>);
<a name="l00562"></a>00562     }
<a name="l00563"></a>00563 <span class="preprocessor">#endif</span>
<a name="l00564"></a>00564 <span class="preprocessor"></span>    SSL_CTX_set_ex_data(ctx, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa3c26a2268bba8099b8b629b9808d267">ossl_ssl_ex_ptr_idx</a>, (<span class="keywordtype">void</span>*)<span class="keyword">self</span>);
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     val = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a89833107651e8d088fce43ce090458a7">ossl_sslctx_get_cert_store</a>(<span class="keyword">self</span>);
<a name="l00567"></a>00567     <span class="keywordflow">if</span>(!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(val)){
<a name="l00568"></a>00568         <span class="comment">/*</span>
<a name="l00569"></a>00569 <span class="comment">         * WORKAROUND:</span>
<a name="l00570"></a>00570 <span class="comment">         *   X509_STORE can count references, but</span>
<a name="l00571"></a>00571 <span class="comment">         *   X509_STORE_free() doesn&apos;t care it.</span>
<a name="l00572"></a>00572 <span class="comment">         *   So we won&apos;t increment it but mark it by ex_data.</span>
<a name="l00573"></a>00573 <span class="comment">         */</span>
<a name="l00574"></a>00574         store = <a class="code" href="../../d3/da1/ossl__x509_8h.html#a3e7a3623a3180cee7ea537c27cbaf436">GetX509StorePtr</a>(val); <span class="comment">/* NO NEED TO DUP */</span>
<a name="l00575"></a>00575         SSL_CTX_set_cert_store(ctx, store);
<a name="l00576"></a>00576         SSL_CTX_set_ex_data(ctx, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaff04e7fef2f53f2151d8bdbf5bd431a">ossl_ssl_ex_store_p</a>, (<span class="keywordtype">void</span>*)1);
<a name="l00577"></a>00577     }
<a name="l00578"></a>00578 
<a name="l00579"></a>00579     val = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#abee8ae69d9430f3caec0f7835d642da8">ossl_sslctx_get_extra_cert</a>(<span class="keyword">self</span>);
<a name="l00580"></a>00580     <span class="keywordflow">if</span>(!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(val)){
<a name="l00581"></a>00581         <a class="code" href="../../d8/d81/ruby__missing_8h.html#a57ef4ad7ebd72a2a8bc8d68e38439db5">rb_block_call</a>(val, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;each&quot;</span>), 0, 0, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#abdb45512cdaade2e46a2a7effdeb56f5">ossl_sslctx_add_extra_chain_cert_i</a>, <span class="keyword">self</span>);
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583 
<a name="l00584"></a>00584     <span class="comment">/* private key may be bundled in certificate file. */</span>
<a name="l00585"></a>00585     val = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a7b2bf221f148fe933e5fc34f04a19668">ossl_sslctx_get_cert</a>(<span class="keyword">self</span>);
<a name="l00586"></a>00586     cert = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(val) ? <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> : <a class="code" href="../../d3/da1/ossl__x509_8h.html#a55515b14c48c1afa36b99c1f5c6cc38d">GetX509CertPtr</a>(val); <span class="comment">/* NO DUP NEEDED */</span>
<a name="l00587"></a>00587     val = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ae83ec2cb54d4893a6cf1fcd42698445c">ossl_sslctx_get_key</a>(<span class="keyword">self</span>);
<a name="l00588"></a>00588     key = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(val) ? <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> : <a class="code" href="../../d1/df0/ossl__pkey_8c.html#a53f3f8bd4cdc335d16faaaa63f2e76da">GetPKeyPtr</a>(val); <span class="comment">/* NO DUP NEEDED */</span>
<a name="l00589"></a>00589     <span class="keywordflow">if</span> (cert &amp;&amp; key) {
<a name="l00590"></a>00590         <span class="keywordflow">if</span> (!SSL_CTX_use_certificate(ctx, cert)) {
<a name="l00591"></a>00591             <span class="comment">/* Adds a ref =&gt; Safe to FREE */</span>
<a name="l00592"></a>00592             <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;SSL_CTX_use_certificate:&quot;</span>);
<a name="l00593"></a>00593         }
<a name="l00594"></a>00594         <span class="keywordflow">if</span> (!SSL_CTX_use_PrivateKey(ctx, key)) {
<a name="l00595"></a>00595             <span class="comment">/* Adds a ref =&gt; Safe to FREE */</span>
<a name="l00596"></a>00596             <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;SSL_CTX_use_PrivateKey:&quot;</span>);
<a name="l00597"></a>00597         }
<a name="l00598"></a>00598         <span class="keywordflow">if</span> (!SSL_CTX_check_private_key(ctx)) {
<a name="l00599"></a>00599             <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;SSL_CTX_check_private_key:&quot;</span>);
<a name="l00600"></a>00600         }
<a name="l00601"></a>00601     }
<a name="l00602"></a>00602 
<a name="l00603"></a>00603     val = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac8a5a1026e7b5753a3d9199e808b0333">ossl_sslctx_get_client_ca</a>(<span class="keyword">self</span>);
<a name="l00604"></a>00604     <span class="keywordflow">if</span>(!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(val)){
<a name="l00605"></a>00605         <span class="keywordflow">if</span>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(val) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a>){
<a name="l00606"></a>00606             <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(val); i++){
<a name="l00607"></a>00607                 client_ca = <a class="code" href="../../d3/da1/ossl__x509_8h.html#a55515b14c48c1afa36b99c1f5c6cc38d">GetX509CertPtr</a>(<a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(val)[i]);
<a name="l00608"></a>00608                 <span class="keywordflow">if</span> (!SSL_CTX_add_client_CA(ctx, client_ca)){
<a name="l00609"></a>00609                     <span class="comment">/* Copies X509_NAME =&gt; FREE it. */</span>
<a name="l00610"></a>00610                     <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;SSL_CTX_add_client_CA&quot;</span>);
<a name="l00611"></a>00611                 }
<a name="l00612"></a>00612             }
<a name="l00613"></a>00613         }
<a name="l00614"></a>00614         <span class="keywordflow">else</span>{
<a name="l00615"></a>00615             client_ca = <a class="code" href="../../d3/da1/ossl__x509_8h.html#a55515b14c48c1afa36b99c1f5c6cc38d">GetX509CertPtr</a>(val); <span class="comment">/* NO DUP NEEDED. */</span>
<a name="l00616"></a>00616             <span class="keywordflow">if</span> (!SSL_CTX_add_client_CA(ctx, client_ca)){
<a name="l00617"></a>00617                 <span class="comment">/* Copies X509_NAME =&gt; FREE it. */</span>
<a name="l00618"></a>00618                 <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;SSL_CTX_add_client_CA&quot;</span>);
<a name="l00619"></a>00619             }
<a name="l00620"></a>00620         }
<a name="l00621"></a>00621     }
<a name="l00622"></a>00622 
<a name="l00623"></a>00623     val = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaf5865bdc04646bea192cf2900a12ef6">ossl_sslctx_get_ca_file</a>(<span class="keyword">self</span>);
<a name="l00624"></a>00624     ca_file = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(val) ? <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2665a51abbd5b49c15abff3df00fa9db">StringValuePtr</a>(val);
<a name="l00625"></a>00625     val = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa758d07e2e1aaa6788f9862ad3caae32">ossl_sslctx_get_ca_path</a>(<span class="keyword">self</span>);
<a name="l00626"></a>00626     ca_path = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(val) ? <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2665a51abbd5b49c15abff3df00fa9db">StringValuePtr</a>(val);
<a name="l00627"></a>00627     <span class="keywordflow">if</span>(ca_file || ca_path){
<a name="l00628"></a>00628         <span class="keywordflow">if</span> (!SSL_CTX_load_verify_locations(ctx, ca_file, ca_path))
<a name="l00629"></a>00629             <a class="code" href="../../db/dcc/error_8c.html#afd461c64916576849b159b21a26123da">rb_warning</a>(<span class="stringliteral">&quot;can&apos;t set verify locations&quot;</span>);
<a name="l00630"></a>00630     }
<a name="l00631"></a>00631 
<a name="l00632"></a>00632     val = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a931b2ba7eefcf64cdc616471a2e90535">ossl_sslctx_get_verify_mode</a>(<span class="keyword">self</span>);
<a name="l00633"></a>00633     verify_mode = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(val) ? SSL_VERIFY_NONE : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(val);
<a name="l00634"></a>00634     SSL_CTX_set_verify(ctx, verify_mode, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5624418c2f05a0ef02fc32528aa1a246">ossl_ssl_verify_callback</a>);
<a name="l00635"></a>00635     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac394fa7178094ea01cb9a542f2029186">ossl_sslctx_get_client_cert_cb</a>(<span class="keyword">self</span>)))
<a name="l00636"></a>00636         SSL_CTX_set_client_cert_cb(ctx, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a93326260dee7e9a5194d2e95a286b700">ossl_client_cert_cb</a>);
<a name="l00637"></a>00637 
<a name="l00638"></a>00638     val = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#abdab56f62d167c25d2ace16bdcd94a11">ossl_sslctx_get_timeout</a>(<span class="keyword">self</span>);
<a name="l00639"></a>00639     <span class="keywordflow">if</span>(!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(val)) SSL_CTX_set_timeout(ctx, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(val));
<a name="l00640"></a>00640 
<a name="l00641"></a>00641     val = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a155c6f87c8aa46afd68504e671d423f6">ossl_sslctx_get_verify_dep</a>(<span class="keyword">self</span>);
<a name="l00642"></a>00642     <span class="keywordflow">if</span>(!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(val)) SSL_CTX_set_verify_depth(ctx, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(val));
<a name="l00643"></a>00643 
<a name="l00644"></a>00644     val = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a10e09afba71f9c132d3aeae0c5932c28">ossl_sslctx_get_options</a>(<span class="keyword">self</span>);
<a name="l00645"></a>00645     <span class="keywordflow">if</span>(!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(val)) {
<a name="l00646"></a>00646         SSL_CTX_set_options(ctx, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(val));
<a name="l00647"></a>00647     }
<a name="l00648"></a>00648     <span class="keywordflow">else</span> {
<a name="l00649"></a>00649         SSL_CTX_set_options(ctx, SSL_OP_ALL);
<a name="l00650"></a>00650     }
<a name="l00651"></a>00651     <a class="code" href="../../db/d2e/intern_8h.html#a8ea3742679211f408cb5769de6cf0d46">rb_obj_freeze</a>(<span class="keyword">self</span>);
<a name="l00652"></a>00652 
<a name="l00653"></a>00653     val = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a54bc993206b0cd89221acc9ef401d9e0">ossl_sslctx_get_sess_id_ctx</a>(<span class="keyword">self</span>);
<a name="l00654"></a>00654     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(val)){
<a name="l00655"></a>00655         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(val);
<a name="l00656"></a>00656         <span class="keywordflow">if</span> (!SSL_CTX_set_session_id_context(ctx, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(val),
<a name="l00657"></a>00657                                             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5133348f689646af76f8fe8e0af547f5">RSTRING_LENINT</a>(val))){
<a name="l00658"></a>00658             <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;SSL_CTX_set_session_id_context:&quot;</span>);
<a name="l00659"></a>00659         }
<a name="l00660"></a>00660     }
<a name="l00661"></a>00661 
<a name="l00662"></a>00662     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(<a class="code" href="../../db/d2e/intern_8h.html#ad05f3639fd927a08b07d12e2960936d4">rb_iv_get</a>(<span class="keyword">self</span>, <span class="stringliteral">&quot;@session_get_cb&quot;</span>))) {
<a name="l00663"></a>00663         SSL_CTX_sess_set_get_cb(ctx, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a2191472f9b551578a6df87dde0c41bb0">ossl_sslctx_session_get_cb</a>);
<a name="l00664"></a>00664         <a class="code" href="../../d5/dac/ossl_8h.html#af24156a85e9b3ac1aaac2d61976ea93a">OSSL_Debug</a>(<span class="stringliteral">&quot;SSL SESSION get callback added&quot;</span>);
<a name="l00665"></a>00665     }
<a name="l00666"></a>00666     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(<a class="code" href="../../db/d2e/intern_8h.html#ad05f3639fd927a08b07d12e2960936d4">rb_iv_get</a>(<span class="keyword">self</span>, <span class="stringliteral">&quot;@session_new_cb&quot;</span>))) {
<a name="l00667"></a>00667         SSL_CTX_sess_set_new_cb(ctx, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa312cab965f94195468bd936790a7a7f">ossl_sslctx_session_new_cb</a>);
<a name="l00668"></a>00668         <a class="code" href="../../d5/dac/ossl_8h.html#af24156a85e9b3ac1aaac2d61976ea93a">OSSL_Debug</a>(<span class="stringliteral">&quot;SSL SESSION new callback added&quot;</span>);
<a name="l00669"></a>00669     }
<a name="l00670"></a>00670     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(<a class="code" href="../../db/d2e/intern_8h.html#ad05f3639fd927a08b07d12e2960936d4">rb_iv_get</a>(<span class="keyword">self</span>, <span class="stringliteral">&quot;@session_remove_cb&quot;</span>))) {
<a name="l00671"></a>00671         SSL_CTX_sess_set_remove_cb(ctx, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ae3b7ba474eef4f00a03f7bbb441df423">ossl_sslctx_session_remove_cb</a>);
<a name="l00672"></a>00672         <a class="code" href="../../d5/dac/ossl_8h.html#af24156a85e9b3ac1aaac2d61976ea93a">OSSL_Debug</a>(<span class="stringliteral">&quot;SSL SESSION remove callback added&quot;</span>);
<a name="l00673"></a>00673     }
<a name="l00674"></a>00674 
<a name="l00675"></a>00675 <span class="preprocessor">#ifdef HAVE_SSL_SET_TLSEXT_HOST_NAME</span>
<a name="l00676"></a>00676 <span class="preprocessor"></span>    val = <a class="code" href="../../db/d2e/intern_8h.html#ad05f3639fd927a08b07d12e2960936d4">rb_iv_get</a>(<span class="keyword">self</span>, <span class="stringliteral">&quot;@servername_cb&quot;</span>);
<a name="l00677"></a>00677     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(val)) {
<a name="l00678"></a>00678         SSL_CTX_set_tlsext_servername_callback(ctx, ssl_servername_cb);
<a name="l00679"></a>00679         <a class="code" href="../../d5/dac/ossl_8h.html#af24156a85e9b3ac1aaac2d61976ea93a">OSSL_Debug</a>(<span class="stringliteral">&quot;SSL TLSEXT servername callback added&quot;</span>);
<a name="l00680"></a>00680     }
<a name="l00681"></a>00681 <span class="preprocessor">#endif</span>
<a name="l00682"></a>00682 <span class="preprocessor"></span>
<a name="l00683"></a>00683     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l00684"></a>00684 }
<a name="l00685"></a>00685 
<a name="l00686"></a>00686 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00687"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a90ee07e5ff132588373d7dcfb491192e">00687</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a90ee07e5ff132588373d7dcfb491192e">ossl_ssl_cipher_to_ary</a>(SSL_CIPHER *cipher)
<a name="l00688"></a>00688 {
<a name="l00689"></a>00689     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary;
<a name="l00690"></a>00690     <span class="keywordtype">int</span> bits, alg_bits;
<a name="l00691"></a>00691 
<a name="l00692"></a>00692     ary = <a class="code" href="../../dc/dcc/array_8c.html#a43a7bd246935ab63c233b4ae34d61d75">rb_ary_new2</a>(4);
<a name="l00693"></a>00693     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(SSL_CIPHER_get_name(cipher)));
<a name="l00694"></a>00694     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(SSL_CIPHER_get_version(cipher)));
<a name="l00695"></a>00695     bits = SSL_CIPHER_get_bits(cipher, &amp;alg_bits);
<a name="l00696"></a>00696     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(bits));
<a name="l00697"></a>00697     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(alg_bits));
<a name="l00698"></a>00698 
<a name="l00699"></a>00699     <span class="keywordflow">return</span> ary;
<a name="l00700"></a>00700 }
<a name="l00701"></a>00701 
<a name="l00702"></a>00702 <span class="comment">/*</span>
<a name="l00703"></a>00703 <span class="comment"> * call-seq:</span>
<a name="l00704"></a>00704 <span class="comment"> *    ctx.ciphers =&gt; [[name, version, bits, alg_bits], ...]</span>
<a name="l00705"></a>00705 <span class="comment"> *</span>
<a name="l00706"></a>00706 <span class="comment"> * The list of ciphers configured for this context.</span>
<a name="l00707"></a>00707 <span class="comment"> */</span>
<a name="l00708"></a>00708 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00709"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a6f4e0e48e6d8acf2367844cfc04b641e">00709</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a6f4e0e48e6d8acf2367844cfc04b641e">ossl_sslctx_get_ciphers</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l00710"></a>00710 {
<a name="l00711"></a>00711     SSL_CTX *ctx;
<a name="l00712"></a>00712     <a class="code" href="../../d5/dac/ossl_8h.html#afdc9179e243623337e07f01bf1404a8c">STACK_OF</a>(SSL_CIPHER) *ciphers;
<a name="l00713"></a>00713     SSL_CIPHER *cipher;
<a name="l00714"></a>00714     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary;
<a name="l00715"></a>00715     <span class="keywordtype">int</span> i, num;
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL_CTX, ctx);
<a name="l00718"></a>00718     <span class="keywordflow">if</span>(!ctx){
<a name="l00719"></a>00719         <a class="code" href="../../db/dcc/error_8c.html#afd461c64916576849b159b21a26123da">rb_warning</a>(<span class="stringliteral">&quot;SSL_CTX is not initialized.&quot;</span>);
<a name="l00720"></a>00720         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00721"></a>00721     }
<a name="l00722"></a>00722     ciphers = ctx-&gt;cipher_list;
<a name="l00723"></a>00723 
<a name="l00724"></a>00724     <span class="keywordflow">if</span> (!ciphers)
<a name="l00725"></a>00725         <span class="keywordflow">return</span> <a class="code" href="../../dc/dcc/array_8c.html#a9518114fd36cb4ef4656ec1dc63348c9">rb_ary_new</a>();
<a name="l00726"></a>00726 
<a name="l00727"></a>00727     num = sk_SSL_CIPHER_num(ciphers);
<a name="l00728"></a>00728     ary = <a class="code" href="../../dc/dcc/array_8c.html#a43a7bd246935ab63c233b4ae34d61d75">rb_ary_new2</a>(num);
<a name="l00729"></a>00729     <span class="keywordflow">for</span>(i = 0; i &lt; num; i++){
<a name="l00730"></a>00730         cipher = sk_SSL_CIPHER_value(ciphers, i);
<a name="l00731"></a>00731         <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a90ee07e5ff132588373d7dcfb491192e">ossl_ssl_cipher_to_ary</a>(cipher));
<a name="l00732"></a>00732     }
<a name="l00733"></a>00733     <span class="keywordflow">return</span> ary;
<a name="l00734"></a>00734 }
<a name="l00735"></a>00735 
<a name="l00736"></a>00736 <span class="comment">/*</span>
<a name="l00737"></a>00737 <span class="comment"> * call-seq:</span>
<a name="l00738"></a>00738 <span class="comment"> *    ctx.ciphers = &quot;cipher1:cipher2:...&quot;</span>
<a name="l00739"></a>00739 <span class="comment"> *    ctx.ciphers = [name, ...]</span>
<a name="l00740"></a>00740 <span class="comment"> *    ctx.ciphers = [[name, version, bits, alg_bits], ...]</span>
<a name="l00741"></a>00741 <span class="comment"> *</span>
<a name="l00742"></a>00742 <span class="comment"> * Sets the list of available ciphers for this context.  Note in a server</span>
<a name="l00743"></a>00743 <span class="comment"> * context some ciphers require the appropriate certificates.  For example, an</span>
<a name="l00744"></a>00744 <span class="comment"> * RSA cipher can only be chosen when an RSA certificate is available.</span>
<a name="l00745"></a>00745 <span class="comment"> *</span>
<a name="l00746"></a>00746 <span class="comment"> * See also OpenSSL::Cipher and OpenSSL::Cipher::ciphers</span>
<a name="l00747"></a>00747 <span class="comment"> */</span>
<a name="l00748"></a>00748 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00749"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a30f3752153ec92789da6cb1fbe2daaf4">00749</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a30f3752153ec92789da6cb1fbe2daaf4">ossl_sslctx_set_ciphers</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v)
<a name="l00750"></a>00750 {
<a name="l00751"></a>00751     SSL_CTX *ctx;
<a name="l00752"></a>00752     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, elem;
<a name="l00753"></a>00753     <span class="keywordtype">int</span> i;
<a name="l00754"></a>00754 
<a name="l00755"></a>00755     <a class="code" href="../../db/d2e/intern_8h.html#a372d6acb27d271ee4fc2e88c7022c485">rb_check_frozen</a>(<span class="keyword">self</span>);
<a name="l00756"></a>00756     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v))
<a name="l00757"></a>00757         <span class="keywordflow">return</span> v;
<a name="l00758"></a>00758     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(v) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a>) {
<a name="l00759"></a>00759         str = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(0, 0);
<a name="l00760"></a>00760         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(v); i++) {
<a name="l00761"></a>00761             elem = <a class="code" href="../../dc/dcc/array_8c.html#ae3c2ac6c88e666d5418855114eb8bcf8">rb_ary_entry</a>(v, i);
<a name="l00762"></a>00762             <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(elem) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a>) elem = <a class="code" href="../../dc/dcc/array_8c.html#ae3c2ac6c88e666d5418855114eb8bcf8">rb_ary_entry</a>(elem, 0);
<a name="l00763"></a>00763             elem = <a class="code" href="../../db/d2e/intern_8h.html#ad7cf2d103c6ce7d9b82c0076effac263">rb_String</a>(elem);
<a name="l00764"></a>00764             <a class="code" href="../../db/d2e/intern_8h.html#ab592dcd9e193dea76fb0ff58b5d907e4">rb_str_append</a>(str, elem);
<a name="l00765"></a>00765             <span class="keywordflow">if</span> (i &lt; <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(v)-1) <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(str, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l00766"></a>00766         }
<a name="l00767"></a>00767     } <span class="keywordflow">else</span> {
<a name="l00768"></a>00768         str = v;
<a name="l00769"></a>00769         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(str);
<a name="l00770"></a>00770     }
<a name="l00771"></a>00771 
<a name="l00772"></a>00772     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL_CTX, ctx);
<a name="l00773"></a>00773     <span class="keywordflow">if</span>(!ctx){
<a name="l00774"></a>00774         <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;SSL_CTX is not initialized.&quot;</span>);
<a name="l00775"></a>00775         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00776"></a>00776     }
<a name="l00777"></a>00777     <span class="keywordflow">if</span> (!SSL_CTX_set_cipher_list(ctx, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str))) {
<a name="l00778"></a>00778         <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;SSL_CTX_set_cipher_list:&quot;</span>);
<a name="l00779"></a>00779     }
<a name="l00780"></a>00780 
<a name="l00781"></a>00781     <span class="keywordflow">return</span> v;
<a name="l00782"></a>00782 }
<a name="l00783"></a>00783 
<a name="l00784"></a>00784 
<a name="l00785"></a>00785 <span class="comment">/*</span>
<a name="l00786"></a>00786 <span class="comment"> *  call-seq:</span>
<a name="l00787"></a>00787 <span class="comment"> *     ctx.session_add(session) -&gt; true | false</span>
<a name="l00788"></a>00788 <span class="comment"> *</span>
<a name="l00789"></a>00789 <span class="comment"> * Adds +session+ to the session cache</span>
<a name="l00790"></a>00790 <span class="comment"> */</span>
<a name="l00791"></a>00791 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00792"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#af5c18b7b8bf0532cfedb0db463bbc35b">00792</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#af5c18b7b8bf0532cfedb0db463bbc35b">ossl_sslctx_session_add</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l00793"></a>00793 {
<a name="l00794"></a>00794     SSL_CTX *ctx;
<a name="l00795"></a>00795     SSL_SESSION *sess;
<a name="l00796"></a>00796 
<a name="l00797"></a>00797     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL_CTX, ctx);
<a name="l00798"></a>00798     <a class="code" href="../../d6/d43/ossl__ssl_8h.html#a6a2c50eb14ed3451daff1fdad90d23e8">SafeGetSSLSession</a>(arg, sess);
<a name="l00799"></a>00799 
<a name="l00800"></a>00800     <span class="keywordflow">return</span> SSL_CTX_add_session(ctx, sess) == 1 ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l00801"></a>00801 }
<a name="l00802"></a>00802 
<a name="l00803"></a>00803 <span class="comment">/*</span>
<a name="l00804"></a>00804 <span class="comment"> *  call-seq:</span>
<a name="l00805"></a>00805 <span class="comment"> *     ctx.session_remove(session) -&gt; true | false</span>
<a name="l00806"></a>00806 <span class="comment"> *</span>
<a name="l00807"></a>00807 <span class="comment"> * Removes +session+ from the session cache</span>
<a name="l00808"></a>00808 <span class="comment"> */</span>
<a name="l00809"></a>00809 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00810"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a1cd49657a932a57661a406a13f209148">00810</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a1cd49657a932a57661a406a13f209148">ossl_sslctx_session_remove</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l00811"></a>00811 {
<a name="l00812"></a>00812     SSL_CTX *ctx;
<a name="l00813"></a>00813     SSL_SESSION *sess;
<a name="l00814"></a>00814 
<a name="l00815"></a>00815     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL_CTX, ctx);
<a name="l00816"></a>00816     <a class="code" href="../../d6/d43/ossl__ssl_8h.html#a6a2c50eb14ed3451daff1fdad90d23e8">SafeGetSSLSession</a>(arg, sess);
<a name="l00817"></a>00817 
<a name="l00818"></a>00818     <span class="keywordflow">return</span> SSL_CTX_remove_session(ctx, sess) == 1 ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l00819"></a>00819 }
<a name="l00820"></a>00820 
<a name="l00821"></a>00821 <span class="comment">/*</span>
<a name="l00822"></a>00822 <span class="comment"> *  call-seq:</span>
<a name="l00823"></a>00823 <span class="comment"> *     ctx.session_cache_mode -&gt; Integer</span>
<a name="l00824"></a>00824 <span class="comment"> *</span>
<a name="l00825"></a>00825 <span class="comment"> * The current session cache mode.</span>
<a name="l00826"></a>00826 <span class="comment"> */</span>
<a name="l00827"></a>00827 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00828"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3c9ed757f1a4d39af379cfdff11c2321">00828</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3c9ed757f1a4d39af379cfdff11c2321">ossl_sslctx_get_session_cache_mode</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l00829"></a>00829 {
<a name="l00830"></a>00830     SSL_CTX *ctx;
<a name="l00831"></a>00831 
<a name="l00832"></a>00832     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL_CTX, ctx);
<a name="l00833"></a>00833 
<a name="l00834"></a>00834     <span class="keywordflow">return</span> <a class="code" href="../../dc/d0c/cparse_8c.html#af1afba1194a12547a1e65d92abf03b03">LONG2NUM</a>(SSL_CTX_get_session_cache_mode(ctx));
<a name="l00835"></a>00835 }
<a name="l00836"></a>00836 
<a name="l00837"></a>00837 <span class="comment">/*</span>
<a name="l00838"></a>00838 <span class="comment"> *  call-seq:</span>
<a name="l00839"></a>00839 <span class="comment"> *     ctx.session_cache_mode=(integer) -&gt; Integer</span>
<a name="l00840"></a>00840 <span class="comment"> *</span>
<a name="l00841"></a>00841 <span class="comment"> * Sets the SSL session cache mode.  Bitwise-or together the desired</span>
<a name="l00842"></a>00842 <span class="comment"> * SESSION_CACHE_* constants to set.  See SSL_CTX_set_session_cache_mode(3) for</span>
<a name="l00843"></a>00843 <span class="comment"> * details.</span>
<a name="l00844"></a>00844 <span class="comment"> */</span>
<a name="l00845"></a>00845 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00846"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a61b9b791b5cb4737096bc25289639b8c">00846</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a61b9b791b5cb4737096bc25289639b8c">ossl_sslctx_set_session_cache_mode</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l00847"></a>00847 {
<a name="l00848"></a>00848     SSL_CTX *ctx;
<a name="l00849"></a>00849 
<a name="l00850"></a>00850     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL_CTX, ctx);
<a name="l00851"></a>00851 
<a name="l00852"></a>00852     SSL_CTX_set_session_cache_mode(ctx, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(arg));
<a name="l00853"></a>00853 
<a name="l00854"></a>00854     <span class="keywordflow">return</span> arg;
<a name="l00855"></a>00855 }
<a name="l00856"></a>00856 
<a name="l00857"></a>00857 <span class="comment">/*</span>
<a name="l00858"></a>00858 <span class="comment"> *  call-seq:</span>
<a name="l00859"></a>00859 <span class="comment"> *     ctx.session_cache_size -&gt; Integer</span>
<a name="l00860"></a>00860 <span class="comment"> *</span>
<a name="l00861"></a>00861 <span class="comment"> * Returns the current session cache size.  Zero is used to represent an</span>
<a name="l00862"></a>00862 <span class="comment"> * unlimited cache size.</span>
<a name="l00863"></a>00863 <span class="comment"> */</span>
<a name="l00864"></a>00864 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00865"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ad8537494667d7ff66a03115583d621dc">00865</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ad8537494667d7ff66a03115583d621dc">ossl_sslctx_get_session_cache_size</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l00866"></a>00866 {
<a name="l00867"></a>00867     SSL_CTX *ctx;
<a name="l00868"></a>00868 
<a name="l00869"></a>00869     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL_CTX, ctx);
<a name="l00870"></a>00870 
<a name="l00871"></a>00871     <span class="keywordflow">return</span> <a class="code" href="../../dc/d0c/cparse_8c.html#af1afba1194a12547a1e65d92abf03b03">LONG2NUM</a>(SSL_CTX_sess_get_cache_size(ctx));
<a name="l00872"></a>00872 }
<a name="l00873"></a>00873 
<a name="l00874"></a>00874 <span class="comment">/*</span>
<a name="l00875"></a>00875 <span class="comment"> *  call-seq:</span>
<a name="l00876"></a>00876 <span class="comment"> *     ctx.session_cache_size=(integer) -&gt; Integer</span>
<a name="l00877"></a>00877 <span class="comment"> *</span>
<a name="l00878"></a>00878 <span class="comment"> * Sets the session cache size.  Returns the previously valid session cache</span>
<a name="l00879"></a>00879 <span class="comment"> * size.  Zero is used to represent an unlimited session cache size.</span>
<a name="l00880"></a>00880 <span class="comment"> */</span>
<a name="l00881"></a>00881 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00882"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a6f2dd6611416ddc134cc9ff2baa73be4">00882</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a6f2dd6611416ddc134cc9ff2baa73be4">ossl_sslctx_set_session_cache_size</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l00883"></a>00883 {
<a name="l00884"></a>00884     SSL_CTX *ctx;
<a name="l00885"></a>00885 
<a name="l00886"></a>00886     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL_CTX, ctx);
<a name="l00887"></a>00887 
<a name="l00888"></a>00888     SSL_CTX_sess_set_cache_size(ctx, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(arg));
<a name="l00889"></a>00889 
<a name="l00890"></a>00890     <span class="keywordflow">return</span> arg;
<a name="l00891"></a>00891 }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893 <span class="comment">/*</span>
<a name="l00894"></a>00894 <span class="comment"> *  call-seq:</span>
<a name="l00895"></a>00895 <span class="comment"> *     ctx.session_cache_stats -&gt; Hash</span>
<a name="l00896"></a>00896 <span class="comment"> *</span>
<a name="l00897"></a>00897 <span class="comment"> * Returns a Hash containing the following keys:</span>
<a name="l00898"></a>00898 <span class="comment"> *</span>
<a name="l00899"></a>00899 <span class="comment"> * :accept:: Number of started SSL/TLS handshakes in server mode</span>
<a name="l00900"></a>00900 <span class="comment"> * :accept_good:: Number of established SSL/TLS sessions in server mode</span>
<a name="l00901"></a>00901 <span class="comment"> * :accept_renegotiate:: Number of start renegotiations in server mode</span>
<a name="l00902"></a>00902 <span class="comment"> * :cache_full:: Number of sessions that were removed due to cache overflow</span>
<a name="l00903"></a>00903 <span class="comment"> * :cache_hits:: Number of successfully reused connections</span>
<a name="l00904"></a>00904 <span class="comment"> * :cache_misses:: Number of sessions proposed by clients that were not found</span>
<a name="l00905"></a>00905 <span class="comment"> *                 in the cache</span>
<a name="l00906"></a>00906 <span class="comment"> * :cache_num:: Number of sessions in the internal session cache</span>
<a name="l00907"></a>00907 <span class="comment"> * :cb_hits:: Number of sessions retrieved from the external cache in server</span>
<a name="l00908"></a>00908 <span class="comment"> *            mode</span>
<a name="l00909"></a>00909 <span class="comment"> * :connect:: Number of started SSL/TLS handshakes in client mode</span>
<a name="l00910"></a>00910 <span class="comment"> * :connect_good:: Number of established SSL/TLS sessions in client mode</span>
<a name="l00911"></a>00911 <span class="comment"> * :connect_renegotiate:: Number of start renegotiations in client mode</span>
<a name="l00912"></a>00912 <span class="comment"> * :timeouts:: Number of sessions proposed by clients that were found in the</span>
<a name="l00913"></a>00913 <span class="comment"> *             cache but had expired due to timeouts</span>
<a name="l00914"></a>00914 <span class="comment"> */</span>
<a name="l00915"></a>00915 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00916"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3fd30d8c36d0ec8d3aa93ae824e3cd60">00916</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3fd30d8c36d0ec8d3aa93ae824e3cd60">ossl_sslctx_get_session_cache_stats</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l00917"></a>00917 {
<a name="l00918"></a>00918     SSL_CTX *ctx;
<a name="l00919"></a>00919     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/deb/lex_8c.html#a5541f85ce416df233cce93949f0eeeca">hash</a>;
<a name="l00920"></a>00920 
<a name="l00921"></a>00921     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL_CTX, ctx);
<a name="l00922"></a>00922 
<a name="l00923"></a>00923     hash = <a class="code" href="../../d1/d04/hash_8c.html#af1da586524a3a1739fd5b91272037815">rb_hash_new</a>();
<a name="l00924"></a>00924     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;cache_num&quot;</span>)), <a class="code" href="../../dc/d0c/cparse_8c.html#af1afba1194a12547a1e65d92abf03b03">LONG2NUM</a>(SSL_CTX_sess_number(ctx)));
<a name="l00925"></a>00925     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;connect&quot;</span>)), <a class="code" href="../../dc/d0c/cparse_8c.html#af1afba1194a12547a1e65d92abf03b03">LONG2NUM</a>(SSL_CTX_sess_connect(ctx)));
<a name="l00926"></a>00926     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;connect_good&quot;</span>)), <a class="code" href="../../dc/d0c/cparse_8c.html#af1afba1194a12547a1e65d92abf03b03">LONG2NUM</a>(SSL_CTX_sess_connect_good(ctx)));
<a name="l00927"></a>00927     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;connect_renegotiate&quot;</span>)), <a class="code" href="../../dc/d0c/cparse_8c.html#af1afba1194a12547a1e65d92abf03b03">LONG2NUM</a>(SSL_CTX_sess_connect_renegotiate(ctx)));
<a name="l00928"></a>00928     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;accept&quot;</span>)), <a class="code" href="../../dc/d0c/cparse_8c.html#af1afba1194a12547a1e65d92abf03b03">LONG2NUM</a>(SSL_CTX_sess_accept(ctx)));
<a name="l00929"></a>00929     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;accept_good&quot;</span>)), <a class="code" href="../../dc/d0c/cparse_8c.html#af1afba1194a12547a1e65d92abf03b03">LONG2NUM</a>(SSL_CTX_sess_accept_good(ctx)));
<a name="l00930"></a>00930     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;accept_renegotiate&quot;</span>)), <a class="code" href="../../dc/d0c/cparse_8c.html#af1afba1194a12547a1e65d92abf03b03">LONG2NUM</a>(SSL_CTX_sess_accept_renegotiate(ctx)));
<a name="l00931"></a>00931     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;cache_hits&quot;</span>)), <a class="code" href="../../dc/d0c/cparse_8c.html#af1afba1194a12547a1e65d92abf03b03">LONG2NUM</a>(SSL_CTX_sess_hits(ctx)));
<a name="l00932"></a>00932     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;cb_hits&quot;</span>)), <a class="code" href="../../dc/d0c/cparse_8c.html#af1afba1194a12547a1e65d92abf03b03">LONG2NUM</a>(SSL_CTX_sess_cb_hits(ctx)));
<a name="l00933"></a>00933     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;cache_misses&quot;</span>)), <a class="code" href="../../dc/d0c/cparse_8c.html#af1afba1194a12547a1e65d92abf03b03">LONG2NUM</a>(SSL_CTX_sess_misses(ctx)));
<a name="l00934"></a>00934     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;cache_full&quot;</span>)), <a class="code" href="../../dc/d0c/cparse_8c.html#af1afba1194a12547a1e65d92abf03b03">LONG2NUM</a>(SSL_CTX_sess_cache_full(ctx)));
<a name="l00935"></a>00935     <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(hash, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;timeouts&quot;</span>)), <a class="code" href="../../dc/d0c/cparse_8c.html#af1afba1194a12547a1e65d92abf03b03">LONG2NUM</a>(SSL_CTX_sess_timeouts(ctx)));
<a name="l00936"></a>00936 
<a name="l00937"></a>00937     <span class="keywordflow">return</span> hash;
<a name="l00938"></a>00938 }
<a name="l00939"></a>00939 
<a name="l00940"></a>00940 
<a name="l00941"></a>00941 <span class="comment">/*</span>
<a name="l00942"></a>00942 <span class="comment"> *  call-seq:</span>
<a name="l00943"></a>00943 <span class="comment"> *     ctx.flush_sessions(time | nil) -&gt; self</span>
<a name="l00944"></a>00944 <span class="comment"> *</span>
<a name="l00945"></a>00945 <span class="comment"> * Removes sessions in the internal cache that have expired at +time+.</span>
<a name="l00946"></a>00946 <span class="comment"> */</span>
<a name="l00947"></a>00947 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00948"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a740b7c266bc5b62405d92adaaa5f0217">00948</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a740b7c266bc5b62405d92adaaa5f0217">ossl_sslctx_flush_sessions</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l00949"></a>00949 {
<a name="l00950"></a>00950     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg1;
<a name="l00951"></a>00951     SSL_CTX *ctx;
<a name="l00952"></a>00952     <a class="code" href="../../d3/d90/missing_8h.html#a7157cbb87d46be33f7f913fa09144900">time_t</a> tm = 0;
<a name="l00953"></a>00953 
<a name="l00954"></a>00954     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;01&quot;</span>, &amp;arg1);
<a name="l00955"></a>00955 
<a name="l00956"></a>00956     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL_CTX, ctx);
<a name="l00957"></a>00957 
<a name="l00958"></a>00958     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(arg1)) {
<a name="l00959"></a>00959         tm = time(0);
<a name="l00960"></a>00960     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#a04d0862c584bd79f66702d353af335af">rb_obj_is_instance_of</a>(arg1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a66f2d68e8b195fed5d03f60cb42ba31b">rb_cTime</a>)) {
<a name="l00961"></a>00961         tm = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(arg1, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;to_i&quot;</span>), 0));
<a name="l00962"></a>00962     } <span class="keywordflow">else</span> {
<a name="l00963"></a>00963         <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;arg must be Time or nil&quot;</span>);
<a name="l00964"></a>00964     }
<a name="l00965"></a>00965 
<a name="l00966"></a>00966     SSL_CTX_flush_sessions(ctx, (<span class="keywordtype">long</span>)tm);
<a name="l00967"></a>00967 
<a name="l00968"></a>00968     <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l00969"></a>00969 }
<a name="l00970"></a>00970 
<a name="l00971"></a>00971 <span class="comment">/*</span>
<a name="l00972"></a>00972 <span class="comment"> * SSLSocket class</span>
<a name="l00973"></a>00973 <span class="comment"> */</span>
<a name="l00974"></a>00974 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00975"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a107fc09999e5bba192dfad7f34ea849c">00975</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a107fc09999e5bba192dfad7f34ea849c">ossl_ssl_shutdown</a>(SSL *ssl)
<a name="l00976"></a>00976 {
<a name="l00977"></a>00977     <span class="keywordtype">int</span> i, rc;
<a name="l00978"></a>00978 
<a name="l00979"></a>00979     <span class="keywordflow">if</span> (ssl) {
<a name="l00980"></a>00980         <span class="comment">/* 4 is from SSL_smart_shutdown() of mod_ssl.c (v2.2.19) */</span>
<a name="l00981"></a>00981         <span class="comment">/* It says max 2x pending + 2x data = 4 */</span>
<a name="l00982"></a>00982         <span class="keywordflow">for</span> (i = 0; i &lt; 4; ++i) {
<a name="l00983"></a>00983             <span class="comment">/*</span>
<a name="l00984"></a>00984 <span class="comment">             * Ignore the case SSL_shutdown returns -1. Empty handshake_func</span>
<a name="l00985"></a>00985 <span class="comment">             * must not happen.</span>
<a name="l00986"></a>00986 <span class="comment">             */</span>
<a name="l00987"></a>00987             <span class="keywordflow">if</span> (rc = SSL_shutdown(ssl))
<a name="l00988"></a>00988                 <span class="keywordflow">break</span>;
<a name="l00989"></a>00989         }
<a name="l00990"></a>00990         ERR_clear_error();
<a name="l00991"></a>00991         SSL_clear(ssl);
<a name="l00992"></a>00992     }
<a name="l00993"></a>00993 }
<a name="l00994"></a>00994 
<a name="l00995"></a>00995 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00996"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac4030d215b38b8c783681edca70a4b55">00996</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac4030d215b38b8c783681edca70a4b55">ossl_ssl_free</a>(SSL *ssl)
<a name="l00997"></a>00997 {
<a name="l00998"></a>00998     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a107fc09999e5bba192dfad7f34ea849c">ossl_ssl_shutdown</a>(ssl);
<a name="l00999"></a>00999     SSL_free(ssl);
<a name="l01000"></a>01000 }
<a name="l01001"></a>01001 
<a name="l01002"></a>01002 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01003"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab6cd346c26f168866c1e79633056178e">01003</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab6cd346c26f168866c1e79633056178e">ossl_ssl_s_alloc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass)
<a name="l01004"></a>01004 {
<a name="l01005"></a>01005     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a27705a261a9addb9ed4cb65dd5a61b1c">Data_Wrap_Struct</a>(klass, 0, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac4030d215b38b8c783681edca70a4b55">ossl_ssl_free</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l01006"></a>01006 }
<a name="l01007"></a>01007 
<a name="l01008"></a>01008 <span class="comment">/*</span>
<a name="l01009"></a>01009 <span class="comment"> * call-seq:</span>
<a name="l01010"></a>01010 <span class="comment"> *    SSLSocket.new(io) =&gt; aSSLSocket</span>
<a name="l01011"></a>01011 <span class="comment"> *    SSLSocket.new(io, ctx) =&gt; aSSLSocket</span>
<a name="l01012"></a>01012 <span class="comment"> *</span>
<a name="l01013"></a>01013 <span class="comment"> * Creates a new SSL socket from +io+ which must be a real ruby object (not an</span>
<a name="l01014"></a>01014 <span class="comment"> * IO-like object that responds to read/write.</span>
<a name="l01015"></a>01015 <span class="comment"> *</span>
<a name="l01016"></a>01016 <span class="comment"> * If +ctx+ is provided the SSL Sockets initial params will be taken from</span>
<a name="l01017"></a>01017 <span class="comment"> * the context.</span>
<a name="l01018"></a>01018 <span class="comment"> *</span>
<a name="l01019"></a>01019 <span class="comment"> * The OpenSSL::Buffering module provides additional IO methods.</span>
<a name="l01020"></a>01020 <span class="comment"> *</span>
<a name="l01021"></a>01021 <span class="comment"> * This method will freeze the SSLContext if one is provided;</span>
<a name="l01022"></a>01022 <span class="comment"> * however, session management is still allowed in the frozen SSLContext.</span>
<a name="l01023"></a>01023 <span class="comment"> */</span>
<a name="l01024"></a>01024 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01025"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab5347a694d19982df0a446fed4aceb83">01025</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab5347a694d19982df0a446fed4aceb83">ossl_ssl_initialize</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01026"></a>01026 {
<a name="l01027"></a>01027     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, ctx;
<a name="l01028"></a>01028 
<a name="l01029"></a>01029     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;11&quot;</span>, &amp;io, &amp;ctx) == 1) {
<a name="l01030"></a>01030         ctx = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;new&quot;</span>), 0);
<a name="l01031"></a>01031     }
<a name="l01032"></a>01032     <a class="code" href="../../d5/dac/ossl_8h.html#ad141f6f7174f7556e3c2be1815a136c4">OSSL_Check_Kind</a>(ctx, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>);
<a name="l01033"></a>01033     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad5a1e03b0a66824f95f6aaf07b4a4052">Check_Type</a>(io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a>);
<a name="l01034"></a>01034     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a54b5c781ff92bd6866ee9a29393d49a7">ossl_ssl_set_io</a>(<span class="keyword">self</span>, io);
<a name="l01035"></a>01035     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a11ce601a226355c361beb71d991d5280">ossl_ssl_set_ctx</a>(<span class="keyword">self</span>, ctx);
<a name="l01036"></a>01036     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a0f1610b40201c60d82658d6349d29ecd">ossl_ssl_set_sync_close</a>(<span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01037"></a>01037     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aee593ff89ad5d4eaeeb4948555ad5f3e">ossl_sslctx_setup</a>(ctx);
<a name="l01038"></a>01038 
<a name="l01039"></a>01039     <a class="code" href="../../db/d2e/intern_8h.html#a7e5b0d4c40fecb26c1ac946f674a690e">rb_iv_set</a>(<span class="keyword">self</span>, <span class="stringliteral">&quot;@hostname&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l01040"></a>01040 
<a name="l01041"></a>01041     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af86a62661fef3c00f697b8a1d37fd92a">rb_call_super</a>(0, 0);
<a name="l01042"></a>01042 
<a name="l01043"></a>01043     <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l01044"></a>01044 }
<a name="l01045"></a>01045 
<a name="l01046"></a>01046 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01047"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac941f56a8ea80057259039a5d58fd3b3">01047</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac941f56a8ea80057259039a5d58fd3b3">ossl_ssl_setup</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01048"></a>01048 {
<a name="l01049"></a>01049     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, v_ctx, cb;
<a name="l01050"></a>01050     SSL_CTX *ctx;
<a name="l01051"></a>01051     SSL *ssl;
<a name="l01052"></a>01052     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01053"></a>01053 
<a name="l01054"></a>01054     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL, ssl);
<a name="l01055"></a>01055     <span class="keywordflow">if</span>(!ssl){
<a name="l01056"></a>01056 <span class="preprocessor">#ifdef HAVE_SSL_SET_TLSEXT_HOST_NAME</span>
<a name="l01057"></a>01057 <span class="preprocessor"></span>        <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> hostname = <a class="code" href="../../db/d2e/intern_8h.html#ad05f3639fd927a08b07d12e2960936d4">rb_iv_get</a>(<span class="keyword">self</span>, <span class="stringliteral">&quot;@hostname&quot;</span>);
<a name="l01058"></a>01058 <span class="preprocessor">#endif</span>
<a name="l01059"></a>01059 <span class="preprocessor"></span>
<a name="l01060"></a>01060         v_ctx = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa73bafb5706de8b7d1935a999154bd44">ossl_ssl_get_ctx</a>(<span class="keyword">self</span>);
<a name="l01061"></a>01061         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(v_ctx, SSL_CTX, ctx);
<a name="l01062"></a>01062 
<a name="l01063"></a>01063         ssl = SSL_new(ctx);
<a name="l01064"></a>01064         <span class="keywordflow">if</span> (!ssl) {
<a name="l01065"></a>01065             <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;SSL_new:&quot;</span>);
<a name="l01066"></a>01066         }
<a name="l01067"></a>01067         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abb509cfdf6560a9f795b1f6932d93691">DATA_PTR</a>(<span class="keyword">self</span>) = ssl;
<a name="l01068"></a>01068 
<a name="l01069"></a>01069 <span class="preprocessor">#ifdef HAVE_SSL_SET_TLSEXT_HOST_NAME</span>
<a name="l01070"></a>01070 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(hostname)) {
<a name="l01071"></a>01071            <span class="keywordflow">if</span> (SSL_set_tlsext_host_name(ssl, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2665a51abbd5b49c15abff3df00fa9db">StringValuePtr</a>(hostname)) != 1)
<a name="l01072"></a>01072                <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;SSL_set_tlsext_host_name:&quot;</span>);
<a name="l01073"></a>01073         }
<a name="l01074"></a>01074 <span class="preprocessor">#endif</span>
<a name="l01075"></a>01075 <span class="preprocessor"></span>        io = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a98c4ad64d4c521ae11e9f683e4ee1ee4">ossl_ssl_get_io</a>(<span class="keyword">self</span>);
<a name="l01076"></a>01076         <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l01077"></a>01077         <a class="code" href="../../dc/dac/io_8h.html#a8557569435da7f8a669908723fcd5e94">rb_io_check_readable</a>(fptr);
<a name="l01078"></a>01078         <a class="code" href="../../dc/dac/io_8h.html#a728977df67c656197402bb30a14af953">rb_io_check_writable</a>(fptr);
<a name="l01079"></a>01079         SSL_set_fd(ssl, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a4fcd1cb4ec15fbbafd4088168e13fa9a">TO_SOCKET</a>(<a class="code" href="../../d8/d81/ruby__missing_8h.html#a90e20054f3e1241918bbdacd6744916e">FPTR_TO_FD</a>(fptr)));
<a name="l01080"></a>01080         SSL_set_ex_data(ssl, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa3c26a2268bba8099b8b629b9808d267">ossl_ssl_ex_ptr_idx</a>, (<span class="keywordtype">void</span>*)<span class="keyword">self</span>);
<a name="l01081"></a>01081         cb = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ae99561e321fe7e94c26f7ec64a349e6f">ossl_sslctx_get_verify_cb</a>(v_ctx);
<a name="l01082"></a>01082         SSL_set_ex_data(ssl, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaccb4c51a7650ead12e74e5ce071750f">ossl_ssl_ex_vcb_idx</a>, (<span class="keywordtype">void</span>*)cb);
<a name="l01083"></a>01083         cb = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac394fa7178094ea01cb9a542f2029186">ossl_sslctx_get_client_cert_cb</a>(v_ctx);
<a name="l01084"></a>01084         SSL_set_ex_data(ssl, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39218e865ef8154ca806c6514b3d4c25">ossl_ssl_ex_client_cert_cb_idx</a>, (<span class="keywordtype">void</span>*)cb);
<a name="l01085"></a>01085         cb = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a13e3d231cd90b2bd6acb78ad87703ee4">ossl_sslctx_get_tmp_dh_cb</a>(v_ctx);
<a name="l01086"></a>01086         SSL_set_ex_data(ssl, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac71ee4a16f11ab58ff8bb63bfb489bf8">ossl_ssl_ex_tmp_dh_callback_idx</a>, (<span class="keywordtype">void</span>*)cb);
<a name="l01087"></a>01087     }
<a name="l01088"></a>01088 
<a name="l01089"></a>01089     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l01090"></a>01090 }
<a name="l01091"></a>01091 
<a name="l01092"></a>01092 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l01093"></a>01093 <span class="preprocessor"></span><span class="preprocessor">#define ssl_get_error(ssl, ret) (errno = rb_w32_map_errno(WSAGetLastError()), SSL_get_error((ssl), (ret)))</span>
<a name="l01094"></a>01094 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l01095"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a0b8b3b367e26ee5dd77abaf0c865f2de">01095</a> <span class="preprocessor"></span><span class="preprocessor">#define ssl_get_error(ssl, ret) SSL_get_error((ssl), (ret))</span>
<a name="l01096"></a>01096 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01097"></a>01097 <span class="preprocessor"></span>
<a name="l01098"></a>01098 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01099"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a410c77cece0c4eef895e02ac5fc3d09d">01099</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a410c77cece0c4eef895e02ac5fc3d09d">write_would_block</a>(<span class="keywordtype">int</span> nonblock)
<a name="l01100"></a>01100 {
<a name="l01101"></a>01101     <span class="keywordflow">if</span> (nonblock) {
<a name="l01102"></a>01102         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> exc = <a class="code" href="../../d4/d3c/ossl_8c.html#a8e9c858d24396a2429b6c18523e7d928">ossl_exc_new</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;write would block&quot;</span>);
<a name="l01103"></a>01103         <a class="code" href="../../d3/d57/eval_8c.html#a157fb11af4678daed6923e40acaaf9b2">rb_extend_object</a>(exc, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac0e6048c512add5b6659c01f7f134d8a">rb_mWaitWritable</a>);
<a name="l01104"></a>01104         <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(exc);
<a name="l01105"></a>01105     }
<a name="l01106"></a>01106 }
<a name="l01107"></a>01107 
<a name="l01108"></a>01108 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01109"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a79b925a2ba52c76bbe1e5a61b5a4270a">01109</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a79b925a2ba52c76bbe1e5a61b5a4270a">read_would_block</a>(<span class="keywordtype">int</span> nonblock)
<a name="l01110"></a>01110 {
<a name="l01111"></a>01111     <span class="keywordflow">if</span> (nonblock) {
<a name="l01112"></a>01112         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> exc = <a class="code" href="../../d4/d3c/ossl_8c.html#a8e9c858d24396a2429b6c18523e7d928">ossl_exc_new</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;read would block&quot;</span>);
<a name="l01113"></a>01113         <a class="code" href="../../d3/d57/eval_8c.html#a157fb11af4678daed6923e40acaaf9b2">rb_extend_object</a>(exc, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac2d47e89b7cb8311129ec7566608a0b2">rb_mWaitReadable</a>);
<a name="l01114"></a>01114         <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(exc);
<a name="l01115"></a>01115     }
<a name="l01116"></a>01116 }
<a name="l01117"></a>01117 
<a name="l01118"></a>01118 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01119"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#abf2015926de1356fb8e255e36e8fd938">01119</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#abf2015926de1356fb8e255e36e8fd938">ossl_start_ssl</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <span class="keywordtype">int</span> (*<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a>)(), <span class="keyword">const</span> <span class="keywordtype">char</span> *funcname, <span class="keywordtype">int</span> nonblock)
<a name="l01120"></a>01120 {
<a name="l01121"></a>01121     SSL *ssl;
<a name="l01122"></a>01122     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01123"></a>01123     <span class="keywordtype">int</span> ret, ret2;
<a name="l01124"></a>01124     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> cb_state;
<a name="l01125"></a>01125 
<a name="l01126"></a>01126     <a class="code" href="../../db/d2e/intern_8h.html#acee88ad0375c8a9080e2283db494d257">rb_ivar_set</a>(<span class="keyword">self</span>, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a03b3aad781a6c9b2f9b8a7f3c319f97e">ID_callback_state</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l01127"></a>01127 
<a name="l01128"></a>01128     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL, ssl);
<a name="l01129"></a>01129     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a98c4ad64d4c521ae11e9f683e4ee1ee4">ossl_ssl_get_io</a>(<span class="keyword">self</span>), fptr);
<a name="l01130"></a>01130     <span class="keywordflow">for</span>(;;){
<a name="l01131"></a>01131         ret = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a>(ssl);
<a name="l01132"></a>01132 
<a name="l01133"></a>01133         cb_state = <a class="code" href="../../db/d2e/intern_8h.html#a35a10b958666c1b330238eea7b7f3a8a">rb_ivar_get</a>(<span class="keyword">self</span>, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a03b3aad781a6c9b2f9b8a7f3c319f97e">ID_callback_state</a>);
<a name="l01134"></a>01134         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(cb_state))
<a name="l01135"></a>01135             <a class="code" href="../../d3/d57/eval_8c.html#ae48d70c45901eab8b89fb181fc9d1f3b">rb_jump_tag</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(cb_state));
<a name="l01136"></a>01136 
<a name="l01137"></a>01137         <span class="keywordflow">if</span> (ret &gt; 0)
<a name="l01138"></a>01138             <span class="keywordflow">break</span>;
<a name="l01139"></a>01139 
<a name="l01140"></a>01140         <span class="keywordflow">switch</span>((ret2 = <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a0b8b3b367e26ee5dd77abaf0c865f2de">ssl_get_error</a>(ssl, ret))){
<a name="l01141"></a>01141         <span class="keywordflow">case</span> SSL_ERROR_WANT_WRITE:
<a name="l01142"></a>01142             <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a410c77cece0c4eef895e02ac5fc3d09d">write_would_block</a>(nonblock);
<a name="l01143"></a>01143             <a class="code" href="../../dc/dac/io_8h.html#af28a170d3ffb07353653f832d95c6ba6">rb_io_wait_writable</a>(<a class="code" href="../../d8/d81/ruby__missing_8h.html#a90e20054f3e1241918bbdacd6744916e">FPTR_TO_FD</a>(fptr));
<a name="l01144"></a>01144             <span class="keywordflow">continue</span>;
<a name="l01145"></a>01145         <span class="keywordflow">case</span> SSL_ERROR_WANT_READ:
<a name="l01146"></a>01146             <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a79b925a2ba52c76bbe1e5a61b5a4270a">read_would_block</a>(nonblock);
<a name="l01147"></a>01147             <a class="code" href="../../dc/dac/io_8h.html#aef370f8ba67623893a3b559bf27b30e3">rb_io_wait_readable</a>(<a class="code" href="../../d8/d81/ruby__missing_8h.html#a90e20054f3e1241918bbdacd6744916e">FPTR_TO_FD</a>(fptr));
<a name="l01148"></a>01148             <span class="keywordflow">continue</span>;
<a name="l01149"></a>01149         <span class="keywordflow">case</span> SSL_ERROR_SYSCALL:
<a name="l01150"></a>01150             <span class="keywordflow">if</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(funcname);
<a name="l01151"></a>01151             <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;%s SYSCALL returned=%d errno=%d state=%s&quot;</span>, funcname, ret2, <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, SSL_state_string_long(ssl));
<a name="l01152"></a>01152         <span class="keywordflow">default</span>:
<a name="l01153"></a>01153             <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;%s returned=%d errno=%d state=%s&quot;</span>, funcname, ret2, <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, SSL_state_string_long(ssl));
<a name="l01154"></a>01154         }
<a name="l01155"></a>01155     }
<a name="l01156"></a>01156 
<a name="l01157"></a>01157     <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l01158"></a>01158 }
<a name="l01159"></a>01159 
<a name="l01160"></a>01160 <span class="comment">/*</span>
<a name="l01161"></a>01161 <span class="comment"> * call-seq:</span>
<a name="l01162"></a>01162 <span class="comment"> *    ssl.connect =&gt; self</span>
<a name="l01163"></a>01163 <span class="comment"> *</span>
<a name="l01164"></a>01164 <span class="comment"> * Initiates an SSL/TLS handshake with a server.  The handshake may be started</span>
<a name="l01165"></a>01165 <span class="comment"> * after unencrypted data has been sent over the socket.</span>
<a name="l01166"></a>01166 <span class="comment"> */</span>
<a name="l01167"></a>01167 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01168"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a37dbf508f1440c92e3dd222dcaed787a">01168</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a37dbf508f1440c92e3dd222dcaed787a">ossl_ssl_connect</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01169"></a>01169 {
<a name="l01170"></a>01170     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac941f56a8ea80057259039a5d58fd3b3">ossl_ssl_setup</a>(<span class="keyword">self</span>);
<a name="l01171"></a>01171     <span class="keywordflow">return</span> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#abf2015926de1356fb8e255e36e8fd938">ossl_start_ssl</a>(<span class="keyword">self</span>, SSL_connect, <span class="stringliteral">&quot;SSL_connect&quot;</span>, 0);
<a name="l01172"></a>01172 }
<a name="l01173"></a>01173 
<a name="l01174"></a>01174 <span class="comment">/*</span>
<a name="l01175"></a>01175 <span class="comment"> * call-seq:</span>
<a name="l01176"></a>01176 <span class="comment"> *    ssl.connect_nonblock =&gt; self</span>
<a name="l01177"></a>01177 <span class="comment"> *</span>
<a name="l01178"></a>01178 <span class="comment"> * Initiates the SSL/TLS handshake as a client in non-blocking manner.</span>
<a name="l01179"></a>01179 <span class="comment"> *</span>
<a name="l01180"></a>01180 <span class="comment"> *   # emulates blocking connect</span>
<a name="l01181"></a>01181 <span class="comment"> *   begin</span>
<a name="l01182"></a>01182 <span class="comment"> *     ssl.connect_nonblock</span>
<a name="l01183"></a>01183 <span class="comment"> *   rescue IO::WaitReadable</span>
<a name="l01184"></a>01184 <span class="comment"> *     IO.select([s2])</span>
<a name="l01185"></a>01185 <span class="comment"> *     retry</span>
<a name="l01186"></a>01186 <span class="comment"> *   rescue IO::WaitWritable</span>
<a name="l01187"></a>01187 <span class="comment"> *     IO.select(nil, [s2])</span>
<a name="l01188"></a>01188 <span class="comment"> *     retry</span>
<a name="l01189"></a>01189 <span class="comment"> *   end</span>
<a name="l01190"></a>01190 <span class="comment"> *</span>
<a name="l01191"></a>01191 <span class="comment"> */</span>
<a name="l01192"></a>01192 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01193"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab519cc92f2d2170486ead4f2e2430422">01193</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab519cc92f2d2170486ead4f2e2430422">ossl_ssl_connect_nonblock</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01194"></a>01194 {
<a name="l01195"></a>01195     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac941f56a8ea80057259039a5d58fd3b3">ossl_ssl_setup</a>(<span class="keyword">self</span>);
<a name="l01196"></a>01196     <span class="keywordflow">return</span> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#abf2015926de1356fb8e255e36e8fd938">ossl_start_ssl</a>(<span class="keyword">self</span>, SSL_connect, <span class="stringliteral">&quot;SSL_connect&quot;</span>, 1);
<a name="l01197"></a>01197 }
<a name="l01198"></a>01198 
<a name="l01199"></a>01199 <span class="comment">/*</span>
<a name="l01200"></a>01200 <span class="comment"> * call-seq:</span>
<a name="l01201"></a>01201 <span class="comment"> *    ssl.accept =&gt; self</span>
<a name="l01202"></a>01202 <span class="comment"> *</span>
<a name="l01203"></a>01203 <span class="comment"> * Waits for a SSL/TLS client to initiate a handshake.  The handshake may be</span>
<a name="l01204"></a>01204 <span class="comment"> * started after unencrypted data has been sent over the socket.</span>
<a name="l01205"></a>01205 <span class="comment"> */</span>
<a name="l01206"></a>01206 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01207"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aba7d1109fa6e94faaa41a8f1d74f111b">01207</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aba7d1109fa6e94faaa41a8f1d74f111b">ossl_ssl_accept</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01208"></a>01208 {
<a name="l01209"></a>01209     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac941f56a8ea80057259039a5d58fd3b3">ossl_ssl_setup</a>(<span class="keyword">self</span>);
<a name="l01210"></a>01210     <span class="keywordflow">return</span> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#abf2015926de1356fb8e255e36e8fd938">ossl_start_ssl</a>(<span class="keyword">self</span>, SSL_accept, <span class="stringliteral">&quot;SSL_accept&quot;</span>, 0);
<a name="l01211"></a>01211 }
<a name="l01212"></a>01212 
<a name="l01213"></a>01213 <span class="comment">/*</span>
<a name="l01214"></a>01214 <span class="comment"> * call-seq:</span>
<a name="l01215"></a>01215 <span class="comment"> *    ssl.accept_nonblock =&gt; self</span>
<a name="l01216"></a>01216 <span class="comment"> *</span>
<a name="l01217"></a>01217 <span class="comment"> * Initiates the SSL/TLS handshake as a server in non-blocking manner.</span>
<a name="l01218"></a>01218 <span class="comment"> *</span>
<a name="l01219"></a>01219 <span class="comment"> *   # emulates blocking accept</span>
<a name="l01220"></a>01220 <span class="comment"> *   begin</span>
<a name="l01221"></a>01221 <span class="comment"> *     ssl.accept_nonblock</span>
<a name="l01222"></a>01222 <span class="comment"> *   rescue IO::WaitReadable</span>
<a name="l01223"></a>01223 <span class="comment"> *     IO.select([s2])</span>
<a name="l01224"></a>01224 <span class="comment"> *     retry</span>
<a name="l01225"></a>01225 <span class="comment"> *   rescue IO::WaitWritable</span>
<a name="l01226"></a>01226 <span class="comment"> *     IO.select(nil, [s2])</span>
<a name="l01227"></a>01227 <span class="comment"> *     retry</span>
<a name="l01228"></a>01228 <span class="comment"> *   end</span>
<a name="l01229"></a>01229 <span class="comment"> *</span>
<a name="l01230"></a>01230 <span class="comment"> */</span>
<a name="l01231"></a>01231 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01232"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa4ed964efa8d3502d151fea7a8326f54">01232</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa4ed964efa8d3502d151fea7a8326f54">ossl_ssl_accept_nonblock</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01233"></a>01233 {
<a name="l01234"></a>01234     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac941f56a8ea80057259039a5d58fd3b3">ossl_ssl_setup</a>(<span class="keyword">self</span>);
<a name="l01235"></a>01235     <span class="keywordflow">return</span> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#abf2015926de1356fb8e255e36e8fd938">ossl_start_ssl</a>(<span class="keyword">self</span>, SSL_accept, <span class="stringliteral">&quot;SSL_accept&quot;</span>, 1);
<a name="l01236"></a>01236 }
<a name="l01237"></a>01237 
<a name="l01238"></a>01238 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01239"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e28a5fe33a8648359e7d79659087088">01239</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e28a5fe33a8648359e7d79659087088">ossl_ssl_read_internal</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <span class="keywordtype">int</span> nonblock)
<a name="l01240"></a>01240 {
<a name="l01241"></a>01241     SSL *ssl;
<a name="l01242"></a>01242     <span class="keywordtype">int</span> ilen, nread = 0;
<a name="l01243"></a>01243     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, str;
<a name="l01244"></a>01244     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01245"></a>01245 
<a name="l01246"></a>01246     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;11&quot;</span>, &amp;len, &amp;str);
<a name="l01247"></a>01247     ilen = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(len);
<a name="l01248"></a>01248     <span class="keywordflow">if</span>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str)) str = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(0, ilen);
<a name="l01249"></a>01249     <span class="keywordflow">else</span>{
<a name="l01250"></a>01250         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(str);
<a name="l01251"></a>01251         <a class="code" href="../../db/d2e/intern_8h.html#a63a6d05687cf812131dce11743581b9d">rb_str_modify</a>(str);
<a name="l01252"></a>01252         <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(str, ilen);
<a name="l01253"></a>01253     }
<a name="l01254"></a>01254     <span class="keywordflow">if</span>(ilen == 0) <span class="keywordflow">return</span> str;
<a name="l01255"></a>01255 
<a name="l01256"></a>01256     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL, ssl);
<a name="l01257"></a>01257     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a98c4ad64d4c521ae11e9f683e4ee1ee4">ossl_ssl_get_io</a>(<span class="keyword">self</span>), fptr);
<a name="l01258"></a>01258     <span class="keywordflow">if</span> (ssl) {
<a name="l01259"></a>01259         <span class="keywordflow">if</span>(!nonblock &amp;&amp; SSL_pending(ssl) &lt;= 0)
<a name="l01260"></a>01260             <a class="code" href="../../db/d2e/intern_8h.html#a38e5ff660fd6c045c7242de575e8a5f2">rb_thread_wait_fd</a>(<a class="code" href="../../d8/d81/ruby__missing_8h.html#a90e20054f3e1241918bbdacd6744916e">FPTR_TO_FD</a>(fptr));
<a name="l01261"></a>01261         <span class="keywordflow">for</span> (;;){
<a name="l01262"></a>01262             nread = SSL_read(ssl, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5133348f689646af76f8fe8e0af547f5">RSTRING_LENINT</a>(str));
<a name="l01263"></a>01263             <span class="keywordflow">switch</span>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a0b8b3b367e26ee5dd77abaf0c865f2de">ssl_get_error</a>(ssl, nread)){
<a name="l01264"></a>01264             <span class="keywordflow">case</span> SSL_ERROR_NONE:
<a name="l01265"></a>01265                 <span class="keywordflow">goto</span> end;
<a name="l01266"></a>01266             <span class="keywordflow">case</span> SSL_ERROR_ZERO_RETURN:
<a name="l01267"></a>01267                 <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>();
<a name="l01268"></a>01268             <span class="keywordflow">case</span> SSL_ERROR_WANT_WRITE:
<a name="l01269"></a>01269                 <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a410c77cece0c4eef895e02ac5fc3d09d">write_would_block</a>(nonblock);
<a name="l01270"></a>01270                 <a class="code" href="../../dc/dac/io_8h.html#af28a170d3ffb07353653f832d95c6ba6">rb_io_wait_writable</a>(<a class="code" href="../../d8/d81/ruby__missing_8h.html#a90e20054f3e1241918bbdacd6744916e">FPTR_TO_FD</a>(fptr));
<a name="l01271"></a>01271                 <span class="keywordflow">continue</span>;
<a name="l01272"></a>01272             <span class="keywordflow">case</span> SSL_ERROR_WANT_READ:
<a name="l01273"></a>01273                 <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a79b925a2ba52c76bbe1e5a61b5a4270a">read_would_block</a>(nonblock);
<a name="l01274"></a>01274                 <a class="code" href="../../dc/dac/io_8h.html#aef370f8ba67623893a3b559bf27b30e3">rb_io_wait_readable</a>(<a class="code" href="../../d8/d81/ruby__missing_8h.html#a90e20054f3e1241918bbdacd6744916e">FPTR_TO_FD</a>(fptr));
<a name="l01275"></a>01275                 <span class="keywordflow">continue</span>;
<a name="l01276"></a>01276             <span class="keywordflow">case</span> SSL_ERROR_SYSCALL:
<a name="l01277"></a>01277                 <span class="keywordflow">if</span>(ERR_peek_error() == 0 &amp;&amp; nread == 0) <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>();
<a name="l01278"></a>01278                 <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l01279"></a>01279             <span class="keywordflow">default</span>:
<a name="l01280"></a>01280                 <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;SSL_read:&quot;</span>);
<a name="l01281"></a>01281             }
<a name="l01282"></a>01282         }
<a name="l01283"></a>01283     }
<a name="l01284"></a>01284     <span class="keywordflow">else</span> {
<a name="l01285"></a>01285         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> meth = nonblock ? <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;read_nonblock&quot;</span>) : rb_intern(<span class="stringliteral">&quot;sysread&quot;</span>);
<a name="l01286"></a>01286         <a class="code" href="../../db/dcc/error_8c.html#afd461c64916576849b159b21a26123da">rb_warning</a>(<span class="stringliteral">&quot;SSL session is not started yet.&quot;</span>);
<a name="l01287"></a>01287         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a98c4ad64d4c521ae11e9f683e4ee1ee4">ossl_ssl_get_io</a>(<span class="keyword">self</span>), meth, 2, len, str);
<a name="l01288"></a>01288     }
<a name="l01289"></a>01289 
<a name="l01290"></a>01290   end:
<a name="l01291"></a>01291     <a class="code" href="../../d8/d81/ruby__missing_8h.html#a89ed8cb86ca6dd49d2db67adae809057">rb_str_set_len</a>(str, nread);
<a name="l01292"></a>01292     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afd75ea0cb81c17e76c73e593d1d8a860">OBJ_TAINT</a>(str);
<a name="l01293"></a>01293 
<a name="l01294"></a>01294     <span class="keywordflow">return</span> str;
<a name="l01295"></a>01295 }
<a name="l01296"></a>01296 
<a name="l01297"></a>01297 
<a name="l01298"></a>01298 <span class="comment">/*</span>
<a name="l01299"></a>01299 <span class="comment"> * call-seq:</span>
<a name="l01300"></a>01300 <span class="comment"> *    ssl.sysread(length) =&gt; string</span>
<a name="l01301"></a>01301 <span class="comment"> *    ssl.sysread(length, buffer) =&gt; buffer</span>
<a name="l01302"></a>01302 <span class="comment"> *</span>
<a name="l01303"></a>01303 <span class="comment"> * Reads +length+ bytes from the SSL connection.  If a pre-allocated +buffer+</span>
<a name="l01304"></a>01304 <span class="comment"> * is provided the data will be written into it.</span>
<a name="l01305"></a>01305 <span class="comment"> */</span>
<a name="l01306"></a>01306 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01307"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#affa5aea0b4831b3c2b1c2ddb5e5af187">01307</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#affa5aea0b4831b3c2b1c2ddb5e5af187">ossl_ssl_read</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01308"></a>01308 {
<a name="l01309"></a>01309     <span class="keywordflow">return</span> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e28a5fe33a8648359e7d79659087088">ossl_ssl_read_internal</a>(argc, argv, <span class="keyword">self</span>, 0);
<a name="l01310"></a>01310 }
<a name="l01311"></a>01311 
<a name="l01312"></a>01312 <span class="comment">/*</span>
<a name="l01313"></a>01313 <span class="comment"> * call-seq:</span>
<a name="l01314"></a>01314 <span class="comment"> *    ssl.sysread_nonblock(length) =&gt; string</span>
<a name="l01315"></a>01315 <span class="comment"> *    ssl.sysread_nonblock(length, buffer) =&gt; buffer</span>
<a name="l01316"></a>01316 <span class="comment"> *</span>
<a name="l01317"></a>01317 <span class="comment"> * A non-blocking version of #sysread.  Raises an SSLError if reading would</span>
<a name="l01318"></a>01318 <span class="comment"> * block.</span>
<a name="l01319"></a>01319 <span class="comment"> *</span>
<a name="l01320"></a>01320 <span class="comment"> * Reads +length+ bytes from the SSL connection.  If a pre-allocated +buffer+</span>
<a name="l01321"></a>01321 <span class="comment"> * is provided the data will be written into it.</span>
<a name="l01322"></a>01322 <span class="comment"> */</span>
<a name="l01323"></a>01323 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01324"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a38673c585afa788eee3a6a2546c57b6a">01324</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a38673c585afa788eee3a6a2546c57b6a">ossl_ssl_read_nonblock</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01325"></a>01325 {
<a name="l01326"></a>01326     <span class="keywordflow">return</span> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e28a5fe33a8648359e7d79659087088">ossl_ssl_read_internal</a>(argc, argv, <span class="keyword">self</span>, 1);
<a name="l01327"></a>01327 }
<a name="l01328"></a>01328 
<a name="l01329"></a>01329 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01330"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab06d7d5b452dbac54b9b53a44cfcc7c9">01330</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab06d7d5b452dbac54b9b53a44cfcc7c9">ossl_ssl_write_internal</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, <span class="keywordtype">int</span> nonblock)
<a name="l01331"></a>01331 {
<a name="l01332"></a>01332     SSL *ssl;
<a name="l01333"></a>01333     <span class="keywordtype">int</span> nwrite = 0;
<a name="l01334"></a>01334     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01335"></a>01335 
<a name="l01336"></a>01336     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(str);
<a name="l01337"></a>01337     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL, ssl);
<a name="l01338"></a>01338     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a98c4ad64d4c521ae11e9f683e4ee1ee4">ossl_ssl_get_io</a>(<span class="keyword">self</span>), fptr);
<a name="l01339"></a>01339 
<a name="l01340"></a>01340     <span class="keywordflow">if</span> (ssl) {
<a name="l01341"></a>01341         <span class="keywordflow">for</span> (;;){
<a name="l01342"></a>01342             nwrite = SSL_write(ssl, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5133348f689646af76f8fe8e0af547f5">RSTRING_LENINT</a>(str));
<a name="l01343"></a>01343             <span class="keywordflow">switch</span>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a0b8b3b367e26ee5dd77abaf0c865f2de">ssl_get_error</a>(ssl, nwrite)){
<a name="l01344"></a>01344             <span class="keywordflow">case</span> SSL_ERROR_NONE:
<a name="l01345"></a>01345                 <span class="keywordflow">goto</span> end;
<a name="l01346"></a>01346             <span class="keywordflow">case</span> SSL_ERROR_WANT_WRITE:
<a name="l01347"></a>01347                 <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a410c77cece0c4eef895e02ac5fc3d09d">write_would_block</a>(nonblock);
<a name="l01348"></a>01348                 <a class="code" href="../../dc/dac/io_8h.html#af28a170d3ffb07353653f832d95c6ba6">rb_io_wait_writable</a>(<a class="code" href="../../d8/d81/ruby__missing_8h.html#a90e20054f3e1241918bbdacd6744916e">FPTR_TO_FD</a>(fptr));
<a name="l01349"></a>01349                 <span class="keywordflow">continue</span>;
<a name="l01350"></a>01350             <span class="keywordflow">case</span> SSL_ERROR_WANT_READ:
<a name="l01351"></a>01351                 <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a79b925a2ba52c76bbe1e5a61b5a4270a">read_would_block</a>(nonblock);
<a name="l01352"></a>01352                 <a class="code" href="../../dc/dac/io_8h.html#aef370f8ba67623893a3b559bf27b30e3">rb_io_wait_readable</a>(<a class="code" href="../../d8/d81/ruby__missing_8h.html#a90e20054f3e1241918bbdacd6744916e">FPTR_TO_FD</a>(fptr));
<a name="l01353"></a>01353                 <span class="keywordflow">continue</span>;
<a name="l01354"></a>01354             <span class="keywordflow">case</span> SSL_ERROR_SYSCALL:
<a name="l01355"></a>01355                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l01356"></a>01356             <span class="keywordflow">default</span>:
<a name="l01357"></a>01357                 <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;SSL_write:&quot;</span>);
<a name="l01358"></a>01358             }
<a name="l01359"></a>01359         }
<a name="l01360"></a>01360     }
<a name="l01361"></a>01361     <span class="keywordflow">else</span> {
<a name="l01362"></a>01362         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> id_syswrite = <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;syswrite&quot;</span>);
<a name="l01363"></a>01363         <a class="code" href="../../db/dcc/error_8c.html#afd461c64916576849b159b21a26123da">rb_warning</a>(<span class="stringliteral">&quot;SSL session is not started yet.&quot;</span>);
<a name="l01364"></a>01364         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a98c4ad64d4c521ae11e9f683e4ee1ee4">ossl_ssl_get_io</a>(<span class="keyword">self</span>), id_syswrite, 1, str);
<a name="l01365"></a>01365     }
<a name="l01366"></a>01366 
<a name="l01367"></a>01367   end:
<a name="l01368"></a>01368     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(nwrite);
<a name="l01369"></a>01369 }
<a name="l01370"></a>01370 
<a name="l01371"></a>01371 <span class="comment">/*</span>
<a name="l01372"></a>01372 <span class="comment"> * call-seq:</span>
<a name="l01373"></a>01373 <span class="comment"> *    ssl.syswrite(string) =&gt; Integer</span>
<a name="l01374"></a>01374 <span class="comment"> *</span>
<a name="l01375"></a>01375 <span class="comment"> * Writes +string+ to the SSL connection.</span>
<a name="l01376"></a>01376 <span class="comment"> */</span>
<a name="l01377"></a>01377 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01378"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aebfcd78f32ecbab80c3a46d27c01822d">01378</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aebfcd78f32ecbab80c3a46d27c01822d">ossl_ssl_write</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str)
<a name="l01379"></a>01379 {
<a name="l01380"></a>01380     <span class="keywordflow">return</span> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab06d7d5b452dbac54b9b53a44cfcc7c9">ossl_ssl_write_internal</a>(<span class="keyword">self</span>, str, 0);
<a name="l01381"></a>01381 }
<a name="l01382"></a>01382 
<a name="l01383"></a>01383 <span class="comment">/*</span>
<a name="l01384"></a>01384 <span class="comment"> * call-seq:</span>
<a name="l01385"></a>01385 <span class="comment"> *    ssl.syswrite_nonblock(string) =&gt; Integer</span>
<a name="l01386"></a>01386 <span class="comment"> *</span>
<a name="l01387"></a>01387 <span class="comment"> * Writes +string+ to the SSL connection in a non-blocking manner.  Raises an</span>
<a name="l01388"></a>01388 <span class="comment"> * SSLError if writing would block.</span>
<a name="l01389"></a>01389 <span class="comment"> */</span>
<a name="l01390"></a>01390 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01391"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a7a13697bb04137b1c222700fac776b89">01391</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a7a13697bb04137b1c222700fac776b89">ossl_ssl_write_nonblock</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str)
<a name="l01392"></a>01392 {
<a name="l01393"></a>01393     <span class="keywordflow">return</span> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab06d7d5b452dbac54b9b53a44cfcc7c9">ossl_ssl_write_internal</a>(<span class="keyword">self</span>, str, 1);
<a name="l01394"></a>01394 }
<a name="l01395"></a>01395 
<a name="l01396"></a>01396 <span class="comment">/*</span>
<a name="l01397"></a>01397 <span class="comment"> * call-seq:</span>
<a name="l01398"></a>01398 <span class="comment"> *    ssl.sysclose =&gt; nil</span>
<a name="l01399"></a>01399 <span class="comment"> *</span>
<a name="l01400"></a>01400 <span class="comment"> * Shuts down the SSL connection and prepares it for another connection.</span>
<a name="l01401"></a>01401 <span class="comment"> */</span>
<a name="l01402"></a>01402 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01403"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8d61d17cba89d4039e480fdb09a31cee">01403</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8d61d17cba89d4039e480fdb09a31cee">ossl_ssl_close</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01404"></a>01404 {
<a name="l01405"></a>01405     SSL *ssl;
<a name="l01406"></a>01406 
<a name="l01407"></a>01407     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL, ssl);
<a name="l01408"></a>01408     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a107fc09999e5bba192dfad7f34ea849c">ossl_ssl_shutdown</a>(ssl);
<a name="l01409"></a>01409     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3c0cac493742b64fd81feb634e972194">ossl_ssl_get_sync_close</a>(<span class="keyword">self</span>)))
<a name="l01410"></a>01410         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a98c4ad64d4c521ae11e9f683e4ee1ee4">ossl_ssl_get_io</a>(<span class="keyword">self</span>), <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;close&quot;</span>), 0);
<a name="l01411"></a>01411 
<a name="l01412"></a>01412     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01413"></a>01413 }
<a name="l01414"></a>01414 
<a name="l01415"></a>01415 <span class="comment">/*</span>
<a name="l01416"></a>01416 <span class="comment"> * call-seq:</span>
<a name="l01417"></a>01417 <span class="comment"> *    ssl.cert =&gt; cert or nil</span>
<a name="l01418"></a>01418 <span class="comment"> *</span>
<a name="l01419"></a>01419 <span class="comment"> * The X509 certificate for this socket endpoint.</span>
<a name="l01420"></a>01420 <span class="comment"> */</span>
<a name="l01421"></a>01421 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01422"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa1289188eee5fbda628a40ffac17d6a8">01422</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa1289188eee5fbda628a40ffac17d6a8">ossl_ssl_get_cert</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01423"></a>01423 {
<a name="l01424"></a>01424     SSL *ssl;
<a name="l01425"></a>01425     X509 *cert = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01426"></a>01426 
<a name="l01427"></a>01427     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL, ssl);
<a name="l01428"></a>01428     <span class="keywordflow">if</span> (!ssl) {
<a name="l01429"></a>01429         <a class="code" href="../../db/dcc/error_8c.html#afd461c64916576849b159b21a26123da">rb_warning</a>(<span class="stringliteral">&quot;SSL session is not started yet.&quot;</span>);
<a name="l01430"></a>01430         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01431"></a>01431     }
<a name="l01432"></a>01432 
<a name="l01433"></a>01433     <span class="comment">/*</span>
<a name="l01434"></a>01434 <span class="comment">     * Is this OpenSSL bug? Should add a ref?</span>
<a name="l01435"></a>01435 <span class="comment">     * TODO: Ask for.</span>
<a name="l01436"></a>01436 <span class="comment">     */</span>
<a name="l01437"></a>01437     cert = SSL_get_certificate(ssl); <span class="comment">/* NO DUPs =&gt; DON&apos;T FREE. */</span>
<a name="l01438"></a>01438 
<a name="l01439"></a>01439     <span class="keywordflow">if</span> (!cert) {
<a name="l01440"></a>01440         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01441"></a>01441     }
<a name="l01442"></a>01442     <span class="keywordflow">return</span> <a class="code" href="../../d3/da1/ossl__x509_8h.html#a184d6a1deb119e3bcf024e29f5da20b8">ossl_x509_new</a>(cert);
<a name="l01443"></a>01443 }
<a name="l01444"></a>01444 
<a name="l01445"></a>01445 <span class="comment">/*</span>
<a name="l01446"></a>01446 <span class="comment"> * call-seq:</span>
<a name="l01447"></a>01447 <span class="comment"> *    ssl.peer_cert =&gt; cert or nil</span>
<a name="l01448"></a>01448 <span class="comment"> *</span>
<a name="l01449"></a>01449 <span class="comment"> * The X509 certificate for this socket&apos;s peer.</span>
<a name="l01450"></a>01450 <span class="comment"> */</span>
<a name="l01451"></a>01451 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01452"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a1355917825538292f94149f8a7dd60b4">01452</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a1355917825538292f94149f8a7dd60b4">ossl_ssl_get_peer_cert</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01453"></a>01453 {
<a name="l01454"></a>01454     SSL *ssl;
<a name="l01455"></a>01455     X509 *cert = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01456"></a>01456     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj;
<a name="l01457"></a>01457 
<a name="l01458"></a>01458     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL, ssl);
<a name="l01459"></a>01459 
<a name="l01460"></a>01460     <span class="keywordflow">if</span> (!ssl){
<a name="l01461"></a>01461         <a class="code" href="../../db/dcc/error_8c.html#afd461c64916576849b159b21a26123da">rb_warning</a>(<span class="stringliteral">&quot;SSL session is not started yet.&quot;</span>);
<a name="l01462"></a>01462         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01463"></a>01463     }
<a name="l01464"></a>01464 
<a name="l01465"></a>01465     cert = SSL_get_peer_certificate(ssl); <span class="comment">/* Adds a ref =&gt; Safe to FREE. */</span>
<a name="l01466"></a>01466 
<a name="l01467"></a>01467     <span class="keywordflow">if</span> (!cert) {
<a name="l01468"></a>01468         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01469"></a>01469     }
<a name="l01470"></a>01470     obj = <a class="code" href="../../d3/da1/ossl__x509_8h.html#a184d6a1deb119e3bcf024e29f5da20b8">ossl_x509_new</a>(cert);
<a name="l01471"></a>01471     X509_free(cert);
<a name="l01472"></a>01472 
<a name="l01473"></a>01473     <span class="keywordflow">return</span> obj;
<a name="l01474"></a>01474 }
<a name="l01475"></a>01475 
<a name="l01476"></a>01476 <span class="comment">/*</span>
<a name="l01477"></a>01477 <span class="comment"> * call-seq:</span>
<a name="l01478"></a>01478 <span class="comment"> *    ssl.peer_cert_chain =&gt; [cert, ...] or nil</span>
<a name="l01479"></a>01479 <span class="comment"> *</span>
<a name="l01480"></a>01480 <span class="comment"> * The X509 certificate chain for this socket&apos;s peer.</span>
<a name="l01481"></a>01481 <span class="comment"> */</span>
<a name="l01482"></a>01482 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01483"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ad134fbd78803b013c021648b4fb7be1f">01483</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ad134fbd78803b013c021648b4fb7be1f">ossl_ssl_get_peer_cert_chain</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01484"></a>01484 {
<a name="l01485"></a>01485     SSL *ssl;
<a name="l01486"></a>01486     <a class="code" href="../../d5/dac/ossl_8h.html#afdc9179e243623337e07f01bf1404a8c">STACK_OF</a>(X509) *chain;
<a name="l01487"></a>01487     X509 *cert;
<a name="l01488"></a>01488     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary;
<a name="l01489"></a>01489     <span class="keywordtype">int</span> i, num;
<a name="l01490"></a>01490 
<a name="l01491"></a>01491     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL, ssl);
<a name="l01492"></a>01492     <span class="keywordflow">if</span>(!ssl){
<a name="l01493"></a>01493         <a class="code" href="../../db/dcc/error_8c.html#afd461c64916576849b159b21a26123da">rb_warning</a>(<span class="stringliteral">&quot;SSL session is not started yet.&quot;</span>);
<a name="l01494"></a>01494         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01495"></a>01495     }
<a name="l01496"></a>01496     chain = SSL_get_peer_cert_chain(ssl);
<a name="l01497"></a>01497     <span class="keywordflow">if</span>(!chain) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01498"></a>01498     num = sk_X509_num(chain);
<a name="l01499"></a>01499     ary = <a class="code" href="../../dc/dcc/array_8c.html#a43a7bd246935ab63c233b4ae34d61d75">rb_ary_new2</a>(num);
<a name="l01500"></a>01500     <span class="keywordflow">for</span> (i = 0; i &lt; num; i++){
<a name="l01501"></a>01501         cert = sk_X509_value(chain, i);
<a name="l01502"></a>01502         <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, <a class="code" href="../../d3/da1/ossl__x509_8h.html#a184d6a1deb119e3bcf024e29f5da20b8">ossl_x509_new</a>(cert));
<a name="l01503"></a>01503     }
<a name="l01504"></a>01504 
<a name="l01505"></a>01505     <span class="keywordflow">return</span> ary;
<a name="l01506"></a>01506 }
<a name="l01507"></a>01507 
<a name="l01508"></a>01508 <span class="comment">/*</span>
<a name="l01509"></a>01509 <span class="comment"> * call-seq:</span>
<a name="l01510"></a>01510 <span class="comment"> *    ssl.cipher =&gt; [name, version, bits, alg_bits]</span>
<a name="l01511"></a>01511 <span class="comment"> *</span>
<a name="l01512"></a>01512 <span class="comment"> * The cipher being used for the current connection</span>
<a name="l01513"></a>01513 <span class="comment"> */</span>
<a name="l01514"></a>01514 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01515"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a38c2a19a216b1dfd4cd2256881efa815">01515</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a38c2a19a216b1dfd4cd2256881efa815">ossl_ssl_get_cipher</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01516"></a>01516 {
<a name="l01517"></a>01517     SSL *ssl;
<a name="l01518"></a>01518     SSL_CIPHER *cipher;
<a name="l01519"></a>01519 
<a name="l01520"></a>01520     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL, ssl);
<a name="l01521"></a>01521     <span class="keywordflow">if</span> (!ssl) {
<a name="l01522"></a>01522         <a class="code" href="../../db/dcc/error_8c.html#afd461c64916576849b159b21a26123da">rb_warning</a>(<span class="stringliteral">&quot;SSL session is not started yet.&quot;</span>);
<a name="l01523"></a>01523         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01524"></a>01524     }
<a name="l01525"></a>01525     cipher = (SSL_CIPHER *)SSL_get_current_cipher(ssl);
<a name="l01526"></a>01526 
<a name="l01527"></a>01527     <span class="keywordflow">return</span> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a90ee07e5ff132588373d7dcfb491192e">ossl_ssl_cipher_to_ary</a>(cipher);
<a name="l01528"></a>01528 }
<a name="l01529"></a>01529 
<a name="l01530"></a>01530 <span class="comment">/*</span>
<a name="l01531"></a>01531 <span class="comment"> * call-seq:</span>
<a name="l01532"></a>01532 <span class="comment"> *    ssl.state =&gt; string</span>
<a name="l01533"></a>01533 <span class="comment"> *</span>
<a name="l01534"></a>01534 <span class="comment"> * A description of the current connection state.</span>
<a name="l01535"></a>01535 <span class="comment"> */</span>
<a name="l01536"></a>01536 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01537"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a70f4b886ae987b6ddc734ed6538f9131">01537</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a70f4b886ae987b6ddc734ed6538f9131">ossl_ssl_get_state</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01538"></a>01538 {
<a name="l01539"></a>01539     SSL *ssl;
<a name="l01540"></a>01540     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ret;
<a name="l01541"></a>01541 
<a name="l01542"></a>01542     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL, ssl);
<a name="l01543"></a>01543     <span class="keywordflow">if</span> (!ssl) {
<a name="l01544"></a>01544         <a class="code" href="../../db/dcc/error_8c.html#afd461c64916576849b159b21a26123da">rb_warning</a>(<span class="stringliteral">&quot;SSL session is not started yet.&quot;</span>);
<a name="l01545"></a>01545         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01546"></a>01546     }
<a name="l01547"></a>01547     ret = <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(SSL_state_string(ssl));
<a name="l01548"></a>01548     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a56087d5316e4c73027105c023006cb15">ruby_verbose</a>) {
<a name="l01549"></a>01549         <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(ret, <span class="stringliteral">&quot;: &quot;</span>);
<a name="l01550"></a>01550         <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(ret, SSL_state_string_long(ssl));
<a name="l01551"></a>01551     }
<a name="l01552"></a>01552     <span class="keywordflow">return</span> ret;
<a name="l01553"></a>01553 }
<a name="l01554"></a>01554 
<a name="l01555"></a>01555 <span class="comment">/*</span>
<a name="l01556"></a>01556 <span class="comment"> * call-seq:</span>
<a name="l01557"></a>01557 <span class="comment"> *    ssl.pending =&gt; Integer</span>
<a name="l01558"></a>01558 <span class="comment"> *</span>
<a name="l01559"></a>01559 <span class="comment"> * The number of bytes that are immediately available for reading</span>
<a name="l01560"></a>01560 <span class="comment"> */</span>
<a name="l01561"></a>01561 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01562"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3ae79c5ffad5eb978a9241574e468f48">01562</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3ae79c5ffad5eb978a9241574e468f48">ossl_ssl_pending</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01563"></a>01563 {
<a name="l01564"></a>01564     SSL *ssl;
<a name="l01565"></a>01565 
<a name="l01566"></a>01566     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL, ssl);
<a name="l01567"></a>01567     <span class="keywordflow">if</span> (!ssl) {
<a name="l01568"></a>01568         <a class="code" href="../../db/dcc/error_8c.html#afd461c64916576849b159b21a26123da">rb_warning</a>(<span class="stringliteral">&quot;SSL session is not started yet.&quot;</span>);
<a name="l01569"></a>01569         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01570"></a>01570     }
<a name="l01571"></a>01571 
<a name="l01572"></a>01572     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(SSL_pending(ssl));
<a name="l01573"></a>01573 }
<a name="l01574"></a>01574 
<a name="l01575"></a>01575 <span class="comment">/*</span>
<a name="l01576"></a>01576 <span class="comment"> * call-seq:</span>
<a name="l01577"></a>01577 <span class="comment"> *    ssl.session_reused? -&gt; true | false</span>
<a name="l01578"></a>01578 <span class="comment"> *</span>
<a name="l01579"></a>01579 <span class="comment"> * Returns true if a reused session was negotiated during the handshake.</span>
<a name="l01580"></a>01580 <span class="comment"> */</span>
<a name="l01581"></a>01581 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01582"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a0112373626aeeb8f5524eb0cc27506f9">01582</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a0112373626aeeb8f5524eb0cc27506f9">ossl_ssl_session_reused</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01583"></a>01583 {
<a name="l01584"></a>01584     SSL *ssl;
<a name="l01585"></a>01585 
<a name="l01586"></a>01586     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL, ssl);
<a name="l01587"></a>01587     <span class="keywordflow">if</span> (!ssl) {
<a name="l01588"></a>01588         <a class="code" href="../../db/dcc/error_8c.html#afd461c64916576849b159b21a26123da">rb_warning</a>(<span class="stringliteral">&quot;SSL session is not started yet.&quot;</span>);
<a name="l01589"></a>01589         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01590"></a>01590     }
<a name="l01591"></a>01591 
<a name="l01592"></a>01592     <span class="keywordflow">switch</span>(SSL_session_reused(ssl)) {
<a name="l01593"></a>01593     <span class="keywordflow">case</span> 1:     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l01594"></a>01594     <span class="keywordflow">case</span> 0:     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l01595"></a>01595     <span class="keywordflow">default</span>:    <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;SSL_session_reused&quot;</span>);
<a name="l01596"></a>01596     }
<a name="l01597"></a>01597 }
<a name="l01598"></a>01598 
<a name="l01599"></a>01599 <span class="comment">/*</span>
<a name="l01600"></a>01600 <span class="comment"> * call-seq:</span>
<a name="l01601"></a>01601 <span class="comment"> *    ssl.session = session -&gt; session</span>
<a name="l01602"></a>01602 <span class="comment"> *</span>
<a name="l01603"></a>01603 <span class="comment"> * Sets the Session to be used when the connection is established.</span>
<a name="l01604"></a>01604 <span class="comment"> */</span>
<a name="l01605"></a>01605 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01606"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a2b7cd83aad9036b5146ecb2f16a3679c">01606</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a2b7cd83aad9036b5146ecb2f16a3679c">ossl_ssl_set_session</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg1)
<a name="l01607"></a>01607 {
<a name="l01608"></a>01608     SSL *ssl;
<a name="l01609"></a>01609     SSL_SESSION *sess;
<a name="l01610"></a>01610 
<a name="l01611"></a>01611 <span class="comment">/* why is ossl_ssl_setup delayed? */</span>
<a name="l01612"></a>01612     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac941f56a8ea80057259039a5d58fd3b3">ossl_ssl_setup</a>(<span class="keyword">self</span>);
<a name="l01613"></a>01613 
<a name="l01614"></a>01614     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL, ssl);
<a name="l01615"></a>01615     <span class="keywordflow">if</span> (!ssl) {
<a name="l01616"></a>01616         <a class="code" href="../../db/dcc/error_8c.html#afd461c64916576849b159b21a26123da">rb_warning</a>(<span class="stringliteral">&quot;SSL session is not started yet.&quot;</span>);
<a name="l01617"></a>01617         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01618"></a>01618     }
<a name="l01619"></a>01619 
<a name="l01620"></a>01620     <a class="code" href="../../d6/d43/ossl__ssl_8h.html#a6a2c50eb14ed3451daff1fdad90d23e8">SafeGetSSLSession</a>(arg1, sess);
<a name="l01621"></a>01621 
<a name="l01622"></a>01622     <span class="keywordflow">if</span> (SSL_set_session(ssl, sess) != 1)
<a name="l01623"></a>01623         <a class="code" href="../../d4/d3c/ossl_8c.html#abdd6427ac56d2ded08a03d234b4ffc23">ossl_raise</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a>, <span class="stringliteral">&quot;SSL_set_session&quot;</span>);
<a name="l01624"></a>01624 
<a name="l01625"></a>01625     <span class="keywordflow">return</span> arg1;
<a name="l01626"></a>01626 }
<a name="l01627"></a>01627 
<a name="l01628"></a>01628 <span class="comment">/*</span>
<a name="l01629"></a>01629 <span class="comment"> * call-seq:</span>
<a name="l01630"></a>01630 <span class="comment"> *    ssl.verify_result =&gt; Integer</span>
<a name="l01631"></a>01631 <span class="comment"> *</span>
<a name="l01632"></a>01632 <span class="comment"> * Returns the result of the peer certificates verification.  See verify(1)</span>
<a name="l01633"></a>01633 <span class="comment"> * for error values and descriptions.</span>
<a name="l01634"></a>01634 <span class="comment"> *</span>
<a name="l01635"></a>01635 <span class="comment"> * If no peer certificate was presented X509_V_OK is returned.</span>
<a name="l01636"></a>01636 <span class="comment"> */</span>
<a name="l01637"></a>01637 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01638"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a9a0c4dd34b37a6bfc22fe7e665b7fd66">01638</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a9a0c4dd34b37a6bfc22fe7e665b7fd66">ossl_ssl_get_verify_result</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01639"></a>01639 {
<a name="l01640"></a>01640     SSL *ssl;
<a name="l01641"></a>01641 
<a name="l01642"></a>01642     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL, ssl);
<a name="l01643"></a>01643     <span class="keywordflow">if</span> (!ssl) {
<a name="l01644"></a>01644         <a class="code" href="../../db/dcc/error_8c.html#afd461c64916576849b159b21a26123da">rb_warning</a>(<span class="stringliteral">&quot;SSL session is not started yet.&quot;</span>);
<a name="l01645"></a>01645         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01646"></a>01646     }
<a name="l01647"></a>01647 
<a name="l01648"></a>01648     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(SSL_get_verify_result(ssl));
<a name="l01649"></a>01649 }
<a name="l01650"></a>01650 
<a name="l01651"></a>01651 <span class="comment">/*</span>
<a name="l01652"></a>01652 <span class="comment"> * call-seq:</span>
<a name="l01653"></a>01653 <span class="comment"> *    ssl.client_ca =&gt; [x509name, ...]</span>
<a name="l01654"></a>01654 <span class="comment"> *</span>
<a name="l01655"></a>01655 <span class="comment"> * Returns the list of client CAs. Please note that in contrast to</span>
<a name="l01656"></a>01656 <span class="comment"> * SSLContext#client_ca= no array of X509::Certificate is returned but</span>
<a name="l01657"></a>01657 <span class="comment"> * X509::Name instances of the CA&apos;s subject distinguished name.</span>
<a name="l01658"></a>01658 <span class="comment"> *</span>
<a name="l01659"></a>01659 <span class="comment"> * In server mode, returns the list set by SSLContext#client_ca=.</span>
<a name="l01660"></a>01660 <span class="comment"> * In client mode, returns the list of client CAs sent from the server.</span>
<a name="l01661"></a>01661 <span class="comment"> */</span>
<a name="l01662"></a>01662 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01663"></a><a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a6a4dba99941b07523746879cceb02689">01663</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a6a4dba99941b07523746879cceb02689">ossl_ssl_get_client_ca_list</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01664"></a>01664 {
<a name="l01665"></a>01665     SSL *ssl;
<a name="l01666"></a>01666     <a class="code" href="../../d5/dac/ossl_8h.html#afdc9179e243623337e07f01bf1404a8c">STACK_OF</a>(X509_NAME) *ca;
<a name="l01667"></a>01667 
<a name="l01668"></a>01668     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad043eb0996705571cad2e5bb39e9675e">Data_Get_Struct</a>(<span class="keyword">self</span>, SSL, ssl);
<a name="l01669"></a>01669     <span class="keywordflow">if</span> (!ssl) {
<a name="l01670"></a>01670         <a class="code" href="../../db/dcc/error_8c.html#afd461c64916576849b159b21a26123da">rb_warning</a>(<span class="stringliteral">&quot;SSL session is not started yet.&quot;</span>);
<a name="l01671"></a>01671         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01672"></a>01672     }
<a name="l01673"></a>01673 
<a name="l01674"></a>01674     ca = SSL_get_client_CA_list(ssl);
<a name="l01675"></a>01675     <span class="keywordflow">return</span> <a class="code" href="../../d5/dac/ossl_8h.html#a16fb5835bed155f3d98602d8a42b69d8">ossl_x509name_sk2ary</a>(ca);
<a name="l01676"></a>01676 }
<a name="l01677"></a>01677 
<a name="l01678"></a>01678 <span class="keywordtype">void</span>
<a name="l01679"></a><a class="code" href="../../d6/d43/ossl__ssl_8h.html#aff81d70ec9eaecb249ebb9fa98227afe">01679</a> <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a642f04eaa293491340db3256833457a2">Init_ossl_ssl</a>()
<a name="l01680"></a>01680 {
<a name="l01681"></a>01681     <span class="keywordtype">int</span> i;
<a name="l01682"></a>01682     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary;
<a name="l01683"></a>01683 
<a name="l01684"></a>01684 <span class="preprocessor">#if 0</span>
<a name="l01685"></a>01685 <span class="preprocessor"></span>    <a class="code" href="../../d4/d3c/ossl_8c.html#a19a5e8aeedd7c99b95bb894a7663fcb9">mOSSL</a> = <a class="code" href="../../de/ddf/group__class.html#ga911071d40f9312e49a774ea0e1b12869">rb_define_module</a>(<span class="stringliteral">&quot;OpenSSL&quot;</span>); <span class="comment">/* let rdoc know about mOSSL */</span>
<a name="l01686"></a>01686 <span class="preprocessor">#endif</span>
<a name="l01687"></a>01687 <span class="preprocessor"></span>
<a name="l01688"></a>01688     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a03b3aad781a6c9b2f9b8a7f3c319f97e">ID_callback_state</a> = <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;@callback_state&quot;</span>);
<a name="l01689"></a>01689 
<a name="l01690"></a>01690     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaccb4c51a7650ead12e74e5ce071750f">ossl_ssl_ex_vcb_idx</a> = SSL_get_ex_new_index(0,(<span class="keywordtype">void</span> *)<span class="stringliteral">&quot;ossl_ssl_ex_vcb_idx&quot;</span>,0,0,0);
<a name="l01691"></a>01691     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaff04e7fef2f53f2151d8bdbf5bd431a">ossl_ssl_ex_store_p</a> = SSL_get_ex_new_index(0,(<span class="keywordtype">void</span> *)<span class="stringliteral">&quot;ossl_ssl_ex_store_p&quot;</span>,0,0,0);
<a name="l01692"></a>01692     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa3c26a2268bba8099b8b629b9808d267">ossl_ssl_ex_ptr_idx</a> = SSL_get_ex_new_index(0,(<span class="keywordtype">void</span> *)<span class="stringliteral">&quot;ossl_ssl_ex_ptr_idx&quot;</span>,0,0,0);
<a name="l01693"></a>01693     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39218e865ef8154ca806c6514b3d4c25">ossl_ssl_ex_client_cert_cb_idx</a> =
<a name="l01694"></a>01694         SSL_get_ex_new_index(0,(<span class="keywordtype">void</span> *)<span class="stringliteral">&quot;ossl_ssl_ex_client_cert_cb_idx&quot;</span>,0,0,0);
<a name="l01695"></a>01695     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ac71ee4a16f11ab58ff8bb63bfb489bf8">ossl_ssl_ex_tmp_dh_callback_idx</a> =
<a name="l01696"></a>01696         SSL_get_ex_new_index(0,(<span class="keywordtype">void</span> *)<span class="stringliteral">&quot;ossl_ssl_ex_tmp_dh_callback_idx&quot;</span>,0,0,0);
<a name="l01697"></a>01697 
<a name="l01698"></a>01698     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a1a50f2b264a326ebc8f9920f504bafca">mSSL</a> = <a class="code" href="../../de/ddf/group__class.html#gad0eeed44f413060a2417852168747388">rb_define_module_under</a>(<a class="code" href="../../d4/d3c/ossl_8c.html#a19a5e8aeedd7c99b95bb894a7663fcb9">mOSSL</a>, <span class="stringliteral">&quot;SSL&quot;</span>);
<a name="l01699"></a>01699     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aaddd3f0e816a05c29463ce994f6bdb62">eSSLError</a> = <a class="code" href="../../de/ddf/group__class.html#ga5266deadce0318d830a1e63c0933b898" title="Defines a class under the namespace of outer.">rb_define_class_under</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a1a50f2b264a326ebc8f9920f504bafca">mSSL</a>, <span class="stringliteral">&quot;SSLError&quot;</span>, <a class="code" href="../../d4/d3c/ossl_8c.html#aea0de3b19cf8085effab72943bddc56e">eOSSLError</a>);
<a name="l01700"></a>01700 
<a name="l01701"></a>01701     <a class="code" href="../../d6/d43/ossl__ssl_8h.html#a4a89fa90221ab3d21c0c38ef00497e21">Init_ossl_ssl_session</a>();
<a name="l01702"></a>01702 
<a name="l01703"></a>01703     <span class="comment">/* Document-class: OpenSSL::SSL::SSLContext</span>
<a name="l01704"></a>01704 <span class="comment">     *</span>
<a name="l01705"></a>01705 <span class="comment">     * An SSLContext is used to set various options regarding certificates,</span>
<a name="l01706"></a>01706 <span class="comment">     * algorithms, verification, session caching, etc.  The SSLContext is</span>
<a name="l01707"></a>01707 <span class="comment">     * used to create an SSLSocket.</span>
<a name="l01708"></a>01708 <span class="comment">     *</span>
<a name="l01709"></a>01709 <span class="comment">     * All attributes must be set before creating an SSLSocket as the</span>
<a name="l01710"></a>01710 <span class="comment">     * SSLContext will be frozen afterward.</span>
<a name="l01711"></a>01711 <span class="comment">     *</span>
<a name="l01712"></a>01712 <span class="comment">     * The following attributes are available but don&apos;t show up in rdoc:</span>
<a name="l01713"></a>01713 <span class="comment">     * * ssl_version, cert, key, client_ca, ca_file, ca_path, timeout,</span>
<a name="l01714"></a>01714 <span class="comment">     * * verify_mode, verify_depth client_cert_cb, tmp_dh_callback,</span>
<a name="l01715"></a>01715 <span class="comment">     * * session_id_context, session_add_cb, session_new_cb, session_remove_cb</span>
<a name="l01716"></a>01716 <span class="comment">     */</span>
<a name="l01717"></a>01717     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a> = <a class="code" href="../../de/ddf/group__class.html#ga5266deadce0318d830a1e63c0933b898" title="Defines a class under the namespace of outer.">rb_define_class_under</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a1a50f2b264a326ebc8f9920f504bafca">mSSL</a>, <span class="stringliteral">&quot;SSLContext&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a57c96ead3ef230b4838e65fe037c346e">rb_cObject</a>);
<a name="l01718"></a>01718     <a class="code" href="../../db/d2e/intern_8h.html#a6c99ed7f070458b961026d43d27d0642">rb_define_alloc_func</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aea74e08ab004bc87346542e4dd79ae6a">ossl_sslctx_s_alloc</a>);
<a name="l01719"></a>01719 
<a name="l01720"></a>01720     <span class="comment">/*</span>
<a name="l01721"></a>01721 <span class="comment">     * Context certificate</span>
<a name="l01722"></a>01722 <span class="comment">     */</span>
<a name="l01723"></a>01723     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;cert&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01724"></a>01724 
<a name="l01725"></a>01725     <span class="comment">/*</span>
<a name="l01726"></a>01726 <span class="comment">     * Context private key</span>
<a name="l01727"></a>01727 <span class="comment">     */</span>
<a name="l01728"></a>01728     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;key&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01729"></a>01729 
<a name="l01730"></a>01730     <span class="comment">/*</span>
<a name="l01731"></a>01731 <span class="comment">     * A certificate or Array of certificates that will be sent to the client.</span>
<a name="l01732"></a>01732 <span class="comment">     */</span>
<a name="l01733"></a>01733     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;client_ca&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01734"></a>01734 
<a name="l01735"></a>01735     <span class="comment">/*</span>
<a name="l01736"></a>01736 <span class="comment">     * The path to a file containing a PEM-format CA certificate</span>
<a name="l01737"></a>01737 <span class="comment">     */</span>
<a name="l01738"></a>01738     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;ca_file&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01739"></a>01739 
<a name="l01740"></a>01740     <span class="comment">/*</span>
<a name="l01741"></a>01741 <span class="comment">     * The path to a directory containing CA certificates in PEM format.</span>
<a name="l01742"></a>01742 <span class="comment">     *</span>
<a name="l01743"></a>01743 <span class="comment">     * Files are looked up by subject&apos;s X509 name&apos;s hash value.</span>
<a name="l01744"></a>01744 <span class="comment">     */</span>
<a name="l01745"></a>01745     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;ca_path&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01746"></a>01746 
<a name="l01747"></a>01747     <span class="comment">/*</span>
<a name="l01748"></a>01748 <span class="comment">     * Maximum session lifetime.</span>
<a name="l01749"></a>01749 <span class="comment">     */</span>
<a name="l01750"></a>01750     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;timeout&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01751"></a>01751 
<a name="l01752"></a>01752     <span class="comment">/*</span>
<a name="l01753"></a>01753 <span class="comment">     * Session verification mode.</span>
<a name="l01754"></a>01754 <span class="comment">     *</span>
<a name="l01755"></a>01755 <span class="comment">     * Valid modes are VERIFY_NONE, VERIFY_PEER, VERIFY_CLIENT_ONCE,</span>
<a name="l01756"></a>01756 <span class="comment">     * VERIFY_FAIL_IF_NO_PEER_CERT and defined on OpenSSL::SSL</span>
<a name="l01757"></a>01757 <span class="comment">     */</span>
<a name="l01758"></a>01758     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;verify_mode&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01759"></a>01759 
<a name="l01760"></a>01760     <span class="comment">/*</span>
<a name="l01761"></a>01761 <span class="comment">     * Number of CA certificates to walk when verifying a certificate chain.</span>
<a name="l01762"></a>01762 <span class="comment">     */</span>
<a name="l01763"></a>01763     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;verify_depth&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01764"></a>01764 
<a name="l01765"></a>01765     <span class="comment">/*</span>
<a name="l01766"></a>01766 <span class="comment">     * A callback for additional certificate verification.  The callback is</span>
<a name="l01767"></a>01767 <span class="comment">     * invoked for each certificate in the chain.</span>
<a name="l01768"></a>01768 <span class="comment">     *</span>
<a name="l01769"></a>01769 <span class="comment">     * The callback is invoked with two values.  +preverify_ok+ indicates</span>
<a name="l01770"></a>01770 <span class="comment">     * indicates if the verification was passed (true) or not (false).</span>
<a name="l01771"></a>01771 <span class="comment">     * +store_context+ is an OpenSSL::X509::StoreContext containing the</span>
<a name="l01772"></a>01772 <span class="comment">     * context used for certificate verification.</span>
<a name="l01773"></a>01773 <span class="comment">     *</span>
<a name="l01774"></a>01774 <span class="comment">     * If the callback returns false verification is stopped.</span>
<a name="l01775"></a>01775 <span class="comment">     */</span>
<a name="l01776"></a>01776     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;verify_callback&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01777"></a>01777 
<a name="l01778"></a>01778     <span class="comment">/*</span>
<a name="l01779"></a>01779 <span class="comment">     * Sets various OpenSSL options.</span>
<a name="l01780"></a>01780 <span class="comment">     */</span>
<a name="l01781"></a>01781     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;options&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01782"></a>01782 
<a name="l01783"></a>01783     <span class="comment">/*</span>
<a name="l01784"></a>01784 <span class="comment">     * An OpenSSL::X509::Store used for certificate verification</span>
<a name="l01785"></a>01785 <span class="comment">     */</span>
<a name="l01786"></a>01786     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;cert_store&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01787"></a>01787 
<a name="l01788"></a>01788     <span class="comment">/*</span>
<a name="l01789"></a>01789 <span class="comment">     * An Array of extra X509 certificates to be added to the certificate</span>
<a name="l01790"></a>01790 <span class="comment">     * chain.</span>
<a name="l01791"></a>01791 <span class="comment">     */</span>
<a name="l01792"></a>01792     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;extra_chain_cert&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01793"></a>01793 
<a name="l01794"></a>01794     <span class="comment">/*</span>
<a name="l01795"></a>01795 <span class="comment">     * A callback invoked when a client certificate is requested by a server</span>
<a name="l01796"></a>01796 <span class="comment">     * and no certificate has been set.</span>
<a name="l01797"></a>01797 <span class="comment">     *</span>
<a name="l01798"></a>01798 <span class="comment">     * The callback is invoked with a Session and must return an Array</span>
<a name="l01799"></a>01799 <span class="comment">     * containing an OpenSSL::X509::Certificate and an OpenSSL::PKey.  If any</span>
<a name="l01800"></a>01800 <span class="comment">     * other value is returned the handshake is suspended.</span>
<a name="l01801"></a>01801 <span class="comment">     */</span>
<a name="l01802"></a>01802     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;client_cert_cb&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01803"></a>01803 
<a name="l01804"></a>01804     <span class="comment">/*</span>
<a name="l01805"></a>01805 <span class="comment">     * A callback invoked when DH parameters are required.</span>
<a name="l01806"></a>01806 <span class="comment">     *</span>
<a name="l01807"></a>01807 <span class="comment">     * The callback is invoked with the Session for the key exchange, an</span>
<a name="l01808"></a>01808 <span class="comment">     * flag indicating the use of an export cipher and the keylength</span>
<a name="l01809"></a>01809 <span class="comment">     * required.</span>
<a name="l01810"></a>01810 <span class="comment">     *</span>
<a name="l01811"></a>01811 <span class="comment">     * The callback must return an OpenSSL::PKey::DH instance of the correct</span>
<a name="l01812"></a>01812 <span class="comment">     * key length.</span>
<a name="l01813"></a>01813 <span class="comment">     */</span>
<a name="l01814"></a>01814     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;tmp_dh_callback&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01815"></a>01815 
<a name="l01816"></a>01816     <span class="comment">/*</span>
<a name="l01817"></a>01817 <span class="comment">     * Sets the context in which a session can be reused.  This allows</span>
<a name="l01818"></a>01818 <span class="comment">     * sessions for multiple applications to be distinguished, for exapmle, by</span>
<a name="l01819"></a>01819 <span class="comment">     * name.</span>
<a name="l01820"></a>01820 <span class="comment">     */</span>
<a name="l01821"></a>01821     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;session_id_context&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01822"></a>01822 
<a name="l01823"></a>01823     <span class="comment">/*</span>
<a name="l01824"></a>01824 <span class="comment">     * A callback invoked on a server when a session is proposed by the client</span>
<a name="l01825"></a>01825 <span class="comment">     * but the session could not be found in the server&apos;s internal cache.</span>
<a name="l01826"></a>01826 <span class="comment">     *</span>
<a name="l01827"></a>01827 <span class="comment">     * The callback is invoked with the SSLSocket and session id.  The</span>
<a name="l01828"></a>01828 <span class="comment">     * callback may return a Session from an external cache.</span>
<a name="l01829"></a>01829 <span class="comment">     */</span>
<a name="l01830"></a>01830     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;session_get_cb&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01831"></a>01831 
<a name="l01832"></a>01832     <span class="comment">/*</span>
<a name="l01833"></a>01833 <span class="comment">     * A callback invoked when a new session was negotiatied.</span>
<a name="l01834"></a>01834 <span class="comment">     *</span>
<a name="l01835"></a>01835 <span class="comment">     * The callback is invoked with an SSLSocket.  If false is returned the</span>
<a name="l01836"></a>01836 <span class="comment">     * session will be removed from the internal cache.</span>
<a name="l01837"></a>01837 <span class="comment">     */</span>
<a name="l01838"></a>01838     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;session_new_cb&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01839"></a>01839 
<a name="l01840"></a>01840     <span class="comment">/*</span>
<a name="l01841"></a>01841 <span class="comment">     * A callback invoked when a session is removed from the internal cache.</span>
<a name="l01842"></a>01842 <span class="comment">     *</span>
<a name="l01843"></a>01843 <span class="comment">     * The callback is invoked with an SSLContext and a Session.</span>
<a name="l01844"></a>01844 <span class="comment">     */</span>
<a name="l01845"></a>01845     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;session_remove_cb&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01846"></a>01846 
<a name="l01847"></a>01847 <span class="preprocessor">#ifdef HAVE_SSL_SET_TLSEXT_HOST_NAME</span>
<a name="l01848"></a>01848 <span class="preprocessor"></span>    <span class="comment">/*</span>
<a name="l01849"></a>01849 <span class="comment">     * A callback invoked at connect time to distinguish between multiple</span>
<a name="l01850"></a>01850 <span class="comment">     * server names.</span>
<a name="l01851"></a>01851 <span class="comment">     *</span>
<a name="l01852"></a>01852 <span class="comment">     * The callback is invoked with an SSLSocket and a server name.  The</span>
<a name="l01853"></a>01853 <span class="comment">     * callback must return an SSLContext for the server name or nil.</span>
<a name="l01854"></a>01854 <span class="comment">     */</span>
<a name="l01855"></a>01855     <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;servername_cb&quot;</span>), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01856"></a>01856 <span class="preprocessor">#endif</span>
<a name="l01857"></a>01857 <span class="preprocessor"></span>
<a name="l01858"></a>01858     <a class="code" href="../../d7/d19/group__defmethod.html#ga9ee2c97671d010bcb7a27614ab28bba7" title="Defines an alias of a method.">rb_define_alias</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;ssl_timeout&quot;</span>, <span class="stringliteral">&quot;timeout&quot;</span>);
<a name="l01859"></a>01859     <a class="code" href="../../d7/d19/group__defmethod.html#ga9ee2c97671d010bcb7a27614ab28bba7" title="Defines an alias of a method.">rb_define_alias</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;ssl_timeout=&quot;</span>, <span class="stringliteral">&quot;timeout=&quot;</span>);
<a name="l01860"></a>01860     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;initialize&quot;</span>,  <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a68e432887535b249e207d9ea6a51baeb">ossl_sslctx_initialize</a>, -1);
<a name="l01861"></a>01861     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;ssl_version=&quot;</span>, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3dbbe34597520e716de2838ed40737a9">ossl_sslctx_set_ssl_version</a>, 1);
<a name="l01862"></a>01862     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;ciphers&quot;</span>,     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a6f4e0e48e6d8acf2367844cfc04b641e">ossl_sslctx_get_ciphers</a>, 0);
<a name="l01863"></a>01863     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;ciphers=&quot;</span>,    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a30f3752153ec92789da6cb1fbe2daaf4">ossl_sslctx_set_ciphers</a>, 1);
<a name="l01864"></a>01864 
<a name="l01865"></a>01865     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;setup&quot;</span>, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aee593ff89ad5d4eaeeb4948555ad5f3e">ossl_sslctx_setup</a>, 0);
<a name="l01866"></a>01866 
<a name="l01867"></a>01867 
<a name="l01868"></a>01868     <span class="comment">/*</span>
<a name="l01869"></a>01869 <span class="comment">     * No session caching for client or server</span>
<a name="l01870"></a>01870 <span class="comment">     */</span>
<a name="l01871"></a>01871     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;SESSION_CACHE_OFF&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2ead2f64c81efed352e79e89f29b8fc8">LONG2FIX</a>(SSL_SESS_CACHE_OFF));
<a name="l01872"></a>01872 
<a name="l01873"></a>01873     <span class="comment">/*</span>
<a name="l01874"></a>01874 <span class="comment">     * Client sessions are added to the session cache</span>
<a name="l01875"></a>01875 <span class="comment">     */</span>
<a name="l01876"></a>01876     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;SESSION_CACHE_CLIENT&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2ead2f64c81efed352e79e89f29b8fc8">LONG2FIX</a>(SSL_SESS_CACHE_CLIENT)); <span class="comment">/* doesn&apos;t actually do anything in 0.9.8e */</span>
<a name="l01877"></a>01877 
<a name="l01878"></a>01878     <span class="comment">/*</span>
<a name="l01879"></a>01879 <span class="comment">     * Server sessions are added to the session cache</span>
<a name="l01880"></a>01880 <span class="comment">     */</span>
<a name="l01881"></a>01881     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;SESSION_CACHE_SERVER&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2ead2f64c81efed352e79e89f29b8fc8">LONG2FIX</a>(SSL_SESS_CACHE_SERVER));
<a name="l01882"></a>01882 
<a name="l01883"></a>01883     <span class="comment">/*</span>
<a name="l01884"></a>01884 <span class="comment">     * Both client and server sessions are added to the session cache</span>
<a name="l01885"></a>01885 <span class="comment">     */</span>
<a name="l01886"></a>01886     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;SESSION_CACHE_BOTH&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2ead2f64c81efed352e79e89f29b8fc8">LONG2FIX</a>(SSL_SESS_CACHE_BOTH)); <span class="comment">/* no different than CACHE_SERVER in 0.9.8e */</span>
<a name="l01887"></a>01887 
<a name="l01888"></a>01888     <span class="comment">/*</span>
<a name="l01889"></a>01889 <span class="comment">     * Normally the sesison cache is checked for expired sessions every 255</span>
<a name="l01890"></a>01890 <span class="comment">     * connections.  Since this may lead to a delay that cannot be controlled,</span>
<a name="l01891"></a>01891 <span class="comment">     * the automatic flushing may be disabled and #flush_sessions can be</span>
<a name="l01892"></a>01892 <span class="comment">     * called explicitly.</span>
<a name="l01893"></a>01893 <span class="comment">     */</span>
<a name="l01894"></a>01894     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;SESSION_CACHE_NO_AUTO_CLEAR&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2ead2f64c81efed352e79e89f29b8fc8">LONG2FIX</a>(SSL_SESS_CACHE_NO_AUTO_CLEAR));
<a name="l01895"></a>01895 
<a name="l01896"></a>01896     <span class="comment">/*</span>
<a name="l01897"></a>01897 <span class="comment">     * Always perform external lookups of sessions even if they are in the</span>
<a name="l01898"></a>01898 <span class="comment">     * internal cache.</span>
<a name="l01899"></a>01899 <span class="comment">     *</span>
<a name="l01900"></a>01900 <span class="comment">     * This flag has no effect on clients</span>
<a name="l01901"></a>01901 <span class="comment">     */</span>
<a name="l01902"></a>01902     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;SESSION_CACHE_NO_INTERNAL_LOOKUP&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2ead2f64c81efed352e79e89f29b8fc8">LONG2FIX</a>(SSL_SESS_CACHE_NO_INTERNAL_LOOKUP));
<a name="l01903"></a>01903 
<a name="l01904"></a>01904     <span class="comment">/*</span>
<a name="l01905"></a>01905 <span class="comment">     * Never automatically store sessions in the internal store.</span>
<a name="l01906"></a>01906 <span class="comment">     */</span>
<a name="l01907"></a>01907     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;SESSION_CACHE_NO_INTERNAL_STORE&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2ead2f64c81efed352e79e89f29b8fc8">LONG2FIX</a>(SSL_SESS_CACHE_NO_INTERNAL_STORE));
<a name="l01908"></a>01908 
<a name="l01909"></a>01909     <span class="comment">/*</span>
<a name="l01910"></a>01910 <span class="comment">     * Enables both SESSION_CACHE_NO_INTERNAL_LOOKUP and</span>
<a name="l01911"></a>01911 <span class="comment">     * SESSION_CACHE_NO_INTERNAL_STORE.</span>
<a name="l01912"></a>01912 <span class="comment">     */</span>
<a name="l01913"></a>01913     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;SESSION_CACHE_NO_INTERNAL&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2ead2f64c81efed352e79e89f29b8fc8">LONG2FIX</a>(SSL_SESS_CACHE_NO_INTERNAL));
<a name="l01914"></a>01914 
<a name="l01915"></a>01915     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;session_add&quot;</span>,     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#af5c18b7b8bf0532cfedb0db463bbc35b">ossl_sslctx_session_add</a>, 1);
<a name="l01916"></a>01916     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;session_remove&quot;</span>,     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a1cd49657a932a57661a406a13f209148">ossl_sslctx_session_remove</a>, 1);
<a name="l01917"></a>01917     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;session_cache_mode&quot;</span>,     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3c9ed757f1a4d39af379cfdff11c2321">ossl_sslctx_get_session_cache_mode</a>, 0);
<a name="l01918"></a>01918     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;session_cache_mode=&quot;</span>,     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a61b9b791b5cb4737096bc25289639b8c">ossl_sslctx_set_session_cache_mode</a>, 1);
<a name="l01919"></a>01919     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;session_cache_size&quot;</span>,     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ad8537494667d7ff66a03115583d621dc">ossl_sslctx_get_session_cache_size</a>, 0);
<a name="l01920"></a>01920     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;session_cache_size=&quot;</span>,     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a6f2dd6611416ddc134cc9ff2baa73be4">ossl_sslctx_set_session_cache_size</a>, 1);
<a name="l01921"></a>01921     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;session_cache_stats&quot;</span>,     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3fd30d8c36d0ec8d3aa93ae824e3cd60">ossl_sslctx_get_session_cache_stats</a>, 0);
<a name="l01922"></a>01922     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;flush_sessions&quot;</span>,     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a740b7c266bc5b62405d92adaaa5f0217">ossl_sslctx_flush_sessions</a>, -1);
<a name="l01923"></a>01923 
<a name="l01924"></a>01924     ary = <a class="code" href="../../dc/dcc/array_8c.html#a43a7bd246935ab63c233b4ae34d61d75">rb_ary_new2</a>(<a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aba4cc5eb530917e91bf5b03c9c3231e9">ossl_ssl_method_tab</a>));
<a name="l01925"></a>01925     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aba4cc5eb530917e91bf5b03c9c3231e9">ossl_ssl_method_tab</a>); i++) {
<a name="l01926"></a>01926         <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aba4cc5eb530917e91bf5b03c9c3231e9">ossl_ssl_method_tab</a>[i].<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)));
<a name="l01927"></a>01927     }
<a name="l01928"></a>01928     <a class="code" href="../../db/d2e/intern_8h.html#a8ea3742679211f408cb5769de6cf0d46">rb_obj_freeze</a>(ary);
<a name="l01929"></a>01929     <span class="comment">/* The list of available SSL/TLS methods */</span>
<a name="l01930"></a>01930     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a39b1539ca074b4dd907ca7d916711d09">cSSLContext</a>, <span class="stringliteral">&quot;METHODS&quot;</span>, ary);
<a name="l01931"></a>01931 
<a name="l01932"></a>01932     <span class="comment">/*</span>
<a name="l01933"></a>01933 <span class="comment">     * Document-class: OpenSSL::SSL::SSLSocket</span>
<a name="l01934"></a>01934 <span class="comment">     *</span>
<a name="l01935"></a>01935 <span class="comment">     * The following attributes are available but don&apos;t show up in rdoc.</span>
<a name="l01936"></a>01936 <span class="comment">     * * io, context, sync_close</span>
<a name="l01937"></a>01937 <span class="comment">     *</span>
<a name="l01938"></a>01938 <span class="comment">     */</span>
<a name="l01939"></a>01939     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a> = <a class="code" href="../../de/ddf/group__class.html#ga5266deadce0318d830a1e63c0933b898" title="Defines a class under the namespace of outer.">rb_define_class_under</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a1a50f2b264a326ebc8f9920f504bafca">mSSL</a>, <span class="stringliteral">&quot;SSLSocket&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a57c96ead3ef230b4838e65fe037c346e">rb_cObject</a>);
<a name="l01940"></a>01940     <a class="code" href="../../db/d2e/intern_8h.html#a6c99ed7f070458b961026d43d27d0642">rb_define_alloc_func</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab6cd346c26f168866c1e79633056178e">ossl_ssl_s_alloc</a>);
<a name="l01941"></a>01941     <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a02caefbd07ae556c8228598db1740394">ossl_ssl_attr_readers</a>); i++)
<a name="l01942"></a>01942         <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a02caefbd07ae556c8228598db1740394">ossl_ssl_attr_readers</a>[i]), 1, 0, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01943"></a>01943     <span class="keywordflow">for</span>(i = 0; i &lt; <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5582a20bc90c9fc49657d33bf3a187c8">ossl_ssl_attrs</a>); i++)
<a name="l01944"></a>01944         <a class="code" href="../../db/d2e/intern_8h.html#a187481b3db6f4bfb253eb0a4a4ee870e">rb_attr</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a5582a20bc90c9fc49657d33bf3a187c8">ossl_ssl_attrs</a>[i]), 1, 1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l01945"></a>01945     <a class="code" href="../../d7/d19/group__defmethod.html#ga9ee2c97671d010bcb7a27614ab28bba7" title="Defines an alias of a method.">rb_define_alias</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;to_io&quot;</span>, <span class="stringliteral">&quot;io&quot;</span>);
<a name="l01946"></a>01946     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;initialize&quot;</span>, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab5347a694d19982df0a446fed4aceb83">ossl_ssl_initialize</a>, -1);
<a name="l01947"></a>01947     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;connect&quot;</span>,    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a37dbf508f1440c92e3dd222dcaed787a">ossl_ssl_connect</a>, 0);
<a name="l01948"></a>01948     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;connect_nonblock&quot;</span>,    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab519cc92f2d2170486ead4f2e2430422">ossl_ssl_connect_nonblock</a>, 0);
<a name="l01949"></a>01949     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;accept&quot;</span>,     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aba7d1109fa6e94faaa41a8f1d74f111b">ossl_ssl_accept</a>, 0);
<a name="l01950"></a>01950     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;accept_nonblock&quot;</span>,     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa4ed964efa8d3502d151fea7a8326f54">ossl_ssl_accept_nonblock</a>, 0);
<a name="l01951"></a>01951     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;sysread&quot;</span>,    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#affa5aea0b4831b3c2b1c2ddb5e5af187">ossl_ssl_read</a>, -1);
<a name="l01952"></a>01952     <a class="code" href="../../d7/d19/group__defmethod.html#ga69c4f84891831d013e9e64972de90d78">rb_define_private_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;sysread_nonblock&quot;</span>,    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a38673c585afa788eee3a6a2546c57b6a">ossl_ssl_read_nonblock</a>, -1);
<a name="l01953"></a>01953     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;syswrite&quot;</span>,   <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aebfcd78f32ecbab80c3a46d27c01822d">ossl_ssl_write</a>, 1);
<a name="l01954"></a>01954     <a class="code" href="../../d7/d19/group__defmethod.html#ga69c4f84891831d013e9e64972de90d78">rb_define_private_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;syswrite_nonblock&quot;</span>,    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a7a13697bb04137b1c222700fac776b89">ossl_ssl_write_nonblock</a>, 1);
<a name="l01955"></a>01955     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;sysclose&quot;</span>,   <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8d61d17cba89d4039e480fdb09a31cee">ossl_ssl_close</a>, 0);
<a name="l01956"></a>01956     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;cert&quot;</span>,       <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#aa1289188eee5fbda628a40ffac17d6a8">ossl_ssl_get_cert</a>, 0);
<a name="l01957"></a>01957     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;peer_cert&quot;</span>,  <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a1355917825538292f94149f8a7dd60b4">ossl_ssl_get_peer_cert</a>, 0);
<a name="l01958"></a>01958     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;peer_cert_chain&quot;</span>, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ad134fbd78803b013c021648b4fb7be1f">ossl_ssl_get_peer_cert_chain</a>, 0);
<a name="l01959"></a>01959     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;cipher&quot;</span>,     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a38c2a19a216b1dfd4cd2256881efa815">ossl_ssl_get_cipher</a>, 0);
<a name="l01960"></a>01960     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;state&quot;</span>,      <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a70f4b886ae987b6ddc734ed6538f9131">ossl_ssl_get_state</a>, 0);
<a name="l01961"></a>01961     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;pending&quot;</span>,    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a3ae79c5ffad5eb978a9241574e468f48">ossl_ssl_pending</a>, 0);
<a name="l01962"></a>01962     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;session_reused?&quot;</span>,    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a0112373626aeeb8f5524eb0cc27506f9">ossl_ssl_session_reused</a>, 0);
<a name="l01963"></a>01963     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;session=&quot;</span>,    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a2b7cd83aad9036b5146ecb2f16a3679c">ossl_ssl_set_session</a>, 1);
<a name="l01964"></a>01964     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;verify_result&quot;</span>, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a9a0c4dd34b37a6bfc22fe7e665b7fd66">ossl_ssl_get_verify_result</a>, 0);
<a name="l01965"></a>01965     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a8e2efd629e0dd3a51cd973477bb1f050">cSSLSocket</a>, <span class="stringliteral">&quot;client_ca&quot;</span>, <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a6a4dba99941b07523746879cceb02689">ossl_ssl_get_client_ca_list</a>, 0);
<a name="l01966"></a>01966 
<a name="l01967"></a>01967 <span class="preprocessor">#define ossl_ssl_def_const(x) rb_define_const(mSSL, #x, INT2NUM(SSL_##x))</span>
<a name="l01968"></a>01968 <span class="preprocessor"></span>
<a name="l01969"></a>01969     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(VERIFY_NONE);
<a name="l01970"></a>01970     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(VERIFY_PEER);
<a name="l01971"></a>01971     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(VERIFY_FAIL_IF_NO_PEER_CERT);
<a name="l01972"></a>01972     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(VERIFY_CLIENT_ONCE);
<a name="l01973"></a>01973     <span class="comment">/* Introduce constants included in OP_ALL.  These constants are mostly for</span>
<a name="l01974"></a>01974 <span class="comment">     * unset some bits in OP_ALL such as:</span>
<a name="l01975"></a>01975 <span class="comment">     *   ctx.options = OP_ALL &amp; ~OP_DONT_INSERT_EMPTY_FRAGMENTS</span>
<a name="l01976"></a>01976 <span class="comment">     */</span>
<a name="l01977"></a>01977     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_MICROSOFT_SESS_ID_BUG);
<a name="l01978"></a>01978     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_NETSCAPE_CHALLENGE_BUG);
<a name="l01979"></a>01979     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_NETSCAPE_REUSE_CIPHER_CHANGE_BUG);
<a name="l01980"></a>01980     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_SSLREF2_REUSE_CERT_TYPE_BUG);
<a name="l01981"></a>01981     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_MICROSOFT_BIG_SSLV3_BUFFER);
<a name="l01982"></a>01982     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_MSIE_SSLV2_RSA_PADDING);
<a name="l01983"></a>01983     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_SSLEAY_080_CLIENT_DH_BUG);
<a name="l01984"></a>01984     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_TLS_D5_BUG);
<a name="l01985"></a>01985     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_TLS_BLOCK_PADDING_BUG);
<a name="l01986"></a>01986     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_DONT_INSERT_EMPTY_FRAGMENTS);
<a name="l01987"></a>01987     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_ALL);
<a name="l01988"></a>01988 <span class="preprocessor">#if defined(SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION)</span>
<a name="l01989"></a>01989 <span class="preprocessor"></span>    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION);
<a name="l01990"></a>01990 <span class="preprocessor">#endif</span>
<a name="l01991"></a>01991 <span class="preprocessor"></span><span class="preprocessor">#if defined(SSL_OP_SINGLE_ECDH_USE)</span>
<a name="l01992"></a>01992 <span class="preprocessor"></span>    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_SINGLE_ECDH_USE);
<a name="l01993"></a>01993 <span class="preprocessor">#endif</span>
<a name="l01994"></a>01994 <span class="preprocessor"></span>    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_SINGLE_DH_USE);
<a name="l01995"></a>01995     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_EPHEMERAL_RSA);
<a name="l01996"></a>01996 <span class="preprocessor">#if defined(SSL_OP_CIPHER_SERVER_PREFERENCE)</span>
<a name="l01997"></a>01997 <span class="preprocessor"></span>    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_CIPHER_SERVER_PREFERENCE);
<a name="l01998"></a>01998 <span class="preprocessor">#endif</span>
<a name="l01999"></a>01999 <span class="preprocessor"></span>    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_TLS_ROLLBACK_BUG);
<a name="l02000"></a>02000     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_NO_SSLv2);
<a name="l02001"></a>02001     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_NO_SSLv3);
<a name="l02002"></a>02002     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_NO_TLSv1);
<a name="l02003"></a>02003 <span class="preprocessor">#if defined(SSL_OP_NO_TICKET)</span>
<a name="l02004"></a>02004 <span class="preprocessor"></span>    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_NO_TICKET);
<a name="l02005"></a>02005 <span class="preprocessor">#endif</span>
<a name="l02006"></a>02006 <span class="preprocessor"></span><span class="preprocessor">#if defined(SSL_OP_NO_COMPRESSION)</span>
<a name="l02007"></a>02007 <span class="preprocessor"></span>    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_NO_COMPRESSION);
<a name="l02008"></a>02008 <span class="preprocessor">#endif</span>
<a name="l02009"></a>02009 <span class="preprocessor"></span>    <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_PKCS1_CHECK_1);
<a name="l02010"></a>02010     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_PKCS1_CHECK_2);
<a name="l02011"></a>02011     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_NETSCAPE_CA_DN_BUG);
<a name="l02012"></a>02012     <a class="code" href="../../dc/dd1/ossl__ssl_8c.html#ab89ba4a29a8dd4e8955eb7f34052d462">ossl_ssl_def_const</a>(OP_NETSCAPE_DEMO_CIPHER_CHANGE_BUG);
<a name="l02013"></a>02013 }
<a name="l02014"></a>02014 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Mar 2013 for Ruby by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
