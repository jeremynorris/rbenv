<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Ruby: io.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>io.c</h1><a href="../../df/d0a/io_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/**********************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  io.c -</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">  $Author: usa $</span>
<a name="l00006"></a>00006 <span class="comment">  created at: Fri Oct 15 18:08:59 JST 1993</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment">  Copyright (C) 1993-2007 Yukihiro Matsumoto</span>
<a name="l00009"></a>00009 <span class="comment">  Copyright (C) 2000  Network Applied Communication Laboratory, Inc.</span>
<a name="l00010"></a>00010 <span class="comment">  Copyright (C) 2000  Information-technology Promotion Agency, Japan</span>
<a name="l00011"></a>00011 <span class="comment"></span>
<a name="l00012"></a>00012 <span class="comment">**********************************************************************/</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="../../de/de6/ruby_2ruby_8h.html">ruby/ruby.h</a>&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="../../dc/dac/io_8h.html">ruby/io.h</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &quot;<a class="code" href="../../df/da8/dln_8h.html">dln.h</a>&quot;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="../../db/dde/internal_8h.html">internal.h</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00020"></a>00020 
<a name="l00021"></a><a class="code" href="../../df/d0a/io_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">00021</a> <span class="preprocessor">#define free(x) xfree(x)</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span>
<a name="l00023"></a>00023 <span class="preprocessor">#if defined(DOSISH) || defined(__CYGWIN__)</span>
<a name="l00024"></a>00024 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="../../dc/dac/io_8h.html">io.h</a>&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#endif</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#if defined HAVE_NET_SOCKET_H</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span><span class="preprocessor"># include &lt;net/socket.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#elif defined HAVE_SYS_SOCKET_H</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span><span class="preprocessor"># include &lt;sys/socket.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#endif</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span>
<a name="l00034"></a>00034 <span class="preprocessor">#if defined(__BOW__) || defined(__CYGWIN__) || defined(_WIN32) || defined(__EMX__) || defined(__BEOS__) || defined(__HAIKU__)</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="preprocessor"># define NO_SAFE_RENAME</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span>
<a name="l00038"></a>00038 <span class="preprocessor">#if defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__) || defined(__DragonFly__) || defined(sun) || defined(_nec_ews)</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor"># define USE_SETVBUF</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>
<a name="l00042"></a>00042 <span class="preprocessor">#ifdef __QNXNTO__</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#include &quot;unix.h&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#endif</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#if defined(HAVE_SYS_IOCTL_H) &amp;&amp; !defined(_WIN32)</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#endif</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span><span class="preprocessor">#if defined(HAVE_FCNTL_H) || defined(_WIN32)</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span><span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#elif defined(HAVE_SYS_FCNTL_H)</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/fcntl.h&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#endif</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span>
<a name="l00056"></a>00056 <span class="preprocessor">#if !HAVE_OFF_T &amp;&amp; !defined(off_t)</span>
<a name="l00057"></a><a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">00057</a> <span class="preprocessor"></span><span class="preprocessor"># define off_t  long</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="comment">/* EMX has sys/param.h, but.. */</span>
<a name="l00063"></a>00063 <span class="preprocessor">#if defined(HAVE_SYS_PARAM_H) &amp;&amp; !(defined(__EMX__) || defined(__HIUX_MPP__))</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span><span class="preprocessor"># include &lt;sys/param.h&gt;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#endif</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>
<a name="l00067"></a>00067 <span class="preprocessor">#if !defined NOFILE</span>
<a name="l00068"></a><a class="code" href="../../df/d0a/io_8c.html#a80bacbaea8dd6aecf216d85d981bcb21">00068</a> <span class="preprocessor"></span><span class="preprocessor"># define NOFILE 64</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span>
<a name="l00071"></a>00071 <span class="preprocessor">#ifdef HAVE_UNISTD_H</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span><span class="preprocessor">#include &lt;unistd.h&gt;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#endif</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>
<a name="l00075"></a>00075 <span class="preprocessor">#ifdef HAVE_SYSCALL_H</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="preprocessor">#include &lt;syscall.h&gt;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#elif defined HAVE_SYS_SYSCALL_H</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/syscall.h&gt;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#endif</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>
<a name="l00081"></a>00081 <span class="preprocessor">#if defined(__BEOS__) || defined(__HAIKU__)</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span><span class="preprocessor"># ifndef NOFILE</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span><span class="preprocessor">#  define NOFILE (OPEN_MAX)</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span><span class="preprocessor"># endif</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span>
<a name="l00087"></a>00087 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d3c/util_8h.html">ruby/util.h</a>&quot;</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 <span class="preprocessor">#ifndef O_ACCMODE</span>
<a name="l00090"></a><a class="code" href="../../df/d0a/io_8c.html#a4dc4d45e07d2abc899bcaf04b2846a87">00090</a> <span class="preprocessor"></span><span class="preprocessor">#define O_ACCMODE (O_RDONLY | O_WRONLY | O_RDWR)</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span>
<a name="l00093"></a>00093 <span class="preprocessor">#if SIZEOF_OFF_T &gt; SIZEOF_LONG &amp;&amp; !defined(HAVE_LONG_LONG)</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span><span class="preprocessor"># error off_t is bigger than long, but you have no long long...</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span>
<a name="l00097"></a>00097 <span class="preprocessor">#ifndef PIPE_BUF</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span><span class="preprocessor"># ifdef _POSIX_PIPE_BUF</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span><span class="preprocessor">#  define PIPE_BUF _POSIX_PIPE_BUF</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span><span class="preprocessor"># else</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span><span class="preprocessor">#  define PIPE_BUF 512 </span><span class="comment">/* is this ok? */</span>
<a name="l00102"></a>00102 <span class="preprocessor"># endif</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00104"></a>00104 <span class="preprocessor"></span>
<a name="l00105"></a><a class="code" href="../../df/d0a/io_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">00105</a> <span class="preprocessor">#define numberof(array) (int)(sizeof(array) / sizeof((array)[0]))</span>
<a name="l00106"></a>00106 <span class="preprocessor"></span>
<a name="l00107"></a><a class="code" href="../../df/d0a/io_8c.html#a56f9188222b3c05d33f244571dd10600">00107</a> <span class="preprocessor">#define IO_RBUF_CAPA_MIN  8192</span>
<a name="l00108"></a><a class="code" href="../../df/d0a/io_8c.html#a25b1881481548cbb177445366abf15e1">00108</a> <span class="preprocessor"></span><span class="preprocessor">#define IO_CBUF_CAPA_MIN  (128*1024)</span>
<a name="l00109"></a><a class="code" href="../../df/d0a/io_8c.html#ab6a00d3d101f364c9acbbae275cef69a">00109</a> <span class="preprocessor"></span><span class="preprocessor">#define IO_RBUF_CAPA_FOR(fptr) (NEED_READCONV(fptr) ? IO_CBUF_CAPA_MIN : IO_RBUF_CAPA_MIN)</span>
<a name="l00110"></a><a class="code" href="../../df/d0a/io_8c.html#a4c1ecf89984f5a0bd1e94e715c5213ff">00110</a> <span class="preprocessor"></span><span class="preprocessor">#define IO_WBUF_CAPA_MIN  8192</span>
<a name="l00111"></a>00111 <span class="preprocessor"></span>
<a name="l00112"></a>00112 <span class="comment">/* define system APIs */</span>
<a name="l00113"></a>00113 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l00114"></a>00114 <span class="preprocessor"></span><span class="preprocessor">#undef open</span>
<a name="l00115"></a>00115 <span class="preprocessor"></span><span class="preprocessor">#define open    rb_w32_uopen</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00117"></a>00117 <span class="preprocessor"></span>
<a name="l00118"></a><a class="code" href="../../df/d0a/io_8c.html#a3d1f25db006f766569c327321e3695d1">00118</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>;
<a name="l00119"></a><a class="code" href="../../df/d0a/io_8c.html#a578f27e58ec12c2b4478eee3a391f025">00119</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a64459141201c6d17c834b04b905a4dc5">rb_eEOFError</a>;
<a name="l00120"></a><a class="code" href="../../df/d0a/io_8c.html#a3a88df7a1fc75148ff72cfa4742e9b01">00120</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>;
<a name="l00121"></a><a class="code" href="../../df/d0a/io_8c.html#acaf7d43b4567d94c73bab2178ce761c2">00121</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac2d47e89b7cb8311129ec7566608a0b2">rb_mWaitReadable</a>;
<a name="l00122"></a><a class="code" href="../../df/d0a/io_8c.html#accfe7d24892a80e096d0f51be8b71c3b">00122</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac0e6048c512add5b6659c01f7f134d8a">rb_mWaitWritable</a>;
<a name="l00123"></a>00123 
<a name="l00124"></a><a class="code" href="../../df/d0a/io_8c.html#af04c060c26cd03ee40e7442e036fae4c">00124</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afafc64c52c6ab49dbc5699da872cad03">rb_stdin</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1bc7a47b6913bb55b64d881d19da4d03">rb_stderr</a>;
<a name="l00125"></a><a class="code" href="../../df/d0a/io_8c.html#a1de1da4197f3c858df455fc43f5bf79c">00125</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../df/d0a/io_8c.html#a1de1da4197f3c858df455fc43f5bf79c">rb_deferr</a>;                <span class="comment">/* rescue VIM plugin */</span>
<a name="l00126"></a><a class="code" href="../../df/d0a/io_8c.html#a51b183f14dd2be4d72bc7f5a9c5af041">00126</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../df/d0a/io_8c.html#a51b183f14dd2be4d72bc7f5a9c5af041">orig_stdout</a>, <a class="code" href="../../df/d0a/io_8c.html#acf8024d5428fdf61c44bea5ed3e40b55">orig_stderr</a>;
<a name="l00127"></a>00127 
<a name="l00128"></a><a class="code" href="../../df/d0a/io_8c.html#ac8351f37c8a5de2cc8cd638f7d515396">00128</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dc/dcc/array_8c.html#ac8351f37c8a5de2cc8cd638f7d515396">rb_output_fs</a>;
<a name="l00129"></a><a class="code" href="../../df/d0a/io_8c.html#a13996fd79308b029254ee6036c47c7e4">00129</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../db/d2e/intern_8h.html#a6d19bb99247117d9d8b880ab14ad8d25">rb_rs</a>;
<a name="l00130"></a><a class="code" href="../../df/d0a/io_8c.html#a7f0e01bfc1af61f23d62d73759d7b4a1">00130</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../db/d2e/intern_8h.html#aad25f1b1b54e12dcb609374f46cfd0e5">rb_output_rs</a>;
<a name="l00131"></a><a class="code" href="../../df/d0a/io_8c.html#affbe1c7be2ff8f10d1b95258b89b4bc8">00131</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../db/d2e/intern_8h.html#ab707a74e9c34626c05d20431ad137570">rb_default_rs</a>;
<a name="l00132"></a>00132 
<a name="l00133"></a><a class="code" href="../../df/d0a/io_8c.html#a1e5a8690ed6b6977e4bf519ac9f3eefd">00133</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>;
<a name="l00134"></a>00134 
<a name="l00135"></a><a class="code" href="../../df/d0a/io_8c.html#a5a1310970981dfb309a18f6a1a9a771b">00135</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <a class="code" href="../../df/d0a/io_8c.html#a5a1310970981dfb309a18f6a1a9a771b">id_write</a>, <a class="code" href="../../df/d0a/io_8c.html#aaab409b2dac658da354cd7efc5ad39ae">id_read</a>, <a class="code" href="../../df/d0a/io_8c.html#a8902818fa89b386103fb16fb33041525">id_getc</a>, <a class="code" href="../../df/d0a/io_8c.html#a3096167a3c55f32a5fa2535e5ee0c2c4">id_flush</a>, <a class="code" href="../../df/d0a/io_8c.html#a5b4f2a8b420ec7588f0a9983fb513b81">id_readpartial</a>, <a class="code" href="../../df/d0a/io_8c.html#a666eb54f6ebe3c9e4220669471fe098c">id_set_encoding</a>;
<a name="l00136"></a><a class="code" href="../../df/d0a/io_8c.html#a950cb0a17937f0c0dfe5d07d0f683e62">00136</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../df/d0a/io_8c.html#a6fe1eaa40920fbfda47e7975c8b75f37">sym_mode</a>, <a class="code" href="../../df/d0a/io_8c.html#a950cb0a17937f0c0dfe5d07d0f683e62">sym_perm</a>, <a class="code" href="../../df/d0a/io_8c.html#a2bea26a74e408e997bfd7fc4d5af334e">sym_extenc</a>, <a class="code" href="../../df/d0a/io_8c.html#a5ae55baafa10e068146f943efaccd871">sym_intenc</a>, <a class="code" href="../../df/d0a/io_8c.html#acbc60bfefe79b70198c8b537ba5ffefb">sym_encoding</a>, <a class="code" href="../../df/d0a/io_8c.html#aa4c5f56edec4d64183c04d42acbdef60">sym_open_args</a>;
<a name="l00137"></a><a class="code" href="../../df/d0a/io_8c.html#a059a73cfb0046b6b226bd2ecffc7b20c">00137</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../df/d0a/io_8c.html#a059a73cfb0046b6b226bd2ecffc7b20c">sym_textmode</a>, <a class="code" href="../../df/d0a/io_8c.html#a3dd84f3dee23c52a99275e865290c722">sym_binmode</a>, <a class="code" href="../../df/d0a/io_8c.html#adc69b3a7193b993c16b2db4379b4f90f">sym_autoclose</a>;
<a name="l00138"></a>00138 
<a name="l00139"></a><a class="code" href="../../de/d05/structargf.html">00139</a> <span class="keyword">struct </span><a class="code" href="../../de/d05/structargf.html">argf</a> {
<a name="l00140"></a><a class="code" href="../../de/d05/structargf.html#a4a848f6fb0012d835153262d0fe330c7">00140</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html#a4a848f6fb0012d835153262d0fe330c7">filename</a>, <a class="code" href="../../de/d05/structargf.html#abfa2b8324eb7097cebd4574121933a6d">current_file</a>;
<a name="l00141"></a><a class="code" href="../../de/d05/structargf.html#a11cfea074c6ddb46e931e50399b71838">00141</a>     <span class="keywordtype">long</span> <a class="code" href="../../de/d05/structargf.html#a11cfea074c6ddb46e931e50399b71838">last_lineno</a>;           <span class="comment">/* $. */</span>
<a name="l00142"></a><a class="code" href="../../de/d05/structargf.html#a7ed7d87a54c68d718f958b304c78d824">00142</a>     <span class="keywordtype">long</span> <a class="code" href="../../de/d05/structargf.html#a7ed7d87a54c68d718f958b304c78d824">lineno</a>;
<a name="l00143"></a><a class="code" href="../../de/d05/structargf.html#ad47f40f415a34eec60ec2c4cda9434f6">00143</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html#ad47f40f415a34eec60ec2c4cda9434f6">argv</a>;
<a name="l00144"></a><a class="code" href="../../de/d05/structargf.html#a11be549c64517da442bade959ce52f15">00144</a>     <span class="keywordtype">char</span> *<a class="code" href="../../de/d05/structargf.html#a11be549c64517da442bade959ce52f15">inplace</a>;
<a name="l00145"></a><a class="code" href="../../de/d05/structargf.html#a129a87ec29eaeab30d052a2f3467fce6">00145</a>     <span class="keyword">struct </span>rb_io_enc_t <a class="code" href="../../de/d05/structargf.html#a129a87ec29eaeab30d052a2f3467fce6">encs</a>;
<a name="l00146"></a><a class="code" href="../../de/d05/structargf.html#a37a1b000be210577b0d77db2bce93019">00146</a>     int8_t <a class="code" href="../../de/d05/structargf.html#ac12385fddf7ddf6d12e33aa632890fbc">init_p</a>, <a class="code" href="../../de/d05/structargf.html#a37a1b000be210577b0d77db2bce93019">next_p</a>, <a class="code" href="../../de/d05/structargf.html#ac61013f7a63ecb15d9c05d22c50c682f">binmode</a>;
<a name="l00147"></a>00147 };
<a name="l00148"></a>00148 
<a name="l00149"></a><a class="code" href="../../df/d0a/io_8c.html#ac9e89b19f784faee13aa7cc81b3e4771">00149</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d0a/io_8c.html#ac9e89b19f784faee13aa7cc81b3e4771">max_file_descriptor</a> = <a class="code" href="../../df/d0a/io_8c.html#a80bacbaea8dd6aecf216d85d981bcb21">NOFILE</a>;
<a name="l00150"></a>00150 <span class="keywordtype">void</span>
<a name="l00151"></a><a class="code" href="../../df/d0a/io_8c.html#a6448f20b0936afe0cb85ab3186753db2">00151</a> <a class="code" href="../../db/d2e/intern_8h.html#a6448f20b0936afe0cb85ab3186753db2">rb_update_max_fd</a>(<span class="keywordtype">int</span> fd)
<a name="l00152"></a>00152 {
<a name="l00153"></a>00153     <span class="keyword">struct </span><a class="code" href="../../dc/db1/win32_8h.html#a4feaac5e1913330bded57b059061965b">stat</a> buf;
<a name="l00154"></a>00154     <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#a8a2cf46df7f7017617df85cdb0afdc64">fstat</a>(fd, &amp;buf) != 0 &amp;&amp; <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EBADF) {
<a name="l00155"></a>00155         <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;rb_update_max_fd: invalid fd (%d) given.&quot;</span>, fd);
<a name="l00156"></a>00156     }
<a name="l00157"></a>00157     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#ac9e89b19f784faee13aa7cc81b3e4771">max_file_descriptor</a> &lt; fd) <a class="code" href="../../df/d0a/io_8c.html#ac9e89b19f784faee13aa7cc81b3e4771">max_file_descriptor</a> = fd;
<a name="l00158"></a>00158 }
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <span class="keywordtype">void</span>
<a name="l00161"></a><a class="code" href="../../df/d0a/io_8c.html#a5278ac5a8808dc5e01c7fb48f4f97e38">00161</a> <a class="code" href="../../df/d0a/io_8c.html#a5278ac5a8808dc5e01c7fb48f4f97e38">rb_maygvl_fd_fix_cloexec</a>(<span class="keywordtype">int</span> fd)
<a name="l00162"></a>00162 {
<a name="l00163"></a>00163   <span class="comment">/* MinGW don&apos;t have F_GETFD and FD_CLOEXEC.  [ruby-core:40281] */</span>
<a name="l00164"></a>00164 <span class="preprocessor">#ifdef F_GETFD</span>
<a name="l00165"></a>00165 <span class="preprocessor"></span>  <span class="keywordtype">int</span> flags, flags2, ret;
<a name="l00166"></a>00166   flags = <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fd, F_GETFD); <span class="comment">/* should not fail except EBADF. */</span>
<a name="l00167"></a>00167   <span class="keywordflow">if</span> (flags == -1) {
<a name="l00168"></a>00168     <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;rb_maygvl_fd_fix_cloexec: fcntl(%d, F_GETFD) failed: %s&quot;</span>, fd, <a class="code" href="../../d3/d90/missing_8h.html#afd46339e0e35acab03772ba959071313">strerror</a>(<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00169"></a>00169   }
<a name="l00170"></a>00170   <span class="keywordflow">if</span> (fd &lt;= 2)
<a name="l00171"></a>00171     flags2 = flags &amp; ~FD_CLOEXEC; <span class="comment">/* Clear CLOEXEC for standard file descriptors: 0, 1, 2. */</span>
<a name="l00172"></a>00172   <span class="keywordflow">else</span>
<a name="l00173"></a>00173     flags2 = flags | FD_CLOEXEC; <span class="comment">/* Set CLOEXEC for non-standard file descriptors: 3, 4, 5, ... */</span>
<a name="l00174"></a>00174   <span class="keywordflow">if</span> (flags != flags2) {
<a name="l00175"></a>00175     ret = <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fd, F_SETFD, flags2);
<a name="l00176"></a>00176     <span class="keywordflow">if</span> (ret == -1) {
<a name="l00177"></a>00177       <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;rb_maygvl_fd_fix_cloexec: fcntl(%d, F_SETFD, %d) failed: %s&quot;</span>, fd, flags2, <a class="code" href="../../d3/d90/missing_8h.html#afd46339e0e35acab03772ba959071313">strerror</a>(<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00178"></a>00178     }
<a name="l00179"></a>00179   }
<a name="l00180"></a>00180 <span class="preprocessor">#endif</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span>}
<a name="l00182"></a>00182 
<a name="l00183"></a>00183 <span class="keywordtype">int</span>
<a name="l00184"></a><a class="code" href="../../df/d0a/io_8c.html#ac731a84d6bdd57dfcbdf468660dc38e5">00184</a> <a class="code" href="../../df/d0a/io_8c.html#ac731a84d6bdd57dfcbdf468660dc38e5">rb_cloexec_fcntl_dupfd</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> minfd)
<a name="l00185"></a>00185 {
<a name="l00186"></a>00186     <span class="keywordtype">int</span> ret;
<a name="l00187"></a>00187 
<a name="l00188"></a>00188 <span class="preprocessor">#if defined(HAVE_FCNTL) &amp;&amp; defined(F_DUPFD_CLOEXEC)</span>
<a name="l00189"></a>00189 <span class="preprocessor"></span>    <span class="keyword">static</span> <span class="keywordtype">int</span> try_dupfd_cloexec = 1;
<a name="l00190"></a>00190     <span class="keywordflow">if</span> (try_dupfd_cloexec) {
<a name="l00191"></a>00191       ret = <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fd, F_DUPFD_CLOEXEC, minfd);
<a name="l00192"></a>00192       <span class="keywordflow">if</span> (ret != -1) {
<a name="l00193"></a>00193         <span class="keywordflow">if</span> (ret &lt;= 2)
<a name="l00194"></a>00194           <a class="code" href="../../df/d0a/io_8c.html#a5278ac5a8808dc5e01c7fb48f4f97e38">rb_maygvl_fd_fix_cloexec</a>(ret);
<a name="l00195"></a>00195         <span class="keywordflow">return</span> ret;
<a name="l00196"></a>00196       }
<a name="l00197"></a>00197       <span class="comment">/* F_DUPFD_CLOEXEC is available since Linux 2.6.24.  Linux 2.6.18 fails with EINVAL */</span>
<a name="l00198"></a>00198       <span class="keywordflow">if</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EINVAL) {
<a name="l00199"></a>00199         ret = <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fd, F_DUPFD, minfd);
<a name="l00200"></a>00200         <span class="keywordflow">if</span> (ret != -1) {
<a name="l00201"></a>00201           try_dupfd_cloexec = 0;
<a name="l00202"></a>00202         }
<a name="l00203"></a>00203       }
<a name="l00204"></a>00204     }
<a name="l00205"></a>00205     <span class="keywordflow">else</span> {
<a name="l00206"></a>00206       ret = <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fd, F_DUPFD, minfd);
<a name="l00207"></a>00207     }
<a name="l00208"></a>00208 <span class="preprocessor">#elif defined(F_DUPFD)</span>
<a name="l00209"></a>00209 <span class="preprocessor"></span>    ret = <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fd, F_DUPFD, minfd);
<a name="l00210"></a>00210 <span class="preprocessor">#else</span>
<a name="l00211"></a>00211 <span class="preprocessor"></span>    ret = -1;
<a name="l00212"></a>00212     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l00213"></a>00213 <span class="preprocessor">#endif</span>
<a name="l00214"></a>00214 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ret == -1) <span class="keywordflow">return</span> -1;
<a name="l00215"></a>00215     <a class="code" href="../../df/d0a/io_8c.html#a5278ac5a8808dc5e01c7fb48f4f97e38">rb_maygvl_fd_fix_cloexec</a>(ret);
<a name="l00216"></a>00216     <span class="keywordflow">return</span> ret;
<a name="l00217"></a>00217 }
<a name="l00218"></a>00218 
<a name="l00219"></a><a class="code" href="../../df/d0a/io_8c.html#a4054ac142b4963ff020a21031faae606">00219</a> <span class="preprocessor">#define argf_of(obj) (*(struct argf *)DATA_PTR(obj))</span>
<a name="l00220"></a><a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">00220</a> <span class="preprocessor"></span><span class="preprocessor">#define ARGF argf_of(argf)</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span>
<a name="l00222"></a>00222 <span class="preprocessor">#ifdef _STDIO_USES_IOSTREAM  </span><span class="comment">/* GNU libc */</span>
<a name="l00223"></a>00223 <span class="preprocessor">#  ifdef _IO_fpos_t</span>
<a name="l00224"></a>00224 <span class="preprocessor"></span><span class="preprocessor">#    define STDIO_READ_DATA_PENDING(fp) ((fp)-&gt;_IO_read_ptr != (fp)-&gt;_IO_read_end)</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span><span class="preprocessor">#  else</span>
<a name="l00226"></a>00226 <span class="preprocessor"></span><span class="preprocessor">#    define STDIO_READ_DATA_PENDING(fp) ((fp)-&gt;_gptr &lt; (fp)-&gt;_egptr)</span>
<a name="l00227"></a>00227 <span class="preprocessor"></span><span class="preprocessor">#  endif</span>
<a name="l00228"></a>00228 <span class="preprocessor"></span><span class="preprocessor">#elif defined(FILE_COUNT)</span>
<a name="l00229"></a>00229 <span class="preprocessor"></span><span class="preprocessor">#  define STDIO_READ_DATA_PENDING(fp) ((fp)-&gt;FILE_COUNT &gt; 0)</span>
<a name="l00230"></a>00230 <span class="preprocessor"></span><span class="preprocessor">#elif defined(FILE_READEND)</span>
<a name="l00231"></a>00231 <span class="preprocessor"></span><span class="preprocessor">#  define STDIO_READ_DATA_PENDING(fp) ((fp)-&gt;FILE_READPTR &lt; (fp)-&gt;FILE_READEND)</span>
<a name="l00232"></a>00232 <span class="preprocessor"></span><span class="preprocessor">#elif defined(__BEOS__) || defined(__HAIKU__)</span>
<a name="l00233"></a>00233 <span class="preprocessor"></span><span class="preprocessor">#  define STDIO_READ_DATA_PENDING(fp) ((fp)-&gt;_state._eof == 0)</span>
<a name="l00234"></a>00234 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00235"></a><a class="code" href="../../df/d0a/io_8c.html#af45f8af95b6c427f54933f445991fab7">00235</a> <span class="preprocessor"></span><span class="preprocessor">#  define STDIO_READ_DATA_PENDING(fp) (!feof(fp))</span>
<a name="l00236"></a>00236 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00237"></a>00237 <span class="preprocessor"></span>
<a name="l00238"></a><a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">00238</a> <span class="preprocessor">#define GetWriteIO(io) rb_io_get_write_io(io)</span>
<a name="l00239"></a>00239 <span class="preprocessor"></span>
<a name="l00240"></a><a class="code" href="../../df/d0a/io_8c.html#a38357513887e9cae9c0b4a5dc0d4007e">00240</a> <span class="preprocessor">#define READ_DATA_PENDING(fptr) ((fptr)-&gt;rbuf.len)</span>
<a name="l00241"></a><a class="code" href="../../df/d0a/io_8c.html#a3d1f21b592c8d0533a4eb4795837f453">00241</a> <span class="preprocessor"></span><span class="preprocessor">#define READ_DATA_PENDING_COUNT(fptr) ((fptr)-&gt;rbuf.len)</span>
<a name="l00242"></a><a class="code" href="../../df/d0a/io_8c.html#a921ad10da930526526f7623973938cb6">00242</a> <span class="preprocessor"></span><span class="preprocessor">#define READ_DATA_PENDING_PTR(fptr) ((fptr)-&gt;rbuf.ptr+(fptr)-&gt;rbuf.off)</span>
<a name="l00243"></a><a class="code" href="../../df/d0a/io_8c.html#acc172dbd9a906b747f18dc76a58990e3">00243</a> <span class="preprocessor"></span><span class="preprocessor">#define READ_DATA_BUFFERED(fptr) READ_DATA_PENDING(fptr)</span>
<a name="l00244"></a>00244 <span class="preprocessor"></span>
<a name="l00245"></a><a class="code" href="../../df/d0a/io_8c.html#aa0377d67a404cdeebc3ad2ceab0ef054">00245</a> <span class="preprocessor">#define READ_CHAR_PENDING(fptr) ((fptr)-&gt;cbuf.len)</span>
<a name="l00246"></a><a class="code" href="../../df/d0a/io_8c.html#aa477a8eca97872ed13fa86fc6ed6e9d4">00246</a> <span class="preprocessor"></span><span class="preprocessor">#define READ_CHAR_PENDING_COUNT(fptr) ((fptr)-&gt;cbuf.len)</span>
<a name="l00247"></a><a class="code" href="../../df/d0a/io_8c.html#a5287955867e0e471ee9341fbbda041b8">00247</a> <span class="preprocessor"></span><span class="preprocessor">#define READ_CHAR_PENDING_PTR(fptr) ((fptr)-&gt;cbuf.ptr+(fptr)-&gt;cbuf.off)</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span>
<a name="l00249"></a>00249 <span class="preprocessor">#if defined(_WIN32)</span>
<a name="l00250"></a>00250 <span class="preprocessor"></span><span class="preprocessor">#define WAIT_FD_IN_WIN32(fptr) \</span>
<a name="l00251"></a>00251 <span class="preprocessor">    (rb_w32_io_cancelable_p((fptr)-&gt;fd) ? 0 : rb_thread_wait_fd((fptr)-&gt;fd))</span>
<a name="l00252"></a>00252 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00253"></a><a class="code" href="../../df/d0a/io_8c.html#a11f26c0fb7561d9316bcc0f80ece9486">00253</a> <span class="preprocessor"></span><span class="preprocessor">#define WAIT_FD_IN_WIN32(fptr)</span>
<a name="l00254"></a>00254 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00255"></a>00255 <span class="preprocessor"></span>
<a name="l00256"></a><a class="code" href="../../df/d0a/io_8c.html#a704f29b50a37b53c4a9f4f876d350f0d">00256</a> <span class="preprocessor">#define READ_CHECK(fptr) do {\</span>
<a name="l00257"></a>00257 <span class="preprocessor">    if (!READ_DATA_PENDING(fptr)) {\</span>
<a name="l00258"></a>00258 <span class="preprocessor">        WAIT_FD_IN_WIN32(fptr);\</span>
<a name="l00259"></a>00259 <span class="preprocessor">        rb_io_check_closed(fptr);\</span>
<a name="l00260"></a>00260 <span class="preprocessor">     }\</span>
<a name="l00261"></a>00261 <span class="preprocessor">} while(0)</span>
<a name="l00262"></a>00262 <span class="preprocessor"></span>
<a name="l00263"></a>00263 <span class="preprocessor">#ifndef S_ISSOCK</span>
<a name="l00264"></a>00264 <span class="preprocessor"></span><span class="preprocessor">#  ifdef _S_ISSOCK</span>
<a name="l00265"></a>00265 <span class="preprocessor"></span><span class="preprocessor">#    define S_ISSOCK(m) _S_ISSOCK(m)</span>
<a name="l00266"></a>00266 <span class="preprocessor"></span><span class="preprocessor">#  else</span>
<a name="l00267"></a>00267 <span class="preprocessor"></span><span class="preprocessor">#    ifdef _S_IFSOCK</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span><span class="preprocessor">#      define S_ISSOCK(m) (((m) &amp; S_IFMT) == _S_IFSOCK)</span>
<a name="l00269"></a>00269 <span class="preprocessor"></span><span class="preprocessor">#    else</span>
<a name="l00270"></a>00270 <span class="preprocessor"></span><span class="preprocessor">#      ifdef S_IFSOCK</span>
<a name="l00271"></a>00271 <span class="preprocessor"></span><span class="preprocessor">#        define S_ISSOCK(m) (((m) &amp; S_IFMT) == S_IFSOCK)</span>
<a name="l00272"></a>00272 <span class="preprocessor"></span><span class="preprocessor">#      endif</span>
<a name="l00273"></a>00273 <span class="preprocessor"></span><span class="preprocessor">#    endif</span>
<a name="l00274"></a>00274 <span class="preprocessor"></span><span class="preprocessor">#  endif</span>
<a name="l00275"></a>00275 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00276"></a>00276 <span class="preprocessor"></span>
<a name="l00277"></a><a class="code" href="../../df/d0a/io_8c.html#a33600c779917508425c20181f0f45366">00277</a> <span class="preprocessor">#define rb_sys_fail_path(path) rb_sys_fail_str(path)</span>
<a name="l00278"></a>00278 <span class="preprocessor"></span>
<a name="l00279"></a>00279 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *);
<a name="l00280"></a>00280 <span class="keyword">static</span> <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *<a class="code" href="../../df/d0a/io_8c.html#a397d2b0970b7bc79aa1b7fc98503c6f5">flush_before_seek</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr);
<a name="l00281"></a>00281 
<a name="l00282"></a><a class="code" href="../../df/d0a/io_8c.html#a8a6ac07e9b2ef3f2e60b2f16f62196c3">00282</a> <span class="preprocessor">#define NEED_NEWLINE_DECORATOR_ON_READ(fptr) ((fptr)-&gt;mode &amp; FMODE_TEXTMODE)</span>
<a name="l00283"></a><a class="code" href="../../df/d0a/io_8c.html#a6a84cf10d61a56a22488349a6b0d3b23">00283</a> <span class="preprocessor"></span><span class="preprocessor">#define NEED_NEWLINE_DECORATOR_ON_WRITE(fptr) ((fptr)-&gt;mode &amp; FMODE_TEXTMODE)</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span><span class="preprocessor">#if defined(RUBY_TEST_CRLF_ENVIRONMENT) || defined(_WIN32)</span>
<a name="l00285"></a>00285 <span class="preprocessor"></span><span class="comment">/* Windows */</span>
<a name="l00286"></a>00286 <span class="preprocessor"># define DEFAULT_TEXTMODE FMODE_TEXTMODE</span>
<a name="l00287"></a>00287 <span class="preprocessor"></span><span class="preprocessor"># define TEXTMODE_NEWLINE_DECORATOR_ON_WRITE ECONV_CRLF_NEWLINE_DECORATOR</span>
<a name="l00288"></a>00288 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l00289"></a>00289 <span class="comment"> * CRLF newline is set as default newline decorator.</span>
<a name="l00290"></a>00290 <span class="comment"> * If only CRLF newline conversion is needed, we use binary IO process</span>
<a name="l00291"></a>00291 <span class="comment"> * with OS&apos;s text mode for IO performance improvement.</span>
<a name="l00292"></a>00292 <span class="comment"> * If encoding conversion is needed or a user sets text mode, we use encoding</span>
<a name="l00293"></a>00293 <span class="comment"> * conversion IO process and universal newline decorator by default.</span>
<a name="l00294"></a>00294 <span class="comment"> */</span>
<a name="l00295"></a>00295 <span class="preprocessor">#define NEED_READCONV(fptr) ((fptr)-&gt;encs.enc2 != NULL || (fptr)-&gt;encs.ecflags &amp; ~ECONV_CRLF_NEWLINE_DECORATOR)</span>
<a name="l00296"></a>00296 <span class="preprocessor"></span><span class="preprocessor">#define NEED_WRITECONV(fptr) (((fptr)-&gt;encs.enc != NULL &amp;&amp; (fptr)-&gt;encs.enc != rb_ascii8bit_encoding()) || ((fptr)-&gt;encs.ecflags &amp; ((ECONV_DECORATOR_MASK &amp; ~ECONV_CRLF_NEWLINE_DECORATOR)|ECONV_STATEFUL_DECORATOR_MASK)))</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span><span class="preprocessor">#define SET_BINARY_MODE(fptr) setmode((fptr)-&gt;fd, O_BINARY)</span>
<a name="l00298"></a>00298 <span class="preprocessor"></span>
<a name="l00299"></a>00299 <span class="preprocessor">#define NEED_NEWLINE_DECORATOR_ON_READ_CHECK(fptr) do {\</span>
<a name="l00300"></a>00300 <span class="preprocessor">    if (NEED_NEWLINE_DECORATOR_ON_READ(fptr)) {\</span>
<a name="l00301"></a>00301 <span class="preprocessor">        if (((fptr)-&gt;mode &amp; FMODE_READABLE) &amp;&amp;\</span>
<a name="l00302"></a>00302 <span class="preprocessor">            !((fptr)-&gt;encs.ecflags &amp; ECONV_NEWLINE_DECORATOR_MASK)) {\</span>
<a name="l00303"></a>00303 <span class="preprocessor">            setmode((fptr)-&gt;fd, O_BINARY);\</span>
<a name="l00304"></a>00304 <span class="preprocessor">        }\</span>
<a name="l00305"></a>00305 <span class="preprocessor">        else {\</span>
<a name="l00306"></a>00306 <span class="preprocessor">            setmode((fptr)-&gt;fd, O_TEXT);\</span>
<a name="l00307"></a>00307 <span class="preprocessor">        }\</span>
<a name="l00308"></a>00308 <span class="preprocessor">    }\</span>
<a name="l00309"></a>00309 <span class="preprocessor">} while(0)</span>
<a name="l00310"></a>00310 <span class="preprocessor"></span>
<a name="l00311"></a>00311 <span class="preprocessor">#define SET_UNIVERSAL_NEWLINE_DECORATOR_IF_ENC2(enc2, ecflags) do {\</span>
<a name="l00312"></a>00312 <span class="preprocessor">    if ((enc2) &amp;&amp; ((ecflags) &amp; ECONV_DEFAULT_NEWLINE_DECORATOR)) {\</span>
<a name="l00313"></a>00313 <span class="preprocessor">        (ecflags) |= ECONV_UNIVERSAL_NEWLINE_DECORATOR;\</span>
<a name="l00314"></a>00314 <span class="preprocessor">    }\</span>
<a name="l00315"></a>00315 <span class="preprocessor">} while(0)</span>
<a name="l00316"></a>00316 <span class="preprocessor"></span>
<a name="l00317"></a>00317 <span class="comment">/*</span>
<a name="l00318"></a>00318 <span class="comment"> * IO unread with taking care of removed &apos;\r&apos; in text mode.</span>
<a name="l00319"></a>00319 <span class="comment"> */</span>
<a name="l00320"></a>00320 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00321"></a>00321 <a class="code" href="../../df/d0a/io_8c.html#a7649b75a0b7abd414acc585acd2d061e">io_unread</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00322"></a>00322 {
<a name="l00323"></a>00323     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> r, pos;
<a name="l00324"></a>00324     ssize_t read_size;
<a name="l00325"></a>00325     <span class="keywordtype">long</span> i;
<a name="l00326"></a>00326     <span class="keywordtype">long</span> newlines = 0;
<a name="l00327"></a>00327     <span class="keywordtype">long</span> extra_max;
<a name="l00328"></a>00328     <span class="keywordtype">char</span> *p;
<a name="l00329"></a>00329     <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     <a class="code" href="../../dc/dac/io_8h.html#a6b4f0c0735ecb278abd3f63059b5fc48">rb_io_check_closed</a>(fptr);
<a name="l00332"></a>00332     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> == 0 || fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a7bba3fe65c0f4b33d346273792dddade">FMODE_DUPLEX</a>) {
<a name="l00333"></a>00333         <span class="keywordflow">return</span>;
<a name="l00334"></a>00334     }
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0;
<a name="l00337"></a>00337     <span class="keywordflow">if</span> (!<a class="code" href="../../dc/db1/win32_8h.html#a19b8f86a8d75136012efa0bec39a169d">rb_w32_fd_is_text</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>)) {
<a name="l00338"></a>00338         r = lseek(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, -fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>, <a class="code" href="../../df/d0a/io_8c.html#a4c8d0b76b470ba65a43ca46a88320f39">SEEK_CUR</a>);
<a name="l00339"></a>00339         <span class="keywordflow">if</span> (r &lt; 0 &amp;&amp; <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l00340"></a>00340             <span class="keywordflow">if</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ESPIPE)
<a name="l00341"></a>00341                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> |= <a class="code" href="../../dc/dac/io_8h.html#a7bba3fe65c0f4b33d346273792dddade">FMODE_DUPLEX</a>;
<a name="l00342"></a>00342             <span class="keywordflow">return</span>;
<a name="l00343"></a>00343         }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = 0;
<a name="l00346"></a>00346         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> = 0;
<a name="l00347"></a>00347         <span class="keywordflow">return</span>;
<a name="l00348"></a>00348     }
<a name="l00349"></a>00349 
<a name="l00350"></a>00350     pos = lseek(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, 0, <a class="code" href="../../df/d0a/io_8c.html#a4c8d0b76b470ba65a43ca46a88320f39">SEEK_CUR</a>);
<a name="l00351"></a>00351     <span class="keywordflow">if</span> (pos &lt; 0 &amp;&amp; <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l00352"></a>00352         <span class="keywordflow">if</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ESPIPE)
<a name="l00353"></a>00353             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> |= <a class="code" href="../../dc/dac/io_8h.html#a7bba3fe65c0f4b33d346273792dddade">FMODE_DUPLEX</a>;
<a name="l00354"></a>00354         <span class="keywordflow">return</span>;
<a name="l00355"></a>00355     }
<a name="l00356"></a>00356 
<a name="l00357"></a>00357     <span class="comment">/* add extra offset for removed &apos;\r&apos; in rbuf */</span>
<a name="l00358"></a>00358     extra_max = (<a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a>)(pos - fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>);
<a name="l00359"></a>00359     p = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>;
<a name="l00360"></a>00360 
<a name="l00361"></a>00361     <span class="comment">/* if the end of rbuf is &apos;\r&apos;, rbuf doesn&apos;t have &apos;\r&apos; within rbuf.len */</span>
<a name="l00362"></a>00362     <span class="keywordflow">if</span> (*(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a> - 1) == <span class="charliteral">&apos;\r&apos;</span>) {
<a name="l00363"></a>00363         newlines++;
<a name="l00364"></a>00364     }
<a name="l00365"></a>00365 
<a name="l00366"></a>00366     <span class="keywordflow">for</span> (i = 0; i &lt; fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>; i++) {
<a name="l00367"></a>00367         <span class="keywordflow">if</span> (*p == <span class="charliteral">&apos;\n&apos;</span>) newlines++;
<a name="l00368"></a>00368         <span class="keywordflow">if</span> (extra_max == newlines) <span class="keywordflow">break</span>;
<a name="l00369"></a>00369         p++;
<a name="l00370"></a>00370     }
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     buf = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a79041aa2bc7439c11906a86f82a52eb6">ALLOC_N</a>(<span class="keywordtype">char</span>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> + newlines);
<a name="l00373"></a>00373     <span class="keywordflow">while</span> (newlines &gt;= 0) {
<a name="l00374"></a>00374         r = lseek(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, pos - fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> - newlines, <a class="code" href="../../df/d0a/io_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">SEEK_SET</a>);
<a name="l00375"></a>00375         <span class="keywordflow">if</span> (newlines == 0) <span class="keywordflow">break</span>;
<a name="l00376"></a>00376         <span class="keywordflow">if</span> (r &lt; 0) {
<a name="l00377"></a>00377             newlines--;
<a name="l00378"></a>00378             <span class="keywordflow">continue</span>;
<a name="l00379"></a>00379         }
<a name="l00380"></a>00380         read_size = _read(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, buf, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> + newlines);
<a name="l00381"></a>00381         <span class="keywordflow">if</span> (read_size &lt; 0) {
<a name="l00382"></a>00382             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(buf);
<a name="l00383"></a>00383             <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l00384"></a>00384         }
<a name="l00385"></a>00385         <span class="keywordflow">if</span> (read_size == fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>) {
<a name="l00386"></a>00386             lseek(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, r, <a class="code" href="../../df/d0a/io_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">SEEK_SET</a>);
<a name="l00387"></a>00387             <span class="keywordflow">break</span>;
<a name="l00388"></a>00388         }
<a name="l00389"></a>00389         <span class="keywordflow">else</span> {
<a name="l00390"></a>00390             newlines--;
<a name="l00391"></a>00391         }
<a name="l00392"></a>00392     }
<a name="l00393"></a>00393     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(buf);
<a name="l00394"></a>00394     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = 0;
<a name="l00395"></a>00395     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> = 0;
<a name="l00396"></a>00396     <span class="keywordflow">return</span>;
<a name="l00397"></a>00397 }
<a name="l00398"></a>00398 
<a name="l00399"></a>00399 <span class="comment">/*</span>
<a name="l00400"></a>00400 <span class="comment"> * We use io_seek to back cursor position when changing mode from text to binary,</span>
<a name="l00401"></a>00401 <span class="comment"> * but stdin and pipe cannot seek back. Stdin and pipe read should use encoding</span>
<a name="l00402"></a>00402 <span class="comment"> * conversion for working properly with mode change.</span>
<a name="l00403"></a>00403 <span class="comment"> *</span>
<a name="l00404"></a>00404 <span class="comment"> * Return previous translation mode.</span>
<a name="l00405"></a>00405 <span class="comment"> */</span>
<a name="l00406"></a>00406 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00407"></a>00407 set_binary_mode_with_seek_cur(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00408"></a>00408 {
<a name="l00409"></a>00409     <span class="keywordflow">if</span> (!<a class="code" href="../../dc/db1/win32_8h.html#a19b8f86a8d75136012efa0bec39a169d">rb_w32_fd_is_text</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>)) <span class="keywordflow">return</span> <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>;
<a name="l00410"></a>00410 
<a name="l00411"></a>00411     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> == 0 || fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a7bba3fe65c0f4b33d346273792dddade">FMODE_DUPLEX</a>) {
<a name="l00412"></a>00412         <span class="keywordflow">return</span> setmode(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>);
<a name="l00413"></a>00413     }
<a name="l00414"></a>00414     <a class="code" href="../../df/d0a/io_8c.html#a397d2b0970b7bc79aa1b7fc98503c6f5">flush_before_seek</a>(fptr);
<a name="l00415"></a>00415     <span class="keywordflow">return</span> setmode(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>);
<a name="l00416"></a>00416 }
<a name="l00417"></a>00417 <span class="preprocessor">#define SET_BINARY_MODE_WITH_SEEK_CUR(fptr) set_binary_mode_with_seek_cur(fptr)</span>
<a name="l00418"></a>00418 <span class="preprocessor"></span>
<a name="l00419"></a>00419 <span class="preprocessor">#else</span>
<a name="l00420"></a>00420 <span class="preprocessor"></span><span class="comment">/* Unix */</span>
<a name="l00421"></a><a class="code" href="../../df/d0a/io_8c.html#ab2c655110073a066c789b7e92cf7377c">00421</a> <span class="preprocessor"># define DEFAULT_TEXTMODE 0</span>
<a name="l00422"></a><a class="code" href="../../df/d0a/io_8c.html#a92621ca418c11e96d4862166f9076a73">00422</a> <span class="preprocessor"></span><span class="preprocessor">#define NEED_READCONV(fptr) ((fptr)-&gt;encs.enc2 != NULL || NEED_NEWLINE_DECORATOR_ON_READ(fptr))</span>
<a name="l00423"></a><a class="code" href="../../df/d0a/io_8c.html#a5c26bbaaf198084cc8a42b241ff53bca">00423</a> <span class="preprocessor"></span><span class="preprocessor">#define NEED_WRITECONV(fptr) (((fptr)-&gt;encs.enc != NULL &amp;&amp; (fptr)-&gt;encs.enc != rb_ascii8bit_encoding()) || NEED_NEWLINE_DECORATOR_ON_WRITE(fptr) || ((fptr)-&gt;encs.ecflags &amp; (ECONV_DECORATOR_MASK|ECONV_STATEFUL_DECORATOR_MASK)))</span>
<a name="l00424"></a><a class="code" href="../../df/d0a/io_8c.html#ace89c001caf3ebc8943c8f06c0aab552">00424</a> <span class="preprocessor"></span><span class="preprocessor">#define SET_BINARY_MODE(fptr) (void)(fptr)</span>
<a name="l00425"></a><a class="code" href="../../df/d0a/io_8c.html#abd7495bb74588d590a98112929d9010c">00425</a> <span class="preprocessor"></span><span class="preprocessor">#define NEED_NEWLINE_DECORATOR_ON_READ_CHECK(fptr) (void)(fptr)</span>
<a name="l00426"></a><a class="code" href="../../df/d0a/io_8c.html#aed67cd777d990c58045b8877ed5c65fc">00426</a> <span class="preprocessor"></span><span class="preprocessor">#define SET_UNIVERSAL_NEWLINE_DECORATOR_IF_ENC2(enc2, ecflags) ((void)(enc2), (void)(ecflags))</span>
<a name="l00427"></a><a class="code" href="../../df/d0a/io_8c.html#a325ff952c6a51577331c216377353886">00427</a> <span class="preprocessor"></span><span class="preprocessor">#define SET_BINARY_MODE_WITH_SEEK_CUR(fptr) (void)(fptr)</span>
<a name="l00428"></a>00428 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00429"></a>00429 <span class="preprocessor"></span>
<a name="l00430"></a>00430 <span class="preprocessor">#if !defined HAVE_SHUTDOWN &amp;&amp; !defined shutdown</span>
<a name="l00431"></a><a class="code" href="../../df/d0a/io_8c.html#a0db1bf6a85e45f4d6ead85a2fc43c871">00431</a> <span class="preprocessor"></span><span class="preprocessor">#define shutdown(a,b)   0</span>
<a name="l00432"></a>00432 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00433"></a>00433 <span class="preprocessor"></span>
<a name="l00434"></a>00434 <span class="preprocessor">#if defined(_WIN32)</span>
<a name="l00435"></a>00435 <span class="preprocessor"></span><span class="preprocessor">#define is_socket(fd, path)     rb_w32_is_socket(fd)</span>
<a name="l00436"></a>00436 <span class="preprocessor"></span><span class="preprocessor">#elif !defined(S_ISSOCK)</span>
<a name="l00437"></a><a class="code" href="../../df/d0a/io_8c.html#a963dc023d760a24b0e23ce29bb583732">00437</a> <span class="preprocessor"></span><span class="preprocessor">#define is_socket(fd, path)     0</span>
<a name="l00438"></a>00438 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00439"></a>00439 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00440"></a>00440 <a class="code" href="../../df/d0a/io_8c.html#a963dc023d760a24b0e23ce29bb583732">is_socket</a>(<span class="keywordtype">int</span> fd, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> path)
<a name="l00441"></a>00441 {
<a name="l00442"></a>00442     <span class="keyword">struct </span><a class="code" href="../../dc/db1/win32_8h.html#a4feaac5e1913330bded57b059061965b">stat</a> sbuf;
<a name="l00443"></a>00443     <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#a8a2cf46df7f7017617df85cdb0afdc64">fstat</a>(fd, &amp;sbuf) &lt; 0)
<a name="l00444"></a>00444         <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(path);
<a name="l00445"></a>00445     <span class="keywordflow">return</span> S_ISSOCK(sbuf.st_mode);
<a name="l00446"></a>00446 }
<a name="l00447"></a>00447 <span class="preprocessor">#endif</span>
<a name="l00448"></a>00448 <span class="preprocessor"></span>
<a name="l00449"></a>00449 <span class="keywordtype">void</span>
<a name="l00450"></a><a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">00450</a> <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>(<span class="keywordtype">void</span>)
<a name="l00451"></a>00451 {
<a name="l00452"></a>00452     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a64459141201c6d17c834b04b905a4dc5">rb_eEOFError</a>, <span class="stringliteral">&quot;end of file reached&quot;</span>);
<a name="l00453"></a>00453 }
<a name="l00454"></a>00454 
<a name="l00455"></a>00455 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00456"></a><a class="code" href="../../df/d0a/io_8c.html#a0c8786dc799d8b1b533ec3d2f8e209f5">00456</a> <a class="code" href="../../dc/dac/io_8h.html#a68e7deaa22cac98e654c80bd7fe187f4">rb_io_taint_check</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l00457"></a>00457 {
<a name="l00458"></a>00458     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a981ef70b505df85f89fba2b5c2d8b462">OBJ_UNTRUSTED</a>(io) &amp;&amp; <a class="code" href="../../d5/d9d/tcltklib_8c.html#a6f520624fabb8332dc98fd223491bf8d">rb_safe_level</a>() &gt;= 4)
<a name="l00459"></a>00459         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ae53f1d228c34c2a7715d7d39ab1a2991">rb_eSecurityError</a>, <span class="stringliteral">&quot;Insecure: operation on trusted IO&quot;</span>);
<a name="l00460"></a>00460     <a class="code" href="../../db/d2e/intern_8h.html#a372d6acb27d271ee4fc2e88c7022c485">rb_check_frozen</a>(io);
<a name="l00461"></a>00461     <span class="keywordflow">return</span> io;
<a name="l00462"></a>00462 }
<a name="l00463"></a>00463 
<a name="l00464"></a>00464 <span class="keywordtype">void</span>
<a name="l00465"></a><a class="code" href="../../df/d0a/io_8c.html#aa53ef4bbbc2eeb5417ae7a6a1b80f794">00465</a> <a class="code" href="../../dc/dac/io_8h.html#af5b8dfbd6b4a542196867145faaa35f5">rb_io_check_initialized</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00466"></a>00466 {
<a name="l00467"></a>00467     <span class="keywordflow">if</span> (!fptr) {
<a name="l00468"></a>00468         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;uninitialized stream&quot;</span>);
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470 }
<a name="l00471"></a>00471 
<a name="l00472"></a>00472 <span class="keywordtype">void</span>
<a name="l00473"></a><a class="code" href="../../df/d0a/io_8c.html#af057321e98822fc4292c144950a3ae5b">00473</a> <a class="code" href="../../dc/dac/io_8h.html#a6b4f0c0735ecb278abd3f63059b5fc48">rb_io_check_closed</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00474"></a>00474 {
<a name="l00475"></a>00475     <a class="code" href="../../dc/dac/io_8h.html#af5b8dfbd6b4a542196867145faaa35f5">rb_io_check_initialized</a>(fptr);
<a name="l00476"></a>00476     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> &lt; 0) {
<a name="l00477"></a>00477         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;closed stream&quot;</span>);
<a name="l00478"></a>00478     }
<a name="l00479"></a>00479 }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481 
<a name="l00482"></a>00482 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00483"></a><a class="code" href="../../df/d0a/io_8c.html#a146b88f22bfc5b430274d9f64aa40b42">00483</a> <a class="code" href="../../db/d2e/intern_8h.html#abc8a40f163cccdca6e3b9c0db7ed24b3">rb_io_get_io</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l00484"></a>00484 {
<a name="l00485"></a>00485     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a692c7c3caf5cdcf40d3812136f757fb5">rb_convert_type</a>(io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a>, <span class="stringliteral">&quot;IO&quot;</span>, <span class="stringliteral">&quot;to_io&quot;</span>);
<a name="l00486"></a>00486 }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00489"></a><a class="code" href="../../df/d0a/io_8c.html#ab5d27e6f0fb8f238d3ab912a34316563">00489</a> <a class="code" href="../../df/d0a/io_8c.html#ab5d27e6f0fb8f238d3ab912a34316563">rb_io_check_io</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l00490"></a>00490 {
<a name="l00491"></a>00491     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a16e59d05c8eb1641308bc1018c333cc1">rb_check_convert_type</a>(io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a>, <span class="stringliteral">&quot;IO&quot;</span>, <span class="stringliteral">&quot;to_io&quot;</span>);
<a name="l00492"></a>00492 }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00495"></a><a class="code" href="../../df/d0a/io_8c.html#ad2562db4d858dc312c9a189e8470b96a">00495</a> <a class="code" href="../../dc/dac/io_8h.html#ad2562db4d858dc312c9a189e8470b96a">rb_io_get_write_io</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l00496"></a>00496 {
<a name="l00497"></a>00497     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write_io;
<a name="l00498"></a>00498     <a class="code" href="../../dc/dac/io_8h.html#af5b8dfbd6b4a542196867145faaa35f5">rb_io_check_initialized</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(io)-&gt;fptr);
<a name="l00499"></a>00499     write_io = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(io)-&gt;fptr-&gt;tied_io_for_writing;
<a name="l00500"></a>00500     <span class="keywordflow">if</span> (write_io) {
<a name="l00501"></a>00501         <span class="keywordflow">return</span> write_io;
<a name="l00502"></a>00502     }
<a name="l00503"></a>00503     <span class="keywordflow">return</span> io;
<a name="l00504"></a>00504 }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00507"></a><a class="code" href="../../df/d0a/io_8c.html#ae2ca9d075a7f1188906d9e23ed053bf5">00507</a> <a class="code" href="../../dc/dac/io_8h.html#ae2ca9d075a7f1188906d9e23ed053bf5">rb_io_set_write_io</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> w)
<a name="l00508"></a>00508 {
<a name="l00509"></a>00509     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write_io;
<a name="l00510"></a>00510     <a class="code" href="../../dc/dac/io_8h.html#af5b8dfbd6b4a542196867145faaa35f5">rb_io_check_initialized</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(io)-&gt;fptr);
<a name="l00511"></a>00511     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(w)) {
<a name="l00512"></a>00512         w = 0;
<a name="l00513"></a>00513     }
<a name="l00514"></a>00514     <span class="keywordflow">else</span> {
<a name="l00515"></a>00515         <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(w);
<a name="l00516"></a>00516     }
<a name="l00517"></a>00517     write_io = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(io)-&gt;fptr-&gt;tied_io_for_writing;
<a name="l00518"></a>00518     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(io)-&gt;fptr-&gt;tied_io_for_writing = w;
<a name="l00519"></a>00519     <span class="keywordflow">return</span> write_io ? write_io : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00520"></a>00520 }
<a name="l00521"></a>00521 
<a name="l00522"></a>00522 <span class="comment">/*</span>
<a name="l00523"></a>00523 <span class="comment"> *  call-seq:</span>
<a name="l00524"></a>00524 <span class="comment"> *     IO.try_convert(obj)  -&gt;  io or nil</span>
<a name="l00525"></a>00525 <span class="comment"> *</span>
<a name="l00526"></a>00526 <span class="comment"> *  Try to convert &lt;i&gt;obj&lt;/i&gt; into an IO, using to_io method.</span>
<a name="l00527"></a>00527 <span class="comment"> *  Returns converted IO or nil if &lt;i&gt;obj&lt;/i&gt; cannot be converted</span>
<a name="l00528"></a>00528 <span class="comment"> *  for any reason.</span>
<a name="l00529"></a>00529 <span class="comment"> *</span>
<a name="l00530"></a>00530 <span class="comment"> *     IO.try_convert(STDOUT)     #=&gt; STDOUT</span>
<a name="l00531"></a>00531 <span class="comment"> *     IO.try_convert(&quot;STDOUT&quot;)   #=&gt; nil</span>
<a name="l00532"></a>00532 <span class="comment"> *</span>
<a name="l00533"></a>00533 <span class="comment"> *     require &apos;zlib&apos;</span>
<a name="l00534"></a>00534 <span class="comment"> *     f = open(&quot;/tmp/zz.gz&quot;)       #=&gt; #&lt;File:/tmp/zz.gz&gt;</span>
<a name="l00535"></a>00535 <span class="comment"> *     z = Zlib::GzipReader.open(f) #=&gt; #&lt;Zlib::GzipReader:0x81d8744&gt;</span>
<a name="l00536"></a>00536 <span class="comment"> *     IO.try_convert(z)            #=&gt; #&lt;File:/tmp/zz.gz&gt;</span>
<a name="l00537"></a>00537 <span class="comment"> *</span>
<a name="l00538"></a>00538 <span class="comment"> */</span>
<a name="l00539"></a>00539 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00540"></a><a class="code" href="../../df/d0a/io_8c.html#ad8f4ce5dbba3a552cba019e81f0d49e7">00540</a> <a class="code" href="../../df/d0a/io_8c.html#ad8f4ce5dbba3a552cba019e81f0d49e7">rb_io_s_try_convert</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> dummy, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l00541"></a>00541 {
<a name="l00542"></a>00542     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#ab5d27e6f0fb8f238d3ab912a34316563">rb_io_check_io</a>(io);
<a name="l00543"></a>00543 }
<a name="l00544"></a>00544 
<a name="l00545"></a>00545 <span class="preprocessor">#if !(defined(RUBY_TEST_CRLF_ENVIRONMENT) || defined(_WIN32))</span>
<a name="l00546"></a>00546 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00547"></a><a class="code" href="../../df/d0a/io_8c.html#a7649b75a0b7abd414acc585acd2d061e">00547</a> <a class="code" href="../../df/d0a/io_8c.html#a7649b75a0b7abd414acc585acd2d061e">io_unread</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00548"></a>00548 {
<a name="l00549"></a>00549     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> r;
<a name="l00550"></a>00550     <a class="code" href="../../dc/dac/io_8h.html#a6b4f0c0735ecb278abd3f63059b5fc48">rb_io_check_closed</a>(fptr);
<a name="l00551"></a>00551     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> == 0 || fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a7bba3fe65c0f4b33d346273792dddade">FMODE_DUPLEX</a>)
<a name="l00552"></a>00552         <span class="keywordflow">return</span>;
<a name="l00553"></a>00553     <span class="comment">/* xxx: target position may be negative if buffer is filled by ungetc */</span>
<a name="l00554"></a>00554     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0;
<a name="l00555"></a>00555     r = lseek(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, -fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>, <a class="code" href="../../df/d0a/io_8c.html#a4c8d0b76b470ba65a43ca46a88320f39">SEEK_CUR</a>);
<a name="l00556"></a>00556     <span class="keywordflow">if</span> (r &lt; 0 &amp;&amp; <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l00557"></a>00557         <span class="keywordflow">if</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ESPIPE)
<a name="l00558"></a>00558             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> |= <a class="code" href="../../dc/dac/io_8h.html#a7bba3fe65c0f4b33d346273792dddade">FMODE_DUPLEX</a>;
<a name="l00559"></a>00559         <span class="keywordflow">return</span>;
<a name="l00560"></a>00560     }
<a name="l00561"></a>00561     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = 0;
<a name="l00562"></a>00562     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> = 0;
<a name="l00563"></a>00563     <span class="keywordflow">return</span>;
<a name="l00564"></a>00564 }
<a name="l00565"></a>00565 <span class="preprocessor">#endif</span>
<a name="l00566"></a>00566 <span class="preprocessor"></span>
<a name="l00567"></a>00567 <span class="keyword">static</span> <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *<a class="code" href="../../df/d0a/io_8c.html#a56707d1971eaab5e4af7a598c630466c">io_input_encoding</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr);
<a name="l00568"></a>00568 
<a name="l00569"></a>00569 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00570"></a><a class="code" href="../../df/d0a/io_8c.html#a9a3bd2eccbe1a9fbb124dac6a1eca2ed">00570</a> <a class="code" href="../../df/d0a/io_8c.html#a9a3bd2eccbe1a9fbb124dac6a1eca2ed">io_ungetbyte</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00571"></a>00571 {
<a name="l00572"></a>00572     <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str);
<a name="l00573"></a>00573 
<a name="l00574"></a>00574     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l00575"></a>00575         <span class="keyword">const</span> <span class="keywordtype">int</span> min_capa = <a class="code" href="../../df/d0a/io_8c.html#ab6a00d3d101f364c9acbbae275cef69a">IO_RBUF_CAPA_FOR</a>(fptr);
<a name="l00576"></a>00576         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = 0;
<a name="l00577"></a>00577         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> = 0;
<a name="l00578"></a>00578 <span class="preprocessor">#if SIZEOF_LONG &gt; SIZEOF_INT</span>
<a name="l00579"></a>00579 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (len &gt; INT_MAX)
<a name="l00580"></a>00580             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;ungetbyte failed&quot;</span>);
<a name="l00581"></a>00581 <span class="preprocessor">#endif</span>
<a name="l00582"></a>00582 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (len &gt; min_capa)
<a name="l00583"></a>00583             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a> = (int)len;
<a name="l00584"></a>00584         <span class="keywordflow">else</span>
<a name="l00585"></a>00585             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a> = min_capa;
<a name="l00586"></a>00586         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a79041aa2bc7439c11906a86f82a52eb6">ALLOC_N</a>(<span class="keywordtype">char</span>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>);
<a name="l00587"></a>00587     }
<a name="l00588"></a>00588     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a> &lt; len + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>) {
<a name="l00589"></a>00589         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;ungetbyte failed&quot;</span>);
<a name="l00590"></a>00590     }
<a name="l00591"></a>00591     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> &lt; len) {
<a name="l00592"></a>00592         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aad09de334c9b8c7f717d314b14679e62">MEMMOVE</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>-fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>,
<a name="l00593"></a>00593                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>,
<a name="l00594"></a>00594                 <span class="keywordtype">char</span>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>);
<a name="l00595"></a>00595         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>-fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>;
<a name="l00596"></a>00596     }
<a name="l00597"></a>00597     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>-=(int)len;
<a name="l00598"></a>00598     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>+=(int)len;
<a name="l00599"></a>00599     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aad09de334c9b8c7f717d314b14679e62">MEMMOVE</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), <span class="keywordtype">char</span>, len);
<a name="l00600"></a>00600 }
<a name="l00601"></a>00601 
<a name="l00602"></a>00602 <span class="keyword">static</span> <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *
<a name="l00603"></a><a class="code" href="../../df/d0a/io_8c.html#a397d2b0970b7bc79aa1b7fc98503c6f5">00603</a> <a class="code" href="../../df/d0a/io_8c.html#a397d2b0970b7bc79aa1b7fc98503c6f5">flush_before_seek</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00604"></a>00604 {
<a name="l00605"></a>00605     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(fptr) &lt; 0)
<a name="l00606"></a>00606         <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l00607"></a>00607     <a class="code" href="../../df/d0a/io_8c.html#a7649b75a0b7abd414acc585acd2d061e">io_unread</a>(fptr);
<a name="l00608"></a>00608     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0;
<a name="l00609"></a>00609     <span class="keywordflow">return</span> fptr;
<a name="l00610"></a>00610 }
<a name="l00611"></a>00611 
<a name="l00612"></a><a class="code" href="../../df/d0a/io_8c.html#a08a06c385029a1ebff645c082bf5b839">00612</a> <span class="preprocessor">#define io_seek(fptr, ofs, whence) (errno = 0, lseek(flush_before_seek(fptr)-&gt;fd, (ofs), (whence)))</span>
<a name="l00613"></a><a class="code" href="../../df/d0a/io_8c.html#a05eb5776a3cfb91c2636c607be1ba1e4">00613</a> <span class="preprocessor"></span><span class="preprocessor">#define io_tell(fptr) lseek(flush_before_seek(fptr)-&gt;fd, 0, SEEK_CUR)</span>
<a name="l00614"></a>00614 <span class="preprocessor"></span>
<a name="l00615"></a>00615 <span class="preprocessor">#ifndef SEEK_CUR</span>
<a name="l00616"></a><a class="code" href="../../df/d0a/io_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">00616</a> <span class="preprocessor"></span><span class="preprocessor"># define SEEK_SET 0</span>
<a name="l00617"></a><a class="code" href="../../df/d0a/io_8c.html#a4c8d0b76b470ba65a43ca46a88320f39">00617</a> <span class="preprocessor"></span><span class="preprocessor"># define SEEK_CUR 1</span>
<a name="l00618"></a><a class="code" href="../../df/d0a/io_8c.html#ad2a2e6c114780c3071efd24f16c7f7d8">00618</a> <span class="preprocessor"></span><span class="preprocessor"># define SEEK_END 2</span>
<a name="l00619"></a>00619 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00620"></a>00620 <span class="preprocessor"></span>
<a name="l00621"></a><a class="code" href="../../df/d0a/io_8c.html#ac218baceb2acc329cd30e35b9cbd6d15">00621</a> <span class="preprocessor">#define FMODE_SYNCWRITE (FMODE_SYNC|FMODE_WRITABLE)</span>
<a name="l00622"></a>00622 <span class="preprocessor"></span>
<a name="l00623"></a>00623 <span class="keywordtype">void</span>
<a name="l00624"></a><a class="code" href="../../df/d0a/io_8c.html#acbd19ff86a565ed9e9f15e4f49736f3d">00624</a> <a class="code" href="../../dc/dac/io_8h.html#acbd19ff86a565ed9e9f15e4f49736f3d">rb_io_check_char_readable</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00625"></a>00625 {
<a name="l00626"></a>00626     <a class="code" href="../../dc/dac/io_8h.html#a6b4f0c0735ecb278abd3f63059b5fc48">rb_io_check_closed</a>(fptr);
<a name="l00627"></a>00627     <span class="keywordflow">if</span> (!(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>)) {
<a name="l00628"></a>00628         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;not opened for reading&quot;</span>);
<a name="l00629"></a>00629     }
<a name="l00630"></a>00630     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>) {
<a name="l00631"></a>00631         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(fptr) &lt; 0)
<a name="l00632"></a>00632             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l00633"></a>00633     }
<a name="l00634"></a>00634     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ad4507dbb812bff2064ead59f235039c2">tied_io_for_writing</a>) {
<a name="l00635"></a>00635         <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *wfptr;
<a name="l00636"></a>00636         <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ad4507dbb812bff2064ead59f235039c2">tied_io_for_writing</a>, wfptr);
<a name="l00637"></a>00637         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(wfptr) &lt; 0)
<a name="l00638"></a>00638             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l00639"></a>00639     }
<a name="l00640"></a>00640 }
<a name="l00641"></a>00641 
<a name="l00642"></a>00642 <span class="keywordtype">void</span>
<a name="l00643"></a><a class="code" href="../../df/d0a/io_8c.html#a38b3a618992ee85d5510dc70db4e2b36">00643</a> <a class="code" href="../../dc/dac/io_8h.html#a38b3a618992ee85d5510dc70db4e2b36">rb_io_check_byte_readable</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00644"></a>00644 {
<a name="l00645"></a>00645     <a class="code" href="../../dc/dac/io_8h.html#acbd19ff86a565ed9e9f15e4f49736f3d">rb_io_check_char_readable</a>(fptr);
<a name="l00646"></a>00646     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#aa0377d67a404cdeebc3ad2ceab0ef054">READ_CHAR_PENDING</a>(fptr)) {
<a name="l00647"></a>00647         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;byte oriented read for character buffered IO&quot;</span>);
<a name="l00648"></a>00648     }
<a name="l00649"></a>00649 }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 <span class="keywordtype">void</span>
<a name="l00652"></a><a class="code" href="../../df/d0a/io_8c.html#a478c704343f014b0942385b391f2d05f">00652</a> <a class="code" href="../../dc/dac/io_8h.html#a8557569435da7f8a669908723fcd5e94">rb_io_check_readable</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00653"></a>00653 {
<a name="l00654"></a>00654     <a class="code" href="../../dc/dac/io_8h.html#a38b3a618992ee85d5510dc70db4e2b36">rb_io_check_byte_readable</a>(fptr);
<a name="l00655"></a>00655 }
<a name="l00656"></a>00656 
<a name="l00657"></a>00657 <span class="keyword">static</span> <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a>*
<a name="l00658"></a><a class="code" href="../../df/d0a/io_8c.html#aa3b568197b019bda6a9aea4fbe2153eb">00658</a> <a class="code" href="../../df/d0a/io_8c.html#aa3b568197b019bda6a9aea4fbe2153eb">io_read_encoding</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00659"></a>00659 {
<a name="l00660"></a>00660     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc) {
<a name="l00661"></a>00661         <span class="keywordflow">return</span> fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc;
<a name="l00662"></a>00662     }
<a name="l00663"></a>00663     <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#a0724183879562529f7d3365ef5115b6d">rb_default_external_encoding</a>();
<a name="l00664"></a>00664 }
<a name="l00665"></a>00665 
<a name="l00666"></a>00666 <span class="keyword">static</span> <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a>*
<a name="l00667"></a><a class="code" href="../../df/d0a/io_8c.html#a56707d1971eaab5e4af7a598c630466c">00667</a> <a class="code" href="../../df/d0a/io_8c.html#a56707d1971eaab5e4af7a598c630466c">io_input_encoding</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00668"></a>00668 {
<a name="l00669"></a>00669     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc2) {
<a name="l00670"></a>00670         <span class="keywordflow">return</span> fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc2;
<a name="l00671"></a>00671     }
<a name="l00672"></a>00672     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#aa3b568197b019bda6a9aea4fbe2153eb">io_read_encoding</a>(fptr);
<a name="l00673"></a>00673 }
<a name="l00674"></a>00674 
<a name="l00675"></a>00675 <span class="keywordtype">void</span>
<a name="l00676"></a><a class="code" href="../../df/d0a/io_8c.html#ae740d025f4e23fcfc005d1dec966314a">00676</a> <a class="code" href="../../dc/dac/io_8h.html#a728977df67c656197402bb30a14af953">rb_io_check_writable</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00677"></a>00677 {
<a name="l00678"></a>00678     <a class="code" href="../../dc/dac/io_8h.html#a6b4f0c0735ecb278abd3f63059b5fc48">rb_io_check_closed</a>(fptr);
<a name="l00679"></a>00679     <span class="keywordflow">if</span> (!(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>)) {
<a name="l00680"></a>00680         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;not opened for writing&quot;</span>);
<a name="l00681"></a>00681     }
<a name="l00682"></a>00682     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>) {
<a name="l00683"></a>00683         <a class="code" href="../../df/d0a/io_8c.html#a7649b75a0b7abd414acc585acd2d061e">io_unread</a>(fptr);
<a name="l00684"></a>00684     }
<a name="l00685"></a>00685 }
<a name="l00686"></a>00686 
<a name="l00687"></a>00687 <span class="keywordtype">int</span>
<a name="l00688"></a><a class="code" href="../../df/d0a/io_8c.html#acfa662fa1d29f732a8d9a4ba7ca3754e">00688</a> <a class="code" href="../../dc/dac/io_8h.html#a88e47151779c6afecd2b4a13956d80c9">rb_io_read_pending</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00689"></a>00689 {
<a name="l00690"></a>00690     <span class="comment">/* This function is used for bytes and chars.  Confusing. */</span>
<a name="l00691"></a>00691     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#aa0377d67a404cdeebc3ad2ceab0ef054">READ_CHAR_PENDING</a>(fptr))
<a name="l00692"></a>00692         <span class="keywordflow">return</span> 1; <span class="comment">/* should raise? */</span>
<a name="l00693"></a>00693     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a38357513887e9cae9c0b4a5dc0d4007e">READ_DATA_PENDING</a>(fptr);
<a name="l00694"></a>00694 }
<a name="l00695"></a>00695 
<a name="l00696"></a>00696 <span class="keywordtype">void</span>
<a name="l00697"></a><a class="code" href="../../df/d0a/io_8c.html#ad3eba03cd96f7d2b91cd9142ff437ace">00697</a> <a class="code" href="../../df/d0a/io_8c.html#ad3eba03cd96f7d2b91cd9142ff437ace">rb_read_check</a>(<a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *fp)
<a name="l00698"></a>00698 {
<a name="l00699"></a>00699     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#af45f8af95b6c427f54933f445991fab7">STDIO_READ_DATA_PENDING</a>(fp)) {
<a name="l00700"></a>00700         <a class="code" href="../../db/d2e/intern_8h.html#a38e5ff660fd6c045c7242de575e8a5f2">rb_thread_wait_fd</a>(<a class="code" href="../../da/d50/vsnprintf_8c.html#a7aa82a32f4ad97a0107302dae80a2b1e">fileno</a>(fp));
<a name="l00701"></a>00701     }
<a name="l00702"></a>00702 }
<a name="l00703"></a>00703 
<a name="l00704"></a>00704 <span class="keywordtype">void</span>
<a name="l00705"></a><a class="code" href="../../df/d0a/io_8c.html#a1725658b2967f025460717c0d6b45df4">00705</a> <a class="code" href="../../dc/dac/io_8h.html#ac54adfb185a404954c702527ee9063af">rb_io_read_check</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00706"></a>00706 {
<a name="l00707"></a>00707     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a38357513887e9cae9c0b4a5dc0d4007e">READ_DATA_PENDING</a>(fptr)) {
<a name="l00708"></a>00708         <a class="code" href="../../db/d2e/intern_8h.html#a38e5ff660fd6c045c7242de575e8a5f2">rb_thread_wait_fd</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>);
<a name="l00709"></a>00709     }
<a name="l00710"></a>00710     <span class="keywordflow">return</span>;
<a name="l00711"></a>00711 }
<a name="l00712"></a>00712 
<a name="l00713"></a>00713 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00714"></a><a class="code" href="../../df/d0a/io_8c.html#a7c54baedd5063c5e77dd110a969fe844">00714</a> <a class="code" href="../../df/d0a/io_8c.html#a7c54baedd5063c5e77dd110a969fe844">ruby_dup</a>(<span class="keywordtype">int</span> orig)
<a name="l00715"></a>00715 {
<a name="l00716"></a>00716     <span class="keywordtype">int</span> fd;
<a name="l00717"></a>00717 
<a name="l00718"></a>00718     fd = dup(orig);
<a name="l00719"></a>00719     <span class="keywordflow">if</span> (fd &lt; 0) {
<a name="l00720"></a>00720         <span class="keywordflow">if</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EMFILE || <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ENFILE || <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ENOMEM) {
<a name="l00721"></a>00721             <a class="code" href="../../d8/d16/gc_8c.html#a7a12ca86b76e272a301173e7661acfea">rb_gc</a>();
<a name="l00722"></a>00722             fd = dup(orig);
<a name="l00723"></a>00723         }
<a name="l00724"></a>00724         <span class="keywordflow">if</span> (fd &lt; 0) {
<a name="l00725"></a>00725             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l00726"></a>00726         }
<a name="l00727"></a>00727     }
<a name="l00728"></a>00728     <a class="code" href="../../db/d2e/intern_8h.html#a6448f20b0936afe0cb85ab3186753db2">rb_update_max_fd</a>(fd);
<a name="l00729"></a>00729     <span class="keywordflow">return</span> fd;
<a name="l00730"></a>00730 }
<a name="l00731"></a>00731 
<a name="l00732"></a>00732 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00733"></a><a class="code" href="../../df/d0a/io_8c.html#a47f57cf9a8f65858e5cfe7ed56cc65bb">00733</a> <a class="code" href="../../df/d0a/io_8c.html#a47f57cf9a8f65858e5cfe7ed56cc65bb">io_alloc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass)
<a name="l00734"></a>00734 {
<a name="l00735"></a>00735     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ab8e75ef1f427d9b009705ebd577bee92">NEWOBJ</a>(io, <span class="keyword">struct</span> <a class="code" href="../../de/d5d/struct_r_file.html">RFile</a>);
<a name="l00736"></a>00736     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a607a9da5249e026d1c4a0826dc840143">OBJSETUP</a>(io, klass, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a>);
<a name="l00737"></a>00737 
<a name="l00738"></a>00738     io-&gt;fptr = 0;
<a name="l00739"></a>00739 
<a name="l00740"></a>00740     <span class="keywordflow">return</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)io;
<a name="l00741"></a>00741 }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743 <span class="preprocessor">#ifndef S_ISREG</span>
<a name="l00744"></a>00744 <span class="preprocessor"></span><span class="preprocessor">#   define S_ISREG(m) (((m) &amp; S_IFMT) == S_IFREG)</span>
<a name="l00745"></a>00745 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00746"></a>00746 <span class="preprocessor"></span>
<a name="l00747"></a>00747 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00748"></a><a class="code" href="../../df/d0a/io_8c.html#ae75a57ca6c3555397511ddc39f87db8a">00748</a> <a class="code" href="../../df/d0a/io_8c.html#ae75a57ca6c3555397511ddc39f87db8a">wsplit_p</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00749"></a>00749 {
<a name="l00750"></a>00750 <span class="preprocessor">#if defined(HAVE_FCNTL) &amp;&amp; defined(F_GETFL) &amp;&amp; defined(O_NONBLOCK)</span>
<a name="l00751"></a>00751 <span class="preprocessor"></span>    <span class="keywordtype">int</span> r;
<a name="l00752"></a>00752 <span class="preprocessor">#endif</span>
<a name="l00753"></a>00753 <span class="preprocessor"></span>
<a name="l00754"></a>00754     <span class="keywordflow">if</span> (!(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a549273c107e35c00c202299a498bd758">FMODE_WSPLIT_INITIALIZED</a>)) {
<a name="l00755"></a>00755         <span class="keyword">struct </span><a class="code" href="../../dc/db1/win32_8h.html#a4feaac5e1913330bded57b059061965b">stat</a> buf;
<a name="l00756"></a>00756         <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#a8a2cf46df7f7017617df85cdb0afdc64">fstat</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, &amp;buf) == 0 &amp;&amp;
<a name="l00757"></a>00757             !<a class="code" href="../../d6/d13/file_8c.html#abf68371159fa46b5cc47d0f3ac9ab723">S_ISREG</a>(buf.st_mode)
<a name="l00758"></a>00758 #<span class="keywordflow">if</span> defined(HAVE_FCNTL) &amp;&amp; defined(F_GETFL) &amp;&amp; defined(<a class="code" href="../../dc/db1/win32_8h.html#a39d33ce33804efd4d52606d59071c6d8">O_NONBLOCK</a>)
<a name="l00759"></a>00759             &amp;&amp; (r = <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, F_GETFL)) != -1 &amp;&amp;
<a name="l00760"></a>00760             !(r &amp; <a class="code" href="../../dc/db1/win32_8h.html#a39d33ce33804efd4d52606d59071c6d8">O_NONBLOCK</a>)
<a name="l00761"></a>00761 #endif
<a name="l00762"></a>00762             ) {
<a name="l00763"></a>00763             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> |= <a class="code" href="../../dc/dac/io_8h.html#ac4bc328ba5e87fac5381cf7b4afa7153">FMODE_WSPLIT</a>;
<a name="l00764"></a>00764         }
<a name="l00765"></a>00765         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> |= <a class="code" href="../../dc/dac/io_8h.html#a549273c107e35c00c202299a498bd758">FMODE_WSPLIT_INITIALIZED</a>;
<a name="l00766"></a>00766     }
<a name="l00767"></a>00767     <span class="keywordflow">return</span> fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#ac4bc328ba5e87fac5381cf7b4afa7153">FMODE_WSPLIT</a>;
<a name="l00768"></a>00768 }
<a name="l00769"></a>00769 
<a name="l00770"></a><a class="code" href="../../d4/d06/structio__internal__read__struct.html">00770</a> <span class="keyword">struct </span><a class="code" href="../../d4/d06/structio__internal__read__struct.html">io_internal_read_struct</a> {
<a name="l00771"></a><a class="code" href="../../d4/d06/structio__internal__read__struct.html#a4691cf8ad18f7e1efefa1b98a4172332">00771</a>     <span class="keywordtype">int</span> <a class="code" href="../../d4/d06/structio__internal__read__struct.html#a4691cf8ad18f7e1efefa1b98a4172332">fd</a>;
<a name="l00772"></a><a class="code" href="../../d4/d06/structio__internal__read__struct.html#ae74ddc0b42cd3cdb06776b56dd78050e">00772</a>     <span class="keywordtype">void</span> *<a class="code" href="../../d4/d06/structio__internal__read__struct.html#ae74ddc0b42cd3cdb06776b56dd78050e">buf</a>;
<a name="l00773"></a><a class="code" href="../../d4/d06/structio__internal__read__struct.html#a568dec00b736c811c8ddd87b60f627a8">00773</a>     <span class="keywordtype">size_t</span> <a class="code" href="../../d4/d06/structio__internal__read__struct.html#a568dec00b736c811c8ddd87b60f627a8">capa</a>;
<a name="l00774"></a>00774 };
<a name="l00775"></a>00775 
<a name="l00776"></a><a class="code" href="../../db/d16/structio__internal__write__struct.html">00776</a> <span class="keyword">struct </span><a class="code" href="../../db/d16/structio__internal__write__struct.html">io_internal_write_struct</a> {
<a name="l00777"></a><a class="code" href="../../db/d16/structio__internal__write__struct.html#a01a5c3f887dc57a6e511b12a30b6378c">00777</a>     <span class="keywordtype">int</span> <a class="code" href="../../db/d16/structio__internal__write__struct.html#a01a5c3f887dc57a6e511b12a30b6378c">fd</a>;
<a name="l00778"></a><a class="code" href="../../db/d16/structio__internal__write__struct.html#aad4aeafd01f5130e60733f195a5de7c4">00778</a>     <span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="../../db/d16/structio__internal__write__struct.html#aad4aeafd01f5130e60733f195a5de7c4">buf</a>;
<a name="l00779"></a><a class="code" href="../../db/d16/structio__internal__write__struct.html#a61cc3d9b7910a8bb64f186147ad2f8d6">00779</a>     <span class="keywordtype">size_t</span> <a class="code" href="../../db/d16/structio__internal__write__struct.html#a61cc3d9b7910a8bb64f186147ad2f8d6">capa</a>;
<a name="l00780"></a>00780 };
<a name="l00781"></a>00781 
<a name="l00782"></a>00782 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00783"></a><a class="code" href="../../df/d0a/io_8c.html#a8d908ccb6c753234c516a9ae80b1d351">00783</a> <a class="code" href="../../df/d0a/io_8c.html#a8d908ccb6c753234c516a9ae80b1d351">internal_read_func</a>(<span class="keywordtype">void</span> *ptr)
<a name="l00784"></a>00784 {
<a name="l00785"></a>00785     <span class="keyword">struct </span><a class="code" href="../../d4/d06/structio__internal__read__struct.html">io_internal_read_struct</a> *iis = ptr;
<a name="l00786"></a>00786     <span class="keywordflow">return</span> read(iis-&gt;<a class="code" href="../../d4/d06/structio__internal__read__struct.html#a4691cf8ad18f7e1efefa1b98a4172332">fd</a>, iis-&gt;<a class="code" href="../../d4/d06/structio__internal__read__struct.html#ae74ddc0b42cd3cdb06776b56dd78050e">buf</a>, iis-&gt;<a class="code" href="../../d4/d06/structio__internal__read__struct.html#a568dec00b736c811c8ddd87b60f627a8">capa</a>);
<a name="l00787"></a>00787 }
<a name="l00788"></a>00788 
<a name="l00789"></a>00789 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00790"></a><a class="code" href="../../df/d0a/io_8c.html#abbb706f58fffa5be74a5ba5c694120b1">00790</a> <a class="code" href="../../df/d0a/io_8c.html#abbb706f58fffa5be74a5ba5c694120b1">internal_write_func</a>(<span class="keywordtype">void</span> *ptr)
<a name="l00791"></a>00791 {
<a name="l00792"></a>00792     <span class="keyword">struct </span><a class="code" href="../../db/d16/structio__internal__write__struct.html">io_internal_write_struct</a> *iis = ptr;
<a name="l00793"></a>00793     <span class="keywordflow">return</span> write(iis-&gt;<a class="code" href="../../db/d16/structio__internal__write__struct.html#a01a5c3f887dc57a6e511b12a30b6378c">fd</a>, iis-&gt;<a class="code" href="../../db/d16/structio__internal__write__struct.html#aad4aeafd01f5130e60733f195a5de7c4">buf</a>, iis-&gt;<a class="code" href="../../db/d16/structio__internal__write__struct.html#a61cc3d9b7910a8bb64f186147ad2f8d6">capa</a>);
<a name="l00794"></a>00794 }
<a name="l00795"></a>00795 
<a name="l00796"></a>00796 <span class="keyword">static</span> ssize_t
<a name="l00797"></a><a class="code" href="../../df/d0a/io_8c.html#aa992ea0a36c7c173ae889134907d2b22">00797</a> <a class="code" href="../../df/d0a/io_8c.html#aa992ea0a36c7c173ae889134907d2b22">rb_read_internal</a>(<span class="keywordtype">int</span> <a class="code" href="../../db/d16/structio__internal__write__struct.html#a01a5c3f887dc57a6e511b12a30b6378c">fd</a>, <span class="keywordtype">void</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>)
<a name="l00798"></a>00798 {
<a name="l00799"></a>00799     <span class="keyword">struct </span><a class="code" href="../../d4/d06/structio__internal__read__struct.html">io_internal_read_struct</a> iis;
<a name="l00800"></a>00800     iis.<a class="code" href="../../d4/d06/structio__internal__read__struct.html#a4691cf8ad18f7e1efefa1b98a4172332">fd</a> = fd;
<a name="l00801"></a>00801     iis.<a class="code" href="../../d4/d06/structio__internal__read__struct.html#ae74ddc0b42cd3cdb06776b56dd78050e">buf</a> = buf;
<a name="l00802"></a>00802     iis.<a class="code" href="../../d4/d06/structio__internal__read__struct.html#a568dec00b736c811c8ddd87b60f627a8">capa</a> = count;
<a name="l00803"></a>00803 
<a name="l00804"></a>00804     <span class="keywordflow">return</span> (ssize_t)<a class="code" href="../../d3/de7/thread_8c.html#af541b78962a7376bf184693fc4144441">rb_thread_io_blocking_region</a>(<a class="code" href="../../df/d0a/io_8c.html#a8d908ccb6c753234c516a9ae80b1d351">internal_read_func</a>, &amp;iis, fd);
<a name="l00805"></a>00805 }
<a name="l00806"></a>00806 
<a name="l00807"></a>00807 <span class="keyword">static</span> ssize_t
<a name="l00808"></a><a class="code" href="../../df/d0a/io_8c.html#ac7a460cb9d941a9c2f160f52b35b5948">00808</a> <a class="code" href="../../df/d0a/io_8c.html#ac7a460cb9d941a9c2f160f52b35b5948">rb_write_internal</a>(<span class="keywordtype">int</span> <a class="code" href="../../d4/d06/structio__internal__read__struct.html#a4691cf8ad18f7e1efefa1b98a4172332">fd</a>, <span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>)
<a name="l00809"></a>00809 {
<a name="l00810"></a>00810     <span class="keyword">struct </span><a class="code" href="../../db/d16/structio__internal__write__struct.html">io_internal_write_struct</a> iis;
<a name="l00811"></a>00811     iis.<a class="code" href="../../db/d16/structio__internal__write__struct.html#a01a5c3f887dc57a6e511b12a30b6378c">fd</a> = fd;
<a name="l00812"></a>00812     iis.<a class="code" href="../../db/d16/structio__internal__write__struct.html#aad4aeafd01f5130e60733f195a5de7c4">buf</a> = buf;
<a name="l00813"></a>00813     iis.<a class="code" href="../../db/d16/structio__internal__write__struct.html#a61cc3d9b7910a8bb64f186147ad2f8d6">capa</a> = count;
<a name="l00814"></a>00814 
<a name="l00815"></a>00815     <span class="keywordflow">return</span> (ssize_t)<a class="code" href="../../d3/de7/thread_8c.html#af541b78962a7376bf184693fc4144441">rb_thread_io_blocking_region</a>(<a class="code" href="../../df/d0a/io_8c.html#abbb706f58fffa5be74a5ba5c694120b1">internal_write_func</a>, &amp;iis, fd);
<a name="l00816"></a>00816 }
<a name="l00817"></a>00817 
<a name="l00818"></a>00818 <span class="keyword">static</span> <span class="keywordtype">long</span>
<a name="l00819"></a><a class="code" href="../../df/d0a/io_8c.html#a7168879fc6c59c3a7d2cd1d7110d18a1">00819</a> <a class="code" href="../../df/d0a/io_8c.html#a7168879fc6c59c3a7d2cd1d7110d18a1">io_writable_length</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <span class="keywordtype">long</span> l)
<a name="l00820"></a>00820 {
<a name="l00821"></a>00821     <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#ad2c1c798d36bdba42d5f4d50da5ae200">PIPE_BUF</a> &lt; l &amp;&amp;
<a name="l00822"></a>00822         !<a class="code" href="../../db/d2e/intern_8h.html#ac86131edba4a5a668958ce58b661d7ee">rb_thread_alone</a>() &amp;&amp;
<a name="l00823"></a>00823         <a class="code" href="../../df/d0a/io_8c.html#ae75a57ca6c3555397511ddc39f87db8a">wsplit_p</a>(fptr)) {
<a name="l00824"></a>00824         l = <a class="code" href="../../dc/db1/win32_8h.html#ad2c1c798d36bdba42d5f4d50da5ae200">PIPE_BUF</a>;
<a name="l00825"></a>00825     }
<a name="l00826"></a>00826     <span class="keywordflow">return</span> l;
<a name="l00827"></a>00827 }
<a name="l00828"></a>00828 
<a name="l00829"></a>00829 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00830"></a><a class="code" href="../../df/d0a/io_8c.html#abb3882e4a3efa9a701ef4e6b9f431de4">00830</a> <a class="code" href="../../df/d0a/io_8c.html#abb3882e4a3efa9a701ef4e6b9f431de4">io_flush_buffer_sync</a>(<span class="keywordtype">void</span> *arg)
<a name="l00831"></a>00831 {
<a name="l00832"></a>00832     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr = arg;
<a name="l00833"></a>00833     <span class="keywordtype">long</span> l = <a class="code" href="../../df/d0a/io_8c.html#a7168879fc6c59c3a7d2cd1d7110d18a1">io_writable_length</a>(fptr, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>);
<a name="l00834"></a>00834     ssize_t r = write(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, (<span class="keywordtype">size_t</span>)l);
<a name="l00835"></a>00835 
<a name="l00836"></a>00836     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> &lt;= r) {
<a name="l00837"></a>00837         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = 0;
<a name="l00838"></a>00838         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> = 0;
<a name="l00839"></a>00839         <span class="keywordflow">return</span> 0;
<a name="l00840"></a>00840     }
<a name="l00841"></a>00841     <span class="keywordflow">if</span> (0 &lt;= r) {
<a name="l00842"></a>00842         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> += (int)r;
<a name="l00843"></a>00843         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> -= (int)r;
<a name="l00844"></a>00844         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EAGAIN;
<a name="l00845"></a>00845     }
<a name="l00846"></a>00846     <span class="keywordflow">return</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)-1;
<a name="l00847"></a>00847 }
<a name="l00848"></a>00848 
<a name="l00849"></a>00849 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00850"></a><a class="code" href="../../df/d0a/io_8c.html#a8f81d2de3f6e837a83f958e93b24df8d">00850</a> <a class="code" href="../../df/d0a/io_8c.html#a8f81d2de3f6e837a83f958e93b24df8d">io_flush_buffer_async</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l00851"></a>00851 {
<a name="l00852"></a>00852     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr = (<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *)arg;
<a name="l00853"></a>00853     <span class="keywordflow">return</span> <a class="code" href="../../d3/de7/thread_8c.html#af541b78962a7376bf184693fc4144441">rb_thread_io_blocking_region</a>(<a class="code" href="../../df/d0a/io_8c.html#abb3882e4a3efa9a701ef4e6b9f431de4">io_flush_buffer_sync</a>, fptr, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>);
<a name="l00854"></a>00854 }
<a name="l00855"></a>00855 
<a name="l00856"></a>00856 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l00857"></a><a class="code" href="../../df/d0a/io_8c.html#a791c9689bd39da452494266f2fd2d48f">00857</a> <a class="code" href="../../df/d0a/io_8c.html#a791c9689bd39da452494266f2fd2d48f">io_flush_buffer</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00858"></a>00858 {
<a name="l00859"></a>00859     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ab6eade210f169f0a929e1381cbef947d">write_lock</a>) {
<a name="l00860"></a>00860         <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)<a class="code" href="../../db/d2e/intern_8h.html#a67eed485066a22a165646aa1fcce93bf">rb_mutex_synchronize</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ab6eade210f169f0a929e1381cbef947d">write_lock</a>, <a class="code" href="../../df/d0a/io_8c.html#a8f81d2de3f6e837a83f958e93b24df8d">io_flush_buffer_async</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)fptr);
<a name="l00861"></a>00861     }
<a name="l00862"></a>00862     <span class="keywordflow">else</span> {
<a name="l00863"></a>00863         <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)<a class="code" href="../../df/d0a/io_8c.html#a8f81d2de3f6e837a83f958e93b24df8d">io_flush_buffer_async</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)fptr);
<a name="l00864"></a>00864     }
<a name="l00865"></a>00865 }
<a name="l00866"></a>00866 
<a name="l00867"></a>00867 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00868"></a><a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">00868</a> <a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00869"></a>00869 {
<a name="l00870"></a>00870     <a class="code" href="../../dc/dac/io_8h.html#a6b4f0c0735ecb278abd3f63059b5fc48">rb_io_check_closed</a>(fptr);
<a name="l00871"></a>00871     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> == 0)
<a name="l00872"></a>00872         <span class="keywordflow">return</span> 0;
<a name="l00873"></a>00873     <span class="keywordflow">if</span> (!<a class="code" href="../../db/d2e/intern_8h.html#ab9654ba3f4c47d18a77ebc22b5b4c356">rb_thread_fd_writable</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>)) {
<a name="l00874"></a>00874         <a class="code" href="../../dc/dac/io_8h.html#a6b4f0c0735ecb278abd3f63059b5fc48">rb_io_check_closed</a>(fptr);
<a name="l00875"></a>00875     }
<a name="l00876"></a>00876     <span class="keywordflow">while</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> &gt; 0 &amp;&amp; <a class="code" href="../../df/d0a/io_8c.html#a791c9689bd39da452494266f2fd2d48f">io_flush_buffer</a>(fptr) != 0) {
<a name="l00877"></a>00877         <span class="keywordflow">if</span> (!<a class="code" href="../../dc/dac/io_8h.html#af28a170d3ffb07353653f832d95c6ba6">rb_io_wait_writable</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>))
<a name="l00878"></a>00878             <span class="keywordflow">return</span> -1;
<a name="l00879"></a>00879         <a class="code" href="../../dc/dac/io_8h.html#a6b4f0c0735ecb278abd3f63059b5fc48">rb_io_check_closed</a>(fptr);
<a name="l00880"></a>00880     }
<a name="l00881"></a>00881     <span class="keywordflow">return</span> 0;
<a name="l00882"></a>00882 }
<a name="l00883"></a>00883 
<a name="l00884"></a>00884 <span class="keywordtype">int</span>
<a name="l00885"></a><a class="code" href="../../df/d0a/io_8c.html#a2e1e6b4076d9a2fb3fb670451474f418">00885</a> <a class="code" href="../../dc/dac/io_8h.html#aef370f8ba67623893a3b559bf27b30e3">rb_io_wait_readable</a>(<span class="keywordtype">int</span> f)
<a name="l00886"></a>00886 {
<a name="l00887"></a>00887     <span class="keywordflow">if</span> (f &lt; 0) {
<a name="l00888"></a>00888         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;closed stream&quot;</span>);
<a name="l00889"></a>00889     }
<a name="l00890"></a>00890     <span class="keywordflow">switch</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l00891"></a>00891       <span class="keywordflow">case</span> EINTR:
<a name="l00892"></a>00892 <span class="preprocessor">#if defined(ERESTART)</span>
<a name="l00893"></a>00893 <span class="preprocessor"></span>      <span class="keywordflow">case</span> ERESTART:
<a name="l00894"></a>00894 <span class="preprocessor">#endif</span>
<a name="l00895"></a>00895 <span class="preprocessor"></span>        <a class="code" href="../../db/d2e/intern_8h.html#a38e5ff660fd6c045c7242de575e8a5f2">rb_thread_wait_fd</a>(f);
<a name="l00896"></a>00896         <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00897"></a>00897 
<a name="l00898"></a>00898       <span class="keywordflow">case</span> EAGAIN:
<a name="l00899"></a>00899 <span class="preprocessor">#if defined(EWOULDBLOCK) &amp;&amp; EWOULDBLOCK != EAGAIN</span>
<a name="l00900"></a>00900 <span class="preprocessor"></span>      <span class="keywordflow">case</span> <a class="code" href="../../dd/d8c/rubysocket_8h.html#a4a3a0b3605fd3b2336455062ee8e25f0">EWOULDBLOCK</a>:
<a name="l00901"></a>00901 <span class="preprocessor">#endif</span>
<a name="l00902"></a>00902 <span class="preprocessor"></span>        <a class="code" href="../../dc/dac/io_8h.html#a5d928dd718bfee4b74deb87c1e82efd6">rb_wait_for_single_fd</a>(f, <a class="code" href="../../dc/dac/io_8h.html#a8e8bb5fe44d8006f2b4efcb8211736bb">RB_WAITFD_IN</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00903"></a>00903         <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00904"></a>00904 
<a name="l00905"></a>00905       <span class="keywordflow">default</span>:
<a name="l00906"></a>00906         <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00907"></a>00907     }
<a name="l00908"></a>00908 }
<a name="l00909"></a>00909 
<a name="l00910"></a>00910 <span class="keywordtype">int</span>
<a name="l00911"></a><a class="code" href="../../df/d0a/io_8c.html#a077ac86cddc0a5714082382487a7d6dc">00911</a> <a class="code" href="../../dc/dac/io_8h.html#af28a170d3ffb07353653f832d95c6ba6">rb_io_wait_writable</a>(<span class="keywordtype">int</span> f)
<a name="l00912"></a>00912 {
<a name="l00913"></a>00913     <span class="keywordflow">if</span> (f &lt; 0) {
<a name="l00914"></a>00914         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;closed stream&quot;</span>);
<a name="l00915"></a>00915     }
<a name="l00916"></a>00916     <span class="keywordflow">switch</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l00917"></a>00917       <span class="keywordflow">case</span> EINTR:
<a name="l00918"></a>00918 <span class="preprocessor">#if defined(ERESTART)</span>
<a name="l00919"></a>00919 <span class="preprocessor"></span>      <span class="keywordflow">case</span> ERESTART:
<a name="l00920"></a>00920 <span class="preprocessor">#endif</span>
<a name="l00921"></a>00921 <span class="preprocessor"></span>        <a class="code" href="../../db/d2e/intern_8h.html#ab9654ba3f4c47d18a77ebc22b5b4c356">rb_thread_fd_writable</a>(f);
<a name="l00922"></a>00922         <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00923"></a>00923 
<a name="l00924"></a>00924       <span class="keywordflow">case</span> EAGAIN:
<a name="l00925"></a>00925 <span class="preprocessor">#if defined(EWOULDBLOCK) &amp;&amp; EWOULDBLOCK != EAGAIN</span>
<a name="l00926"></a>00926 <span class="preprocessor"></span>      <span class="keywordflow">case</span> <a class="code" href="../../dd/d8c/rubysocket_8h.html#a4a3a0b3605fd3b2336455062ee8e25f0">EWOULDBLOCK</a>:
<a name="l00927"></a>00927 <span class="preprocessor">#endif</span>
<a name="l00928"></a>00928 <span class="preprocessor"></span>        <a class="code" href="../../dc/dac/io_8h.html#a5d928dd718bfee4b74deb87c1e82efd6">rb_wait_for_single_fd</a>(f, <a class="code" href="../../dc/dac/io_8h.html#a399021080de1229d3202874624f9d853">RB_WAITFD_OUT</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00929"></a>00929         <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00930"></a>00930 
<a name="l00931"></a>00931       <span class="keywordflow">default</span>:
<a name="l00932"></a>00932         <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00933"></a>00933     }
<a name="l00934"></a>00934 }
<a name="l00935"></a>00935 
<a name="l00936"></a>00936 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00937"></a><a class="code" href="../../df/d0a/io_8c.html#a56dd6b1210a074ead538e888566cfead">00937</a> <a class="code" href="../../df/d0a/io_8c.html#a56dd6b1210a074ead538e888566cfead">make_writeconv</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l00938"></a>00938 {
<a name="l00939"></a>00939     <span class="keywordflow">if</span> (!fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a98a76b1e470573eb34ed020196db9ba0">writeconv_initialized</a>) {
<a name="l00940"></a>00940         <span class="keyword">const</span> <span class="keywordtype">char</span> *senc, *denc;
<a name="l00941"></a>00941         <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc;
<a name="l00942"></a>00942         <span class="keywordtype">int</span> ecflags;
<a name="l00943"></a>00943         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ecopts;
<a name="l00944"></a>00944 
<a name="l00945"></a>00945         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a98a76b1e470573eb34ed020196db9ba0">writeconv_initialized</a> = 1;
<a name="l00946"></a>00946 
<a name="l00947"></a>00947         ecflags = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags &amp; ~<a class="code" href="../../d5/de3/encoding_8h.html#aca6b54583dbe05c55e665018ae164149">ECONV_NEWLINE_DECORATOR_READ_MASK</a>;
<a name="l00948"></a>00948         ecopts = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecopts;
<a name="l00949"></a>00949 
<a name="l00950"></a>00950         <span class="keywordflow">if</span> (!fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc || (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc == <a class="code" href="../../d5/db5/encoding_8c.html#a767d777810f0d48add93857b52057262">rb_ascii8bit_encoding</a>() &amp;&amp; !fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc2)) {
<a name="l00951"></a>00951             <span class="comment">/* no encoding conversion */</span>
<a name="l00952"></a>00952             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaccc1b6d4b005eda87fa017026fd2701">writeconv_pre_ecflags</a> = 0;
<a name="l00953"></a>00953             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ac82d528d2dee6d4f0f880fa9526fa9a6">writeconv_pre_ecopts</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00954"></a>00954             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a> = <a class="code" href="../../d5/de3/encoding_8h.html#ac48226d977525efbbf4ed18ff36fce23">rb_econv_open_opts</a>(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, ecflags, ecopts);
<a name="l00955"></a>00955             <span class="keywordflow">if</span> (!fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>)
<a name="l00956"></a>00956                 <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a0dbeff3af14fde49b20f00fde25057d0">rb_econv_open_exc</a>(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, ecflags));
<a name="l00957"></a>00957             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a8b6143bfe35f445d8564a71b547101ee">writeconv_asciicompat</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00958"></a>00958         }
<a name="l00959"></a>00959         <span class="keywordflow">else</span> {
<a name="l00960"></a>00960             enc = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc2 ? fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc2 : fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc;
<a name="l00961"></a>00961             senc = <a class="code" href="../../d5/de3/encoding_8h.html#aa74ee304630f931586c6da5bbf3ee810">rb_econv_asciicompat_encoding</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(enc));
<a name="l00962"></a>00962             <span class="keywordflow">if</span> (!senc &amp;&amp; !(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#aa9a3acfe7fdbcb1664f0c784389b917d">ECONV_STATEFUL_DECORATOR_MASK</a>)) {
<a name="l00963"></a>00963                 <span class="comment">/* single conversion */</span>
<a name="l00964"></a>00964                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaccc1b6d4b005eda87fa017026fd2701">writeconv_pre_ecflags</a> = ecflags;
<a name="l00965"></a>00965                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ac82d528d2dee6d4f0f880fa9526fa9a6">writeconv_pre_ecopts</a> = ecopts;
<a name="l00966"></a>00966                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00967"></a>00967                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a8b6143bfe35f445d8564a71b547101ee">writeconv_asciicompat</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00968"></a>00968             }
<a name="l00969"></a>00969             <span class="keywordflow">else</span> {
<a name="l00970"></a>00970                 <span class="comment">/* double conversion */</span>
<a name="l00971"></a>00971                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaccc1b6d4b005eda87fa017026fd2701">writeconv_pre_ecflags</a> = ecflags &amp; ~<a class="code" href="../../d5/de3/encoding_8h.html#aa9a3acfe7fdbcb1664f0c784389b917d">ECONV_STATEFUL_DECORATOR_MASK</a>;
<a name="l00972"></a>00972                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ac82d528d2dee6d4f0f880fa9526fa9a6">writeconv_pre_ecopts</a> = ecopts;
<a name="l00973"></a>00973                 <span class="keywordflow">if</span> (senc) {
<a name="l00974"></a>00974                     denc = <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(enc);
<a name="l00975"></a>00975                     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a8b6143bfe35f445d8564a71b547101ee">writeconv_asciicompat</a> = <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(senc);
<a name="l00976"></a>00976                 }
<a name="l00977"></a>00977                 <span class="keywordflow">else</span> {
<a name="l00978"></a>00978                     senc = denc = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00979"></a>00979                     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a8b6143bfe35f445d8564a71b547101ee">writeconv_asciicompat</a> = <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(enc));
<a name="l00980"></a>00980                 }
<a name="l00981"></a>00981                 ecflags = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags &amp; (<a class="code" href="../../d5/de3/encoding_8h.html#ab6cbd026c964d4c120c79d8cbe0cb7d0">ECONV_ERROR_HANDLER_MASK</a>|<a class="code" href="../../d5/de3/encoding_8h.html#aa9a3acfe7fdbcb1664f0c784389b917d">ECONV_STATEFUL_DECORATOR_MASK</a>);
<a name="l00982"></a>00982                 ecopts = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecopts;
<a name="l00983"></a>00983                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a> = <a class="code" href="../../d5/de3/encoding_8h.html#ac48226d977525efbbf4ed18ff36fce23">rb_econv_open_opts</a>(senc, denc, ecflags, ecopts);
<a name="l00984"></a>00984                 <span class="keywordflow">if</span> (!fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>)
<a name="l00985"></a>00985                     <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a0dbeff3af14fde49b20f00fde25057d0">rb_econv_open_exc</a>(senc, denc, ecflags));
<a name="l00986"></a>00986             }
<a name="l00987"></a>00987         }
<a name="l00988"></a>00988     }
<a name="l00989"></a>00989 }
<a name="l00990"></a>00990 
<a name="l00991"></a>00991 <span class="comment">/* writing functions */</span>
<a name="l00992"></a><a class="code" href="../../d3/d61/structbinwrite__arg.html">00992</a> <span class="keyword">struct </span><a class="code" href="../../d3/d61/structbinwrite__arg.html">binwrite_arg</a> {
<a name="l00993"></a><a class="code" href="../../d3/d61/structbinwrite__arg.html#ada32c7b47da650c042959241ebf23337">00993</a>     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l00994"></a><a class="code" href="../../d3/d61/structbinwrite__arg.html#acc80eaf17d78b8c08bbc26b0129a0698">00994</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d61/structbinwrite__arg.html#acc80eaf17d78b8c08bbc26b0129a0698">str</a>;
<a name="l00995"></a><a class="code" href="../../d3/d61/structbinwrite__arg.html#a096a5b8509da51333671e8956119c39f">00995</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/d61/structbinwrite__arg.html#a096a5b8509da51333671e8956119c39f">ptr</a>;
<a name="l00996"></a><a class="code" href="../../d3/d61/structbinwrite__arg.html#ac2b35af2e4cddf5eb66c102d27699cc6">00996</a>     <span class="keywordtype">long</span> <a class="code" href="../../d3/d61/structbinwrite__arg.html#ac2b35af2e4cddf5eb66c102d27699cc6">length</a>;
<a name="l00997"></a>00997 };
<a name="l00998"></a>00998 
<a name="l00999"></a><a class="code" href="../../dd/d4b/structwrite__arg.html">00999</a> <span class="keyword">struct </span><a class="code" href="../../dd/d4b/structwrite__arg.html">write_arg</a> {
<a name="l01000"></a><a class="code" href="../../dd/d4b/structwrite__arg.html#a65f4fa015e8e859209abdec4352945ec">01000</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dd/d4b/structwrite__arg.html#a65f4fa015e8e859209abdec4352945ec">io</a>;
<a name="l01001"></a><a class="code" href="../../dd/d4b/structwrite__arg.html#a3c20be56c3ea9c09f7d16e14b7485089">01001</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dd/d4b/structwrite__arg.html#a3c20be56c3ea9c09f7d16e14b7485089">str</a>;
<a name="l01002"></a><a class="code" href="../../dd/d4b/structwrite__arg.html#a4e40b1c7b2f0897112040b6e247a475c">01002</a>     <span class="keywordtype">int</span> <a class="code" href="../../dd/d4b/structwrite__arg.html#a4e40b1c7b2f0897112040b6e247a475c">nosync</a>;
<a name="l01003"></a>01003 };
<a name="l01004"></a>01004 
<a name="l01005"></a>01005 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01006"></a><a class="code" href="../../df/d0a/io_8c.html#a19a73bab71aeab6f472dd396d3f0010c">01006</a> <a class="code" href="../../df/d0a/io_8c.html#a19a73bab71aeab6f472dd396d3f0010c">io_binwrite_string</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l01007"></a>01007 {
<a name="l01008"></a>01008     <span class="keyword">struct </span><a class="code" href="../../d3/d61/structbinwrite__arg.html">binwrite_arg</a> *p = (<span class="keyword">struct </span><a class="code" href="../../d3/d61/structbinwrite__arg.html">binwrite_arg</a> *)arg;
<a name="l01009"></a>01009     <span class="keywordtype">long</span> l = <a class="code" href="../../df/d0a/io_8c.html#a7168879fc6c59c3a7d2cd1d7110d18a1">io_writable_length</a>(p-&gt;<a class="code" href="../../d3/d61/structbinwrite__arg.html#ada32c7b47da650c042959241ebf23337">fptr</a>, p-&gt;<a class="code" href="../../d3/d61/structbinwrite__arg.html#ac2b35af2e4cddf5eb66c102d27699cc6">length</a>);
<a name="l01010"></a>01010     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#ac7a460cb9d941a9c2f160f52b35b5948">rb_write_internal</a>(p-&gt;<a class="code" href="../../d3/d61/structbinwrite__arg.html#ada32c7b47da650c042959241ebf23337">fptr</a>-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, p-&gt;<a class="code" href="../../d3/d61/structbinwrite__arg.html#a096a5b8509da51333671e8956119c39f">ptr</a>, l);
<a name="l01011"></a>01011 }
<a name="l01012"></a>01012 
<a name="l01013"></a>01013 <span class="keyword">static</span> <span class="keywordtype">long</span>
<a name="l01014"></a><a class="code" href="../../df/d0a/io_8c.html#a434d0bad3a6a4a85ab3a2932204b8d83">01014</a> <a class="code" href="../../df/d0a/io_8c.html#a434d0bad3a6a4a85ab3a2932204b8d83">io_binwrite</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d61/structbinwrite__arg.html#acc80eaf17d78b8c08bbc26b0129a0698">str</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/d61/structbinwrite__arg.html#a096a5b8509da51333671e8956119c39f">ptr</a>, <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <span class="keywordtype">int</span> nosync)
<a name="l01015"></a>01015 {
<a name="l01016"></a>01016     <span class="keywordtype">long</span> n, r, offset = 0;
<a name="l01017"></a>01017 
<a name="l01018"></a>01018     <span class="keywordflow">if</span> ((n = len) &lt;= 0) <span class="keywordflow">return</span> n;
<a name="l01019"></a>01019     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; !(!nosync &amp;&amp; (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a95a89e4b35429fb51d7c3e52ec405d90">FMODE_SYNC</a>))) {
<a name="l01020"></a>01020         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = 0;
<a name="l01021"></a>01021         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> = 0;
<a name="l01022"></a>01022         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a> = <a class="code" href="../../df/d0a/io_8c.html#a4c1ecf89984f5a0bd1e94e715c5213ff">IO_WBUF_CAPA_MIN</a>;
<a name="l01023"></a>01023         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a79041aa2bc7439c11906a86f82a52eb6">ALLOC_N</a>(<span class="keywordtype">char</span>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>);
<a name="l01024"></a>01024         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ab6eade210f169f0a929e1381cbef947d">write_lock</a> = <a class="code" href="../../db/d2e/intern_8h.html#a23f4d3393bc85cb29c1f8212cd2ecd7f">rb_mutex_new</a>();
<a name="l01025"></a>01025     }
<a name="l01026"></a>01026     <span class="keywordflow">if</span> ((!nosync &amp;&amp; (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; (<a class="code" href="../../dc/dac/io_8h.html#a95a89e4b35429fb51d7c3e52ec405d90">FMODE_SYNC</a>|<a class="code" href="../../dc/dac/io_8h.html#a40065fb3d48c5c13642ef3880efaaa03">FMODE_TTY</a>))) ||
<a name="l01027"></a>01027         (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> &amp;&amp; fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a> &lt;= fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> + len)) {
<a name="l01028"></a>01028         <span class="keyword">struct </span><a class="code" href="../../d3/d61/structbinwrite__arg.html">binwrite_arg</a> arg;
<a name="l01029"></a>01029 
<a name="l01030"></a>01030         <span class="comment">/* xxx: use writev to avoid double write if available */</span>
<a name="l01031"></a>01031         <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> &amp;&amp; fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>+len &lt;= fptr-&gt;wbuf.capa) {
<a name="l01032"></a>01032             <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a> &lt; fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>+len) {
<a name="l01033"></a>01033                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aad09de334c9b8c7f717d314b14679e62">MEMMOVE</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, <span class="keywordtype">char</span>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>);
<a name="l01034"></a>01034                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = 0;
<a name="l01035"></a>01035             }
<a name="l01036"></a>01036             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aad09de334c9b8c7f717d314b14679e62">MEMMOVE</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>, ptr+offset, <span class="keywordtype">char</span>, len);
<a name="l01037"></a>01037             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> += (int)len;
<a name="l01038"></a>01038             n = 0;
<a name="l01039"></a>01039         }
<a name="l01040"></a>01040         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(fptr) &lt; 0)
<a name="l01041"></a>01041             <span class="keywordflow">return</span> -1L;
<a name="l01042"></a>01042         <span class="keywordflow">if</span> (n == 0)
<a name="l01043"></a>01043             <span class="keywordflow">return</span> len;
<a name="l01044"></a>01044         <span class="comment">/* avoid context switch between &quot;a&quot; and &quot;\n&quot; in STDERR.puts &quot;a&quot;.</span>
<a name="l01045"></a>01045 <span class="comment">           [ruby-dev:25080] */</span>
<a name="l01046"></a>01046         <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a> != stderr &amp;&amp; !<a class="code" href="../../db/d2e/intern_8h.html#ab9654ba3f4c47d18a77ebc22b5b4c356">rb_thread_fd_writable</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>)) {
<a name="l01047"></a>01047             <a class="code" href="../../dc/dac/io_8h.html#a6b4f0c0735ecb278abd3f63059b5fc48">rb_io_check_closed</a>(fptr);
<a name="l01048"></a>01048         }
<a name="l01049"></a>01049         arg.<a class="code" href="../../d3/d61/structbinwrite__arg.html#ada32c7b47da650c042959241ebf23337">fptr</a> = fptr;
<a name="l01050"></a>01050         arg.<a class="code" href="../../d3/d61/structbinwrite__arg.html#acc80eaf17d78b8c08bbc26b0129a0698">str</a> = str;
<a name="l01051"></a>01051       retry:
<a name="l01052"></a>01052         arg.<a class="code" href="../../d3/d61/structbinwrite__arg.html#a096a5b8509da51333671e8956119c39f">ptr</a> = ptr + offset;
<a name="l01053"></a>01053         arg.<a class="code" href="../../d3/d61/structbinwrite__arg.html#ac2b35af2e4cddf5eb66c102d27699cc6">length</a> = n;
<a name="l01054"></a>01054         <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ab6eade210f169f0a929e1381cbef947d">write_lock</a>) {
<a name="l01055"></a>01055             r = <a class="code" href="../../db/d2e/intern_8h.html#a67eed485066a22a165646aa1fcce93bf">rb_mutex_synchronize</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ab6eade210f169f0a929e1381cbef947d">write_lock</a>, <a class="code" href="../../df/d0a/io_8c.html#a19a73bab71aeab6f472dd396d3f0010c">io_binwrite_string</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;arg);
<a name="l01056"></a>01056         }
<a name="l01057"></a>01057         <span class="keywordflow">else</span> {
<a name="l01058"></a>01058             <span class="keywordtype">long</span> l = <a class="code" href="../../df/d0a/io_8c.html#a7168879fc6c59c3a7d2cd1d7110d18a1">io_writable_length</a>(fptr, n);
<a name="l01059"></a>01059             r = <a class="code" href="../../df/d0a/io_8c.html#ac7a460cb9d941a9c2f160f52b35b5948">rb_write_internal</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, ptr+offset, l);
<a name="l01060"></a>01060         }
<a name="l01061"></a>01061         <span class="comment">/* xxx: other threads may modify given string. */</span>
<a name="l01062"></a>01062         <span class="keywordflow">if</span> (r == n) <span class="keywordflow">return</span> len;
<a name="l01063"></a>01063         <span class="keywordflow">if</span> (0 &lt;= r) {
<a name="l01064"></a>01064             offset += r;
<a name="l01065"></a>01065             n -= r;
<a name="l01066"></a>01066             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EAGAIN;
<a name="l01067"></a>01067         }
<a name="l01068"></a>01068         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dac/io_8h.html#af28a170d3ffb07353653f832d95c6ba6">rb_io_wait_writable</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>)) {
<a name="l01069"></a>01069             <a class="code" href="../../dc/dac/io_8h.html#a6b4f0c0735ecb278abd3f63059b5fc48">rb_io_check_closed</a>(fptr);
<a name="l01070"></a>01070             <span class="keywordflow">if</span> (offset &lt; len)
<a name="l01071"></a>01071                 <span class="keywordflow">goto</span> retry;
<a name="l01072"></a>01072         }
<a name="l01073"></a>01073         <span class="keywordflow">return</span> -1L;
<a name="l01074"></a>01074     }
<a name="l01075"></a>01075 
<a name="l01076"></a>01076     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>) {
<a name="l01077"></a>01077         <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>)
<a name="l01078"></a>01078             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aad09de334c9b8c7f717d314b14679e62">MEMMOVE</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, <span class="keywordtype">char</span>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>);
<a name="l01079"></a>01079         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = 0;
<a name="l01080"></a>01080     }
<a name="l01081"></a>01081     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aad09de334c9b8c7f717d314b14679e62">MEMMOVE</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>, ptr+offset, <span class="keywordtype">char</span>, len);
<a name="l01082"></a>01082     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> += (int)len;
<a name="l01083"></a>01083     <span class="keywordflow">return</span> len;
<a name="l01084"></a>01084 }
<a name="l01085"></a>01085 
<a name="l01086"></a><a class="code" href="../../df/d0a/io_8c.html#a5f4cda0ea1994c3ee917943870da504e">01086</a> <span class="preprocessor"># define MODE_BTMODE(a,b,c) ((fmode &amp; FMODE_BINMODE) ? (b) : \</span>
<a name="l01087"></a>01087 <span class="preprocessor">                             (fmode &amp; FMODE_TEXTMODE) ? (c) : (a))</span>
<a name="l01088"></a>01088 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01089"></a><a class="code" href="../../df/d0a/io_8c.html#a05622d0edf68307ac02be32ed9b5ecf7">01089</a> <a class="code" href="../../df/d0a/io_8c.html#a05622d0edf68307ac02be32ed9b5ecf7">do_writeconv</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d61/structbinwrite__arg.html#acc80eaf17d78b8c08bbc26b0129a0698">str</a>, <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l01090"></a>01090 {
<a name="l01091"></a>01091     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a5c26bbaaf198084cc8a42b241ff53bca">NEED_WRITECONV</a>(fptr)) {
<a name="l01092"></a>01092         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> common_encoding = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01093"></a>01093         <a class="code" href="../../df/d0a/io_8c.html#ace89c001caf3ebc8943c8f06c0aab552">SET_BINARY_MODE</a>(fptr);
<a name="l01094"></a>01094 
<a name="l01095"></a>01095         <a class="code" href="../../df/d0a/io_8c.html#a56dd6b1210a074ead538e888566cfead">make_writeconv</a>(fptr);
<a name="l01096"></a>01096 
<a name="l01097"></a>01097         <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>) {
<a name="l01098"></a>01098 <span class="preprocessor">#define fmode (fptr-&gt;mode)</span>
<a name="l01099"></a>01099 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a8b6143bfe35f445d8564a71b547101ee">writeconv_asciicompat</a>))
<a name="l01100"></a>01100                 common_encoding = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a8b6143bfe35f445d8564a71b547101ee">writeconv_asciicompat</a>;
<a name="l01101"></a>01101             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a5f4cda0ea1994c3ee917943870da504e">MODE_BTMODE</a>(<a class="code" href="../../df/d0a/io_8c.html#ab2c655110073a066c789b7e92cf7377c">DEFAULT_TEXTMODE</a>,0,1) &amp;&amp; !<a class="code" href="../../d5/de3/encoding_8h.html#a8b18a09a3055d3006c6d5baeaa6e7c72">rb_enc_asciicompat</a>(<a class="code" href="../../d5/db5/encoding_8c.html#ac21ed764f3b39453b6a848dd64a19585">rb_enc_get</a>(str))) {
<a name="l01102"></a>01102                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;ASCII incompatible string written for text mode IO without encoding conversion: %s&quot;</span>,
<a name="l01103"></a>01103                          <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(<a class="code" href="../../d5/db5/encoding_8c.html#ac21ed764f3b39453b6a848dd64a19585">rb_enc_get</a>(str)));
<a name="l01104"></a>01104             }
<a name="l01105"></a>01105 <span class="preprocessor">#undef fmode</span>
<a name="l01106"></a>01106 <span class="preprocessor"></span>        }
<a name="l01107"></a>01107         <span class="keywordflow">else</span> {
<a name="l01108"></a>01108             <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc2)
<a name="l01109"></a>01109                 common_encoding = <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc2);
<a name="l01110"></a>01110             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc != <a class="code" href="../../d5/db5/encoding_8c.html#a767d777810f0d48add93857b52057262">rb_ascii8bit_encoding</a>())
<a name="l01111"></a>01111                 common_encoding = <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc);
<a name="l01112"></a>01112         }
<a name="l01113"></a>01113 
<a name="l01114"></a>01114         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(common_encoding)) {
<a name="l01115"></a>01115             str = <a class="code" href="../../d5/de3/encoding_8h.html#a92c4c79471eb00ba915287505a118401">rb_str_encode</a>(str, common_encoding,
<a name="l01116"></a>01116                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaccc1b6d4b005eda87fa017026fd2701">writeconv_pre_ecflags</a>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ac82d528d2dee6d4f0f880fa9526fa9a6">writeconv_pre_ecopts</a>);
<a name="l01117"></a>01117         }
<a name="l01118"></a>01118 
<a name="l01119"></a>01119         <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>) {
<a name="l01120"></a>01120             str = <a class="code" href="../../d5/de3/encoding_8h.html#a7e5ee7da8d856b9c500ae2b50b584627">rb_econv_str_convert</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>, str, <a class="code" href="../../d5/de3/encoding_8h.html#ab1eeed22e1b00841e21fa4715df0029e">ECONV_PARTIAL_INPUT</a>);
<a name="l01121"></a>01121         }
<a name="l01122"></a>01122     }
<a name="l01123"></a>01123 <span class="preprocessor">#if defined(RUBY_TEST_CRLF_ENVIRONMENT) || defined(_WIN32)</span>
<a name="l01124"></a>01124 <span class="preprocessor"></span><span class="preprocessor">#define fmode (fptr-&gt;mode)</span>
<a name="l01125"></a>01125 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a5f4cda0ea1994c3ee917943870da504e">MODE_BTMODE</a>(<a class="code" href="../../df/d0a/io_8c.html#ab2c655110073a066c789b7e92cf7377c">DEFAULT_TEXTMODE</a>,0,1)) {
<a name="l01126"></a>01126         <span class="keywordflow">if</span> ((fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>) &amp;&amp;
<a name="l01127"></a>01127             !(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#aea188e77ea841e2c7741a9ef8c4c33a5">ECONV_NEWLINE_DECORATOR_MASK</a>)) {
<a name="l01128"></a>01128             setmode(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>);
<a name="l01129"></a>01129         }
<a name="l01130"></a>01130         <span class="keywordflow">else</span> {
<a name="l01131"></a>01131             setmode(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, O_TEXT);
<a name="l01132"></a>01132         }
<a name="l01133"></a>01133         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/de3/encoding_8h.html#a8b18a09a3055d3006c6d5baeaa6e7c72">rb_enc_asciicompat</a>(<a class="code" href="../../d5/db5/encoding_8c.html#ac21ed764f3b39453b6a848dd64a19585">rb_enc_get</a>(str))) {
<a name="l01134"></a>01134             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;ASCII incompatible string written for text mode IO without encoding conversion: %s&quot;</span>,
<a name="l01135"></a>01135             <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(<a class="code" href="../../d5/db5/encoding_8c.html#ac21ed764f3b39453b6a848dd64a19585">rb_enc_get</a>(str)));
<a name="l01136"></a>01136         }
<a name="l01137"></a>01137     }
<a name="l01138"></a>01138 <span class="preprocessor">#undef fmode</span>
<a name="l01139"></a>01139 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01140"></a>01140 <span class="preprocessor"></span>    <span class="keywordflow">return</span> str;
<a name="l01141"></a>01141 }
<a name="l01142"></a>01142 
<a name="l01143"></a>01143 <span class="keyword">static</span> <span class="keywordtype">long</span>
<a name="l01144"></a><a class="code" href="../../df/d0a/io_8c.html#a07177b43f8cb62c818afe27af93dc043">01144</a> <a class="code" href="../../df/d0a/io_8c.html#a07177b43f8cb62c818afe27af93dc043">io_fwrite</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d61/structbinwrite__arg.html#acc80eaf17d78b8c08bbc26b0129a0698">str</a>, <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <span class="keywordtype">int</span> nosync)
<a name="l01145"></a>01145 {
<a name="l01146"></a>01146 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l01147"></a>01147 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a40065fb3d48c5c13642ef3880efaaa03">FMODE_TTY</a>) {
<a name="l01148"></a>01148         <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = <a class="code" href="../../dc/db1/win32_8h.html#a07475740ddb9ed55ea0ae009c5007254">rb_w32_write_console</a>(str, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>);
<a name="l01149"></a>01149         <span class="keywordflow">if</span> (len &gt; 0) <span class="keywordflow">return</span> len;
<a name="l01150"></a>01150     }
<a name="l01151"></a>01151 <span class="preprocessor">#endif</span>
<a name="l01152"></a>01152 <span class="preprocessor"></span>    str = <a class="code" href="../../df/d0a/io_8c.html#a05622d0edf68307ac02be32ed9b5ecf7">do_writeconv</a>(str, fptr);
<a name="l01153"></a>01153     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a434d0bad3a6a4a85ab3a2932204b8d83">io_binwrite</a>(str, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str),
<a name="l01154"></a>01154                        fptr, nosync);
<a name="l01155"></a>01155 }
<a name="l01156"></a>01156 
<a name="l01157"></a>01157 ssize_t
<a name="l01158"></a><a class="code" href="../../df/d0a/io_8c.html#ac498ae6e389ece41fbcddd87a974677f">01158</a> <a class="code" href="../../dc/dac/io_8h.html#ac498ae6e389ece41fbcddd87a974677f">rb_io_bufwrite</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l01159"></a>01159 {
<a name="l01160"></a>01160     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01161"></a>01161 
<a name="l01162"></a>01162     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l01163"></a>01163     <a class="code" href="../../dc/dac/io_8h.html#a728977df67c656197402bb30a14af953">rb_io_check_writable</a>(fptr);
<a name="l01164"></a>01164     <span class="keywordflow">return</span> (ssize_t)<a class="code" href="../../df/d0a/io_8c.html#a434d0bad3a6a4a85ab3a2932204b8d83">io_binwrite</a>(0, buf, (<span class="keywordtype">long</span>)size, fptr, 0);
<a name="l01165"></a>01165 }
<a name="l01166"></a>01166 
<a name="l01167"></a>01167 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01168"></a><a class="code" href="../../df/d0a/io_8c.html#abe88ebe32ee29a9e05e78f43385395de">01168</a> <a class="code" href="../../df/d0a/io_8c.html#abe88ebe32ee29a9e05e78f43385395de">io_write</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d61/structbinwrite__arg.html#acc80eaf17d78b8c08bbc26b0129a0698">str</a>, <span class="keywordtype">int</span> nosync)
<a name="l01169"></a>01169 {
<a name="l01170"></a>01170     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01171"></a>01171     <span class="keywordtype">long</span> n;
<a name="l01172"></a>01172     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> tmp;
<a name="l01173"></a>01173 
<a name="l01174"></a>01174     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a98b91af598acb64fe8497413ce498766">rb_secure</a>(4);
<a name="l01175"></a>01175     io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l01176"></a>01176     str = <a class="code" href="../../db/d2e/intern_8h.html#acae5350f5d539c4654e4e33690256a9f">rb_obj_as_string</a>(str);
<a name="l01177"></a>01177     tmp = <a class="code" href="../../df/d0a/io_8c.html#ab5d27e6f0fb8f238d3ab912a34316563">rb_io_check_io</a>(io);
<a name="l01178"></a>01178     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(tmp)) {
<a name="l01179"></a>01179         <span class="comment">/* port is not IO, call write method for it. */</span>
<a name="l01180"></a>01180         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(io, <a class="code" href="../../df/d0a/io_8c.html#a5a1310970981dfb309a18f6a1a9a771b">id_write</a>, 1, str);
<a name="l01181"></a>01181     }
<a name="l01182"></a>01182     io = tmp;
<a name="l01183"></a>01183     <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str) == 0) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0);
<a name="l01184"></a>01184 
<a name="l01185"></a>01185     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l01186"></a>01186     <a class="code" href="../../dc/dac/io_8h.html#a728977df67c656197402bb30a14af953">rb_io_check_writable</a>(fptr);
<a name="l01187"></a>01187 
<a name="l01188"></a>01188     n = <a class="code" href="../../df/d0a/io_8c.html#a07177b43f8cb62c818afe27af93dc043">io_fwrite</a>(str, fptr, nosync);
<a name="l01189"></a>01189     <span class="keywordflow">if</span> (n == -1L) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l01190"></a>01190 
<a name="l01191"></a>01191     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2ead2f64c81efed352e79e89f29b8fc8">LONG2FIX</a>(n);
<a name="l01192"></a>01192 }
<a name="l01193"></a>01193 
<a name="l01194"></a>01194 <span class="comment">/*</span>
<a name="l01195"></a>01195 <span class="comment"> *  call-seq:</span>
<a name="l01196"></a>01196 <span class="comment"> *     ios.write(string)    -&gt; integer</span>
<a name="l01197"></a>01197 <span class="comment"> *</span>
<a name="l01198"></a>01198 <span class="comment"> *  Writes the given string to &lt;em&gt;ios&lt;/em&gt;. The stream must be opened</span>
<a name="l01199"></a>01199 <span class="comment"> *  for writing. If the argument is not a string, it will be converted</span>
<a name="l01200"></a>01200 <span class="comment"> *  to a string using &lt;code&gt;to_s&lt;/code&gt;. Returns the number of bytes</span>
<a name="l01201"></a>01201 <span class="comment"> *  written.</span>
<a name="l01202"></a>01202 <span class="comment"> *</span>
<a name="l01203"></a>01203 <span class="comment"> *     count = $stdout.write(&quot;This is a test\n&quot;)</span>
<a name="l01204"></a>01204 <span class="comment"> *     puts &quot;That was #{count} bytes of data&quot;</span>
<a name="l01205"></a>01205 <span class="comment"> *</span>
<a name="l01206"></a>01206 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l01207"></a>01207 <span class="comment"> *</span>
<a name="l01208"></a>01208 <span class="comment"> *     This is a test</span>
<a name="l01209"></a>01209 <span class="comment"> *     That was 15 bytes of data</span>
<a name="l01210"></a>01210 <span class="comment"> */</span>
<a name="l01211"></a>01211 
<a name="l01212"></a>01212 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01213"></a><a class="code" href="../../df/d0a/io_8c.html#a6929fbb0b7bb6756e549bff399334093">01213</a> <a class="code" href="../../df/d0a/io_8c.html#a6929fbb0b7bb6756e549bff399334093">io_write_m</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d61/structbinwrite__arg.html#acc80eaf17d78b8c08bbc26b0129a0698">str</a>)
<a name="l01214"></a>01214 {
<a name="l01215"></a>01215     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#abe88ebe32ee29a9e05e78f43385395de">io_write</a>(io, str, 0);
<a name="l01216"></a>01216 }
<a name="l01217"></a>01217 
<a name="l01218"></a>01218 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01219"></a><a class="code" href="../../df/d0a/io_8c.html#a6a280549d3cc997fe0a257daeb83ba19">01219</a> <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d61/structbinwrite__arg.html#acc80eaf17d78b8c08bbc26b0129a0698">str</a>)
<a name="l01220"></a>01220 {
<a name="l01221"></a>01221     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(io, <a class="code" href="../../df/d0a/io_8c.html#a5a1310970981dfb309a18f6a1a9a771b">id_write</a>, 1, str);
<a name="l01222"></a>01222 }
<a name="l01223"></a>01223 
<a name="l01224"></a>01224 <span class="comment">/*</span>
<a name="l01225"></a>01225 <span class="comment"> *  call-seq:</span>
<a name="l01226"></a>01226 <span class="comment"> *     ios &lt;&lt; obj     -&gt; ios</span>
<a name="l01227"></a>01227 <span class="comment"> *</span>
<a name="l01228"></a>01228 <span class="comment"> *  String Output---Writes &lt;i&gt;obj&lt;/i&gt; to &lt;em&gt;ios&lt;/em&gt;.</span>
<a name="l01229"></a>01229 <span class="comment"> *  &lt;i&gt;obj&lt;/i&gt; will be converted to a string using</span>
<a name="l01230"></a>01230 <span class="comment"> *  &lt;code&gt;to_s&lt;/code&gt;.</span>
<a name="l01231"></a>01231 <span class="comment"> *</span>
<a name="l01232"></a>01232 <span class="comment"> *     $stdout &lt;&lt; &quot;Hello &quot; &lt;&lt; &quot;world!\n&quot;</span>
<a name="l01233"></a>01233 <span class="comment"> *</span>
<a name="l01234"></a>01234 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l01235"></a>01235 <span class="comment"> *</span>
<a name="l01236"></a>01236 <span class="comment"> *     Hello world!</span>
<a name="l01237"></a>01237 <span class="comment"> */</span>
<a name="l01238"></a>01238 
<a name="l01239"></a>01239 
<a name="l01240"></a>01240 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01241"></a><a class="code" href="../../df/d0a/io_8c.html#a14cd5bbcedd59cf5490ee633955825ed">01241</a> <a class="code" href="../../db/d2e/intern_8h.html#a9660780630812f5149c578517e5a1796">rb_io_addstr</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d61/structbinwrite__arg.html#acc80eaf17d78b8c08bbc26b0129a0698">str</a>)
<a name="l01242"></a>01242 {
<a name="l01243"></a>01243     <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(io, str);
<a name="l01244"></a>01244     <span class="keywordflow">return</span> io;
<a name="l01245"></a>01245 }
<a name="l01246"></a>01246 
<a name="l01247"></a>01247 <span class="comment">/*</span>
<a name="l01248"></a>01248 <span class="comment"> *  call-seq:</span>
<a name="l01249"></a>01249 <span class="comment"> *     ios.flush    -&gt; ios</span>
<a name="l01250"></a>01250 <span class="comment"> *</span>
<a name="l01251"></a>01251 <span class="comment"> *  Flushes any buffered data within &lt;em&gt;ios&lt;/em&gt; to the underlying</span>
<a name="l01252"></a>01252 <span class="comment"> *  operating system (note that this is Ruby internal buffering only;</span>
<a name="l01253"></a>01253 <span class="comment"> *  the OS may buffer the data as well).</span>
<a name="l01254"></a>01254 <span class="comment"> *</span>
<a name="l01255"></a>01255 <span class="comment"> *     $stdout.print &quot;no newline&quot;</span>
<a name="l01256"></a>01256 <span class="comment"> *     $stdout.flush</span>
<a name="l01257"></a>01257 <span class="comment"> *</span>
<a name="l01258"></a>01258 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l01259"></a>01259 <span class="comment"> *</span>
<a name="l01260"></a>01260 <span class="comment"> *     no newline</span>
<a name="l01261"></a>01261 <span class="comment"> */</span>
<a name="l01262"></a>01262 
<a name="l01263"></a>01263 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01264"></a><a class="code" href="../../df/d0a/io_8c.html#aa46395c86fb04dae0879c4062f7ed776">01264</a> <a class="code" href="../../db/d2e/intern_8h.html#a773ecf32a05c03d4ca1da8cf31bbfc29">rb_io_flush</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l01265"></a>01265 {
<a name="l01266"></a>01266     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01267"></a>01267 
<a name="l01268"></a>01268     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(io) != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a>) {
<a name="l01269"></a>01269         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(io, <a class="code" href="../../df/d0a/io_8c.html#a3096167a3c55f32a5fa2535e5ee0c2c4">id_flush</a>, 0);
<a name="l01270"></a>01270     }
<a name="l01271"></a>01271 
<a name="l01272"></a>01272     io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l01273"></a>01273     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l01274"></a>01274 
<a name="l01275"></a>01275     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>) {
<a name="l01276"></a>01276         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(fptr) &lt; 0)
<a name="l01277"></a>01277             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l01278"></a>01278 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l01279"></a>01279 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (GetFileType((HANDLE)<a class="code" href="../../dc/db1/win32_8h.html#a1955cd10ac395eb8442b50577b1e968e">rb_w32_get_osfhandle</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>)) == FILE_TYPE_DISK) {
<a name="l01280"></a>01280             <a class="code" href="../../dc/db1/win32_8h.html#ad352c8c2259cb51bd490b1dfdae5f784">fsync</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>);
<a name="l01281"></a>01281         }
<a name="l01282"></a>01282 <span class="preprocessor">#endif</span>
<a name="l01283"></a>01283 <span class="preprocessor"></span>    }
<a name="l01284"></a>01284     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>) {
<a name="l01285"></a>01285         <a class="code" href="../../df/d0a/io_8c.html#a7649b75a0b7abd414acc585acd2d061e">io_unread</a>(fptr);
<a name="l01286"></a>01286     }
<a name="l01287"></a>01287 
<a name="l01288"></a>01288     <span class="keywordflow">return</span> io;
<a name="l01289"></a>01289 }
<a name="l01290"></a>01290 
<a name="l01291"></a>01291 <span class="comment">/*</span>
<a name="l01292"></a>01292 <span class="comment"> *  call-seq:</span>
<a name="l01293"></a>01293 <span class="comment"> *     ios.pos     -&gt; integer</span>
<a name="l01294"></a>01294 <span class="comment"> *     ios.tell    -&gt; integer</span>
<a name="l01295"></a>01295 <span class="comment"> *</span>
<a name="l01296"></a>01296 <span class="comment"> *  Returns the current offset (in bytes) of &lt;em&gt;ios&lt;/em&gt;.</span>
<a name="l01297"></a>01297 <span class="comment"> *</span>
<a name="l01298"></a>01298 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l01299"></a>01299 <span class="comment"> *     f.pos    #=&gt; 0</span>
<a name="l01300"></a>01300 <span class="comment"> *     f.gets   #=&gt; &quot;This is line one\n&quot;</span>
<a name="l01301"></a>01301 <span class="comment"> *     f.pos    #=&gt; 17</span>
<a name="l01302"></a>01302 <span class="comment"> */</span>
<a name="l01303"></a>01303 
<a name="l01304"></a>01304 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01305"></a><a class="code" href="../../df/d0a/io_8c.html#a9dfbc6591e022d6d91a1590d3a329d79">01305</a> <a class="code" href="../../df/d0a/io_8c.html#a9dfbc6591e022d6d91a1590d3a329d79">rb_io_tell</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l01306"></a>01306 {
<a name="l01307"></a>01307     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01308"></a>01308     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> pos;
<a name="l01309"></a>01309 
<a name="l01310"></a>01310     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l01311"></a>01311     pos = <a class="code" href="../../df/d0a/io_8c.html#a05eb5776a3cfb91c2636c607be1ba1e4">io_tell</a>(fptr);
<a name="l01312"></a>01312     <span class="keywordflow">if</span> (pos &lt; 0 &amp;&amp; <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l01313"></a>01313     pos -= fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>;
<a name="l01314"></a>01314     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0272a51f5dbad0d6413d4de5d24c4aad">OFFT2NUM</a>(pos);
<a name="l01315"></a>01315 }
<a name="l01316"></a>01316 
<a name="l01317"></a>01317 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01318"></a><a class="code" href="../../df/d0a/io_8c.html#a7de72531da99cf086e643d54f60d21c6">01318</a> <a class="code" href="../../df/d0a/io_8c.html#a7de72531da99cf086e643d54f60d21c6">rb_io_seek</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> offset, <span class="keywordtype">int</span> whence)
<a name="l01319"></a>01319 {
<a name="l01320"></a>01320     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01321"></a>01321     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> pos;
<a name="l01322"></a>01322 
<a name="l01323"></a>01323     pos = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#adc3ee80338c33b87afa2a7047287c96f">NUM2OFFT</a>(offset);
<a name="l01324"></a>01324     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l01325"></a>01325     pos = <a class="code" href="../../df/d0a/io_8c.html#a08a06c385029a1ebff645c082bf5b839">io_seek</a>(fptr, pos, whence);
<a name="l01326"></a>01326     <span class="keywordflow">if</span> (pos &lt; 0 &amp;&amp; <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l01327"></a>01327 
<a name="l01328"></a>01328     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0);
<a name="l01329"></a>01329 }
<a name="l01330"></a>01330 
<a name="l01331"></a>01331 <span class="comment">/*</span>
<a name="l01332"></a>01332 <span class="comment"> *  call-seq:</span>
<a name="l01333"></a>01333 <span class="comment"> *     ios.seek(amount, whence=IO::SEEK_SET)  -&gt;  0</span>
<a name="l01334"></a>01334 <span class="comment"> *</span>
<a name="l01335"></a>01335 <span class="comment"> *  Seeks to a given offset &lt;i&gt;anInteger&lt;/i&gt; in the stream according to</span>
<a name="l01336"></a>01336 <span class="comment"> *  the value of &lt;i&gt;whence&lt;/i&gt;:</span>
<a name="l01337"></a>01337 <span class="comment"> *</span>
<a name="l01338"></a>01338 <span class="comment"> *    IO::SEEK_CUR  | Seeks to _amount_ plus current position</span>
<a name="l01339"></a>01339 <span class="comment"> *    --------------+----------------------------------------------------</span>
<a name="l01340"></a>01340 <span class="comment"> *    IO::SEEK_END  | Seeks to _amount_ plus end of stream (you probably</span>
<a name="l01341"></a>01341 <span class="comment"> *                  | want a negative value for _amount_)</span>
<a name="l01342"></a>01342 <span class="comment"> *    --------------+----------------------------------------------------</span>
<a name="l01343"></a>01343 <span class="comment"> *    IO::SEEK_SET  | Seeks to the absolute location given by _amount_</span>
<a name="l01344"></a>01344 <span class="comment"> *</span>
<a name="l01345"></a>01345 <span class="comment"> *  Example:</span>
<a name="l01346"></a>01346 <span class="comment"> *</span>
<a name="l01347"></a>01347 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l01348"></a>01348 <span class="comment"> *     f.seek(-13, IO::SEEK_END)   #=&gt; 0</span>
<a name="l01349"></a>01349 <span class="comment"> *     f.readline                  #=&gt; &quot;And so on...\n&quot;</span>
<a name="l01350"></a>01350 <span class="comment"> */</span>
<a name="l01351"></a>01351 
<a name="l01352"></a>01352 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01353"></a><a class="code" href="../../df/d0a/io_8c.html#a3da22b51f3d8dfd33f72a6640597ffad">01353</a> <a class="code" href="../../df/d0a/io_8c.html#a3da22b51f3d8dfd33f72a6640597ffad">rb_io_seek_m</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l01354"></a>01354 {
<a name="l01355"></a>01355     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> offset, ptrname;
<a name="l01356"></a>01356     <span class="keywordtype">int</span> whence = <a class="code" href="../../df/d0a/io_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">SEEK_SET</a>;
<a name="l01357"></a>01357 
<a name="l01358"></a>01358     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;11&quot;</span>, &amp;offset, &amp;ptrname) == 2) {
<a name="l01359"></a>01359         whence = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(ptrname);
<a name="l01360"></a>01360     }
<a name="l01361"></a>01361 
<a name="l01362"></a>01362     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a7de72531da99cf086e643d54f60d21c6">rb_io_seek</a>(io, offset, whence);
<a name="l01363"></a>01363 }
<a name="l01364"></a>01364 
<a name="l01365"></a>01365 <span class="comment">/*</span>
<a name="l01366"></a>01366 <span class="comment"> *  call-seq:</span>
<a name="l01367"></a>01367 <span class="comment"> *     ios.pos = integer    -&gt; integer</span>
<a name="l01368"></a>01368 <span class="comment"> *</span>
<a name="l01369"></a>01369 <span class="comment"> *  Seeks to the given position (in bytes) in &lt;em&gt;ios&lt;/em&gt;.</span>
<a name="l01370"></a>01370 <span class="comment"> *</span>
<a name="l01371"></a>01371 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l01372"></a>01372 <span class="comment"> *     f.pos = 17</span>
<a name="l01373"></a>01373 <span class="comment"> *     f.gets   #=&gt; &quot;This is line two\n&quot;</span>
<a name="l01374"></a>01374 <span class="comment"> */</span>
<a name="l01375"></a>01375 
<a name="l01376"></a>01376 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01377"></a><a class="code" href="../../df/d0a/io_8c.html#abbcb6b6b0e2f4b79f198c78c203deea6">01377</a> <a class="code" href="../../df/d0a/io_8c.html#abbcb6b6b0e2f4b79f198c78c203deea6">rb_io_set_pos</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> offset)
<a name="l01378"></a>01378 {
<a name="l01379"></a>01379     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01380"></a>01380     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> pos;
<a name="l01381"></a>01381 
<a name="l01382"></a>01382     pos = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#adc3ee80338c33b87afa2a7047287c96f">NUM2OFFT</a>(offset);
<a name="l01383"></a>01383     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l01384"></a>01384     pos = <a class="code" href="../../df/d0a/io_8c.html#a08a06c385029a1ebff645c082bf5b839">io_seek</a>(fptr, pos, <a class="code" href="../../df/d0a/io_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">SEEK_SET</a>);
<a name="l01385"></a>01385     <span class="keywordflow">if</span> (pos &lt; 0 &amp;&amp; <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l01386"></a>01386 
<a name="l01387"></a>01387     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0272a51f5dbad0d6413d4de5d24c4aad">OFFT2NUM</a>(pos);
<a name="l01388"></a>01388 }
<a name="l01389"></a>01389 
<a name="l01390"></a>01390 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d0a/io_8c.html#a89693737d8688aa1fea03c70711799ab">clear_readconv</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr);
<a name="l01391"></a>01391 
<a name="l01392"></a>01392 <span class="comment">/*</span>
<a name="l01393"></a>01393 <span class="comment"> *  call-seq:</span>
<a name="l01394"></a>01394 <span class="comment"> *     ios.rewind    -&gt; 0</span>
<a name="l01395"></a>01395 <span class="comment"> *</span>
<a name="l01396"></a>01396 <span class="comment"> *  Positions &lt;em&gt;ios&lt;/em&gt; to the beginning of input, resetting</span>
<a name="l01397"></a>01397 <span class="comment"> *  &lt;code&gt;lineno&lt;/code&gt; to zero.</span>
<a name="l01398"></a>01398 <span class="comment"> *</span>
<a name="l01399"></a>01399 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l01400"></a>01400 <span class="comment"> *     f.readline   #=&gt; &quot;This is line one\n&quot;</span>
<a name="l01401"></a>01401 <span class="comment"> *     f.rewind     #=&gt; 0</span>
<a name="l01402"></a>01402 <span class="comment"> *     f.lineno     #=&gt; 0</span>
<a name="l01403"></a>01403 <span class="comment"> *     f.readline   #=&gt; &quot;This is line one\n&quot;</span>
<a name="l01404"></a>01404 <span class="comment"> *</span>
<a name="l01405"></a>01405 <span class="comment"> *  Note that it cannot be used with streams such as pipes, ttys, and sockets.</span>
<a name="l01406"></a>01406 <span class="comment"> */</span>
<a name="l01407"></a>01407 
<a name="l01408"></a>01408 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01409"></a><a class="code" href="../../df/d0a/io_8c.html#a2990bd35f03a7105058cc973bb5d2ce5">01409</a> <a class="code" href="../../df/d0a/io_8c.html#a2990bd35f03a7105058cc973bb5d2ce5">rb_io_rewind</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l01410"></a>01410 {
<a name="l01411"></a>01411     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01412"></a>01412 
<a name="l01413"></a>01413     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l01414"></a>01414     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a08a06c385029a1ebff645c082bf5b839">io_seek</a>(fptr, 0L, 0) &lt; 0 &amp;&amp; <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l01415"></a>01415 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l01416"></a>01416 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (GetFileType((HANDLE)<a class="code" href="../../dc/db1/win32_8h.html#a1955cd10ac395eb8442b50577b1e968e">rb_w32_get_osfhandle</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>)) == FILE_TYPE_DISK) {
<a name="l01417"></a>01417         <a class="code" href="../../dc/db1/win32_8h.html#ad352c8c2259cb51bd490b1dfdae5f784">fsync</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>);
<a name="l01418"></a>01418     }
<a name="l01419"></a>01419 <span class="preprocessor">#endif</span>
<a name="l01420"></a>01420 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (io == <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file) {
<a name="l01421"></a>01421         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno -= fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a397be62fbdfe88a3763377f262241ca7">lineno</a>;
<a name="l01422"></a>01422     }
<a name="l01423"></a>01423     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a397be62fbdfe88a3763377f262241ca7">lineno</a> = 0;
<a name="l01424"></a>01424     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>) {
<a name="l01425"></a>01425         <a class="code" href="../../df/d0a/io_8c.html#a89693737d8688aa1fea03c70711799ab">clear_readconv</a>(fptr);
<a name="l01426"></a>01426     }
<a name="l01427"></a>01427 
<a name="l01428"></a>01428     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0);
<a name="l01429"></a>01429 }
<a name="l01430"></a>01430 
<a name="l01431"></a>01431 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01432"></a><a class="code" href="../../df/d0a/io_8c.html#a7d1e7b95139715aa6fa393b30e6a39e8">01432</a> <a class="code" href="../../df/d0a/io_8c.html#a7d1e7b95139715aa6fa393b30e6a39e8">io_fillbuf</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l01433"></a>01433 {
<a name="l01434"></a>01434     ssize_t r;
<a name="l01435"></a>01435 
<a name="l01436"></a>01436     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01437"></a>01437         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = 0;
<a name="l01438"></a>01438         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> = 0;
<a name="l01439"></a>01439         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a> = <a class="code" href="../../df/d0a/io_8c.html#ab6a00d3d101f364c9acbbae275cef69a">IO_RBUF_CAPA_FOR</a>(fptr);
<a name="l01440"></a>01440         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a79041aa2bc7439c11906a86f82a52eb6">ALLOC_N</a>(<span class="keywordtype">char</span>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>);
<a name="l01441"></a>01441 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l01442"></a>01442 <span class="preprocessor"></span>        fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>--;
<a name="l01443"></a>01443 <span class="preprocessor">#endif</span>
<a name="l01444"></a>01444 <span class="preprocessor"></span>    }
<a name="l01445"></a>01445     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> == 0) {
<a name="l01446"></a>01446       retry:
<a name="l01447"></a>01447         {
<a name="l01448"></a>01448             r = <a class="code" href="../../df/d0a/io_8c.html#aa992ea0a36c7c173ae889134907d2b22">rb_read_internal</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>);
<a name="l01449"></a>01449         }
<a name="l01450"></a>01450         <span class="keywordflow">if</span> (r &lt; 0) {
<a name="l01451"></a>01451             <span class="keywordflow">if</span> (<a class="code" href="../../dc/dac/io_8h.html#aef370f8ba67623893a3b559bf27b30e3">rb_io_wait_readable</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>))
<a name="l01452"></a>01452                 <span class="keywordflow">goto</span> retry;
<a name="l01453"></a>01453             <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l01454"></a>01454         }
<a name="l01455"></a>01455         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = 0;
<a name="l01456"></a>01456         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> = (int)r; <span class="comment">/* r should be &lt;= rbuf_capa */</span>
<a name="l01457"></a>01457         <span class="keywordflow">if</span> (r == 0)
<a name="l01458"></a>01458             <span class="keywordflow">return</span> -1; <span class="comment">/* EOF */</span>
<a name="l01459"></a>01459     }
<a name="l01460"></a>01460     <span class="keywordflow">return</span> 0;
<a name="l01461"></a>01461 }
<a name="l01462"></a>01462 
<a name="l01463"></a>01463 <span class="comment">/*</span>
<a name="l01464"></a>01464 <span class="comment"> *  call-seq:</span>
<a name="l01465"></a>01465 <span class="comment"> *     ios.eof     -&gt; true or false</span>
<a name="l01466"></a>01466 <span class="comment"> *     ios.eof?    -&gt; true or false</span>
<a name="l01467"></a>01467 <span class="comment"> *</span>
<a name="l01468"></a>01468 <span class="comment"> *  Returns true if &lt;em&gt;ios&lt;/em&gt; is at end of file that means</span>
<a name="l01469"></a>01469 <span class="comment"> *  there are no more data to read.</span>
<a name="l01470"></a>01470 <span class="comment"> *  The stream must be opened for reading or an &lt;code&gt;IOError&lt;/code&gt; will be</span>
<a name="l01471"></a>01471 <span class="comment"> *  raised.</span>
<a name="l01472"></a>01472 <span class="comment"> *</span>
<a name="l01473"></a>01473 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l01474"></a>01474 <span class="comment"> *     dummy = f.readlines</span>
<a name="l01475"></a>01475 <span class="comment"> *     f.eof   #=&gt; true</span>
<a name="l01476"></a>01476 <span class="comment"> *</span>
<a name="l01477"></a>01477 <span class="comment"> *  If &lt;em&gt;ios&lt;/em&gt; is a stream such as pipe or socket, &lt;code&gt;IO#eof?&lt;/code&gt;</span>
<a name="l01478"></a>01478 <span class="comment"> *  blocks until the other end sends some data or closes it.</span>
<a name="l01479"></a>01479 <span class="comment"> *</span>
<a name="l01480"></a>01480 <span class="comment"> *     r, w = IO.pipe</span>
<a name="l01481"></a>01481 <span class="comment"> *     Thread.new { sleep 1; w.close }</span>
<a name="l01482"></a>01482 <span class="comment"> *     r.eof?  #=&gt; true after 1 second blocking</span>
<a name="l01483"></a>01483 <span class="comment"> *</span>
<a name="l01484"></a>01484 <span class="comment"> *     r, w = IO.pipe</span>
<a name="l01485"></a>01485 <span class="comment"> *     Thread.new { sleep 1; w.puts &quot;a&quot; }</span>
<a name="l01486"></a>01486 <span class="comment"> *     r.eof?  #=&gt; false after 1 second blocking</span>
<a name="l01487"></a>01487 <span class="comment"> *</span>
<a name="l01488"></a>01488 <span class="comment"> *     r, w = IO.pipe</span>
<a name="l01489"></a>01489 <span class="comment"> *     r.eof?  # blocks forever</span>
<a name="l01490"></a>01490 <span class="comment"> *</span>
<a name="l01491"></a>01491 <span class="comment"> *  Note that &lt;code&gt;IO#eof?&lt;/code&gt; reads data to the input byte buffer.</span>
<a name="l01492"></a>01492 <span class="comment"> *  So &lt;code&gt;IO#sysread&lt;/code&gt; may not behave as you intend with</span>
<a name="l01493"></a>01493 <span class="comment"> *  &lt;code&gt;IO#eof?&lt;/code&gt;, unless you call &lt;code&gt;IO#rewind&lt;/code&gt;</span>
<a name="l01494"></a>01494 <span class="comment"> *  first (which is not available for some streams).</span>
<a name="l01495"></a>01495 <span class="comment"> */</span>
<a name="l01496"></a>01496 
<a name="l01497"></a>01497 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01498"></a><a class="code" href="../../df/d0a/io_8c.html#a814470758df8ff7fe351c120a4d98176">01498</a> <a class="code" href="../../db/d2e/intern_8h.html#a25dc0631238847713d9cb4ea9bebdb13">rb_io_eof</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l01499"></a>01499 {
<a name="l01500"></a>01500     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01501"></a>01501 
<a name="l01502"></a>01502     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l01503"></a>01503     <a class="code" href="../../dc/dac/io_8h.html#acbd19ff86a565ed9e9f15e4f49736f3d">rb_io_check_char_readable</a>(fptr);
<a name="l01504"></a>01504 
<a name="l01505"></a>01505     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#aa0377d67a404cdeebc3ad2ceab0ef054">READ_CHAR_PENDING</a>(fptr)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l01506"></a>01506     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a38357513887e9cae9c0b4a5dc0d4007e">READ_DATA_PENDING</a>(fptr)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l01507"></a>01507     <a class="code" href="../../df/d0a/io_8c.html#a704f29b50a37b53c4a9f4f876d350f0d">READ_CHECK</a>(fptr);
<a name="l01508"></a>01508 <span class="preprocessor">#if defined(RUBY_TEST_CRLF_ENVIRONMENT) || defined(_WIN32)</span>
<a name="l01509"></a>01509 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a92621ca418c11e96d4862166f9076a73">NEED_READCONV</a>(fptr) &amp;&amp; <a class="code" href="../../df/d0a/io_8c.html#a8a6ac07e9b2ef3f2e60b2f16f62196c3">NEED_NEWLINE_DECORATOR_ON_READ</a>(fptr)) {
<a name="l01510"></a>01510         <span class="keywordflow">return</span> eof(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>) ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l01511"></a>01511     }
<a name="l01512"></a>01512 <span class="preprocessor">#endif</span>
<a name="l01513"></a>01513 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a7d1e7b95139715aa6fa393b30e6a39e8">io_fillbuf</a>(fptr) &lt; 0) {
<a name="l01514"></a>01514         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l01515"></a>01515     }
<a name="l01516"></a>01516     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l01517"></a>01517 }
<a name="l01518"></a>01518 
<a name="l01519"></a>01519 <span class="comment">/*</span>
<a name="l01520"></a>01520 <span class="comment"> *  call-seq:</span>
<a name="l01521"></a>01521 <span class="comment"> *     ios.sync    -&gt; true or false</span>
<a name="l01522"></a>01522 <span class="comment"> *</span>
<a name="l01523"></a>01523 <span class="comment"> *  Returns the current ``sync mode&apos;&apos; of &lt;em&gt;ios&lt;/em&gt;. When sync mode is</span>
<a name="l01524"></a>01524 <span class="comment"> *  true, all output is immediately flushed to the underlying operating</span>
<a name="l01525"></a>01525 <span class="comment"> *  system and is not buffered by Ruby internally. See also</span>
<a name="l01526"></a>01526 <span class="comment"> *  &lt;code&gt;IO#fsync&lt;/code&gt;.</span>
<a name="l01527"></a>01527 <span class="comment"> *</span>
<a name="l01528"></a>01528 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l01529"></a>01529 <span class="comment"> *     f.sync   #=&gt; false</span>
<a name="l01530"></a>01530 <span class="comment"> */</span>
<a name="l01531"></a>01531 
<a name="l01532"></a>01532 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01533"></a><a class="code" href="../../df/d0a/io_8c.html#a276e193f9a2406f345608aabfcb2e9aa">01533</a> <a class="code" href="../../df/d0a/io_8c.html#a276e193f9a2406f345608aabfcb2e9aa">rb_io_sync</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l01534"></a>01534 {
<a name="l01535"></a>01535     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01536"></a>01536 
<a name="l01537"></a>01537     io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l01538"></a>01538     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l01539"></a>01539     <span class="keywordflow">return</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a95a89e4b35429fb51d7c3e52ec405d90">FMODE_SYNC</a>) ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l01540"></a>01540 }
<a name="l01541"></a>01541 
<a name="l01542"></a>01542 <span class="comment">/*</span>
<a name="l01543"></a>01543 <span class="comment"> *  call-seq:</span>
<a name="l01544"></a>01544 <span class="comment"> *     ios.sync = boolean   -&gt; boolean</span>
<a name="l01545"></a>01545 <span class="comment"> *</span>
<a name="l01546"></a>01546 <span class="comment"> *  Sets the ``sync mode&apos;&apos; to &lt;code&gt;true&lt;/code&gt; or &lt;code&gt;false&lt;/code&gt;.</span>
<a name="l01547"></a>01547 <span class="comment"> *  When sync mode is true, all output is immediately flushed to the</span>
<a name="l01548"></a>01548 <span class="comment"> *  underlying operating system and is not buffered internally. Returns</span>
<a name="l01549"></a>01549 <span class="comment"> *  the new state. See also &lt;code&gt;IO#fsync&lt;/code&gt;.</span>
<a name="l01550"></a>01550 <span class="comment"> *</span>
<a name="l01551"></a>01551 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l01552"></a>01552 <span class="comment"> *     f.sync = true</span>
<a name="l01553"></a>01553 <span class="comment"> *</span>
<a name="l01554"></a>01554 <span class="comment"> *  &lt;em&gt;(produces no output)&lt;/em&gt;</span>
<a name="l01555"></a>01555 <span class="comment"> */</span>
<a name="l01556"></a>01556 
<a name="l01557"></a>01557 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01558"></a><a class="code" href="../../df/d0a/io_8c.html#acfe156cb7906a6541fd2ffb1e1d86cb4">01558</a> <a class="code" href="../../df/d0a/io_8c.html#acfe156cb7906a6541fd2ffb1e1d86cb4">rb_io_set_sync</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> sync)
<a name="l01559"></a>01559 {
<a name="l01560"></a>01560     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01561"></a>01561 
<a name="l01562"></a>01562     io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l01563"></a>01563     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l01564"></a>01564     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(sync)) {
<a name="l01565"></a>01565         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> |= <a class="code" href="../../dc/dac/io_8h.html#a95a89e4b35429fb51d7c3e52ec405d90">FMODE_SYNC</a>;
<a name="l01566"></a>01566     }
<a name="l01567"></a>01567     <span class="keywordflow">else</span> {
<a name="l01568"></a>01568         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp;= ~<a class="code" href="../../dc/dac/io_8h.html#a95a89e4b35429fb51d7c3e52ec405d90">FMODE_SYNC</a>;
<a name="l01569"></a>01569     }
<a name="l01570"></a>01570     <span class="keywordflow">return</span> sync;
<a name="l01571"></a>01571 }
<a name="l01572"></a>01572 
<a name="l01573"></a>01573 <span class="preprocessor">#ifdef HAVE_FSYNC</span>
<a name="l01574"></a>01574 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> nogvl_fsync(<span class="keywordtype">void</span> *<a class="code" href="../../d3/d61/structbinwrite__arg.html#a096a5b8509da51333671e8956119c39f">ptr</a>)
<a name="l01575"></a>01575 {
<a name="l01576"></a>01576     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr = ptr;
<a name="l01577"></a>01577 
<a name="l01578"></a>01578     <span class="keywordflow">return</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)<a class="code" href="../../dc/db1/win32_8h.html#ad352c8c2259cb51bd490b1dfdae5f784">fsync</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>);
<a name="l01579"></a>01579 }
<a name="l01580"></a>01580 
<a name="l01581"></a>01581 <span class="comment">/*</span>
<a name="l01582"></a>01582 <span class="comment"> *  call-seq:</span>
<a name="l01583"></a>01583 <span class="comment"> *     ios.fsync   -&gt; 0 or nil</span>
<a name="l01584"></a>01584 <span class="comment"> *</span>
<a name="l01585"></a>01585 <span class="comment"> *  Immediately writes all buffered data in &lt;em&gt;ios&lt;/em&gt; to disk.</span>
<a name="l01586"></a>01586 <span class="comment"> *  Note that &lt;code&gt;fsync&lt;/code&gt; differs from</span>
<a name="l01587"></a>01587 <span class="comment"> *  using &lt;code&gt;IO#sync=&lt;/code&gt;. The latter ensures that data is flushed</span>
<a name="l01588"></a>01588 <span class="comment"> *  from Ruby&apos;s buffers, but doesn&apos;t not guarantee that the underlying</span>
<a name="l01589"></a>01589 <span class="comment"> *  operating system actually writes it to disk.</span>
<a name="l01590"></a>01590 <span class="comment"> *</span>
<a name="l01591"></a>01591 <span class="comment"> *  &lt;code&gt;NotImplementedError&lt;/code&gt; is raised</span>
<a name="l01592"></a>01592 <span class="comment"> *  if the underlying operating system does not support &lt;em&gt;fsync(2)&lt;/em&gt;.</span>
<a name="l01593"></a>01593 <span class="comment"> */</span>
<a name="l01594"></a>01594 
<a name="l01595"></a>01595 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01596"></a>01596 <a class="code" href="../../df/d0a/io_8c.html#aa68742bd88c7650ea90208b70d080d0d">rb_io_fsync</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l01597"></a>01597 {
<a name="l01598"></a>01598     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01599"></a>01599 
<a name="l01600"></a>01600     io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l01601"></a>01601     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l01602"></a>01602 
<a name="l01603"></a>01603     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(fptr) &lt; 0)
<a name="l01604"></a>01604         <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l01605"></a>01605 <span class="preprocessor">#ifndef _WIN32  </span><span class="comment">/* already called in io_fflush() */</span>
<a name="l01606"></a>01606     <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)<a class="code" href="../../d3/de7/thread_8c.html#af541b78962a7376bf184693fc4144441">rb_thread_io_blocking_region</a>(nogvl_fsync, fptr, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>) &lt; 0)
<a name="l01607"></a>01607         <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l01608"></a>01608 <span class="preprocessor">#endif</span>
<a name="l01609"></a>01609 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0);
<a name="l01610"></a>01610 }
<a name="l01611"></a>01611 <span class="preprocessor">#else</span>
<a name="l01612"></a><a class="code" href="../../df/d0a/io_8c.html#aa68742bd88c7650ea90208b70d080d0d">01612</a> <span class="preprocessor"></span><span class="preprocessor">#define rb_io_fsync rb_f_notimplement</span>
<a name="l01613"></a>01613 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01614"></a>01614 <span class="preprocessor"></span>
<a name="l01615"></a>01615 <span class="preprocessor">#ifdef HAVE_FDATASYNC</span>
<a name="l01616"></a>01616 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> nogvl_fdatasync(<span class="keywordtype">void</span> *ptr)
<a name="l01617"></a>01617 {
<a name="l01618"></a>01618     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr = ptr;
<a name="l01619"></a>01619 
<a name="l01620"></a>01620     <span class="keywordflow">return</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)fdatasync(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>);
<a name="l01621"></a>01621 }
<a name="l01622"></a>01622 
<a name="l01623"></a>01623 <span class="comment">/*</span>
<a name="l01624"></a>01624 <span class="comment"> *  call-seq:</span>
<a name="l01625"></a>01625 <span class="comment"> *     ios.fdatasync   -&gt; 0 or nil</span>
<a name="l01626"></a>01626 <span class="comment"> *</span>
<a name="l01627"></a>01627 <span class="comment"> *  Immediately writes all buffered data in &lt;em&gt;ios&lt;/em&gt; to disk.</span>
<a name="l01628"></a>01628 <span class="comment"> *</span>
<a name="l01629"></a>01629 <span class="comment"> *  If the underlying operating system does not support &lt;em&gt;fdatasync(2)&lt;/em&gt;,</span>
<a name="l01630"></a>01630 <span class="comment"> *  &lt;code&gt;IO#fsync&lt;/code&gt; is called instead (which might raise a</span>
<a name="l01631"></a>01631 <span class="comment"> *  &lt;code&gt;NotImplementedError&lt;/code&gt;).</span>
<a name="l01632"></a>01632 <span class="comment"> */</span>
<a name="l01633"></a>01633 
<a name="l01634"></a>01634 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01635"></a>01635 <a class="code" href="../../df/d0a/io_8c.html#ae7ae82560cc5e5b9042a822f9f7596d2">rb_io_fdatasync</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l01636"></a>01636 {
<a name="l01637"></a>01637     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01638"></a>01638 
<a name="l01639"></a>01639     io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l01640"></a>01640     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l01641"></a>01641 
<a name="l01642"></a>01642     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(fptr) &lt; 0)
<a name="l01643"></a>01643         <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l01644"></a>01644 
<a name="l01645"></a>01645     <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)<a class="code" href="../../d3/de7/thread_8c.html#af541b78962a7376bf184693fc4144441">rb_thread_io_blocking_region</a>(nogvl_fdatasync, fptr, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>) == 0)
<a name="l01646"></a>01646         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0);
<a name="l01647"></a>01647 
<a name="l01648"></a>01648     <span class="comment">/* fall back */</span>
<a name="l01649"></a>01649     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#aa68742bd88c7650ea90208b70d080d0d">rb_io_fsync</a>(io);
<a name="l01650"></a>01650 }
<a name="l01651"></a>01651 <span class="preprocessor">#else</span>
<a name="l01652"></a><a class="code" href="../../df/d0a/io_8c.html#ae7ae82560cc5e5b9042a822f9f7596d2">01652</a> <span class="preprocessor"></span><span class="preprocessor">#define rb_io_fdatasync rb_io_fsync</span>
<a name="l01653"></a>01653 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01654"></a>01654 <span class="preprocessor"></span>
<a name="l01655"></a>01655 <span class="comment">/*</span>
<a name="l01656"></a>01656 <span class="comment"> *  call-seq:</span>
<a name="l01657"></a>01657 <span class="comment"> *     ios.fileno    -&gt; fixnum</span>
<a name="l01658"></a>01658 <span class="comment"> *     ios.to_i      -&gt; fixnum</span>
<a name="l01659"></a>01659 <span class="comment"> *</span>
<a name="l01660"></a>01660 <span class="comment"> *  Returns an integer representing the numeric file descriptor for</span>
<a name="l01661"></a>01661 <span class="comment"> *  &lt;em&gt;ios&lt;/em&gt;.</span>
<a name="l01662"></a>01662 <span class="comment"> *</span>
<a name="l01663"></a>01663 <span class="comment"> *     $stdin.fileno    #=&gt; 0</span>
<a name="l01664"></a>01664 <span class="comment"> *     $stdout.fileno   #=&gt; 1</span>
<a name="l01665"></a>01665 <span class="comment"> */</span>
<a name="l01666"></a>01666 
<a name="l01667"></a>01667 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01668"></a><a class="code" href="../../df/d0a/io_8c.html#a62dd820b5e3ae52bc5afc5afb5c2f3bd">01668</a> <a class="code" href="../../df/d0a/io_8c.html#a62dd820b5e3ae52bc5afc5afb5c2f3bd">rb_io_fileno</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l01669"></a>01669 {
<a name="l01670"></a>01670     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01671"></a>01671     <span class="keywordtype">int</span> fd;
<a name="l01672"></a>01672 
<a name="l01673"></a>01673     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l01674"></a>01674     fd = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>;
<a name="l01675"></a>01675     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(fd);
<a name="l01676"></a>01676 }
<a name="l01677"></a>01677 
<a name="l01678"></a>01678 
<a name="l01679"></a>01679 <span class="comment">/*</span>
<a name="l01680"></a>01680 <span class="comment"> *  call-seq:</span>
<a name="l01681"></a>01681 <span class="comment"> *     ios.pid    -&gt; fixnum</span>
<a name="l01682"></a>01682 <span class="comment"> *</span>
<a name="l01683"></a>01683 <span class="comment"> *  Returns the process ID of a child process associated with</span>
<a name="l01684"></a>01684 <span class="comment"> *  &lt;em&gt;ios&lt;/em&gt;. This will be set by &lt;code&gt;IO.popen&lt;/code&gt;.</span>
<a name="l01685"></a>01685 <span class="comment"> *</span>
<a name="l01686"></a>01686 <span class="comment"> *     pipe = IO.popen(&quot;-&quot;)</span>
<a name="l01687"></a>01687 <span class="comment"> *     if pipe</span>
<a name="l01688"></a>01688 <span class="comment"> *       $stderr.puts &quot;In parent, child pid is #{pipe.pid}&quot;</span>
<a name="l01689"></a>01689 <span class="comment"> *     else</span>
<a name="l01690"></a>01690 <span class="comment"> *       $stderr.puts &quot;In child, pid is #{$$}&quot;</span>
<a name="l01691"></a>01691 <span class="comment"> *     end</span>
<a name="l01692"></a>01692 <span class="comment"> *</span>
<a name="l01693"></a>01693 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l01694"></a>01694 <span class="comment"> *</span>
<a name="l01695"></a>01695 <span class="comment"> *     In child, pid is 26209</span>
<a name="l01696"></a>01696 <span class="comment"> *     In parent, child pid is 26209</span>
<a name="l01697"></a>01697 <span class="comment"> */</span>
<a name="l01698"></a>01698 
<a name="l01699"></a>01699 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01700"></a><a class="code" href="../../df/d0a/io_8c.html#a240fbf1fce3d93824fc901c8a717d68a">01700</a> <a class="code" href="../../df/d0a/io_8c.html#a240fbf1fce3d93824fc901c8a717d68a">rb_io_pid</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l01701"></a>01701 {
<a name="l01702"></a>01702     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01703"></a>01703 
<a name="l01704"></a>01704     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l01705"></a>01705     <span class="keywordflow">if</span> (!fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6080b18e6883f70d36a1c1554761ccfe">pid</a>)
<a name="l01706"></a>01706         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01707"></a>01707     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a26099e66edea0c7f6870bcb528841645">PIDT2NUM</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6080b18e6883f70d36a1c1554761ccfe">pid</a>);
<a name="l01708"></a>01708 }
<a name="l01709"></a>01709 
<a name="l01710"></a>01710 
<a name="l01711"></a>01711 <span class="comment">/*</span>
<a name="l01712"></a>01712 <span class="comment"> * call-seq:</span>
<a name="l01713"></a>01713 <span class="comment"> *   ios.inspect   -&gt; string</span>
<a name="l01714"></a>01714 <span class="comment"> *</span>
<a name="l01715"></a>01715 <span class="comment"> * Return a string describing this IO object.</span>
<a name="l01716"></a>01716 <span class="comment"> */</span>
<a name="l01717"></a>01717 
<a name="l01718"></a>01718 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01719"></a><a class="code" href="../../df/d0a/io_8c.html#aadf9911657d145787d4f1b196de78913">01719</a> <a class="code" href="../../df/d0a/io_8c.html#aadf9911657d145787d4f1b196de78913">rb_io_inspect</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj)
<a name="l01720"></a>01720 {
<a name="l01721"></a>01721     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01722"></a>01722     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d8/d90/nkf_8c.html#a5ea5ac7abf5cce39283e422add1067d5">result</a>;
<a name="l01723"></a>01723     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> closed[] = <span class="stringliteral">&quot; (closed)&quot;</span>;
<a name="l01724"></a>01724 
<a name="l01725"></a>01725     fptr = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(<a class="code" href="../../dc/dac/io_8h.html#a68e7deaa22cac98e654c80bd7fe187f4">rb_io_taint_check</a>(obj))-&gt;fptr;
<a name="l01726"></a>01726     <span class="keywordflow">if</span> (!fptr) <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a24afa0db60cabea2fb47545b1ff9edf4">rb_any_to_s</a>(obj);
<a name="l01727"></a>01727     result = <a class="code" href="../../db/d2e/intern_8h.html#a2b9cc485b0aa1dc270744b8b9eb47569">rb_str_new_cstr</a>(<span class="stringliteral">&quot;#&lt;&quot;</span>);
<a name="l01728"></a>01728     <a class="code" href="../../db/d2e/intern_8h.html#ab592dcd9e193dea76fb0ff58b5d907e4">rb_str_append</a>(result, <a class="code" href="../../db/d2e/intern_8h.html#a006647827acc7cce9e940e5f7fa3a1b8">rb_class_name</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad07df58de9895cbc33c10f02540d2d4d">CLASS_OF</a>(obj)));
<a name="l01729"></a>01729     <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(result, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l01730"></a>01730     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>)) {
<a name="l01731"></a>01731         <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> &lt; 0) {
<a name="l01732"></a>01732             <a class="code" href="../../db/d2e/intern_8h.html#a4e3e3ccf959b5db6c125a68e1e1db0a3">rb_str_cat</a>(result, closed+1, <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(closed)-1);
<a name="l01733"></a>01733         }
<a name="l01734"></a>01734         <span class="keywordflow">else</span> {
<a name="l01735"></a>01735             <a class="code" href="../../d9/d2d/sprintf_8c.html#a01a3022a41f713613342bbaba9ac9359">rb_str_catf</a>(result, <span class="stringliteral">&quot;fd %d&quot;</span>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>);
<a name="l01736"></a>01736         }
<a name="l01737"></a>01737     }
<a name="l01738"></a>01738     <span class="keywordflow">else</span> {
<a name="l01739"></a>01739         <a class="code" href="../../db/d2e/intern_8h.html#ab592dcd9e193dea76fb0ff58b5d907e4">rb_str_append</a>(result, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l01740"></a>01740         <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> &lt; 0) {
<a name="l01741"></a>01741             <a class="code" href="../../db/d2e/intern_8h.html#a4e3e3ccf959b5db6c125a68e1e1db0a3">rb_str_cat</a>(result, closed, <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(closed));
<a name="l01742"></a>01742         }
<a name="l01743"></a>01743     }
<a name="l01744"></a>01744     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(result, <span class="stringliteral">&quot;&gt;&quot;</span>);
<a name="l01745"></a>01745 }
<a name="l01746"></a>01746 
<a name="l01747"></a>01747 <span class="comment">/*</span>
<a name="l01748"></a>01748 <span class="comment"> *  call-seq:</span>
<a name="l01749"></a>01749 <span class="comment"> *     ios.to_io  -&gt;  ios</span>
<a name="l01750"></a>01750 <span class="comment"> *</span>
<a name="l01751"></a>01751 <span class="comment"> *  Returns &lt;em&gt;ios&lt;/em&gt;.</span>
<a name="l01752"></a>01752 <span class="comment"> */</span>
<a name="l01753"></a>01753 
<a name="l01754"></a>01754 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01755"></a><a class="code" href="../../df/d0a/io_8c.html#ac204e4088139945a77d8f6fa621a66d8">01755</a> <a class="code" href="../../df/d0a/io_8c.html#ac204e4088139945a77d8f6fa621a66d8">rb_io_to_io</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l01756"></a>01756 {
<a name="l01757"></a>01757     <span class="keywordflow">return</span> io;
<a name="l01758"></a>01758 }
<a name="l01759"></a>01759 
<a name="l01760"></a>01760 <span class="comment">/* reading functions */</span>
<a name="l01761"></a>01761 <span class="keyword">static</span> <span class="keywordtype">long</span>
<a name="l01762"></a><a class="code" href="../../df/d0a/io_8c.html#af0cb01766b96b9ba7f84b4ebd4e2099d">01762</a> <a class="code" href="../../df/d0a/io_8c.html#af0cb01766b96b9ba7f84b4ebd4e2099d">read_buffered_data</a>(<span class="keywordtype">char</span> *ptr, <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l01763"></a>01763 {
<a name="l01764"></a>01764     <span class="keywordtype">int</span> n;
<a name="l01765"></a>01765 
<a name="l01766"></a>01766     n = <a class="code" href="../../df/d0a/io_8c.html#a3d1f21b592c8d0533a4eb4795837f453">READ_DATA_PENDING_COUNT</a>(fptr);
<a name="l01767"></a>01767     <span class="keywordflow">if</span> (n &lt;= 0) <span class="keywordflow">return</span> 0;
<a name="l01768"></a>01768     <span class="keywordflow">if</span> (n &gt; len) n = (int)len;
<a name="l01769"></a>01769     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aad09de334c9b8c7f717d314b14679e62">MEMMOVE</a>(ptr, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, <span class="keywordtype">char</span>, n);
<a name="l01770"></a>01770     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> += n;
<a name="l01771"></a>01771     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> -= n;
<a name="l01772"></a>01772     <span class="keywordflow">return</span> n;
<a name="l01773"></a>01773 }
<a name="l01774"></a>01774 
<a name="l01775"></a>01775 <span class="keyword">static</span> <span class="keywordtype">long</span>
<a name="l01776"></a><a class="code" href="../../df/d0a/io_8c.html#a5a1799519d1aabc3c499f9713686967e">01776</a> <a class="code" href="../../df/d0a/io_8c.html#a5a1799519d1aabc3c499f9713686967e">io_bufread</a>(<span class="keywordtype">char</span> *ptr, <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l01777"></a>01777 {
<a name="l01778"></a>01778     <span class="keywordtype">long</span> offset = 0;
<a name="l01779"></a>01779     <span class="keywordtype">long</span> n = len;
<a name="l01780"></a>01780     <span class="keywordtype">long</span> c;
<a name="l01781"></a>01781 
<a name="l01782"></a>01782     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a38357513887e9cae9c0b4a5dc0d4007e">READ_DATA_PENDING</a>(fptr) == 0) {
<a name="l01783"></a>01783         <span class="keywordflow">while</span> (n &gt; 0) {
<a name="l01784"></a>01784           again:
<a name="l01785"></a>01785             c = <a class="code" href="../../df/d0a/io_8c.html#aa992ea0a36c7c173ae889134907d2b22">rb_read_internal</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, ptr+offset, n);
<a name="l01786"></a>01786             <span class="keywordflow">if</span> (c == 0) <span class="keywordflow">break</span>;
<a name="l01787"></a>01787             <span class="keywordflow">if</span> (c &lt; 0) {
<a name="l01788"></a>01788                 <span class="keywordflow">if</span> (<a class="code" href="../../dc/dac/io_8h.html#aef370f8ba67623893a3b559bf27b30e3">rb_io_wait_readable</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>))
<a name="l01789"></a>01789                     <span class="keywordflow">goto</span> again;
<a name="l01790"></a>01790                 <span class="keywordflow">return</span> -1;
<a name="l01791"></a>01791             }
<a name="l01792"></a>01792             offset += c;
<a name="l01793"></a>01793             <span class="keywordflow">if</span> ((n -= c) &lt;= 0) <span class="keywordflow">break</span>;
<a name="l01794"></a>01794             <a class="code" href="../../db/d2e/intern_8h.html#a38e5ff660fd6c045c7242de575e8a5f2">rb_thread_wait_fd</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>);
<a name="l01795"></a>01795         }
<a name="l01796"></a>01796         <span class="keywordflow">return</span> len - n;
<a name="l01797"></a>01797     }
<a name="l01798"></a>01798 
<a name="l01799"></a>01799     <span class="keywordflow">while</span> (n &gt; 0) {
<a name="l01800"></a>01800         c = <a class="code" href="../../df/d0a/io_8c.html#af0cb01766b96b9ba7f84b4ebd4e2099d">read_buffered_data</a>(ptr+offset, n, fptr);
<a name="l01801"></a>01801         <span class="keywordflow">if</span> (c &gt; 0) {
<a name="l01802"></a>01802             offset += c;
<a name="l01803"></a>01803             <span class="keywordflow">if</span> ((n -= c) &lt;= 0) <span class="keywordflow">break</span>;
<a name="l01804"></a>01804         }
<a name="l01805"></a>01805         <a class="code" href="../../db/d2e/intern_8h.html#a38e5ff660fd6c045c7242de575e8a5f2">rb_thread_wait_fd</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>);
<a name="l01806"></a>01806         <a class="code" href="../../dc/dac/io_8h.html#a6b4f0c0735ecb278abd3f63059b5fc48">rb_io_check_closed</a>(fptr);
<a name="l01807"></a>01807         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a7d1e7b95139715aa6fa393b30e6a39e8">io_fillbuf</a>(fptr) &lt; 0) {
<a name="l01808"></a>01808             <span class="keywordflow">break</span>;
<a name="l01809"></a>01809         }
<a name="l01810"></a>01810     }
<a name="l01811"></a>01811     <span class="keywordflow">return</span> len - n;
<a name="l01812"></a>01812 }
<a name="l01813"></a>01813 
<a name="l01814"></a>01814 <span class="keyword">static</span> <span class="keywordtype">long</span>
<a name="l01815"></a><a class="code" href="../../df/d0a/io_8c.html#ae5495474957be7e97bd5e592f028bc86">01815</a> <a class="code" href="../../df/d0a/io_8c.html#ae5495474957be7e97bd5e592f028bc86">io_fread</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d61/structbinwrite__arg.html#acc80eaf17d78b8c08bbc26b0129a0698">str</a>, <span class="keywordtype">long</span> offset, <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l01816"></a>01816 {
<a name="l01817"></a>01817     <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l01818"></a>01818 
<a name="l01819"></a>01819     <a class="code" href="../../db/d2e/intern_8h.html#ac8be785eb014dbaac6d9daeba3cbaf17">rb_str_locktmp</a>(str);
<a name="l01820"></a>01820     len = <a class="code" href="../../df/d0a/io_8c.html#a5a1799519d1aabc3c499f9713686967e">io_bufread</a>(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str) + offset, <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str) - offset,
<a name="l01821"></a>01821                      fptr);
<a name="l01822"></a>01822     <a class="code" href="../../db/d2e/intern_8h.html#a027ec67101bdfadde1553c0a0a70c724">rb_str_unlocktmp</a>(str);
<a name="l01823"></a>01823     <span class="keywordflow">if</span> (len &lt; 0) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l01824"></a>01824     <span class="keywordflow">return</span> len;
<a name="l01825"></a>01825 }
<a name="l01826"></a>01826 
<a name="l01827"></a>01827 ssize_t
<a name="l01828"></a><a class="code" href="../../df/d0a/io_8c.html#a17bcea48bdb02e9a07b9d03341906f7d">01828</a> <a class="code" href="../../df/d0a/io_8c.html#a17bcea48bdb02e9a07b9d03341906f7d">rb_io_bufread</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <span class="keywordtype">void</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l01829"></a>01829 {
<a name="l01830"></a>01830     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l01831"></a>01831 
<a name="l01832"></a>01832     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l01833"></a>01833     <a class="code" href="../../dc/dac/io_8h.html#a8557569435da7f8a669908723fcd5e94">rb_io_check_readable</a>(fptr);
<a name="l01834"></a>01834     <span class="keywordflow">return</span> (ssize_t)<a class="code" href="../../df/d0a/io_8c.html#a5a1799519d1aabc3c499f9713686967e">io_bufread</a>(buf, (<span class="keywordtype">long</span>)size, fptr);
<a name="l01835"></a>01835 }
<a name="l01836"></a>01836 
<a name="l01837"></a><a class="code" href="../../df/d0a/io_8c.html#a33edaf0878967cface23772484fa2c97">01837</a> <span class="preprocessor">#define SMALLBUF 100</span>
<a name="l01838"></a>01838 <span class="preprocessor"></span>
<a name="l01839"></a>01839 <span class="keyword">static</span> <span class="keywordtype">long</span>
<a name="l01840"></a><a class="code" href="../../df/d0a/io_8c.html#a12126308ff477ec7e04e15db2f878285">01840</a> <a class="code" href="../../df/d0a/io_8c.html#a12126308ff477ec7e04e15db2f878285">remain_size</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l01841"></a>01841 {
<a name="l01842"></a>01842     <span class="keyword">struct </span><a class="code" href="../../dc/db1/win32_8h.html#a4feaac5e1913330bded57b059061965b">stat</a> st;
<a name="l01843"></a>01843     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> siz = <a class="code" href="../../df/d0a/io_8c.html#a3d1f21b592c8d0533a4eb4795837f453">READ_DATA_PENDING_COUNT</a>(fptr);
<a name="l01844"></a>01844     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> pos;
<a name="l01845"></a>01845 
<a name="l01846"></a>01846     <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#a8a2cf46df7f7017617df85cdb0afdc64">fstat</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, &amp;st) == 0  &amp;&amp; <a class="code" href="../../d6/d13/file_8c.html#abf68371159fa46b5cc47d0f3ac9ab723">S_ISREG</a>(st.st_mode)
<a name="l01847"></a>01847 #<span class="keywordflow">if</span> defined(__BEOS__) || defined(__HAIKU__)
<a name="l01848"></a>01848         &amp;&amp; (st.st_dev &gt; 3)
<a name="l01849"></a>01849 #endif
<a name="l01850"></a>01850         )
<a name="l01851"></a>01851     {
<a name="l01852"></a>01852         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(fptr) &lt; 0)
<a name="l01853"></a>01853             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l01854"></a>01854         pos = lseek(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, 0, <a class="code" href="../../df/d0a/io_8c.html#a4c8d0b76b470ba65a43ca46a88320f39">SEEK_CUR</a>);
<a name="l01855"></a>01855         <span class="keywordflow">if</span> (st.st_size &gt;= pos &amp;&amp; pos &gt;= 0) {
<a name="l01856"></a>01856             siz += st.st_size - pos;
<a name="l01857"></a>01857             <span class="keywordflow">if</span> (siz &gt; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a50fece4db74f09568b2938db583c5655">LONG_MAX</a>) {
<a name="l01858"></a>01858                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;file too big for single read&quot;</span>);
<a name="l01859"></a>01859             }
<a name="l01860"></a>01860         }
<a name="l01861"></a>01861     }
<a name="l01862"></a>01862     <span class="keywordflow">else</span> {
<a name="l01863"></a>01863         siz += BUFSIZ;
<a name="l01864"></a>01864     }
<a name="l01865"></a>01865     <span class="keywordflow">return</span> (<span class="keywordtype">long</span>)siz;
<a name="l01866"></a>01866 }
<a name="l01867"></a>01867 
<a name="l01868"></a>01868 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01869"></a><a class="code" href="../../df/d0a/io_8c.html#acd3c89cc4bd3aaef3dfea3b3fa2c6360">01869</a> <a class="code" href="../../df/d0a/io_8c.html#acd3c89cc4bd3aaef3dfea3b3fa2c6360">io_enc_str</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l01870"></a>01870 {
<a name="l01871"></a>01871     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afd75ea0cb81c17e76c73e593d1d8a860">OBJ_TAINT</a>(str);
<a name="l01872"></a>01872     <a class="code" href="../../d5/db5/encoding_8c.html#a150a6e3ac22ac3be8f8c2ccc74a28e7b">rb_enc_associate</a>(str, <a class="code" href="../../df/d0a/io_8c.html#aa3b568197b019bda6a9aea4fbe2153eb">io_read_encoding</a>(fptr));
<a name="l01873"></a>01873     <span class="keywordflow">return</span> str;
<a name="l01874"></a>01874 }
<a name="l01875"></a>01875 
<a name="l01876"></a>01876 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01877"></a><a class="code" href="../../df/d0a/io_8c.html#a7270c50b73afa5c8c999dacfab097524">01877</a> <a class="code" href="../../df/d0a/io_8c.html#a7270c50b73afa5c8c999dacfab097524">make_readconv</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <span class="keywordtype">int</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l01878"></a>01878 {
<a name="l01879"></a>01879     <span class="keywordflow">if</span> (!fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>) {
<a name="l01880"></a>01880         <span class="keywordtype">int</span> ecflags;
<a name="l01881"></a>01881         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ecopts;
<a name="l01882"></a>01882         <span class="keyword">const</span> <span class="keywordtype">char</span> *sname, *dname;
<a name="l01883"></a>01883         ecflags = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags &amp; ~<a class="code" href="../../d5/de3/encoding_8h.html#a614e230e6117b1a6f0d05fdedaab1e64">ECONV_NEWLINE_DECORATOR_WRITE_MASK</a>;
<a name="l01884"></a>01884         ecopts = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecopts;
<a name="l01885"></a>01885         <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc2) {
<a name="l01886"></a>01886             sname = <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc2);
<a name="l01887"></a>01887             dname = <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc);
<a name="l01888"></a>01888         }
<a name="l01889"></a>01889         <span class="keywordflow">else</span> {
<a name="l01890"></a>01890             sname = dname = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01891"></a>01891         }
<a name="l01892"></a>01892         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a> = <a class="code" href="../../d5/de3/encoding_8h.html#ac48226d977525efbbf4ed18ff36fce23">rb_econv_open_opts</a>(sname, dname, ecflags, ecopts);
<a name="l01893"></a>01893         <span class="keywordflow">if</span> (!fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>)
<a name="l01894"></a>01894             <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a0dbeff3af14fde49b20f00fde25057d0">rb_econv_open_exc</a>(sname, dname, ecflags));
<a name="l01895"></a>01895         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = 0;
<a name="l01896"></a>01896         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> = 0;
<a name="l01897"></a>01897         <span class="keywordflow">if</span> (size &lt; <a class="code" href="../../df/d0a/io_8c.html#a25b1881481548cbb177445366abf15e1">IO_CBUF_CAPA_MIN</a>) size = <a class="code" href="../../df/d0a/io_8c.html#a25b1881481548cbb177445366abf15e1">IO_CBUF_CAPA_MIN</a>;
<a name="l01898"></a>01898         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a> = size;
<a name="l01899"></a>01899         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a79041aa2bc7439c11906a86f82a52eb6">ALLOC_N</a>(<span class="keywordtype">char</span>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>);
<a name="l01900"></a>01900     }
<a name="l01901"></a>01901 }
<a name="l01902"></a>01902 
<a name="l01903"></a><a class="code" href="../../df/d0a/io_8c.html#ab937552cffc59b502c2fd1151ac75454">01903</a> <span class="preprocessor">#define MORE_CHAR_SUSPENDED Qtrue</span>
<a name="l01904"></a><a class="code" href="../../df/d0a/io_8c.html#adb561f38bf9315a2ec31e9f6926d0618">01904</a> <span class="preprocessor"></span><span class="preprocessor">#define MORE_CHAR_FINISHED Qnil</span>
<a name="l01905"></a>01905 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01906"></a><a class="code" href="../../df/d0a/io_8c.html#a5f2a2db79a24f8d30bdf95bca0c77a94">01906</a> <a class="code" href="../../df/d0a/io_8c.html#a5f2a2db79a24f8d30bdf95bca0c77a94">fill_cbuf</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <span class="keywordtype">int</span> ec_flags)
<a name="l01907"></a>01907 {
<a name="l01908"></a>01908     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ss, *sp, *se;
<a name="l01909"></a>01909     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ds, *<a class="code" href="../../db/d16/debug_8h.html#a08a47aff6867e5ae146382e66d2cc26b">dp</a>, *de;
<a name="l01910"></a>01910     <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a> res;
<a name="l01911"></a>01911     <span class="keywordtype">int</span> putbackable;
<a name="l01912"></a>01912     <span class="keywordtype">int</span> cbuf_len0;
<a name="l01913"></a>01913     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> exc;
<a name="l01914"></a>01914 
<a name="l01915"></a>01915     ec_flags |= <a class="code" href="../../d5/de3/encoding_8h.html#ab1eeed22e1b00841e21fa4715df0029e">ECONV_PARTIAL_INPUT</a>;
<a name="l01916"></a>01916 
<a name="l01917"></a>01917     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> == fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>)
<a name="l01918"></a>01918         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#ab937552cffc59b502c2fd1151ac75454">MORE_CHAR_SUSPENDED</a>; <span class="comment">/* cbuf full */</span>
<a name="l01919"></a>01919     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> == 0)
<a name="l01920"></a>01920         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = 0;
<a name="l01921"></a>01921     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> == fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>) {
<a name="l01922"></a>01922         <a class="code" href="../../d3/d90/missing_8h.html#a809a3e9326a0d3e5aa549b17085b057d">memmove</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>);
<a name="l01923"></a>01923         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = 0;
<a name="l01924"></a>01924     }
<a name="l01925"></a>01925 
<a name="l01926"></a>01926     cbuf_len0 = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>;
<a name="l01927"></a>01927 
<a name="l01928"></a>01928     <span class="keywordflow">while</span> (1) {
<a name="l01929"></a>01929         ss = sp = (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>;
<a name="l01930"></a>01930         se = sp + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>;
<a name="l01931"></a>01931         ds = dp = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>;
<a name="l01932"></a>01932         de = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>;
<a name="l01933"></a>01933         res = <a class="code" href="../../d5/de3/encoding_8h.html#a346451a419b3ce73da0d2323eb3238ee">rb_econv_convert</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>, &amp;sp, se, &amp;dp, de, ec_flags);
<a name="l01934"></a>01934         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> += (int)(sp - ss);
<a name="l01935"></a>01935         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> -= (int)(sp - ss);
<a name="l01936"></a>01936         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> += (int)(dp - ds);
<a name="l01937"></a>01937 
<a name="l01938"></a>01938         putbackable = <a class="code" href="../../d5/de3/encoding_8h.html#a3c4c5466e476fb10e4fe3c63ce08a97d">rb_econv_putbackable</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>);
<a name="l01939"></a>01939         <span class="keywordflow">if</span> (putbackable) {
<a name="l01940"></a>01940             <a class="code" href="../../d5/de3/encoding_8h.html#af225eb5773352c9eeddb42209047d591">rb_econv_putback</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> - putbackable, putbackable);
<a name="l01941"></a>01941             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> -= putbackable;
<a name="l01942"></a>01942             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> += putbackable;
<a name="l01943"></a>01943         }
<a name="l01944"></a>01944 
<a name="l01945"></a>01945         exc = <a class="code" href="../../d5/de3/encoding_8h.html#a97f7e97de80001465896aae6ae28731b">rb_econv_make_exception</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>);
<a name="l01946"></a>01946         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(exc))
<a name="l01947"></a>01947             <span class="keywordflow">return</span> exc;
<a name="l01948"></a>01948 
<a name="l01949"></a>01949         <span class="keywordflow">if</span> (cbuf_len0 != fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>)
<a name="l01950"></a>01950             <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#ab937552cffc59b502c2fd1151ac75454">MORE_CHAR_SUSPENDED</a>;
<a name="l01951"></a>01951 
<a name="l01952"></a>01952         <span class="keywordflow">if</span> (res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa50dc17a7e8399ca9dcd98a7b6e652764">econv_finished</a>) {
<a name="l01953"></a>01953             <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#adb561f38bf9315a2ec31e9f6926d0618">MORE_CHAR_FINISHED</a>;
<a name="l01954"></a>01954         }
<a name="l01955"></a>01955 
<a name="l01956"></a>01956         <span class="keywordflow">if</span> (res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>) {
<a name="l01957"></a>01957             <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> == 0) {
<a name="l01958"></a>01958                 <a class="code" href="../../df/d0a/io_8c.html#a704f29b50a37b53c4a9f4f876d350f0d">READ_CHECK</a>(fptr);
<a name="l01959"></a>01959                 <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a7d1e7b95139715aa6fa393b30e6a39e8">io_fillbuf</a>(fptr) == -1) {
<a name="l01960"></a>01960                     <span class="keywordflow">if</span> (!fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>) {
<a name="l01961"></a>01961                         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#adb561f38bf9315a2ec31e9f6926d0618">MORE_CHAR_FINISHED</a>;
<a name="l01962"></a>01962                     }
<a name="l01963"></a>01963                     ds = dp = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>;
<a name="l01964"></a>01964                     de = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>;
<a name="l01965"></a>01965                     res = <a class="code" href="../../d5/de3/encoding_8h.html#a346451a419b3ce73da0d2323eb3238ee">rb_econv_convert</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;dp, de, 0);
<a name="l01966"></a>01966                     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> += (int)(dp - ds);
<a name="l01967"></a>01967                     <a class="code" href="../../d5/de3/encoding_8h.html#aa4320e0c296f0bce29ad2d28044dbf62">rb_econv_check_error</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>);
<a name="l01968"></a>01968                     <span class="keywordflow">break</span>;
<a name="l01969"></a>01969                 }
<a name="l01970"></a>01970             }
<a name="l01971"></a>01971         }
<a name="l01972"></a>01972     }
<a name="l01973"></a>01973     <span class="keywordflow">if</span> (cbuf_len0 != fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>)
<a name="l01974"></a>01974         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#ab937552cffc59b502c2fd1151ac75454">MORE_CHAR_SUSPENDED</a>;
<a name="l01975"></a>01975 
<a name="l01976"></a>01976     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#adb561f38bf9315a2ec31e9f6926d0618">MORE_CHAR_FINISHED</a>;
<a name="l01977"></a>01977 }
<a name="l01978"></a>01978 
<a name="l01979"></a>01979 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01980"></a><a class="code" href="../../df/d0a/io_8c.html#a97e0f8279ec629d58f6690fa57e8704f">01980</a> <a class="code" href="../../df/d0a/io_8c.html#a97e0f8279ec629d58f6690fa57e8704f">more_char</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l01981"></a>01981 {
<a name="l01982"></a>01982     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v;
<a name="l01983"></a>01983     v = <a class="code" href="../../df/d0a/io_8c.html#a5f2a2db79a24f8d30bdf95bca0c77a94">fill_cbuf</a>(fptr, <a class="code" href="../../d5/de3/encoding_8h.html#a0311828d8ad5d3ba4bdce5fd9244301b">ECONV_AFTER_OUTPUT</a>);
<a name="l01984"></a>01984     <span class="keywordflow">if</span> (v != <a class="code" href="../../df/d0a/io_8c.html#ab937552cffc59b502c2fd1151ac75454">MORE_CHAR_SUSPENDED</a> &amp;&amp; v != <a class="code" href="../../df/d0a/io_8c.html#adb561f38bf9315a2ec31e9f6926d0618">MORE_CHAR_FINISHED</a>)
<a name="l01985"></a>01985         <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(v);
<a name="l01986"></a>01986     <span class="keywordflow">return</span> v;
<a name="l01987"></a>01987 }
<a name="l01988"></a>01988 
<a name="l01989"></a>01989 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01990"></a><a class="code" href="../../df/d0a/io_8c.html#a20e719e6f50c2ea1857b4d85ee09b2ea">01990</a> <a class="code" href="../../df/d0a/io_8c.html#a20e719e6f50c2ea1857b4d85ee09b2ea">io_shift_cbuf</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *strp)
<a name="l01991"></a>01991 {
<a name="l01992"></a>01992     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01993"></a>01993     <span class="keywordflow">if</span> (strp) {
<a name="l01994"></a>01994         str = *strp;
<a name="l01995"></a>01995         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str)) {
<a name="l01996"></a>01996             *strp = str = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, len);
<a name="l01997"></a>01997         }
<a name="l01998"></a>01998         <span class="keywordflow">else</span> {
<a name="l01999"></a>01999             <a class="code" href="../../db/d2e/intern_8h.html#a4e3e3ccf959b5db6c125a68e1e1db0a3">rb_str_cat</a>(str, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, len);
<a name="l02000"></a>02000         }
<a name="l02001"></a>02001         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afd75ea0cb81c17e76c73e593d1d8a860">OBJ_TAINT</a>(str);
<a name="l02002"></a>02002         <a class="code" href="../../d5/db5/encoding_8c.html#a150a6e3ac22ac3be8f8c2ccc74a28e7b">rb_enc_associate</a>(str, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc);
<a name="l02003"></a>02003     }
<a name="l02004"></a>02004     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> += len;
<a name="l02005"></a>02005     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> -= len;
<a name="l02006"></a>02006     <span class="comment">/* xxx: set coderange */</span>
<a name="l02007"></a>02007     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> == 0)
<a name="l02008"></a>02008         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = 0;
<a name="l02009"></a>02009     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>/2 &lt; fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>) {
<a name="l02010"></a>02010         <a class="code" href="../../d3/d90/missing_8h.html#a809a3e9326a0d3e5aa549b17085b057d">memmove</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>);
<a name="l02011"></a>02011         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = 0;
<a name="l02012"></a>02012     }
<a name="l02013"></a>02013     <span class="keywordflow">return</span> str;
<a name="l02014"></a>02014 }
<a name="l02015"></a>02015 
<a name="l02016"></a>02016 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02017"></a><a class="code" href="../../df/d0a/io_8c.html#aaffc2b4214d2165b476eaccee348f411">02017</a> <a class="code" href="../../df/d0a/io_8c.html#aaffc2b4214d2165b476eaccee348f411">io_setstrbuf</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *str,<span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>)
<a name="l02018"></a>02018 {
<a name="l02019"></a>02019 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l02020"></a>02020 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(*str)) {
<a name="l02021"></a>02021         *str = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(0, len+1);
<a name="l02022"></a>02022         <a class="code" href="../../d8/d81/ruby__missing_8h.html#a89ed8cb86ca6dd49d2db67adae809057">rb_str_set_len</a>(*str,len);
<a name="l02023"></a>02023     }
<a name="l02024"></a>02024     <span class="keywordflow">else</span> {
<a name="l02025"></a>02025         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(*str);
<a name="l02026"></a>02026         <a class="code" href="../../db/d2e/intern_8h.html#a63a6d05687cf812131dce11743581b9d">rb_str_modify</a>(*str);
<a name="l02027"></a>02027         <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(*str, len+1);
<a name="l02028"></a>02028         <a class="code" href="../../d8/d81/ruby__missing_8h.html#a89ed8cb86ca6dd49d2db67adae809057">rb_str_set_len</a>(*str,len);
<a name="l02029"></a>02029     }
<a name="l02030"></a>02030 <span class="preprocessor">#else</span>
<a name="l02031"></a>02031 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(*str)) {
<a name="l02032"></a>02032         *str = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(0, len);
<a name="l02033"></a>02033     }
<a name="l02034"></a>02034     <span class="keywordflow">else</span> {
<a name="l02035"></a>02035         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(*str);
<a name="l02036"></a>02036         <a class="code" href="../../db/d2e/intern_8h.html#a63a6d05687cf812131dce11743581b9d">rb_str_modify</a>(*str);
<a name="l02037"></a>02037         <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(*str, len);
<a name="l02038"></a>02038     }
<a name="l02039"></a>02039 <span class="preprocessor">#endif</span>
<a name="l02040"></a>02040 <span class="preprocessor"></span>}
<a name="l02041"></a>02041 
<a name="l02042"></a>02042 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02043"></a><a class="code" href="../../df/d0a/io_8c.html#af2554e01814c78482ef25c774bbf7477">02043</a> <a class="code" href="../../df/d0a/io_8c.html#af2554e01814c78482ef25c774bbf7477">read_all</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <span class="keywordtype">long</span> siz, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str)
<a name="l02044"></a>02044 {
<a name="l02045"></a>02045     <span class="keywordtype">long</span> bytes;
<a name="l02046"></a>02046     <span class="keywordtype">long</span> n;
<a name="l02047"></a>02047     <span class="keywordtype">long</span> pos;
<a name="l02048"></a>02048     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc;
<a name="l02049"></a>02049     <span class="keywordtype">int</span> cr;
<a name="l02050"></a>02050 
<a name="l02051"></a>02051     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a92621ca418c11e96d4862166f9076a73">NEED_READCONV</a>(fptr)) {
<a name="l02052"></a>02052         <a class="code" href="../../df/d0a/io_8c.html#ace89c001caf3ebc8943c8f06c0aab552">SET_BINARY_MODE</a>(fptr);
<a name="l02053"></a>02053         <a class="code" href="../../df/d0a/io_8c.html#aaffc2b4214d2165b476eaccee348f411">io_setstrbuf</a>(&amp;str,0);
<a name="l02054"></a>02054         <a class="code" href="../../df/d0a/io_8c.html#a7270c50b73afa5c8c999dacfab097524">make_readconv</a>(fptr, 0);
<a name="l02055"></a>02055         <span class="keywordflow">while</span> (1) {
<a name="l02056"></a>02056             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v;
<a name="l02057"></a>02057             <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>) {
<a name="l02058"></a>02058                 <a class="code" href="../../df/d0a/io_8c.html#a20e719e6f50c2ea1857b4d85ee09b2ea">io_shift_cbuf</a>(fptr, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>, &amp;str);
<a name="l02059"></a>02059             }
<a name="l02060"></a>02060             v = <a class="code" href="../../df/d0a/io_8c.html#a5f2a2db79a24f8d30bdf95bca0c77a94">fill_cbuf</a>(fptr, 0);
<a name="l02061"></a>02061             <span class="keywordflow">if</span> (v != <a class="code" href="../../df/d0a/io_8c.html#ab937552cffc59b502c2fd1151ac75454">MORE_CHAR_SUSPENDED</a> &amp;&amp; v != <a class="code" href="../../df/d0a/io_8c.html#adb561f38bf9315a2ec31e9f6926d0618">MORE_CHAR_FINISHED</a>) {
<a name="l02062"></a>02062                 <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>) {
<a name="l02063"></a>02063                     <a class="code" href="../../df/d0a/io_8c.html#a20e719e6f50c2ea1857b4d85ee09b2ea">io_shift_cbuf</a>(fptr, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>, &amp;str);
<a name="l02064"></a>02064                 }
<a name="l02065"></a>02065                 <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(v);
<a name="l02066"></a>02066             }
<a name="l02067"></a>02067             <span class="keywordflow">if</span> (v == <a class="code" href="../../df/d0a/io_8c.html#adb561f38bf9315a2ec31e9f6926d0618">MORE_CHAR_FINISHED</a>) {
<a name="l02068"></a>02068                 <a class="code" href="../../df/d0a/io_8c.html#a89693737d8688aa1fea03c70711799ab">clear_readconv</a>(fptr);
<a name="l02069"></a>02069                 <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#acd3c89cc4bd3aaef3dfea3b3fa2c6360">io_enc_str</a>(str, fptr);
<a name="l02070"></a>02070             }
<a name="l02071"></a>02071         }
<a name="l02072"></a>02072     }
<a name="l02073"></a>02073 
<a name="l02074"></a>02074     <a class="code" href="../../df/d0a/io_8c.html#abd7495bb74588d590a98112929d9010c">NEED_NEWLINE_DECORATOR_ON_READ_CHECK</a>(fptr);
<a name="l02075"></a>02075     bytes = 0;
<a name="l02076"></a>02076     pos = 0;
<a name="l02077"></a>02077 
<a name="l02078"></a>02078     enc = <a class="code" href="../../df/d0a/io_8c.html#aa3b568197b019bda6a9aea4fbe2153eb">io_read_encoding</a>(fptr);
<a name="l02079"></a>02079     cr = 0;
<a name="l02080"></a>02080 
<a name="l02081"></a>02081     <span class="keywordflow">if</span> (siz == 0) siz = BUFSIZ;
<a name="l02082"></a>02082     <a class="code" href="../../df/d0a/io_8c.html#aaffc2b4214d2165b476eaccee348f411">io_setstrbuf</a>(&amp;str,siz);
<a name="l02083"></a>02083     <span class="keywordflow">for</span> (;;) {
<a name="l02084"></a>02084         <a class="code" href="../../df/d0a/io_8c.html#a704f29b50a37b53c4a9f4f876d350f0d">READ_CHECK</a>(fptr);
<a name="l02085"></a>02085         n = <a class="code" href="../../df/d0a/io_8c.html#ae5495474957be7e97bd5e592f028bc86">io_fread</a>(str, bytes, fptr);
<a name="l02086"></a>02086         <span class="keywordflow">if</span> (n == 0 &amp;&amp; bytes == 0) {
<a name="l02087"></a>02087             <span class="keywordflow">break</span>;
<a name="l02088"></a>02088         }
<a name="l02089"></a>02089         bytes += n;
<a name="l02090"></a>02090         <span class="keywordflow">if</span> (cr != <a class="code" href="../../d5/de3/encoding_8h.html#abb86fbc02fc2b78d928825ea6d6922f9">ENC_CODERANGE_BROKEN</a>)
<a name="l02091"></a>02091             pos += <a class="code" href="../../d5/de3/encoding_8h.html#ac1fbec2516e7dbaafbdf8933c5ad7946">rb_str_coderange_scan_restartable</a>(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str) + pos, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str) + bytes, enc, &amp;cr);
<a name="l02092"></a>02092         <span class="keywordflow">if</span> (bytes &lt; siz) <span class="keywordflow">break</span>;
<a name="l02093"></a>02093         siz += BUFSIZ;
<a name="l02094"></a>02094         <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(str, siz);
<a name="l02095"></a>02095     }
<a name="l02096"></a>02096     <span class="keywordflow">if</span> (bytes != siz) <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(str, bytes);
<a name="l02097"></a>02097     str = <a class="code" href="../../df/d0a/io_8c.html#acd3c89cc4bd3aaef3dfea3b3fa2c6360">io_enc_str</a>(str, fptr);
<a name="l02098"></a>02098     <a class="code" href="../../d5/de3/encoding_8h.html#aefe5772c0116cf7131a5227de7243dbc">ENC_CODERANGE_SET</a>(str, cr);
<a name="l02099"></a>02099     <span class="keywordflow">return</span> str;
<a name="l02100"></a>02100 }
<a name="l02101"></a>02101 
<a name="l02102"></a>02102 <span class="keywordtype">void</span>
<a name="l02103"></a><a class="code" href="../../df/d0a/io_8c.html#ad3cd1cfd937d36dfeb7d0f2f4aeb08ab">02103</a> <a class="code" href="../../dc/dac/io_8h.html#ad3cd1cfd937d36dfeb7d0f2f4aeb08ab">rb_io_set_nonblock</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l02104"></a>02104 {
<a name="l02105"></a>02105     <span class="keywordtype">int</span> oflags;
<a name="l02106"></a>02106 <span class="preprocessor">#ifdef F_GETFL</span>
<a name="l02107"></a>02107 <span class="preprocessor"></span>    oflags = <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, F_GETFL);
<a name="l02108"></a>02108     <span class="keywordflow">if</span> (oflags == -1) {
<a name="l02109"></a>02109         <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l02110"></a>02110     }
<a name="l02111"></a>02111 <span class="preprocessor">#else</span>
<a name="l02112"></a>02112 <span class="preprocessor"></span>    oflags = 0;
<a name="l02113"></a>02113 <span class="preprocessor">#endif</span>
<a name="l02114"></a>02114 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((oflags &amp; <a class="code" href="../../dc/db1/win32_8h.html#a39d33ce33804efd4d52606d59071c6d8">O_NONBLOCK</a>) == 0) {
<a name="l02115"></a>02115         oflags |= O_NONBLOCK;
<a name="l02116"></a>02116         <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, <a class="code" href="../../dc/db1/win32_8h.html#af2939853c650561d3495ed40f68f6249">F_SETFL</a>, oflags) == -1) {
<a name="l02117"></a>02117             <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l02118"></a>02118         }
<a name="l02119"></a>02119     }
<a name="l02120"></a>02120 }
<a name="l02121"></a>02121 
<a name="l02122"></a>02122 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02123"></a><a class="code" href="../../df/d0a/io_8c.html#a76ca56b9974b8eb9840baf8a6a30b146">02123</a> <a class="code" href="../../df/d0a/io_8c.html#a76ca56b9974b8eb9840baf8a6a30b146">io_getpartial</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <span class="keywordtype">int</span> nonblock)
<a name="l02124"></a>02124 {
<a name="l02125"></a>02125     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l02126"></a>02126     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> length, str;
<a name="l02127"></a>02127     <span class="keywordtype">long</span> n, <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l02128"></a>02128 
<a name="l02129"></a>02129     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;11&quot;</span>, &amp;length, &amp;str);
<a name="l02130"></a>02130 
<a name="l02131"></a>02131     <span class="keywordflow">if</span> ((len = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(length)) &lt; 0) {
<a name="l02132"></a>02132         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;negative length %ld given&quot;</span>, len);
<a name="l02133"></a>02133     }
<a name="l02134"></a>02134 
<a name="l02135"></a>02135     <a class="code" href="../../df/d0a/io_8c.html#aaffc2b4214d2165b476eaccee348f411">io_setstrbuf</a>(&amp;str,len);
<a name="l02136"></a>02136     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afd75ea0cb81c17e76c73e593d1d8a860">OBJ_TAINT</a>(str);
<a name="l02137"></a>02137 
<a name="l02138"></a>02138     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l02139"></a>02139     <a class="code" href="../../dc/dac/io_8h.html#a38b3a618992ee85d5510dc70db4e2b36">rb_io_check_byte_readable</a>(fptr);
<a name="l02140"></a>02140 
<a name="l02141"></a>02141     <span class="keywordflow">if</span> (len == 0)
<a name="l02142"></a>02142         <span class="keywordflow">return</span> str;
<a name="l02143"></a>02143 
<a name="l02144"></a>02144     <span class="keywordflow">if</span> (!nonblock)
<a name="l02145"></a>02145         <a class="code" href="../../df/d0a/io_8c.html#a704f29b50a37b53c4a9f4f876d350f0d">READ_CHECK</a>(fptr);
<a name="l02146"></a>02146     n = <a class="code" href="../../df/d0a/io_8c.html#af0cb01766b96b9ba7f84b4ebd4e2099d">read_buffered_data</a>(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), len, fptr);
<a name="l02147"></a>02147     <span class="keywordflow">if</span> (n &lt;= 0) {
<a name="l02148"></a>02148       again:
<a name="l02149"></a>02149         <span class="keywordflow">if</span> (nonblock) {
<a name="l02150"></a>02150             <a class="code" href="../../dc/dac/io_8h.html#ad3cd1cfd937d36dfeb7d0f2f4aeb08ab">rb_io_set_nonblock</a>(fptr);
<a name="l02151"></a>02151         }
<a name="l02152"></a>02152         <a class="code" href="../../db/d2e/intern_8h.html#ac8be785eb014dbaac6d9daeba3cbaf17">rb_str_locktmp</a>(str);
<a name="l02153"></a>02153         n = <a class="code" href="../../df/d0a/io_8c.html#aa992ea0a36c7c173ae889134907d2b22">rb_read_internal</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), len);
<a name="l02154"></a>02154         <a class="code" href="../../db/d2e/intern_8h.html#a027ec67101bdfadde1553c0a0a70c724">rb_str_unlocktmp</a>(str);
<a name="l02155"></a>02155         <span class="keywordflow">if</span> (n &lt; 0) {
<a name="l02156"></a>02156             <span class="keywordflow">if</span> (!nonblock &amp;&amp; <a class="code" href="../../dc/dac/io_8h.html#aef370f8ba67623893a3b559bf27b30e3">rb_io_wait_readable</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>))
<a name="l02157"></a>02157                 <span class="keywordflow">goto</span> again;
<a name="l02158"></a>02158             <span class="keywordflow">if</span> (nonblock &amp;&amp; (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == <a class="code" href="../../dd/d8c/rubysocket_8h.html#a4a3a0b3605fd3b2336455062ee8e25f0">EWOULDBLOCK</a> || <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EAGAIN))
<a name="l02159"></a>02159                 <a class="code" href="../../db/dcc/error_8c.html#a2087f7e18da9f5eec20b6e36b56d71ee">rb_mod_sys_fail</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac2d47e89b7cb8311129ec7566608a0b2">rb_mWaitReadable</a>, <span class="stringliteral">&quot;read would block&quot;</span>);
<a name="l02160"></a>02160             <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l02161"></a>02161         }
<a name="l02162"></a>02162     }
<a name="l02163"></a>02163     <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(str, n);
<a name="l02164"></a>02164 
<a name="l02165"></a>02165     <span class="keywordflow">if</span> (n == 0)
<a name="l02166"></a>02166         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02167"></a>02167     <span class="keywordflow">else</span>
<a name="l02168"></a>02168         <span class="keywordflow">return</span> str;
<a name="l02169"></a>02169 }
<a name="l02170"></a>02170 
<a name="l02171"></a>02171 <span class="comment">/*</span>
<a name="l02172"></a>02172 <span class="comment"> *  call-seq:</span>
<a name="l02173"></a>02173 <span class="comment"> *     ios.readpartial(maxlen)              -&gt; string</span>
<a name="l02174"></a>02174 <span class="comment"> *     ios.readpartial(maxlen, outbuf)      -&gt; outbuf</span>
<a name="l02175"></a>02175 <span class="comment"> *</span>
<a name="l02176"></a>02176 <span class="comment"> *  Reads at most &lt;i&gt;maxlen&lt;/i&gt; bytes from the I/O stream.</span>
<a name="l02177"></a>02177 <span class="comment"> *  It blocks only if &lt;em&gt;ios&lt;/em&gt; has no data immediately available.</span>
<a name="l02178"></a>02178 <span class="comment"> *  It doesn&apos;t block if some data available.</span>
<a name="l02179"></a>02179 <span class="comment"> *  If the optional &lt;i&gt;outbuf&lt;/i&gt; argument is present,</span>
<a name="l02180"></a>02180 <span class="comment"> *  it must reference a String, which will receive the data.</span>
<a name="l02181"></a>02181 <span class="comment"> *  It raises &lt;code&gt;EOFError&lt;/code&gt; on end of file.</span>
<a name="l02182"></a>02182 <span class="comment"> *</span>
<a name="l02183"></a>02183 <span class="comment"> *  readpartial is designed for streams such as pipe, socket, tty, etc.</span>
<a name="l02184"></a>02184 <span class="comment"> *  It blocks only when no data immediately available.</span>
<a name="l02185"></a>02185 <span class="comment"> *  This means that it blocks only when following all conditions hold.</span>
<a name="l02186"></a>02186 <span class="comment"> *  * the byte buffer in the IO object is empty.</span>
<a name="l02187"></a>02187 <span class="comment"> *  * the content of the stream is empty.</span>
<a name="l02188"></a>02188 <span class="comment"> *  * the stream is not reached to EOF.</span>
<a name="l02189"></a>02189 <span class="comment"> *</span>
<a name="l02190"></a>02190 <span class="comment"> *  When readpartial blocks, it waits data or EOF on the stream.</span>
<a name="l02191"></a>02191 <span class="comment"> *  If some data is reached, readpartial returns with the data.</span>
<a name="l02192"></a>02192 <span class="comment"> *  If EOF is reached, readpartial raises EOFError.</span>
<a name="l02193"></a>02193 <span class="comment"> *</span>
<a name="l02194"></a>02194 <span class="comment"> *  When readpartial doesn&apos;t blocks, it returns or raises immediately.</span>
<a name="l02195"></a>02195 <span class="comment"> *  If the byte buffer is not empty, it returns the data in the buffer.</span>
<a name="l02196"></a>02196 <span class="comment"> *  Otherwise if the stream has some content,</span>
<a name="l02197"></a>02197 <span class="comment"> *  it returns the data in the stream.</span>
<a name="l02198"></a>02198 <span class="comment"> *  Otherwise if the stream is reached to EOF, it raises EOFError.</span>
<a name="l02199"></a>02199 <span class="comment"> *</span>
<a name="l02200"></a>02200 <span class="comment"> *     r, w = IO.pipe           #               buffer          pipe content</span>
<a name="l02201"></a>02201 <span class="comment"> *     w &lt;&lt; &quot;abc&quot;               #               &quot;&quot;              &quot;abc&quot;.</span>
<a name="l02202"></a>02202 <span class="comment"> *     r.readpartial(4096)      #=&gt; &quot;abc&quot;       &quot;&quot;              &quot;&quot;</span>
<a name="l02203"></a>02203 <span class="comment"> *     r.readpartial(4096)      # blocks because buffer and pipe is empty.</span>
<a name="l02204"></a>02204 <span class="comment"> *</span>
<a name="l02205"></a>02205 <span class="comment"> *     r, w = IO.pipe           #               buffer          pipe content</span>
<a name="l02206"></a>02206 <span class="comment"> *     w &lt;&lt; &quot;abc&quot;               #               &quot;&quot;              &quot;abc&quot;</span>
<a name="l02207"></a>02207 <span class="comment"> *     w.close                  #               &quot;&quot;              &quot;abc&quot; EOF</span>
<a name="l02208"></a>02208 <span class="comment"> *     r.readpartial(4096)      #=&gt; &quot;abc&quot;       &quot;&quot;              EOF</span>
<a name="l02209"></a>02209 <span class="comment"> *     r.readpartial(4096)      # raises EOFError</span>
<a name="l02210"></a>02210 <span class="comment"> *</span>
<a name="l02211"></a>02211 <span class="comment"> *     r, w = IO.pipe           #               buffer          pipe content</span>
<a name="l02212"></a>02212 <span class="comment"> *     w &lt;&lt; &quot;abc\ndef\n&quot;        #               &quot;&quot;              &quot;abc\ndef\n&quot;</span>
<a name="l02213"></a>02213 <span class="comment"> *     r.gets                   #=&gt; &quot;abc\n&quot;     &quot;def\n&quot;         &quot;&quot;</span>
<a name="l02214"></a>02214 <span class="comment"> *     w &lt;&lt; &quot;ghi\n&quot;             #               &quot;def\n&quot;         &quot;ghi\n&quot;</span>
<a name="l02215"></a>02215 <span class="comment"> *     r.readpartial(4096)      #=&gt; &quot;def\n&quot;     &quot;&quot;              &quot;ghi\n&quot;</span>
<a name="l02216"></a>02216 <span class="comment"> *     r.readpartial(4096)      #=&gt; &quot;ghi\n&quot;     &quot;&quot;              &quot;&quot;</span>
<a name="l02217"></a>02217 <span class="comment"> *</span>
<a name="l02218"></a>02218 <span class="comment"> *  Note that readpartial behaves similar to sysread.</span>
<a name="l02219"></a>02219 <span class="comment"> *  The differences are:</span>
<a name="l02220"></a>02220 <span class="comment"> *  * If the byte buffer is not empty, read from the byte buffer instead of &quot;sysread for buffered IO (IOError)&quot;.</span>
<a name="l02221"></a>02221 <span class="comment"> *  * It doesn&apos;t cause Errno::EWOULDBLOCK and Errno::EINTR.  When readpartial meets EWOULDBLOCK and EINTR by read system call, readpartial retry the system call.</span>
<a name="l02222"></a>02222 <span class="comment"> *</span>
<a name="l02223"></a>02223 <span class="comment"> *  The later means that readpartial is nonblocking-flag insensitive.</span>
<a name="l02224"></a>02224 <span class="comment"> *  It blocks on the situation IO#sysread causes Errno::EWOULDBLOCK as if the fd is blocking mode.</span>
<a name="l02225"></a>02225 <span class="comment"> *</span>
<a name="l02226"></a>02226 <span class="comment"> */</span>
<a name="l02227"></a>02227 
<a name="l02228"></a>02228 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02229"></a><a class="code" href="../../df/d0a/io_8c.html#acddb1da73471e25d175a447beacf11f8">02229</a> <a class="code" href="../../df/d0a/io_8c.html#acddb1da73471e25d175a447beacf11f8">io_readpartial</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l02230"></a>02230 {
<a name="l02231"></a>02231     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ret;
<a name="l02232"></a>02232 
<a name="l02233"></a>02233     ret = <a class="code" href="../../df/d0a/io_8c.html#a76ca56b9974b8eb9840baf8a6a30b146">io_getpartial</a>(argc, argv, io, 0);
<a name="l02234"></a>02234     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(ret))
<a name="l02235"></a>02235         <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>();
<a name="l02236"></a>02236     <span class="keywordflow">else</span>
<a name="l02237"></a>02237         <span class="keywordflow">return</span> ret;
<a name="l02238"></a>02238 }
<a name="l02239"></a>02239 
<a name="l02240"></a>02240 <span class="comment">/*</span>
<a name="l02241"></a>02241 <span class="comment"> *  call-seq:</span>
<a name="l02242"></a>02242 <span class="comment"> *     ios.read_nonblock(maxlen)              -&gt; string</span>
<a name="l02243"></a>02243 <span class="comment"> *     ios.read_nonblock(maxlen, outbuf)      -&gt; outbuf</span>
<a name="l02244"></a>02244 <span class="comment"> *</span>
<a name="l02245"></a>02245 <span class="comment"> *  Reads at most &lt;i&gt;maxlen&lt;/i&gt; bytes from &lt;em&gt;ios&lt;/em&gt; using</span>
<a name="l02246"></a>02246 <span class="comment"> *  the read(2) system call after O_NONBLOCK is set for</span>
<a name="l02247"></a>02247 <span class="comment"> *  the underlying file descriptor.</span>
<a name="l02248"></a>02248 <span class="comment"> *</span>
<a name="l02249"></a>02249 <span class="comment"> *  If the optional &lt;i&gt;outbuf&lt;/i&gt; argument is present,</span>
<a name="l02250"></a>02250 <span class="comment"> *  it must reference a String, which will receive the data.</span>
<a name="l02251"></a>02251 <span class="comment"> *</span>
<a name="l02252"></a>02252 <span class="comment"> *  read_nonblock just calls the read(2) system call.</span>
<a name="l02253"></a>02253 <span class="comment"> *  It causes all errors the read(2) system call causes: Errno::EWOULDBLOCK, Errno::EINTR, etc.</span>
<a name="l02254"></a>02254 <span class="comment"> *  The caller should care such errors.</span>
<a name="l02255"></a>02255 <span class="comment"> *</span>
<a name="l02256"></a>02256 <span class="comment"> *  If the exception is Errno::EWOULDBLOCK or Errno::AGAIN,</span>
<a name="l02257"></a>02257 <span class="comment"> *  it is extended by IO::WaitReadable.</span>
<a name="l02258"></a>02258 <span class="comment"> *  So IO::WaitReadable can be used to rescue the exceptions for retrying read_nonblock.</span>
<a name="l02259"></a>02259 <span class="comment"> *</span>
<a name="l02260"></a>02260 <span class="comment"> *  read_nonblock causes EOFError on EOF.</span>
<a name="l02261"></a>02261 <span class="comment"> *</span>
<a name="l02262"></a>02262 <span class="comment"> *  If the read byte buffer is not empty,</span>
<a name="l02263"></a>02263 <span class="comment"> *  read_nonblock reads from the buffer like readpartial.</span>
<a name="l02264"></a>02264 <span class="comment"> *  In this case, the read(2) system call is not called.</span>
<a name="l02265"></a>02265 <span class="comment"> *</span>
<a name="l02266"></a>02266 <span class="comment"> *  When read_nonblock raises an exception kind of IO::WaitReadable,</span>
<a name="l02267"></a>02267 <span class="comment"> *  read_nonblock should not be called</span>
<a name="l02268"></a>02268 <span class="comment"> *  until io is readable for avoiding busy loop.</span>
<a name="l02269"></a>02269 <span class="comment"> *  This can be done as follows.</span>
<a name="l02270"></a>02270 <span class="comment"> *</span>
<a name="l02271"></a>02271 <span class="comment"> *    # emulates blocking read (readpartial).</span>
<a name="l02272"></a>02272 <span class="comment"> *    begin</span>
<a name="l02273"></a>02273 <span class="comment"> *      result = io.read_nonblock(maxlen)</span>
<a name="l02274"></a>02274 <span class="comment"> *    rescue IO::WaitReadable</span>
<a name="l02275"></a>02275 <span class="comment"> *      IO.select([io])</span>
<a name="l02276"></a>02276 <span class="comment"> *      retry</span>
<a name="l02277"></a>02277 <span class="comment"> *    end</span>
<a name="l02278"></a>02278 <span class="comment"> *</span>
<a name="l02279"></a>02279 <span class="comment"> *  Although IO#read_nonblock doesn&apos;t raise IO::WaitWritable.</span>
<a name="l02280"></a>02280 <span class="comment"> *  OpenSSL::Buffering#read_nonblock can raise IO::WaitWritable.</span>
<a name="l02281"></a>02281 <span class="comment"> *  If IO and SSL should be used polymorphically,</span>
<a name="l02282"></a>02282 <span class="comment"> *  IO::WaitWritable should be rescued too.</span>
<a name="l02283"></a>02283 <span class="comment"> *  See the document of OpenSSL::Buffering#read_nonblock for sample code.</span>
<a name="l02284"></a>02284 <span class="comment"> *</span>
<a name="l02285"></a>02285 <span class="comment"> *  Note that this method is identical to readpartial</span>
<a name="l02286"></a>02286 <span class="comment"> *  except the non-blocking flag is set.</span>
<a name="l02287"></a>02287 <span class="comment"> */</span>
<a name="l02288"></a>02288 
<a name="l02289"></a>02289 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02290"></a><a class="code" href="../../df/d0a/io_8c.html#a56b8f1fad1cec08e3e85cdd2bbe3fe1e">02290</a> <a class="code" href="../../df/d0a/io_8c.html#a56b8f1fad1cec08e3e85cdd2bbe3fe1e">io_read_nonblock</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l02291"></a>02291 {
<a name="l02292"></a>02292     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ret;
<a name="l02293"></a>02293 
<a name="l02294"></a>02294     ret = <a class="code" href="../../df/d0a/io_8c.html#a76ca56b9974b8eb9840baf8a6a30b146">io_getpartial</a>(argc, argv, io, 1);
<a name="l02295"></a>02295     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(ret))
<a name="l02296"></a>02296         <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>();
<a name="l02297"></a>02297     <span class="keywordflow">else</span>
<a name="l02298"></a>02298         <span class="keywordflow">return</span> ret;
<a name="l02299"></a>02299 }
<a name="l02300"></a>02300 
<a name="l02301"></a>02301 <span class="comment">/*</span>
<a name="l02302"></a>02302 <span class="comment"> *  call-seq:</span>
<a name="l02303"></a>02303 <span class="comment"> *     ios.write_nonblock(string)   -&gt; integer</span>
<a name="l02304"></a>02304 <span class="comment"> *</span>
<a name="l02305"></a>02305 <span class="comment"> *  Writes the given string to &lt;em&gt;ios&lt;/em&gt; using</span>
<a name="l02306"></a>02306 <span class="comment"> *  the write(2) system call after O_NONBLOCK is set for</span>
<a name="l02307"></a>02307 <span class="comment"> *  the underlying file descriptor.</span>
<a name="l02308"></a>02308 <span class="comment"> *</span>
<a name="l02309"></a>02309 <span class="comment"> *  It returns the number of bytes written.</span>
<a name="l02310"></a>02310 <span class="comment"> *</span>
<a name="l02311"></a>02311 <span class="comment"> *  write_nonblock just calls the write(2) system call.</span>
<a name="l02312"></a>02312 <span class="comment"> *  It causes all errors the write(2) system call causes: Errno::EWOULDBLOCK, Errno::EINTR, etc.</span>
<a name="l02313"></a>02313 <span class="comment"> *  The result may also be smaller than string.length (partial write).</span>
<a name="l02314"></a>02314 <span class="comment"> *  The caller should care such errors and partial write.</span>
<a name="l02315"></a>02315 <span class="comment"> *</span>
<a name="l02316"></a>02316 <span class="comment"> *  If the exception is Errno::EWOULDBLOCK or Errno::AGAIN,</span>
<a name="l02317"></a>02317 <span class="comment"> *  it is extended by IO::WaitWritable.</span>
<a name="l02318"></a>02318 <span class="comment"> *  So IO::WaitWritable can be used to rescue the exceptions for retrying write_nonblock.</span>
<a name="l02319"></a>02319 <span class="comment"> *</span>
<a name="l02320"></a>02320 <span class="comment"> *    # Creates a pipe.</span>
<a name="l02321"></a>02321 <span class="comment"> *    r, w = IO.pipe</span>
<a name="l02322"></a>02322 <span class="comment"> *</span>
<a name="l02323"></a>02323 <span class="comment"> *    # write_nonblock writes only 65536 bytes and return 65536.</span>
<a name="l02324"></a>02324 <span class="comment"> *    # (The pipe size is 65536 bytes on this environment.)</span>
<a name="l02325"></a>02325 <span class="comment"> *    s = &quot;a&quot; * 100000</span>
<a name="l02326"></a>02326 <span class="comment"> *    p w.write_nonblock(s)     #=&gt; 65536</span>
<a name="l02327"></a>02327 <span class="comment"> *</span>
<a name="l02328"></a>02328 <span class="comment"> *    # write_nonblock cannot write a byte and raise EWOULDBLOCK (EAGAIN).</span>
<a name="l02329"></a>02329 <span class="comment"> *    p w.write_nonblock(&quot;b&quot;)   # Resource temporarily unavailable (Errno::EAGAIN)</span>
<a name="l02330"></a>02330 <span class="comment"> *</span>
<a name="l02331"></a>02331 <span class="comment"> *  If the write buffer is not empty, it is flushed at first.</span>
<a name="l02332"></a>02332 <span class="comment"> *</span>
<a name="l02333"></a>02333 <span class="comment"> *  When write_nonblock raises an exception kind of IO::WaitWritable,</span>
<a name="l02334"></a>02334 <span class="comment"> *  write_nonblock should not be called</span>
<a name="l02335"></a>02335 <span class="comment"> *  until io is writable for avoiding busy loop.</span>
<a name="l02336"></a>02336 <span class="comment"> *  This can be done as follows.</span>
<a name="l02337"></a>02337 <span class="comment"> *</span>
<a name="l02338"></a>02338 <span class="comment"> *    begin</span>
<a name="l02339"></a>02339 <span class="comment"> *      result = io.write_nonblock(string)</span>
<a name="l02340"></a>02340 <span class="comment"> *    rescue IO::WaitWritable, Errno::EINTR</span>
<a name="l02341"></a>02341 <span class="comment"> *      IO.select(nil, [io])</span>
<a name="l02342"></a>02342 <span class="comment"> *      retry</span>
<a name="l02343"></a>02343 <span class="comment"> *    end</span>
<a name="l02344"></a>02344 <span class="comment"> *</span>
<a name="l02345"></a>02345 <span class="comment"> *  Note that this doesn&apos;t guarantee to write all data in string.</span>
<a name="l02346"></a>02346 <span class="comment"> *  The length written is reported as result and it should be checked later.</span>
<a name="l02347"></a>02347 <span class="comment"> *</span>
<a name="l02348"></a>02348 <span class="comment"> *  On some platforms such as Windows, write_nonblock is not supported</span>
<a name="l02349"></a>02349 <span class="comment"> *  according to the kind of the IO object.</span>
<a name="l02350"></a>02350 <span class="comment"> *  In such cases, write_nonblock raises &lt;code&gt;Errno::EBADF&lt;/code&gt;.</span>
<a name="l02351"></a>02351 <span class="comment"> *</span>
<a name="l02352"></a>02352 <span class="comment"> */</span>
<a name="l02353"></a>02353 
<a name="l02354"></a>02354 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02355"></a><a class="code" href="../../df/d0a/io_8c.html#a84c56d8dfcf86bd09b8d064c976fda9e">02355</a> <a class="code" href="../../df/d0a/io_8c.html#a84c56d8dfcf86bd09b8d064c976fda9e">rb_io_write_nonblock</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str)
<a name="l02356"></a>02356 {
<a name="l02357"></a>02357     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l02358"></a>02358     <span class="keywordtype">long</span> n;
<a name="l02359"></a>02359 
<a name="l02360"></a>02360     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a98b91af598acb64fe8497413ce498766">rb_secure</a>(4);
<a name="l02361"></a>02361     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(str) != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a22a8c2a4bbaae9b68f65c9bb92fd4e39">T_STRING</a>)
<a name="l02362"></a>02362         str = <a class="code" href="../../db/d2e/intern_8h.html#acae5350f5d539c4654e4e33690256a9f">rb_obj_as_string</a>(str);
<a name="l02363"></a>02363 
<a name="l02364"></a>02364     io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l02365"></a>02365     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l02366"></a>02366     <a class="code" href="../../dc/dac/io_8h.html#a728977df67c656197402bb30a14af953">rb_io_check_writable</a>(fptr);
<a name="l02367"></a>02367 
<a name="l02368"></a>02368     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(fptr) &lt; 0)
<a name="l02369"></a>02369         <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l02370"></a>02370 
<a name="l02371"></a>02371     <a class="code" href="../../dc/dac/io_8h.html#ad3cd1cfd937d36dfeb7d0f2f4aeb08ab">rb_io_set_nonblock</a>(fptr);
<a name="l02372"></a>02372     n = write(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str));
<a name="l02373"></a>02373 
<a name="l02374"></a>02374     <span class="keywordflow">if</span> (n == -1) {
<a name="l02375"></a>02375         <span class="keywordflow">if</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == <a class="code" href="../../dd/d8c/rubysocket_8h.html#a4a3a0b3605fd3b2336455062ee8e25f0">EWOULDBLOCK</a> || <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EAGAIN)
<a name="l02376"></a>02376             <a class="code" href="../../db/dcc/error_8c.html#a2087f7e18da9f5eec20b6e36b56d71ee">rb_mod_sys_fail</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac0e6048c512add5b6659c01f7f134d8a">rb_mWaitWritable</a>, <span class="stringliteral">&quot;write would block&quot;</span>);
<a name="l02377"></a>02377         <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l02378"></a>02378     }
<a name="l02379"></a>02379 
<a name="l02380"></a>02380     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2ead2f64c81efed352e79e89f29b8fc8">LONG2FIX</a>(n);
<a name="l02381"></a>02381 }
<a name="l02382"></a>02382 
<a name="l02383"></a>02383 <span class="comment">/*</span>
<a name="l02384"></a>02384 <span class="comment"> *  call-seq:</span>
<a name="l02385"></a>02385 <span class="comment"> *     ios.read([length [, buffer]])    -&gt; string, buffer, or nil</span>
<a name="l02386"></a>02386 <span class="comment"> *</span>
<a name="l02387"></a>02387 <span class="comment"> *  Reads &lt;i&gt;length&lt;/i&gt; bytes from the I/O stream.</span>
<a name="l02388"></a>02388 <span class="comment"> *</span>
<a name="l02389"></a>02389 <span class="comment"> *  &lt;i&gt;length&lt;/i&gt; must be a non-negative integer or &lt;code&gt;nil&lt;/code&gt;.</span>
<a name="l02390"></a>02390 <span class="comment"> *</span>
<a name="l02391"></a>02391 <span class="comment"> *  If &lt;i&gt;length&lt;/i&gt; is a positive integer,</span>
<a name="l02392"></a>02392 <span class="comment"> *  it try to read &lt;i&gt;length&lt;/i&gt; bytes without any conversion (binary mode).</span>
<a name="l02393"></a>02393 <span class="comment"> *  It returns &lt;code&gt;nil&lt;/code&gt; or a string whose length is 1 to &lt;i&gt;length&lt;/i&gt; bytes.</span>
<a name="l02394"></a>02394 <span class="comment"> *  &lt;code&gt;nil&lt;/code&gt; means it met EOF at beginning.</span>
<a name="l02395"></a>02395 <span class="comment"> *  The 1 to &lt;i&gt;length&lt;/i&gt;-1 bytes string means it met EOF after reading the result.</span>
<a name="l02396"></a>02396 <span class="comment"> *  The &lt;i&gt;length&lt;/i&gt; bytes string means it doesn&apos;t meet EOF.</span>
<a name="l02397"></a>02397 <span class="comment"> *  The resulted string is always ASCII-8BIT encoding.</span>
<a name="l02398"></a>02398 <span class="comment"> *</span>
<a name="l02399"></a>02399 <span class="comment"> *  If &lt;i&gt;length&lt;/i&gt; is omitted or is &lt;code&gt;nil&lt;/code&gt;,</span>
<a name="l02400"></a>02400 <span class="comment"> *  it reads until EOF and the encoding conversion is applied.</span>
<a name="l02401"></a>02401 <span class="comment"> *  It returns a string even if EOF is met at beginning.</span>
<a name="l02402"></a>02402 <span class="comment"> *</span>
<a name="l02403"></a>02403 <span class="comment"> *  If &lt;i&gt;length&lt;/i&gt; is zero, it returns &lt;code&gt;&quot;&quot;&lt;/code&gt;.</span>
<a name="l02404"></a>02404 <span class="comment"> *</span>
<a name="l02405"></a>02405 <span class="comment"> *  If the optional &lt;i&gt;buffer&lt;/i&gt; argument is present, it must reference</span>
<a name="l02406"></a>02406 <span class="comment"> *  a String, which will receive the data.</span>
<a name="l02407"></a>02407 <span class="comment"> *</span>
<a name="l02408"></a>02408 <span class="comment"> *  At end of file, it returns &lt;code&gt;nil&lt;/code&gt; or &lt;code&gt;&quot;&quot;&lt;/code&gt;</span>
<a name="l02409"></a>02409 <span class="comment"> *  depend on &lt;i&gt;length&lt;/i&gt;.</span>
<a name="l02410"></a>02410 <span class="comment"> *  &lt;code&gt;&lt;i&gt;ios&lt;/i&gt;.read()&lt;/code&gt; and</span>
<a name="l02411"></a>02411 <span class="comment"> *  &lt;code&gt;&lt;i&gt;ios&lt;/i&gt;.read(nil)&lt;/code&gt; returns &lt;code&gt;&quot;&quot;&lt;/code&gt;.</span>
<a name="l02412"></a>02412 <span class="comment"> *  &lt;code&gt;&lt;i&gt;ios&lt;/i&gt;.read(&lt;i&gt;positive-integer&lt;/i&gt;)&lt;/code&gt; returns &lt;code&gt;nil&lt;/code&gt;.</span>
<a name="l02413"></a>02413 <span class="comment"> *</span>
<a name="l02414"></a>02414 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l02415"></a>02415 <span class="comment"> *     f.read(16)   #=&gt; &quot;This is line one&quot;</span>
<a name="l02416"></a>02416 <span class="comment"> *</span>
<a name="l02417"></a>02417 <span class="comment"> *     # reads whole file</span>
<a name="l02418"></a>02418 <span class="comment"> *     open(&quot;file&quot;) {|f|</span>
<a name="l02419"></a>02419 <span class="comment"> *       data = f.read # This returns a string even if the file is empty.</span>
<a name="l02420"></a>02420 <span class="comment"> *       ...</span>
<a name="l02421"></a>02421 <span class="comment"> *     }</span>
<a name="l02422"></a>02422 <span class="comment"> *</span>
<a name="l02423"></a>02423 <span class="comment"> *     # iterate over fixed length records.</span>
<a name="l02424"></a>02424 <span class="comment"> *     open(&quot;fixed-record-file&quot;) {|f|</span>
<a name="l02425"></a>02425 <span class="comment"> *       while record = f.read(256)</span>
<a name="l02426"></a>02426 <span class="comment"> *         ...</span>
<a name="l02427"></a>02427 <span class="comment"> *       end</span>
<a name="l02428"></a>02428 <span class="comment"> *     }</span>
<a name="l02429"></a>02429 <span class="comment"> *</span>
<a name="l02430"></a>02430 <span class="comment"> *     # iterate over variable length records.</span>
<a name="l02431"></a>02431 <span class="comment"> *     # record is prefixed by 32-bit length.</span>
<a name="l02432"></a>02432 <span class="comment"> *     open(&quot;variable-record-file&quot;) {|f|</span>
<a name="l02433"></a>02433 <span class="comment"> *       while len = f.read(4)</span>
<a name="l02434"></a>02434 <span class="comment"> *         len = len.unpack(&quot;N&quot;)[0] # 32-bit length</span>
<a name="l02435"></a>02435 <span class="comment"> *         record = f.read(len) # This returns a string even if len is 0.</span>
<a name="l02436"></a>02436 <span class="comment"> *       end</span>
<a name="l02437"></a>02437 <span class="comment"> *     }</span>
<a name="l02438"></a>02438 <span class="comment"> *</span>
<a name="l02439"></a>02439 <span class="comment"> *  Note that this method behaves like fread() function in C.</span>
<a name="l02440"></a>02440 <span class="comment"> *  If you need the behavior like read(2) system call,</span>
<a name="l02441"></a>02441 <span class="comment"> *  consider readpartial, read_nonblock and sysread.</span>
<a name="l02442"></a>02442 <span class="comment"> */</span>
<a name="l02443"></a>02443 
<a name="l02444"></a>02444 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02445"></a><a class="code" href="../../df/d0a/io_8c.html#aabba878d4b639aa789e090114d1023f9">02445</a> <a class="code" href="../../df/d0a/io_8c.html#aabba878d4b639aa789e090114d1023f9">io_read</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l02446"></a>02446 {
<a name="l02447"></a>02447     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l02448"></a>02448     <span class="keywordtype">long</span> n, <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l02449"></a>02449     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> length, str;
<a name="l02450"></a>02450 <span class="preprocessor">#if defined(RUBY_TEST_CRLF_ENVIRONMENT) || defined(_WIN32)</span>
<a name="l02451"></a>02451 <span class="preprocessor"></span>    <span class="keywordtype">int</span> previous_mode;
<a name="l02452"></a>02452 <span class="preprocessor">#endif</span>
<a name="l02453"></a>02453 <span class="preprocessor"></span>
<a name="l02454"></a>02454     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;02&quot;</span>, &amp;length, &amp;str);
<a name="l02455"></a>02455 
<a name="l02456"></a>02456     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(length)) {
<a name="l02457"></a>02457         <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l02458"></a>02458         <a class="code" href="../../dc/dac/io_8h.html#acbd19ff86a565ed9e9f15e4f49736f3d">rb_io_check_char_readable</a>(fptr);
<a name="l02459"></a>02459         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#af2554e01814c78482ef25c774bbf7477">read_all</a>(fptr, <a class="code" href="../../df/d0a/io_8c.html#a12126308ff477ec7e04e15db2f878285">remain_size</a>(fptr), str);
<a name="l02460"></a>02460     }
<a name="l02461"></a>02461     len = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(length);
<a name="l02462"></a>02462     <span class="keywordflow">if</span> (len &lt; 0) {
<a name="l02463"></a>02463         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;negative length %ld given&quot;</span>, len);
<a name="l02464"></a>02464     }
<a name="l02465"></a>02465 
<a name="l02466"></a>02466     <a class="code" href="../../df/d0a/io_8c.html#aaffc2b4214d2165b476eaccee348f411">io_setstrbuf</a>(&amp;str,len);
<a name="l02467"></a>02467 
<a name="l02468"></a>02468     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l02469"></a>02469     <a class="code" href="../../dc/dac/io_8h.html#a38b3a618992ee85d5510dc70db4e2b36">rb_io_check_byte_readable</a>(fptr);
<a name="l02470"></a>02470     <span class="keywordflow">if</span> (len == 0) <span class="keywordflow">return</span> str;
<a name="l02471"></a>02471 
<a name="l02472"></a>02472     <a class="code" href="../../df/d0a/io_8c.html#a704f29b50a37b53c4a9f4f876d350f0d">READ_CHECK</a>(fptr);
<a name="l02473"></a>02473 <span class="preprocessor">#if defined(RUBY_TEST_CRLF_ENVIRONMENT) || defined(_WIN32)</span>
<a name="l02474"></a>02474 <span class="preprocessor"></span>    previous_mode = set_binary_mode_with_seek_cur(fptr);
<a name="l02475"></a>02475 <span class="preprocessor">#endif</span>
<a name="l02476"></a>02476 <span class="preprocessor"></span>    n = <a class="code" href="../../df/d0a/io_8c.html#ae5495474957be7e97bd5e592f028bc86">io_fread</a>(str, 0, fptr);
<a name="l02477"></a>02477 <span class="preprocessor">#if defined(RUBY_TEST_CRLF_ENVIRONMENT) || defined(_WIN32)</span>
<a name="l02478"></a>02478 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (previous_mode == O_TEXT) {
<a name="l02479"></a>02479         setmode(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, O_TEXT);
<a name="l02480"></a>02480     }
<a name="l02481"></a>02481 <span class="preprocessor">#endif</span>
<a name="l02482"></a>02482 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (n == 0) {
<a name="l02483"></a>02483         <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> &lt; 0) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02484"></a>02484         <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(str, 0);
<a name="l02485"></a>02485         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02486"></a>02486     }
<a name="l02487"></a>02487     <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(str, n);
<a name="l02488"></a>02488     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afd75ea0cb81c17e76c73e593d1d8a860">OBJ_TAINT</a>(str);
<a name="l02489"></a>02489 
<a name="l02490"></a>02490     <span class="keywordflow">return</span> str;
<a name="l02491"></a>02491 }
<a name="l02492"></a>02492 
<a name="l02493"></a>02493 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02494"></a><a class="code" href="../../df/d0a/io_8c.html#a7a584aa0dc2ca6c929cea5e2c95f2309">02494</a> <a class="code" href="../../df/d0a/io_8c.html#a7a584aa0dc2ca6c929cea5e2c95f2309">rscheck</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *rsptr, <span class="keywordtype">long</span> rslen, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> rs)
<a name="l02495"></a>02495 {
<a name="l02496"></a>02496     <span class="keywordflow">if</span> (!rs) <span class="keywordflow">return</span>;
<a name="l02497"></a>02497     <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(rs) != rsptr &amp;&amp; <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(rs) != rslen)
<a name="l02498"></a>02498         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a95ad3953d535707e2cf2b1d837f5e253">rb_eRuntimeError</a>, <span class="stringliteral">&quot;rs modified&quot;</span>);
<a name="l02499"></a>02499 }
<a name="l02500"></a>02500 
<a name="l02501"></a>02501 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02502"></a><a class="code" href="../../df/d0a/io_8c.html#a68787af67157f1c6a698e50aa6791af8">02502</a> <a class="code" href="../../df/d0a/io_8c.html#a68787af67157f1c6a698e50aa6791af8">appendline</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <span class="keywordtype">int</span> delim, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *strp, <span class="keywordtype">long</span> *lp)
<a name="l02503"></a>02503 {
<a name="l02504"></a>02504     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str = *strp;
<a name="l02505"></a>02505     <span class="keywordtype">long</span> limit = *lp;
<a name="l02506"></a>02506 
<a name="l02507"></a>02507     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a92621ca418c11e96d4862166f9076a73">NEED_READCONV</a>(fptr)) {
<a name="l02508"></a>02508         <a class="code" href="../../df/d0a/io_8c.html#ace89c001caf3ebc8943c8f06c0aab552">SET_BINARY_MODE</a>(fptr);
<a name="l02509"></a>02509         <a class="code" href="../../df/d0a/io_8c.html#a7270c50b73afa5c8c999dacfab097524">make_readconv</a>(fptr, 0);
<a name="l02510"></a>02510         <span class="keywordflow">do</span> {
<a name="l02511"></a>02511             <span class="keyword">const</span> <span class="keywordtype">char</span> *p, *e;
<a name="l02512"></a>02512             <span class="keywordtype">int</span> searchlen;
<a name="l02513"></a>02513             <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>) {
<a name="l02514"></a>02514                 p = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>;
<a name="l02515"></a>02515                 searchlen = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>;
<a name="l02516"></a>02516                 <span class="keywordflow">if</span> (0 &lt; limit &amp;&amp; limit &lt; searchlen)
<a name="l02517"></a>02517                     searchlen = (int)limit;
<a name="l02518"></a>02518                 e = memchr(p, delim, searchlen);
<a name="l02519"></a>02519                 <span class="keywordflow">if</span> (e) {
<a name="l02520"></a>02520                     <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = (int)(e-p+1);
<a name="l02521"></a>02521                     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str))
<a name="l02522"></a>02522                         *strp = str = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(p, len);
<a name="l02523"></a>02523                     <span class="keywordflow">else</span>
<a name="l02524"></a>02524                         <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(str, p, len);
<a name="l02525"></a>02525                     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> += len;
<a name="l02526"></a>02526                     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> -= len;
<a name="l02527"></a>02527                     limit -= len;
<a name="l02528"></a>02528                     *lp = limit;
<a name="l02529"></a>02529                     <span class="keywordflow">return</span> delim;
<a name="l02530"></a>02530                 }
<a name="l02531"></a>02531 
<a name="l02532"></a>02532                 <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str))
<a name="l02533"></a>02533                     *strp = str = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(p, searchlen);
<a name="l02534"></a>02534                 <span class="keywordflow">else</span>
<a name="l02535"></a>02535                     <a class="code" href="../../db/d2e/intern_8h.html#a4dff49e6d9aa925fd94fc5100b3c399b">rb_str_buf_cat</a>(str, p, searchlen);
<a name="l02536"></a>02536                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> += searchlen;
<a name="l02537"></a>02537                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> -= searchlen;
<a name="l02538"></a>02538                 limit -= searchlen;
<a name="l02539"></a>02539 
<a name="l02540"></a>02540                 <span class="keywordflow">if</span> (limit == 0) {
<a name="l02541"></a>02541                     *lp = limit;
<a name="l02542"></a>02542                     <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str)[<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str)-1];
<a name="l02543"></a>02543                 }
<a name="l02544"></a>02544             }
<a name="l02545"></a>02545         } <span class="keywordflow">while</span> (<a class="code" href="../../df/d0a/io_8c.html#a97e0f8279ec629d58f6690fa57e8704f">more_char</a>(fptr) != <a class="code" href="../../df/d0a/io_8c.html#adb561f38bf9315a2ec31e9f6926d0618">MORE_CHAR_FINISHED</a>);
<a name="l02546"></a>02546         <a class="code" href="../../df/d0a/io_8c.html#a89693737d8688aa1fea03c70711799ab">clear_readconv</a>(fptr);
<a name="l02547"></a>02547         *lp = limit;
<a name="l02548"></a>02548         <span class="keywordflow">return</span> <a class="code" href="../../da/d50/vsnprintf_8c.html#a59adc4c82490d23754cd39c2fb99b0da">EOF</a>;
<a name="l02549"></a>02549     }
<a name="l02550"></a>02550 
<a name="l02551"></a>02551     <a class="code" href="../../df/d0a/io_8c.html#abd7495bb74588d590a98112929d9010c">NEED_NEWLINE_DECORATOR_ON_READ_CHECK</a>(fptr);
<a name="l02552"></a>02552     <span class="keywordflow">do</span> {
<a name="l02553"></a>02553         <span class="keywordtype">long</span> pending = <a class="code" href="../../df/d0a/io_8c.html#a3d1f21b592c8d0533a4eb4795837f453">READ_DATA_PENDING_COUNT</a>(fptr);
<a name="l02554"></a>02554         <span class="keywordflow">if</span> (pending &gt; 0) {
<a name="l02555"></a>02555             <span class="keyword">const</span> <span class="keywordtype">char</span> *p = <a class="code" href="../../df/d0a/io_8c.html#a921ad10da930526526f7623973938cb6">READ_DATA_PENDING_PTR</a>(fptr);
<a name="l02556"></a>02556             <span class="keyword">const</span> <span class="keywordtype">char</span> *e;
<a name="l02557"></a>02557             <span class="keywordtype">long</span> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a>;
<a name="l02558"></a>02558 
<a name="l02559"></a>02559             <span class="keywordflow">if</span> (limit &gt; 0 &amp;&amp; pending &gt; limit) pending = limit;
<a name="l02560"></a>02560             e = memchr(p, delim, pending);
<a name="l02561"></a>02561             <span class="keywordflow">if</span> (e) pending = e - p + 1;
<a name="l02562"></a>02562             <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str)) {
<a name="l02563"></a>02563                 last = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str);
<a name="l02564"></a>02564                 <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(str, last + pending);
<a name="l02565"></a>02565             }
<a name="l02566"></a>02566             <span class="keywordflow">else</span> {
<a name="l02567"></a>02567                 last = 0;
<a name="l02568"></a>02568                 *strp = str = <a class="code" href="../../db/d2e/intern_8h.html#a65dee742ae2daaab92ac8974cb2fbff2">rb_str_buf_new</a>(pending);
<a name="l02569"></a>02569                 <a class="code" href="../../d8/d81/ruby__missing_8h.html#a89ed8cb86ca6dd49d2db67adae809057">rb_str_set_len</a>(str, pending);
<a name="l02570"></a>02570             }
<a name="l02571"></a>02571             <a class="code" href="../../df/d0a/io_8c.html#af0cb01766b96b9ba7f84b4ebd4e2099d">read_buffered_data</a>(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str) + last, pending, fptr); <span class="comment">/* must not fail */</span>
<a name="l02572"></a>02572             limit -= pending;
<a name="l02573"></a>02573             *lp = limit;
<a name="l02574"></a>02574             <span class="keywordflow">if</span> (e) <span class="keywordflow">return</span> delim;
<a name="l02575"></a>02575             <span class="keywordflow">if</span> (limit == 0)
<a name="l02576"></a>02576                 <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str)[<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str)-1];
<a name="l02577"></a>02577         }
<a name="l02578"></a>02578         <a class="code" href="../../df/d0a/io_8c.html#a704f29b50a37b53c4a9f4f876d350f0d">READ_CHECK</a>(fptr);
<a name="l02579"></a>02579     } <span class="keywordflow">while</span> (<a class="code" href="../../df/d0a/io_8c.html#a7d1e7b95139715aa6fa393b30e6a39e8">io_fillbuf</a>(fptr) &gt;= 0);
<a name="l02580"></a>02580     *lp = limit;
<a name="l02581"></a>02581     <span class="keywordflow">return</span> <a class="code" href="../../da/d50/vsnprintf_8c.html#a59adc4c82490d23754cd39c2fb99b0da">EOF</a>;
<a name="l02582"></a>02582 }
<a name="l02583"></a>02583 
<a name="l02584"></a>02584 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l02585"></a><a class="code" href="../../df/d0a/io_8c.html#aa896e345efa29eb5c7dd87a58a96a7a5">02585</a> <a class="code" href="../../df/d0a/io_8c.html#aa896e345efa29eb5c7dd87a58a96a7a5">swallow</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <span class="keywordtype">int</span> <a class="code" href="../../d3/d09/ripper_8y.html#a0c940d9e4ce4cfee55d7ccf714a1303d">term</a>)
<a name="l02586"></a>02586 {
<a name="l02587"></a>02587     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a92621ca418c11e96d4862166f9076a73">NEED_READCONV</a>(fptr)) {
<a name="l02588"></a>02588         <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc = <a class="code" href="../../df/d0a/io_8c.html#aa3b568197b019bda6a9aea4fbe2153eb">io_read_encoding</a>(fptr);
<a name="l02589"></a>02589         <span class="keywordtype">int</span> needconv = <a class="code" href="../../d5/de3/encoding_8h.html#aaffb0395eb9bf0b3ba3175fa5c9c1615">rb_enc_mbminlen</a>(enc) != 1;
<a name="l02590"></a>02590         <a class="code" href="../../df/d0a/io_8c.html#ace89c001caf3ebc8943c8f06c0aab552">SET_BINARY_MODE</a>(fptr);
<a name="l02591"></a>02591         <a class="code" href="../../df/d0a/io_8c.html#a7270c50b73afa5c8c999dacfab097524">make_readconv</a>(fptr, 0);
<a name="l02592"></a>02592         <span class="keywordflow">do</span> {
<a name="l02593"></a>02593             <span class="keywordtype">size_t</span> <a class="code" href="../../d8/d36/signal_8c.html#a6f2334d7e90694f211f708b860dfa486">cnt</a>;
<a name="l02594"></a>02594             <span class="keywordflow">while</span> ((cnt = <a class="code" href="../../df/d0a/io_8c.html#aa477a8eca97872ed13fa86fc6ed6e9d4">READ_CHAR_PENDING_COUNT</a>(fptr)) &gt; 0) {
<a name="l02595"></a>02595                 <span class="keyword">const</span> <span class="keywordtype">char</span> *p = <a class="code" href="../../df/d0a/io_8c.html#a5287955867e0e471ee9341fbbda041b8">READ_CHAR_PENDING_PTR</a>(fptr);
<a name="l02596"></a>02596                 <span class="keywordtype">int</span> i;
<a name="l02597"></a>02597                 <span class="keywordflow">if</span> (!needconv) {
<a name="l02598"></a>02598                     <span class="keywordflow">if</span> (*p != term) <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02599"></a>02599                     i = (int)cnt;
<a name="l02600"></a>02600                     <span class="keywordflow">while</span> (--i &amp;&amp; *++p == term);
<a name="l02601"></a>02601                 }
<a name="l02602"></a>02602                 <span class="keywordflow">else</span> {
<a name="l02603"></a>02603                     <span class="keyword">const</span> <span class="keywordtype">char</span> *e = p + cnt;
<a name="l02604"></a>02604                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/db5/encoding_8c.html#af6663b51ce857cfe600a8bc48434d6f2">rb_enc_ascget</a>(p, e, &amp;i, enc) != term) <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02605"></a>02605                     <span class="keywordflow">while</span> ((p += i) &lt; e &amp;&amp; <a class="code" href="../../d5/db5/encoding_8c.html#af6663b51ce857cfe600a8bc48434d6f2">rb_enc_ascget</a>(p, e, &amp;i, enc) == term);
<a name="l02606"></a>02606                     i = (int)(e - p);
<a name="l02607"></a>02607                 }
<a name="l02608"></a>02608                 <a class="code" href="../../df/d0a/io_8c.html#a20e719e6f50c2ea1857b4d85ee09b2ea">io_shift_cbuf</a>(fptr, (<span class="keywordtype">int</span>)cnt - i, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02609"></a>02609             }
<a name="l02610"></a>02610         } <span class="keywordflow">while</span> (<a class="code" href="../../df/d0a/io_8c.html#a97e0f8279ec629d58f6690fa57e8704f">more_char</a>(fptr) != <a class="code" href="../../df/d0a/io_8c.html#adb561f38bf9315a2ec31e9f6926d0618">MORE_CHAR_FINISHED</a>);
<a name="l02611"></a>02611         <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02612"></a>02612     }
<a name="l02613"></a>02613 
<a name="l02614"></a>02614     <a class="code" href="../../df/d0a/io_8c.html#abd7495bb74588d590a98112929d9010c">NEED_NEWLINE_DECORATOR_ON_READ_CHECK</a>(fptr);
<a name="l02615"></a>02615     <span class="keywordflow">do</span> {
<a name="l02616"></a>02616         <span class="keywordtype">size_t</span> <a class="code" href="../../d8/d36/signal_8c.html#a6f2334d7e90694f211f708b860dfa486">cnt</a>;
<a name="l02617"></a>02617         <span class="keywordflow">while</span> ((cnt = <a class="code" href="../../df/d0a/io_8c.html#a3d1f21b592c8d0533a4eb4795837f453">READ_DATA_PENDING_COUNT</a>(fptr)) &gt; 0) {
<a name="l02618"></a>02618             <span class="keywordtype">char</span> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>[1024];
<a name="l02619"></a>02619             <span class="keyword">const</span> <span class="keywordtype">char</span> *p = <a class="code" href="../../df/d0a/io_8c.html#a921ad10da930526526f7623973938cb6">READ_DATA_PENDING_PTR</a>(fptr);
<a name="l02620"></a>02620             <span class="keywordtype">int</span> i;
<a name="l02621"></a>02621             <span class="keywordflow">if</span> (cnt &gt; <span class="keyword">sizeof</span> buf) cnt = <span class="keyword">sizeof</span> buf;
<a name="l02622"></a>02622             <span class="keywordflow">if</span> (*p != term) <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02623"></a>02623             i = (int)cnt;
<a name="l02624"></a>02624             <span class="keywordflow">while</span> (--i &amp;&amp; *++p == term);
<a name="l02625"></a>02625             <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#af0cb01766b96b9ba7f84b4ebd4e2099d">read_buffered_data</a>(buf, cnt - i, fptr)) <span class="comment">/* must not fail */</span>
<a name="l02626"></a>02626                 <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l02627"></a>02627         }
<a name="l02628"></a>02628         <a class="code" href="../../df/d0a/io_8c.html#a704f29b50a37b53c4a9f4f876d350f0d">READ_CHECK</a>(fptr);
<a name="l02629"></a>02629     } <span class="keywordflow">while</span> (<a class="code" href="../../df/d0a/io_8c.html#a7d1e7b95139715aa6fa393b30e6a39e8">io_fillbuf</a>(fptr) == 0);
<a name="l02630"></a>02630     <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02631"></a>02631 }
<a name="l02632"></a>02632 
<a name="l02633"></a>02633 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02634"></a><a class="code" href="../../df/d0a/io_8c.html#ad23435815f9e5c82e86fbf240bfcf729">02634</a> <a class="code" href="../../df/d0a/io_8c.html#ad23435815f9e5c82e86fbf240bfcf729">rb_io_getline_fast</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l02635"></a>02635 {
<a name="l02636"></a>02636     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02637"></a>02637     <span class="keywordtype">int</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = 0;
<a name="l02638"></a>02638     <span class="keywordtype">long</span> pos = 0;
<a name="l02639"></a>02639     <span class="keywordtype">int</span> cr = 0;
<a name="l02640"></a>02640 
<a name="l02641"></a>02641     <span class="keywordflow">for</span> (;;) {
<a name="l02642"></a>02642         <span class="keywordtype">int</span> pending = <a class="code" href="../../df/d0a/io_8c.html#a3d1f21b592c8d0533a4eb4795837f453">READ_DATA_PENDING_COUNT</a>(fptr);
<a name="l02643"></a>02643 
<a name="l02644"></a>02644         <span class="keywordflow">if</span> (pending &gt; 0) {
<a name="l02645"></a>02645             <span class="keyword">const</span> <span class="keywordtype">char</span> *p = <a class="code" href="../../df/d0a/io_8c.html#a921ad10da930526526f7623973938cb6">READ_DATA_PENDING_PTR</a>(fptr);
<a name="l02646"></a>02646             <span class="keyword">const</span> <span class="keywordtype">char</span> *e;
<a name="l02647"></a>02647 
<a name="l02648"></a>02648             e = memchr(p, <span class="charliteral">&apos;\n&apos;</span>, pending);
<a name="l02649"></a>02649             <span class="keywordflow">if</span> (e) {
<a name="l02650"></a>02650                 pending = (int)(e - p + 1);
<a name="l02651"></a>02651             }
<a name="l02652"></a>02652             <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str)) {
<a name="l02653"></a>02653                 str = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(p, pending);
<a name="l02654"></a>02654                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> += pending;
<a name="l02655"></a>02655                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> -= pending;
<a name="l02656"></a>02656             }
<a name="l02657"></a>02657             <span class="keywordflow">else</span> {
<a name="l02658"></a>02658                 <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(str, len + pending);
<a name="l02659"></a>02659                 <a class="code" href="../../df/d0a/io_8c.html#af0cb01766b96b9ba7f84b4ebd4e2099d">read_buffered_data</a>(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str)+len, pending, fptr);
<a name="l02660"></a>02660             }
<a name="l02661"></a>02661             len += pending;
<a name="l02662"></a>02662             <span class="keywordflow">if</span> (cr != <a class="code" href="../../d5/de3/encoding_8h.html#abb86fbc02fc2b78d928825ea6d6922f9">ENC_CODERANGE_BROKEN</a>)
<a name="l02663"></a>02663                 pos += <a class="code" href="../../d5/de3/encoding_8h.html#ac1fbec2516e7dbaafbdf8933c5ad7946">rb_str_coderange_scan_restartable</a>(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str) + pos, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str) + len, enc, &amp;cr);
<a name="l02664"></a>02664             <span class="keywordflow">if</span> (e) <span class="keywordflow">break</span>;
<a name="l02665"></a>02665         }
<a name="l02666"></a>02666         <a class="code" href="../../df/d0a/io_8c.html#a704f29b50a37b53c4a9f4f876d350f0d">READ_CHECK</a>(fptr);
<a name="l02667"></a>02667         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a7d1e7b95139715aa6fa393b30e6a39e8">io_fillbuf</a>(fptr) &lt; 0) {
<a name="l02668"></a>02668             <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02669"></a>02669             <span class="keywordflow">break</span>;
<a name="l02670"></a>02670         }
<a name="l02671"></a>02671     }
<a name="l02672"></a>02672 
<a name="l02673"></a>02673     str = <a class="code" href="../../df/d0a/io_8c.html#acd3c89cc4bd3aaef3dfea3b3fa2c6360">io_enc_str</a>(str, fptr);
<a name="l02674"></a>02674     <a class="code" href="../../d5/de3/encoding_8h.html#aefe5772c0116cf7131a5227de7243dbc">ENC_CODERANGE_SET</a>(str, cr);
<a name="l02675"></a>02675     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a397be62fbdfe88a3763377f262241ca7">lineno</a>++;
<a name="l02676"></a>02676     <span class="keywordflow">if</span> (io == <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file) {
<a name="l02677"></a>02677         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno++;
<a name="l02678"></a>02678         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.last_lineno = <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno;
<a name="l02679"></a>02679     }
<a name="l02680"></a>02680     <span class="keywordflow">else</span> {
<a name="l02681"></a>02681         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.last_lineno = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a397be62fbdfe88a3763377f262241ca7">lineno</a>;
<a name="l02682"></a>02682     }
<a name="l02683"></a>02683 
<a name="l02684"></a>02684     <span class="keywordflow">return</span> str;
<a name="l02685"></a>02685 }
<a name="l02686"></a>02686 
<a name="l02687"></a>02687 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02688"></a><a class="code" href="../../df/d0a/io_8c.html#a393a6b0219ae8e05ac1d74a25d8dfc45">02688</a> <a class="code" href="../../df/d0a/io_8c.html#a393a6b0219ae8e05ac1d74a25d8dfc45">prepare_getline_args</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *rsp, <span class="keywordtype">long</span> *limit, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l02689"></a>02689 {
<a name="l02690"></a>02690     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> rs = <a class="code" href="../../db/d2e/intern_8h.html#a6d19bb99247117d9d8b880ab14ad8d25">rb_rs</a>, lim = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02691"></a>02691     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l02692"></a>02692 
<a name="l02693"></a>02693     <span class="keywordflow">if</span> (argc == 1) {
<a name="l02694"></a>02694         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> tmp = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02695"></a>02695 
<a name="l02696"></a>02696         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(argv[0]) || !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(tmp = <a class="code" href="../../db/d2e/intern_8h.html#a669b6063704b2d304844bd1553217cf0">rb_check_string_type</a>(argv[0]))) {
<a name="l02697"></a>02697             rs = tmp;
<a name="l02698"></a>02698         }
<a name="l02699"></a>02699         <span class="keywordflow">else</span> {
<a name="l02700"></a>02700             lim = argv[0];
<a name="l02701"></a>02701         }
<a name="l02702"></a>02702     }
<a name="l02703"></a>02703     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (2 &lt;= argc) {
<a name="l02704"></a>02704         <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;2&quot;</span>, &amp;rs, &amp;lim);
<a name="l02705"></a>02705         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(rs))
<a name="l02706"></a>02706             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(rs);
<a name="l02707"></a>02707     }
<a name="l02708"></a>02708     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(rs)) {
<a name="l02709"></a>02709         <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc_rs, *enc_io;
<a name="l02710"></a>02710 
<a name="l02711"></a>02711         <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l02712"></a>02712         enc_rs = <a class="code" href="../../d5/db5/encoding_8c.html#ac21ed764f3b39453b6a848dd64a19585">rb_enc_get</a>(rs);
<a name="l02713"></a>02713         enc_io = <a class="code" href="../../df/d0a/io_8c.html#aa3b568197b019bda6a9aea4fbe2153eb">io_read_encoding</a>(fptr);
<a name="l02714"></a>02714         <span class="keywordflow">if</span> (enc_io != enc_rs &amp;&amp;
<a name="l02715"></a>02715             (<a class="code" href="../../d5/de3/encoding_8h.html#a5282c41e11a68fe310f45c9a326ae2b8">rb_enc_str_coderange</a>(rs) != <a class="code" href="../../d5/de3/encoding_8h.html#a0a0e73a2d98205044e1ad19432502c5b">ENC_CODERANGE_7BIT</a> ||
<a name="l02716"></a>02716              (<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(rs) &gt; 0 &amp;&amp; !<a class="code" href="../../d5/de3/encoding_8h.html#a8b18a09a3055d3006c6d5baeaa6e7c72">rb_enc_asciicompat</a>(enc_io)))) {
<a name="l02717"></a>02717             <span class="keywordflow">if</span> (rs == <a class="code" href="../../db/d2e/intern_8h.html#ab707a74e9c34626c05d20431ad137570">rb_default_rs</a>) {
<a name="l02718"></a>02718                 rs = <a class="code" href="../../d5/de3/encoding_8h.html#a6707b730597e0e614213beb11670aca2">rb_enc_str_new</a>(0, 0, enc_io);
<a name="l02719"></a>02719                 <a class="code" href="../../db/d2e/intern_8h.html#ab60c5953186b8b096a23a3c7a8c0a414">rb_str_buf_cat_ascii</a>(rs, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02720"></a>02720             }
<a name="l02721"></a>02721             <span class="keywordflow">else</span> {
<a name="l02722"></a>02722                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;encoding mismatch: %s IO with %s RS&quot;</span>,
<a name="l02723"></a>02723                          <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(enc_io),
<a name="l02724"></a>02724                          <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(enc_rs));
<a name="l02725"></a>02725             }
<a name="l02726"></a>02726         }
<a name="l02727"></a>02727     }
<a name="l02728"></a>02728     *rsp = rs;
<a name="l02729"></a>02729     *limit = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(lim) ? -1L : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(lim);
<a name="l02730"></a>02730 }
<a name="l02731"></a>02731 
<a name="l02732"></a>02732 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02733"></a><a class="code" href="../../df/d0a/io_8c.html#aea533e8711f2958efd92ed2a8a5718cb">02733</a> <a class="code" href="../../df/d0a/io_8c.html#aea533e8711f2958efd92ed2a8a5718cb">rb_io_getline_1</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> rs, <span class="keywordtype">long</span> limit, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l02734"></a>02734 {
<a name="l02735"></a>02735     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02736"></a>02736     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l02737"></a>02737     <span class="keywordtype">int</span> nolimit = 0;
<a name="l02738"></a>02738     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc;
<a name="l02739"></a>02739 
<a name="l02740"></a>02740     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l02741"></a>02741     <a class="code" href="../../dc/dac/io_8h.html#acbd19ff86a565ed9e9f15e4f49736f3d">rb_io_check_char_readable</a>(fptr);
<a name="l02742"></a>02742     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(rs) &amp;&amp; limit &lt; 0) {
<a name="l02743"></a>02743         str = <a class="code" href="../../df/d0a/io_8c.html#af2554e01814c78482ef25c774bbf7477">read_all</a>(fptr, 0, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l02744"></a>02744         <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str) == 0) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02745"></a>02745     }
<a name="l02746"></a>02746     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (limit == 0) {
<a name="l02747"></a>02747         <span class="keywordflow">return</span> <a class="code" href="../../d5/de3/encoding_8h.html#a6707b730597e0e614213beb11670aca2">rb_enc_str_new</a>(0, 0, <a class="code" href="../../df/d0a/io_8c.html#aa3b568197b019bda6a9aea4fbe2153eb">io_read_encoding</a>(fptr));
<a name="l02748"></a>02748     }
<a name="l02749"></a>02749     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rs == <a class="code" href="../../db/d2e/intern_8h.html#ab707a74e9c34626c05d20431ad137570">rb_default_rs</a> &amp;&amp; limit &lt; 0 &amp;&amp; !<a class="code" href="../../df/d0a/io_8c.html#a92621ca418c11e96d4862166f9076a73">NEED_READCONV</a>(fptr) &amp;&amp;
<a name="l02750"></a>02750              <a class="code" href="../../d5/de3/encoding_8h.html#a8b18a09a3055d3006c6d5baeaa6e7c72">rb_enc_asciicompat</a>(enc = <a class="code" href="../../df/d0a/io_8c.html#aa3b568197b019bda6a9aea4fbe2153eb">io_read_encoding</a>(fptr))) {
<a name="l02751"></a>02751         <a class="code" href="../../df/d0a/io_8c.html#abd7495bb74588d590a98112929d9010c">NEED_NEWLINE_DECORATOR_ON_READ_CHECK</a>(fptr);
<a name="l02752"></a>02752         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#ad23435815f9e5c82e86fbf240bfcf729">rb_io_getline_fast</a>(fptr, enc, io);
<a name="l02753"></a>02753     }
<a name="l02754"></a>02754     <span class="keywordflow">else</span> {
<a name="l02755"></a>02755         <span class="keywordtype">int</span> c, newline = -1;
<a name="l02756"></a>02756         <span class="keyword">const</span> <span class="keywordtype">char</span> *rsptr = 0;
<a name="l02757"></a>02757         <span class="keywordtype">long</span> rslen = 0;
<a name="l02758"></a>02758         <span class="keywordtype">int</span> rspara = 0;
<a name="l02759"></a>02759         <span class="keywordtype">int</span> extra_limit = 16;
<a name="l02760"></a>02760 
<a name="l02761"></a>02761         <a class="code" href="../../df/d0a/io_8c.html#ace89c001caf3ebc8943c8f06c0aab552">SET_BINARY_MODE</a>(fptr);
<a name="l02762"></a>02762         enc = <a class="code" href="../../df/d0a/io_8c.html#aa3b568197b019bda6a9aea4fbe2153eb">io_read_encoding</a>(fptr);
<a name="l02763"></a>02763 
<a name="l02764"></a>02764         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(rs)) {
<a name="l02765"></a>02765             rslen = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(rs);
<a name="l02766"></a>02766             <span class="keywordflow">if</span> (rslen == 0) {
<a name="l02767"></a>02767                 rsptr = <span class="stringliteral">&quot;\n\n&quot;</span>;
<a name="l02768"></a>02768                 rslen = 2;
<a name="l02769"></a>02769                 rspara = 1;
<a name="l02770"></a>02770                 <a class="code" href="../../df/d0a/io_8c.html#aa896e345efa29eb5c7dd87a58a96a7a5">swallow</a>(fptr, <span class="charliteral">&apos;\n&apos;</span>);
<a name="l02771"></a>02771                 rs = 0;
<a name="l02772"></a>02772                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/de3/encoding_8h.html#a8b18a09a3055d3006c6d5baeaa6e7c72">rb_enc_asciicompat</a>(enc)) {
<a name="l02773"></a>02773                     rs = <a class="code" href="../../db/d2e/intern_8h.html#aed107a4eacd5f626b554d2d341b58bd5">rb_usascii_str_new</a>(rsptr, rslen);
<a name="l02774"></a>02774                     rs = <a class="code" href="../../d5/de3/encoding_8h.html#a92c4c79471eb00ba915287505a118401">rb_str_encode</a>(rs, <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(enc), 0, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l02775"></a>02775                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7ae8fa209abf837905d53c1c4be7c75d">OBJ_FREEZE</a>(rs);
<a name="l02776"></a>02776                     rsptr = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(rs);
<a name="l02777"></a>02777                     rslen = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(rs);
<a name="l02778"></a>02778                 }
<a name="l02779"></a>02779             }
<a name="l02780"></a>02780             <span class="keywordflow">else</span> {
<a name="l02781"></a>02781                 rsptr = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(rs);
<a name="l02782"></a>02782             }
<a name="l02783"></a>02783             newline = (<span class="keywordtype">unsigned</span> char)rsptr[rslen - 1];
<a name="l02784"></a>02784         }
<a name="l02785"></a>02785 
<a name="l02786"></a>02786         <span class="comment">/* MS - Optimisation */</span>
<a name="l02787"></a>02787         <span class="keywordflow">while</span> ((c = <a class="code" href="../../df/d0a/io_8c.html#a68787af67157f1c6a698e50aa6791af8">appendline</a>(fptr, newline, &amp;str, &amp;limit)) != <a class="code" href="../../da/d50/vsnprintf_8c.html#a59adc4c82490d23754cd39c2fb99b0da">EOF</a>) {
<a name="l02788"></a>02788             <span class="keyword">const</span> <span class="keywordtype">char</span> *s, *p, *pp, *e;
<a name="l02789"></a>02789 
<a name="l02790"></a>02790             <span class="keywordflow">if</span> (c == newline) {
<a name="l02791"></a>02791                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str) &lt; rslen) <span class="keywordflow">continue</span>;
<a name="l02792"></a>02792                 s = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str);
<a name="l02793"></a>02793                 e = s + <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str);
<a name="l02794"></a>02794                 p = e - rslen;
<a name="l02795"></a>02795                 pp = <a class="code" href="../../d5/de3/encoding_8h.html#a2282b636d8d5c4c0e73d313cf97a4365">rb_enc_left_char_head</a>(s, p, e, enc);
<a name="l02796"></a>02796                 <span class="keywordflow">if</span> (pp != p) <span class="keywordflow">continue</span>;
<a name="l02797"></a>02797                 <span class="keywordflow">if</span> (!rspara) <a class="code" href="../../df/d0a/io_8c.html#a7a584aa0dc2ca6c929cea5e2c95f2309">rscheck</a>(rsptr, rslen, rs);
<a name="l02798"></a>02798                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d21/memcmp_8c.html#a1499ab2d0a3da86cbc3e688294f60a48">memcmp</a>(p, rsptr, rslen) == 0) <span class="keywordflow">break</span>;
<a name="l02799"></a>02799             }
<a name="l02800"></a>02800             <span class="keywordflow">if</span> (limit == 0) {
<a name="l02801"></a>02801                 s = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str);
<a name="l02802"></a>02802                 p = s + <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str);
<a name="l02803"></a>02803                 pp = <a class="code" href="../../d5/de3/encoding_8h.html#a2282b636d8d5c4c0e73d313cf97a4365">rb_enc_left_char_head</a>(s, p-1, p, enc);
<a name="l02804"></a>02804                 <span class="keywordflow">if</span> (extra_limit &amp;&amp;
<a name="l02805"></a>02805                     <a class="code" href="../../d5/de3/encoding_8h.html#aaf154483822592f1b9813b1f489bf772">MBCLEN_NEEDMORE_P</a>(<a class="code" href="../../d5/db5/encoding_8c.html#a0c6003b6aeaed218d841974b00c95870">rb_enc_precise_mbclen</a>(pp, p, enc))) {
<a name="l02806"></a>02806                     <span class="comment">/* relax the limit while incomplete character.</span>
<a name="l02807"></a>02807 <span class="comment">                     * extra_limit limits the relax length */</span>
<a name="l02808"></a>02808                     limit = 1;
<a name="l02809"></a>02809                     extra_limit--;
<a name="l02810"></a>02810                 }
<a name="l02811"></a>02811                 <span class="keywordflow">else</span> {
<a name="l02812"></a>02812                     nolimit = 1;
<a name="l02813"></a>02813                     <span class="keywordflow">break</span>;
<a name="l02814"></a>02814                 }
<a name="l02815"></a>02815             }
<a name="l02816"></a>02816         }
<a name="l02817"></a>02817 
<a name="l02818"></a>02818         <span class="keywordflow">if</span> (rspara) {
<a name="l02819"></a>02819             <span class="keywordflow">if</span> (c != <a class="code" href="../../da/d50/vsnprintf_8c.html#a59adc4c82490d23754cd39c2fb99b0da">EOF</a>) {
<a name="l02820"></a>02820                 <a class="code" href="../../df/d0a/io_8c.html#aa896e345efa29eb5c7dd87a58a96a7a5">swallow</a>(fptr, <span class="charliteral">&apos;\n&apos;</span>);
<a name="l02821"></a>02821             }
<a name="l02822"></a>02822         }
<a name="l02823"></a>02823         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str))
<a name="l02824"></a>02824             str = <a class="code" href="../../df/d0a/io_8c.html#acd3c89cc4bd3aaef3dfea3b3fa2c6360">io_enc_str</a>(str, fptr);
<a name="l02825"></a>02825     }
<a name="l02826"></a>02826 
<a name="l02827"></a>02827     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str)) {
<a name="l02828"></a>02828         <span class="keywordflow">if</span> (!nolimit) {
<a name="l02829"></a>02829             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a397be62fbdfe88a3763377f262241ca7">lineno</a>++;
<a name="l02830"></a>02830             <span class="keywordflow">if</span> (io == <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file) {
<a name="l02831"></a>02831                 <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno++;
<a name="l02832"></a>02832                 <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.last_lineno = <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno;
<a name="l02833"></a>02833             }
<a name="l02834"></a>02834             <span class="keywordflow">else</span> {
<a name="l02835"></a>02835                 <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.last_lineno = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a397be62fbdfe88a3763377f262241ca7">lineno</a>;
<a name="l02836"></a>02836             }
<a name="l02837"></a>02837         }
<a name="l02838"></a>02838     }
<a name="l02839"></a>02839 
<a name="l02840"></a>02840     <span class="keywordflow">return</span> str;
<a name="l02841"></a>02841 }
<a name="l02842"></a>02842 
<a name="l02843"></a>02843 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02844"></a><a class="code" href="../../df/d0a/io_8c.html#aa2d3a2ac2bfedf356cd73efe1c16e837">02844</a> <a class="code" href="../../df/d0a/io_8c.html#aa2d3a2ac2bfedf356cd73efe1c16e837">rb_io_getline</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l02845"></a>02845 {
<a name="l02846"></a>02846     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> rs;
<a name="l02847"></a>02847     <span class="keywordtype">long</span> limit;
<a name="l02848"></a>02848 
<a name="l02849"></a>02849     <a class="code" href="../../df/d0a/io_8c.html#a393a6b0219ae8e05ac1d74a25d8dfc45">prepare_getline_args</a>(argc, argv, &amp;rs, &amp;limit, io);
<a name="l02850"></a>02850     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#aea533e8711f2958efd92ed2a8a5718cb">rb_io_getline_1</a>(rs, limit, io);
<a name="l02851"></a>02851 }
<a name="l02852"></a>02852 
<a name="l02853"></a>02853 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02854"></a><a class="code" href="../../df/d0a/io_8c.html#a056f4fe62cbdf012ab139afc9ea806fe">02854</a> <a class="code" href="../../db/d2e/intern_8h.html#a4f0d1bd3c88e8f31ee0b41afce9e94fb">rb_io_gets</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l02855"></a>02855 {
<a name="l02856"></a>02856     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#aea533e8711f2958efd92ed2a8a5718cb">rb_io_getline_1</a>(<a class="code" href="../../db/d2e/intern_8h.html#ab707a74e9c34626c05d20431ad137570">rb_default_rs</a>, -1, io);
<a name="l02857"></a>02857 }
<a name="l02858"></a>02858 
<a name="l02859"></a>02859 <span class="comment">/*</span>
<a name="l02860"></a>02860 <span class="comment"> *  call-seq:</span>
<a name="l02861"></a>02861 <span class="comment"> *     ios.gets(sep=$/)     -&gt; string or nil</span>
<a name="l02862"></a>02862 <span class="comment"> *     ios.gets(limit)      -&gt; string or nil</span>
<a name="l02863"></a>02863 <span class="comment"> *     ios.gets(sep, limit) -&gt; string or nil</span>
<a name="l02864"></a>02864 <span class="comment"> *</span>
<a name="l02865"></a>02865 <span class="comment"> *  Reads the next ``line&apos;&apos; from the I/O stream; lines are separated by</span>
<a name="l02866"></a>02866 <span class="comment"> *  &lt;i&gt;sep&lt;/i&gt;. A separator of &lt;code&gt;nil&lt;/code&gt; reads the entire</span>
<a name="l02867"></a>02867 <span class="comment"> *  contents, and a zero-length separator reads the input a paragraph at</span>
<a name="l02868"></a>02868 <span class="comment"> *  a time (two successive newlines in the input separate paragraphs).</span>
<a name="l02869"></a>02869 <span class="comment"> *  The stream must be opened for reading or an &lt;code&gt;IOError&lt;/code&gt;</span>
<a name="l02870"></a>02870 <span class="comment"> *  will be raised. The line read in will be returned and also assigned</span>
<a name="l02871"></a>02871 <span class="comment"> *  to &lt;code&gt;$_&lt;/code&gt;. Returns &lt;code&gt;nil&lt;/code&gt; if called at end of</span>
<a name="l02872"></a>02872 <span class="comment"> *  file.  If the first argument is an integer, or optional second</span>
<a name="l02873"></a>02873 <span class="comment"> *  argument is given, the returning string would not be longer than the</span>
<a name="l02874"></a>02874 <span class="comment"> *  given value in bytes.</span>
<a name="l02875"></a>02875 <span class="comment"> *</span>
<a name="l02876"></a>02876 <span class="comment"> *     File.new(&quot;testfile&quot;).gets   #=&gt; &quot;This is line one\n&quot;</span>
<a name="l02877"></a>02877 <span class="comment"> *     $_                          #=&gt; &quot;This is line one\n&quot;</span>
<a name="l02878"></a>02878 <span class="comment"> */</span>
<a name="l02879"></a>02879 
<a name="l02880"></a>02880 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02881"></a><a class="code" href="../../df/d0a/io_8c.html#a82aa0c7d60448d8caca4fccd7ced8e3f">02881</a> <a class="code" href="../../df/d0a/io_8c.html#a82aa0c7d60448d8caca4fccd7ced8e3f">rb_io_gets_m</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l02882"></a>02882 {
<a name="l02883"></a>02883     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str;
<a name="l02884"></a>02884 
<a name="l02885"></a>02885     str = <a class="code" href="../../df/d0a/io_8c.html#aa2d3a2ac2bfedf356cd73efe1c16e837">rb_io_getline</a>(argc, argv, io);
<a name="l02886"></a>02886     <a class="code" href="../../db/d2e/intern_8h.html#ada36b7e0e23335fa38937f0b5328601d">rb_lastline_set</a>(str);
<a name="l02887"></a>02887 
<a name="l02888"></a>02888     <span class="keywordflow">return</span> str;
<a name="l02889"></a>02889 }
<a name="l02890"></a>02890 
<a name="l02891"></a>02891 <span class="comment">/*</span>
<a name="l02892"></a>02892 <span class="comment"> *  call-seq:</span>
<a name="l02893"></a>02893 <span class="comment"> *     ios.lineno    -&gt; integer</span>
<a name="l02894"></a>02894 <span class="comment"> *</span>
<a name="l02895"></a>02895 <span class="comment"> *  Returns the current line number in &lt;em&gt;ios&lt;/em&gt;.  The stream must be</span>
<a name="l02896"></a>02896 <span class="comment"> *  opened for reading. &lt;code&gt;lineno&lt;/code&gt; counts the number of times</span>
<a name="l02897"></a>02897 <span class="comment"> *  #gets is called rather than the number of newlines encountered.  The two</span>
<a name="l02898"></a>02898 <span class="comment"> *  values will differ if #gets is called with a separator other than newline.</span>
<a name="l02899"></a>02899 <span class="comment"> *</span>
<a name="l02900"></a>02900 <span class="comment"> *  Methods that use &lt;code&gt;$/&lt;/code&gt; like #each, #lines and #readline will</span>
<a name="l02901"></a>02901 <span class="comment"> *  also increment &lt;code&gt;lineno&lt;/code&gt;.</span>
<a name="l02902"></a>02902 <span class="comment"> *</span>
<a name="l02903"></a>02903 <span class="comment"> *  See also the &lt;code&gt;$.&lt;/code&gt; variable.</span>
<a name="l02904"></a>02904 <span class="comment"> *</span>
<a name="l02905"></a>02905 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l02906"></a>02906 <span class="comment"> *     f.lineno   #=&gt; 0</span>
<a name="l02907"></a>02907 <span class="comment"> *     f.gets     #=&gt; &quot;This is line one\n&quot;</span>
<a name="l02908"></a>02908 <span class="comment"> *     f.lineno   #=&gt; 1</span>
<a name="l02909"></a>02909 <span class="comment"> *     f.gets     #=&gt; &quot;This is line two\n&quot;</span>
<a name="l02910"></a>02910 <span class="comment"> *     f.lineno   #=&gt; 2</span>
<a name="l02911"></a>02911 <span class="comment"> */</span>
<a name="l02912"></a>02912 
<a name="l02913"></a>02913 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02914"></a><a class="code" href="../../df/d0a/io_8c.html#aa0553726b71a5f77990f61214eae6172">02914</a> <a class="code" href="../../df/d0a/io_8c.html#aa0553726b71a5f77990f61214eae6172">rb_io_lineno</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l02915"></a>02915 {
<a name="l02916"></a>02916     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l02917"></a>02917 
<a name="l02918"></a>02918     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l02919"></a>02919     <a class="code" href="../../dc/dac/io_8h.html#acbd19ff86a565ed9e9f15e4f49736f3d">rb_io_check_char_readable</a>(fptr);
<a name="l02920"></a>02920     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a397be62fbdfe88a3763377f262241ca7">lineno</a>);
<a name="l02921"></a>02921 }
<a name="l02922"></a>02922 
<a name="l02923"></a>02923 <span class="comment">/*</span>
<a name="l02924"></a>02924 <span class="comment"> *  call-seq:</span>
<a name="l02925"></a>02925 <span class="comment"> *     ios.lineno = integer    -&gt; integer</span>
<a name="l02926"></a>02926 <span class="comment"> *</span>
<a name="l02927"></a>02927 <span class="comment"> *  Manually sets the current line number to the given value.</span>
<a name="l02928"></a>02928 <span class="comment"> *  &lt;code&gt;$.&lt;/code&gt; is updated only on the next read.</span>
<a name="l02929"></a>02929 <span class="comment"> *</span>
<a name="l02930"></a>02930 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l02931"></a>02931 <span class="comment"> *     f.gets                     #=&gt; &quot;This is line one\n&quot;</span>
<a name="l02932"></a>02932 <span class="comment"> *     $.                         #=&gt; 1</span>
<a name="l02933"></a>02933 <span class="comment"> *     f.lineno = 1000</span>
<a name="l02934"></a>02934 <span class="comment"> *     f.lineno                   #=&gt; 1000</span>
<a name="l02935"></a>02935 <span class="comment"> *     $.                         #=&gt; 1         # lineno of last read</span>
<a name="l02936"></a>02936 <span class="comment"> *     f.gets                     #=&gt; &quot;This is line two\n&quot;</span>
<a name="l02937"></a>02937 <span class="comment"> *     $.                         #=&gt; 1001      # lineno of last read</span>
<a name="l02938"></a>02938 <span class="comment"> */</span>
<a name="l02939"></a>02939 
<a name="l02940"></a>02940 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02941"></a><a class="code" href="../../df/d0a/io_8c.html#ae0bd7719ba31dc8500b31617eeea28b9">02941</a> <a class="code" href="../../df/d0a/io_8c.html#ae0bd7719ba31dc8500b31617eeea28b9">rb_io_set_lineno</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> lineno)
<a name="l02942"></a>02942 {
<a name="l02943"></a>02943     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l02944"></a>02944 
<a name="l02945"></a>02945     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l02946"></a>02946     <a class="code" href="../../dc/dac/io_8h.html#acbd19ff86a565ed9e9f15e4f49736f3d">rb_io_check_char_readable</a>(fptr);
<a name="l02947"></a>02947     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a397be62fbdfe88a3763377f262241ca7">lineno</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(lineno);
<a name="l02948"></a>02948     <span class="keywordflow">return</span> lineno;
<a name="l02949"></a>02949 }
<a name="l02950"></a>02950 
<a name="l02951"></a>02951 <span class="comment">/*</span>
<a name="l02952"></a>02952 <span class="comment"> *  call-seq:</span>
<a name="l02953"></a>02953 <span class="comment"> *     ios.readline(sep=$/)     -&gt; string</span>
<a name="l02954"></a>02954 <span class="comment"> *     ios.readline(limit)      -&gt; string</span>
<a name="l02955"></a>02955 <span class="comment"> *     ios.readline(sep, limit) -&gt; string</span>
<a name="l02956"></a>02956 <span class="comment"> *</span>
<a name="l02957"></a>02957 <span class="comment"> *  Reads a line as with &lt;code&gt;IO#gets&lt;/code&gt;, but raises an</span>
<a name="l02958"></a>02958 <span class="comment"> *  &lt;code&gt;EOFError&lt;/code&gt; on end of file.</span>
<a name="l02959"></a>02959 <span class="comment"> */</span>
<a name="l02960"></a>02960 
<a name="l02961"></a>02961 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02962"></a><a class="code" href="../../df/d0a/io_8c.html#a2faee7a572ab37aacf1227fca325f7fc">02962</a> <a class="code" href="../../df/d0a/io_8c.html#a2faee7a572ab37aacf1227fca325f7fc">rb_io_readline</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l02963"></a>02963 {
<a name="l02964"></a>02964     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> line = <a class="code" href="../../df/d0a/io_8c.html#a82aa0c7d60448d8caca4fccd7ced8e3f">rb_io_gets_m</a>(argc, argv, io);
<a name="l02965"></a>02965 
<a name="l02966"></a>02966     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(line)) {
<a name="l02967"></a>02967         <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>();
<a name="l02968"></a>02968     }
<a name="l02969"></a>02969     <span class="keywordflow">return</span> line;
<a name="l02970"></a>02970 }
<a name="l02971"></a>02971 
<a name="l02972"></a>02972 <span class="comment">/*</span>
<a name="l02973"></a>02973 <span class="comment"> *  call-seq:</span>
<a name="l02974"></a>02974 <span class="comment"> *     ios.readlines(sep=$/)     -&gt; array</span>
<a name="l02975"></a>02975 <span class="comment"> *     ios.readlines(limit)      -&gt; array</span>
<a name="l02976"></a>02976 <span class="comment"> *     ios.readlines(sep, limit) -&gt; array</span>
<a name="l02977"></a>02977 <span class="comment"> *</span>
<a name="l02978"></a>02978 <span class="comment"> *  Reads all of the lines in &lt;em&gt;ios&lt;/em&gt;, and returns them in</span>
<a name="l02979"></a>02979 <span class="comment"> *  &lt;i&gt;anArray&lt;/i&gt;. Lines are separated by the optional &lt;i&gt;sep&lt;/i&gt;. If</span>
<a name="l02980"></a>02980 <span class="comment"> *  &lt;i&gt;sep&lt;/i&gt; is &lt;code&gt;nil&lt;/code&gt;, the rest of the stream is returned</span>
<a name="l02981"></a>02981 <span class="comment"> *  as a single record.  If the first argument is an integer, or</span>
<a name="l02982"></a>02982 <span class="comment"> *  optional second argument is given, the returning string would not be</span>
<a name="l02983"></a>02983 <span class="comment"> *  longer than the given value in bytes. The stream must be opened for</span>
<a name="l02984"></a>02984 <span class="comment"> *  reading or an &lt;code&gt;IOError&lt;/code&gt; will be raised.</span>
<a name="l02985"></a>02985 <span class="comment"> *</span>
<a name="l02986"></a>02986 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l02987"></a>02987 <span class="comment"> *     f.readlines[0]   #=&gt; &quot;This is line one\n&quot;</span>
<a name="l02988"></a>02988 <span class="comment"> */</span>
<a name="l02989"></a>02989 
<a name="l02990"></a>02990 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02991"></a><a class="code" href="../../df/d0a/io_8c.html#aedb3b02ed530d801262cea5cac06e1a9">02991</a> <a class="code" href="../../df/d0a/io_8c.html#aedb3b02ed530d801262cea5cac06e1a9">rb_io_readlines</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l02992"></a>02992 {
<a name="l02993"></a>02993     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> line, ary, rs;
<a name="l02994"></a>02994     <span class="keywordtype">long</span> limit;
<a name="l02995"></a>02995 
<a name="l02996"></a>02996     <a class="code" href="../../df/d0a/io_8c.html#a393a6b0219ae8e05ac1d74a25d8dfc45">prepare_getline_args</a>(argc, argv, &amp;rs, &amp;limit, io);
<a name="l02997"></a>02997     <span class="keywordflow">if</span> (limit == 0)
<a name="l02998"></a>02998         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;invalid limit: 0 for readlines&quot;</span>);
<a name="l02999"></a>02999     ary = <a class="code" href="../../dc/dcc/array_8c.html#a9518114fd36cb4ef4656ec1dc63348c9">rb_ary_new</a>();
<a name="l03000"></a>03000     <span class="keywordflow">while</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(line = <a class="code" href="../../df/d0a/io_8c.html#aea533e8711f2958efd92ed2a8a5718cb">rb_io_getline_1</a>(rs, limit, io))) {
<a name="l03001"></a>03001         <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, line);
<a name="l03002"></a>03002     }
<a name="l03003"></a>03003     <span class="keywordflow">return</span> ary;
<a name="l03004"></a>03004 }
<a name="l03005"></a>03005 
<a name="l03006"></a>03006 <span class="comment">/*</span>
<a name="l03007"></a>03007 <span class="comment"> *  call-seq:</span>
<a name="l03008"></a>03008 <span class="comment"> *     ios.each(sep=$/) {|line| block }         -&gt; ios</span>
<a name="l03009"></a>03009 <span class="comment"> *     ios.each(limit) {|line| block }          -&gt; ios</span>
<a name="l03010"></a>03010 <span class="comment"> *     ios.each(sep,limit) {|line| block }      -&gt; ios</span>
<a name="l03011"></a>03011 <span class="comment"> *     ios.each(...)                            -&gt; an_enumerator</span>
<a name="l03012"></a>03012 <span class="comment"> *</span>
<a name="l03013"></a>03013 <span class="comment"> *     ios.each_line(sep=$/) {|line| block }    -&gt; ios</span>
<a name="l03014"></a>03014 <span class="comment"> *     ios.each_line(limit) {|line| block }     -&gt; ios</span>
<a name="l03015"></a>03015 <span class="comment"> *     ios.each_line(sep,limit) {|line| block } -&gt; ios</span>
<a name="l03016"></a>03016 <span class="comment"> *     ios.each_line(...)                       -&gt; an_enumerator</span>
<a name="l03017"></a>03017 <span class="comment"> *</span>
<a name="l03018"></a>03018 <span class="comment"> *     ios.lines(sep=$/) {|line| block }        -&gt; ios</span>
<a name="l03019"></a>03019 <span class="comment"> *     ios.lines(limit) {|line| block }         -&gt; ios</span>
<a name="l03020"></a>03020 <span class="comment"> *     ios.lines(sep,limit) {|line| block }     -&gt; ios</span>
<a name="l03021"></a>03021 <span class="comment"> *     ios.lines(...)                           -&gt; an_enumerator</span>
<a name="l03022"></a>03022 <span class="comment"> *</span>
<a name="l03023"></a>03023 <span class="comment"> *  Executes the block for every line in &lt;em&gt;ios&lt;/em&gt;, where lines are</span>
<a name="l03024"></a>03024 <span class="comment"> *  separated by &lt;i&gt;sep&lt;/i&gt;. &lt;em&gt;ios&lt;/em&gt; must be opened for</span>
<a name="l03025"></a>03025 <span class="comment"> *  reading or an &lt;code&gt;IOError&lt;/code&gt; will be raised.</span>
<a name="l03026"></a>03026 <span class="comment"> *</span>
<a name="l03027"></a>03027 <span class="comment"> *  If no block is given, an enumerator is returned instead.</span>
<a name="l03028"></a>03028 <span class="comment"> *</span>
<a name="l03029"></a>03029 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l03030"></a>03030 <span class="comment"> *     f.each {|line| puts &quot;#{f.lineno}: #{line}&quot; }</span>
<a name="l03031"></a>03031 <span class="comment"> *</span>
<a name="l03032"></a>03032 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l03033"></a>03033 <span class="comment"> *</span>
<a name="l03034"></a>03034 <span class="comment"> *     1: This is line one</span>
<a name="l03035"></a>03035 <span class="comment"> *     2: This is line two</span>
<a name="l03036"></a>03036 <span class="comment"> *     3: This is line three</span>
<a name="l03037"></a>03037 <span class="comment"> *     4: And so on...</span>
<a name="l03038"></a>03038 <span class="comment"> */</span>
<a name="l03039"></a>03039 
<a name="l03040"></a>03040 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03041"></a><a class="code" href="../../df/d0a/io_8c.html#a49a636ecf7eb2394814596c05d0b4ce0">03041</a> <a class="code" href="../../df/d0a/io_8c.html#a49a636ecf7eb2394814596c05d0b4ce0">rb_io_each_line</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l03042"></a>03042 {
<a name="l03043"></a>03043     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, rs;
<a name="l03044"></a>03044     <span class="keywordtype">long</span> limit;
<a name="l03045"></a>03045 
<a name="l03046"></a>03046     <a class="code" href="../../db/d2e/intern_8h.html#ad174dd963d99ac27a67c8ef9cfa1eb58">RETURN_ENUMERATOR</a>(io, argc, argv);
<a name="l03047"></a>03047     <a class="code" href="../../df/d0a/io_8c.html#a393a6b0219ae8e05ac1d74a25d8dfc45">prepare_getline_args</a>(argc, argv, &amp;rs, &amp;limit, io);
<a name="l03048"></a>03048     <span class="keywordflow">if</span> (limit == 0)
<a name="l03049"></a>03049         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;invalid limit: 0 for each_line&quot;</span>);
<a name="l03050"></a>03050     <span class="keywordflow">while</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str = <a class="code" href="../../df/d0a/io_8c.html#aea533e8711f2958efd92ed2a8a5718cb">rb_io_getline_1</a>(rs, limit, io))) {
<a name="l03051"></a>03051         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae6bd0c4ea4db971ebd569ca8f05c6b4a">rb_yield</a>(str);
<a name="l03052"></a>03052     }
<a name="l03053"></a>03053     <span class="keywordflow">return</span> io;
<a name="l03054"></a>03054 }
<a name="l03055"></a>03055 
<a name="l03056"></a>03056 <span class="comment">/*</span>
<a name="l03057"></a>03057 <span class="comment"> *  call-seq:</span>
<a name="l03058"></a>03058 <span class="comment"> *     ios.bytes {|byte| block }      -&gt; ios</span>
<a name="l03059"></a>03059 <span class="comment"> *     ios.bytes                      -&gt; an_enumerator</span>
<a name="l03060"></a>03060 <span class="comment"> *</span>
<a name="l03061"></a>03061 <span class="comment"> *     ios.each_byte {|byte| block }  -&gt; ios</span>
<a name="l03062"></a>03062 <span class="comment"> *     ios.each_byte                  -&gt; an_enumerator</span>
<a name="l03063"></a>03063 <span class="comment"> *</span>
<a name="l03064"></a>03064 <span class="comment"> *  Calls the given block once for each byte (0..255) in &lt;em&gt;ios&lt;/em&gt;,</span>
<a name="l03065"></a>03065 <span class="comment"> *  passing the byte as an argument. The stream must be opened for</span>
<a name="l03066"></a>03066 <span class="comment"> *  reading or an &lt;code&gt;IOError&lt;/code&gt; will be raised.</span>
<a name="l03067"></a>03067 <span class="comment"> *</span>
<a name="l03068"></a>03068 <span class="comment"> *  If no block is given, an enumerator is returned instead.</span>
<a name="l03069"></a>03069 <span class="comment"> *</span>
<a name="l03070"></a>03070 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l03071"></a>03071 <span class="comment"> *     checksum = 0</span>
<a name="l03072"></a>03072 <span class="comment"> *     f.each_byte {|x| checksum ^= x }   #=&gt; #&lt;File:testfile&gt;</span>
<a name="l03073"></a>03073 <span class="comment"> *     checksum                           #=&gt; 12</span>
<a name="l03074"></a>03074 <span class="comment"> */</span>
<a name="l03075"></a>03075 
<a name="l03076"></a>03076 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03077"></a><a class="code" href="../../df/d0a/io_8c.html#a04ad573d5a1e3b71730740743e6ee42b">03077</a> <a class="code" href="../../df/d0a/io_8c.html#a04ad573d5a1e3b71730740743e6ee42b">rb_io_each_byte</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l03078"></a>03078 {
<a name="l03079"></a>03079     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l03080"></a>03080     <span class="keywordtype">char</span> *p, *e;
<a name="l03081"></a>03081 
<a name="l03082"></a>03082     <a class="code" href="../../db/d2e/intern_8h.html#ad174dd963d99ac27a67c8ef9cfa1eb58">RETURN_ENUMERATOR</a>(io, 0, 0);
<a name="l03083"></a>03083     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l03084"></a>03084 
<a name="l03085"></a>03085     <span class="keywordflow">for</span> (;;) {
<a name="l03086"></a>03086         <span class="keywordflow">while</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> &gt; 0) {
<a name="l03087"></a>03087             p = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>++;
<a name="l03088"></a>03088             e = p + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>--;
<a name="l03089"></a>03089             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae6bd0c4ea4db971ebd569ca8f05c6b4a">rb_yield</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(*p &amp; 0xff));
<a name="l03090"></a>03090             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0;
<a name="l03091"></a>03091         }
<a name="l03092"></a>03092         <a class="code" href="../../dc/dac/io_8h.html#a38b3a618992ee85d5510dc70db4e2b36">rb_io_check_byte_readable</a>(fptr);
<a name="l03093"></a>03093         <a class="code" href="../../df/d0a/io_8c.html#a704f29b50a37b53c4a9f4f876d350f0d">READ_CHECK</a>(fptr);
<a name="l03094"></a>03094         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a7d1e7b95139715aa6fa393b30e6a39e8">io_fillbuf</a>(fptr) &lt; 0) {
<a name="l03095"></a>03095             <span class="keywordflow">break</span>;
<a name="l03096"></a>03096         }
<a name="l03097"></a>03097     }
<a name="l03098"></a>03098     <span class="keywordflow">return</span> io;
<a name="l03099"></a>03099 }
<a name="l03100"></a>03100 
<a name="l03101"></a>03101 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03102"></a><a class="code" href="../../df/d0a/io_8c.html#af0f4edd1fbc303e5bff7dfe79bc11ae4">03102</a> <a class="code" href="../../df/d0a/io_8c.html#af0f4edd1fbc303e5bff7dfe79bc11ae4">io_getc</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc)
<a name="l03103"></a>03103 {
<a name="l03104"></a>03104     <span class="keywordtype">int</span> r, n, cr = 0;
<a name="l03105"></a>03105     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str;
<a name="l03106"></a>03106 
<a name="l03107"></a>03107     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a92621ca418c11e96d4862166f9076a73">NEED_READCONV</a>(fptr)) {
<a name="l03108"></a>03108         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03109"></a>03109         <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *read_enc = <a class="code" href="../../df/d0a/io_8c.html#aa3b568197b019bda6a9aea4fbe2153eb">io_read_encoding</a>(fptr);
<a name="l03110"></a>03110 
<a name="l03111"></a>03111         <a class="code" href="../../df/d0a/io_8c.html#ace89c001caf3ebc8943c8f06c0aab552">SET_BINARY_MODE</a>(fptr);
<a name="l03112"></a>03112         <a class="code" href="../../df/d0a/io_8c.html#a7270c50b73afa5c8c999dacfab097524">make_readconv</a>(fptr, 0);
<a name="l03113"></a>03113 
<a name="l03114"></a>03114         <span class="keywordflow">while</span> (1) {
<a name="l03115"></a>03115             <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>) {
<a name="l03116"></a>03116                 r = <a class="code" href="../../d5/db5/encoding_8c.html#a0c6003b6aeaed218d841974b00c95870">rb_enc_precise_mbclen</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>,
<a name="l03117"></a>03117                         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>,
<a name="l03118"></a>03118                         read_enc);
<a name="l03119"></a>03119                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/de3/encoding_8h.html#aaf154483822592f1b9813b1f489bf772">MBCLEN_NEEDMORE_P</a>(r))
<a name="l03120"></a>03120                     <span class="keywordflow">break</span>;
<a name="l03121"></a>03121                 <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> == fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>) {
<a name="l03122"></a>03122                     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;too long character&quot;</span>);
<a name="l03123"></a>03123                 }
<a name="l03124"></a>03124             }
<a name="l03125"></a>03125 
<a name="l03126"></a>03126             <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a97e0f8279ec629d58f6690fa57e8704f">more_char</a>(fptr) == <a class="code" href="../../df/d0a/io_8c.html#adb561f38bf9315a2ec31e9f6926d0618">MORE_CHAR_FINISHED</a>) {
<a name="l03127"></a>03127                 <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> == 0) {
<a name="l03128"></a>03128                     <a class="code" href="../../df/d0a/io_8c.html#a89693737d8688aa1fea03c70711799ab">clear_readconv</a>(fptr);
<a name="l03129"></a>03129                     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03130"></a>03130                 }
<a name="l03131"></a>03131                 <span class="comment">/* return an unit of an incomplete character just before EOF */</span>
<a name="l03132"></a>03132                 str = <a class="code" href="../../d5/de3/encoding_8h.html#a6707b730597e0e614213beb11670aca2">rb_enc_str_new</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, 1, read_enc);
<a name="l03133"></a>03133                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> += 1;
<a name="l03134"></a>03134                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> -= 1;
<a name="l03135"></a>03135                 <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> == 0) <a class="code" href="../../df/d0a/io_8c.html#a89693737d8688aa1fea03c70711799ab">clear_readconv</a>(fptr);
<a name="l03136"></a>03136                 <a class="code" href="../../d5/de3/encoding_8h.html#aefe5772c0116cf7131a5227de7243dbc">ENC_CODERANGE_SET</a>(str, <a class="code" href="../../d5/de3/encoding_8h.html#abb86fbc02fc2b78d928825ea6d6922f9">ENC_CODERANGE_BROKEN</a>);
<a name="l03137"></a>03137                 <span class="keywordflow">return</span> str;
<a name="l03138"></a>03138             }
<a name="l03139"></a>03139         }
<a name="l03140"></a>03140         <span class="keywordflow">if</span> (<a class="code" href="../../d5/de3/encoding_8h.html#a9be706470754634a65ed29bcd2508ee1">MBCLEN_INVALID_P</a>(r)) {
<a name="l03141"></a>03141             r = <a class="code" href="../../d5/db5/encoding_8c.html#aa91c0fa3dfdfe3c55fcaa6029c35bbb8">rb_enc_mbclen</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>,
<a name="l03142"></a>03142                               fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>,
<a name="l03143"></a>03143                               read_enc);
<a name="l03144"></a>03144             <a class="code" href="../../df/d0a/io_8c.html#a20e719e6f50c2ea1857b4d85ee09b2ea">io_shift_cbuf</a>(fptr, r, &amp;str);
<a name="l03145"></a>03145             cr = <a class="code" href="../../d5/de3/encoding_8h.html#abb86fbc02fc2b78d928825ea6d6922f9">ENC_CODERANGE_BROKEN</a>;
<a name="l03146"></a>03146         }
<a name="l03147"></a>03147         <span class="keywordflow">else</span> {
<a name="l03148"></a>03148             <a class="code" href="../../df/d0a/io_8c.html#a20e719e6f50c2ea1857b4d85ee09b2ea">io_shift_cbuf</a>(fptr, <a class="code" href="../../d5/de3/encoding_8h.html#a877f84ae22293dae2a8cf1e26ea5b1a6">MBCLEN_CHARFOUND_LEN</a>(r), &amp;str);
<a name="l03149"></a>03149             cr = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af96ff81718c3c27b342b5958fac6cb7e">ISASCII</a>(r) ? <a class="code" href="../../d5/de3/encoding_8h.html#a0a0e73a2d98205044e1ad19432502c5b">ENC_CODERANGE_7BIT</a> : <a class="code" href="../../d5/de3/encoding_8h.html#a0c81a12daaa1e57009d46b9d906957dc">ENC_CODERANGE_VALID</a>;
<a name="l03150"></a>03150         }
<a name="l03151"></a>03151         str = <a class="code" href="../../df/d0a/io_8c.html#acd3c89cc4bd3aaef3dfea3b3fa2c6360">io_enc_str</a>(str, fptr);
<a name="l03152"></a>03152         <a class="code" href="../../d5/de3/encoding_8h.html#aefe5772c0116cf7131a5227de7243dbc">ENC_CODERANGE_SET</a>(str, cr);
<a name="l03153"></a>03153         <span class="keywordflow">return</span> str;
<a name="l03154"></a>03154     }
<a name="l03155"></a>03155 
<a name="l03156"></a>03156     <a class="code" href="../../df/d0a/io_8c.html#abd7495bb74588d590a98112929d9010c">NEED_NEWLINE_DECORATOR_ON_READ_CHECK</a>(fptr);
<a name="l03157"></a>03157     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a7d1e7b95139715aa6fa393b30e6a39e8">io_fillbuf</a>(fptr) &lt; 0) {
<a name="l03158"></a>03158         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03159"></a>03159     }
<a name="l03160"></a>03160     <span class="keywordflow">if</span> (<a class="code" href="../../d5/de3/encoding_8h.html#a8b18a09a3055d3006c6d5baeaa6e7c72">rb_enc_asciicompat</a>(enc) &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af96ff81718c3c27b342b5958fac6cb7e">ISASCII</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>[fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>])) {
<a name="l03161"></a>03161         str = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, 1);
<a name="l03162"></a>03162         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> += 1;
<a name="l03163"></a>03163         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> -= 1;
<a name="l03164"></a>03164         cr = <a class="code" href="../../d5/de3/encoding_8h.html#a0a0e73a2d98205044e1ad19432502c5b">ENC_CODERANGE_7BIT</a>;
<a name="l03165"></a>03165     }
<a name="l03166"></a>03166     <span class="keywordflow">else</span> {
<a name="l03167"></a>03167         r = <a class="code" href="../../d5/db5/encoding_8c.html#a0c6003b6aeaed218d841974b00c95870">rb_enc_precise_mbclen</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>, enc);
<a name="l03168"></a>03168         <span class="keywordflow">if</span> (<a class="code" href="../../d5/de3/encoding_8h.html#ac3dcc15c5ed42d6590e1c1f91b74165c">MBCLEN_CHARFOUND_P</a>(r) &amp;&amp;
<a name="l03169"></a>03169             (n = <a class="code" href="../../d5/de3/encoding_8h.html#a877f84ae22293dae2a8cf1e26ea5b1a6">MBCLEN_CHARFOUND_LEN</a>(r)) &lt;= fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>) {
<a name="l03170"></a>03170             str = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, n);
<a name="l03171"></a>03171             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> += n;
<a name="l03172"></a>03172             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> -= n;
<a name="l03173"></a>03173             cr = <a class="code" href="../../d5/de3/encoding_8h.html#a0c81a12daaa1e57009d46b9d906957dc">ENC_CODERANGE_VALID</a>;
<a name="l03174"></a>03174         }
<a name="l03175"></a>03175         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/de3/encoding_8h.html#aaf154483822592f1b9813b1f489bf772">MBCLEN_NEEDMORE_P</a>(r)) {
<a name="l03176"></a>03176             str = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>);
<a name="l03177"></a>03177             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> = 0;
<a name="l03178"></a>03178           getc_needmore:
<a name="l03179"></a>03179             <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a7d1e7b95139715aa6fa393b30e6a39e8">io_fillbuf</a>(fptr) != -1) {
<a name="l03180"></a>03180                 <a class="code" href="../../db/d2e/intern_8h.html#a4e3e3ccf959b5db6c125a68e1e1db0a3">rb_str_cat</a>(str, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, 1);
<a name="l03181"></a>03181                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>++;
<a name="l03182"></a>03182                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>--;
<a name="l03183"></a>03183                 r = <a class="code" href="../../d5/db5/encoding_8c.html#a0c6003b6aeaed218d841974b00c95870">rb_enc_precise_mbclen</a>(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str)+<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str), enc);
<a name="l03184"></a>03184                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/de3/encoding_8h.html#aaf154483822592f1b9813b1f489bf772">MBCLEN_NEEDMORE_P</a>(r)) {
<a name="l03185"></a>03185                     <span class="keywordflow">goto</span> getc_needmore;
<a name="l03186"></a>03186                 }
<a name="l03187"></a>03187                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/de3/encoding_8h.html#ac3dcc15c5ed42d6590e1c1f91b74165c">MBCLEN_CHARFOUND_P</a>(r)) {
<a name="l03188"></a>03188                     cr = <a class="code" href="../../d5/de3/encoding_8h.html#a0c81a12daaa1e57009d46b9d906957dc">ENC_CODERANGE_VALID</a>;
<a name="l03189"></a>03189                 }
<a name="l03190"></a>03190             }
<a name="l03191"></a>03191         }
<a name="l03192"></a>03192         <span class="keywordflow">else</span> {
<a name="l03193"></a>03193             str = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, 1);
<a name="l03194"></a>03194             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>++;
<a name="l03195"></a>03195             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>--;
<a name="l03196"></a>03196         }
<a name="l03197"></a>03197     }
<a name="l03198"></a>03198     <span class="keywordflow">if</span> (!cr) cr = <a class="code" href="../../d5/de3/encoding_8h.html#abb86fbc02fc2b78d928825ea6d6922f9">ENC_CODERANGE_BROKEN</a>;
<a name="l03199"></a>03199     str = <a class="code" href="../../df/d0a/io_8c.html#acd3c89cc4bd3aaef3dfea3b3fa2c6360">io_enc_str</a>(str, fptr);
<a name="l03200"></a>03200     <a class="code" href="../../d5/de3/encoding_8h.html#aefe5772c0116cf7131a5227de7243dbc">ENC_CODERANGE_SET</a>(str, cr);
<a name="l03201"></a>03201     <span class="keywordflow">return</span> str;
<a name="l03202"></a>03202 }
<a name="l03203"></a>03203 
<a name="l03204"></a>03204 <span class="comment">/*</span>
<a name="l03205"></a>03205 <span class="comment"> *  call-seq:</span>
<a name="l03206"></a>03206 <span class="comment"> *     ios.chars {|c| block }      -&gt; ios</span>
<a name="l03207"></a>03207 <span class="comment"> *     ios.chars                   -&gt; an_enumerator</span>
<a name="l03208"></a>03208 <span class="comment"> *</span>
<a name="l03209"></a>03209 <span class="comment"> *     ios.each_char {|c| block }  -&gt; ios</span>
<a name="l03210"></a>03210 <span class="comment"> *     ios.each_char               -&gt; an_enumerator</span>
<a name="l03211"></a>03211 <span class="comment"> *</span>
<a name="l03212"></a>03212 <span class="comment"> *  Calls the given block once for each character in &lt;em&gt;ios&lt;/em&gt;,</span>
<a name="l03213"></a>03213 <span class="comment"> *  passing the character as an argument. The stream must be opened for</span>
<a name="l03214"></a>03214 <span class="comment"> *  reading or an &lt;code&gt;IOError&lt;/code&gt; will be raised.</span>
<a name="l03215"></a>03215 <span class="comment"> *</span>
<a name="l03216"></a>03216 <span class="comment"> *  If no block is given, an enumerator is returned instead.</span>
<a name="l03217"></a>03217 <span class="comment"> *</span>
<a name="l03218"></a>03218 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l03219"></a>03219 <span class="comment"> *     f.each_char {|c| print c, &apos; &apos; }   #=&gt; #&lt;File:testfile&gt;</span>
<a name="l03220"></a>03220 <span class="comment"> */</span>
<a name="l03221"></a>03221 
<a name="l03222"></a>03222 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03223"></a><a class="code" href="../../df/d0a/io_8c.html#a8508906b0294323f5d53a7847cb5fb92">03223</a> <a class="code" href="../../df/d0a/io_8c.html#a8508906b0294323f5d53a7847cb5fb92">rb_io_each_char</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l03224"></a>03224 {
<a name="l03225"></a>03225     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l03226"></a>03226     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc;
<a name="l03227"></a>03227     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> c;
<a name="l03228"></a>03228 
<a name="l03229"></a>03229     <a class="code" href="../../db/d2e/intern_8h.html#ad174dd963d99ac27a67c8ef9cfa1eb58">RETURN_ENUMERATOR</a>(io, 0, 0);
<a name="l03230"></a>03230     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l03231"></a>03231     <a class="code" href="../../dc/dac/io_8h.html#acbd19ff86a565ed9e9f15e4f49736f3d">rb_io_check_char_readable</a>(fptr);
<a name="l03232"></a>03232 
<a name="l03233"></a>03233     enc = <a class="code" href="../../df/d0a/io_8c.html#a56707d1971eaab5e4af7a598c630466c">io_input_encoding</a>(fptr);
<a name="l03234"></a>03234     <a class="code" href="../../df/d0a/io_8c.html#a704f29b50a37b53c4a9f4f876d350f0d">READ_CHECK</a>(fptr);
<a name="l03235"></a>03235     <span class="keywordflow">while</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(c = <a class="code" href="../../df/d0a/io_8c.html#af0f4edd1fbc303e5bff7dfe79bc11ae4">io_getc</a>(fptr, enc))) {
<a name="l03236"></a>03236         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae6bd0c4ea4db971ebd569ca8f05c6b4a">rb_yield</a>(c);
<a name="l03237"></a>03237     }
<a name="l03238"></a>03238     <span class="keywordflow">return</span> io;
<a name="l03239"></a>03239 }
<a name="l03240"></a>03240 
<a name="l03241"></a>03241 
<a name="l03242"></a>03242 <span class="comment">/*</span>
<a name="l03243"></a>03243 <span class="comment"> *  call-seq:</span>
<a name="l03244"></a>03244 <span class="comment"> *     ios.each_codepoint {|c| block }  -&gt; ios</span>
<a name="l03245"></a>03245 <span class="comment"> *     ios.codepoints     {|c| block }  -&gt; ios</span>
<a name="l03246"></a>03246 <span class="comment"> *     ios.each_codepoint               -&gt; an_enumerator</span>
<a name="l03247"></a>03247 <span class="comment"> *     ios.codepoints                   -&gt; an_enumerator</span>
<a name="l03248"></a>03248 <span class="comment"> *</span>
<a name="l03249"></a>03249 <span class="comment"> *  Passes the &lt;code&gt;Integer&lt;/code&gt; ordinal of each character in &lt;i&gt;ios&lt;/i&gt;,</span>
<a name="l03250"></a>03250 <span class="comment"> *  passing the codepoint as an argument. The stream must be opened for</span>
<a name="l03251"></a>03251 <span class="comment"> *  reading or an &lt;code&gt;IOError&lt;/code&gt; will be raised.</span>
<a name="l03252"></a>03252 <span class="comment"> *</span>
<a name="l03253"></a>03253 <span class="comment"> *  If no block is given, an enumerator is returned instead.</span>
<a name="l03254"></a>03254 <span class="comment"> *</span>
<a name="l03255"></a>03255 <span class="comment"> */</span>
<a name="l03256"></a>03256 
<a name="l03257"></a>03257 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03258"></a><a class="code" href="../../df/d0a/io_8c.html#a954bc2cc1261b29fad52ccfdbfbbb419">03258</a> <a class="code" href="../../df/d0a/io_8c.html#a954bc2cc1261b29fad52ccfdbfbbb419">rb_io_each_codepoint</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l03259"></a>03259 {
<a name="l03260"></a>03260     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l03261"></a>03261     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc;
<a name="l03262"></a>03262     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> c;
<a name="l03263"></a>03263     <span class="keywordtype">int</span> r, n;
<a name="l03264"></a>03264 
<a name="l03265"></a>03265     <a class="code" href="../../db/d2e/intern_8h.html#ad174dd963d99ac27a67c8ef9cfa1eb58">RETURN_ENUMERATOR</a>(io, 0, 0);
<a name="l03266"></a>03266     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l03267"></a>03267     <a class="code" href="../../dc/dac/io_8h.html#acbd19ff86a565ed9e9f15e4f49736f3d">rb_io_check_char_readable</a>(fptr);
<a name="l03268"></a>03268 
<a name="l03269"></a>03269     <a class="code" href="../../df/d0a/io_8c.html#a704f29b50a37b53c4a9f4f876d350f0d">READ_CHECK</a>(fptr);
<a name="l03270"></a>03270     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a92621ca418c11e96d4862166f9076a73">NEED_READCONV</a>(fptr)) {
<a name="l03271"></a>03271         <a class="code" href="../../df/d0a/io_8c.html#ace89c001caf3ebc8943c8f06c0aab552">SET_BINARY_MODE</a>(fptr);
<a name="l03272"></a>03272         <span class="keywordflow">for</span> (;;) {
<a name="l03273"></a>03273             <a class="code" href="../../df/d0a/io_8c.html#a7270c50b73afa5c8c999dacfab097524">make_readconv</a>(fptr, 0);
<a name="l03274"></a>03274             <span class="keywordflow">for</span> (;;) {
<a name="l03275"></a>03275                 <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>) {
<a name="l03276"></a>03276                     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc)
<a name="l03277"></a>03277                         r = <a class="code" href="../../d5/db5/encoding_8c.html#a0c6003b6aeaed218d841974b00c95870">rb_enc_precise_mbclen</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>,
<a name="l03278"></a>03278                                                   fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>,
<a name="l03279"></a>03279                                                   fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc);
<a name="l03280"></a>03280                     <span class="keywordflow">else</span>
<a name="l03281"></a>03281                         r = <a class="code" href="../../d8/db3/oniguruma_8h.html#ab16c85718aaf6d67d9299d1ff8d93ed2">ONIGENC_CONSTRUCT_MBCLEN_CHARFOUND</a>(1);
<a name="l03282"></a>03282                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/de3/encoding_8h.html#aaf154483822592f1b9813b1f489bf772">MBCLEN_NEEDMORE_P</a>(r))
<a name="l03283"></a>03283                         <span class="keywordflow">break</span>;
<a name="l03284"></a>03284                     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> == fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>) {
<a name="l03285"></a>03285                         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;too long character&quot;</span>);
<a name="l03286"></a>03286                     }
<a name="l03287"></a>03287                 }
<a name="l03288"></a>03288                 <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a97e0f8279ec629d58f6690fa57e8704f">more_char</a>(fptr) == <a class="code" href="../../df/d0a/io_8c.html#adb561f38bf9315a2ec31e9f6926d0618">MORE_CHAR_FINISHED</a>) {
<a name="l03289"></a>03289                     <a class="code" href="../../df/d0a/io_8c.html#a89693737d8688aa1fea03c70711799ab">clear_readconv</a>(fptr);
<a name="l03290"></a>03290                     <span class="comment">/* ignore an incomplete character before EOF */</span>
<a name="l03291"></a>03291                     <span class="keywordflow">return</span> io;
<a name="l03292"></a>03292                 }
<a name="l03293"></a>03293             }
<a name="l03294"></a>03294             <span class="keywordflow">if</span> (<a class="code" href="../../d5/de3/encoding_8h.html#a9be706470754634a65ed29bcd2508ee1">MBCLEN_INVALID_P</a>(r)) {
<a name="l03295"></a>03295                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;invalid byte sequence in %s&quot;</span>,
<a name="l03296"></a>03296                          <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc));
<a name="l03297"></a>03297             }
<a name="l03298"></a>03298             n = <a class="code" href="../../d5/de3/encoding_8h.html#a877f84ae22293dae2a8cf1e26ea5b1a6">MBCLEN_CHARFOUND_LEN</a>(r);
<a name="l03299"></a>03299             <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc) {
<a name="l03300"></a>03300                 c = <a class="code" href="../../d5/de3/encoding_8h.html#a902fb7e618fcdb1ce1317b09a772af15">rb_enc_codepoint</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>,
<a name="l03301"></a>03301                                      fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>,
<a name="l03302"></a>03302                                      fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc);
<a name="l03303"></a>03303             }
<a name="l03304"></a>03304             <span class="keywordflow">else</span> {
<a name="l03305"></a>03305                 c = (<span class="keywordtype">unsigned</span> char)fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>[fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>];
<a name="l03306"></a>03306             }
<a name="l03307"></a>03307             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> += n;
<a name="l03308"></a>03308             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> -= n;
<a name="l03309"></a>03309             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae6bd0c4ea4db971ebd569ca8f05c6b4a">rb_yield</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6eb3054f7a740d26c133d34ae6afdf2c">UINT2NUM</a>(c));
<a name="l03310"></a>03310         }
<a name="l03311"></a>03311     }
<a name="l03312"></a>03312     <a class="code" href="../../df/d0a/io_8c.html#abd7495bb74588d590a98112929d9010c">NEED_NEWLINE_DECORATOR_ON_READ_CHECK</a>(fptr);
<a name="l03313"></a>03313     enc = <a class="code" href="../../df/d0a/io_8c.html#a56707d1971eaab5e4af7a598c630466c">io_input_encoding</a>(fptr);
<a name="l03314"></a>03314     <span class="keywordflow">for</span> (;;) {
<a name="l03315"></a>03315         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a7d1e7b95139715aa6fa393b30e6a39e8">io_fillbuf</a>(fptr) &lt; 0) {
<a name="l03316"></a>03316             <span class="keywordflow">return</span> io;
<a name="l03317"></a>03317         }
<a name="l03318"></a>03318         r = <a class="code" href="../../d5/db5/encoding_8c.html#a0c6003b6aeaed218d841974b00c95870">rb_enc_precise_mbclen</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>,
<a name="l03319"></a>03319                                   fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>, enc);
<a name="l03320"></a>03320         <span class="keywordflow">if</span> (<a class="code" href="../../d5/de3/encoding_8h.html#ac3dcc15c5ed42d6590e1c1f91b74165c">MBCLEN_CHARFOUND_P</a>(r) &amp;&amp;
<a name="l03321"></a>03321             (n = <a class="code" href="../../d5/de3/encoding_8h.html#a877f84ae22293dae2a8cf1e26ea5b1a6">MBCLEN_CHARFOUND_LEN</a>(r)) &lt;= fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>) {
<a name="l03322"></a>03322             c = <a class="code" href="../../d5/de3/encoding_8h.html#a902fb7e618fcdb1ce1317b09a772af15">rb_enc_codepoint</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>,
<a name="l03323"></a>03323                                  fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>, enc);
<a name="l03324"></a>03324             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> += n;
<a name="l03325"></a>03325             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> -= n;
<a name="l03326"></a>03326             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae6bd0c4ea4db971ebd569ca8f05c6b4a">rb_yield</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6eb3054f7a740d26c133d34ae6afdf2c">UINT2NUM</a>(c));
<a name="l03327"></a>03327         }
<a name="l03328"></a>03328         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/de3/encoding_8h.html#a9be706470754634a65ed29bcd2508ee1">MBCLEN_INVALID_P</a>(r)) {
<a name="l03329"></a>03329             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;invalid byte sequence in %s&quot;</span>, <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(enc));
<a name="l03330"></a>03330         }
<a name="l03331"></a>03331         <span class="keywordflow">else</span> {
<a name="l03332"></a>03332             <span class="keywordflow">continue</span>;
<a name="l03333"></a>03333         }
<a name="l03334"></a>03334     }
<a name="l03335"></a>03335     <span class="keywordflow">return</span> io;
<a name="l03336"></a>03336 }
<a name="l03337"></a>03337 
<a name="l03338"></a>03338 
<a name="l03339"></a>03339 
<a name="l03340"></a>03340 <span class="comment">/*</span>
<a name="l03341"></a>03341 <span class="comment"> *  call-seq:</span>
<a name="l03342"></a>03342 <span class="comment"> *     ios.getc   -&gt; string or nil</span>
<a name="l03343"></a>03343 <span class="comment"> *</span>
<a name="l03344"></a>03344 <span class="comment"> *  Reads a one-character string from &lt;em&gt;ios&lt;/em&gt;. Returns</span>
<a name="l03345"></a>03345 <span class="comment"> *  &lt;code&gt;nil&lt;/code&gt; if called at end of file.</span>
<a name="l03346"></a>03346 <span class="comment"> *</span>
<a name="l03347"></a>03347 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l03348"></a>03348 <span class="comment"> *     f.getc   #=&gt; &quot;h&quot;</span>
<a name="l03349"></a>03349 <span class="comment"> *     f.getc   #=&gt; &quot;e&quot;</span>
<a name="l03350"></a>03350 <span class="comment"> */</span>
<a name="l03351"></a>03351 
<a name="l03352"></a>03352 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03353"></a><a class="code" href="../../df/d0a/io_8c.html#a970e65fde195f4283b34493c26c74dab">03353</a> <a class="code" href="../../df/d0a/io_8c.html#a970e65fde195f4283b34493c26c74dab">rb_io_getc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l03354"></a>03354 {
<a name="l03355"></a>03355     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l03356"></a>03356     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc;
<a name="l03357"></a>03357 
<a name="l03358"></a>03358     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l03359"></a>03359     <a class="code" href="../../dc/dac/io_8h.html#acbd19ff86a565ed9e9f15e4f49736f3d">rb_io_check_char_readable</a>(fptr);
<a name="l03360"></a>03360 
<a name="l03361"></a>03361     enc = <a class="code" href="../../df/d0a/io_8c.html#a56707d1971eaab5e4af7a598c630466c">io_input_encoding</a>(fptr);
<a name="l03362"></a>03362     <a class="code" href="../../df/d0a/io_8c.html#a704f29b50a37b53c4a9f4f876d350f0d">READ_CHECK</a>(fptr);
<a name="l03363"></a>03363     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#af0f4edd1fbc303e5bff7dfe79bc11ae4">io_getc</a>(fptr, enc);
<a name="l03364"></a>03364 }
<a name="l03365"></a>03365 
<a name="l03366"></a>03366 <span class="comment">/*</span>
<a name="l03367"></a>03367 <span class="comment"> *  call-seq:</span>
<a name="l03368"></a>03368 <span class="comment"> *     ios.readchar   -&gt; string</span>
<a name="l03369"></a>03369 <span class="comment"> *</span>
<a name="l03370"></a>03370 <span class="comment"> *  Reads a one-character string from &lt;em&gt;ios&lt;/em&gt;. Raises an</span>
<a name="l03371"></a>03371 <span class="comment"> *  &lt;code&gt;EOFError&lt;/code&gt; on end of file.</span>
<a name="l03372"></a>03372 <span class="comment"> *</span>
<a name="l03373"></a>03373 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l03374"></a>03374 <span class="comment"> *     f.readchar   #=&gt; &quot;h&quot;</span>
<a name="l03375"></a>03375 <span class="comment"> *     f.readchar   #=&gt; &quot;e&quot;</span>
<a name="l03376"></a>03376 <span class="comment"> */</span>
<a name="l03377"></a>03377 
<a name="l03378"></a>03378 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03379"></a><a class="code" href="../../df/d0a/io_8c.html#ace92bfe94affa64705d88a37ee0ad8f3">03379</a> <a class="code" href="../../df/d0a/io_8c.html#ace92bfe94affa64705d88a37ee0ad8f3">rb_io_readchar</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l03380"></a>03380 {
<a name="l03381"></a>03381     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> c = <a class="code" href="../../df/d0a/io_8c.html#a970e65fde195f4283b34493c26c74dab">rb_io_getc</a>(io);
<a name="l03382"></a>03382 
<a name="l03383"></a>03383     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(c)) {
<a name="l03384"></a>03384         <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>();
<a name="l03385"></a>03385     }
<a name="l03386"></a>03386     <span class="keywordflow">return</span> c;
<a name="l03387"></a>03387 }
<a name="l03388"></a>03388 
<a name="l03389"></a>03389 <span class="comment">/*</span>
<a name="l03390"></a>03390 <span class="comment"> *  call-seq:</span>
<a name="l03391"></a>03391 <span class="comment"> *     ios.getbyte   -&gt; fixnum or nil</span>
<a name="l03392"></a>03392 <span class="comment"> *</span>
<a name="l03393"></a>03393 <span class="comment"> *  Gets the next 8-bit byte (0..255) from &lt;em&gt;ios&lt;/em&gt;. Returns</span>
<a name="l03394"></a>03394 <span class="comment"> *  &lt;code&gt;nil&lt;/code&gt; if called at end of file.</span>
<a name="l03395"></a>03395 <span class="comment"> *</span>
<a name="l03396"></a>03396 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l03397"></a>03397 <span class="comment"> *     f.getbyte   #=&gt; 84</span>
<a name="l03398"></a>03398 <span class="comment"> *     f.getbyte   #=&gt; 104</span>
<a name="l03399"></a>03399 <span class="comment"> */</span>
<a name="l03400"></a>03400 
<a name="l03401"></a>03401 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03402"></a><a class="code" href="../../df/d0a/io_8c.html#a3061f7a0c03ca7c76b510ea88f56bc54">03402</a> <a class="code" href="../../db/d2e/intern_8h.html#a13c20887173177e30ccd7bb42708dc2b">rb_io_getbyte</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l03403"></a>03403 {
<a name="l03404"></a>03404     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l03405"></a>03405     <span class="keywordtype">int</span> c;
<a name="l03406"></a>03406 
<a name="l03407"></a>03407     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l03408"></a>03408     <a class="code" href="../../dc/dac/io_8h.html#a38b3a618992ee85d5510dc70db4e2b36">rb_io_check_byte_readable</a>(fptr);
<a name="l03409"></a>03409     <a class="code" href="../../df/d0a/io_8c.html#a704f29b50a37b53c4a9f4f876d350f0d">READ_CHECK</a>(fptr);
<a name="l03410"></a>03410     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> == 0 &amp;&amp; (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a40065fb3d48c5c13642ef3880efaaa03">FMODE_TTY</a>) &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a>) {
<a name="l03411"></a>03411         <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *ofp;
<a name="l03412"></a>03412         <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>, ofp);
<a name="l03413"></a>03413         <span class="keywordflow">if</span> (ofp-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a40065fb3d48c5c13642ef3880efaaa03">FMODE_TTY</a>) {
<a name="l03414"></a>03414             <a class="code" href="../../db/d2e/intern_8h.html#a773ecf32a05c03d4ca1da8cf31bbfc29">rb_io_flush</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>);
<a name="l03415"></a>03415         }
<a name="l03416"></a>03416     }
<a name="l03417"></a>03417     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a7d1e7b95139715aa6fa393b30e6a39e8">io_fillbuf</a>(fptr) &lt; 0) {
<a name="l03418"></a>03418         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03419"></a>03419     }
<a name="l03420"></a>03420     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>++;
<a name="l03421"></a>03421     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>--;
<a name="l03422"></a>03422     c = (<span class="keywordtype">unsigned</span> char)fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>[fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>-1];
<a name="l03423"></a>03423     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(c &amp; 0xff);
<a name="l03424"></a>03424 }
<a name="l03425"></a>03425 
<a name="l03426"></a>03426 <span class="comment">/*</span>
<a name="l03427"></a>03427 <span class="comment"> *  call-seq:</span>
<a name="l03428"></a>03428 <span class="comment"> *     ios.readbyte   -&gt; fixnum</span>
<a name="l03429"></a>03429 <span class="comment"> *</span>
<a name="l03430"></a>03430 <span class="comment"> *  Reads a byte as with &lt;code&gt;IO#getbyte&lt;/code&gt;, but raises an</span>
<a name="l03431"></a>03431 <span class="comment"> *  &lt;code&gt;EOFError&lt;/code&gt; on end of file.</span>
<a name="l03432"></a>03432 <span class="comment"> */</span>
<a name="l03433"></a>03433 
<a name="l03434"></a>03434 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03435"></a><a class="code" href="../../df/d0a/io_8c.html#a512f661818d07b0e13bda85f72677c16">03435</a> <a class="code" href="../../df/d0a/io_8c.html#a512f661818d07b0e13bda85f72677c16">rb_io_readbyte</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l03436"></a>03436 {
<a name="l03437"></a>03437     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> c = <a class="code" href="../../db/d2e/intern_8h.html#a13c20887173177e30ccd7bb42708dc2b">rb_io_getbyte</a>(io);
<a name="l03438"></a>03438 
<a name="l03439"></a>03439     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(c)) {
<a name="l03440"></a>03440         <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>();
<a name="l03441"></a>03441     }
<a name="l03442"></a>03442     <span class="keywordflow">return</span> c;
<a name="l03443"></a>03443 }
<a name="l03444"></a>03444 
<a name="l03445"></a>03445 <span class="comment">/*</span>
<a name="l03446"></a>03446 <span class="comment"> *  call-seq:</span>
<a name="l03447"></a>03447 <span class="comment"> *     ios.ungetbyte(string)   -&gt; nil</span>
<a name="l03448"></a>03448 <span class="comment"> *     ios.ungetbyte(integer)   -&gt; nil</span>
<a name="l03449"></a>03449 <span class="comment"> *</span>
<a name="l03450"></a>03450 <span class="comment"> *  Pushes back bytes (passed as a parameter) onto &lt;em&gt;ios&lt;/em&gt;,</span>
<a name="l03451"></a>03451 <span class="comment"> *  such that a subsequent buffered read will return it. Only one byte</span>
<a name="l03452"></a>03452 <span class="comment"> *  may be pushed back before a subsequent read operation (that is,</span>
<a name="l03453"></a>03453 <span class="comment"> *  you will be able to read only the last of several bytes that have been pushed</span>
<a name="l03454"></a>03454 <span class="comment"> *  back). Has no effect with unbuffered reads (such as &lt;code&gt;IO#sysread&lt;/code&gt;).</span>
<a name="l03455"></a>03455 <span class="comment"> *</span>
<a name="l03456"></a>03456 <span class="comment"> *     f = File.new(&quot;testfile&quot;)   #=&gt; #&lt;File:testfile&gt;</span>
<a name="l03457"></a>03457 <span class="comment"> *     b = f.getbyte              #=&gt; 0x38</span>
<a name="l03458"></a>03458 <span class="comment"> *     f.ungetbyte(b)             #=&gt; nil</span>
<a name="l03459"></a>03459 <span class="comment"> *     f.getbyte                  #=&gt; 0x38</span>
<a name="l03460"></a>03460 <span class="comment"> */</span>
<a name="l03461"></a>03461 
<a name="l03462"></a>03462 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03463"></a><a class="code" href="../../df/d0a/io_8c.html#a2771a6d5cd93f86aec8b82521a0f0c06">03463</a> <a class="code" href="../../db/d2e/intern_8h.html#ad5e3541ec00f5805a8bfb10fbe71a33a">rb_io_ungetbyte</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> b)
<a name="l03464"></a>03464 {
<a name="l03465"></a>03465     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l03466"></a>03466 
<a name="l03467"></a>03467     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l03468"></a>03468     <a class="code" href="../../dc/dac/io_8h.html#a38b3a618992ee85d5510dc70db4e2b36">rb_io_check_byte_readable</a>(fptr);
<a name="l03469"></a>03469     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(b)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03470"></a>03470     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#acf2fcf97dcf9c7c35452730eb3e2aeb2">FIXNUM_P</a>(b)) {
<a name="l03471"></a>03471         <span class="keywordtype">char</span> cc = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9444c431b3cb1184e7523fc572f2c758">FIX2INT</a>(b);
<a name="l03472"></a>03472         b = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(&amp;cc, 1);
<a name="l03473"></a>03473     }
<a name="l03474"></a>03474     <span class="keywordflow">else</span> {
<a name="l03475"></a>03475         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0381640e2905c1b3e104194f91697ca4">SafeStringValue</a>(b);
<a name="l03476"></a>03476     }
<a name="l03477"></a>03477     <a class="code" href="../../df/d0a/io_8c.html#a9a3bd2eccbe1a9fbb124dac6a1eca2ed">io_ungetbyte</a>(b, fptr);
<a name="l03478"></a>03478     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03479"></a>03479 }
<a name="l03480"></a>03480 
<a name="l03481"></a>03481 <span class="comment">/*</span>
<a name="l03482"></a>03482 <span class="comment"> *  call-seq:</span>
<a name="l03483"></a>03483 <span class="comment"> *     ios.ungetc(string)   -&gt; nil</span>
<a name="l03484"></a>03484 <span class="comment"> *</span>
<a name="l03485"></a>03485 <span class="comment"> *  Pushes back one character (passed as a parameter) onto &lt;em&gt;ios&lt;/em&gt;,</span>
<a name="l03486"></a>03486 <span class="comment"> *  such that a subsequent buffered character read will return it. Only one character</span>
<a name="l03487"></a>03487 <span class="comment"> *  may be pushed back before a subsequent read operation (that is,</span>
<a name="l03488"></a>03488 <span class="comment"> *  you will be able to read only the last of several characters that have been pushed</span>
<a name="l03489"></a>03489 <span class="comment"> *  back). Has no effect with unbuffered reads (such as &lt;code&gt;IO#sysread&lt;/code&gt;).</span>
<a name="l03490"></a>03490 <span class="comment"> *</span>
<a name="l03491"></a>03491 <span class="comment"> *     f = File.new(&quot;testfile&quot;)   #=&gt; #&lt;File:testfile&gt;</span>
<a name="l03492"></a>03492 <span class="comment"> *     c = f.getc                 #=&gt; &quot;8&quot;</span>
<a name="l03493"></a>03493 <span class="comment"> *     f.ungetc(c)                #=&gt; nil</span>
<a name="l03494"></a>03494 <span class="comment"> *     f.getc                     #=&gt; &quot;8&quot;</span>
<a name="l03495"></a>03495 <span class="comment"> */</span>
<a name="l03496"></a>03496 
<a name="l03497"></a>03497 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03498"></a><a class="code" href="../../df/d0a/io_8c.html#ab4ae9754b2e1b68035b2f62e130a7ee6">03498</a> <a class="code" href="../../db/d2e/intern_8h.html#a494a6de694f10dfe1b8da289e6479c51">rb_io_ungetc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> c)
<a name="l03499"></a>03499 {
<a name="l03500"></a>03500     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l03501"></a>03501     <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l03502"></a>03502 
<a name="l03503"></a>03503     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l03504"></a>03504     <a class="code" href="../../dc/dac/io_8h.html#acbd19ff86a565ed9e9f15e4f49736f3d">rb_io_check_char_readable</a>(fptr);
<a name="l03505"></a>03505     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(c)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03506"></a>03506     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#acf2fcf97dcf9c7c35452730eb3e2aeb2">FIXNUM_P</a>(c)) {
<a name="l03507"></a>03507         c = <a class="code" href="../../d5/de3/encoding_8h.html#a5ec51a3a3c8089728c6ac121d37205bb">rb_enc_uint_chr</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aaf9c568541e720d34bda2d7009c69365">FIX2UINT</a>(c), <a class="code" href="../../df/d0a/io_8c.html#aa3b568197b019bda6a9aea4fbe2153eb">io_read_encoding</a>(fptr));
<a name="l03508"></a>03508     }
<a name="l03509"></a>03509     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(c) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a41ac74a27dd1eadc2ca86d10590f2163">T_BIGNUM</a>) {
<a name="l03510"></a>03510         c = <a class="code" href="../../d5/de3/encoding_8h.html#a5ec51a3a3c8089728c6ac121d37205bb">rb_enc_uint_chr</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a72d845303f20fad5c5ef29c339d3c7f6">NUM2UINT</a>(c), <a class="code" href="../../df/d0a/io_8c.html#aa3b568197b019bda6a9aea4fbe2153eb">io_read_encoding</a>(fptr));
<a name="l03511"></a>03511     }
<a name="l03512"></a>03512     <span class="keywordflow">else</span> {
<a name="l03513"></a>03513         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0381640e2905c1b3e104194f91697ca4">SafeStringValue</a>(c);
<a name="l03514"></a>03514     }
<a name="l03515"></a>03515     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a92621ca418c11e96d4862166f9076a73">NEED_READCONV</a>(fptr)) {
<a name="l03516"></a>03516         <a class="code" href="../../df/d0a/io_8c.html#ace89c001caf3ebc8943c8f06c0aab552">SET_BINARY_MODE</a>(fptr);
<a name="l03517"></a>03517         len = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(c);
<a name="l03518"></a>03518 <span class="preprocessor">#if SIZEOF_LONG &gt; SIZEOF_INT</span>
<a name="l03519"></a>03519 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (len &gt; INT_MAX)
<a name="l03520"></a>03520             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;ungetc failed&quot;</span>);
<a name="l03521"></a>03521 <span class="preprocessor">#endif</span>
<a name="l03522"></a>03522 <span class="preprocessor"></span>        <a class="code" href="../../df/d0a/io_8c.html#a7270c50b73afa5c8c999dacfab097524">make_readconv</a>(fptr, (<span class="keywordtype">int</span>)len);
<a name="l03523"></a>03523         <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a> - fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> &lt; len)
<a name="l03524"></a>03524             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;ungetc failed&quot;</span>);
<a name="l03525"></a>03525         <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> &lt; len) {
<a name="l03526"></a>03526             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aad09de334c9b8c7f717d314b14679e62">MEMMOVE</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>-fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>,
<a name="l03527"></a>03527                     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>,
<a name="l03528"></a>03528                     <span class="keywordtype">char</span>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>);
<a name="l03529"></a>03529             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>-fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>;
<a name="l03530"></a>03530         }
<a name="l03531"></a>03531         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> -= (int)len;
<a name="l03532"></a>03532         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> += (int)len;
<a name="l03533"></a>03533         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aad09de334c9b8c7f717d314b14679e62">MEMMOVE</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>+fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a>, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(c), <span class="keywordtype">char</span>, len);
<a name="l03534"></a>03534     }
<a name="l03535"></a>03535     <span class="keywordflow">else</span> {
<a name="l03536"></a>03536         <a class="code" href="../../df/d0a/io_8c.html#abd7495bb74588d590a98112929d9010c">NEED_NEWLINE_DECORATOR_ON_READ_CHECK</a>(fptr);
<a name="l03537"></a>03537         <a class="code" href="../../df/d0a/io_8c.html#a9a3bd2eccbe1a9fbb124dac6a1eca2ed">io_ungetbyte</a>(c, fptr);
<a name="l03538"></a>03538     }
<a name="l03539"></a>03539     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03540"></a>03540 }
<a name="l03541"></a>03541 
<a name="l03542"></a>03542 <span class="comment">/*</span>
<a name="l03543"></a>03543 <span class="comment"> *  call-seq:</span>
<a name="l03544"></a>03544 <span class="comment"> *     ios.isatty   -&gt; true or false</span>
<a name="l03545"></a>03545 <span class="comment"> *     ios.tty?     -&gt; true or false</span>
<a name="l03546"></a>03546 <span class="comment"> *</span>
<a name="l03547"></a>03547 <span class="comment"> *  Returns &lt;code&gt;true&lt;/code&gt; if &lt;em&gt;ios&lt;/em&gt; is associated with a</span>
<a name="l03548"></a>03548 <span class="comment"> *  terminal device (tty), &lt;code&gt;false&lt;/code&gt; otherwise.</span>
<a name="l03549"></a>03549 <span class="comment"> *</span>
<a name="l03550"></a>03550 <span class="comment"> *     File.new(&quot;testfile&quot;).isatty   #=&gt; false</span>
<a name="l03551"></a>03551 <span class="comment"> *     File.new(&quot;/dev/tty&quot;).isatty   #=&gt; true</span>
<a name="l03552"></a>03552 <span class="comment"> */</span>
<a name="l03553"></a>03553 
<a name="l03554"></a>03554 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03555"></a><a class="code" href="../../df/d0a/io_8c.html#a732eb09f86dbbb17e14babef8752afaf">03555</a> <a class="code" href="../../df/d0a/io_8c.html#a732eb09f86dbbb17e14babef8752afaf">rb_io_isatty</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l03556"></a>03556 {
<a name="l03557"></a>03557     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l03558"></a>03558 
<a name="l03559"></a>03559     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l03560"></a>03560     <span class="keywordflow">if</span> (isatty(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>) == 0)
<a name="l03561"></a>03561         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l03562"></a>03562     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l03563"></a>03563 }
<a name="l03564"></a>03564 
<a name="l03565"></a>03565 <span class="preprocessor">#if defined(HAVE_FCNTL) &amp;&amp; defined(F_GETFD) &amp;&amp; defined(F_SETFD) &amp;&amp; defined(FD_CLOEXEC)</span>
<a name="l03566"></a>03566 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l03567"></a>03567 <span class="comment"> *  call-seq:</span>
<a name="l03568"></a>03568 <span class="comment"> *     ios.close_on_exec?   -&gt; true or false</span>
<a name="l03569"></a>03569 <span class="comment"> *</span>
<a name="l03570"></a>03570 <span class="comment"> *  Returns &lt;code&gt;true&lt;/code&gt; if &lt;em&gt;ios&lt;/em&gt; will be closed on exec.</span>
<a name="l03571"></a>03571 <span class="comment"> *</span>
<a name="l03572"></a>03572 <span class="comment"> *     f = open(&quot;/dev/null&quot;)</span>
<a name="l03573"></a>03573 <span class="comment"> *     f.close_on_exec?                 #=&gt; false</span>
<a name="l03574"></a>03574 <span class="comment"> *     f.close_on_exec = true</span>
<a name="l03575"></a>03575 <span class="comment"> *     f.close_on_exec?                 #=&gt; true</span>
<a name="l03576"></a>03576 <span class="comment"> *     f.close_on_exec = false</span>
<a name="l03577"></a>03577 <span class="comment"> *     f.close_on_exec?                 #=&gt; false</span>
<a name="l03578"></a>03578 <span class="comment"> */</span>
<a name="l03579"></a>03579 
<a name="l03580"></a>03580 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03581"></a>03581 <a class="code" href="../../df/d0a/io_8c.html#a4c9604f6272d5c09e1613ceffde9e27e">rb_io_close_on_exec_p</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l03582"></a>03582 {
<a name="l03583"></a>03583     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l03584"></a>03584     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write_io;
<a name="l03585"></a>03585     <span class="keywordtype">int</span> fd, ret;
<a name="l03586"></a>03586 
<a name="l03587"></a>03587     write_io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l03588"></a>03588     <span class="keywordflow">if</span> (io != write_io) {
<a name="l03589"></a>03589         <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(write_io, fptr);
<a name="l03590"></a>03590         <span class="keywordflow">if</span> (fptr &amp;&amp; 0 &lt;= (fd = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>)) {
<a name="l03591"></a>03591             <span class="keywordflow">if</span> ((ret = <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fd, F_GETFD)) == -1) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l03592"></a>03592             <span class="keywordflow">if</span> (!(ret &amp; FD_CLOEXEC)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l03593"></a>03593         }
<a name="l03594"></a>03594     }
<a name="l03595"></a>03595 
<a name="l03596"></a>03596     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l03597"></a>03597     <span class="keywordflow">if</span> (fptr &amp;&amp; 0 &lt;= (fd = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>)) {
<a name="l03598"></a>03598         <span class="keywordflow">if</span> ((ret = <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fd, F_GETFD)) == -1) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l03599"></a>03599         <span class="keywordflow">if</span> (!(ret &amp; FD_CLOEXEC)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l03600"></a>03600     }
<a name="l03601"></a>03601     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l03602"></a>03602 }
<a name="l03603"></a>03603 <span class="preprocessor">#else</span>
<a name="l03604"></a><a class="code" href="../../df/d0a/io_8c.html#a4c9604f6272d5c09e1613ceffde9e27e">03604</a> <span class="preprocessor"></span><span class="preprocessor">#define rb_io_close_on_exec_p rb_f_notimplement</span>
<a name="l03605"></a>03605 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l03606"></a>03606 <span class="preprocessor"></span>
<a name="l03607"></a>03607 <span class="preprocessor">#if defined(HAVE_FCNTL) &amp;&amp; defined(F_GETFD) &amp;&amp; defined(F_SETFD) &amp;&amp; defined(FD_CLOEXEC)</span>
<a name="l03608"></a>03608 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l03609"></a>03609 <span class="comment"> *  call-seq:</span>
<a name="l03610"></a>03610 <span class="comment"> *     ios.close_on_exec = bool    -&gt; true or false</span>
<a name="l03611"></a>03611 <span class="comment"> *</span>
<a name="l03612"></a>03612 <span class="comment"> *  Sets a close-on-exec flag.</span>
<a name="l03613"></a>03613 <span class="comment"> *</span>
<a name="l03614"></a>03614 <span class="comment"> *     f = open(&quot;/dev/null&quot;)</span>
<a name="l03615"></a>03615 <span class="comment"> *     f.close_on_exec = true</span>
<a name="l03616"></a>03616 <span class="comment"> *     system(&quot;cat&quot;, &quot;/proc/self/fd/#{f.fileno}&quot;) # cat: /proc/self/fd/3: No such file or directory</span>
<a name="l03617"></a>03617 <span class="comment"> *     f.closed?                #=&gt; false</span>
<a name="l03618"></a>03618 <span class="comment"> */</span>
<a name="l03619"></a>03619 
<a name="l03620"></a>03620 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03621"></a>03621 <a class="code" href="../../df/d0a/io_8c.html#adc297d05a298e421011648796d6d844f">rb_io_set_close_on_exec</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l03622"></a>03622 {
<a name="l03623"></a>03623     <span class="keywordtype">int</span> flag = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(arg) ? FD_CLOEXEC : 0;
<a name="l03624"></a>03624     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l03625"></a>03625     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write_io;
<a name="l03626"></a>03626     <span class="keywordtype">int</span> fd, ret;
<a name="l03627"></a>03627 
<a name="l03628"></a>03628     write_io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l03629"></a>03629     <span class="keywordflow">if</span> (io != write_io) {
<a name="l03630"></a>03630         <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(write_io, fptr);
<a name="l03631"></a>03631         <span class="keywordflow">if</span> (fptr &amp;&amp; 0 &lt;= (fd = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>)) {
<a name="l03632"></a>03632             <span class="keywordflow">if</span> ((ret = <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, F_GETFD)) == -1) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l03633"></a>03633             <span class="keywordflow">if</span> ((ret &amp; FD_CLOEXEC) != flag) {
<a name="l03634"></a>03634                 ret = (ret &amp; ~FD_CLOEXEC) | flag;
<a name="l03635"></a>03635                 ret = <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fd, F_SETFD, ret);
<a name="l03636"></a>03636                 <span class="keywordflow">if</span> (ret == -1) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l03637"></a>03637             }
<a name="l03638"></a>03638         }
<a name="l03639"></a>03639 
<a name="l03640"></a>03640     }
<a name="l03641"></a>03641 
<a name="l03642"></a>03642     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l03643"></a>03643     <span class="keywordflow">if</span> (fptr &amp;&amp; 0 &lt;= (fd = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>)) {
<a name="l03644"></a>03644         <span class="keywordflow">if</span> ((ret = <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fd, F_GETFD)) == -1) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l03645"></a>03645         <span class="keywordflow">if</span> ((ret &amp; FD_CLOEXEC) != flag) {
<a name="l03646"></a>03646             ret = (ret &amp; ~FD_CLOEXEC) | flag;
<a name="l03647"></a>03647             ret = <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fd, F_SETFD, ret);
<a name="l03648"></a>03648             <span class="keywordflow">if</span> (ret == -1) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l03649"></a>03649         }
<a name="l03650"></a>03650     }
<a name="l03651"></a>03651     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03652"></a>03652 }
<a name="l03653"></a>03653 <span class="preprocessor">#else</span>
<a name="l03654"></a><a class="code" href="../../df/d0a/io_8c.html#adc297d05a298e421011648796d6d844f">03654</a> <span class="preprocessor"></span><span class="preprocessor">#define rb_io_set_close_on_exec rb_f_notimplement</span>
<a name="l03655"></a>03655 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l03656"></a>03656 <span class="preprocessor"></span>
<a name="l03657"></a><a class="code" href="../../df/d0a/io_8c.html#a8d840b75e901aaf536355307ebef1291">03657</a> <span class="preprocessor">#define FMODE_PREP (1&lt;&lt;16)</span>
<a name="l03658"></a><a class="code" href="../../df/d0a/io_8c.html#ae96f61e7e8ed6ac314a838919617ccee">03658</a> <span class="preprocessor"></span><span class="preprocessor">#define IS_PREP_STDIO(f) ((f)-&gt;mode &amp; FMODE_PREP)</span>
<a name="l03659"></a><a class="code" href="../../df/d0a/io_8c.html#a8023d58d05a057f4d67c135295be3f5c">03659</a> <span class="preprocessor"></span><span class="preprocessor">#define PREP_STDIO_NAME(f) (RSTRING_PTR((f)-&gt;pathv))</span>
<a name="l03660"></a>03660 <span class="preprocessor"></span>
<a name="l03661"></a>03661 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03662"></a><a class="code" href="../../df/d0a/io_8c.html#a5307ed0799f0a596aa694f778379c31d">03662</a> <a class="code" href="../../df/d0a/io_8c.html#a5307ed0799f0a596aa694f778379c31d">finish_writeconv</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <span class="keywordtype">int</span> noalloc)
<a name="l03663"></a>03663 {
<a name="l03664"></a>03664     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ds, *<a class="code" href="../../db/d16/debug_8h.html#a08a47aff6867e5ae146382e66d2cc26b">dp</a>, *de;
<a name="l03665"></a>03665     <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a> res;
<a name="l03666"></a>03666 
<a name="l03667"></a>03667     <span class="keywordflow">if</span> (!fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>) {
<a name="l03668"></a>03668         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>[1024];
<a name="l03669"></a>03669         <span class="keywordtype">long</span> r;
<a name="l03670"></a>03670 
<a name="l03671"></a>03671         res = <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a>;
<a name="l03672"></a>03672         <span class="keywordflow">while</span> (res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a>) {
<a name="l03673"></a>03673             ds = dp = buf;
<a name="l03674"></a>03674             de = buf + <span class="keyword">sizeof</span>(buf);
<a name="l03675"></a>03675             res = <a class="code" href="../../d5/de3/encoding_8h.html#a346451a419b3ce73da0d2323eb3238ee">rb_econv_convert</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;dp, de, 0);
<a name="l03676"></a>03676             <span class="keywordflow">while</span> (dp-ds) {
<a name="l03677"></a>03677               retry:
<a name="l03678"></a>03678                 r = <a class="code" href="../../df/d0a/io_8c.html#ac7a460cb9d941a9c2f160f52b35b5948">rb_write_internal</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, ds, dp-ds);
<a name="l03679"></a>03679                 <span class="keywordflow">if</span> (r == dp-ds)
<a name="l03680"></a>03680                     <span class="keywordflow">break</span>;
<a name="l03681"></a>03681                 <span class="keywordflow">if</span> (0 &lt;= r) {
<a name="l03682"></a>03682                     ds += r;
<a name="l03683"></a>03683                 }
<a name="l03684"></a>03684                 <span class="keywordflow">if</span> (<a class="code" href="../../dc/dac/io_8h.html#af28a170d3ffb07353653f832d95c6ba6">rb_io_wait_writable</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>)) {
<a name="l03685"></a>03685                     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> &lt; 0)
<a name="l03686"></a>03686                         <span class="keywordflow">return</span> noalloc ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../db/dcc/error_8c.html#a4989eeb5742cad6359a2ed77859674de">rb_exc_new3</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <a class="code" href="../../db/d2e/intern_8h.html#a2b9cc485b0aa1dc270744b8b9eb47569">rb_str_new_cstr</a>(<span class="stringliteral">&quot;closed stream&quot;</span>));
<a name="l03687"></a>03687                     <span class="keywordflow">goto</span> retry;
<a name="l03688"></a>03688                 }
<a name="l03689"></a>03689                 <span class="keywordflow">return</span> noalloc ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>);
<a name="l03690"></a>03690             }
<a name="l03691"></a>03691             <span class="keywordflow">if</span> (res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad43244977ecc5d0f0cda6d003b1e37d1">econv_invalid_byte_sequence</a> ||
<a name="l03692"></a>03692                 res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa42fe600023b5129588324a787ade662d">econv_incomplete_input</a> ||
<a name="l03693"></a>03693                 res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7e59e5dc4cb8b9db559a803ee88aec57">econv_undefined_conversion</a>) {
<a name="l03694"></a>03694                 <span class="keywordflow">return</span> noalloc ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../d5/de3/encoding_8h.html#a97f7e97de80001465896aae6ae28731b">rb_econv_make_exception</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>);
<a name="l03695"></a>03695             }
<a name="l03696"></a>03696         }
<a name="l03697"></a>03697 
<a name="l03698"></a>03698         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03699"></a>03699     }
<a name="l03700"></a>03700 
<a name="l03701"></a>03701     res = <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a>;
<a name="l03702"></a>03702     <span class="keywordflow">while</span> (res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a>) {
<a name="l03703"></a>03703         <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> == fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>) {
<a name="l03704"></a>03704             <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(fptr) &lt; 0)
<a name="l03705"></a>03705                 <span class="keywordflow">return</span> noalloc ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>);
<a name="l03706"></a>03706         }
<a name="l03707"></a>03707 
<a name="l03708"></a>03708         ds = dp = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>;
<a name="l03709"></a>03709         de = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> + fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>;
<a name="l03710"></a>03710         res = <a class="code" href="../../d5/de3/encoding_8h.html#a346451a419b3ce73da0d2323eb3238ee">rb_econv_convert</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;dp, de, 0);
<a name="l03711"></a>03711         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> += (int)(dp - ds);
<a name="l03712"></a>03712         <span class="keywordflow">if</span> (res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad43244977ecc5d0f0cda6d003b1e37d1">econv_invalid_byte_sequence</a> ||
<a name="l03713"></a>03713             res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa42fe600023b5129588324a787ade662d">econv_incomplete_input</a> ||
<a name="l03714"></a>03714             res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7e59e5dc4cb8b9db559a803ee88aec57">econv_undefined_conversion</a>) {
<a name="l03715"></a>03715             <span class="keywordflow">return</span> noalloc ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../d5/de3/encoding_8h.html#a97f7e97de80001465896aae6ae28731b">rb_econv_make_exception</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>);
<a name="l03716"></a>03716         }
<a name="l03717"></a>03717     }
<a name="l03718"></a>03718     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03719"></a>03719 }
<a name="l03720"></a>03720 
<a name="l03721"></a><a class="code" href="../../d0/d9b/structfinish__writeconv__arg.html">03721</a> <span class="keyword">struct </span><a class="code" href="../../d0/d9b/structfinish__writeconv__arg.html">finish_writeconv_arg</a> {
<a name="l03722"></a><a class="code" href="../../d0/d9b/structfinish__writeconv__arg.html#a5275e1eb0d4bd1e120be74921db33aec">03722</a>     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l03723"></a><a class="code" href="../../d0/d9b/structfinish__writeconv__arg.html#a7bfaa6c0e455e64e9e6991ebdc878097">03723</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/d9b/structfinish__writeconv__arg.html#a7bfaa6c0e455e64e9e6991ebdc878097">noalloc</a>;
<a name="l03724"></a>03724 };
<a name="l03725"></a>03725 
<a name="l03726"></a>03726 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03727"></a><a class="code" href="../../df/d0a/io_8c.html#a2d456d7f9e207ba16d6af8c9e9a92f92">03727</a> <a class="code" href="../../df/d0a/io_8c.html#a2d456d7f9e207ba16d6af8c9e9a92f92">finish_writeconv_sync</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l03728"></a>03728 {
<a name="l03729"></a>03729     <span class="keyword">struct </span><a class="code" href="../../d0/d9b/structfinish__writeconv__arg.html">finish_writeconv_arg</a> *p = (<span class="keyword">struct </span><a class="code" href="../../d0/d9b/structfinish__writeconv__arg.html">finish_writeconv_arg</a> *)arg;
<a name="l03730"></a>03730     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a5307ed0799f0a596aa694f778379c31d">finish_writeconv</a>(p-&gt;<a class="code" href="../../d0/d9b/structfinish__writeconv__arg.html#a5275e1eb0d4bd1e120be74921db33aec">fptr</a>, p-&gt;<a class="code" href="../../d0/d9b/structfinish__writeconv__arg.html#a7bfaa6c0e455e64e9e6991ebdc878097">noalloc</a>);
<a name="l03731"></a>03731 }
<a name="l03732"></a>03732 
<a name="l03733"></a>03733 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l03734"></a><a class="code" href="../../df/d0a/io_8c.html#af3f583ba468c4669c27e4be2f7943abb">03734</a> <a class="code" href="../../df/d0a/io_8c.html#af3f583ba468c4669c27e4be2f7943abb">fptr_finalize</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <span class="keywordtype">int</span> noraise)
<a name="l03735"></a>03735 {
<a name="l03736"></a>03736     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03737"></a>03737     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>) {
<a name="l03738"></a>03738         <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ab6eade210f169f0a929e1381cbef947d">write_lock</a> &amp;&amp; !noraise) {
<a name="l03739"></a>03739             <span class="keyword">struct </span><a class="code" href="../../d0/d9b/structfinish__writeconv__arg.html">finish_writeconv_arg</a> arg;
<a name="l03740"></a>03740             arg.<a class="code" href="../../d0/d9b/structfinish__writeconv__arg.html#a5275e1eb0d4bd1e120be74921db33aec">fptr</a> = fptr;
<a name="l03741"></a>03741             arg.<a class="code" href="../../d0/d9b/structfinish__writeconv__arg.html#a7bfaa6c0e455e64e9e6991ebdc878097">noalloc</a> = noraise;
<a name="l03742"></a>03742             err = <a class="code" href="../../db/d2e/intern_8h.html#a67eed485066a22a165646aa1fcce93bf">rb_mutex_synchronize</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ab6eade210f169f0a929e1381cbef947d">write_lock</a>, <a class="code" href="../../df/d0a/io_8c.html#a2d456d7f9e207ba16d6af8c9e9a92f92">finish_writeconv_sync</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;arg);
<a name="l03743"></a>03743         }
<a name="l03744"></a>03744         <span class="keywordflow">else</span> {
<a name="l03745"></a>03745             err = <a class="code" href="../../df/d0a/io_8c.html#a5307ed0799f0a596aa694f778379c31d">finish_writeconv</a>(fptr, noraise);
<a name="l03746"></a>03746         }
<a name="l03747"></a>03747     }
<a name="l03748"></a>03748     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>) {
<a name="l03749"></a>03749         <span class="keywordflow">if</span> (noraise) {
<a name="l03750"></a>03750             <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)<a class="code" href="../../df/d0a/io_8c.html#abb3882e4a3efa9a701ef4e6b9f431de4">io_flush_buffer_sync</a>(fptr) &lt; 0 &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(err))
<a name="l03751"></a>03751                 err = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l03752"></a>03752         }
<a name="l03753"></a>03753         <span class="keywordflow">else</span> {
<a name="l03754"></a>03754             <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(fptr) &lt; 0 &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(err))
<a name="l03755"></a>03755                 err = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>);
<a name="l03756"></a>03756         }
<a name="l03757"></a>03757     }
<a name="l03758"></a>03758     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#ae96f61e7e8ed6ac314a838919617ccee">IS_PREP_STDIO</a>(fptr) || fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> &lt;= 2) {
<a name="l03759"></a>03759         <span class="keywordflow">goto</span> skip_fd_close;
<a name="l03760"></a>03760     }
<a name="l03761"></a>03761     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a>) {
<a name="l03762"></a>03762         <span class="comment">/* fptr-&gt;stdio_file is deallocated anyway</span>
<a name="l03763"></a>03763 <span class="comment">         * even if fclose failed.  */</span>
<a name="l03764"></a>03764         <span class="keywordflow">if</span> (fclose(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a>) &lt; 0 &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(err))
<a name="l03765"></a>03765             err = noraise ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>);
<a name="l03766"></a>03766     }
<a name="l03767"></a>03767     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (0 &lt;= fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>) {
<a name="l03768"></a>03768         <span class="comment">/* fptr-&gt;fd may be closed even if close fails.</span>
<a name="l03769"></a>03769 <span class="comment">         * POSIX doesn&apos;t specify it.</span>
<a name="l03770"></a>03770 <span class="comment">         * We assumes it is closed.  */</span>
<a name="l03771"></a>03771         <span class="keywordflow">if</span> (close(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>) &lt; 0 &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(err))
<a name="l03772"></a>03772             err = noraise ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>);
<a name="l03773"></a>03773     }
<a name="l03774"></a>03774   skip_fd_close:
<a name="l03775"></a>03775     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> = -1;
<a name="l03776"></a>03776     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a> = 0;
<a name="l03777"></a>03777     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp;= ~(<a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>|<a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>);
<a name="l03778"></a>03778 
<a name="l03779"></a>03779     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(err) &amp;&amp; !noraise) {
<a name="l03780"></a>03780         <span class="keywordflow">switch</span>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(err)) {
<a name="l03781"></a>03781           <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a523855de5546c34061e030f4606db3e9">T_FIXNUM</a>:
<a name="l03782"></a>03782           <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a41ac74a27dd1eadc2ca86d10590f2163">T_BIGNUM</a>:
<a name="l03783"></a>03783             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(err);
<a name="l03784"></a>03784             <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l03785"></a>03785 
<a name="l03786"></a>03786           <span class="keywordflow">default</span>:
<a name="l03787"></a>03787             <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(err);
<a name="l03788"></a>03788         }
<a name="l03789"></a>03789     }
<a name="l03790"></a>03790 }
<a name="l03791"></a>03791 
<a name="l03792"></a>03792 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l03793"></a><a class="code" href="../../df/d0a/io_8c.html#a55d86535586e243472ea1080c1c8d535">03793</a> <a class="code" href="../../df/d0a/io_8c.html#a55d86535586e243472ea1080c1c8d535">rb_io_fptr_cleanup</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <span class="keywordtype">int</span> noraise)
<a name="l03794"></a>03794 {
<a name="l03795"></a>03795     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a5a2f6f866626d12df82f61cf98401f8c">finalize</a>) {
<a name="l03796"></a>03796         (*fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a5a2f6f866626d12df82f61cf98401f8c">finalize</a>)(fptr, noraise);
<a name="l03797"></a>03797     }
<a name="l03798"></a>03798     <span class="keywordflow">else</span> {
<a name="l03799"></a>03799         <a class="code" href="../../df/d0a/io_8c.html#af3f583ba468c4669c27e4be2f7943abb">fptr_finalize</a>(fptr, noraise);
<a name="l03800"></a>03800     }
<a name="l03801"></a>03801 }
<a name="l03802"></a>03802 
<a name="l03803"></a>03803 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l03804"></a><a class="code" href="../../df/d0a/io_8c.html#a89693737d8688aa1fea03c70711799ab">03804</a> <a class="code" href="../../df/d0a/io_8c.html#a89693737d8688aa1fea03c70711799ab">clear_readconv</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l03805"></a>03805 {
<a name="l03806"></a>03806     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>) {
<a name="l03807"></a>03807         <a class="code" href="../../d5/de3/encoding_8h.html#adaf53306799f8796d7e6437bc98d0b0e">rb_econv_close</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>);
<a name="l03808"></a>03808         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03809"></a>03809     }
<a name="l03810"></a>03810     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>) {
<a name="l03811"></a>03811         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>);
<a name="l03812"></a>03812         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03813"></a>03813     }
<a name="l03814"></a>03814 }
<a name="l03815"></a>03815 
<a name="l03816"></a>03816 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l03817"></a><a class="code" href="../../df/d0a/io_8c.html#ad679c0351db466582f58ddca62a3af74">03817</a> <a class="code" href="../../df/d0a/io_8c.html#ad679c0351db466582f58ddca62a3af74">clear_writeconv</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l03818"></a>03818 {
<a name="l03819"></a>03819     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>) {
<a name="l03820"></a>03820         <a class="code" href="../../d5/de3/encoding_8h.html#adaf53306799f8796d7e6437bc98d0b0e">rb_econv_close</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>);
<a name="l03821"></a>03821         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03822"></a>03822     }
<a name="l03823"></a>03823     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a98a76b1e470573eb34ed020196db9ba0">writeconv_initialized</a> = 0;
<a name="l03824"></a>03824 }
<a name="l03825"></a>03825 
<a name="l03826"></a>03826 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l03827"></a><a class="code" href="../../df/d0a/io_8c.html#a6a7e6fc03722338bbc29fc27ee59ea39">03827</a> <a class="code" href="../../df/d0a/io_8c.html#a6a7e6fc03722338bbc29fc27ee59ea39">clear_codeconv</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l03828"></a>03828 {
<a name="l03829"></a>03829     <a class="code" href="../../df/d0a/io_8c.html#a89693737d8688aa1fea03c70711799ab">clear_readconv</a>(fptr);
<a name="l03830"></a>03830     <a class="code" href="../../df/d0a/io_8c.html#ad679c0351db466582f58ddca62a3af74">clear_writeconv</a>(fptr);
<a name="l03831"></a>03831 }
<a name="l03832"></a>03832 
<a name="l03833"></a>03833 <span class="keywordtype">int</span>
<a name="l03834"></a><a class="code" href="../../df/d0a/io_8c.html#ab0351a43344edc2e332de2048b312eab">03834</a> <a class="code" href="../../dc/dac/io_8h.html#a6fc4023c7b0bced3b799f7300913de28">rb_io_fptr_finalize</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l03835"></a>03835 {
<a name="l03836"></a>03836     <span class="keywordflow">if</span> (!fptr) <span class="keywordflow">return</span> 0;
<a name="l03837"></a>03837     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03838"></a>03838     <span class="keywordflow">if</span> (0 &lt;= fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>)
<a name="l03839"></a>03839         <a class="code" href="../../df/d0a/io_8c.html#a55d86535586e243472ea1080c1c8d535">rb_io_fptr_cleanup</a>(fptr, <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03840"></a>03840     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ab6eade210f169f0a929e1381cbef947d">write_lock</a> = 0;
<a name="l03841"></a>03841     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>) {
<a name="l03842"></a>03842         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>);
<a name="l03843"></a>03843         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> = 0;
<a name="l03844"></a>03844     }
<a name="l03845"></a>03845     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>) {
<a name="l03846"></a>03846         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a>);
<a name="l03847"></a>03847         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a817f0d08e7fcb168e49fd7165a440ce1">ptr</a> = 0;
<a name="l03848"></a>03848     }
<a name="l03849"></a>03849     <a class="code" href="../../df/d0a/io_8c.html#a6a7e6fc03722338bbc29fc27ee59ea39">clear_codeconv</a>(fptr);
<a name="l03850"></a>03850     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(fptr);
<a name="l03851"></a>03851     <span class="keywordflow">return</span> 1;
<a name="l03852"></a>03852 }
<a name="l03853"></a>03853 
<a name="l03854"></a>03854 <span class="keywordtype">size_t</span> <a class="code" href="../../df/d0a/io_8c.html#a5230515101f3719ac5f9b4c16f5204fa">rb_econv_memsize</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *);
<a name="l03855"></a>03855 
<a name="l03856"></a>03856 RUBY_FUNC_EXPORTED <span class="keywordtype">size_t</span>
<a name="l03857"></a><a class="code" href="../../df/d0a/io_8c.html#ad875c24583b6fad8a5f1e157fcc971f2">03857</a> <a class="code" href="../../d3/d4e/objspace_8c.html#a9961d1dfb2b3d7ba00a0ca9fe3fa40dc">rb_io_memsize</a>(<span class="keyword">const</span> <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l03858"></a>03858 {
<a name="l03859"></a>03859     <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a>);
<a name="l03860"></a>03860     size += fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>;
<a name="l03861"></a>03861     size += fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>;
<a name="l03862"></a>03862     size += fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aba43192a9eee3e82d3ea2793eb3dbdd9">cbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac4a756c05d23c62903b5000a338adb53">capa</a>;
<a name="l03863"></a>03863     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>) size += <a class="code" href="../../df/d0a/io_8c.html#a5230515101f3719ac5f9b4c16f5204fa">rb_econv_memsize</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>);
<a name="l03864"></a>03864     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>) size += <a class="code" href="../../df/d0a/io_8c.html#a5230515101f3719ac5f9b4c16f5204fa">rb_econv_memsize</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>);
<a name="l03865"></a>03865     <span class="keywordflow">return</span> size;
<a name="l03866"></a>03866 }
<a name="l03867"></a>03867 
<a name="l03868"></a>03868 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03869"></a><a class="code" href="../../df/d0a/io_8c.html#afb5d2780c7091b3457b6ffd1e19c5a23">03869</a> <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l03870"></a>03870 {
<a name="l03871"></a>03871     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l03872"></a>03872     <span class="keywordtype">int</span> fd;
<a name="l03873"></a>03873     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write_io;
<a name="l03874"></a>03874     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *write_fptr;
<a name="l03875"></a>03875 
<a name="l03876"></a>03876     write_io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l03877"></a>03877     <span class="keywordflow">if</span> (io != write_io) {
<a name="l03878"></a>03878         write_fptr = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(write_io)-&gt;fptr;
<a name="l03879"></a>03879         <span class="keywordflow">if</span> (write_fptr &amp;&amp; 0 &lt;= write_fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>) {
<a name="l03880"></a>03880             <a class="code" href="../../df/d0a/io_8c.html#a55d86535586e243472ea1080c1c8d535">rb_io_fptr_cleanup</a>(write_fptr, <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>);
<a name="l03881"></a>03881         }
<a name="l03882"></a>03882     }
<a name="l03883"></a>03883 
<a name="l03884"></a>03884     fptr = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(io)-&gt;fptr;
<a name="l03885"></a>03885     <span class="keywordflow">if</span> (!fptr) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03886"></a>03886     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> &lt; 0) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03887"></a>03887 
<a name="l03888"></a>03888     fd = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>;
<a name="l03889"></a>03889 <span class="preprocessor">#if defined __APPLE__ &amp;&amp; defined(__MACH__) &amp;&amp; \</span>
<a name="l03890"></a>03890 <span class="preprocessor">    (!defined(MAC_OS_X_VERSION_MIN_ALLOWED) || MAC_OS_X_VERSION_MIN_ALLOWED &lt;= 1050)</span>
<a name="l03891"></a>03891 <span class="preprocessor"></span>    <span class="comment">/* close(2) on a fd which is being read by another thread causes</span>
<a name="l03892"></a>03892 <span class="comment">     * deadlock on Mac OS X 10.5 */</span>
<a name="l03893"></a>03893     <a class="code" href="../../db/d2e/intern_8h.html#ad157720b45b21621915e6eb87721ca6a">rb_thread_fd_close</a>(fd);
<a name="l03894"></a>03894 <span class="preprocessor">#endif</span>
<a name="l03895"></a>03895 <span class="preprocessor"></span>    <a class="code" href="../../df/d0a/io_8c.html#a55d86535586e243472ea1080c1c8d535">rb_io_fptr_cleanup</a>(fptr, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l03896"></a>03896     <a class="code" href="../../db/d2e/intern_8h.html#ad157720b45b21621915e6eb87721ca6a">rb_thread_fd_close</a>(fd);
<a name="l03897"></a>03897 
<a name="l03898"></a>03898     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6080b18e6883f70d36a1c1554761ccfe">pid</a>) {
<a name="l03899"></a>03899         <a class="code" href="../../db/d2e/intern_8h.html#a82c33571533db32c5bd3d2515a152593">rb_syswait</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6080b18e6883f70d36a1c1554761ccfe">pid</a>);
<a name="l03900"></a>03900         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6080b18e6883f70d36a1c1554761ccfe">pid</a> = 0;
<a name="l03901"></a>03901     }
<a name="l03902"></a>03902 
<a name="l03903"></a>03903     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03904"></a>03904 }
<a name="l03905"></a>03905 
<a name="l03906"></a>03906 <span class="comment">/*</span>
<a name="l03907"></a>03907 <span class="comment"> *  call-seq:</span>
<a name="l03908"></a>03908 <span class="comment"> *     ios.close   -&gt; nil</span>
<a name="l03909"></a>03909 <span class="comment"> *</span>
<a name="l03910"></a>03910 <span class="comment"> *  Closes &lt;em&gt;ios&lt;/em&gt; and flushes any pending writes to the operating</span>
<a name="l03911"></a>03911 <span class="comment"> *  system. The stream is unavailable for any further data operations;</span>
<a name="l03912"></a>03912 <span class="comment"> *  an &lt;code&gt;IOError&lt;/code&gt; is raised if such an attempt is made. I/O</span>
<a name="l03913"></a>03913 <span class="comment"> *  streams are automatically closed when they are claimed by the</span>
<a name="l03914"></a>03914 <span class="comment"> *  garbage collector.</span>
<a name="l03915"></a>03915 <span class="comment"> *</span>
<a name="l03916"></a>03916 <span class="comment"> *  If &lt;em&gt;ios&lt;/em&gt; is opened by &lt;code&gt;IO.popen&lt;/code&gt;,</span>
<a name="l03917"></a>03917 <span class="comment"> *  &lt;code&gt;close&lt;/code&gt; sets &lt;code&gt;$?&lt;/code&gt;.</span>
<a name="l03918"></a>03918 <span class="comment"> */</span>
<a name="l03919"></a>03919 
<a name="l03920"></a>03920 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03921"></a><a class="code" href="../../df/d0a/io_8c.html#af420b3bd2e69cd4d8ac0a7f1eebefc8d">03921</a> <a class="code" href="../../df/d0a/io_8c.html#af420b3bd2e69cd4d8ac0a7f1eebefc8d">rb_io_close_m</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l03922"></a>03922 {
<a name="l03923"></a>03923     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9d/tcltklib_8c.html#a6f520624fabb8332dc98fd223491bf8d">rb_safe_level</a>() &gt;= 4 &amp;&amp; !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a981ef70b505df85f89fba2b5c2d8b462">OBJ_UNTRUSTED</a>(io)) {
<a name="l03924"></a>03924         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ae53f1d228c34c2a7715d7d39ab1a2991">rb_eSecurityError</a>, <span class="stringliteral">&quot;Insecure: can&apos;t close&quot;</span>);
<a name="l03925"></a>03925     }
<a name="l03926"></a>03926     <a class="code" href="../../dc/dac/io_8h.html#a6b4f0c0735ecb278abd3f63059b5fc48">rb_io_check_closed</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(io)-&gt;fptr);
<a name="l03927"></a>03927     <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>(io);
<a name="l03928"></a>03928     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03929"></a>03929 }
<a name="l03930"></a>03930 
<a name="l03931"></a>03931 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03932"></a><a class="code" href="../../df/d0a/io_8c.html#a5a09b7d7498ee069ce6c420c90541092">03932</a> <a class="code" href="../../df/d0a/io_8c.html#a5a09b7d7498ee069ce6c420c90541092">io_call_close</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l03933"></a>03933 {
<a name="l03934"></a>03934     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(io, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;close&quot;</span>), 0, 0);
<a name="l03935"></a>03935 }
<a name="l03936"></a>03936 
<a name="l03937"></a>03937 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03938"></a><a class="code" href="../../df/d0a/io_8c.html#a7816bea23b5170be49ecb1a7ff8aafcf">03938</a> <a class="code" href="../../df/d0a/io_8c.html#a7816bea23b5170be49ecb1a7ff8aafcf">io_close</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l03939"></a>03939 {
<a name="l03940"></a>03940     <span class="keywordflow">return</span> <a class="code" href="../../d3/d57/eval_8c.html#a8935de1c570989c6ccc34d0336b2b75a">rb_rescue</a>(<a class="code" href="../../df/d0a/io_8c.html#a5a09b7d7498ee069ce6c420c90541092">io_call_close</a>, io, 0, 0);
<a name="l03941"></a>03941 }
<a name="l03942"></a>03942 
<a name="l03943"></a>03943 <span class="comment">/*</span>
<a name="l03944"></a>03944 <span class="comment"> *  call-seq:</span>
<a name="l03945"></a>03945 <span class="comment"> *     ios.closed?    -&gt; true or false</span>
<a name="l03946"></a>03946 <span class="comment"> *</span>
<a name="l03947"></a>03947 <span class="comment"> *  Returns &lt;code&gt;true&lt;/code&gt; if &lt;em&gt;ios&lt;/em&gt; is completely closed (for</span>
<a name="l03948"></a>03948 <span class="comment"> *  duplex streams, both reader and writer), &lt;code&gt;false&lt;/code&gt;</span>
<a name="l03949"></a>03949 <span class="comment"> *  otherwise.</span>
<a name="l03950"></a>03950 <span class="comment"> *</span>
<a name="l03951"></a>03951 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l03952"></a>03952 <span class="comment"> *     f.close         #=&gt; nil</span>
<a name="l03953"></a>03953 <span class="comment"> *     f.closed?       #=&gt; true</span>
<a name="l03954"></a>03954 <span class="comment"> *     f = IO.popen(&quot;/bin/sh&quot;,&quot;r+&quot;)</span>
<a name="l03955"></a>03955 <span class="comment"> *     f.close_write   #=&gt; nil</span>
<a name="l03956"></a>03956 <span class="comment"> *     f.closed?       #=&gt; false</span>
<a name="l03957"></a>03957 <span class="comment"> *     f.close_read    #=&gt; nil</span>
<a name="l03958"></a>03958 <span class="comment"> *     f.closed?       #=&gt; true</span>
<a name="l03959"></a>03959 <span class="comment"> */</span>
<a name="l03960"></a>03960 
<a name="l03961"></a>03961 
<a name="l03962"></a>03962 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03963"></a><a class="code" href="../../df/d0a/io_8c.html#add81852a736e6068e5619df3f4e92509">03963</a> <a class="code" href="../../df/d0a/io_8c.html#add81852a736e6068e5619df3f4e92509">rb_io_closed</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l03964"></a>03964 {
<a name="l03965"></a>03965     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l03966"></a>03966     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write_io;
<a name="l03967"></a>03967     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *write_fptr;
<a name="l03968"></a>03968 
<a name="l03969"></a>03969     write_io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l03970"></a>03970     <span class="keywordflow">if</span> (io != write_io) {
<a name="l03971"></a>03971         write_fptr = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(write_io)-&gt;fptr;
<a name="l03972"></a>03972         <span class="keywordflow">if</span> (write_fptr &amp;&amp; 0 &lt;= write_fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>) {
<a name="l03973"></a>03973             <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l03974"></a>03974         }
<a name="l03975"></a>03975     }
<a name="l03976"></a>03976 
<a name="l03977"></a>03977     fptr = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(io)-&gt;fptr;
<a name="l03978"></a>03978     <a class="code" href="../../dc/dac/io_8h.html#af5b8dfbd6b4a542196867145faaa35f5">rb_io_check_initialized</a>(fptr);
<a name="l03979"></a>03979     <span class="keywordflow">return</span> 0 &lt;= fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l03980"></a>03980 }
<a name="l03981"></a>03981 
<a name="l03982"></a>03982 <span class="comment">/*</span>
<a name="l03983"></a>03983 <span class="comment"> *  call-seq:</span>
<a name="l03984"></a>03984 <span class="comment"> *     ios.close_read    -&gt; nil</span>
<a name="l03985"></a>03985 <span class="comment"> *</span>
<a name="l03986"></a>03986 <span class="comment"> *  Closes the read end of a duplex I/O stream (i.e., one that contains</span>
<a name="l03987"></a>03987 <span class="comment"> *  both a read and a write stream, such as a pipe). Will raise an</span>
<a name="l03988"></a>03988 <span class="comment"> *  &lt;code&gt;IOError&lt;/code&gt; if the stream is not duplexed.</span>
<a name="l03989"></a>03989 <span class="comment"> *</span>
<a name="l03990"></a>03990 <span class="comment"> *     f = IO.popen(&quot;/bin/sh&quot;,&quot;r+&quot;)</span>
<a name="l03991"></a>03991 <span class="comment"> *     f.close_read</span>
<a name="l03992"></a>03992 <span class="comment"> *     f.readlines</span>
<a name="l03993"></a>03993 <span class="comment"> *</span>
<a name="l03994"></a>03994 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l03995"></a>03995 <span class="comment"> *</span>
<a name="l03996"></a>03996 <span class="comment"> *     prog.rb:3:in `readlines&apos;: not opened for reading (IOError)</span>
<a name="l03997"></a>03997 <span class="comment"> *      from prog.rb:3</span>
<a name="l03998"></a>03998 <span class="comment"> */</span>
<a name="l03999"></a>03999 
<a name="l04000"></a>04000 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04001"></a><a class="code" href="../../df/d0a/io_8c.html#afc1297e52e07c3407b90ec0342c00306">04001</a> <a class="code" href="../../df/d0a/io_8c.html#afc1297e52e07c3407b90ec0342c00306">rb_io_close_read</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l04002"></a>04002 {
<a name="l04003"></a>04003     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l04004"></a>04004     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write_io;
<a name="l04005"></a>04005 
<a name="l04006"></a>04006     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9d/tcltklib_8c.html#a6f520624fabb8332dc98fd223491bf8d">rb_safe_level</a>() &gt;= 4 &amp;&amp; !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a981ef70b505df85f89fba2b5c2d8b462">OBJ_UNTRUSTED</a>(io)) {
<a name="l04007"></a>04007         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ae53f1d228c34c2a7715d7d39ab1a2991">rb_eSecurityError</a>, <span class="stringliteral">&quot;Insecure: can&apos;t close&quot;</span>);
<a name="l04008"></a>04008     }
<a name="l04009"></a>04009     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l04010"></a>04010     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a963dc023d760a24b0e23ce29bb583732">is_socket</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>)) {
<a name="l04011"></a>04011 <span class="preprocessor">#ifndef SHUT_RD</span>
<a name="l04012"></a>04012 <span class="preprocessor"></span><span class="preprocessor"># define SHUT_RD 0</span>
<a name="l04013"></a>04013 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l04014"></a>04014 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a0db1bf6a85e45f4d6ead85a2fc43c871">shutdown</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, <a class="code" href="../../df/d0a/io_8c.html#af1c8cf84ac37451afaef3bde9976b6e1">SHUT_RD</a>) &lt; 0)
<a name="l04015"></a>04015             <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l04016"></a>04016         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp;= ~<a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>;
<a name="l04017"></a>04017         <span class="keywordflow">if</span> (!(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>))
<a name="l04018"></a>04018             <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>(io);
<a name="l04019"></a>04019         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l04020"></a>04020     }
<a name="l04021"></a>04021 
<a name="l04022"></a>04022     write_io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l04023"></a>04023     <span class="keywordflow">if</span> (io != write_io) {
<a name="l04024"></a>04024         <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *wfptr;
<a name="l04025"></a>04025         <a class="code" href="../../df/d0a/io_8c.html#a55d86535586e243472ea1080c1c8d535">rb_io_fptr_cleanup</a>(fptr, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>);
<a name="l04026"></a>04026         <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(write_io, wfptr);
<a name="l04027"></a>04027         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(io)-&gt;fptr = wfptr;
<a name="l04028"></a>04028         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(write_io)-&gt;fptr = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04029"></a>04029         <a class="code" href="../../dc/dac/io_8h.html#a6fc4023c7b0bced3b799f7300913de28">rb_io_fptr_finalize</a>(fptr);
<a name="l04030"></a>04030         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l04031"></a>04031     }
<a name="l04032"></a>04032 
<a name="l04033"></a>04033     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>) {
<a name="l04034"></a>04034         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;closing non-duplex IO for reading&quot;</span>);
<a name="l04035"></a>04035     }
<a name="l04036"></a>04036     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>(io);
<a name="l04037"></a>04037 }
<a name="l04038"></a>04038 
<a name="l04039"></a>04039 <span class="comment">/*</span>
<a name="l04040"></a>04040 <span class="comment"> *  call-seq:</span>
<a name="l04041"></a>04041 <span class="comment"> *     ios.close_write   -&gt; nil</span>
<a name="l04042"></a>04042 <span class="comment"> *</span>
<a name="l04043"></a>04043 <span class="comment"> *  Closes the write end of a duplex I/O stream (i.e., one that contains</span>
<a name="l04044"></a>04044 <span class="comment"> *  both a read and a write stream, such as a pipe). Will raise an</span>
<a name="l04045"></a>04045 <span class="comment"> *  &lt;code&gt;IOError&lt;/code&gt; if the stream is not duplexed.</span>
<a name="l04046"></a>04046 <span class="comment"> *</span>
<a name="l04047"></a>04047 <span class="comment"> *     f = IO.popen(&quot;/bin/sh&quot;,&quot;r+&quot;)</span>
<a name="l04048"></a>04048 <span class="comment"> *     f.close_write</span>
<a name="l04049"></a>04049 <span class="comment"> *     f.print &quot;nowhere&quot;</span>
<a name="l04050"></a>04050 <span class="comment"> *</span>
<a name="l04051"></a>04051 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l04052"></a>04052 <span class="comment"> *</span>
<a name="l04053"></a>04053 <span class="comment"> *     prog.rb:3:in `write&apos;: not opened for writing (IOError)</span>
<a name="l04054"></a>04054 <span class="comment"> *      from prog.rb:3:in `print&apos;</span>
<a name="l04055"></a>04055 <span class="comment"> *      from prog.rb:3</span>
<a name="l04056"></a>04056 <span class="comment"> */</span>
<a name="l04057"></a>04057 
<a name="l04058"></a>04058 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04059"></a><a class="code" href="../../df/d0a/io_8c.html#a46dd9f01ddd88b96f7e0acab4ab41dc2">04059</a> <a class="code" href="../../df/d0a/io_8c.html#a46dd9f01ddd88b96f7e0acab4ab41dc2">rb_io_close_write</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l04060"></a>04060 {
<a name="l04061"></a>04061     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l04062"></a>04062     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write_io;
<a name="l04063"></a>04063 
<a name="l04064"></a>04064     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9d/tcltklib_8c.html#a6f520624fabb8332dc98fd223491bf8d">rb_safe_level</a>() &gt;= 4 &amp;&amp; !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a981ef70b505df85f89fba2b5c2d8b462">OBJ_UNTRUSTED</a>(io)) {
<a name="l04065"></a>04065         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ae53f1d228c34c2a7715d7d39ab1a2991">rb_eSecurityError</a>, <span class="stringliteral">&quot;Insecure: can&apos;t close&quot;</span>);
<a name="l04066"></a>04066     }
<a name="l04067"></a>04067     write_io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l04068"></a>04068     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(write_io, fptr);
<a name="l04069"></a>04069     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a963dc023d760a24b0e23ce29bb583732">is_socket</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>)) {
<a name="l04070"></a>04070 <span class="preprocessor">#ifndef SHUT_WR</span>
<a name="l04071"></a>04071 <span class="preprocessor"></span><span class="preprocessor"># define SHUT_WR 1</span>
<a name="l04072"></a>04072 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l04073"></a>04073 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a0db1bf6a85e45f4d6ead85a2fc43c871">shutdown</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, <a class="code" href="../../df/d0a/io_8c.html#addb0a758e6fafdd89f5b7120f84738eb">SHUT_WR</a>) &lt; 0)
<a name="l04074"></a>04074             <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l04075"></a>04075         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp;= ~<a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>;
<a name="l04076"></a>04076         <span class="keywordflow">if</span> (!(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>))
<a name="l04077"></a>04077             <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>(write_io);
<a name="l04078"></a>04078         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l04079"></a>04079     }
<a name="l04080"></a>04080 
<a name="l04081"></a>04081     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>) {
<a name="l04082"></a>04082         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;closing non-duplex IO for writing&quot;</span>);
<a name="l04083"></a>04083     }
<a name="l04084"></a>04084 
<a name="l04085"></a>04085     <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>(write_io);
<a name="l04086"></a>04086     <span class="keywordflow">if</span> (io != write_io) {
<a name="l04087"></a>04087         <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l04088"></a>04088         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ad4507dbb812bff2064ead59f235039c2">tied_io_for_writing</a> = 0;
<a name="l04089"></a>04089         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp;= ~<a class="code" href="../../dc/dac/io_8h.html#a7bba3fe65c0f4b33d346273792dddade">FMODE_DUPLEX</a>;
<a name="l04090"></a>04090     }
<a name="l04091"></a>04091     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l04092"></a>04092 }
<a name="l04093"></a>04093 
<a name="l04094"></a>04094 <span class="comment">/*</span>
<a name="l04095"></a>04095 <span class="comment"> *  call-seq:</span>
<a name="l04096"></a>04096 <span class="comment"> *     ios.sysseek(offset, whence=IO::SEEK_SET)   -&gt; integer</span>
<a name="l04097"></a>04097 <span class="comment"> *</span>
<a name="l04098"></a>04098 <span class="comment"> *  Seeks to a given &lt;i&gt;offset&lt;/i&gt; in the stream according to the value</span>
<a name="l04099"></a>04099 <span class="comment"> *  of &lt;i&gt;whence&lt;/i&gt; (see &lt;code&gt;IO#seek&lt;/code&gt; for values of</span>
<a name="l04100"></a>04100 <span class="comment"> *  &lt;i&gt;whence&lt;/i&gt;). Returns the new offset into the file.</span>
<a name="l04101"></a>04101 <span class="comment"> *</span>
<a name="l04102"></a>04102 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l04103"></a>04103 <span class="comment"> *     f.sysseek(-13, IO::SEEK_END)   #=&gt; 53</span>
<a name="l04104"></a>04104 <span class="comment"> *     f.sysread(10)                  #=&gt; &quot;And so on.&quot;</span>
<a name="l04105"></a>04105 <span class="comment"> */</span>
<a name="l04106"></a>04106 
<a name="l04107"></a>04107 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04108"></a><a class="code" href="../../df/d0a/io_8c.html#ab69172e0b3ab8dcf5f6fcd84e26d7021">04108</a> <a class="code" href="../../df/d0a/io_8c.html#ab69172e0b3ab8dcf5f6fcd84e26d7021">rb_io_sysseek</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l04109"></a>04109 {
<a name="l04110"></a>04110     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> offset, ptrname;
<a name="l04111"></a>04111     <span class="keywordtype">int</span> whence = <a class="code" href="../../df/d0a/io_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">SEEK_SET</a>;
<a name="l04112"></a>04112     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l04113"></a>04113     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> pos;
<a name="l04114"></a>04114 
<a name="l04115"></a>04115     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;11&quot;</span>, &amp;offset, &amp;ptrname) == 2) {
<a name="l04116"></a>04116         whence = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(ptrname);
<a name="l04117"></a>04117     }
<a name="l04118"></a>04118     pos = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#adc3ee80338c33b87afa2a7047287c96f">NUM2OFFT</a>(offset);
<a name="l04119"></a>04119     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l04120"></a>04120     <span class="keywordflow">if</span> ((fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>) &amp;&amp;
<a name="l04121"></a>04121         (<a class="code" href="../../df/d0a/io_8c.html#acc172dbd9a906b747f18dc76a58990e3">READ_DATA_BUFFERED</a>(fptr) || <a class="code" href="../../df/d0a/io_8c.html#aa0377d67a404cdeebc3ad2ceab0ef054">READ_CHAR_PENDING</a>(fptr))) {
<a name="l04122"></a>04122         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;sysseek for buffered IO&quot;</span>);
<a name="l04123"></a>04123     }
<a name="l04124"></a>04124     <span class="keywordflow">if</span> ((fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>) &amp;&amp; fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>) {
<a name="l04125"></a>04125         <a class="code" href="../../db/dcc/error_8c.html#aa5b1972d475e9a090c8ef607ce033008">rb_warn</a>(<span class="stringliteral">&quot;sysseek for buffered IO&quot;</span>);
<a name="l04126"></a>04126     }
<a name="l04127"></a>04127     <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0;
<a name="l04128"></a>04128     pos = lseek(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, pos, whence);
<a name="l04129"></a>04129     <span class="keywordflow">if</span> (pos == -1 &amp;&amp; <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l04130"></a>04130 
<a name="l04131"></a>04131     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0272a51f5dbad0d6413d4de5d24c4aad">OFFT2NUM</a>(pos);
<a name="l04132"></a>04132 }
<a name="l04133"></a>04133 
<a name="l04134"></a>04134 <span class="comment">/*</span>
<a name="l04135"></a>04135 <span class="comment"> *  call-seq:</span>
<a name="l04136"></a>04136 <span class="comment"> *     ios.syswrite(string)   -&gt; integer</span>
<a name="l04137"></a>04137 <span class="comment"> *</span>
<a name="l04138"></a>04138 <span class="comment"> *  Writes the given string to &lt;em&gt;ios&lt;/em&gt; using a low-level write.</span>
<a name="l04139"></a>04139 <span class="comment"> *  Returns the number of bytes written. Do not mix with other methods</span>
<a name="l04140"></a>04140 <span class="comment"> *  that write to &lt;em&gt;ios&lt;/em&gt; or you may get unpredictable results.</span>
<a name="l04141"></a>04141 <span class="comment"> *  Raises &lt;code&gt;SystemCallError&lt;/code&gt; on error.</span>
<a name="l04142"></a>04142 <span class="comment"> *</span>
<a name="l04143"></a>04143 <span class="comment"> *     f = File.new(&quot;out&quot;, &quot;w&quot;)</span>
<a name="l04144"></a>04144 <span class="comment"> *     f.syswrite(&quot;ABCDEF&quot;)   #=&gt; 6</span>
<a name="l04145"></a>04145 <span class="comment"> */</span>
<a name="l04146"></a>04146 
<a name="l04147"></a>04147 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04148"></a><a class="code" href="../../df/d0a/io_8c.html#a99ae5729cea4de9ec885a3aebe7b89d1">04148</a> <a class="code" href="../../df/d0a/io_8c.html#a99ae5729cea4de9ec885a3aebe7b89d1">rb_io_syswrite</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str)
<a name="l04149"></a>04149 {
<a name="l04150"></a>04150     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l04151"></a>04151     <span class="keywordtype">long</span> n;
<a name="l04152"></a>04152 
<a name="l04153"></a>04153     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a98b91af598acb64fe8497413ce498766">rb_secure</a>(4);
<a name="l04154"></a>04154     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(str) != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a22a8c2a4bbaae9b68f65c9bb92fd4e39">T_STRING</a>)
<a name="l04155"></a>04155         str = <a class="code" href="../../db/d2e/intern_8h.html#acae5350f5d539c4654e4e33690256a9f">rb_obj_as_string</a>(str);
<a name="l04156"></a>04156 
<a name="l04157"></a>04157     io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l04158"></a>04158     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l04159"></a>04159     <a class="code" href="../../dc/dac/io_8h.html#a728977df67c656197402bb30a14af953">rb_io_check_writable</a>(fptr);
<a name="l04160"></a>04160 
<a name="l04161"></a>04161     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6d8c44388c98b9b92c47c2e9752a8dfe">wbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>) {
<a name="l04162"></a>04162         <a class="code" href="../../db/dcc/error_8c.html#aa5b1972d475e9a090c8ef607ce033008">rb_warn</a>(<span class="stringliteral">&quot;syswrite for buffered IO&quot;</span>);
<a name="l04163"></a>04163     }
<a name="l04164"></a>04164     <span class="keywordflow">if</span> (!<a class="code" href="../../db/d2e/intern_8h.html#ab9654ba3f4c47d18a77ebc22b5b4c356">rb_thread_fd_writable</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>)) {
<a name="l04165"></a>04165         <a class="code" href="../../dc/dac/io_8h.html#a6b4f0c0735ecb278abd3f63059b5fc48">rb_io_check_closed</a>(fptr);
<a name="l04166"></a>04166     }
<a name="l04167"></a>04167 
<a name="l04168"></a>04168     n = <a class="code" href="../../df/d0a/io_8c.html#ac7a460cb9d941a9c2f160f52b35b5948">rb_write_internal</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str));
<a name="l04169"></a>04169 
<a name="l04170"></a>04170     <span class="keywordflow">if</span> (n == -1) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l04171"></a>04171 
<a name="l04172"></a>04172     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2ead2f64c81efed352e79e89f29b8fc8">LONG2FIX</a>(n);
<a name="l04173"></a>04173 }
<a name="l04174"></a>04174 
<a name="l04175"></a>04175 <span class="comment">/*</span>
<a name="l04176"></a>04176 <span class="comment"> *  call-seq:</span>
<a name="l04177"></a>04177 <span class="comment"> *     ios.sysread(maxlen[, outbuf])    -&gt; string</span>
<a name="l04178"></a>04178 <span class="comment"> *</span>
<a name="l04179"></a>04179 <span class="comment"> *  Reads &lt;i&gt;maxlen&lt;/i&gt; bytes from &lt;em&gt;ios&lt;/em&gt; using a low-level</span>
<a name="l04180"></a>04180 <span class="comment"> *  read and returns them as a string.  Do not mix with other methods</span>
<a name="l04181"></a>04181 <span class="comment"> *  that read from &lt;em&gt;ios&lt;/em&gt; or you may get unpredictable results.</span>
<a name="l04182"></a>04182 <span class="comment"> *  If the optional &lt;i&gt;outbuf&lt;/i&gt; argument is present, it must reference</span>
<a name="l04183"></a>04183 <span class="comment"> *  a String, which will receive the data.</span>
<a name="l04184"></a>04184 <span class="comment"> *  Raises &lt;code&gt;SystemCallError&lt;/code&gt; on error and</span>
<a name="l04185"></a>04185 <span class="comment"> *  &lt;code&gt;EOFError&lt;/code&gt; at end of file.</span>
<a name="l04186"></a>04186 <span class="comment"> *</span>
<a name="l04187"></a>04187 <span class="comment"> *     f = File.new(&quot;testfile&quot;)</span>
<a name="l04188"></a>04188 <span class="comment"> *     f.sysread(16)   #=&gt; &quot;This is line one&quot;</span>
<a name="l04189"></a>04189 <span class="comment"> */</span>
<a name="l04190"></a>04190 
<a name="l04191"></a>04191 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04192"></a><a class="code" href="../../df/d0a/io_8c.html#ac593f1d6d740b68e649f17c66f428954">04192</a> <a class="code" href="../../df/d0a/io_8c.html#ac593f1d6d740b68e649f17c66f428954">rb_io_sysread</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l04193"></a>04193 {
<a name="l04194"></a>04194     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, str;
<a name="l04195"></a>04195     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l04196"></a>04196     <span class="keywordtype">long</span> n, ilen;
<a name="l04197"></a>04197 
<a name="l04198"></a>04198     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;11&quot;</span>, &amp;len, &amp;str);
<a name="l04199"></a>04199     ilen = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(len);
<a name="l04200"></a>04200 
<a name="l04201"></a>04201     <a class="code" href="../../df/d0a/io_8c.html#aaffc2b4214d2165b476eaccee348f411">io_setstrbuf</a>(&amp;str,ilen);
<a name="l04202"></a>04202     <span class="keywordflow">if</span> (ilen == 0) <span class="keywordflow">return</span> str;
<a name="l04203"></a>04203 
<a name="l04204"></a>04204     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l04205"></a>04205     <a class="code" href="../../dc/dac/io_8h.html#a38b3a618992ee85d5510dc70db4e2b36">rb_io_check_byte_readable</a>(fptr);
<a name="l04206"></a>04206 
<a name="l04207"></a>04207     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#acc172dbd9a906b747f18dc76a58990e3">READ_DATA_BUFFERED</a>(fptr)) {
<a name="l04208"></a>04208         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;sysread for buffered IO&quot;</span>);
<a name="l04209"></a>04209     }
<a name="l04210"></a>04210 
<a name="l04211"></a>04211     n = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>;
<a name="l04212"></a>04212     <a class="code" href="../../db/d2e/intern_8h.html#a38e5ff660fd6c045c7242de575e8a5f2">rb_thread_wait_fd</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>);
<a name="l04213"></a>04213     <a class="code" href="../../dc/dac/io_8h.html#a6b4f0c0735ecb278abd3f63059b5fc48">rb_io_check_closed</a>(fptr);
<a name="l04214"></a>04214 
<a name="l04215"></a>04215     <a class="code" href="../../db/d2e/intern_8h.html#ac8be785eb014dbaac6d9daeba3cbaf17">rb_str_locktmp</a>(str);
<a name="l04216"></a>04216     n = <a class="code" href="../../df/d0a/io_8c.html#aa992ea0a36c7c173ae889134907d2b22">rb_read_internal</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), ilen);
<a name="l04217"></a>04217     <a class="code" href="../../db/d2e/intern_8h.html#a027ec67101bdfadde1553c0a0a70c724">rb_str_unlocktmp</a>(str);
<a name="l04218"></a>04218 
<a name="l04219"></a>04219     <span class="keywordflow">if</span> (n == -1) {
<a name="l04220"></a>04220         <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l04221"></a>04221     }
<a name="l04222"></a>04222     <a class="code" href="../../d8/d81/ruby__missing_8h.html#a89ed8cb86ca6dd49d2db67adae809057">rb_str_set_len</a>(str, n);
<a name="l04223"></a>04223     <span class="keywordflow">if</span> (n == 0 &amp;&amp; ilen &gt; 0) {
<a name="l04224"></a>04224         <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>();
<a name="l04225"></a>04225     }
<a name="l04226"></a>04226     <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(str, n);
<a name="l04227"></a>04227     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afd75ea0cb81c17e76c73e593d1d8a860">OBJ_TAINT</a>(str);
<a name="l04228"></a>04228 
<a name="l04229"></a>04229     <span class="keywordflow">return</span> str;
<a name="l04230"></a>04230 }
<a name="l04231"></a>04231 
<a name="l04232"></a>04232 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04233"></a><a class="code" href="../../df/d0a/io_8c.html#aabbe914a5d1c3fb5e5218b2d93c4ce21">04233</a> <a class="code" href="../../db/d2e/intern_8h.html#adb93518ea7f5fdcf897359c214c03254">rb_io_binmode</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l04234"></a>04234 {
<a name="l04235"></a>04235     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l04236"></a>04236 
<a name="l04237"></a>04237     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l04238"></a>04238     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>)
<a name="l04239"></a>04239         <a class="code" href="../../d5/de3/encoding_8h.html#a8fb16d08bf53acc8c7a85fe469d3ec95">rb_econv_binmode</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>);
<a name="l04240"></a>04240     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>)
<a name="l04241"></a>04241         <a class="code" href="../../d5/de3/encoding_8h.html#a8fb16d08bf53acc8c7a85fe469d3ec95">rb_econv_binmode</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>);
<a name="l04242"></a>04242     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> |= <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>;
<a name="l04243"></a>04243     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp;= ~<a class="code" href="../../dc/dac/io_8h.html#aaf5edfb63656cca0368d0de8324015c1">FMODE_TEXTMODE</a>;
<a name="l04244"></a>04244     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaccc1b6d4b005eda87fa017026fd2701">writeconv_pre_ecflags</a> &amp;= ~<a class="code" href="../../d5/de3/encoding_8h.html#aea188e77ea841e2c7741a9ef8c4c33a5">ECONV_NEWLINE_DECORATOR_MASK</a>;
<a name="l04245"></a>04245 <span class="preprocessor">#ifdef O_BINARY</span>
<a name="l04246"></a>04246 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>) {
<a name="l04247"></a>04247         <a class="code" href="../../df/d0a/io_8c.html#a325ff952c6a51577331c216377353886">SET_BINARY_MODE_WITH_SEEK_CUR</a>(fptr);
<a name="l04248"></a>04248     }
<a name="l04249"></a>04249     <span class="keywordflow">else</span> {
<a name="l04250"></a>04250         setmode(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>);
<a name="l04251"></a>04251     }
<a name="l04252"></a>04252 <span class="preprocessor">#endif</span>
<a name="l04253"></a>04253 <span class="preprocessor"></span>    <span class="keywordflow">return</span> io;
<a name="l04254"></a>04254 }
<a name="l04255"></a>04255 
<a name="l04256"></a>04256 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04257"></a><a class="code" href="../../df/d0a/io_8c.html#aaa6c24197b3077b2b66c184352b0ae8f">04257</a> <a class="code" href="../../db/d2e/intern_8h.html#a5e93bb5b5a12f3c6638b443f4e6746b3">rb_io_ascii8bit_binmode</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l04258"></a>04258 {
<a name="l04259"></a>04259     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l04260"></a>04260 
<a name="l04261"></a>04261     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l04262"></a>04262     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>) {
<a name="l04263"></a>04263         <a class="code" href="../../d5/de3/encoding_8h.html#adaf53306799f8796d7e6437bc98d0b0e">rb_econv_close</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a>);
<a name="l04264"></a>04264         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a86265dc445995fd9696605aa78fe99be">readconv</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04265"></a>04265     }
<a name="l04266"></a>04266     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>) {
<a name="l04267"></a>04267         <a class="code" href="../../d5/de3/encoding_8h.html#adaf53306799f8796d7e6437bc98d0b0e">rb_econv_close</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a>);
<a name="l04268"></a>04268         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6078f27f1649b08a35ff32e642df4827">writeconv</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04269"></a>04269     }
<a name="l04270"></a>04270     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> |= <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>;
<a name="l04271"></a>04271     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp;= ~<a class="code" href="../../dc/dac/io_8h.html#aaf5edfb63656cca0368d0de8324015c1">FMODE_TEXTMODE</a>;
<a name="l04272"></a>04272     <a class="code" href="../../df/d0a/io_8c.html#a325ff952c6a51577331c216377353886">SET_BINARY_MODE_WITH_SEEK_CUR</a>(fptr);
<a name="l04273"></a>04273 
<a name="l04274"></a>04274     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc = <a class="code" href="../../d5/db5/encoding_8c.html#a767d777810f0d48add93857b52057262">rb_ascii8bit_encoding</a>();
<a name="l04275"></a>04275     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc2 = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04276"></a>04276     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags = 0;
<a name="l04277"></a>04277     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecopts = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l04278"></a>04278     <a class="code" href="../../df/d0a/io_8c.html#a6a7e6fc03722338bbc29fc27ee59ea39">clear_codeconv</a>(fptr);
<a name="l04279"></a>04279 
<a name="l04280"></a>04280     <span class="keywordflow">return</span> io;
<a name="l04281"></a>04281 }
<a name="l04282"></a>04282 
<a name="l04283"></a>04283 <span class="comment">/*</span>
<a name="l04284"></a>04284 <span class="comment"> *  call-seq:</span>
<a name="l04285"></a>04285 <span class="comment"> *     ios.binmode    -&gt; ios</span>
<a name="l04286"></a>04286 <span class="comment"> *</span>
<a name="l04287"></a>04287 <span class="comment"> *  Puts &lt;em&gt;ios&lt;/em&gt; into binary mode.</span>
<a name="l04288"></a>04288 <span class="comment"> *  Once a stream is in binary mode, it cannot be reset to nonbinary mode.</span>
<a name="l04289"></a>04289 <span class="comment"> *</span>
<a name="l04290"></a>04290 <span class="comment"> *  - newline conversion disabled</span>
<a name="l04291"></a>04291 <span class="comment"> *  - encoding conversion disabled</span>
<a name="l04292"></a>04292 <span class="comment"> *  - content is treated as ASCII-8BIT</span>
<a name="l04293"></a>04293 <span class="comment"> *</span>
<a name="l04294"></a>04294 <span class="comment"> */</span>
<a name="l04295"></a>04295 
<a name="l04296"></a>04296 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04297"></a><a class="code" href="../../df/d0a/io_8c.html#afb263b3801efd8532104ec93253ee380">04297</a> <a class="code" href="../../df/d0a/io_8c.html#afb263b3801efd8532104ec93253ee380">rb_io_binmode_m</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l04298"></a>04298 {
<a name="l04299"></a>04299     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write_io;
<a name="l04300"></a>04300 
<a name="l04301"></a>04301     <a class="code" href="../../db/d2e/intern_8h.html#a5e93bb5b5a12f3c6638b443f4e6746b3">rb_io_ascii8bit_binmode</a>(io);
<a name="l04302"></a>04302 
<a name="l04303"></a>04303     write_io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l04304"></a>04304     <span class="keywordflow">if</span> (write_io != io)
<a name="l04305"></a>04305         <a class="code" href="../../db/d2e/intern_8h.html#a5e93bb5b5a12f3c6638b443f4e6746b3">rb_io_ascii8bit_binmode</a>(write_io);
<a name="l04306"></a>04306     <span class="keywordflow">return</span> io;
<a name="l04307"></a>04307 }
<a name="l04308"></a>04308 
<a name="l04309"></a>04309 <span class="comment">/*</span>
<a name="l04310"></a>04310 <span class="comment"> *  call-seq:</span>
<a name="l04311"></a>04311 <span class="comment"> *     ios.binmode?    -&gt; true or false</span>
<a name="l04312"></a>04312 <span class="comment"> *</span>
<a name="l04313"></a>04313 <span class="comment"> *  Returns &lt;code&gt;true&lt;/code&gt; if &lt;em&gt;ios&lt;/em&gt; is binmode.</span>
<a name="l04314"></a>04314 <span class="comment"> */</span>
<a name="l04315"></a>04315 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04316"></a><a class="code" href="../../df/d0a/io_8c.html#a886960de6c88a81db8156c06e3dadb98">04316</a> <a class="code" href="../../df/d0a/io_8c.html#a886960de6c88a81db8156c06e3dadb98">rb_io_binmode_p</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l04317"></a>04317 {
<a name="l04318"></a>04318     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l04319"></a>04319     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l04320"></a>04320     <span class="keywordflow">return</span> fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a> ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l04321"></a>04321 }
<a name="l04322"></a>04322 
<a name="l04323"></a>04323 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>*
<a name="l04324"></a><a class="code" href="../../df/d0a/io_8c.html#af98084269e66d5b168e2e2b985209e00">04324</a> <a class="code" href="../../df/d0a/io_8c.html#af98084269e66d5b168e2e2b985209e00">rb_io_fmode_modestr</a>(<span class="keywordtype">int</span> fmode)
<a name="l04325"></a>04325 {
<a name="l04326"></a>04326     <span class="keywordflow">if</span> (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a7a29604a28e82f69d9325405514be4a7">FMODE_APPEND</a>) {
<a name="l04327"></a>04327         <span class="keywordflow">if</span> ((fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a289245342d513a229938e5f8700648b5">FMODE_READWRITE</a>) == FMODE_READWRITE) {
<a name="l04328"></a>04328             <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a5f4cda0ea1994c3ee917943870da504e">MODE_BTMODE</a>(<span class="stringliteral">&quot;a+&quot;</span>, <span class="stringliteral">&quot;ab+&quot;</span>, <span class="stringliteral">&quot;at+&quot;</span>);
<a name="l04329"></a>04329         }
<a name="l04330"></a>04330         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a5f4cda0ea1994c3ee917943870da504e">MODE_BTMODE</a>(<span class="stringliteral">&quot;a&quot;</span>, <span class="stringliteral">&quot;ab&quot;</span>, <span class="stringliteral">&quot;at&quot;</span>);
<a name="l04331"></a>04331     }
<a name="l04332"></a>04332     <span class="keywordflow">switch</span> (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a289245342d513a229938e5f8700648b5">FMODE_READWRITE</a>) {
<a name="l04333"></a>04333       <span class="keywordflow">case</span> <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>:
<a name="l04334"></a>04334         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a5f4cda0ea1994c3ee917943870da504e">MODE_BTMODE</a>(<span class="stringliteral">&quot;r&quot;</span>, <span class="stringliteral">&quot;rb&quot;</span>, <span class="stringliteral">&quot;rt&quot;</span>);
<a name="l04335"></a>04335       <span class="keywordflow">case</span> <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>:
<a name="l04336"></a>04336         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a5f4cda0ea1994c3ee917943870da504e">MODE_BTMODE</a>(<span class="stringliteral">&quot;w&quot;</span>, <span class="stringliteral">&quot;wb&quot;</span>, <span class="stringliteral">&quot;wt&quot;</span>);
<a name="l04337"></a>04337       <span class="keywordflow">case</span> FMODE_READWRITE:
<a name="l04338"></a>04338         <span class="keywordflow">if</span> (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a46de7b70411362002c8b92fb6a75382b">FMODE_CREATE</a>) {
<a name="l04339"></a>04339             <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a5f4cda0ea1994c3ee917943870da504e">MODE_BTMODE</a>(<span class="stringliteral">&quot;w+&quot;</span>, <span class="stringliteral">&quot;wb+&quot;</span>, <span class="stringliteral">&quot;wt+&quot;</span>);
<a name="l04340"></a>04340         }
<a name="l04341"></a>04341         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a5f4cda0ea1994c3ee917943870da504e">MODE_BTMODE</a>(<span class="stringliteral">&quot;r+&quot;</span>, <span class="stringliteral">&quot;rb+&quot;</span>, <span class="stringliteral">&quot;rt+&quot;</span>);
<a name="l04342"></a>04342     }
<a name="l04343"></a>04343     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;invalid access fmode 0x%x&quot;</span>, fmode);
<a name="l04344"></a>04344     <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;                <span class="comment">/* not reached */</span>
<a name="l04345"></a>04345 }
<a name="l04346"></a>04346 
<a name="l04347"></a>04347 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l04348"></a><a class="code" href="../../df/d0a/io_8c.html#a40d7bcc9f8fd7a8edb041e12359b5c28">04348</a> <a class="code" href="../../df/d0a/io_8c.html#a40d7bcc9f8fd7a8edb041e12359b5c28">io_encname_bom_p</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>)
<a name="l04349"></a>04349 {
<a name="l04350"></a>04350     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> bom_prefix[] = <span class="stringliteral">&quot;bom|utf-&quot;</span>;
<a name="l04351"></a>04351     <span class="keyword">enum</span> {bom_prefix_len = (int)<span class="keyword">sizeof</span>(bom_prefix) - 1};
<a name="l04352"></a>04352     <span class="keywordflow">if</span> (!len) {
<a name="l04353"></a>04353         <span class="keyword">const</span> <span class="keywordtype">char</span> *p = <a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(name, <span class="charliteral">&apos;:&apos;</span>);
<a name="l04354"></a>04354         len = p ? (<a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a>)(p - name) : (<a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a>)<a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(name);
<a name="l04355"></a>04355     }
<a name="l04356"></a>04356     <span class="keywordflow">return</span> len &gt; bom_prefix_len &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afcd8c37e32c2bfc294617c5553cd1e3b">STRNCASECMP</a>(name, bom_prefix, bom_prefix_len) == 0;
<a name="l04357"></a>04357 }
<a name="l04358"></a>04358 
<a name="l04359"></a>04359 <span class="keywordtype">int</span>
<a name="l04360"></a><a class="code" href="../../df/d0a/io_8c.html#a0c32c67101e6698b9b314041ac5025f4">04360</a> <a class="code" href="../../dc/dac/io_8h.html#a0c32c67101e6698b9b314041ac5025f4">rb_io_modestr_fmode</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *modestr)
<a name="l04361"></a>04361 {
<a name="l04362"></a>04362     <span class="keywordtype">int</span> <a class="code" href="../../df/d0a/io_8c.html#a8d9cc2340b814767e83294570cafa7fd">fmode</a> = 0;
<a name="l04363"></a>04363     <span class="keyword">const</span> <span class="keywordtype">char</span> *m = modestr, *p = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04364"></a>04364 
<a name="l04365"></a>04365     <span class="keywordflow">switch</span> (*m++) {
<a name="l04366"></a>04366       <span class="keywordflow">case</span> <span class="charliteral">&apos;r&apos;</span>:
<a name="l04367"></a>04367         fmode |= <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>;
<a name="l04368"></a>04368         <span class="keywordflow">break</span>;
<a name="l04369"></a>04369       <span class="keywordflow">case</span> <span class="charliteral">&apos;w&apos;</span>:
<a name="l04370"></a>04370         fmode |= <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a> | <a class="code" href="../../dc/dac/io_8h.html#aced46a99b499f14f97bfe994746238cf">FMODE_TRUNC</a> | <a class="code" href="../../dc/dac/io_8h.html#a46de7b70411362002c8b92fb6a75382b">FMODE_CREATE</a>;
<a name="l04371"></a>04371         <span class="keywordflow">break</span>;
<a name="l04372"></a>04372       <span class="keywordflow">case</span> <span class="charliteral">&apos;a&apos;</span>:
<a name="l04373"></a>04373         fmode |= <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a> | <a class="code" href="../../dc/dac/io_8h.html#a7a29604a28e82f69d9325405514be4a7">FMODE_APPEND</a> | <a class="code" href="../../dc/dac/io_8h.html#a46de7b70411362002c8b92fb6a75382b">FMODE_CREATE</a>;
<a name="l04374"></a>04374         <span class="keywordflow">break</span>;
<a name="l04375"></a>04375       <span class="keywordflow">default</span>:
<a name="l04376"></a>04376       error:
<a name="l04377"></a>04377         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;invalid access mode %s&quot;</span>, modestr);
<a name="l04378"></a>04378     }
<a name="l04379"></a>04379 
<a name="l04380"></a>04380     <span class="keywordflow">while</span> (*m) {
<a name="l04381"></a>04381         <span class="keywordflow">switch</span> (*m++) {
<a name="l04382"></a>04382           <span class="keywordflow">case</span> <span class="charliteral">&apos;b&apos;</span>:
<a name="l04383"></a>04383             fmode |= <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>;
<a name="l04384"></a>04384             <span class="keywordflow">break</span>;
<a name="l04385"></a>04385           <span class="keywordflow">case</span> <span class="charliteral">&apos;t&apos;</span>:
<a name="l04386"></a>04386             fmode |= <a class="code" href="../../dc/dac/io_8h.html#aaf5edfb63656cca0368d0de8324015c1">FMODE_TEXTMODE</a>;
<a name="l04387"></a>04387             <span class="keywordflow">break</span>;
<a name="l04388"></a>04388           <span class="keywordflow">case</span> <span class="charliteral">&apos;+&apos;</span>:
<a name="l04389"></a>04389             fmode |= <a class="code" href="../../dc/dac/io_8h.html#a289245342d513a229938e5f8700648b5">FMODE_READWRITE</a>;
<a name="l04390"></a>04390             <span class="keywordflow">break</span>;
<a name="l04391"></a>04391           <span class="keywordflow">default</span>:
<a name="l04392"></a>04392             <span class="keywordflow">goto</span> error;
<a name="l04393"></a>04393           <span class="keywordflow">case</span> <span class="charliteral">&apos;:&apos;</span>:
<a name="l04394"></a>04394             p = m;
<a name="l04395"></a>04395             <span class="keywordflow">goto</span> finished;
<a name="l04396"></a>04396         }
<a name="l04397"></a>04397     }
<a name="l04398"></a>04398 
<a name="l04399"></a>04399   finished:
<a name="l04400"></a>04400     <span class="keywordflow">if</span> ((fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>) &amp;&amp; (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#aaf5edfb63656cca0368d0de8324015c1">FMODE_TEXTMODE</a>))
<a name="l04401"></a>04401         <span class="keywordflow">goto</span> error;
<a name="l04402"></a>04402     <span class="keywordflow">if</span> (p &amp;&amp; <a class="code" href="../../df/d0a/io_8c.html#a40d7bcc9f8fd7a8edb041e12359b5c28">io_encname_bom_p</a>(p, 0))
<a name="l04403"></a>04403         fmode |= <a class="code" href="../../dc/dac/io_8h.html#a1887ab1ec5253a5f363e78092a55348c">FMODE_SETENC_BY_BOM</a>;
<a name="l04404"></a>04404 
<a name="l04405"></a>04405     <span class="keywordflow">return</span> fmode;
<a name="l04406"></a>04406 }
<a name="l04407"></a>04407 
<a name="l04408"></a>04408 <span class="keywordtype">int</span>
<a name="l04409"></a><a class="code" href="../../df/d0a/io_8c.html#a5c81f2aab2c1cf43fe65b926f8a5bd73">04409</a> <a class="code" href="../../dc/dac/io_8h.html#a5c81f2aab2c1cf43fe65b926f8a5bd73">rb_io_oflags_fmode</a>(<span class="keywordtype">int</span> oflags)
<a name="l04410"></a>04410 {
<a name="l04411"></a>04411     <span class="keywordtype">int</span> <a class="code" href="../../df/d0a/io_8c.html#a8d9cc2340b814767e83294570cafa7fd">fmode</a> = 0;
<a name="l04412"></a>04412 
<a name="l04413"></a>04413     <span class="keywordflow">switch</span> (oflags &amp; (O_RDONLY|O_WRONLY|O_RDWR)) {
<a name="l04414"></a>04414       <span class="keywordflow">case</span> O_RDONLY:
<a name="l04415"></a>04415         fmode = <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>;
<a name="l04416"></a>04416         <span class="keywordflow">break</span>;
<a name="l04417"></a>04417       <span class="keywordflow">case</span> O_WRONLY:
<a name="l04418"></a>04418         fmode = <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>;
<a name="l04419"></a>04419         <span class="keywordflow">break</span>;
<a name="l04420"></a>04420       <span class="keywordflow">case</span> O_RDWR:
<a name="l04421"></a>04421         fmode = <a class="code" href="../../dc/dac/io_8h.html#a289245342d513a229938e5f8700648b5">FMODE_READWRITE</a>;
<a name="l04422"></a>04422         <span class="keywordflow">break</span>;
<a name="l04423"></a>04423     }
<a name="l04424"></a>04424 
<a name="l04425"></a>04425     <span class="keywordflow">if</span> (oflags &amp; O_APPEND) {
<a name="l04426"></a>04426         fmode |= <a class="code" href="../../dc/dac/io_8h.html#a7a29604a28e82f69d9325405514be4a7">FMODE_APPEND</a>;
<a name="l04427"></a>04427     }
<a name="l04428"></a>04428     <span class="keywordflow">if</span> (oflags &amp; O_TRUNC) {
<a name="l04429"></a>04429         fmode |= <a class="code" href="../../dc/dac/io_8h.html#aced46a99b499f14f97bfe994746238cf">FMODE_TRUNC</a>;
<a name="l04430"></a>04430     }
<a name="l04431"></a>04431     <span class="keywordflow">if</span> (oflags &amp; O_CREAT) {
<a name="l04432"></a>04432         fmode |= <a class="code" href="../../dc/dac/io_8h.html#a46de7b70411362002c8b92fb6a75382b">FMODE_CREATE</a>;
<a name="l04433"></a>04433     }
<a name="l04434"></a>04434 <span class="preprocessor">#ifdef O_BINARY</span>
<a name="l04435"></a>04435 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (oflags &amp; <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>) {
<a name="l04436"></a>04436         fmode |= <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>;
<a name="l04437"></a>04437     }
<a name="l04438"></a>04438 <span class="preprocessor">#endif</span>
<a name="l04439"></a>04439 <span class="preprocessor"></span>
<a name="l04440"></a>04440     <span class="keywordflow">return</span> fmode;
<a name="l04441"></a>04441 }
<a name="l04442"></a>04442 
<a name="l04443"></a>04443 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l04444"></a><a class="code" href="../../df/d0a/io_8c.html#abe73106951f1bd614c978445ace2af9e">04444</a> <a class="code" href="../../df/d0a/io_8c.html#abe73106951f1bd614c978445ace2af9e">rb_io_fmode_oflags</a>(<span class="keywordtype">int</span> fmode)
<a name="l04445"></a>04445 {
<a name="l04446"></a>04446     <span class="keywordtype">int</span> oflags = 0;
<a name="l04447"></a>04447 
<a name="l04448"></a>04448     <span class="keywordflow">switch</span> (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a289245342d513a229938e5f8700648b5">FMODE_READWRITE</a>) {
<a name="l04449"></a>04449       <span class="keywordflow">case</span> <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>:
<a name="l04450"></a>04450         oflags |= O_RDONLY;
<a name="l04451"></a>04451         <span class="keywordflow">break</span>;
<a name="l04452"></a>04452       <span class="keywordflow">case</span> <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>:
<a name="l04453"></a>04453         oflags |= O_WRONLY;
<a name="l04454"></a>04454         <span class="keywordflow">break</span>;
<a name="l04455"></a>04455       <span class="keywordflow">case</span> FMODE_READWRITE:
<a name="l04456"></a>04456         oflags |= O_RDWR;
<a name="l04457"></a>04457         <span class="keywordflow">break</span>;
<a name="l04458"></a>04458     }
<a name="l04459"></a>04459 
<a name="l04460"></a>04460     <span class="keywordflow">if</span> (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a7a29604a28e82f69d9325405514be4a7">FMODE_APPEND</a>) {
<a name="l04461"></a>04461         oflags |= O_APPEND;
<a name="l04462"></a>04462     }
<a name="l04463"></a>04463     <span class="keywordflow">if</span> (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#aced46a99b499f14f97bfe994746238cf">FMODE_TRUNC</a>) {
<a name="l04464"></a>04464         oflags |= O_TRUNC;
<a name="l04465"></a>04465     }
<a name="l04466"></a>04466     <span class="keywordflow">if</span> (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a46de7b70411362002c8b92fb6a75382b">FMODE_CREATE</a>) {
<a name="l04467"></a>04467         oflags |= O_CREAT;
<a name="l04468"></a>04468     }
<a name="l04469"></a>04469 <span class="preprocessor">#ifdef O_BINARY</span>
<a name="l04470"></a>04470 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>) {
<a name="l04471"></a>04471         oflags |= <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>;
<a name="l04472"></a>04472     }
<a name="l04473"></a>04473 <span class="preprocessor">#endif</span>
<a name="l04474"></a>04474 <span class="preprocessor"></span>
<a name="l04475"></a>04475     <span class="keywordflow">return</span> oflags;
<a name="l04476"></a>04476 }
<a name="l04477"></a>04477 
<a name="l04478"></a>04478 <span class="keywordtype">int</span>
<a name="l04479"></a><a class="code" href="../../df/d0a/io_8c.html#a18815b569044e1ffbe48c093ed7efd1f">04479</a> <a class="code" href="../../dc/dac/io_8h.html#a18815b569044e1ffbe48c093ed7efd1f">rb_io_modestr_oflags</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *modestr)
<a name="l04480"></a>04480 {
<a name="l04481"></a>04481     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#abe73106951f1bd614c978445ace2af9e">rb_io_fmode_oflags</a>(<a class="code" href="../../dc/dac/io_8h.html#a0c32c67101e6698b9b314041ac5025f4">rb_io_modestr_fmode</a>(modestr));
<a name="l04482"></a>04482 }
<a name="l04483"></a>04483 
<a name="l04484"></a>04484 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>*
<a name="l04485"></a><a class="code" href="../../df/d0a/io_8c.html#a36c0d38dddc4c2872ea006caf5c59471">04485</a> <a class="code" href="../../df/d0a/io_8c.html#a36c0d38dddc4c2872ea006caf5c59471">rb_io_oflags_modestr</a>(<span class="keywordtype">int</span> oflags)
<a name="l04486"></a>04486 {
<a name="l04487"></a>04487 <span class="preprocessor">#ifdef O_BINARY</span>
<a name="l04488"></a>04488 <span class="preprocessor"></span><span class="preprocessor"># define MODE_BINARY(a,b) ((oflags &amp; O_BINARY) ? (b) : (a))</span>
<a name="l04489"></a>04489 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l04490"></a>04490 <span class="preprocessor"></span><span class="preprocessor"># define MODE_BINARY(a,b) (a)</span>
<a name="l04491"></a>04491 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l04492"></a>04492 <span class="preprocessor"></span>    <span class="keywordtype">int</span> accmode = oflags &amp; (O_RDONLY|O_WRONLY|O_RDWR);
<a name="l04493"></a>04493     <span class="keywordflow">if</span> (oflags &amp; O_APPEND) {
<a name="l04494"></a>04494         <span class="keywordflow">if</span> (accmode == O_WRONLY) {
<a name="l04495"></a>04495             <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#ac8a6eb284e9a04c69bcd5f1f3bfd7507">MODE_BINARY</a>(<span class="stringliteral">&quot;a&quot;</span>, <span class="stringliteral">&quot;ab&quot;</span>);
<a name="l04496"></a>04496         }
<a name="l04497"></a>04497         <span class="keywordflow">if</span> (accmode == O_RDWR) {
<a name="l04498"></a>04498             <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#ac8a6eb284e9a04c69bcd5f1f3bfd7507">MODE_BINARY</a>(<span class="stringliteral">&quot;a+&quot;</span>, <span class="stringliteral">&quot;ab+&quot;</span>);
<a name="l04499"></a>04499         }
<a name="l04500"></a>04500     }
<a name="l04501"></a>04501     <span class="keywordflow">switch</span> (oflags &amp; (O_RDONLY|O_WRONLY|O_RDWR)) {
<a name="l04502"></a>04502       <span class="keywordflow">case</span> O_RDONLY:
<a name="l04503"></a>04503         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#ac8a6eb284e9a04c69bcd5f1f3bfd7507">MODE_BINARY</a>(<span class="stringliteral">&quot;r&quot;</span>, <span class="stringliteral">&quot;rb&quot;</span>);
<a name="l04504"></a>04504       <span class="keywordflow">case</span> O_WRONLY:
<a name="l04505"></a>04505         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#ac8a6eb284e9a04c69bcd5f1f3bfd7507">MODE_BINARY</a>(<span class="stringliteral">&quot;w&quot;</span>, <span class="stringliteral">&quot;wb&quot;</span>);
<a name="l04506"></a>04506       <span class="keywordflow">case</span> O_RDWR:
<a name="l04507"></a>04507         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#ac8a6eb284e9a04c69bcd5f1f3bfd7507">MODE_BINARY</a>(<span class="stringliteral">&quot;r+&quot;</span>, <span class="stringliteral">&quot;rb+&quot;</span>);
<a name="l04508"></a>04508     }
<a name="l04509"></a>04509     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;invalid access oflags 0x%x&quot;</span>, oflags);
<a name="l04510"></a>04510     <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;                <span class="comment">/* not reached */</span>
<a name="l04511"></a>04511 }
<a name="l04512"></a>04512 
<a name="l04513"></a>04513 <span class="comment">/*</span>
<a name="l04514"></a>04514 <span class="comment"> * Convert external/internal encodings to enc/enc2</span>
<a name="l04515"></a>04515 <span class="comment"> * NULL =&gt; use default encoding</span>
<a name="l04516"></a>04516 <span class="comment"> * Qnil =&gt; no encoding specified (internal only)</span>
<a name="l04517"></a>04517 <span class="comment"> */</span>
<a name="l04518"></a>04518 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l04519"></a><a class="code" href="../../df/d0a/io_8c.html#a8dcac7969c25237c0f4620b5e074727a">04519</a> <a class="code" href="../../df/d0a/io_8c.html#a8dcac7969c25237c0f4620b5e074727a">rb_io_ext_int_to_encs</a>(<a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *ext, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *intern, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> **enc, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> **enc2)
<a name="l04520"></a>04520 {
<a name="l04521"></a>04521     <span class="keywordtype">int</span> default_ext = 0;
<a name="l04522"></a>04522 
<a name="l04523"></a>04523     <span class="keywordflow">if</span> (ext == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l04524"></a>04524         ext = <a class="code" href="../../d5/db5/encoding_8c.html#a0724183879562529f7d3365ef5115b6d">rb_default_external_encoding</a>();
<a name="l04525"></a>04525         default_ext = 1;
<a name="l04526"></a>04526     }
<a name="l04527"></a>04527     <span class="keywordflow">if</span> (intern == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> &amp;&amp; ext != <a class="code" href="../../d5/db5/encoding_8c.html#a767d777810f0d48add93857b52057262">rb_ascii8bit_encoding</a>())
<a name="l04528"></a>04528         <span class="comment">/* If external is ASCII-8BIT, no default transcoding */</span>
<a name="l04529"></a>04529         intern = <a class="code" href="../../d5/db5/encoding_8c.html#a62b808940b1049f1af6233cbbb828bd6">rb_default_internal_encoding</a>();
<a name="l04530"></a>04530     <span class="keywordflow">if</span> (intern == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> || intern == (<a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a> || intern == ext) {
<a name="l04531"></a>04531         <span class="comment">/* No internal encoding =&gt; use external + no transcoding */</span>
<a name="l04532"></a>04532         *enc = (default_ext &amp;&amp; intern != ext) ? <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a> : ext;
<a name="l04533"></a>04533         *enc2 = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04534"></a>04534     }
<a name="l04535"></a>04535     <span class="keywordflow">else</span> {
<a name="l04536"></a>04536         *enc = intern;
<a name="l04537"></a>04537         *enc2 = ext;
<a name="l04538"></a>04538     }
<a name="l04539"></a>04539 }
<a name="l04540"></a>04540 
<a name="l04541"></a>04541 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l04542"></a><a class="code" href="../../df/d0a/io_8c.html#a83cf2bfe6afeb749627027cf09e6c7d4">04542</a> <a class="code" href="../../df/d0a/io_8c.html#a83cf2bfe6afeb749627027cf09e6c7d4">parse_mode_enc</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *estr, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> **enc_p, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> **enc2_p, <span class="keywordtype">int</span> *fmode_p)
<a name="l04543"></a>04543 {
<a name="l04544"></a>04544     <span class="keyword">const</span> <span class="keywordtype">char</span> *p;
<a name="l04545"></a>04545     <span class="keywordtype">char</span> encname[<a class="code" href="../../d5/de3/encoding_8h.html#a67fee731e27c8636f140043b5ed19403">ENCODING_MAXNAMELEN</a>+1];
<a name="l04546"></a>04546     <span class="keywordtype">int</span> idx, idx2;
<a name="l04547"></a>04547     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *ext_enc, *int_enc;
<a name="l04548"></a>04548 
<a name="l04549"></a>04549     <span class="comment">/* parse estr as &quot;enc&quot; or &quot;enc2:enc&quot; or &quot;enc:-&quot; */</span>
<a name="l04550"></a>04550 
<a name="l04551"></a>04551     p = <a class="code" href="../../dd/dd0/eval__intern_8h.html#abe95d128538ae3fa3d09adfc0ef1b206">strrchr</a>(estr, <span class="charliteral">&apos;:&apos;</span>);
<a name="l04552"></a>04552     <span class="keywordflow">if</span> (p) {
<a name="l04553"></a>04553         <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = (p++) - estr;
<a name="l04554"></a>04554         <span class="keywordflow">if</span> (len == 0 || len &gt; <a class="code" href="../../d5/de3/encoding_8h.html#a67fee731e27c8636f140043b5ed19403">ENCODING_MAXNAMELEN</a>)
<a name="l04555"></a>04555             idx = -1;
<a name="l04556"></a>04556         <span class="keywordflow">else</span> {
<a name="l04557"></a>04557             <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a40d7bcc9f8fd7a8edb041e12359b5c28">io_encname_bom_p</a>(estr, len)) {
<a name="l04558"></a>04558                 <span class="keywordflow">if</span> (fmode_p) *fmode_p |= <a class="code" href="../../dc/dac/io_8h.html#a1887ab1ec5253a5f363e78092a55348c">FMODE_SETENC_BY_BOM</a>;
<a name="l04559"></a>04559                 estr += 4;
<a name="l04560"></a>04560                 len -= 4;
<a name="l04561"></a>04561             }
<a name="l04562"></a>04562             memcpy(encname, estr, len);
<a name="l04563"></a>04563             encname[len] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04564"></a>04564             estr = encname;
<a name="l04565"></a>04565             idx = <a class="code" href="../../d5/db5/encoding_8c.html#adeb5f5b97ea43528a55d717add8f64c5">rb_enc_find_index</a>(encname);
<a name="l04566"></a>04566         }
<a name="l04567"></a>04567     }
<a name="l04568"></a>04568     <span class="keywordflow">else</span> {
<a name="l04569"></a>04569         <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(estr);
<a name="l04570"></a>04570         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a40d7bcc9f8fd7a8edb041e12359b5c28">io_encname_bom_p</a>(estr, len)) {
<a name="l04571"></a>04571             <span class="keywordflow">if</span> (fmode_p) *fmode_p |= <a class="code" href="../../dc/dac/io_8h.html#a1887ab1ec5253a5f363e78092a55348c">FMODE_SETENC_BY_BOM</a>;
<a name="l04572"></a>04572             estr += 4;
<a name="l04573"></a>04573             len -= 4;
<a name="l04574"></a>04574             memcpy(encname, estr, len);
<a name="l04575"></a>04575             encname[len] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04576"></a>04576             estr = encname;
<a name="l04577"></a>04577         }
<a name="l04578"></a>04578         idx = <a class="code" href="../../d5/db5/encoding_8c.html#adeb5f5b97ea43528a55d717add8f64c5">rb_enc_find_index</a>(estr);
<a name="l04579"></a>04579     }
<a name="l04580"></a>04580 
<a name="l04581"></a>04581     <span class="keywordflow">if</span> (idx &gt;= 0)
<a name="l04582"></a>04582         ext_enc = <a class="code" href="../../d5/db5/encoding_8c.html#aef9c377b2d9d78b9f88e890b77593109">rb_enc_from_index</a>(idx);
<a name="l04583"></a>04583     <span class="keywordflow">else</span> {
<a name="l04584"></a>04584         <span class="keywordflow">if</span> (idx != -2)
<a name="l04585"></a>04585             <a class="code" href="../../db/dcc/error_8c.html#aa5b1972d475e9a090c8ef607ce033008">rb_warn</a>(<span class="stringliteral">&quot;Unsupported encoding %s ignored&quot;</span>, estr);
<a name="l04586"></a>04586         ext_enc = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04587"></a>04587     }
<a name="l04588"></a>04588 
<a name="l04589"></a>04589     int_enc = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04590"></a>04590     <span class="keywordflow">if</span> (p) {
<a name="l04591"></a>04591         <span class="keywordflow">if</span> (*p == <span class="charliteral">&apos;-&apos;</span> &amp;&amp; *(p+1) == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l04592"></a>04592             <span class="comment">/* Special case - &quot;-&quot; =&gt; no transcoding */</span>
<a name="l04593"></a>04593             int_enc = (<a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l04594"></a>04594         }
<a name="l04595"></a>04595         <span class="keywordflow">else</span> {
<a name="l04596"></a>04596             idx2 = <a class="code" href="../../d5/db5/encoding_8c.html#adeb5f5b97ea43528a55d717add8f64c5">rb_enc_find_index</a>(p);
<a name="l04597"></a>04597             <span class="keywordflow">if</span> (idx2 &lt; 0)
<a name="l04598"></a>04598                 <a class="code" href="../../db/dcc/error_8c.html#aa5b1972d475e9a090c8ef607ce033008">rb_warn</a>(<span class="stringliteral">&quot;Unsupported encoding %s ignored&quot;</span>, p);
<a name="l04599"></a>04599             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (idx2 == idx) {
<a name="l04600"></a>04600                 <a class="code" href="../../db/dcc/error_8c.html#aa5b1972d475e9a090c8ef607ce033008">rb_warn</a>(<span class="stringliteral">&quot;Ignoring internal encoding %s: it is identical to external encoding %s&quot;</span>, p, estr);
<a name="l04601"></a>04601                 int_enc = (<a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l04602"></a>04602             }
<a name="l04603"></a>04603             <span class="keywordflow">else</span>
<a name="l04604"></a>04604                 int_enc = <a class="code" href="../../d5/db5/encoding_8c.html#aef9c377b2d9d78b9f88e890b77593109">rb_enc_from_index</a>(idx2);
<a name="l04605"></a>04605         }
<a name="l04606"></a>04606     }
<a name="l04607"></a>04607 
<a name="l04608"></a>04608     <a class="code" href="../../df/d0a/io_8c.html#a8dcac7969c25237c0f4620b5e074727a">rb_io_ext_int_to_encs</a>(ext_enc, int_enc, enc_p, enc2_p);
<a name="l04609"></a>04609 }
<a name="l04610"></a>04610 
<a name="l04611"></a>04611 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l04612"></a><a class="code" href="../../df/d0a/io_8c.html#a6446f34724f71fe406d25508e49a2bd6">04612</a> <a class="code" href="../../df/d0a/io_8c.html#a6446f34724f71fe406d25508e49a2bd6">mode_enc</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <span class="keyword">const</span> <span class="keywordtype">char</span> *estr)
<a name="l04613"></a>04613 {
<a name="l04614"></a>04614     <a class="code" href="../../df/d0a/io_8c.html#a6a7e6fc03722338bbc29fc27ee59ea39">clear_codeconv</a>(fptr);
<a name="l04615"></a>04615 
<a name="l04616"></a>04616     <a class="code" href="../../df/d0a/io_8c.html#a83cf2bfe6afeb749627027cf09e6c7d4">parse_mode_enc</a>(estr, &amp;fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc, &amp;fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc2, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l04617"></a>04617 }
<a name="l04618"></a>04618 
<a name="l04619"></a>04619 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l04620"></a><a class="code" href="../../df/d0a/io_8c.html#a96729c493ef5726a2c38c94dc096a76e">04620</a> <a class="code" href="../../df/d0a/io_8c.html#a96729c493ef5726a2c38c94dc096a76e">rb_io_mode_enc</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <span class="keyword">const</span> <span class="keywordtype">char</span> *modestr)
<a name="l04621"></a>04621 {
<a name="l04622"></a>04622     <span class="keyword">const</span> <span class="keywordtype">char</span> *p = <a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(modestr, <span class="charliteral">&apos;:&apos;</span>);
<a name="l04623"></a>04623     <span class="keywordflow">if</span> (p) {
<a name="l04624"></a>04624         <a class="code" href="../../df/d0a/io_8c.html#a6446f34724f71fe406d25508e49a2bd6">mode_enc</a>(fptr, p+1);
<a name="l04625"></a>04625     }
<a name="l04626"></a>04626 }
<a name="l04627"></a>04627 
<a name="l04628"></a>04628 <span class="keywordtype">int</span>
<a name="l04629"></a><a class="code" href="../../df/d0a/io_8c.html#a51c36b8e9d3a677016832864186cc72d">04629</a> <a class="code" href="../../dc/dac/io_8h.html#a51c36b8e9d3a677016832864186cc72d">rb_io_extract_encoding_option</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opt, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> **enc_p, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> **enc2_p, <span class="keywordtype">int</span> *fmode_p)
<a name="l04630"></a>04630 {
<a name="l04631"></a>04631     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> encoding=<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>, extenc=<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a>, intenc=<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a>, tmp;
<a name="l04632"></a>04632     <span class="keywordtype">int</span> extracted = 0;
<a name="l04633"></a>04633     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *extencoding = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04634"></a>04634     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *intencoding = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04635"></a>04635 
<a name="l04636"></a>04636     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(opt)) {
<a name="l04637"></a>04637         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v;
<a name="l04638"></a>04638         v = <a class="code" href="../../d1/d04/hash_8c.html#a2c487a168f8d6238fb47a4e5f20ef4d2">rb_hash_lookup2</a>(opt, <a class="code" href="../../df/d0a/io_8c.html#acbc60bfefe79b70198c8b537ba5ffefb">sym_encoding</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l04639"></a>04639         <span class="keywordflow">if</span> (v != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>) encoding = v;
<a name="l04640"></a>04640         v = <a class="code" href="../../d1/d04/hash_8c.html#a2c487a168f8d6238fb47a4e5f20ef4d2">rb_hash_lookup2</a>(opt, <a class="code" href="../../df/d0a/io_8c.html#a2bea26a74e408e997bfd7fc4d5af334e">sym_extenc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a>);
<a name="l04641"></a>04641         <span class="keywordflow">if</span> (v != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>) extenc = v;
<a name="l04642"></a>04642         v = <a class="code" href="../../d1/d04/hash_8c.html#a2c487a168f8d6238fb47a4e5f20ef4d2">rb_hash_lookup2</a>(opt, <a class="code" href="../../df/d0a/io_8c.html#a5ae55baafa10e068146f943efaccd871">sym_intenc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a>);
<a name="l04643"></a>04643         <span class="keywordflow">if</span> (v != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a>) intenc = v;
<a name="l04644"></a>04644     }
<a name="l04645"></a>04645     <span class="keywordflow">if</span> ((extenc != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a> || intenc != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a>) &amp;&amp; !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(encoding)) {
<a name="l04646"></a>04646         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a56087d5316e4c73027105c023006cb15">ruby_verbose</a>)) {
<a name="l04647"></a>04647             <span class="keywordtype">int</span> idx = <a class="code" href="../../d5/db5/encoding_8c.html#a13a97a6605eca1509135ff473bf346b6">rb_to_encoding_index</a>(encoding);
<a name="l04648"></a>04648             <a class="code" href="../../db/dcc/error_8c.html#aa5b1972d475e9a090c8ef607ce033008">rb_warn</a>(<span class="stringliteral">&quot;Ignoring encoding parameter &apos;%s&apos;: %s_encoding is used&quot;</span>,
<a name="l04649"></a>04649                     idx &lt; 0 ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(encoding) : <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(<a class="code" href="../../d5/db5/encoding_8c.html#aef9c377b2d9d78b9f88e890b77593109">rb_enc_from_index</a>(idx)),
<a name="l04650"></a>04650                     extenc == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a> ? <span class="stringliteral">&quot;internal&quot;</span> : <span class="stringliteral">&quot;external&quot;</span>);
<a name="l04651"></a>04651         }
<a name="l04652"></a>04652         encoding = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l04653"></a>04653     }
<a name="l04654"></a>04654     <span class="keywordflow">if</span> (extenc != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a> &amp;&amp; !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(extenc)) {
<a name="l04655"></a>04655         extencoding = <a class="code" href="../../d5/db5/encoding_8c.html#a73a17b842b857bdaf2062107fe898304">rb_to_encoding</a>(extenc);
<a name="l04656"></a>04656     }
<a name="l04657"></a>04657     <span class="keywordflow">if</span> (intenc != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a>) {
<a name="l04658"></a>04658         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(intenc)) {
<a name="l04659"></a>04659             <span class="comment">/* internal_encoding: nil =&gt; no transcoding */</span>
<a name="l04660"></a>04660             intencoding = (<a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l04661"></a>04661         }
<a name="l04662"></a>04662         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(tmp = <a class="code" href="../../db/d2e/intern_8h.html#a669b6063704b2d304844bd1553217cf0">rb_check_string_type</a>(intenc))) {
<a name="l04663"></a>04663             <span class="keywordtype">char</span> *p = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(tmp);
<a name="l04664"></a>04664 
<a name="l04665"></a>04665             <span class="keywordflow">if</span> (*p == <span class="charliteral">&apos;-&apos;</span> &amp;&amp; *(p+1) == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l04666"></a>04666                 <span class="comment">/* Special case - &quot;-&quot; =&gt; no transcoding */</span>
<a name="l04667"></a>04667                 intencoding = (<a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l04668"></a>04668             }
<a name="l04669"></a>04669             <span class="keywordflow">else</span> {
<a name="l04670"></a>04670                 intencoding = <a class="code" href="../../d5/db5/encoding_8c.html#a73a17b842b857bdaf2062107fe898304">rb_to_encoding</a>(intenc);
<a name="l04671"></a>04671             }
<a name="l04672"></a>04672         }
<a name="l04673"></a>04673         <span class="keywordflow">else</span> {
<a name="l04674"></a>04674             intencoding = <a class="code" href="../../d5/db5/encoding_8c.html#a73a17b842b857bdaf2062107fe898304">rb_to_encoding</a>(intenc);
<a name="l04675"></a>04675         }
<a name="l04676"></a>04676         <span class="keywordflow">if</span> (extencoding == intencoding) {
<a name="l04677"></a>04677             intencoding = (<a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l04678"></a>04678         }
<a name="l04679"></a>04679     }
<a name="l04680"></a>04680     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(encoding)) {
<a name="l04681"></a>04681         extracted = 1;
<a name="l04682"></a>04682         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(tmp = <a class="code" href="../../db/d2e/intern_8h.html#a669b6063704b2d304844bd1553217cf0">rb_check_string_type</a>(encoding))) {
<a name="l04683"></a>04683             <a class="code" href="../../df/d0a/io_8c.html#a83cf2bfe6afeb749627027cf09e6c7d4">parse_mode_enc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(tmp), enc_p, enc2_p, fmode_p);
<a name="l04684"></a>04684         }
<a name="l04685"></a>04685         <span class="keywordflow">else</span> {
<a name="l04686"></a>04686             <a class="code" href="../../df/d0a/io_8c.html#a8dcac7969c25237c0f4620b5e074727a">rb_io_ext_int_to_encs</a>(<a class="code" href="../../d5/db5/encoding_8c.html#a73a17b842b857bdaf2062107fe898304">rb_to_encoding</a>(encoding), <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, enc_p, enc2_p);
<a name="l04687"></a>04687         }
<a name="l04688"></a>04688     }
<a name="l04689"></a>04689     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (extenc != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a> || intenc != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a>) {
<a name="l04690"></a>04690         extracted = 1;
<a name="l04691"></a>04691         <a class="code" href="../../df/d0a/io_8c.html#a8dcac7969c25237c0f4620b5e074727a">rb_io_ext_int_to_encs</a>(extencoding, intencoding, enc_p, enc2_p);
<a name="l04692"></a>04692     }
<a name="l04693"></a>04693     <span class="keywordflow">return</span> extracted;
<a name="l04694"></a>04694 }
<a name="l04695"></a>04695 
<a name="l04696"></a><a class="code" href="../../df/d0a/io_8c.html#a8a7a37633499f91b42907cfd1ecea043">04696</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>rb_io_enc_t <a class="code" href="../../df/d0a/io_8c.html#a8a7a37633499f91b42907cfd1ecea043">convconfig_t</a>;
<a name="l04697"></a>04697 
<a name="l04698"></a>04698 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l04699"></a><a class="code" href="../../df/d0a/io_8c.html#aa9b7bb2abeafdd599f98d4b7db988f1b">04699</a> <a class="code" href="../../df/d0a/io_8c.html#aa9b7bb2abeafdd599f98d4b7db988f1b">validate_enc_binmode</a>(<span class="keywordtype">int</span> *fmode_p, <span class="keywordtype">int</span> ecflags, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc2)
<a name="l04700"></a>04700 {
<a name="l04701"></a>04701     <span class="keywordtype">int</span> <a class="code" href="../../df/d0a/io_8c.html#a8d9cc2340b814767e83294570cafa7fd">fmode</a> = *fmode_p;
<a name="l04702"></a>04702 
<a name="l04703"></a>04703     <span class="keywordflow">if</span> ((fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>) &amp;&amp;
<a name="l04704"></a>04704         !enc2 &amp;&amp;
<a name="l04705"></a>04705         !(fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>) &amp;&amp;
<a name="l04706"></a>04706         !<a class="code" href="../../d5/de3/encoding_8h.html#a8b18a09a3055d3006c6d5baeaa6e7c72">rb_enc_asciicompat</a>(enc ? enc : <a class="code" href="../../d5/db5/encoding_8c.html#a0724183879562529f7d3365ef5115b6d">rb_default_external_encoding</a>()))
<a name="l04707"></a>04707         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;ASCII incompatible encoding needs binmode&quot;</span>);
<a name="l04708"></a>04708 
<a name="l04709"></a>04709     <span class="keywordflow">if</span> (!(fmode &amp; FMODE_BINMODE) &amp;&amp;
<a name="l04710"></a>04710         (<a class="code" href="../../df/d0a/io_8c.html#ab2c655110073a066c789b7e92cf7377c">DEFAULT_TEXTMODE</a> || (ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#aea188e77ea841e2c7741a9ef8c4c33a5">ECONV_NEWLINE_DECORATOR_MASK</a>))) {
<a name="l04711"></a>04711         fmode |= <a class="code" href="../../df/d0a/io_8c.html#ab2c655110073a066c789b7e92cf7377c">DEFAULT_TEXTMODE</a>;
<a name="l04712"></a>04712         *fmode_p = fmode;
<a name="l04713"></a>04713     }
<a name="l04714"></a>04714 <span class="preprocessor">#if !DEFAULT_TEXTMODE</span>
<a name="l04715"></a>04715 <span class="preprocessor"></span>    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(ecflags &amp; ECONV_NEWLINE_DECORATOR_MASK)) {
<a name="l04716"></a>04716         fmode &amp;= ~<a class="code" href="../../dc/dac/io_8h.html#aaf5edfb63656cca0368d0de8324015c1">FMODE_TEXTMODE</a>;
<a name="l04717"></a>04717         *fmode_p = fmode;
<a name="l04718"></a>04718     }
<a name="l04719"></a>04719 <span class="preprocessor">#endif</span>
<a name="l04720"></a>04720 <span class="preprocessor"></span>}
<a name="l04721"></a>04721 
<a name="l04722"></a>04722 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l04723"></a><a class="code" href="../../df/d0a/io_8c.html#a0f1670258d74dfbb4562e6ab4e6e7118">04723</a> <a class="code" href="../../df/d0a/io_8c.html#a0f1670258d74dfbb4562e6ab4e6e7118">extract_binmode</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opthash, <span class="keywordtype">int</span> *fmode)
<a name="l04724"></a>04724 {
<a name="l04725"></a>04725     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(opthash)) {
<a name="l04726"></a>04726         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v;
<a name="l04727"></a>04727         v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opthash, <a class="code" href="../../df/d0a/io_8c.html#a059a73cfb0046b6b226bd2ecffc7b20c">sym_textmode</a>);
<a name="l04728"></a>04728         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v) &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(v))
<a name="l04729"></a>04729             *fmode |= <a class="code" href="../../dc/dac/io_8h.html#aaf5edfb63656cca0368d0de8324015c1">FMODE_TEXTMODE</a>;
<a name="l04730"></a>04730         v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opthash, <a class="code" href="../../df/d0a/io_8c.html#a3dd84f3dee23c52a99275e865290c722">sym_binmode</a>);
<a name="l04731"></a>04731         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v) &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(v))
<a name="l04732"></a>04732             *fmode |= <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>;
<a name="l04733"></a>04733 
<a name="l04734"></a>04734         <span class="keywordflow">if</span> ((*fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>) &amp;&amp; (*fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#aaf5edfb63656cca0368d0de8324015c1">FMODE_TEXTMODE</a>))
<a name="l04735"></a>04735             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;both textmode and binmode specified&quot;</span>);
<a name="l04736"></a>04736     }
<a name="l04737"></a>04737 }
<a name="l04738"></a>04738 
<a name="l04739"></a>04739 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l04740"></a><a class="code" href="../../df/d0a/io_8c.html#a13ec2b7ce2ee691474894144cde6c82e">04740</a> <a class="code" href="../../df/d0a/io_8c.html#a13ec2b7ce2ee691474894144cde6c82e">rb_io_extract_modeenc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *vmode_p, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *vperm_p, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opthash,
<a name="l04741"></a>04741         <span class="keywordtype">int</span> *oflags_p, <span class="keywordtype">int</span> *fmode_p, <a class="code" href="../../df/d0a/io_8c.html#a8a7a37633499f91b42907cfd1ecea043">convconfig_t</a> *convconfig_p)
<a name="l04742"></a>04742 {
<a name="l04743"></a>04743     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> vmode;
<a name="l04744"></a>04744     <span class="keywordtype">int</span> oflags, <a class="code" href="../../df/d0a/io_8c.html#a8d9cc2340b814767e83294570cafa7fd">fmode</a>;
<a name="l04745"></a>04745     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc, *enc2;
<a name="l04746"></a>04746     <span class="keywordtype">int</span> ecflags;
<a name="l04747"></a>04747     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ecopts;
<a name="l04748"></a>04748     <span class="keywordtype">int</span> has_enc = 0, has_vmode = 0;
<a name="l04749"></a>04749     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> intmode;
<a name="l04750"></a>04750 
<a name="l04751"></a>04751     vmode = *vmode_p;
<a name="l04752"></a>04752 
<a name="l04753"></a>04753     <span class="comment">/* Set to defaults */</span>
<a name="l04754"></a>04754     <a class="code" href="../../df/d0a/io_8c.html#a8dcac7969c25237c0f4620b5e074727a">rb_io_ext_int_to_encs</a>(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;enc, &amp;enc2);
<a name="l04755"></a>04755 
<a name="l04756"></a>04756   vmode_handle:
<a name="l04757"></a>04757     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(vmode)) {
<a name="l04758"></a>04758         fmode = <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>;
<a name="l04759"></a>04759         oflags = O_RDONLY;
<a name="l04760"></a>04760     }
<a name="l04761"></a>04761     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(intmode = <a class="code" href="../../db/d2e/intern_8h.html#aa6019bc11856926dd4b9c7adade93d8f">rb_check_to_integer</a>(vmode, <span class="stringliteral">&quot;to_int&quot;</span>))) {
<a name="l04762"></a>04762         vmode = intmode;
<a name="l04763"></a>04763         oflags = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(intmode);
<a name="l04764"></a>04764         fmode = <a class="code" href="../../dc/dac/io_8h.html#a5c81f2aab2c1cf43fe65b926f8a5bd73">rb_io_oflags_fmode</a>(oflags);
<a name="l04765"></a>04765     }
<a name="l04766"></a>04766     <span class="keywordflow">else</span> {
<a name="l04767"></a>04767         <span class="keyword">const</span> <span class="keywordtype">char</span> *p;
<a name="l04768"></a>04768 
<a name="l04769"></a>04769         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0381640e2905c1b3e104194f91697ca4">SafeStringValue</a>(vmode);
<a name="l04770"></a>04770         p = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(vmode);
<a name="l04771"></a>04771         fmode = <a class="code" href="../../dc/dac/io_8h.html#a0c32c67101e6698b9b314041ac5025f4">rb_io_modestr_fmode</a>(p);
<a name="l04772"></a>04772         oflags = <a class="code" href="../../df/d0a/io_8c.html#abe73106951f1bd614c978445ace2af9e">rb_io_fmode_oflags</a>(fmode);
<a name="l04773"></a>04773         p = <a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(p, <span class="charliteral">&apos;:&apos;</span>);
<a name="l04774"></a>04774         <span class="keywordflow">if</span> (p) {
<a name="l04775"></a>04775             has_enc = 1;
<a name="l04776"></a>04776             <a class="code" href="../../df/d0a/io_8c.html#a83cf2bfe6afeb749627027cf09e6c7d4">parse_mode_enc</a>(p+1, &amp;enc, &amp;enc2, &amp;fmode);
<a name="l04777"></a>04777         }
<a name="l04778"></a>04778         <span class="keywordflow">else</span> {
<a name="l04779"></a>04779             <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *e;
<a name="l04780"></a>04780 
<a name="l04781"></a>04781             e = (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>) ? <a class="code" href="../../d5/db5/encoding_8c.html#a767d777810f0d48add93857b52057262">rb_ascii8bit_encoding</a>() : <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l04782"></a>04782             <a class="code" href="../../df/d0a/io_8c.html#a8dcac7969c25237c0f4620b5e074727a">rb_io_ext_int_to_encs</a>(e, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;enc, &amp;enc2);
<a name="l04783"></a>04783         }
<a name="l04784"></a>04784     }
<a name="l04785"></a>04785 
<a name="l04786"></a>04786     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(opthash)) {
<a name="l04787"></a>04787         ecflags = (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>) ?
<a name="l04788"></a>04788             <a class="code" href="../../df/d0a/io_8c.html#a5f4cda0ea1994c3ee917943870da504e">MODE_BTMODE</a>(<a class="code" href="../../d5/de3/encoding_8h.html#afae8969f13c765a2a96d810d7049543a">ECONV_DEFAULT_NEWLINE_DECORATOR</a>,
<a name="l04789"></a>04789                         0, <a class="code" href="../../d5/de3/encoding_8h.html#a122d5f3118774ae1a01a3262c73141eb">ECONV_UNIVERSAL_NEWLINE_DECORATOR</a>) : 0;
<a name="l04790"></a>04790 <span class="preprocessor">#ifdef TEXTMODE_NEWLINE_DECORATOR_ON_WRITE</span>
<a name="l04791"></a>04791 <span class="preprocessor"></span>        ecflags |= (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>) ?
<a name="l04792"></a>04792             <a class="code" href="../../df/d0a/io_8c.html#a5f4cda0ea1994c3ee917943870da504e">MODE_BTMODE</a>(TEXTMODE_NEWLINE_DECORATOR_ON_WRITE,
<a name="l04793"></a>04793                         0, TEXTMODE_NEWLINE_DECORATOR_ON_WRITE) : 0;
<a name="l04794"></a>04794 <span class="preprocessor">#endif</span>
<a name="l04795"></a>04795 <span class="preprocessor"></span>        <a class="code" href="../../df/d0a/io_8c.html#aed67cd777d990c58045b8877ed5c65fc">SET_UNIVERSAL_NEWLINE_DECORATOR_IF_ENC2</a>(enc2, ecflags);
<a name="l04796"></a>04796         ecopts = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l04797"></a>04797     }
<a name="l04798"></a>04798     <span class="keywordflow">else</span> {
<a name="l04799"></a>04799         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v;
<a name="l04800"></a>04800         <a class="code" href="../../df/d0a/io_8c.html#a0f1670258d74dfbb4562e6ab4e6e7118">extract_binmode</a>(opthash, &amp;fmode);
<a name="l04801"></a>04801 <span class="preprocessor">#ifdef O_BINARY</span>
<a name="l04802"></a>04802 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>)
<a name="l04803"></a>04803             oflags |= <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>;
<a name="l04804"></a>04804 <span class="preprocessor">#endif</span>
<a name="l04805"></a>04805 <span class="preprocessor"></span><span class="preprocessor">#if DEFAULT_TEXTMODE</span>
<a name="l04806"></a>04806 <span class="preprocessor"></span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(vmode)) {
<a name="l04807"></a>04807             fmode |= <a class="code" href="../../df/d0a/io_8c.html#ab2c655110073a066c789b7e92cf7377c">DEFAULT_TEXTMODE</a>;
<a name="l04808"></a>04808         }
<a name="l04809"></a>04809 <span class="preprocessor">#endif</span>
<a name="l04810"></a>04810 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!has_vmode) {
<a name="l04811"></a>04811             v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opthash, <a class="code" href="../../df/d0a/io_8c.html#a6fe1eaa40920fbfda47e7975c8b75f37">sym_mode</a>);
<a name="l04812"></a>04812             <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v)) {
<a name="l04813"></a>04813                 <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(vmode)) {
<a name="l04814"></a>04814                     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;mode specified twice&quot;</span>);
<a name="l04815"></a>04815                 }
<a name="l04816"></a>04816                 has_vmode = 1;
<a name="l04817"></a>04817                 vmode = v;
<a name="l04818"></a>04818                 <span class="keywordflow">goto</span> vmode_handle;
<a name="l04819"></a>04819             }
<a name="l04820"></a>04820         }
<a name="l04821"></a>04821         v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opthash, <a class="code" href="../../df/d0a/io_8c.html#a950cb0a17937f0c0dfe5d07d0f683e62">sym_perm</a>);
<a name="l04822"></a>04822         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v)) {
<a name="l04823"></a>04823             <span class="keywordflow">if</span> (vperm_p) {
<a name="l04824"></a>04824                 <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(*vperm_p)) {
<a name="l04825"></a>04825                     <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;perm specified twice&quot;</span>);
<a name="l04826"></a>04826                 }
<a name="l04827"></a>04827                 *vperm_p = v;
<a name="l04828"></a>04828             }
<a name="l04829"></a>04829             <span class="keywordflow">else</span> {
<a name="l04830"></a>04830                 <span class="comment">/* perm no use, just ignore */</span>
<a name="l04831"></a>04831             }
<a name="l04832"></a>04832         }
<a name="l04833"></a>04833         ecflags = (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>) ?
<a name="l04834"></a>04834             <a class="code" href="../../df/d0a/io_8c.html#a5f4cda0ea1994c3ee917943870da504e">MODE_BTMODE</a>(<a class="code" href="../../d5/de3/encoding_8h.html#afae8969f13c765a2a96d810d7049543a">ECONV_DEFAULT_NEWLINE_DECORATOR</a>,
<a name="l04835"></a>04835                         0, <a class="code" href="../../d5/de3/encoding_8h.html#a122d5f3118774ae1a01a3262c73141eb">ECONV_UNIVERSAL_NEWLINE_DECORATOR</a>) : 0;
<a name="l04836"></a>04836 <span class="preprocessor">#ifdef TEXTMODE_NEWLINE_DECORATOR_ON_WRITE</span>
<a name="l04837"></a>04837 <span class="preprocessor"></span>        ecflags |= (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>) ?
<a name="l04838"></a>04838             <a class="code" href="../../df/d0a/io_8c.html#a5f4cda0ea1994c3ee917943870da504e">MODE_BTMODE</a>(TEXTMODE_NEWLINE_DECORATOR_ON_WRITE,
<a name="l04839"></a>04839                         0, TEXTMODE_NEWLINE_DECORATOR_ON_WRITE) : 0;
<a name="l04840"></a>04840 <span class="preprocessor">#endif</span>
<a name="l04841"></a>04841 <span class="preprocessor"></span>
<a name="l04842"></a>04842         <span class="keywordflow">if</span> (<a class="code" href="../../dc/dac/io_8h.html#a51c36b8e9d3a677016832864186cc72d">rb_io_extract_encoding_option</a>(opthash, &amp;enc, &amp;enc2, &amp;fmode)) {
<a name="l04843"></a>04843             <span class="keywordflow">if</span> (has_enc) {
<a name="l04844"></a>04844                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;encoding specified twice&quot;</span>);
<a name="l04845"></a>04845             }
<a name="l04846"></a>04846         }
<a name="l04847"></a>04847         <a class="code" href="../../df/d0a/io_8c.html#aed67cd777d990c58045b8877ed5c65fc">SET_UNIVERSAL_NEWLINE_DECORATOR_IF_ENC2</a>(enc2, ecflags);
<a name="l04848"></a>04848         ecflags = <a class="code" href="../../d5/de3/encoding_8h.html#a044a268a72d78b9e549136b55745af1d">rb_econv_prepare_options</a>(opthash, &amp;ecopts, ecflags);
<a name="l04849"></a>04849     }
<a name="l04850"></a>04850 
<a name="l04851"></a>04851     <a class="code" href="../../df/d0a/io_8c.html#aa9b7bb2abeafdd599f98d4b7db988f1b">validate_enc_binmode</a>(&amp;fmode, ecflags, enc, enc2);
<a name="l04852"></a>04852 
<a name="l04853"></a>04853     *vmode_p = vmode;
<a name="l04854"></a>04854 
<a name="l04855"></a>04855     *oflags_p = oflags;
<a name="l04856"></a>04856     *fmode_p = fmode;
<a name="l04857"></a>04857     convconfig_p-&gt;enc = enc;
<a name="l04858"></a>04858     convconfig_p-&gt;enc2 = enc2;
<a name="l04859"></a>04859     convconfig_p-&gt;ecflags = ecflags;
<a name="l04860"></a>04860     convconfig_p-&gt;ecopts = ecopts;
<a name="l04861"></a>04861 }
<a name="l04862"></a>04862 
<a name="l04863"></a><a class="code" href="../../d4/d91/structsysopen__struct.html">04863</a> <span class="keyword">struct </span><a class="code" href="../../d4/d91/structsysopen__struct.html">sysopen_struct</a> {
<a name="l04864"></a><a class="code" href="../../d4/d91/structsysopen__struct.html#add60a127f623bed3100dd515e477dd9d">04864</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d4/d91/structsysopen__struct.html#add60a127f623bed3100dd515e477dd9d">fname</a>;
<a name="l04865"></a><a class="code" href="../../d4/d91/structsysopen__struct.html#a53adce7ff5d0d6e00b3b10fe64d0823c">04865</a>     <span class="keywordtype">int</span> <a class="code" href="../../d4/d91/structsysopen__struct.html#a53adce7ff5d0d6e00b3b10fe64d0823c">oflags</a>;
<a name="l04866"></a><a class="code" href="../../d4/d91/structsysopen__struct.html#a06cb3c53f93a5a0f9a017ed9b12543ad">04866</a>     <a class="code" href="../../dc/db1/win32_8h.html#ad2933406ba93c0e0d1884fc09c18a0bf">mode_t</a> <a class="code" href="../../d4/d91/structsysopen__struct.html#a06cb3c53f93a5a0f9a017ed9b12543ad">perm</a>;
<a name="l04867"></a>04867 };
<a name="l04868"></a>04868 
<a name="l04869"></a>04869 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04870"></a><a class="code" href="../../df/d0a/io_8c.html#ac0afde27e31cb12f35d8b99c16b9bd59">04870</a> <a class="code" href="../../df/d0a/io_8c.html#ac0afde27e31cb12f35d8b99c16b9bd59">sysopen_func</a>(<span class="keywordtype">void</span> *ptr)
<a name="l04871"></a>04871 {
<a name="l04872"></a>04872     <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="../../d4/d91/structsysopen__struct.html">sysopen_struct</a> *data = ptr;
<a name="l04873"></a>04873     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d4/d91/structsysopen__struct.html#add60a127f623bed3100dd515e477dd9d">fname</a> = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(data-&gt;<a class="code" href="../../d4/d91/structsysopen__struct.html#add60a127f623bed3100dd515e477dd9d">fname</a>);
<a name="l04874"></a>04874     <span class="keywordflow">return</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)open(fname, data-&gt;<a class="code" href="../../d4/d91/structsysopen__struct.html#a53adce7ff5d0d6e00b3b10fe64d0823c">oflags</a>, data-&gt;<a class="code" href="../../d4/d91/structsysopen__struct.html#a06cb3c53f93a5a0f9a017ed9b12543ad">perm</a>);
<a name="l04875"></a>04875 }
<a name="l04876"></a>04876 
<a name="l04877"></a>04877 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l04878"></a><a class="code" href="../../df/d0a/io_8c.html#abc6dfe9ca50727e69b4e9b0681fde800">04878</a> <a class="code" href="../../df/d0a/io_8c.html#abc6dfe9ca50727e69b4e9b0681fde800">rb_sysopen_internal</a>(<span class="keyword">struct</span> <a class="code" href="../../d4/d91/structsysopen__struct.html">sysopen_struct</a> *data)
<a name="l04879"></a>04879 {
<a name="l04880"></a>04880     <span class="keywordtype">int</span> fd;
<a name="l04881"></a>04881     fd = (int)<a class="code" href="../../db/d2e/intern_8h.html#a08ae0a0abef66341ce134880e8e37934">rb_thread_blocking_region</a>(<a class="code" href="../../df/d0a/io_8c.html#ac0afde27e31cb12f35d8b99c16b9bd59">sysopen_func</a>, data, <a class="code" href="../../db/d2e/intern_8h.html#a42eb65c31dbcdaa74496ed9668b7889f">RUBY_UBF_IO</a>, 0);
<a name="l04882"></a>04882     <span class="keywordflow">if</span> (0 &lt;= fd)
<a name="l04883"></a>04883         <a class="code" href="../../db/d2e/intern_8h.html#a6448f20b0936afe0cb85ab3186753db2">rb_update_max_fd</a>(fd);
<a name="l04884"></a>04884     <span class="keywordflow">return</span> fd;
<a name="l04885"></a>04885 }
<a name="l04886"></a>04886 
<a name="l04887"></a>04887 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l04888"></a><a class="code" href="../../df/d0a/io_8c.html#a42654a6f8234decb8c183204f42e1b8a">04888</a> <a class="code" href="../../df/d0a/io_8c.html#a42654a6f8234decb8c183204f42e1b8a">rb_sysopen</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d4/d91/structsysopen__struct.html#add60a127f623bed3100dd515e477dd9d">fname</a>, <span class="keywordtype">int</span> <a class="code" href="../../d4/d91/structsysopen__struct.html#a53adce7ff5d0d6e00b3b10fe64d0823c">oflags</a>, <a class="code" href="../../dc/db1/win32_8h.html#ad2933406ba93c0e0d1884fc09c18a0bf">mode_t</a> <a class="code" href="../../d4/d91/structsysopen__struct.html#a06cb3c53f93a5a0f9a017ed9b12543ad">perm</a>)
<a name="l04889"></a>04889 {
<a name="l04890"></a>04890     <span class="keywordtype">int</span> fd;
<a name="l04891"></a>04891     <span class="keyword">struct </span><a class="code" href="../../d4/d91/structsysopen__struct.html">sysopen_struct</a> data;
<a name="l04892"></a>04892 
<a name="l04893"></a>04893     data.<a class="code" href="../../d4/d91/structsysopen__struct.html#add60a127f623bed3100dd515e477dd9d">fname</a> = <a class="code" href="../../d6/d13/file_8c.html#a4cccaa05adca4eaa4a0646c0578f137d">rb_str_encode_ospath</a>(fname);
<a name="l04894"></a>04894     data.<a class="code" href="../../d4/d91/structsysopen__struct.html#a53adce7ff5d0d6e00b3b10fe64d0823c">oflags</a> = oflags;
<a name="l04895"></a>04895     data.<a class="code" href="../../d4/d91/structsysopen__struct.html#a06cb3c53f93a5a0f9a017ed9b12543ad">perm</a> = perm;
<a name="l04896"></a>04896 
<a name="l04897"></a>04897     fd = <a class="code" href="../../df/d0a/io_8c.html#abc6dfe9ca50727e69b4e9b0681fde800">rb_sysopen_internal</a>(&amp;data);
<a name="l04898"></a>04898     <span class="keywordflow">if</span> (fd &lt; 0) {
<a name="l04899"></a>04899         <span class="keywordflow">if</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EMFILE || <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ENFILE) {
<a name="l04900"></a>04900             <a class="code" href="../../d8/d16/gc_8c.html#a7a12ca86b76e272a301173e7661acfea">rb_gc</a>();
<a name="l04901"></a>04901             fd = <a class="code" href="../../df/d0a/io_8c.html#abc6dfe9ca50727e69b4e9b0681fde800">rb_sysopen_internal</a>(&amp;data);
<a name="l04902"></a>04902         }
<a name="l04903"></a>04903         <span class="keywordflow">if</span> (fd &lt; 0) {
<a name="l04904"></a>04904             <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fname);
<a name="l04905"></a>04905         }
<a name="l04906"></a>04906     }
<a name="l04907"></a>04907     <a class="code" href="../../db/d2e/intern_8h.html#a6448f20b0936afe0cb85ab3186753db2">rb_update_max_fd</a>(fd);
<a name="l04908"></a>04908     <span class="keywordflow">return</span> fd;
<a name="l04909"></a>04909 }
<a name="l04910"></a>04910 
<a name="l04911"></a>04911 <a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *
<a name="l04912"></a><a class="code" href="../../df/d0a/io_8c.html#abefd96bef01746bab43abc21a32bb17f">04912</a> <a class="code" href="../../dc/dac/io_8h.html#a07c2492c65dc6094210adc71cb362c72">rb_fdopen</a>(<span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keywordtype">char</span> *modestr)
<a name="l04913"></a>04913 {
<a name="l04914"></a>04914     <a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *file;
<a name="l04915"></a>04915 
<a name="l04916"></a>04916 <span class="preprocessor">#if defined(sun)</span>
<a name="l04917"></a>04917 <span class="preprocessor"></span>    <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0;
<a name="l04918"></a>04918 <span class="preprocessor">#endif</span>
<a name="l04919"></a>04919 <span class="preprocessor"></span>    file = fdopen(fd, modestr);
<a name="l04920"></a>04920     <span class="keywordflow">if</span> (!file) {
<a name="l04921"></a>04921         <span class="keywordflow">if</span> (
<a name="l04922"></a>04922 #<span class="keywordflow">if</span> defined(sun)
<a name="l04923"></a>04923             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == 0 ||
<a name="l04924"></a>04924 #endif
<a name="l04925"></a>04925             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EMFILE || <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ENFILE) {
<a name="l04926"></a>04926             <a class="code" href="../../d8/d16/gc_8c.html#a7a12ca86b76e272a301173e7661acfea">rb_gc</a>();
<a name="l04927"></a>04927 <span class="preprocessor">#if defined(sun)</span>
<a name="l04928"></a>04928 <span class="preprocessor"></span>            <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0;
<a name="l04929"></a>04929 <span class="preprocessor">#endif</span>
<a name="l04930"></a>04930 <span class="preprocessor"></span>            file = fdopen(fd, modestr);
<a name="l04931"></a>04931         }
<a name="l04932"></a>04932         <span class="keywordflow">if</span> (!file) {
<a name="l04933"></a>04933 <span class="preprocessor">#ifdef _WIN32</span>
<a name="l04934"></a>04934 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == 0) <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l04935"></a>04935 <span class="preprocessor">#elif defined(sun)</span>
<a name="l04936"></a>04936 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == 0) <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EMFILE;
<a name="l04937"></a>04937 <span class="preprocessor">#endif</span>
<a name="l04938"></a>04938 <span class="preprocessor"></span>            <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l04939"></a>04939         }
<a name="l04940"></a>04940     }
<a name="l04941"></a>04941 
<a name="l04942"></a>04942     <span class="comment">/* xxx: should be _IONBF?  A buffer in FILE may have trouble. */</span>
<a name="l04943"></a>04943 <span class="preprocessor">#ifdef USE_SETVBUF</span>
<a name="l04944"></a>04944 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (setvbuf(file, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, _IOFBF, 0) != 0)
<a name="l04945"></a>04945         <a class="code" href="../../db/dcc/error_8c.html#aa5b1972d475e9a090c8ef607ce033008">rb_warn</a>(<span class="stringliteral">&quot;setvbuf() can&apos;t be honoured (fd=%d)&quot;</span>, fd);
<a name="l04946"></a>04946 <span class="preprocessor">#endif</span>
<a name="l04947"></a>04947 <span class="preprocessor"></span>    <span class="keywordflow">return</span> file;
<a name="l04948"></a>04948 }
<a name="l04949"></a>04949 
<a name="l04950"></a>04950 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l04951"></a><a class="code" href="../../df/d0a/io_8c.html#a91e87f4790e897c6938dbb2213d0059f">04951</a> <a class="code" href="../../df/d0a/io_8c.html#a91e87f4790e897c6938dbb2213d0059f">io_check_tty</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l04952"></a>04952 {
<a name="l04953"></a>04953     <span class="keywordflow">if</span> (isatty(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>))
<a name="l04954"></a>04954         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> |= <a class="code" href="../../dc/dac/io_8h.html#a40065fb3d48c5c13642ef3880efaaa03">FMODE_TTY</a>|<a class="code" href="../../dc/dac/io_8h.html#a7bba3fe65c0f4b33d346273792dddade">FMODE_DUPLEX</a>;
<a name="l04955"></a>04955 }
<a name="l04956"></a>04956 
<a name="l04957"></a>04957 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../df/d0a/io_8c.html#a48ce1fe48cfa72a42f99111bfe1c6077">rb_io_internal_encoding</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>);
<a name="l04958"></a>04958 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../df/d0a/io_8c.html#a5a1a8cba1be8081b15952fa0945a1692">io_encoding_set</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>);
<a name="l04959"></a>04959 
<a name="l04960"></a>04960 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l04961"></a><a class="code" href="../../df/d0a/io_8c.html#a12a742c8f13de584f5f086e99286d66b">04961</a> <a class="code" href="../../df/d0a/io_8c.html#a12a742c8f13de584f5f086e99286d66b">io_strip_bom</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l04962"></a>04962 {
<a name="l04963"></a>04963     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> b1, b2, b3, b4;
<a name="l04964"></a>04964 
<a name="l04965"></a>04965     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(b1 = <a class="code" href="../../db/d2e/intern_8h.html#a13c20887173177e30ccd7bb42708dc2b">rb_io_getbyte</a>(io))) <span class="keywordflow">return</span> 0;
<a name="l04966"></a>04966     <span class="keywordflow">switch</span> (b1) {
<a name="l04967"></a>04967       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0xEF):
<a name="l04968"></a>04968         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(b2 = <a class="code" href="../../db/d2e/intern_8h.html#a13c20887173177e30ccd7bb42708dc2b">rb_io_getbyte</a>(io))) <span class="keywordflow">break</span>;
<a name="l04969"></a>04969         <span class="keywordflow">if</span> (b2 == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0xBB) &amp;&amp; !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(b3 = <a class="code" href="../../db/d2e/intern_8h.html#a13c20887173177e30ccd7bb42708dc2b">rb_io_getbyte</a>(io))) {
<a name="l04970"></a>04970             <span class="keywordflow">if</span> (b3 == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0xBF)) {
<a name="l04971"></a>04971                 <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#a401176ad45a3d3834694ca2412bf2351">rb_utf8_encindex</a>();
<a name="l04972"></a>04972             }
<a name="l04973"></a>04973             <a class="code" href="../../db/d2e/intern_8h.html#ad5e3541ec00f5805a8bfb10fbe71a33a">rb_io_ungetbyte</a>(io, b3);
<a name="l04974"></a>04974         }
<a name="l04975"></a>04975         <a class="code" href="../../db/d2e/intern_8h.html#ad5e3541ec00f5805a8bfb10fbe71a33a">rb_io_ungetbyte</a>(io, b2);
<a name="l04976"></a>04976         <span class="keywordflow">break</span>;
<a name="l04977"></a>04977 
<a name="l04978"></a>04978       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0xFE):
<a name="l04979"></a>04979         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(b2 = <a class="code" href="../../db/d2e/intern_8h.html#a13c20887173177e30ccd7bb42708dc2b">rb_io_getbyte</a>(io))) <span class="keywordflow">break</span>;
<a name="l04980"></a>04980         <span class="keywordflow">if</span> (b2 == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0xFF)) {
<a name="l04981"></a>04981             <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#adeb5f5b97ea43528a55d717add8f64c5">rb_enc_find_index</a>(<span class="stringliteral">&quot;UTF-16BE&quot;</span>);
<a name="l04982"></a>04982         }
<a name="l04983"></a>04983         <a class="code" href="../../db/d2e/intern_8h.html#ad5e3541ec00f5805a8bfb10fbe71a33a">rb_io_ungetbyte</a>(io, b2);
<a name="l04984"></a>04984         <span class="keywordflow">break</span>;
<a name="l04985"></a>04985 
<a name="l04986"></a>04986       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0xFF):
<a name="l04987"></a>04987         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(b2 = <a class="code" href="../../db/d2e/intern_8h.html#a13c20887173177e30ccd7bb42708dc2b">rb_io_getbyte</a>(io))) <span class="keywordflow">break</span>;
<a name="l04988"></a>04988         <span class="keywordflow">if</span> (b2 == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0xFE)) {
<a name="l04989"></a>04989             b3 = <a class="code" href="../../db/d2e/intern_8h.html#a13c20887173177e30ccd7bb42708dc2b">rb_io_getbyte</a>(io);
<a name="l04990"></a>04990             <span class="keywordflow">if</span> (b3 == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0) &amp;&amp; !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(b4 = <a class="code" href="../../db/d2e/intern_8h.html#a13c20887173177e30ccd7bb42708dc2b">rb_io_getbyte</a>(io))) {
<a name="l04991"></a>04991                 <span class="keywordflow">if</span> (b4 == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0)) {
<a name="l04992"></a>04992                     <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#adeb5f5b97ea43528a55d717add8f64c5">rb_enc_find_index</a>(<span class="stringliteral">&quot;UTF-32LE&quot;</span>);
<a name="l04993"></a>04993                 }
<a name="l04994"></a>04994                 <a class="code" href="../../db/d2e/intern_8h.html#ad5e3541ec00f5805a8bfb10fbe71a33a">rb_io_ungetbyte</a>(io, b4);
<a name="l04995"></a>04995                 <a class="code" href="../../db/d2e/intern_8h.html#ad5e3541ec00f5805a8bfb10fbe71a33a">rb_io_ungetbyte</a>(io, b3);
<a name="l04996"></a>04996             }
<a name="l04997"></a>04997             <span class="keywordflow">else</span> {
<a name="l04998"></a>04998                 <a class="code" href="../../db/d2e/intern_8h.html#ad5e3541ec00f5805a8bfb10fbe71a33a">rb_io_ungetbyte</a>(io, b3);
<a name="l04999"></a>04999                 <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#adeb5f5b97ea43528a55d717add8f64c5">rb_enc_find_index</a>(<span class="stringliteral">&quot;UTF-16LE&quot;</span>);
<a name="l05000"></a>05000             }
<a name="l05001"></a>05001         }
<a name="l05002"></a>05002         <a class="code" href="../../db/d2e/intern_8h.html#ad5e3541ec00f5805a8bfb10fbe71a33a">rb_io_ungetbyte</a>(io, b2);
<a name="l05003"></a>05003         <span class="keywordflow">break</span>;
<a name="l05004"></a>05004 
<a name="l05005"></a>05005       <span class="keywordflow">case</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0):
<a name="l05006"></a>05006         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(b2 = <a class="code" href="../../db/d2e/intern_8h.html#a13c20887173177e30ccd7bb42708dc2b">rb_io_getbyte</a>(io))) <span class="keywordflow">break</span>;
<a name="l05007"></a>05007         <span class="keywordflow">if</span> (b2 == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0) &amp;&amp; !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(b3 = <a class="code" href="../../db/d2e/intern_8h.html#a13c20887173177e30ccd7bb42708dc2b">rb_io_getbyte</a>(io))) {
<a name="l05008"></a>05008             <span class="keywordflow">if</span> (b3 == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0xFE) &amp;&amp; !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(b4 = <a class="code" href="../../db/d2e/intern_8h.html#a13c20887173177e30ccd7bb42708dc2b">rb_io_getbyte</a>(io))) {
<a name="l05009"></a>05009                 <span class="keywordflow">if</span> (b4 == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0xFF)) {
<a name="l05010"></a>05010                     <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#adeb5f5b97ea43528a55d717add8f64c5">rb_enc_find_index</a>(<span class="stringliteral">&quot;UTF-32BE&quot;</span>);
<a name="l05011"></a>05011                 }
<a name="l05012"></a>05012                 <a class="code" href="../../db/d2e/intern_8h.html#ad5e3541ec00f5805a8bfb10fbe71a33a">rb_io_ungetbyte</a>(io, b4);
<a name="l05013"></a>05013             }
<a name="l05014"></a>05014             <a class="code" href="../../db/d2e/intern_8h.html#ad5e3541ec00f5805a8bfb10fbe71a33a">rb_io_ungetbyte</a>(io, b3);
<a name="l05015"></a>05015         }
<a name="l05016"></a>05016         <a class="code" href="../../db/d2e/intern_8h.html#ad5e3541ec00f5805a8bfb10fbe71a33a">rb_io_ungetbyte</a>(io, b2);
<a name="l05017"></a>05017         <span class="keywordflow">break</span>;
<a name="l05018"></a>05018     }
<a name="l05019"></a>05019     <a class="code" href="../../db/d2e/intern_8h.html#ad5e3541ec00f5805a8bfb10fbe71a33a">rb_io_ungetbyte</a>(io, b1);
<a name="l05020"></a>05020     <span class="keywordflow">return</span> 0;
<a name="l05021"></a>05021 }
<a name="l05022"></a>05022 
<a name="l05023"></a>05023 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l05024"></a><a class="code" href="../../df/d0a/io_8c.html#abc37d2836f249b72957c05de008f9963">05024</a> <a class="code" href="../../df/d0a/io_8c.html#abc37d2836f249b72957c05de008f9963">io_set_encoding_by_bom</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l05025"></a>05025 {
<a name="l05026"></a>05026     <span class="keywordtype">int</span> idx = <a class="code" href="../../df/d0a/io_8c.html#a12a742c8f13de584f5f086e99286d66b">io_strip_bom</a>(io);
<a name="l05027"></a>05027 
<a name="l05028"></a>05028     <span class="keywordflow">if</span> (idx) {
<a name="l05029"></a>05029         <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l05030"></a>05030         <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l05031"></a>05031         <a class="code" href="../../df/d0a/io_8c.html#a5a1a8cba1be8081b15952fa0945a1692">io_encoding_set</a>(fptr, <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(<a class="code" href="../../d5/db5/encoding_8c.html#aef9c377b2d9d78b9f88e890b77593109">rb_enc_from_index</a>(idx)),
<a name="l05032"></a>05032                 <a class="code" href="../../df/d0a/io_8c.html#a48ce1fe48cfa72a42f99111bfe1c6077">rb_io_internal_encoding</a>(io), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l05033"></a>05033     }
<a name="l05034"></a>05034 }
<a name="l05035"></a>05035 
<a name="l05036"></a>05036 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l05037"></a><a class="code" href="../../df/d0a/io_8c.html#ad69e3fce0b7a32e4aade7a5d80e3f62f">05037</a> <a class="code" href="../../df/d0a/io_8c.html#ad69e3fce0b7a32e4aade7a5d80e3f62f">rb_file_open_generic</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> filename, <span class="keywordtype">int</span> <a class="code" href="../../d4/d91/structsysopen__struct.html#a53adce7ff5d0d6e00b3b10fe64d0823c">oflags</a>, <span class="keywordtype">int</span> fmode, <a class="code" href="../../df/d0a/io_8c.html#a8a7a37633499f91b42907cfd1ecea043">convconfig_t</a> *convconfig, <a class="code" href="../../dc/db1/win32_8h.html#ad2933406ba93c0e0d1884fc09c18a0bf">mode_t</a> <a class="code" href="../../d4/d91/structsysopen__struct.html#a06cb3c53f93a5a0f9a017ed9b12543ad">perm</a>)
<a name="l05038"></a>05038 {
<a name="l05039"></a>05039     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l05040"></a>05040     <a class="code" href="../../df/d0a/io_8c.html#a8a7a37633499f91b42907cfd1ecea043">convconfig_t</a> cc;
<a name="l05041"></a>05041     <span class="keywordflow">if</span> (!convconfig) {
<a name="l05042"></a>05042         <span class="comment">/* Set to default encodings */</span>
<a name="l05043"></a>05043         <a class="code" href="../../df/d0a/io_8c.html#a8dcac7969c25237c0f4620b5e074727a">rb_io_ext_int_to_encs</a>(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;cc.enc, &amp;cc.enc2);
<a name="l05044"></a>05044         cc.ecflags = 0;
<a name="l05045"></a>05045         cc.ecopts = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l05046"></a>05046         convconfig = &amp;cc;
<a name="l05047"></a>05047     }
<a name="l05048"></a>05048     <a class="code" href="../../df/d0a/io_8c.html#aa9b7bb2abeafdd599f98d4b7db988f1b">validate_enc_binmode</a>(&amp;fmode, convconfig-&gt;ecflags,
<a name="l05049"></a>05049                          convconfig-&gt;enc, convconfig-&gt;enc2);
<a name="l05050"></a>05050 
<a name="l05051"></a>05051     <a class="code" href="../../dc/dac/io_8h.html#a806072dc06b95702f12c2d59e815cfde">MakeOpenFile</a>(io, fptr);
<a name="l05052"></a>05052     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> = fmode;
<a name="l05053"></a>05053     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a> = *convconfig;
<a name="l05054"></a>05054     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a> = <a class="code" href="../../db/d2e/intern_8h.html#ab771cea1c6187da7a08e9f0bc309a0a6">rb_str_new_frozen</a>(filename);
<a name="l05055"></a>05055     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> = <a class="code" href="../../df/d0a/io_8c.html#a42654a6f8234decb8c183204f42e1b8a">rb_sysopen</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>, oflags, perm);
<a name="l05056"></a>05056     <a class="code" href="../../df/d0a/io_8c.html#a91e87f4790e897c6938dbb2213d0059f">io_check_tty</a>(fptr);
<a name="l05057"></a>05057     <span class="keywordflow">if</span> (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a1887ab1ec5253a5f363e78092a55348c">FMODE_SETENC_BY_BOM</a>) <a class="code" href="../../df/d0a/io_8c.html#abc37d2836f249b72957c05de008f9963">io_set_encoding_by_bom</a>(io);
<a name="l05058"></a>05058 
<a name="l05059"></a>05059     <span class="keywordflow">return</span> io;
<a name="l05060"></a>05060 }
<a name="l05061"></a>05061 
<a name="l05062"></a>05062 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l05063"></a><a class="code" href="../../df/d0a/io_8c.html#aef5e436087ab84e24df415c26b4c4fe7">05063</a> <a class="code" href="../../df/d0a/io_8c.html#aef5e436087ab84e24df415c26b4c4fe7">rb_file_open_internal</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> filename, <span class="keyword">const</span> <span class="keywordtype">char</span> *modestr)
<a name="l05064"></a>05064 {
<a name="l05065"></a>05065     <span class="keywordtype">int</span> <a class="code" href="../../df/d0a/io_8c.html#a8d9cc2340b814767e83294570cafa7fd">fmode</a> = <a class="code" href="../../dc/dac/io_8h.html#a0c32c67101e6698b9b314041ac5025f4">rb_io_modestr_fmode</a>(modestr);
<a name="l05066"></a>05066     <span class="keyword">const</span> <span class="keywordtype">char</span> *p = <a class="code" href="../../de/d32/dir_8c.html#a99c0c80536c9a3937814525bb5f8a7ad">strchr</a>(modestr, <span class="charliteral">&apos;:&apos;</span>);
<a name="l05067"></a>05067     <a class="code" href="../../df/d0a/io_8c.html#a8a7a37633499f91b42907cfd1ecea043">convconfig_t</a> convconfig;
<a name="l05068"></a>05068 
<a name="l05069"></a>05069     <span class="keywordflow">if</span> (p) {
<a name="l05070"></a>05070         <a class="code" href="../../df/d0a/io_8c.html#a83cf2bfe6afeb749627027cf09e6c7d4">parse_mode_enc</a>(p+1, &amp;convconfig.enc, &amp;convconfig.enc2, &amp;fmode);
<a name="l05071"></a>05071     }
<a name="l05072"></a>05072     <span class="keywordflow">else</span> {
<a name="l05073"></a>05073         <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *e;
<a name="l05074"></a>05074         <span class="comment">/* Set to default encodings */</span>
<a name="l05075"></a>05075 
<a name="l05076"></a>05076         e = (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>) ? <a class="code" href="../../d5/db5/encoding_8c.html#a767d777810f0d48add93857b52057262">rb_ascii8bit_encoding</a>() : <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05077"></a>05077         <a class="code" href="../../df/d0a/io_8c.html#a8dcac7969c25237c0f4620b5e074727a">rb_io_ext_int_to_encs</a>(e, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;convconfig.enc, &amp;convconfig.enc2);
<a name="l05078"></a>05078         convconfig.ecflags = 0;
<a name="l05079"></a>05079         convconfig.ecopts = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l05080"></a>05080     }
<a name="l05081"></a>05081 
<a name="l05082"></a>05082     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#ad69e3fce0b7a32e4aade7a5d80e3f62f">rb_file_open_generic</a>(io, filename,
<a name="l05083"></a>05083             <a class="code" href="../../df/d0a/io_8c.html#abe73106951f1bd614c978445ace2af9e">rb_io_fmode_oflags</a>(fmode),
<a name="l05084"></a>05084             fmode,
<a name="l05085"></a>05085             &amp;convconfig,
<a name="l05086"></a>05086             0666);
<a name="l05087"></a>05087 }
<a name="l05088"></a>05088 
<a name="l05089"></a>05089 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l05090"></a><a class="code" href="../../df/d0a/io_8c.html#ae6205d94ec78ed8b07983f366a702470">05090</a> <a class="code" href="../../db/d2e/intern_8h.html#a7355c873e8175a0c36e6eef35507e781">rb_file_open_str</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d4/d91/structsysopen__struct.html#add60a127f623bed3100dd515e477dd9d">fname</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *modestr)
<a name="l05091"></a>05091 {
<a name="l05092"></a>05092     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a66b35e3e022b499db72f5df63bb1d358">FilePathValue</a>(fname);
<a name="l05093"></a>05093     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#aef5e436087ab84e24df415c26b4c4fe7">rb_file_open_internal</a>(<a class="code" href="../../df/d0a/io_8c.html#a47f57cf9a8f65858e5cfe7ed56cc65bb">io_alloc</a>(<a class="code" href="../../d6/d13/file_8c.html#ae9f03997c2e7a3461524e83053a24ac2">rb_cFile</a>), fname, modestr);
<a name="l05094"></a>05094 }
<a name="l05095"></a>05095 
<a name="l05096"></a>05096 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l05097"></a><a class="code" href="../../df/d0a/io_8c.html#adc84447d42c529fb4160c607c590cd1d">05097</a> <a class="code" href="../../db/d2e/intern_8h.html#a28282fca257f7a7b80524edac3214614">rb_file_open</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d4/d91/structsysopen__struct.html#add60a127f623bed3100dd515e477dd9d">fname</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *modestr)
<a name="l05098"></a>05098 {
<a name="l05099"></a>05099     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#aef5e436087ab84e24df415c26b4c4fe7">rb_file_open_internal</a>(<a class="code" href="../../df/d0a/io_8c.html#a47f57cf9a8f65858e5cfe7ed56cc65bb">io_alloc</a>(<a class="code" href="../../d6/d13/file_8c.html#ae9f03997c2e7a3461524e83053a24ac2">rb_cFile</a>), <a class="code" href="../../db/d2e/intern_8h.html#a2b9cc485b0aa1dc270744b8b9eb47569">rb_str_new_cstr</a>(fname), modestr);
<a name="l05100"></a>05100 }
<a name="l05101"></a>05101 
<a name="l05102"></a>05102 <span class="preprocessor">#if defined(__CYGWIN__) || !defined(HAVE_FORK)</span>
<a name="l05103"></a><a class="code" href="../../d3/d53/structpipe__list.html">05103</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="../../d3/d53/structpipe__list.html">pipe_list</a> {
<a name="l05104"></a><a class="code" href="../../d3/d53/structpipe__list.html#a6ee133f2e212fcb8f7a1ff0fd28462a9">05104</a>     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l05105"></a><a class="code" href="../../d3/d53/structpipe__list.html#a55893dfdbe920a01bda7aac57836b90d">05105</a>     <span class="keyword">struct </span><a class="code" href="../../d3/d53/structpipe__list.html">pipe_list</a> *<a class="code" href="../../d3/d53/structpipe__list.html#a55893dfdbe920a01bda7aac57836b90d">next</a>;
<a name="l05106"></a>05106 } *<a class="code" href="../../d3/d53/structpipe__list.html">pipe_list</a>;
<a name="l05107"></a>05107 
<a name="l05108"></a>05108 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l05109"></a><a class="code" href="../../df/d0a/io_8c.html#a6cee254cfd59ee0a24dc3872fc46de2a">05109</a> <a class="code" href="../../df/d0a/io_8c.html#a6cee254cfd59ee0a24dc3872fc46de2a">pipe_add_fptr</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l05110"></a>05110 {
<a name="l05111"></a>05111     <span class="keyword">struct </span><a class="code" href="../../d3/d53/structpipe__list.html">pipe_list</a> *<a class="code" href="../../d5/db5/encoding_8c.html#a05f70dacbe595d27364e1e014efb0c8e">list</a>;
<a name="l05112"></a>05112 
<a name="l05113"></a>05113     list = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac8df5a8a8961bd9e16be385fef28c2f2">ALLOC</a>(<span class="keyword">struct</span> <a class="code" href="../../d3/d53/structpipe__list.html">pipe_list</a>);
<a name="l05114"></a>05114     list-&gt;<a class="code" href="../../d3/d53/structpipe__list.html#a6ee133f2e212fcb8f7a1ff0fd28462a9">fptr</a> = fptr;
<a name="l05115"></a>05115     list-&gt;<a class="code" href="../../d3/d53/structpipe__list.html#a55893dfdbe920a01bda7aac57836b90d">next</a> = <a class="code" href="../../d3/d53/structpipe__list.html">pipe_list</a>;
<a name="l05116"></a>05116     <a class="code" href="../../d3/d53/structpipe__list.html">pipe_list</a> = list;
<a name="l05117"></a>05117 }
<a name="l05118"></a>05118 
<a name="l05119"></a>05119 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l05120"></a><a class="code" href="../../df/d0a/io_8c.html#a8b21d130f714e845215a6995a10f55b0">05120</a> <a class="code" href="../../df/d0a/io_8c.html#a8b21d130f714e845215a6995a10f55b0">pipe_del_fptr</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l05121"></a>05121 {
<a name="l05122"></a>05122     <span class="keyword">struct </span><a class="code" href="../../d3/d53/structpipe__list.html">pipe_list</a> *<a class="code" href="../../d5/db5/encoding_8c.html#a05f70dacbe595d27364e1e014efb0c8e">list</a> = <a class="code" href="../../d3/d53/structpipe__list.html">pipe_list</a>;
<a name="l05123"></a>05123     <span class="keyword">struct </span><a class="code" href="../../d3/d53/structpipe__list.html">pipe_list</a> *tmp;
<a name="l05124"></a>05124 
<a name="l05125"></a>05125     <span class="keywordflow">if</span> (list-&gt;<a class="code" href="../../d3/d53/structpipe__list.html#a6ee133f2e212fcb8f7a1ff0fd28462a9">fptr</a> == fptr) {
<a name="l05126"></a>05126         <a class="code" href="../../d3/d53/structpipe__list.html">pipe_list</a> = list-&gt;<a class="code" href="../../d3/d53/structpipe__list.html#a55893dfdbe920a01bda7aac57836b90d">next</a>;
<a name="l05127"></a>05127         <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(list);
<a name="l05128"></a>05128         <span class="keywordflow">return</span>;
<a name="l05129"></a>05129     }
<a name="l05130"></a>05130 
<a name="l05131"></a>05131     <span class="keywordflow">while</span> (list-&gt;<a class="code" href="../../d3/d53/structpipe__list.html#a55893dfdbe920a01bda7aac57836b90d">next</a>) {
<a name="l05132"></a>05132         <span class="keywordflow">if</span> (list-&gt;<a class="code" href="../../d3/d53/structpipe__list.html#a55893dfdbe920a01bda7aac57836b90d">next</a>-&gt;<a class="code" href="../../d3/d53/structpipe__list.html#a6ee133f2e212fcb8f7a1ff0fd28462a9">fptr</a> == fptr) {
<a name="l05133"></a>05133             tmp = list-&gt;<a class="code" href="../../d3/d53/structpipe__list.html#a55893dfdbe920a01bda7aac57836b90d">next</a>;
<a name="l05134"></a>05134             list-&gt;<a class="code" href="../../d3/d53/structpipe__list.html#a55893dfdbe920a01bda7aac57836b90d">next</a> = list-&gt;<a class="code" href="../../d3/d53/structpipe__list.html#a55893dfdbe920a01bda7aac57836b90d">next</a>-&gt;<a class="code" href="../../d3/d53/structpipe__list.html#a55893dfdbe920a01bda7aac57836b90d">next</a>;
<a name="l05135"></a>05135             <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(tmp);
<a name="l05136"></a>05136             <span class="keywordflow">return</span>;
<a name="l05137"></a>05137         }
<a name="l05138"></a>05138         list = list-&gt;<a class="code" href="../../d3/d53/structpipe__list.html#a55893dfdbe920a01bda7aac57836b90d">next</a>;
<a name="l05139"></a>05139     }
<a name="l05140"></a>05140 }
<a name="l05141"></a>05141 
<a name="l05142"></a>05142 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l05143"></a><a class="code" href="../../df/d0a/io_8c.html#a13b5c96773a093946c181cd2e563fabb">05143</a> <a class="code" href="../../df/d0a/io_8c.html#a13b5c96773a093946c181cd2e563fabb">pipe_atexit</a>(<span class="keywordtype">void</span>)
<a name="l05144"></a>05144 {
<a name="l05145"></a>05145     <span class="keyword">struct </span><a class="code" href="../../d3/d53/structpipe__list.html">pipe_list</a> *<a class="code" href="../../d5/db5/encoding_8c.html#a05f70dacbe595d27364e1e014efb0c8e">list</a> = <a class="code" href="../../d3/d53/structpipe__list.html">pipe_list</a>;
<a name="l05146"></a>05146     <span class="keyword">struct </span><a class="code" href="../../d3/d53/structpipe__list.html">pipe_list</a> *tmp;
<a name="l05147"></a>05147 
<a name="l05148"></a>05148     <span class="keywordflow">while</span> (list) {
<a name="l05149"></a>05149         tmp = list-&gt;<a class="code" href="../../d3/d53/structpipe__list.html#a55893dfdbe920a01bda7aac57836b90d">next</a>;
<a name="l05150"></a>05150         <a class="code" href="../../dc/dac/io_8h.html#a6fc4023c7b0bced3b799f7300913de28">rb_io_fptr_finalize</a>(list-&gt;<a class="code" href="../../d3/d53/structpipe__list.html#a6ee133f2e212fcb8f7a1ff0fd28462a9">fptr</a>);
<a name="l05151"></a>05151         list = tmp;
<a name="l05152"></a>05152     }
<a name="l05153"></a>05153 }
<a name="l05154"></a>05154 
<a name="l05155"></a>05155 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l05156"></a><a class="code" href="../../df/d0a/io_8c.html#a6467635964aaf761d2ac9169d217ee63">05156</a> <a class="code" href="../../df/d0a/io_8c.html#a6467635964aaf761d2ac9169d217ee63">pipe_finalize</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <span class="keywordtype">int</span> noraise)
<a name="l05157"></a>05157 {
<a name="l05158"></a>05158 <span class="preprocessor">#if !defined(HAVE_FORK) &amp;&amp; !defined(_WIN32)</span>
<a name="l05159"></a>05159 <span class="preprocessor"></span>    <span class="keywordtype">int</span> status = 0;
<a name="l05160"></a>05160     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a>) {
<a name="l05161"></a>05161         status = pclose(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a>);
<a name="l05162"></a>05162     }
<a name="l05163"></a>05163     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> = -1;
<a name="l05164"></a>05164     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a> = 0;
<a name="l05165"></a>05165     <a class="code" href="../../db/d2e/intern_8h.html#ad71838efdb17238a892e8cece35351a7">rb_last_status_set</a>(status, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6080b18e6883f70d36a1c1554761ccfe">pid</a>);
<a name="l05166"></a>05166 <span class="preprocessor">#else</span>
<a name="l05167"></a>05167 <span class="preprocessor"></span>    <a class="code" href="../../df/d0a/io_8c.html#af3f583ba468c4669c27e4be2f7943abb">fptr_finalize</a>(fptr, noraise);
<a name="l05168"></a>05168 <span class="preprocessor">#endif</span>
<a name="l05169"></a>05169 <span class="preprocessor"></span>    <a class="code" href="../../df/d0a/io_8c.html#a8b21d130f714e845215a6995a10f55b0">pipe_del_fptr</a>(fptr);
<a name="l05170"></a>05170 }
<a name="l05171"></a>05171 <span class="preprocessor">#endif</span>
<a name="l05172"></a>05172 <span class="preprocessor"></span>
<a name="l05173"></a>05173 <span class="keywordtype">void</span>
<a name="l05174"></a><a class="code" href="../../df/d0a/io_8c.html#af6bb15db4332907f64ef509a5e84b1cb">05174</a> <a class="code" href="../../dc/dac/io_8h.html#aeb14fb21179cb04f2a87dec384f8236b">rb_io_synchronized</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l05175"></a>05175 {
<a name="l05176"></a>05176     <a class="code" href="../../dc/dac/io_8h.html#af5b8dfbd6b4a542196867145faaa35f5">rb_io_check_initialized</a>(fptr);
<a name="l05177"></a>05177     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> |= <a class="code" href="../../dc/dac/io_8h.html#a95a89e4b35429fb51d7c3e52ec405d90">FMODE_SYNC</a>;
<a name="l05178"></a>05178 }
<a name="l05179"></a>05179 
<a name="l05180"></a>05180 <span class="keywordtype">void</span>
<a name="l05181"></a><a class="code" href="../../df/d0a/io_8c.html#abe04ff3298ce217eb92c19be5da237ef">05181</a> <a class="code" href="../../df/d0a/io_8c.html#abe04ff3298ce217eb92c19be5da237ef">rb_io_unbuffered</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l05182"></a>05182 {
<a name="l05183"></a>05183     <a class="code" href="../../dc/dac/io_8h.html#aeb14fb21179cb04f2a87dec384f8236b">rb_io_synchronized</a>(fptr);
<a name="l05184"></a>05184 }
<a name="l05185"></a>05185 
<a name="l05186"></a>05186 <span class="keywordtype">int</span>
<a name="l05187"></a><a class="code" href="../../df/d0a/io_8c.html#abbfdd28892be7ef48b8c7f4fba55cbe4">05187</a> <a class="code" href="../../db/d2e/intern_8h.html#abbfdd28892be7ef48b8c7f4fba55cbe4">rb_pipe</a>(<span class="keywordtype">int</span> *pipes)
<a name="l05188"></a>05188 {
<a name="l05189"></a>05189     <span class="keywordtype">int</span> ret;
<a name="l05190"></a>05190     ret = pipe(pipes);
<a name="l05191"></a>05191     <span class="keywordflow">if</span> (ret == -1) {
<a name="l05192"></a>05192         <span class="keywordflow">if</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EMFILE || <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ENFILE) {
<a name="l05193"></a>05193             <a class="code" href="../../d8/d16/gc_8c.html#a7a12ca86b76e272a301173e7661acfea">rb_gc</a>();
<a name="l05194"></a>05194             ret = pipe(pipes);
<a name="l05195"></a>05195         }
<a name="l05196"></a>05196     }
<a name="l05197"></a>05197     <span class="keywordflow">if</span> (ret == 0) {
<a name="l05198"></a>05198         <a class="code" href="../../db/d2e/intern_8h.html#a6448f20b0936afe0cb85ab3186753db2">rb_update_max_fd</a>(pipes[0]);
<a name="l05199"></a>05199         <a class="code" href="../../db/d2e/intern_8h.html#a6448f20b0936afe0cb85ab3186753db2">rb_update_max_fd</a>(pipes[1]);
<a name="l05200"></a>05200     }
<a name="l05201"></a>05201     <span class="keywordflow">return</span> ret;
<a name="l05202"></a>05202 }
<a name="l05203"></a>05203 
<a name="l05204"></a>05204 <span class="preprocessor">#ifdef HAVE_FORK</span>
<a name="l05205"></a>05205 <span class="preprocessor"></span><span class="keyword">struct </span>popen_arg {
<a name="l05206"></a>05206     <span class="keyword">struct </span><a class="code" href="../../d2/d2e/structrb__exec__arg.html">rb_exec_arg</a> *execp;
<a name="l05207"></a>05207     <span class="keywordtype">int</span> modef;
<a name="l05208"></a>05208     <span class="keywordtype">int</span> pair[2];
<a name="l05209"></a>05209     <span class="keywordtype">int</span> write_pair[2];
<a name="l05210"></a>05210 };
<a name="l05211"></a>05211 
<a name="l05212"></a>05212 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l05213"></a>05213 popen_redirect(<span class="keyword">struct</span> popen_arg *p)
<a name="l05214"></a>05214 {
<a name="l05215"></a>05215     <span class="keywordflow">if</span> ((p-&gt;modef &amp; <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>) &amp;&amp; (p-&gt;modef &amp; <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>)) {
<a name="l05216"></a>05216         close(p-&gt;write_pair[1]);
<a name="l05217"></a>05217         <span class="keywordflow">if</span> (p-&gt;write_pair[0] != 0) {
<a name="l05218"></a>05218             <a class="code" href="../../d3/d90/missing_8h.html#a1a7dc1d5f4ee5da620088e280e4bc580">dup2</a>(p-&gt;write_pair[0], 0);
<a name="l05219"></a>05219             close(p-&gt;write_pair[0]);
<a name="l05220"></a>05220         }
<a name="l05221"></a>05221         close(p-&gt;pair[0]);
<a name="l05222"></a>05222         <span class="keywordflow">if</span> (p-&gt;pair[1] != 1) {
<a name="l05223"></a>05223             <a class="code" href="../../d3/d90/missing_8h.html#a1a7dc1d5f4ee5da620088e280e4bc580">dup2</a>(p-&gt;pair[1], 1);
<a name="l05224"></a>05224             close(p-&gt;pair[1]);
<a name="l05225"></a>05225         }
<a name="l05226"></a>05226     }
<a name="l05227"></a>05227     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;modef &amp; <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>) {
<a name="l05228"></a>05228         close(p-&gt;pair[0]);
<a name="l05229"></a>05229         <span class="keywordflow">if</span> (p-&gt;pair[1] != 1) {
<a name="l05230"></a>05230             <a class="code" href="../../d3/d90/missing_8h.html#a1a7dc1d5f4ee5da620088e280e4bc580">dup2</a>(p-&gt;pair[1], 1);
<a name="l05231"></a>05231             close(p-&gt;pair[1]);
<a name="l05232"></a>05232         }
<a name="l05233"></a>05233     }
<a name="l05234"></a>05234     <span class="keywordflow">else</span> {
<a name="l05235"></a>05235         close(p-&gt;pair[1]);
<a name="l05236"></a>05236         <span class="keywordflow">if</span> (p-&gt;pair[0] != 0) {
<a name="l05237"></a>05237             <a class="code" href="../../d3/d90/missing_8h.html#a1a7dc1d5f4ee5da620088e280e4bc580">dup2</a>(p-&gt;pair[0], 0);
<a name="l05238"></a>05238             close(p-&gt;pair[0]);
<a name="l05239"></a>05239         }
<a name="l05240"></a>05240     }
<a name="l05241"></a>05241 }
<a name="l05242"></a>05242 
<a name="l05243"></a>05243 <span class="keywordtype">void</span>
<a name="l05244"></a>05244 <a class="code" href="../../db/d2e/intern_8h.html#a906c25d86ff1eacd9c715d13dd18f8b3">rb_close_before_exec</a>(<span class="keywordtype">int</span> lowfd, <span class="keywordtype">int</span> maxhint, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> noclose_fds)
<a name="l05245"></a>05245 {
<a name="l05246"></a>05246     <span class="keywordtype">int</span> fd, ret;
<a name="l05247"></a>05247     <span class="keywordtype">int</span> <a class="code" href="../../d1/d6f/date__strftime_8c.html#aa5d960354774dc177393b360c0f90aa9">max</a> = <a class="code" href="../../df/d0a/io_8c.html#ac9e89b19f784faee13aa7cc81b3e4771">max_file_descriptor</a>;
<a name="l05248"></a>05248     <span class="keywordflow">if</span> (max &lt; maxhint)
<a name="l05249"></a>05249         max = maxhint;
<a name="l05250"></a>05250     <span class="keywordflow">for</span> (fd = lowfd; fd &lt;= max; fd++) {
<a name="l05251"></a>05251         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(noclose_fds) &amp;&amp;
<a name="l05252"></a>05252             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(<a class="code" href="../../d5/d9d/tcltklib_8c.html#aa6896905f9ab15ac1ea4ce9aec1df54b">rb_hash_lookup</a>(noclose_fds, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(fd))))
<a name="l05253"></a>05253             <span class="keywordflow">continue</span>;
<a name="l05254"></a>05254 <span class="preprocessor">#ifdef FD_CLOEXEC</span>
<a name="l05255"></a>05255 <span class="preprocessor"></span>        ret = <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fd, F_GETFD);
<a name="l05256"></a>05256         <span class="keywordflow">if</span> (ret != -1 &amp;&amp; !(ret &amp; FD_CLOEXEC)) {
<a name="l05257"></a>05257             <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fd, F_SETFD, ret|FD_CLOEXEC);
<a name="l05258"></a>05258         }
<a name="l05259"></a>05259 <span class="preprocessor">#else</span>
<a name="l05260"></a>05260 <span class="preprocessor"></span>        ret = close(fd);
<a name="l05261"></a>05261 <span class="preprocessor">#endif</span>
<a name="l05262"></a>05262 <span class="preprocessor"></span><span class="preprocessor">#define CONTIGUOUS_CLOSED_FDS 20</span>
<a name="l05263"></a>05263 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ret != -1) {
<a name="l05264"></a>05264             <span class="keywordflow">if</span> (max &lt; fd + CONTIGUOUS_CLOSED_FDS)
<a name="l05265"></a>05265                 max = fd + CONTIGUOUS_CLOSED_FDS;
<a name="l05266"></a>05266         }
<a name="l05267"></a>05267     }
<a name="l05268"></a>05268 }
<a name="l05269"></a>05269 
<a name="l05270"></a>05270 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l05271"></a>05271 popen_exec(<span class="keywordtype">void</span> *pp, <span class="keywordtype">char</span> *errmsg, <span class="keywordtype">size_t</span> errmsg_len)
<a name="l05272"></a>05272 {
<a name="l05273"></a>05273     <span class="keyword">struct </span>popen_arg *p = (<span class="keyword">struct </span>popen_arg*)pp;
<a name="l05274"></a>05274 
<a name="l05275"></a>05275     <a class="code" href="../../db/d2e/intern_8h.html#a9582c89e8f607363640a487f183431ab">rb_thread_atfork_before_exec</a>();
<a name="l05276"></a>05276     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#ae671912334aeff895e4c69a671ae9c7d">rb_exec_err</a>(p-&gt;execp, errmsg, errmsg_len);
<a name="l05277"></a>05277 }
<a name="l05278"></a>05278 <span class="preprocessor">#endif</span>
<a name="l05279"></a>05279 <span class="preprocessor"></span>
<a name="l05280"></a>05280 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l05281"></a><a class="code" href="../../df/d0a/io_8c.html#a7880b32edc2ee95a666f865cee2fb220">05281</a> <a class="code" href="../../df/d0a/io_8c.html#a7880b32edc2ee95a666f865cee2fb220">pipe_open</a>(<span class="keyword">struct</span> <a class="code" href="../../d2/d2e/structrb__exec__arg.html">rb_exec_arg</a> *eargp, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> prog, <span class="keyword">const</span> <span class="keywordtype">char</span> *modestr, <span class="keywordtype">int</span> fmode, <a class="code" href="../../df/d0a/io_8c.html#a8a7a37633499f91b42907cfd1ecea043">convconfig_t</a> *convconfig)
<a name="l05282"></a>05282 {
<a name="l05283"></a>05283     rb_pid_t pid = 0;
<a name="l05284"></a>05284     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l05285"></a>05285     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> port;
<a name="l05286"></a>05286     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *write_fptr;
<a name="l05287"></a>05287     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write_port;
<a name="l05288"></a>05288 <span class="preprocessor">#if defined(HAVE_FORK)</span>
<a name="l05289"></a>05289 <span class="preprocessor"></span>    <span class="keywordtype">int</span> status;
<a name="l05290"></a>05290     <span class="keyword">struct </span>popen_arg arg;
<a name="l05291"></a>05291     <span class="keywordtype">char</span> errmsg[80] = { <span class="charliteral">&apos;\0&apos;</span> };
<a name="l05292"></a>05292 <span class="preprocessor">#elif defined(_WIN32)</span>
<a name="l05293"></a>05293 <span class="preprocessor"></span>    <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> argbuf;
<a name="l05294"></a>05294     <span class="keywordtype">char</span> **<a class="code" href="../../d3/d09/ripper_8y.html#a8187411843a6284ffb964ef3fb9fcab3">args</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05295"></a>05295     <span class="keywordtype">int</span> pair[2], write_pair[2];
<a name="l05296"></a>05296 <span class="preprocessor">#endif</span>
<a name="l05297"></a>05297 <span class="preprocessor"></span><span class="preprocessor">#if !defined(HAVE_FORK)</span>
<a name="l05298"></a>05298 <span class="preprocessor"></span>    <span class="keyword">struct </span><a class="code" href="../../d2/d2e/structrb__exec__arg.html">rb_exec_arg</a> sarg;
<a name="l05299"></a>05299 <span class="preprocessor">#endif</span>
<a name="l05300"></a>05300 <span class="preprocessor"></span>    <a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *fp = 0;
<a name="l05301"></a>05301     <span class="keywordtype">int</span> fd = -1;
<a name="l05302"></a>05302     <span class="keywordtype">int</span> write_fd = -1;
<a name="l05303"></a>05303     <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd = 0;
<a name="l05304"></a>05304     <span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>;
<a name="l05305"></a>05305     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>;
<a name="l05306"></a>05306 
<a name="l05307"></a>05307     <span class="keywordflow">if</span> (prog)
<a name="l05308"></a>05308         cmd = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(prog);
<a name="l05309"></a>05309 
<a name="l05310"></a>05310     <span class="keywordflow">if</span> (!eargp) {
<a name="l05311"></a>05311         <span class="comment">/* fork : IO.popen(&quot;-&quot;) */</span>
<a name="l05312"></a>05312         argc = 0;
<a name="l05313"></a>05313         argv = 0;
<a name="l05314"></a>05314     }
<a name="l05315"></a>05315     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (eargp-&gt;<a class="code" href="../../d2/d2e/structrb__exec__arg.html#ae54227ed65d910f20031b5b00c437c52">argc</a>) {
<a name="l05316"></a>05316         <span class="comment">/* no shell : IO.popen([prog, arg0], arg1, ...) */</span>
<a name="l05317"></a>05317         argc = eargp-&gt;<a class="code" href="../../d2/d2e/structrb__exec__arg.html#ae54227ed65d910f20031b5b00c437c52">argc</a>;
<a name="l05318"></a>05318         argv = eargp-&gt;<a class="code" href="../../d2/d2e/structrb__exec__arg.html#ae3aba7a396cbc00d14f8c2e384250b1c">argv</a>;
<a name="l05319"></a>05319     }
<a name="l05320"></a>05320     <span class="keywordflow">else</span> {
<a name="l05321"></a>05321         <span class="comment">/* with shell : IO.popen(prog) */</span>
<a name="l05322"></a>05322         argc = 0;
<a name="l05323"></a>05323         argv = 0;
<a name="l05324"></a>05324     }
<a name="l05325"></a>05325 
<a name="l05326"></a>05326 <span class="preprocessor">#if defined(HAVE_FORK)</span>
<a name="l05327"></a>05327 <span class="preprocessor"></span>    arg.execp = eargp;
<a name="l05328"></a>05328     arg.modef = fmode;
<a name="l05329"></a>05329     arg.pair[0] = arg.pair[1] = -1;
<a name="l05330"></a>05330     arg.write_pair[0] = arg.write_pair[1] = -1;
<a name="l05331"></a>05331     <span class="keywordflow">switch</span> (fmode &amp; (<a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>|<a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>)) {
<a name="l05332"></a>05332       <span class="keywordflow">case</span> <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>|<a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>:
<a name="l05333"></a>05333         <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#abbfdd28892be7ef48b8c7f4fba55cbe4">rb_pipe</a>(arg.write_pair) &lt; 0)
<a name="l05334"></a>05334             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(cmd);
<a name="l05335"></a>05335         <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#abbfdd28892be7ef48b8c7f4fba55cbe4">rb_pipe</a>(arg.pair) &lt; 0) {
<a name="l05336"></a>05336             <span class="keywordtype">int</span> e = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l05337"></a>05337             close(arg.write_pair[0]);
<a name="l05338"></a>05338             close(arg.write_pair[1]);
<a name="l05339"></a>05339             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = e;
<a name="l05340"></a>05340             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(cmd);
<a name="l05341"></a>05341         }
<a name="l05342"></a>05342         <span class="keywordflow">if</span> (eargp) {
<a name="l05343"></a>05343             <a class="code" href="../../db/d2e/intern_8h.html#aa6fa6085812c6b4e48e0a757044f1b93">rb_exec_arg_addopt</a>(eargp, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(arg.write_pair[0]));
<a name="l05344"></a>05344             <a class="code" href="../../db/d2e/intern_8h.html#aa6fa6085812c6b4e48e0a757044f1b93">rb_exec_arg_addopt</a>(eargp, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(1), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(arg.pair[1]));
<a name="l05345"></a>05345         }
<a name="l05346"></a>05346         <span class="keywordflow">break</span>;
<a name="l05347"></a>05347       <span class="keywordflow">case</span> <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>:
<a name="l05348"></a>05348         <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#abbfdd28892be7ef48b8c7f4fba55cbe4">rb_pipe</a>(arg.pair) &lt; 0)
<a name="l05349"></a>05349             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(cmd);
<a name="l05350"></a>05350         <span class="keywordflow">if</span> (eargp)
<a name="l05351"></a>05351             <a class="code" href="../../db/d2e/intern_8h.html#aa6fa6085812c6b4e48e0a757044f1b93">rb_exec_arg_addopt</a>(eargp, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(1), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(arg.pair[1]));
<a name="l05352"></a>05352         <span class="keywordflow">break</span>;
<a name="l05353"></a>05353       <span class="keywordflow">case</span> <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>:
<a name="l05354"></a>05354         <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#abbfdd28892be7ef48b8c7f4fba55cbe4">rb_pipe</a>(arg.pair) &lt; 0)
<a name="l05355"></a>05355             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(cmd);
<a name="l05356"></a>05356         <span class="keywordflow">if</span> (eargp)
<a name="l05357"></a>05357             <a class="code" href="../../db/d2e/intern_8h.html#aa6fa6085812c6b4e48e0a757044f1b93">rb_exec_arg_addopt</a>(eargp, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(arg.pair[0]));
<a name="l05358"></a>05358         <span class="keywordflow">break</span>;
<a name="l05359"></a>05359       <span class="keywordflow">default</span>:
<a name="l05360"></a>05360         <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(cmd);
<a name="l05361"></a>05361     }
<a name="l05362"></a>05362     <span class="keywordflow">if</span> (eargp) {
<a name="l05363"></a>05363         <a class="code" href="../../db/d2e/intern_8h.html#afb05b4454d318d77a5dc55df7c87fb8b">rb_exec_arg_fixup</a>(arg.execp);
<a name="l05364"></a>05364         pid = <a class="code" href="../../db/d2e/intern_8h.html#a490c498df3b006bb2a6c818f1d0b92b9">rb_fork_err</a>(&amp;status, popen_exec, &amp;arg, arg.execp-&gt;redirect_fds, errmsg, <span class="keyword">sizeof</span>(errmsg));
<a name="l05365"></a>05365     }
<a name="l05366"></a>05366     <span class="keywordflow">else</span> {
<a name="l05367"></a>05367         fflush(stdin);          <span class="comment">/* is it really needed? */</span>
<a name="l05368"></a>05368         pid = <a class="code" href="../../db/d2e/intern_8h.html#ae20112f6c2c89dd8f9590587917c204f">rb_fork</a>(&amp;status, 0, 0, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l05369"></a>05369         <span class="keywordflow">if</span> (pid == 0) {         <span class="comment">/* child */</span>
<a name="l05370"></a>05370             <a class="code" href="../../db/d2e/intern_8h.html#abd6f8148f90fefcd84afa732cefc2965">rb_thread_atfork</a>();
<a name="l05371"></a>05371             popen_redirect(&amp;arg);
<a name="l05372"></a>05372             <a class="code" href="../../dc/dac/io_8h.html#aeb14fb21179cb04f2a87dec384f8236b">rb_io_synchronized</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(<a class="code" href="../../df/d0a/io_8c.html#a51b183f14dd2be4d72bc7f5a9c5af041">orig_stdout</a>)-&gt;fptr);
<a name="l05373"></a>05373             <a class="code" href="../../dc/dac/io_8h.html#aeb14fb21179cb04f2a87dec384f8236b">rb_io_synchronized</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(<a class="code" href="../../df/d0a/io_8c.html#acf8024d5428fdf61c44bea5ed3e40b55">orig_stderr</a>)-&gt;fptr);
<a name="l05374"></a>05374             <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l05375"></a>05375         }
<a name="l05376"></a>05376     }
<a name="l05377"></a>05377 
<a name="l05378"></a>05378     <span class="comment">/* parent */</span>
<a name="l05379"></a>05379     <span class="keywordflow">if</span> (pid == -1) {
<a name="l05380"></a>05380         <span class="keywordtype">int</span> e = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l05381"></a>05381         close(arg.pair[0]);
<a name="l05382"></a>05382         close(arg.pair[1]);
<a name="l05383"></a>05383         <span class="keywordflow">if</span> ((fmode &amp; (<a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>|<a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>)) == (<a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>|<a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>)) {
<a name="l05384"></a>05384             close(arg.write_pair[0]);
<a name="l05385"></a>05385             close(arg.write_pair[1]);
<a name="l05386"></a>05386         }
<a name="l05387"></a>05387         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = e;
<a name="l05388"></a>05388         <span class="keywordflow">if</span> (errmsg[0])
<a name="l05389"></a>05389             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(errmsg);
<a name="l05390"></a>05390         <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(cmd);
<a name="l05391"></a>05391     }
<a name="l05392"></a>05392     <span class="keywordflow">if</span> ((fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>) &amp;&amp; (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>)) {
<a name="l05393"></a>05393         close(arg.pair[1]);
<a name="l05394"></a>05394         fd = arg.pair[0];
<a name="l05395"></a>05395         close(arg.write_pair[0]);
<a name="l05396"></a>05396         write_fd = arg.write_pair[1];
<a name="l05397"></a>05397     }
<a name="l05398"></a>05398     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fmode &amp; FMODE_READABLE) {
<a name="l05399"></a>05399         close(arg.pair[1]);
<a name="l05400"></a>05400         fd = arg.pair[0];
<a name="l05401"></a>05401     }
<a name="l05402"></a>05402     <span class="keywordflow">else</span> {
<a name="l05403"></a>05403         close(arg.pair[0]);
<a name="l05404"></a>05404         fd = arg.pair[1];
<a name="l05405"></a>05405     }
<a name="l05406"></a>05406 <span class="preprocessor">#elif defined(_WIN32)</span>
<a name="l05407"></a>05407 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (argc) {
<a name="l05408"></a>05408         <span class="keywordtype">int</span> i;
<a name="l05409"></a>05409 
<a name="l05410"></a>05410         <span class="keywordflow">if</span> (argc &gt;= (<span class="keywordtype">int</span>)(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ab1040c5fdcb7a88dca4c25222bf43454">FIXNUM_MAX</a> / <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *))) {
<a name="l05411"></a>05411             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;too many arguments&quot;</span>);
<a name="l05412"></a>05412         }
<a name="l05413"></a>05413         argbuf = <a class="code" href="../../db/d2e/intern_8h.html#a9c93a5402138185ceff87cb1f483c4f5">rb_str_tmp_new</a>((argc+1) * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *));
<a name="l05414"></a>05414         args = (<span class="keywordtype">void</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(argbuf);
<a name="l05415"></a>05415         <span class="keywordflow">for</span> (i = 0; i &lt; argc; ++i) {
<a name="l05416"></a>05416             args[i] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(argv[i]);
<a name="l05417"></a>05417         }
<a name="l05418"></a>05418         args[i] = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l05419"></a>05419     }
<a name="l05420"></a>05420     <span class="keywordflow">switch</span> (fmode &amp; (FMODE_READABLE|FMODE_WRITABLE)) {
<a name="l05421"></a>05421       <span class="keywordflow">case</span> FMODE_READABLE|FMODE_WRITABLE:
<a name="l05422"></a>05422         <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#abbfdd28892be7ef48b8c7f4fba55cbe4">rb_pipe</a>(write_pair) &lt; 0)
<a name="l05423"></a>05423             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(cmd);
<a name="l05424"></a>05424         <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#abbfdd28892be7ef48b8c7f4fba55cbe4">rb_pipe</a>(pair) &lt; 0) {
<a name="l05425"></a>05425             <span class="keywordtype">int</span> e = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l05426"></a>05426             close(write_pair[0]);
<a name="l05427"></a>05427             close(write_pair[1]);
<a name="l05428"></a>05428             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = e;
<a name="l05429"></a>05429             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(cmd);
<a name="l05430"></a>05430         }
<a name="l05431"></a>05431         <span class="keywordflow">if</span> (eargp) {
<a name="l05432"></a>05432             <a class="code" href="../../db/d2e/intern_8h.html#aa6fa6085812c6b4e48e0a757044f1b93">rb_exec_arg_addopt</a>(eargp, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(write_pair[0]));
<a name="l05433"></a>05433             <a class="code" href="../../db/d2e/intern_8h.html#aa6fa6085812c6b4e48e0a757044f1b93">rb_exec_arg_addopt</a>(eargp, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(1), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(pair[1]));
<a name="l05434"></a>05434         }
<a name="l05435"></a>05435         <span class="keywordflow">break</span>;
<a name="l05436"></a>05436       <span class="keywordflow">case</span> FMODE_READABLE:
<a name="l05437"></a>05437         <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#abbfdd28892be7ef48b8c7f4fba55cbe4">rb_pipe</a>(pair) &lt; 0)
<a name="l05438"></a>05438             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(cmd);
<a name="l05439"></a>05439         <span class="keywordflow">if</span> (eargp)
<a name="l05440"></a>05440             <a class="code" href="../../db/d2e/intern_8h.html#aa6fa6085812c6b4e48e0a757044f1b93">rb_exec_arg_addopt</a>(eargp, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(1), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(pair[1]));
<a name="l05441"></a>05441         <span class="keywordflow">break</span>;
<a name="l05442"></a>05442       <span class="keywordflow">case</span> FMODE_WRITABLE:
<a name="l05443"></a>05443         <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#abbfdd28892be7ef48b8c7f4fba55cbe4">rb_pipe</a>(pair) &lt; 0)
<a name="l05444"></a>05444             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(cmd);
<a name="l05445"></a>05445         <span class="keywordflow">if</span> (eargp)
<a name="l05446"></a>05446             <a class="code" href="../../db/d2e/intern_8h.html#aa6fa6085812c6b4e48e0a757044f1b93">rb_exec_arg_addopt</a>(eargp, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(pair[0]));
<a name="l05447"></a>05447         <span class="keywordflow">break</span>;
<a name="l05448"></a>05448       <span class="keywordflow">default</span>:
<a name="l05449"></a>05449         <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(cmd);
<a name="l05450"></a>05450     }
<a name="l05451"></a>05451     <span class="keywordflow">if</span> (eargp) {
<a name="l05452"></a>05452         <a class="code" href="../../db/d2e/intern_8h.html#afb05b4454d318d77a5dc55df7c87fb8b">rb_exec_arg_fixup</a>(eargp);
<a name="l05453"></a>05453         <a class="code" href="../../db/d2e/intern_8h.html#ac1c2bbac9bb73f2f91a00d619c10b8b8">rb_run_exec_options</a>(eargp, &amp;sarg);
<a name="l05454"></a>05454     }
<a name="l05455"></a>05455     <span class="keywordflow">while</span> ((pid = (args ?
<a name="l05456"></a>05456                    <a class="code" href="../../dc/db1/win32_8h.html#a4d7623fc5298f802f41339ee53761064">rb_w32_aspawn</a>(<a class="code" href="../../d0/d85/process_8c.html#adbf992dd8dead36444b76290025d0ac9">P_NOWAIT</a>, cmd, args) :
<a name="l05457"></a>05457                    <a class="code" href="../../dc/db1/win32_8h.html#ae94bfda820ed3539b29e9fdba5babdb7">rb_w32_spawn</a>(<a class="code" href="../../d0/d85/process_8c.html#adbf992dd8dead36444b76290025d0ac9">P_NOWAIT</a>, cmd, 0))) == -1) {
<a name="l05458"></a>05458         <span class="comment">/* exec failed */</span>
<a name="l05459"></a>05459         <span class="keywordflow">switch</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l05460"></a>05460           <span class="keywordflow">case</span> EAGAIN:
<a name="l05461"></a>05461 <span class="preprocessor">#if defined(EWOULDBLOCK) &amp;&amp; EWOULDBLOCK != EAGAIN</span>
<a name="l05462"></a>05462 <span class="preprocessor"></span>          <span class="keywordflow">case</span> <a class="code" href="../../dd/d8c/rubysocket_8h.html#a4a3a0b3605fd3b2336455062ee8e25f0">EWOULDBLOCK</a>:
<a name="l05463"></a>05463 <span class="preprocessor">#endif</span>
<a name="l05464"></a>05464 <span class="preprocessor"></span>            <a class="code" href="../../db/d2e/intern_8h.html#ad16a381d26668f09e4fb85cb89f79ddd">rb_thread_sleep</a>(1);
<a name="l05465"></a>05465             <span class="keywordflow">break</span>;
<a name="l05466"></a>05466           <span class="keywordflow">default</span>:
<a name="l05467"></a>05467             {
<a name="l05468"></a>05468                 <span class="keywordtype">int</span> e = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l05469"></a>05469                 <span class="keywordflow">if</span> (eargp)
<a name="l05470"></a>05470                     <a class="code" href="../../db/d2e/intern_8h.html#ac1c2bbac9bb73f2f91a00d619c10b8b8">rb_run_exec_options</a>(&amp;sarg, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05471"></a>05471                 close(pair[0]);
<a name="l05472"></a>05472                 close(pair[1]);
<a name="l05473"></a>05473                 <span class="keywordflow">if</span> ((fmode &amp; (FMODE_READABLE|FMODE_WRITABLE)) == (FMODE_READABLE|FMODE_WRITABLE)) {
<a name="l05474"></a>05474                     close(write_pair[0]);
<a name="l05475"></a>05475                     close(write_pair[1]);
<a name="l05476"></a>05476                 }
<a name="l05477"></a>05477                 <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = e;
<a name="l05478"></a>05478                 <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(cmd);
<a name="l05479"></a>05479             }
<a name="l05480"></a>05480             <span class="keywordflow">break</span>;
<a name="l05481"></a>05481         }
<a name="l05482"></a>05482     }
<a name="l05483"></a>05483 
<a name="l05484"></a>05484     <a class="code" href="../../d8/df4/generator_8h.html#ad2bf389f3fddea7bd3befa162c70561a">RB_GC_GUARD</a>(argbuf);
<a name="l05485"></a>05485 
<a name="l05486"></a>05486     <span class="keywordflow">if</span> (eargp)
<a name="l05487"></a>05487         <a class="code" href="../../db/d2e/intern_8h.html#ac1c2bbac9bb73f2f91a00d619c10b8b8">rb_run_exec_options</a>(&amp;sarg, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05488"></a>05488     <span class="keywordflow">if</span> ((fmode &amp; FMODE_READABLE) &amp;&amp; (fmode &amp; FMODE_WRITABLE)) {
<a name="l05489"></a>05489         close(pair[1]);
<a name="l05490"></a>05490         fd = pair[0];
<a name="l05491"></a>05491         close(write_pair[0]);
<a name="l05492"></a>05492         write_fd = write_pair[1];
<a name="l05493"></a>05493     }
<a name="l05494"></a>05494     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fmode &amp; FMODE_READABLE) {
<a name="l05495"></a>05495         close(pair[1]);
<a name="l05496"></a>05496         fd = pair[0];
<a name="l05497"></a>05497     }
<a name="l05498"></a>05498     <span class="keywordflow">else</span> {
<a name="l05499"></a>05499         close(pair[0]);
<a name="l05500"></a>05500         fd = pair[1];
<a name="l05501"></a>05501     }
<a name="l05502"></a>05502 <span class="preprocessor">#else</span>
<a name="l05503"></a>05503 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (argc) {
<a name="l05504"></a>05504         prog = <a class="code" href="../../dc/dcc/array_8c.html#af4d478d63ee15a20ca0d9aee90ea04db">rb_ary_join</a>(<a class="code" href="../../dc/dcc/array_8c.html#a575a99eebf6ce65893ed83c2b6783d2d">rb_ary_new4</a>(argc, argv), <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot; &quot;</span>));
<a name="l05505"></a>05505         cmd = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(prog);
<a name="l05506"></a>05506     }
<a name="l05507"></a>05507     <span class="keywordflow">if</span> (eargp) {
<a name="l05508"></a>05508         <a class="code" href="../../db/d2e/intern_8h.html#afb05b4454d318d77a5dc55df7c87fb8b">rb_exec_arg_fixup</a>(eargp);
<a name="l05509"></a>05509         <a class="code" href="../../db/d2e/intern_8h.html#ac1c2bbac9bb73f2f91a00d619c10b8b8">rb_run_exec_options</a>(eargp, &amp;sarg);
<a name="l05510"></a>05510     }
<a name="l05511"></a>05511     fp = popen(cmd, modestr);
<a name="l05512"></a>05512     <span class="keywordflow">if</span> (eargp)
<a name="l05513"></a>05513         <a class="code" href="../../db/d2e/intern_8h.html#ac1c2bbac9bb73f2f91a00d619c10b8b8">rb_run_exec_options</a>(&amp;sarg, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l05514"></a>05514     <span class="keywordflow">if</span> (!fp) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(prog);
<a name="l05515"></a>05515     fd = <a class="code" href="../../da/d50/vsnprintf_8c.html#a7aa82a32f4ad97a0107302dae80a2b1e">fileno</a>(fp);
<a name="l05516"></a>05516 <span class="preprocessor">#endif</span>
<a name="l05517"></a>05517 <span class="preprocessor"></span>
<a name="l05518"></a>05518     port = <a class="code" href="../../df/d0a/io_8c.html#a47f57cf9a8f65858e5cfe7ed56cc65bb">io_alloc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>);
<a name="l05519"></a>05519     <a class="code" href="../../dc/dac/io_8h.html#a806072dc06b95702f12c2d59e815cfde">MakeOpenFile</a>(port, fptr);
<a name="l05520"></a>05520     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> = fd;
<a name="l05521"></a>05521     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a> = fp;
<a name="l05522"></a>05522     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> = fmode | <a class="code" href="../../dc/dac/io_8h.html#a95a89e4b35429fb51d7c3e52ec405d90">FMODE_SYNC</a>|<a class="code" href="../../dc/dac/io_8h.html#a7bba3fe65c0f4b33d346273792dddade">FMODE_DUPLEX</a>;
<a name="l05523"></a>05523     <span class="keywordflow">if</span> (convconfig) {
<a name="l05524"></a>05524         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a> = *convconfig;
<a name="l05525"></a>05525 <span class="preprocessor">#if defined(RUBY_TEST_CRLF_ENVIRONMENT) || defined(_WIN32)</span>
<a name="l05526"></a>05526 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#afae8969f13c765a2a96d810d7049543a">ECONV_DEFAULT_NEWLINE_DECORATOR</a>) {
<a name="l05527"></a>05527             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags |= <a class="code" href="../../d5/de3/encoding_8h.html#a122d5f3118774ae1a01a3262c73141eb">ECONV_UNIVERSAL_NEWLINE_DECORATOR</a>;
<a name="l05528"></a>05528         }
<a name="l05529"></a>05529 <span class="preprocessor">#endif</span>
<a name="l05530"></a>05530 <span class="preprocessor"></span>    }
<a name="l05531"></a>05531     <span class="keywordflow">else</span> {
<a name="l05532"></a>05532         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a8a6ac07e9b2ef3f2e60b2f16f62196c3">NEED_NEWLINE_DECORATOR_ON_READ</a>(fptr)) {
<a name="l05533"></a>05533             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags |= <a class="code" href="../../d5/de3/encoding_8h.html#a122d5f3118774ae1a01a3262c73141eb">ECONV_UNIVERSAL_NEWLINE_DECORATOR</a>;
<a name="l05534"></a>05534         }
<a name="l05535"></a>05535 <span class="preprocessor">#ifdef TEXTMODE_NEWLINE_DECORATOR_ON_WRITE</span>
<a name="l05536"></a>05536 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a6a84cf10d61a56a22488349a6b0d3b23">NEED_NEWLINE_DECORATOR_ON_WRITE</a>(fptr)) {
<a name="l05537"></a>05537             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags |= TEXTMODE_NEWLINE_DECORATOR_ON_WRITE;
<a name="l05538"></a>05538         }
<a name="l05539"></a>05539 <span class="preprocessor">#endif</span>
<a name="l05540"></a>05540 <span class="preprocessor"></span>    }
<a name="l05541"></a>05541     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6080b18e6883f70d36a1c1554761ccfe">pid</a> = pid;
<a name="l05542"></a>05542 
<a name="l05543"></a>05543     <span class="keywordflow">if</span> (0 &lt;= write_fd) {
<a name="l05544"></a>05544         write_port = <a class="code" href="../../df/d0a/io_8c.html#a47f57cf9a8f65858e5cfe7ed56cc65bb">io_alloc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>);
<a name="l05545"></a>05545         <a class="code" href="../../dc/dac/io_8h.html#a806072dc06b95702f12c2d59e815cfde">MakeOpenFile</a>(write_port, write_fptr);
<a name="l05546"></a>05546         write_fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> = write_fd;
<a name="l05547"></a>05547         write_fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> = (fmode &amp; ~FMODE_READABLE)| <a class="code" href="../../dc/dac/io_8h.html#a95a89e4b35429fb51d7c3e52ec405d90">FMODE_SYNC</a>|<a class="code" href="../../dc/dac/io_8h.html#a7bba3fe65c0f4b33d346273792dddade">FMODE_DUPLEX</a>;
<a name="l05548"></a>05548         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp;= ~FMODE_WRITABLE;
<a name="l05549"></a>05549         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ad4507dbb812bff2064ead59f235039c2">tied_io_for_writing</a> = write_port;
<a name="l05550"></a>05550         <a class="code" href="../../db/d2e/intern_8h.html#acee88ad0375c8a9080e2283db494d257">rb_ivar_set</a>(port, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;@tied_io_for_writing&quot;</span>), write_port);
<a name="l05551"></a>05551     }
<a name="l05552"></a>05552 
<a name="l05553"></a>05553 <span class="preprocessor">#if defined (__CYGWIN__) || !defined(HAVE_FORK)</span>
<a name="l05554"></a>05554 <span class="preprocessor"></span>    fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a5a2f6f866626d12df82f61cf98401f8c">finalize</a> = <a class="code" href="../../df/d0a/io_8c.html#a6467635964aaf761d2ac9169d217ee63">pipe_finalize</a>;
<a name="l05555"></a>05555     <a class="code" href="../../df/d0a/io_8c.html#a6cee254cfd59ee0a24dc3872fc46de2a">pipe_add_fptr</a>(fptr);
<a name="l05556"></a>05556 <span class="preprocessor">#endif</span>
<a name="l05557"></a>05557 <span class="preprocessor"></span>    <span class="keywordflow">return</span> port;
<a name="l05558"></a>05558 }
<a name="l05559"></a>05559 
<a name="l05560"></a>05560 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l05561"></a><a class="code" href="../../df/d0a/io_8c.html#a152ce988be406926c5d6cdcfde82703e">05561</a> <a class="code" href="../../df/d0a/io_8c.html#a152ce988be406926c5d6cdcfde82703e">pipe_open_v</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *modestr, <span class="keywordtype">int</span> fmode, <a class="code" href="../../df/d0a/io_8c.html#a8a7a37633499f91b42907cfd1ecea043">convconfig_t</a> *convconfig)
<a name="l05562"></a>05562 {
<a name="l05563"></a>05563     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d2/d2e/structrb__exec__arg.html#a04616bee431c76d99d7afe37d8361414">prog</a>;
<a name="l05564"></a>05564     <span class="keyword">struct </span><a class="code" href="../../d2/d2e/structrb__exec__arg.html">rb_exec_arg</a> earg;
<a name="l05565"></a>05565     prog = <a class="code" href="../../db/d2e/intern_8h.html#a11acd0c774afcafdb5b3bce4a7446566">rb_exec_arg_init</a>(argc, argv, <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>, &amp;earg);
<a name="l05566"></a>05566     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a7880b32edc2ee95a666f865cee2fb220">pipe_open</a>(&amp;earg, prog, modestr, fmode, convconfig);
<a name="l05567"></a>05567 }
<a name="l05568"></a>05568 
<a name="l05569"></a>05569 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l05570"></a><a class="code" href="../../df/d0a/io_8c.html#a9246eb91d966de94aff31ef562e051e9">05570</a> <a class="code" href="../../df/d0a/io_8c.html#a9246eb91d966de94aff31ef562e051e9">pipe_open_s</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d2/d2e/structrb__exec__arg.html#a04616bee431c76d99d7afe37d8361414">prog</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *modestr, <span class="keywordtype">int</span> fmode, <a class="code" href="../../df/d0a/io_8c.html#a8a7a37633499f91b42907cfd1ecea043">convconfig_t</a> *convconfig)
<a name="l05571"></a>05571 {
<a name="l05572"></a>05572     <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(prog);
<a name="l05573"></a>05573     <span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a> = 1;
<a name="l05574"></a>05574     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a> = &amp;prog;
<a name="l05575"></a>05575     <span class="keyword">struct </span><a class="code" href="../../d2/d2e/structrb__exec__arg.html">rb_exec_arg</a> earg;
<a name="l05576"></a>05576 
<a name="l05577"></a>05577     <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(prog) == 1 &amp;&amp; cmd[0] == <span class="charliteral">&apos;-&apos;</span>) {
<a name="l05578"></a>05578 <span class="preprocessor">#if !defined(HAVE_FORK)</span>
<a name="l05579"></a>05579 <span class="preprocessor"></span>        <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a1f4044eeff81eb1676037771628b555c">rb_eNotImpError</a>,
<a name="l05580"></a>05580                  <span class="stringliteral">&quot;fork() function is unimplemented on this machine&quot;</span>);
<a name="l05581"></a>05581 <span class="preprocessor">#endif</span>
<a name="l05582"></a>05582 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a7880b32edc2ee95a666f865cee2fb220">pipe_open</a>(0, 0, modestr, fmode, convconfig);
<a name="l05583"></a>05583     }
<a name="l05584"></a>05584 
<a name="l05585"></a>05585     <a class="code" href="../../db/d2e/intern_8h.html#a11acd0c774afcafdb5b3bce4a7446566">rb_exec_arg_init</a>(argc, argv, <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>, &amp;earg);
<a name="l05586"></a>05586     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a7880b32edc2ee95a666f865cee2fb220">pipe_open</a>(&amp;earg, prog, modestr, fmode, convconfig);
<a name="l05587"></a>05587 }
<a name="l05588"></a>05588 
<a name="l05589"></a>05589 <span class="comment">/*</span>
<a name="l05590"></a>05590 <span class="comment"> *  call-seq:</span>
<a name="l05591"></a>05591 <span class="comment"> *     IO.popen(cmd, mode=&quot;r&quot; [, opt])               -&gt; io</span>
<a name="l05592"></a>05592 <span class="comment"> *     IO.popen(cmd, mode=&quot;r&quot; [, opt]) {|io| block } -&gt; obj</span>
<a name="l05593"></a>05593 <span class="comment"> *</span>
<a name="l05594"></a>05594 <span class="comment"> *  Runs the specified command as a subprocess; the subprocess&apos;s</span>
<a name="l05595"></a>05595 <span class="comment"> *  standard input and output will be connected to the returned</span>
<a name="l05596"></a>05596 <span class="comment"> *  &lt;code&gt;IO&lt;/code&gt; object.</span>
<a name="l05597"></a>05597 <span class="comment"> *</span>
<a name="l05598"></a>05598 <span class="comment"> *  The PID of the started process can be obtained by IO#pid method.</span>
<a name="l05599"></a>05599 <span class="comment"> *</span>
<a name="l05600"></a>05600 <span class="comment"> *  _cmd_ is a string or an array as follows.</span>
<a name="l05601"></a>05601 <span class="comment"> *</span>
<a name="l05602"></a>05602 <span class="comment"> *    cmd:</span>
<a name="l05603"></a>05603 <span class="comment"> *      &quot;-&quot;                                      : fork</span>
<a name="l05604"></a>05604 <span class="comment"> *      commandline                              : command line string which is passed to a shell</span>
<a name="l05605"></a>05605 <span class="comment"> *      [env, cmdname, arg1, ..., opts]          : command name and zero or more arguments (no shell)</span>
<a name="l05606"></a>05606 <span class="comment"> *      [env, [cmdname, argv0], arg1, ..., opts] : command name, argv[0] and zero or more arguments (no shell)</span>
<a name="l05607"></a>05607 <span class="comment"> *    (env and opts are optional.)</span>
<a name="l05608"></a>05608 <span class="comment"> *</span>
<a name="l05609"></a>05609 <span class="comment"> *  If _cmd_ is a +String+ ``&lt;code&gt;-&lt;/code&gt;&apos;&apos;,</span>
<a name="l05610"></a>05610 <span class="comment"> *  then a new instance of Ruby is started as the subprocess.</span>
<a name="l05611"></a>05611 <span class="comment"> *</span>
<a name="l05612"></a>05612 <span class="comment"> *  If &lt;i&gt;cmd&lt;/i&gt; is an +Array+ of +String+,</span>
<a name="l05613"></a>05613 <span class="comment"> *  then it will be used as the subprocess&apos;s +argv+ bypassing a shell.</span>
<a name="l05614"></a>05614 <span class="comment"> *  The array can contains a hash at first for environments and</span>
<a name="l05615"></a>05615 <span class="comment"> *  a hash at last for options similar to &lt;code&gt;spawn&lt;/code&gt;.</span>
<a name="l05616"></a>05616 <span class="comment"> *</span>
<a name="l05617"></a>05617 <span class="comment"> *  The default mode for the new file object is ``r&apos;&apos;,</span>
<a name="l05618"></a>05618 <span class="comment"> *  but &lt;i&gt;mode&lt;/i&gt; may be set to any of the modes listed in the description for class IO.</span>
<a name="l05619"></a>05619 <span class="comment"> *  The last argument &lt;i&gt;opt&lt;/i&gt; qualifies &lt;i&gt;mode&lt;/i&gt;.</span>
<a name="l05620"></a>05620 <span class="comment"> *</span>
<a name="l05621"></a>05621 <span class="comment"> *    # set IO encoding</span>
<a name="l05622"></a>05622 <span class="comment"> *    IO.popen(&quot;nkf -e filename&quot;, :external_encoding=&gt;&quot;EUC-JP&quot;) {|nkf_io|</span>
<a name="l05623"></a>05623 <span class="comment"> *      euc_jp_string = nkf_io.read</span>
<a name="l05624"></a>05624 <span class="comment"> *    }</span>
<a name="l05625"></a>05625 <span class="comment"> *</span>
<a name="l05626"></a>05626 <span class="comment"> *    # merge standard output and standard error using</span>
<a name="l05627"></a>05627 <span class="comment"> *    # spawn option.  See the document of Kernel.spawn.</span>
<a name="l05628"></a>05628 <span class="comment"> *    IO.popen([&quot;ls&quot;, &quot;/&quot;, :err=&gt;[:child, :out]]) {|ls_io|</span>
<a name="l05629"></a>05629 <span class="comment"> *      ls_result_with_error = ls_io.read</span>
<a name="l05630"></a>05630 <span class="comment"> *    }</span>
<a name="l05631"></a>05631 <span class="comment"> *</span>
<a name="l05632"></a>05632 <span class="comment"> *  Raises exceptions which &lt;code&gt;IO.pipe&lt;/code&gt; and</span>
<a name="l05633"></a>05633 <span class="comment"> *  &lt;code&gt;Kernel.spawn&lt;/code&gt; raise.</span>
<a name="l05634"></a>05634 <span class="comment"> *</span>
<a name="l05635"></a>05635 <span class="comment"> *  If a block is given, Ruby will run the command as a child connected</span>
<a name="l05636"></a>05636 <span class="comment"> *  to Ruby with a pipe. Ruby&apos;s end of the pipe will be passed as a</span>
<a name="l05637"></a>05637 <span class="comment"> *  parameter to the block.</span>
<a name="l05638"></a>05638 <span class="comment"> *  At the end of block, Ruby close the pipe and sets &lt;code&gt;$?&lt;/code&gt;.</span>
<a name="l05639"></a>05639 <span class="comment"> *  In this case &lt;code&gt;IO.popen&lt;/code&gt; returns</span>
<a name="l05640"></a>05640 <span class="comment"> *  the value of the block.</span>
<a name="l05641"></a>05641 <span class="comment"> *</span>
<a name="l05642"></a>05642 <span class="comment"> *  If a block is given with a _cmd_ of ``&lt;code&gt;-&lt;/code&gt;&apos;&apos;,</span>
<a name="l05643"></a>05643 <span class="comment"> *  the block will be run in two separate processes: once in the parent,</span>
<a name="l05644"></a>05644 <span class="comment"> *  and once in a child. The parent process will be passed the pipe</span>
<a name="l05645"></a>05645 <span class="comment"> *  object as a parameter to the block, the child version of the block</span>
<a name="l05646"></a>05646 <span class="comment"> *  will be passed &lt;code&gt;nil&lt;/code&gt;, and the child&apos;s standard in and</span>
<a name="l05647"></a>05647 <span class="comment"> *  standard out will be connected to the parent through the pipe. Not</span>
<a name="l05648"></a>05648 <span class="comment"> *  available on all platforms.</span>
<a name="l05649"></a>05649 <span class="comment"> *</span>
<a name="l05650"></a>05650 <span class="comment"> *     f = IO.popen(&quot;uname&quot;)</span>
<a name="l05651"></a>05651 <span class="comment"> *     p f.readlines</span>
<a name="l05652"></a>05652 <span class="comment"> *     f.close</span>
<a name="l05653"></a>05653 <span class="comment"> *     puts &quot;Parent is #{Process.pid}&quot;</span>
<a name="l05654"></a>05654 <span class="comment"> *     IO.popen(&quot;date&quot;) { |f| puts f.gets }</span>
<a name="l05655"></a>05655 <span class="comment"> *     IO.popen(&quot;-&quot;) {|f| $stderr.puts &quot;#{Process.pid} is here, f is #{f.inspect}&quot;}</span>
<a name="l05656"></a>05656 <span class="comment"> *     p $?</span>
<a name="l05657"></a>05657 <span class="comment"> *     IO.popen(%w&quot;sed -e s|^|&lt;foo&gt;| -e s&amp;$&amp;;zot;&amp;&quot;, &quot;r+&quot;) {|f|</span>
<a name="l05658"></a>05658 <span class="comment"> *       f.puts &quot;bar&quot;; f.close_write; puts f.gets</span>
<a name="l05659"></a>05659 <span class="comment"> *     }</span>
<a name="l05660"></a>05660 <span class="comment"> *</span>
<a name="l05661"></a>05661 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l05662"></a>05662 <span class="comment"> *</span>
<a name="l05663"></a>05663 <span class="comment"> *     [&quot;Linux\n&quot;]</span>
<a name="l05664"></a>05664 <span class="comment"> *     Parent is 21346</span>
<a name="l05665"></a>05665 <span class="comment"> *     Thu Jan 15 22:41:19 JST 2009</span>
<a name="l05666"></a>05666 <span class="comment"> *     21346 is here, f is #&lt;IO:fd 3&gt;</span>
<a name="l05667"></a>05667 <span class="comment"> *     21352 is here, f is nil</span>
<a name="l05668"></a>05668 <span class="comment"> *     #&lt;Process::Status: pid 21352 exit 0&gt;</span>
<a name="l05669"></a>05669 <span class="comment"> *     &lt;foo&gt;bar;zot;</span>
<a name="l05670"></a>05670 <span class="comment"> */</span>
<a name="l05671"></a>05671 
<a name="l05672"></a>05672 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l05673"></a><a class="code" href="../../df/d0a/io_8c.html#a163d2de63a404ee68d91b01a1e60b397">05673</a> <a class="code" href="../../df/d0a/io_8c.html#a163d2de63a404ee68d91b01a1e60b397">rb_io_s_popen</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass)
<a name="l05674"></a>05674 {
<a name="l05675"></a>05675     <span class="keyword">const</span> <span class="keywordtype">char</span> *modestr;
<a name="l05676"></a>05676     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> pname, pmode, port, tmp, opt;
<a name="l05677"></a>05677     <span class="keywordtype">int</span> oflags, <a class="code" href="../../df/d0a/io_8c.html#a8d9cc2340b814767e83294570cafa7fd">fmode</a>;
<a name="l05678"></a>05678     <a class="code" href="../../df/d0a/io_8c.html#a8a7a37633499f91b42907cfd1ecea043">convconfig_t</a> convconfig;
<a name="l05679"></a>05679 
<a name="l05680"></a>05680     argc = <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;11:&quot;</span>, &amp;pname, &amp;pmode, &amp;opt);
<a name="l05681"></a>05681 
<a name="l05682"></a>05682     <a class="code" href="../../df/d0a/io_8c.html#a13ec2b7ce2ee691474894144cde6c82e">rb_io_extract_modeenc</a>(&amp;pmode, 0, opt, &amp;oflags, &amp;fmode, &amp;convconfig);
<a name="l05683"></a>05683     modestr = <a class="code" href="../../df/d0a/io_8c.html#a36c0d38dddc4c2872ea006caf5c59471">rb_io_oflags_modestr</a>(oflags);
<a name="l05684"></a>05684 
<a name="l05685"></a>05685     tmp = <a class="code" href="../../dc/dcc/array_8c.html#aaa66361aff757dd7ef869f5b84b3793e">rb_check_array_type</a>(pname);
<a name="l05686"></a>05686     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(tmp)) {
<a name="l05687"></a>05687         <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(tmp);
<a name="l05688"></a>05688 <span class="preprocessor">#if SIZEOF_LONG &gt; SIZEOF_INT</span>
<a name="l05689"></a>05689 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (len &gt; INT_MAX) {
<a name="l05690"></a>05690             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;too many arguments&quot;</span>);
<a name="l05691"></a>05691         }
<a name="l05692"></a>05692 <span class="preprocessor">#endif</span>
<a name="l05693"></a>05693 <span class="preprocessor"></span>        tmp = <a class="code" href="../../dc/dcc/array_8c.html#a4ed6dfd78eb5519d446c519e364ef3ab">rb_ary_dup</a>(tmp);
<a name="l05694"></a>05694         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1d4c05021aacd8cab989ff60f95ebe2d">RBASIC</a>(tmp)-&gt;klass = 0;
<a name="l05695"></a>05695         port = <a class="code" href="../../df/d0a/io_8c.html#a152ce988be406926c5d6cdcfde82703e">pipe_open_v</a>((<span class="keywordtype">int</span>)len, <a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(tmp), modestr, fmode, &amp;convconfig);
<a name="l05696"></a>05696         <a class="code" href="../../dc/dcc/array_8c.html#aaf8c74d0eef61073fadf2c631fa9540f">rb_ary_clear</a>(tmp);
<a name="l05697"></a>05697     }
<a name="l05698"></a>05698     <span class="keywordflow">else</span> {
<a name="l05699"></a>05699         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0381640e2905c1b3e104194f91697ca4">SafeStringValue</a>(pname);
<a name="l05700"></a>05700         port = <a class="code" href="../../df/d0a/io_8c.html#a9246eb91d966de94aff31ef562e051e9">pipe_open_s</a>(pname, modestr, fmode, &amp;convconfig);
<a name="l05701"></a>05701     }
<a name="l05702"></a>05702     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(port)) {
<a name="l05703"></a>05703         <span class="comment">/* child */</span>
<a name="l05704"></a>05704         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d57/eval_8c.html#aea346c4eb8bc06df88422e956bb05fec">rb_block_given_p</a>()) {
<a name="l05705"></a>05705             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae6bd0c4ea4db971ebd569ca8f05c6b4a">rb_yield</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l05706"></a>05706             <a class="code" href="../../db/d2e/intern_8h.html#a773ecf32a05c03d4ca1da8cf31bbfc29">rb_io_flush</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>);
<a name="l05707"></a>05707             <a class="code" href="../../db/d2e/intern_8h.html#a773ecf32a05c03d4ca1da8cf31bbfc29">rb_io_flush</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1bc7a47b6913bb55b64d881d19da4d03">rb_stderr</a>);
<a name="l05708"></a>05708             _exit(0);
<a name="l05709"></a>05709         }
<a name="l05710"></a>05710         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l05711"></a>05711     }
<a name="l05712"></a>05712     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1d4c05021aacd8cab989ff60f95ebe2d">RBASIC</a>(port)-&gt;klass = klass;
<a name="l05713"></a>05713     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d57/eval_8c.html#aea346c4eb8bc06df88422e956bb05fec">rb_block_given_p</a>()) {
<a name="l05714"></a>05714         <span class="keywordflow">return</span> <a class="code" href="../../d3/d57/eval_8c.html#a8061198378fb16adeb931f90540b2839">rb_ensure</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae6bd0c4ea4db971ebd569ca8f05c6b4a">rb_yield</a>, port, <a class="code" href="../../df/d0a/io_8c.html#a7816bea23b5170be49ecb1a7ff8aafcf">io_close</a>, port);
<a name="l05715"></a>05715     }
<a name="l05716"></a>05716     <span class="keywordflow">return</span> port;
<a name="l05717"></a>05717 }
<a name="l05718"></a>05718 
<a name="l05719"></a>05719 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l05720"></a><a class="code" href="../../df/d0a/io_8c.html#a296c60436a9f83ad60cfcd8fc4e8e5a2">05720</a> <a class="code" href="../../df/d0a/io_8c.html#a296c60436a9f83ad60cfcd8fc4e8e5a2">rb_scan_open_args</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>,
<a name="l05721"></a>05721         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *fname_p, <span class="keywordtype">int</span> *oflags_p, <span class="keywordtype">int</span> *fmode_p,
<a name="l05722"></a>05722         <a class="code" href="../../df/d0a/io_8c.html#a8a7a37633499f91b42907cfd1ecea043">convconfig_t</a> *convconfig_p, <a class="code" href="../../dc/db1/win32_8h.html#ad2933406ba93c0e0d1884fc09c18a0bf">mode_t</a> *perm_p)
<a name="l05723"></a>05723 {
<a name="l05724"></a>05724     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opt, fname, vmode, vperm;
<a name="l05725"></a>05725     <span class="keywordtype">int</span> oflags, <a class="code" href="../../df/d0a/io_8c.html#a8d9cc2340b814767e83294570cafa7fd">fmode</a>;
<a name="l05726"></a>05726     <a class="code" href="../../dc/db1/win32_8h.html#ad2933406ba93c0e0d1884fc09c18a0bf">mode_t</a> perm;
<a name="l05727"></a>05727 
<a name="l05728"></a>05728     argc = <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;12:&quot;</span>, &amp;fname, &amp;vmode, &amp;vperm, &amp;opt);
<a name="l05729"></a>05729     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a66b35e3e022b499db72f5df63bb1d358">FilePathValue</a>(fname);
<a name="l05730"></a>05730 
<a name="l05731"></a>05731     <a class="code" href="../../df/d0a/io_8c.html#a13ec2b7ce2ee691474894144cde6c82e">rb_io_extract_modeenc</a>(&amp;vmode, &amp;vperm, opt, &amp;oflags, &amp;fmode, convconfig_p);
<a name="l05732"></a>05732 
<a name="l05733"></a>05733     perm = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(vperm) ? 0666 :  <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa790f2b689dd9e44e3faab861f291900">NUM2MODET</a>(vperm);
<a name="l05734"></a>05734 
<a name="l05735"></a>05735     *fname_p = fname;
<a name="l05736"></a>05736     *oflags_p = oflags;
<a name="l05737"></a>05737     *fmode_p = fmode;
<a name="l05738"></a>05738     *perm_p = perm;
<a name="l05739"></a>05739 }
<a name="l05740"></a>05740 
<a name="l05741"></a>05741 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l05742"></a><a class="code" href="../../df/d0a/io_8c.html#a8b5d31f18b19cf07bbf1d4132b6fd247">05742</a> <a class="code" href="../../df/d0a/io_8c.html#a8b5d31f18b19cf07bbf1d4132b6fd247">rb_open_file</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l05743"></a>05743 {
<a name="l05744"></a>05744     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> fname;
<a name="l05745"></a>05745     <span class="keywordtype">int</span> oflags, <a class="code" href="../../df/d0a/io_8c.html#a8d9cc2340b814767e83294570cafa7fd">fmode</a>;
<a name="l05746"></a>05746     <a class="code" href="../../df/d0a/io_8c.html#a8a7a37633499f91b42907cfd1ecea043">convconfig_t</a> convconfig;
<a name="l05747"></a>05747     <a class="code" href="../../dc/db1/win32_8h.html#ad2933406ba93c0e0d1884fc09c18a0bf">mode_t</a> perm;
<a name="l05748"></a>05748 
<a name="l05749"></a>05749     <a class="code" href="../../df/d0a/io_8c.html#a296c60436a9f83ad60cfcd8fc4e8e5a2">rb_scan_open_args</a>(argc, argv, &amp;fname, &amp;oflags, &amp;fmode, &amp;convconfig, &amp;perm);
<a name="l05750"></a>05750     <a class="code" href="../../df/d0a/io_8c.html#ad69e3fce0b7a32e4aade7a5d80e3f62f">rb_file_open_generic</a>(io, fname, oflags, fmode, &amp;convconfig, perm);
<a name="l05751"></a>05751 
<a name="l05752"></a>05752     <span class="keywordflow">return</span> io;
<a name="l05753"></a>05753 }
<a name="l05754"></a>05754 
<a name="l05755"></a>05755 
<a name="l05756"></a>05756 <span class="comment">/*</span>
<a name="l05757"></a>05757 <span class="comment"> *  Document-method: File::open</span>
<a name="l05758"></a>05758 <span class="comment"> *</span>
<a name="l05759"></a>05759 <span class="comment"> *  call-seq:</span>
<a name="l05760"></a>05760 <span class="comment"> *     File.open(filename, mode=&quot;r&quot; [, opt])                 -&gt; file</span>
<a name="l05761"></a>05761 <span class="comment"> *     File.open(filename [, mode [, perm]] [, opt])         -&gt; file</span>
<a name="l05762"></a>05762 <span class="comment"> *     File.open(filename, mode=&quot;r&quot; [, opt]) {|file| block } -&gt; obj</span>
<a name="l05763"></a>05763 <span class="comment"> *     File.open(filename [, mode [, perm]] [, opt]) {|file| block } -&gt; obj</span>
<a name="l05764"></a>05764 <span class="comment"> *</span>
<a name="l05765"></a>05765 <span class="comment"> *  With no associated block, &lt;code&gt;File.open&lt;/code&gt; is a synonym for</span>
<a name="l05766"></a>05766 <span class="comment"> *  File.new. If the optional code block is given, it will</span>
<a name="l05767"></a>05767 <span class="comment"> *  be passed the opened +file+ as an argument, and the File object will</span>
<a name="l05768"></a>05768 <span class="comment"> *  automatically be closed when the block terminates.  In this instance,</span>
<a name="l05769"></a>05769 <span class="comment"> *  &lt;code&gt;File.open&lt;/code&gt; returns the value of the block.</span>
<a name="l05770"></a>05770 <span class="comment"> *</span>
<a name="l05771"></a>05771 <span class="comment"> *  See IO.new for a list of values for the +opt+ parameter.</span>
<a name="l05772"></a>05772 <span class="comment"> */</span>
<a name="l05773"></a>05773 
<a name="l05774"></a>05774 <span class="comment">/*</span>
<a name="l05775"></a>05775 <span class="comment"> *  Document-method: IO::open</span>
<a name="l05776"></a>05776 <span class="comment"> *</span>
<a name="l05777"></a>05777 <span class="comment"> *  call-seq:</span>
<a name="l05778"></a>05778 <span class="comment"> *     IO.open(fd, mode_string=&quot;r&quot; [, opt])               -&gt; io</span>
<a name="l05779"></a>05779 <span class="comment"> *     IO.open(fd, mode_string=&quot;r&quot; [, opt]) {|io| block } -&gt; obj</span>
<a name="l05780"></a>05780 <span class="comment"> *</span>
<a name="l05781"></a>05781 <span class="comment"> *  With no associated block, &lt;code&gt;IO.open&lt;/code&gt; is a synonym for IO.new. If</span>
<a name="l05782"></a>05782 <span class="comment"> *  the optional code block is given, it will be passed +io+ as an</span>
<a name="l05783"></a>05783 <span class="comment"> *  argument, and the IO object will automatically be closed when the block</span>
<a name="l05784"></a>05784 <span class="comment"> *  terminates. In this instance, IO.open returns the value of the block.</span>
<a name="l05785"></a>05785 <span class="comment"> *</span>
<a name="l05786"></a>05786 <span class="comment"> *  See IO.new for a description of values for the +opt+ parameter.</span>
<a name="l05787"></a>05787 <span class="comment"> *</span>
<a name="l05788"></a>05788 <span class="comment"> */</span>
<a name="l05789"></a>05789 
<a name="l05790"></a>05790 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l05791"></a><a class="code" href="../../df/d0a/io_8c.html#a6276032e5c6c91c0b13a7196b844e709">05791</a> <a class="code" href="../../df/d0a/io_8c.html#a6276032e5c6c91c0b13a7196b844e709">rb_io_s_open</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass)
<a name="l05792"></a>05792 {
<a name="l05793"></a>05793     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io = <a class="code" href="../../db/d2e/intern_8h.html#a4e25a1a5ca0fc372179c4f429600bc2a">rb_class_new_instance</a>(argc, argv, klass);
<a name="l05794"></a>05794 
<a name="l05795"></a>05795     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d57/eval_8c.html#aea346c4eb8bc06df88422e956bb05fec">rb_block_given_p</a>()) {
<a name="l05796"></a>05796         <span class="keywordflow">return</span> <a class="code" href="../../d3/d57/eval_8c.html#a8061198378fb16adeb931f90540b2839">rb_ensure</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae6bd0c4ea4db971ebd569ca8f05c6b4a">rb_yield</a>, io, <a class="code" href="../../df/d0a/io_8c.html#a7816bea23b5170be49ecb1a7ff8aafcf">io_close</a>, io);
<a name="l05797"></a>05797     }
<a name="l05798"></a>05798 
<a name="l05799"></a>05799     <span class="keywordflow">return</span> io;
<a name="l05800"></a>05800 }
<a name="l05801"></a>05801 
<a name="l05802"></a>05802 <span class="comment">/*</span>
<a name="l05803"></a>05803 <span class="comment"> *  call-seq:</span>
<a name="l05804"></a>05804 <span class="comment"> *     IO.sysopen(path, [mode, [perm]])  -&gt; fixnum</span>
<a name="l05805"></a>05805 <span class="comment"> *</span>
<a name="l05806"></a>05806 <span class="comment"> *  Opens the given path, returning the underlying file descriptor as a</span>
<a name="l05807"></a>05807 <span class="comment"> *  &lt;code&gt;Fixnum&lt;/code&gt;.</span>
<a name="l05808"></a>05808 <span class="comment"> *</span>
<a name="l05809"></a>05809 <span class="comment"> *     IO.sysopen(&quot;testfile&quot;)   #=&gt; 3</span>
<a name="l05810"></a>05810 <span class="comment"> *</span>
<a name="l05811"></a>05811 <span class="comment"> */</span>
<a name="l05812"></a>05812 
<a name="l05813"></a>05813 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l05814"></a><a class="code" href="../../df/d0a/io_8c.html#ad2594a367b3df93ed7126d26aa790ea9">05814</a> <a class="code" href="../../df/d0a/io_8c.html#ad2594a367b3df93ed7126d26aa790ea9">rb_io_s_sysopen</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>)
<a name="l05815"></a>05815 {
<a name="l05816"></a>05816     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> fname, vmode, vperm;
<a name="l05817"></a>05817     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> intmode;
<a name="l05818"></a>05818     <span class="keywordtype">int</span> oflags, fd;
<a name="l05819"></a>05819     <a class="code" href="../../dc/db1/win32_8h.html#ad2933406ba93c0e0d1884fc09c18a0bf">mode_t</a> perm;
<a name="l05820"></a>05820 
<a name="l05821"></a>05821     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;12&quot;</span>, &amp;fname, &amp;vmode, &amp;vperm);
<a name="l05822"></a>05822     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a66b35e3e022b499db72f5df63bb1d358">FilePathValue</a>(fname);
<a name="l05823"></a>05823 
<a name="l05824"></a>05824     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(vmode))
<a name="l05825"></a>05825         oflags = O_RDONLY;
<a name="l05826"></a>05826     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(intmode = <a class="code" href="../../db/d2e/intern_8h.html#aa6019bc11856926dd4b9c7adade93d8f">rb_check_to_integer</a>(vmode, <span class="stringliteral">&quot;to_int&quot;</span>)))
<a name="l05827"></a>05827         oflags = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(intmode);
<a name="l05828"></a>05828     <span class="keywordflow">else</span> {
<a name="l05829"></a>05829         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0381640e2905c1b3e104194f91697ca4">SafeStringValue</a>(vmode);
<a name="l05830"></a>05830         oflags = <a class="code" href="../../dc/dac/io_8h.html#a18815b569044e1ffbe48c093ed7efd1f">rb_io_modestr_oflags</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(vmode));
<a name="l05831"></a>05831     }
<a name="l05832"></a>05832     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(vperm)) perm = 0666;
<a name="l05833"></a>05833     <span class="keywordflow">else</span>              perm = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa790f2b689dd9e44e3faab861f291900">NUM2MODET</a>(vperm);
<a name="l05834"></a>05834 
<a name="l05835"></a>05835     <a class="code" href="../../d8/df4/generator_8h.html#ad2bf389f3fddea7bd3befa162c70561a">RB_GC_GUARD</a>(fname) = <a class="code" href="../../db/d2e/intern_8h.html#af609add406b0ef084a38f6dd615119d6">rb_str_new4</a>(fname);
<a name="l05836"></a>05836     fd = <a class="code" href="../../df/d0a/io_8c.html#a42654a6f8234decb8c183204f42e1b8a">rb_sysopen</a>(fname, oflags, perm);
<a name="l05837"></a>05837     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(fd);
<a name="l05838"></a>05838 }
<a name="l05839"></a>05839 
<a name="l05840"></a>05840 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l05841"></a><a class="code" href="../../df/d0a/io_8c.html#a0d53e5925c25b09b2344e655069ee46c">05841</a> <a class="code" href="../../df/d0a/io_8c.html#a0d53e5925c25b09b2344e655069ee46c">check_pipe_command</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> filename_or_command)
<a name="l05842"></a>05842 {
<a name="l05843"></a>05843     <span class="keywordtype">char</span> *s = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(filename_or_command);
<a name="l05844"></a>05844     <span class="keywordtype">long</span> l = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(filename_or_command);
<a name="l05845"></a>05845     <span class="keywordtype">char</span> *e = s + l;
<a name="l05846"></a>05846     <span class="keywordtype">int</span> chlen;
<a name="l05847"></a>05847 
<a name="l05848"></a>05848     <span class="keywordflow">if</span> (<a class="code" href="../../d5/db5/encoding_8c.html#af6663b51ce857cfe600a8bc48434d6f2">rb_enc_ascget</a>(s, e, &amp;chlen, <a class="code" href="../../d5/db5/encoding_8c.html#ac21ed764f3b39453b6a848dd64a19585">rb_enc_get</a>(filename_or_command)) == <span class="charliteral">&apos;|&apos;</span>) {
<a name="l05849"></a>05849         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> cmd = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(s+chlen, l-chlen);
<a name="l05850"></a>05850         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3bf9ab455a1e0e3e8cfc6ebabd8f12df">OBJ_INFECT</a>(cmd, filename_or_command);
<a name="l05851"></a>05851         <span class="keywordflow">return</span> cmd;
<a name="l05852"></a>05852     }
<a name="l05853"></a>05853     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l05854"></a>05854 }
<a name="l05855"></a>05855 
<a name="l05856"></a>05856 <span class="comment">/*</span>
<a name="l05857"></a>05857 <span class="comment"> *  call-seq:</span>
<a name="l05858"></a>05858 <span class="comment"> *     open(path [, mode_enc [, perm]] [, opt])                -&gt; io or nil</span>
<a name="l05859"></a>05859 <span class="comment"> *     open(path [, mode_enc [, perm]] [, opt]) {|io| block }  -&gt; obj</span>
<a name="l05860"></a>05860 <span class="comment"> *</span>
<a name="l05861"></a>05861 <span class="comment"> *  Creates an &lt;code&gt;IO&lt;/code&gt; object connected to the given stream,</span>
<a name="l05862"></a>05862 <span class="comment"> *  file, or subprocess.</span>
<a name="l05863"></a>05863 <span class="comment"> *</span>
<a name="l05864"></a>05864 <span class="comment"> *  If &lt;i&gt;path&lt;/i&gt; does not start with a pipe character</span>
<a name="l05865"></a>05865 <span class="comment"> *  (``&lt;code&gt;|&lt;/code&gt;&apos;&apos;), treat it as the name of a file to open using</span>
<a name="l05866"></a>05866 <span class="comment"> *  the specified mode (defaulting to ``&lt;code&gt;r&lt;/code&gt;&apos;&apos;).</span>
<a name="l05867"></a>05867 <span class="comment"> *</span>
<a name="l05868"></a>05868 <span class="comment"> *  The mode_enc is</span>
<a name="l05869"></a>05869 <span class="comment"> *  either a string or an integer.  If it is an integer, it must be</span>
<a name="l05870"></a>05870 <span class="comment"> *  bitwise-or of open(2) flags, such as File::RDWR or File::EXCL.</span>
<a name="l05871"></a>05871 <span class="comment"> *  If it is a string, it is either &quot;mode&quot;, &quot;mode:ext_enc&quot;, or</span>
<a name="l05872"></a>05872 <span class="comment"> *  &quot;mode:ext_enc:int_enc&quot;.</span>
<a name="l05873"></a>05873 <span class="comment"> *  The mode is one of the following:</span>
<a name="l05874"></a>05874 <span class="comment"> *</span>
<a name="l05875"></a>05875 <span class="comment"> *   r: read (default)</span>
<a name="l05876"></a>05876 <span class="comment"> *   w: write</span>
<a name="l05877"></a>05877 <span class="comment"> *   a: append</span>
<a name="l05878"></a>05878 <span class="comment"> *</span>
<a name="l05879"></a>05879 <span class="comment"> *  The mode can be followed by &quot;b&quot; (means binary-mode), or &quot;+&quot;</span>
<a name="l05880"></a>05880 <span class="comment"> *  (means both reading and writing allowed) or both.</span>
<a name="l05881"></a>05881 <span class="comment"> *  If ext_enc (external encoding) is specified,</span>
<a name="l05882"></a>05882 <span class="comment"> *  read string will be tagged by the encoding in reading,</span>
<a name="l05883"></a>05883 <span class="comment"> *  and output string will be converted</span>
<a name="l05884"></a>05884 <span class="comment"> *  to the specified encoding in writing.</span>
<a name="l05885"></a>05885 <span class="comment"> *  If ext_enc starts with &apos;BOM|&apos;, check whether the input has a BOM. If</span>
<a name="l05886"></a>05886 <span class="comment"> *  there is a BOM, strip it and set external encoding as</span>
<a name="l05887"></a>05887 <span class="comment"> *  what the BOM tells. If there is no BOM, use ext_enc without &apos;BOM|&apos;.</span>
<a name="l05888"></a>05888 <span class="comment"> *  If two encoding names,</span>
<a name="l05889"></a>05889 <span class="comment"> *  ext_enc and int_enc (external encoding and internal encoding),</span>
<a name="l05890"></a>05890 <span class="comment"> *  are specified, the read string is converted from ext_enc</span>
<a name="l05891"></a>05891 <span class="comment"> *  to int_enc then tagged with the int_enc in read mode,</span>
<a name="l05892"></a>05892 <span class="comment"> *  and in write mode, the output string will be</span>
<a name="l05893"></a>05893 <span class="comment"> *  converted from int_enc to ext_enc before writing.</span>
<a name="l05894"></a>05894 <span class="comment"> *</span>
<a name="l05895"></a>05895 <span class="comment"> *  If a file is being created, its initial permissions may be</span>
<a name="l05896"></a>05896 <span class="comment"> *  set using the integer third parameter.</span>
<a name="l05897"></a>05897 <span class="comment"> *</span>
<a name="l05898"></a>05898 <span class="comment"> *  If a block is specified, it will be invoked with the</span>
<a name="l05899"></a>05899 <span class="comment"> *  &lt;code&gt;File&lt;/code&gt; object as a parameter, and the file will be</span>
<a name="l05900"></a>05900 <span class="comment"> *  automatically closed when the block terminates. The call</span>
<a name="l05901"></a>05901 <span class="comment"> *  returns the value of the block.</span>
<a name="l05902"></a>05902 <span class="comment"> *</span>
<a name="l05903"></a>05903 <span class="comment"> *  If &lt;i&gt;path&lt;/i&gt; starts with a pipe character, a subprocess is</span>
<a name="l05904"></a>05904 <span class="comment"> *  created, connected to the caller by a pair of pipes. The returned</span>
<a name="l05905"></a>05905 <span class="comment"> *  &lt;code&gt;IO&lt;/code&gt; object may be used to write to the standard input</span>
<a name="l05906"></a>05906 <span class="comment"> *  and read from the standard output of this subprocess. If the command</span>
<a name="l05907"></a>05907 <span class="comment"> *  following the ``&lt;code&gt;|&lt;/code&gt;&apos;&apos; is a single minus sign, Ruby forks,</span>
<a name="l05908"></a>05908 <span class="comment"> *  and this subprocess is connected to the parent. In the subprocess,</span>
<a name="l05909"></a>05909 <span class="comment"> *  the &lt;code&gt;open&lt;/code&gt; call returns &lt;code&gt;nil&lt;/code&gt;. If the command</span>
<a name="l05910"></a>05910 <span class="comment"> *  is not ``&lt;code&gt;-&lt;/code&gt;&apos;&apos;, the subprocess runs the command. If a</span>
<a name="l05911"></a>05911 <span class="comment"> *  block is associated with an &lt;code&gt;open(&quot;|-&quot;)&lt;/code&gt; call, that block</span>
<a name="l05912"></a>05912 <span class="comment"> *  will be run twice---once in the parent and once in the child. The</span>
<a name="l05913"></a>05913 <span class="comment"> *  block parameter will be an &lt;code&gt;IO&lt;/code&gt; object in the parent and</span>
<a name="l05914"></a>05914 <span class="comment"> *  &lt;code&gt;nil&lt;/code&gt; in the child. The parent&apos;s &lt;code&gt;IO&lt;/code&gt; object</span>
<a name="l05915"></a>05915 <span class="comment"> *  will be connected to the child&apos;s &lt;code&gt;$stdin&lt;/code&gt; and</span>
<a name="l05916"></a>05916 <span class="comment"> *  &lt;code&gt;$stdout&lt;/code&gt;. The subprocess will be terminated at the end</span>
<a name="l05917"></a>05917 <span class="comment"> *  of the block.</span>
<a name="l05918"></a>05918 <span class="comment"> *</span>
<a name="l05919"></a>05919 <span class="comment"> *     open(&quot;testfile&quot;) do |f|</span>
<a name="l05920"></a>05920 <span class="comment"> *       print f.gets</span>
<a name="l05921"></a>05921 <span class="comment"> *     end</span>
<a name="l05922"></a>05922 <span class="comment"> *</span>
<a name="l05923"></a>05923 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l05924"></a>05924 <span class="comment"> *</span>
<a name="l05925"></a>05925 <span class="comment"> *     This is line one</span>
<a name="l05926"></a>05926 <span class="comment"> *</span>
<a name="l05927"></a>05927 <span class="comment"> *  Open a subprocess and read its output:</span>
<a name="l05928"></a>05928 <span class="comment"> *</span>
<a name="l05929"></a>05929 <span class="comment"> *     cmd = open(&quot;|date&quot;)</span>
<a name="l05930"></a>05930 <span class="comment"> *     print cmd.gets</span>
<a name="l05931"></a>05931 <span class="comment"> *     cmd.close</span>
<a name="l05932"></a>05932 <span class="comment"> *</span>
<a name="l05933"></a>05933 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l05934"></a>05934 <span class="comment"> *</span>
<a name="l05935"></a>05935 <span class="comment"> *     Wed Apr  9 08:56:31 CDT 2003</span>
<a name="l05936"></a>05936 <span class="comment"> *</span>
<a name="l05937"></a>05937 <span class="comment"> *  Open a subprocess running the same Ruby program:</span>
<a name="l05938"></a>05938 <span class="comment"> *</span>
<a name="l05939"></a>05939 <span class="comment"> *     f = open(&quot;|-&quot;, &quot;w+&quot;)</span>
<a name="l05940"></a>05940 <span class="comment"> *     if f == nil</span>
<a name="l05941"></a>05941 <span class="comment"> *       puts &quot;in Child&quot;</span>
<a name="l05942"></a>05942 <span class="comment"> *       exit</span>
<a name="l05943"></a>05943 <span class="comment"> *     else</span>
<a name="l05944"></a>05944 <span class="comment"> *       puts &quot;Got: #{f.gets}&quot;</span>
<a name="l05945"></a>05945 <span class="comment"> *     end</span>
<a name="l05946"></a>05946 <span class="comment"> *</span>
<a name="l05947"></a>05947 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l05948"></a>05948 <span class="comment"> *</span>
<a name="l05949"></a>05949 <span class="comment"> *     Got: in Child</span>
<a name="l05950"></a>05950 <span class="comment"> *</span>
<a name="l05951"></a>05951 <span class="comment"> *  Open a subprocess using a block to receive the I/O object:</span>
<a name="l05952"></a>05952 <span class="comment"> *</span>
<a name="l05953"></a>05953 <span class="comment"> *     open(&quot;|-&quot;) do |f|</span>
<a name="l05954"></a>05954 <span class="comment"> *       if f == nil</span>
<a name="l05955"></a>05955 <span class="comment"> *         puts &quot;in Child&quot;</span>
<a name="l05956"></a>05956 <span class="comment"> *       else</span>
<a name="l05957"></a>05957 <span class="comment"> *         puts &quot;Got: #{f.gets}&quot;</span>
<a name="l05958"></a>05958 <span class="comment"> *       end</span>
<a name="l05959"></a>05959 <span class="comment"> *     end</span>
<a name="l05960"></a>05960 <span class="comment"> *</span>
<a name="l05961"></a>05961 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l05962"></a>05962 <span class="comment"> *</span>
<a name="l05963"></a>05963 <span class="comment"> *     Got: in Child</span>
<a name="l05964"></a>05964 <span class="comment"> */</span>
<a name="l05965"></a>05965 
<a name="l05966"></a>05966 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l05967"></a><a class="code" href="../../df/d0a/io_8c.html#a3862359d3b7422dcf99eb607724beb43">05967</a> <a class="code" href="../../df/d0a/io_8c.html#a3862359d3b7422dcf99eb607724beb43">rb_f_open</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>)
<a name="l05968"></a>05968 {
<a name="l05969"></a>05969     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> to_open = 0;
<a name="l05970"></a>05970     <span class="keywordtype">int</span> redirect = <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l05971"></a>05971 
<a name="l05972"></a>05972     <span class="keywordflow">if</span> (argc &gt;= 1) {
<a name="l05973"></a>05973         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa50b9d5bc665eb5545f6857c89232161">CONST_ID</a>(to_open, <span class="stringliteral">&quot;to_open&quot;</span>);
<a name="l05974"></a>05974         <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#a5c6c63c2619b8c03df2e173ef1e73846">rb_respond_to</a>(argv[0], to_open)) {
<a name="l05975"></a>05975             redirect = <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l05976"></a>05976         }
<a name="l05977"></a>05977         <span class="keywordflow">else</span> {
<a name="l05978"></a>05978             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> tmp = argv[0];
<a name="l05979"></a>05979             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a66b35e3e022b499db72f5df63bb1d358">FilePathValue</a>(tmp);
<a name="l05980"></a>05980             <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(tmp)) {
<a name="l05981"></a>05981                 redirect = <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l05982"></a>05982             }
<a name="l05983"></a>05983             <span class="keywordflow">else</span> {
<a name="l05984"></a>05984                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> cmd = <a class="code" href="../../df/d0a/io_8c.html#a0d53e5925c25b09b2344e655069ee46c">check_pipe_command</a>(tmp);
<a name="l05985"></a>05985                 <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(cmd)) {
<a name="l05986"></a>05986                     argv[0] = cmd;
<a name="l05987"></a>05987                     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a163d2de63a404ee68d91b01a1e60b397">rb_io_s_popen</a>(argc, argv, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>);
<a name="l05988"></a>05988                 }
<a name="l05989"></a>05989             }
<a name="l05990"></a>05990         }
<a name="l05991"></a>05991     }
<a name="l05992"></a>05992     <span class="keywordflow">if</span> (redirect) {
<a name="l05993"></a>05993         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#adafa8fd17636821445380e7e1881355e" title="Calls a method.">rb_funcall2</a>(argv[0], to_open, argc-1, argv+1);
<a name="l05994"></a>05994 
<a name="l05995"></a>05995         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d57/eval_8c.html#aea346c4eb8bc06df88422e956bb05fec">rb_block_given_p</a>()) {
<a name="l05996"></a>05996             <span class="keywordflow">return</span> <a class="code" href="../../d3/d57/eval_8c.html#a8061198378fb16adeb931f90540b2839">rb_ensure</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae6bd0c4ea4db971ebd569ca8f05c6b4a">rb_yield</a>, io, <a class="code" href="../../df/d0a/io_8c.html#a7816bea23b5170be49ecb1a7ff8aafcf">io_close</a>, io);
<a name="l05997"></a>05997         }
<a name="l05998"></a>05998         <span class="keywordflow">return</span> io;
<a name="l05999"></a>05999     }
<a name="l06000"></a>06000     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a6276032e5c6c91c0b13a7196b844e709">rb_io_s_open</a>(argc, argv, <a class="code" href="../../d6/d13/file_8c.html#ae9f03997c2e7a3461524e83053a24ac2">rb_cFile</a>);
<a name="l06001"></a>06001 }
<a name="l06002"></a>06002 
<a name="l06003"></a>06003 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06004"></a><a class="code" href="../../df/d0a/io_8c.html#ad3a0800448e149c31b1adc110bf94fc6">06004</a> <a class="code" href="../../df/d0a/io_8c.html#ad3a0800448e149c31b1adc110bf94fc6">rb_io_open</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> filename, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> vmode, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> vperm, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opt)
<a name="l06005"></a>06005 {
<a name="l06006"></a>06006     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> cmd;
<a name="l06007"></a>06007     <span class="keywordtype">int</span> oflags, <a class="code" href="../../df/d0a/io_8c.html#a8d9cc2340b814767e83294570cafa7fd">fmode</a>;
<a name="l06008"></a>06008     <a class="code" href="../../df/d0a/io_8c.html#a8a7a37633499f91b42907cfd1ecea043">convconfig_t</a> convconfig;
<a name="l06009"></a>06009     <a class="code" href="../../dc/db1/win32_8h.html#ad2933406ba93c0e0d1884fc09c18a0bf">mode_t</a> perm;
<a name="l06010"></a>06010 
<a name="l06011"></a>06011     <a class="code" href="../../df/d0a/io_8c.html#a13ec2b7ce2ee691474894144cde6c82e">rb_io_extract_modeenc</a>(&amp;vmode, &amp;vperm, opt, &amp;oflags, &amp;fmode, &amp;convconfig);
<a name="l06012"></a>06012     perm = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(vperm) ? 0666 :  <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa790f2b689dd9e44e3faab861f291900">NUM2MODET</a>(vperm);
<a name="l06013"></a>06013 
<a name="l06014"></a>06014     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(cmd = <a class="code" href="../../df/d0a/io_8c.html#a0d53e5925c25b09b2344e655069ee46c">check_pipe_command</a>(filename))) {
<a name="l06015"></a>06015         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a9246eb91d966de94aff31ef562e051e9">pipe_open_s</a>(cmd, <a class="code" href="../../df/d0a/io_8c.html#a36c0d38dddc4c2872ea006caf5c59471">rb_io_oflags_modestr</a>(oflags), fmode, &amp;convconfig);
<a name="l06016"></a>06016     }
<a name="l06017"></a>06017     <span class="keywordflow">else</span> {
<a name="l06018"></a>06018         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#ad69e3fce0b7a32e4aade7a5d80e3f62f">rb_file_open_generic</a>(<a class="code" href="../../df/d0a/io_8c.html#a47f57cf9a8f65858e5cfe7ed56cc65bb">io_alloc</a>(<a class="code" href="../../d6/d13/file_8c.html#ae9f03997c2e7a3461524e83053a24ac2">rb_cFile</a>), filename,
<a name="l06019"></a>06019                 oflags, fmode, &amp;convconfig, perm);
<a name="l06020"></a>06020     }
<a name="l06021"></a>06021 }
<a name="l06022"></a>06022 
<a name="l06023"></a>06023 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06024"></a><a class="code" href="../../df/d0a/io_8c.html#a9c8dcf11db3bf78262fdf7e7f8635c06">06024</a> <a class="code" href="../../df/d0a/io_8c.html#a9c8dcf11db3bf78262fdf7e7f8635c06">rb_io_open_with_args</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>)
<a name="l06025"></a>06025 {
<a name="l06026"></a>06026     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io;
<a name="l06027"></a>06027 
<a name="l06028"></a>06028     io = <a class="code" href="../../df/d0a/io_8c.html#a47f57cf9a8f65858e5cfe7ed56cc65bb">io_alloc</a>(<a class="code" href="../../d6/d13/file_8c.html#ae9f03997c2e7a3461524e83053a24ac2">rb_cFile</a>);
<a name="l06029"></a>06029     <a class="code" href="../../df/d0a/io_8c.html#a8b5d31f18b19cf07bbf1d4132b6fd247">rb_open_file</a>(argc, argv, io);
<a name="l06030"></a>06030     <span class="keywordflow">return</span> io;
<a name="l06031"></a>06031 }
<a name="l06032"></a>06032 
<a name="l06033"></a>06033 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06034"></a><a class="code" href="../../df/d0a/io_8c.html#aa77290573232e6f565c73dcea84a5ce3">06034</a> <a class="code" href="../../df/d0a/io_8c.html#aa77290573232e6f565c73dcea84a5ce3">io_reopen</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> nfile)
<a name="l06035"></a>06035 {
<a name="l06036"></a>06036     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, *orig;
<a name="l06037"></a>06037     <span class="keywordtype">int</span> fd, fd2;
<a name="l06038"></a>06038     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> pos = 0;
<a name="l06039"></a>06039 
<a name="l06040"></a>06040     nfile = <a class="code" href="../../db/d2e/intern_8h.html#abc8a40f163cccdca6e3b9c0db7ed24b3">rb_io_get_io</a>(nfile);
<a name="l06041"></a>06041     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9d/tcltklib_8c.html#a6f520624fabb8332dc98fd223491bf8d">rb_safe_level</a>() &gt;= 4 &amp;&amp;
<a name="l06042"></a>06042         (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a981ef70b505df85f89fba2b5c2d8b462">OBJ_UNTRUSTED</a>(io) || !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a981ef70b505df85f89fba2b5c2d8b462">OBJ_UNTRUSTED</a>(nfile))) {
<a name="l06043"></a>06043         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ae53f1d228c34c2a7715d7d39ab1a2991">rb_eSecurityError</a>, <span class="stringliteral">&quot;Insecure: can&apos;t reopen&quot;</span>);
<a name="l06044"></a>06044     }
<a name="l06045"></a>06045     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l06046"></a>06046     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(nfile, orig);
<a name="l06047"></a>06047 
<a name="l06048"></a>06048     <span class="keywordflow">if</span> (fptr == orig) <span class="keywordflow">return</span> io;
<a name="l06049"></a>06049     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#ae96f61e7e8ed6ac314a838919617ccee">IS_PREP_STDIO</a>(fptr)) {
<a name="l06050"></a>06050         <span class="keywordflow">if</span> ((fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a> == stdin &amp;&amp; !(orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>)) ||
<a name="l06051"></a>06051             (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a> == stdout &amp;&amp; !(orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>)) ||
<a name="l06052"></a>06052             (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a> == stderr &amp;&amp; !(orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>))) {
<a name="l06053"></a>06053             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>,
<a name="l06054"></a>06054                      <span class="stringliteral">&quot;%s can&apos;t change access mode from \&quot;%s\&quot; to \&quot;%s\&quot;&quot;</span>,
<a name="l06055"></a>06055                      <a class="code" href="../../df/d0a/io_8c.html#a8023d58d05a057f4d67c135295be3f5c">PREP_STDIO_NAME</a>(fptr), <a class="code" href="../../df/d0a/io_8c.html#af98084269e66d5b168e2e2b985209e00">rb_io_fmode_modestr</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a>),
<a name="l06056"></a>06056                      <a class="code" href="../../df/d0a/io_8c.html#af98084269e66d5b168e2e2b985209e00">rb_io_fmode_modestr</a>(orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a>));
<a name="l06057"></a>06057         }
<a name="l06058"></a>06058     }
<a name="l06059"></a>06059     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>) {
<a name="l06060"></a>06060         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(fptr) &lt; 0)
<a name="l06061"></a>06061             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l06062"></a>06062     }
<a name="l06063"></a>06063     <span class="keywordflow">else</span> {
<a name="l06064"></a>06064         <a class="code" href="../../df/d0a/io_8c.html#a05eb5776a3cfb91c2636c607be1ba1e4">io_tell</a>(fptr);
<a name="l06065"></a>06065     }
<a name="l06066"></a>06066     <span class="keywordflow">if</span> (orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>) {
<a name="l06067"></a>06067         pos = <a class="code" href="../../df/d0a/io_8c.html#a05eb5776a3cfb91c2636c607be1ba1e4">io_tell</a>(orig);
<a name="l06068"></a>06068     }
<a name="l06069"></a>06069     <span class="keywordflow">if</span> (orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>) {
<a name="l06070"></a>06070         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(orig) &lt; 0)
<a name="l06071"></a>06071             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l06072"></a>06072     }
<a name="l06073"></a>06073 
<a name="l06074"></a>06074     <span class="comment">/* copy rb_io_t structure */</span>
<a name="l06075"></a>06075     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> = orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> | (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../df/d0a/io_8c.html#a8d840b75e901aaf536355307ebef1291">FMODE_PREP</a>);
<a name="l06076"></a>06076     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6080b18e6883f70d36a1c1554761ccfe">pid</a> = orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6080b18e6883f70d36a1c1554761ccfe">pid</a>;
<a name="l06077"></a>06077     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a397be62fbdfe88a3763377f262241ca7">lineno</a> = orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a397be62fbdfe88a3763377f262241ca7">lineno</a>;
<a name="l06078"></a>06078     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>)) fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a> = orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>;
<a name="l06079"></a>06079     <span class="keywordflow">else</span> <a class="code" href="../../d7/dc0/parse_8y.html#a2ac1143ac343c79cbfa448e30d74fa1c">if</a> (!<a class="code" href="../../df/d0a/io_8c.html#ae96f61e7e8ed6ac314a838919617ccee">IS_PREP_STDIO</a>(fptr)) fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l06080"></a>06080     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a5a2f6f866626d12df82f61cf98401f8c">finalize</a> = orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a5a2f6f866626d12df82f61cf98401f8c">finalize</a>;
<a name="l06081"></a>06081 #<span class="keywordflow">if</span> defined (__CYGWIN__) || !defined(HAVE_FORK)
<a name="l06082"></a>06082     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a5a2f6f866626d12df82f61cf98401f8c">finalize</a> == <a class="code" href="../../df/d0a/io_8c.html#a6467635964aaf761d2ac9169d217ee63">pipe_finalize</a>)
<a name="l06083"></a>06083         <a class="code" href="../../df/d0a/io_8c.html#a6cee254cfd59ee0a24dc3872fc46de2a">pipe_add_fptr</a>(fptr);
<a name="l06084"></a>06084 <span class="preprocessor">#endif</span>
<a name="l06085"></a>06085 <span class="preprocessor"></span>
<a name="l06086"></a>06086     fd = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>;
<a name="l06087"></a>06087     fd2 = orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>;
<a name="l06088"></a>06088     <span class="keywordflow">if</span> (fd != fd2) {
<a name="l06089"></a>06089         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#ae96f61e7e8ed6ac314a838919617ccee">IS_PREP_STDIO</a>(fptr) || fd &lt;= 2 || !fptr-&gt;stdio_file) {
<a name="l06090"></a>06090             <span class="comment">/* need to keep FILE objects of stdin, stdout and stderr */</span>
<a name="l06091"></a>06091             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d90/missing_8h.html#a1a7dc1d5f4ee5da620088e280e4bc580">dup2</a>(fd2, fd) &lt; 0)
<a name="l06092"></a>06092                 <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l06093"></a>06093             <a class="code" href="../../db/d2e/intern_8h.html#a6448f20b0936afe0cb85ab3186753db2">rb_update_max_fd</a>(fd);
<a name="l06094"></a>06094         }
<a name="l06095"></a>06095         <span class="keywordflow">else</span> {
<a name="l06096"></a>06096             fclose(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a>);
<a name="l06097"></a>06097             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a> = 0;
<a name="l06098"></a>06098             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> = -1;
<a name="l06099"></a>06099             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d90/missing_8h.html#a1a7dc1d5f4ee5da620088e280e4bc580">dup2</a>(fd2, fd) &lt; 0)
<a name="l06100"></a>06100                 <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l06101"></a>06101             <a class="code" href="../../db/d2e/intern_8h.html#a6448f20b0936afe0cb85ab3186753db2">rb_update_max_fd</a>(fd);
<a name="l06102"></a>06102             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> = fd;
<a name="l06103"></a>06103         }
<a name="l06104"></a>06104         <a class="code" href="../../db/d2e/intern_8h.html#ad157720b45b21621915e6eb87721ca6a">rb_thread_fd_close</a>(fd);
<a name="l06105"></a>06105         <span class="keywordflow">if</span> ((orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>) &amp;&amp; pos &gt;= 0) {
<a name="l06106"></a>06106             <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a08a06c385029a1ebff645c082bf5b839">io_seek</a>(fptr, pos, <a class="code" href="../../df/d0a/io_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">SEEK_SET</a>) &lt; 0 &amp;&amp; <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l06107"></a>06107                 <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l06108"></a>06108             }
<a name="l06109"></a>06109             <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a08a06c385029a1ebff645c082bf5b839">io_seek</a>(orig, pos, <a class="code" href="../../df/d0a/io_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">SEEK_SET</a>) &lt; 0 &amp;&amp; <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l06110"></a>06110                 <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l06111"></a>06111             }
<a name="l06112"></a>06112         }
<a name="l06113"></a>06113     }
<a name="l06114"></a>06114 
<a name="l06115"></a>06115     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>) {
<a name="l06116"></a>06116         <a class="code" href="../../db/d2e/intern_8h.html#adb93518ea7f5fdcf897359c214c03254">rb_io_binmode</a>(io);
<a name="l06117"></a>06117     }
<a name="l06118"></a>06118 
<a name="l06119"></a>06119     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1d4c05021aacd8cab989ff60f95ebe2d">RBASIC</a>(io)-&gt;klass = <a class="code" href="../../db/d2e/intern_8h.html#ac2be7243e739fa8f5dce6be0c8ee5f6d">rb_obj_class</a>(nfile);
<a name="l06120"></a>06120     <span class="keywordflow">return</span> io;
<a name="l06121"></a>06121 }
<a name="l06122"></a>06122 
<a name="l06123"></a>06123 <span class="comment">/*</span>
<a name="l06124"></a>06124 <span class="comment"> *  call-seq:</span>
<a name="l06125"></a>06125 <span class="comment"> *     ios.reopen(other_IO)         -&gt; ios</span>
<a name="l06126"></a>06126 <span class="comment"> *     ios.reopen(path, mode_str)   -&gt; ios</span>
<a name="l06127"></a>06127 <span class="comment"> *</span>
<a name="l06128"></a>06128 <span class="comment"> *  Reassociates &lt;em&gt;ios&lt;/em&gt; with the I/O stream given in</span>
<a name="l06129"></a>06129 <span class="comment"> *  &lt;i&gt;other_IO&lt;/i&gt; or to a new stream opened on &lt;i&gt;path&lt;/i&gt;. This may</span>
<a name="l06130"></a>06130 <span class="comment"> *  dynamically change the actual class of this stream.</span>
<a name="l06131"></a>06131 <span class="comment"> *</span>
<a name="l06132"></a>06132 <span class="comment"> *     f1 = File.new(&quot;testfile&quot;)</span>
<a name="l06133"></a>06133 <span class="comment"> *     f2 = File.new(&quot;testfile&quot;)</span>
<a name="l06134"></a>06134 <span class="comment"> *     f2.readlines[0]   #=&gt; &quot;This is line one\n&quot;</span>
<a name="l06135"></a>06135 <span class="comment"> *     f2.reopen(f1)     #=&gt; #&lt;File:testfile&gt;</span>
<a name="l06136"></a>06136 <span class="comment"> *     f2.readlines[0]   #=&gt; &quot;This is line one\n&quot;</span>
<a name="l06137"></a>06137 <span class="comment"> */</span>
<a name="l06138"></a>06138 
<a name="l06139"></a>06139 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06140"></a><a class="code" href="../../df/d0a/io_8c.html#a31c3d0d5ac3fed0515858687beef0c97">06140</a> <a class="code" href="../../df/d0a/io_8c.html#a31c3d0d5ac3fed0515858687beef0c97">rb_io_reopen</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> file)
<a name="l06141"></a>06141 {
<a name="l06142"></a>06142     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> fname, nmode;
<a name="l06143"></a>06143     <span class="keywordtype">int</span> oflags;
<a name="l06144"></a>06144     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l06145"></a>06145 
<a name="l06146"></a>06146     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a98b91af598acb64fe8497413ce498766">rb_secure</a>(4);
<a name="l06147"></a>06147     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;11&quot;</span>, &amp;fname, &amp;nmode) == 1) {
<a name="l06148"></a>06148         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> tmp = <a class="code" href="../../df/d0a/io_8c.html#ab5d27e6f0fb8f238d3ab912a34316563">rb_io_check_io</a>(fname);
<a name="l06149"></a>06149         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(tmp)) {
<a name="l06150"></a>06150             <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#aa77290573232e6f565c73dcea84a5ce3">io_reopen</a>(file, tmp);
<a name="l06151"></a>06151         }
<a name="l06152"></a>06152     }
<a name="l06153"></a>06153 
<a name="l06154"></a>06154     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a66b35e3e022b499db72f5df63bb1d358">FilePathValue</a>(fname);
<a name="l06155"></a>06155     <a class="code" href="../../dc/dac/io_8h.html#a68e7deaa22cac98e654c80bd7fe187f4">rb_io_taint_check</a>(file);
<a name="l06156"></a>06156     fptr = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(file)-&gt;fptr;
<a name="l06157"></a>06157     <span class="keywordflow">if</span> (!fptr) {
<a name="l06158"></a>06158         fptr = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(file)-&gt;fptr = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac8df5a8a8961bd9e16be385fef28c2f2">ALLOC</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a>);
<a name="l06159"></a>06159         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a56d620b94b668ed7665d1616b2c54e48">MEMZERO</a>(fptr, <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a>, 1);
<a name="l06160"></a>06160     }
<a name="l06161"></a>06161 
<a name="l06162"></a>06162     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(nmode)) {
<a name="l06163"></a>06163         <span class="keywordtype">int</span> <a class="code" href="../../df/d0a/io_8c.html#a8d9cc2340b814767e83294570cafa7fd">fmode</a> = <a class="code" href="../../dc/dac/io_8h.html#a0c32c67101e6698b9b314041ac5025f4">rb_io_modestr_fmode</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(nmode));
<a name="l06164"></a>06164         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#ae96f61e7e8ed6ac314a838919617ccee">IS_PREP_STDIO</a>(fptr) &amp;&amp;
<a name="l06165"></a>06165             ((fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a289245342d513a229938e5f8700648b5">FMODE_READWRITE</a>) &amp; (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a289245342d513a229938e5f8700648b5">FMODE_READWRITE</a>)) !=
<a name="l06166"></a>06166             (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; FMODE_READWRITE)) {
<a name="l06167"></a>06167             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>,
<a name="l06168"></a>06168                      <span class="stringliteral">&quot;%s can&apos;t change access mode from \&quot;%s\&quot; to \&quot;%s\&quot;&quot;</span>,
<a name="l06169"></a>06169                      <a class="code" href="../../df/d0a/io_8c.html#a8023d58d05a057f4d67c135295be3f5c">PREP_STDIO_NAME</a>(fptr), <a class="code" href="../../df/d0a/io_8c.html#af98084269e66d5b168e2e2b985209e00">rb_io_fmode_modestr</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a>),
<a name="l06170"></a>06170                      <a class="code" href="../../df/d0a/io_8c.html#af98084269e66d5b168e2e2b985209e00">rb_io_fmode_modestr</a>(fmode));
<a name="l06171"></a>06171         }
<a name="l06172"></a>06172         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> = fmode;
<a name="l06173"></a>06173         <a class="code" href="../../df/d0a/io_8c.html#a96729c493ef5726a2c38c94dc096a76e">rb_io_mode_enc</a>(fptr, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(nmode));
<a name="l06174"></a>06174         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags = 0;
<a name="l06175"></a>06175         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecopts = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l06176"></a>06176     }
<a name="l06177"></a>06177 
<a name="l06178"></a>06178     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a> = <a class="code" href="../../db/d2e/intern_8h.html#ab771cea1c6187da7a08e9f0bc309a0a6">rb_str_new_frozen</a>(fname);
<a name="l06179"></a>06179     oflags = <a class="code" href="../../df/d0a/io_8c.html#abe73106951f1bd614c978445ace2af9e">rb_io_fmode_oflags</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a>);
<a name="l06180"></a>06180     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> &lt; 0) {
<a name="l06181"></a>06181         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> = <a class="code" href="../../df/d0a/io_8c.html#a42654a6f8234decb8c183204f42e1b8a">rb_sysopen</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>, oflags, 0666);
<a name="l06182"></a>06182         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a> = 0;
<a name="l06183"></a>06183         <span class="keywordflow">return</span> file;
<a name="l06184"></a>06184     }
<a name="l06185"></a>06185 
<a name="l06186"></a>06186     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>) {
<a name="l06187"></a>06187         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(fptr) &lt; 0)
<a name="l06188"></a>06188             <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l06189"></a>06189     }
<a name="l06190"></a>06190     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#ac28eb294504ec4b94ac09d6bcefe5127">off</a> = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a> = 0;
<a name="l06191"></a>06191 
<a name="l06192"></a>06192     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a>) {
<a name="l06193"></a>06193         <span class="keywordflow">if</span> (freopen(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>), <a class="code" href="../../df/d0a/io_8c.html#a36c0d38dddc4c2872ea006caf5c59471">rb_io_oflags_modestr</a>(oflags), fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a>) == 0) {
<a name="l06194"></a>06194             <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l06195"></a>06195         }
<a name="l06196"></a>06196         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> = <a class="code" href="../../da/d50/vsnprintf_8c.html#a7aa82a32f4ad97a0107302dae80a2b1e">fileno</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a>);
<a name="l06197"></a>06197 <span class="preprocessor">#ifdef USE_SETVBUF</span>
<a name="l06198"></a>06198 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (setvbuf(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, _IOFBF, 0) != 0)
<a name="l06199"></a>06199             <a class="code" href="../../db/dcc/error_8c.html#aa5b1972d475e9a090c8ef607ce033008">rb_warn</a>(<span class="stringliteral">&quot;setvbuf() can&apos;t be honoured for %s&quot;</span>, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>));
<a name="l06200"></a>06200 <span class="preprocessor">#endif</span>
<a name="l06201"></a>06201 <span class="preprocessor"></span>    }
<a name="l06202"></a>06202     <span class="keywordflow">else</span> {
<a name="l06203"></a>06203         <span class="keywordflow">if</span> (close(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>) &lt; 0)
<a name="l06204"></a>06204             <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l06205"></a>06205         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> = -1;
<a name="l06206"></a>06206         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> = <a class="code" href="../../df/d0a/io_8c.html#a42654a6f8234decb8c183204f42e1b8a">rb_sysopen</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>, oflags, 0666);
<a name="l06207"></a>06207     }
<a name="l06208"></a>06208 
<a name="l06209"></a>06209     <span class="keywordflow">return</span> file;
<a name="l06210"></a>06210 }
<a name="l06211"></a>06211 
<a name="l06212"></a>06212 <span class="comment">/* :nodoc: */</span>
<a name="l06213"></a>06213 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06214"></a><a class="code" href="../../df/d0a/io_8c.html#a53737e0fba68b3e6b773e78f2873c4ad">06214</a> <a class="code" href="../../df/d0a/io_8c.html#a53737e0fba68b3e6b773e78f2873c4ad">rb_io_init_copy</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> dest, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l06215"></a>06215 {
<a name="l06216"></a>06216     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, *orig;
<a name="l06217"></a>06217     <span class="keywordtype">int</span> fd;
<a name="l06218"></a>06218     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write_io;
<a name="l06219"></a>06219     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> pos;
<a name="l06220"></a>06220 
<a name="l06221"></a>06221     io = <a class="code" href="../../db/d2e/intern_8h.html#abc8a40f163cccdca6e3b9c0db7ed24b3">rb_io_get_io</a>(io);
<a name="l06222"></a>06222     <span class="keywordflow">if</span> (dest == io) <span class="keywordflow">return</span> dest;
<a name="l06223"></a>06223     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, orig);
<a name="l06224"></a>06224     <a class="code" href="../../dc/dac/io_8h.html#a806072dc06b95702f12c2d59e815cfde">MakeOpenFile</a>(dest, fptr);
<a name="l06225"></a>06225 
<a name="l06226"></a>06226     <a class="code" href="../../db/d2e/intern_8h.html#a773ecf32a05c03d4ca1da8cf31bbfc29">rb_io_flush</a>(io);
<a name="l06227"></a>06227 
<a name="l06228"></a>06228     <span class="comment">/* copy rb_io_t structure */</span>
<a name="l06229"></a>06229     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> = orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; ~<a class="code" href="../../df/d0a/io_8c.html#a8d840b75e901aaf536355307ebef1291">FMODE_PREP</a>;
<a name="l06230"></a>06230     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a> = orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>;
<a name="l06231"></a>06231     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6080b18e6883f70d36a1c1554761ccfe">pid</a> = orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a6080b18e6883f70d36a1c1554761ccfe">pid</a>;
<a name="l06232"></a>06232     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a397be62fbdfe88a3763377f262241ca7">lineno</a> = orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a397be62fbdfe88a3763377f262241ca7">lineno</a>;
<a name="l06233"></a>06233     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>)) fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a> = orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>;
<a name="l06234"></a>06234     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a5a2f6f866626d12df82f61cf98401f8c">finalize</a> = orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a5a2f6f866626d12df82f61cf98401f8c">finalize</a>;
<a name="l06235"></a>06235 <span class="preprocessor">#if defined (__CYGWIN__) || !defined(HAVE_FORK)</span>
<a name="l06236"></a>06236 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a5a2f6f866626d12df82f61cf98401f8c">finalize</a> == <a class="code" href="../../df/d0a/io_8c.html#a6467635964aaf761d2ac9169d217ee63">pipe_finalize</a>)
<a name="l06237"></a>06237         <a class="code" href="../../df/d0a/io_8c.html#a6cee254cfd59ee0a24dc3872fc46de2a">pipe_add_fptr</a>(fptr);
<a name="l06238"></a>06238 <span class="preprocessor">#endif</span>
<a name="l06239"></a>06239 <span class="preprocessor"></span>
<a name="l06240"></a>06240     fd = <a class="code" href="../../df/d0a/io_8c.html#a7c54baedd5063c5e77dd110a969fe844">ruby_dup</a>(orig-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>);
<a name="l06241"></a>06241     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> = fd;
<a name="l06242"></a>06242     pos = <a class="code" href="../../df/d0a/io_8c.html#a05eb5776a3cfb91c2636c607be1ba1e4">io_tell</a>(orig);
<a name="l06243"></a>06243     <span class="keywordflow">if</span> (0 &lt;= pos)
<a name="l06244"></a>06244         <a class="code" href="../../df/d0a/io_8c.html#a08a06c385029a1ebff645c082bf5b839">io_seek</a>(fptr, pos, <a class="code" href="../../df/d0a/io_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">SEEK_SET</a>);
<a name="l06245"></a>06245     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>) {
<a name="l06246"></a>06246         <a class="code" href="../../db/d2e/intern_8h.html#adb93518ea7f5fdcf897359c214c03254">rb_io_binmode</a>(dest);
<a name="l06247"></a>06247     }
<a name="l06248"></a>06248 
<a name="l06249"></a>06249     write_io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l06250"></a>06250     <span class="keywordflow">if</span> (io != write_io) {
<a name="l06251"></a>06251         write_io = <a class="code" href="../../db/d2e/intern_8h.html#a303b384bd946cba1101841237c5c27d0">rb_obj_dup</a>(write_io);
<a name="l06252"></a>06252         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#ad4507dbb812bff2064ead59f235039c2">tied_io_for_writing</a> = write_io;
<a name="l06253"></a>06253         <a class="code" href="../../db/d2e/intern_8h.html#acee88ad0375c8a9080e2283db494d257">rb_ivar_set</a>(dest, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;@tied_io_for_writing&quot;</span>), write_io);
<a name="l06254"></a>06254     }
<a name="l06255"></a>06255 
<a name="l06256"></a>06256     <span class="keywordflow">return</span> dest;
<a name="l06257"></a>06257 }
<a name="l06258"></a>06258 
<a name="l06259"></a>06259 <span class="comment">/*</span>
<a name="l06260"></a>06260 <span class="comment"> *  call-seq:</span>
<a name="l06261"></a>06261 <span class="comment"> *     ios.printf(format_string [, obj, ...])   -&gt; nil</span>
<a name="l06262"></a>06262 <span class="comment"> *</span>
<a name="l06263"></a>06263 <span class="comment"> *  Formats and writes to &lt;em&gt;ios&lt;/em&gt;, converting parameters under</span>
<a name="l06264"></a>06264 <span class="comment"> *  control of the format string. See &lt;code&gt;Kernel#sprintf&lt;/code&gt;</span>
<a name="l06265"></a>06265 <span class="comment"> *  for details.</span>
<a name="l06266"></a>06266 <span class="comment"> */</span>
<a name="l06267"></a>06267 
<a name="l06268"></a>06268 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06269"></a><a class="code" href="../../df/d0a/io_8c.html#a38badf2cb0b09c67962b4fd62a0898ba">06269</a> <a class="code" href="../../db/d2e/intern_8h.html#ab73b37851177d15273fb23ed21b8c564">rb_io_printf</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> out)
<a name="l06270"></a>06270 {
<a name="l06271"></a>06271     <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(out, <a class="code" href="../../db/d2e/intern_8h.html#ab5684a99e0fa5990eb153b4aa9d4cc89">rb_f_sprintf</a>(argc, argv));
<a name="l06272"></a>06272     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l06273"></a>06273 }
<a name="l06274"></a>06274 
<a name="l06275"></a>06275 <span class="comment">/*</span>
<a name="l06276"></a>06276 <span class="comment"> *  call-seq:</span>
<a name="l06277"></a>06277 <span class="comment"> *     printf(io, string [, obj ... ])    -&gt; nil</span>
<a name="l06278"></a>06278 <span class="comment"> *     printf(string [, obj ... ])        -&gt; nil</span>
<a name="l06279"></a>06279 <span class="comment"> *</span>
<a name="l06280"></a>06280 <span class="comment"> *  Equivalent to:</span>
<a name="l06281"></a>06281 <span class="comment"> *     io.write(sprintf(string, obj, ...)</span>
<a name="l06282"></a>06282 <span class="comment"> *  or</span>
<a name="l06283"></a>06283 <span class="comment"> *     $stdout.write(sprintf(string, obj, ...)</span>
<a name="l06284"></a>06284 <span class="comment"> */</span>
<a name="l06285"></a>06285 
<a name="l06286"></a>06286 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06287"></a><a class="code" href="../../df/d0a/io_8c.html#a7eb879db72bbf694163f5808c4729b75">06287</a> <a class="code" href="../../df/d0a/io_8c.html#a7eb879db72bbf694163f5808c4729b75">rb_f_printf</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>)
<a name="l06288"></a>06288 {
<a name="l06289"></a>06289     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> out;
<a name="l06290"></a>06290 
<a name="l06291"></a>06291     <span class="keywordflow">if</span> (argc == 0) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l06292"></a>06292     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(argv[0]) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a22a8c2a4bbaae9b68f65c9bb92fd4e39">T_STRING</a>) {
<a name="l06293"></a>06293         out = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>;
<a name="l06294"></a>06294     }
<a name="l06295"></a>06295     <span class="keywordflow">else</span> {
<a name="l06296"></a>06296         out = argv[0];
<a name="l06297"></a>06297         argv++;
<a name="l06298"></a>06298         argc--;
<a name="l06299"></a>06299     }
<a name="l06300"></a>06300     <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(out, <a class="code" href="../../db/d2e/intern_8h.html#ab5684a99e0fa5990eb153b4aa9d4cc89">rb_f_sprintf</a>(argc, argv));
<a name="l06301"></a>06301 
<a name="l06302"></a>06302     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l06303"></a>06303 }
<a name="l06304"></a>06304 
<a name="l06305"></a>06305 <span class="comment">/*</span>
<a name="l06306"></a>06306 <span class="comment"> *  call-seq:</span>
<a name="l06307"></a>06307 <span class="comment"> *     ios.print()             -&gt; nil</span>
<a name="l06308"></a>06308 <span class="comment"> *     ios.print(obj, ...)     -&gt; nil</span>
<a name="l06309"></a>06309 <span class="comment"> *</span>
<a name="l06310"></a>06310 <span class="comment"> *  Writes the given object(s) to &lt;em&gt;ios&lt;/em&gt;. The stream must be</span>
<a name="l06311"></a>06311 <span class="comment"> *  opened for writing. If the output field separator (&lt;code&gt;$,&lt;/code&gt;)</span>
<a name="l06312"></a>06312 <span class="comment"> *  is not &lt;code&gt;nil&lt;/code&gt;, it will be inserted between each object.</span>
<a name="l06313"></a>06313 <span class="comment"> *  If the output record separator (&lt;code&gt;$\&lt;/code&gt;)</span>
<a name="l06314"></a>06314 <span class="comment"> *  is not &lt;code&gt;nil&lt;/code&gt;, it will be appended to the output. If no</span>
<a name="l06315"></a>06315 <span class="comment"> *  arguments are given, prints &lt;code&gt;$_&lt;/code&gt;. Objects that aren&apos;t</span>
<a name="l06316"></a>06316 <span class="comment"> *  strings will be converted by calling their &lt;code&gt;to_s&lt;/code&gt; method.</span>
<a name="l06317"></a>06317 <span class="comment"> *  With no argument, prints the contents of the variable &lt;code&gt;$_&lt;/code&gt;.</span>
<a name="l06318"></a>06318 <span class="comment"> *  Returns &lt;code&gt;nil&lt;/code&gt;.</span>
<a name="l06319"></a>06319 <span class="comment"> *</span>
<a name="l06320"></a>06320 <span class="comment"> *     $stdout.print(&quot;This is &quot;, 100, &quot; percent.\n&quot;)</span>
<a name="l06321"></a>06321 <span class="comment"> *</span>
<a name="l06322"></a>06322 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l06323"></a>06323 <span class="comment"> *</span>
<a name="l06324"></a>06324 <span class="comment"> *     This is 100 percent.</span>
<a name="l06325"></a>06325 <span class="comment"> */</span>
<a name="l06326"></a>06326 
<a name="l06327"></a>06327 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06328"></a><a class="code" href="../../df/d0a/io_8c.html#afe817473eb851b2c50b6882fb46e9db6">06328</a> <a class="code" href="../../db/d2e/intern_8h.html#a5224149a04b11c155dd7ed90abca45a4">rb_io_print</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> out)
<a name="l06329"></a>06329 {
<a name="l06330"></a>06330     <span class="keywordtype">int</span> i;
<a name="l06331"></a>06331     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> line;
<a name="l06332"></a>06332 
<a name="l06333"></a>06333     <span class="comment">/* if no argument given, print `$_&apos; */</span>
<a name="l06334"></a>06334     <span class="keywordflow">if</span> (argc == 0) {
<a name="l06335"></a>06335         argc = 1;
<a name="l06336"></a>06336         line = <a class="code" href="../../db/d2e/intern_8h.html#ac185acdaeb1aadf3f4297609e05fd083">rb_lastline_get</a>();
<a name="l06337"></a>06337         argv = &amp;line;
<a name="l06338"></a>06338     }
<a name="l06339"></a>06339     <span class="keywordflow">for</span> (i=0; i&lt;argc; i++) {
<a name="l06340"></a>06340         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(<a class="code" href="../../dc/dcc/array_8c.html#ac8351f37c8a5de2cc8cd638f7d515396">rb_output_fs</a>) &amp;&amp; i&gt;0) {
<a name="l06341"></a>06341             <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(out, <a class="code" href="../../dc/dcc/array_8c.html#ac8351f37c8a5de2cc8cd638f7d515396">rb_output_fs</a>);
<a name="l06342"></a>06342         }
<a name="l06343"></a>06343         <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(out, argv[i]);
<a name="l06344"></a>06344     }
<a name="l06345"></a>06345     <span class="keywordflow">if</span> (argc &gt; 0 &amp;&amp; !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(<a class="code" href="../../db/d2e/intern_8h.html#aad25f1b1b54e12dcb609374f46cfd0e5">rb_output_rs</a>)) {
<a name="l06346"></a>06346         <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(out, <a class="code" href="../../db/d2e/intern_8h.html#aad25f1b1b54e12dcb609374f46cfd0e5">rb_output_rs</a>);
<a name="l06347"></a>06347     }
<a name="l06348"></a>06348 
<a name="l06349"></a>06349     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l06350"></a>06350 }
<a name="l06351"></a>06351 
<a name="l06352"></a>06352 <span class="comment">/*</span>
<a name="l06353"></a>06353 <span class="comment"> *  call-seq:</span>
<a name="l06354"></a>06354 <span class="comment"> *     print(obj, ...)    -&gt; nil</span>
<a name="l06355"></a>06355 <span class="comment"> *</span>
<a name="l06356"></a>06356 <span class="comment"> *  Prints each object in turn to &lt;code&gt;$stdout&lt;/code&gt;. If the output</span>
<a name="l06357"></a>06357 <span class="comment"> *  field separator (&lt;code&gt;$,&lt;/code&gt;) is not +nil+, its</span>
<a name="l06358"></a>06358 <span class="comment"> *  contents will appear between each field. If the output record</span>
<a name="l06359"></a>06359 <span class="comment"> *  separator (&lt;code&gt;$\&lt;/code&gt;) is not +nil+, it will be</span>
<a name="l06360"></a>06360 <span class="comment"> *  appended to the output. If no arguments are given, prints</span>
<a name="l06361"></a>06361 <span class="comment"> *  &lt;code&gt;$_&lt;/code&gt;. Objects that aren&apos;t strings will be converted by</span>
<a name="l06362"></a>06362 <span class="comment"> *  calling their &lt;code&gt;to_s&lt;/code&gt; method.</span>
<a name="l06363"></a>06363 <span class="comment"> *</span>
<a name="l06364"></a>06364 <span class="comment"> *     print &quot;cat&quot;, [1,2,3], 99, &quot;\n&quot;</span>
<a name="l06365"></a>06365 <span class="comment"> *     $, = &quot;, &quot;</span>
<a name="l06366"></a>06366 <span class="comment"> *     $\ = &quot;\n&quot;</span>
<a name="l06367"></a>06367 <span class="comment"> *     print &quot;cat&quot;, [1,2,3], 99</span>
<a name="l06368"></a>06368 <span class="comment"> *</span>
<a name="l06369"></a>06369 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l06370"></a>06370 <span class="comment"> *</span>
<a name="l06371"></a>06371 <span class="comment"> *     cat12399</span>
<a name="l06372"></a>06372 <span class="comment"> *     cat, 1, 2, 3, 99</span>
<a name="l06373"></a>06373 <span class="comment"> */</span>
<a name="l06374"></a>06374 
<a name="l06375"></a>06375 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06376"></a><a class="code" href="../../df/d0a/io_8c.html#a0630de87ee55f257fef2426aaa6887de">06376</a> <a class="code" href="../../df/d0a/io_8c.html#a0630de87ee55f257fef2426aaa6887de">rb_f_print</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>)
<a name="l06377"></a>06377 {
<a name="l06378"></a>06378     <a class="code" href="../../db/d2e/intern_8h.html#a5224149a04b11c155dd7ed90abca45a4">rb_io_print</a>(argc, argv, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>);
<a name="l06379"></a>06379     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l06380"></a>06380 }
<a name="l06381"></a>06381 
<a name="l06382"></a>06382 <span class="comment">/*</span>
<a name="l06383"></a>06383 <span class="comment"> *  call-seq:</span>
<a name="l06384"></a>06384 <span class="comment"> *     ios.putc(obj)    -&gt; obj</span>
<a name="l06385"></a>06385 <span class="comment"> *</span>
<a name="l06386"></a>06386 <span class="comment"> *  If &lt;i&gt;obj&lt;/i&gt; is &lt;code&gt;Numeric&lt;/code&gt;, write the character whose code is</span>
<a name="l06387"></a>06387 <span class="comment"> *  the least-significant byte of &lt;i&gt;obj&lt;/i&gt;, otherwise write the first byte</span>
<a name="l06388"></a>06388 <span class="comment"> *  of the string representation of &lt;i&gt;obj&lt;/i&gt; to &lt;em&gt;ios&lt;/em&gt;. Note: This</span>
<a name="l06389"></a>06389 <span class="comment"> *  method is not safe for use with multi-byte characters as it will truncate</span>
<a name="l06390"></a>06390 <span class="comment"> *  them.</span>
<a name="l06391"></a>06391 <span class="comment"> *</span>
<a name="l06392"></a>06392 <span class="comment"> *     $stdout.putc &quot;A&quot;</span>
<a name="l06393"></a>06393 <span class="comment"> *     $stdout.putc 65</span>
<a name="l06394"></a>06394 <span class="comment"> *</span>
<a name="l06395"></a>06395 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l06396"></a>06396 <span class="comment"> *</span>
<a name="l06397"></a>06397 <span class="comment"> *     AA</span>
<a name="l06398"></a>06398 <span class="comment"> */</span>
<a name="l06399"></a>06399 
<a name="l06400"></a>06400 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06401"></a><a class="code" href="../../df/d0a/io_8c.html#a1990ad98c29175470468993aed279507">06401</a> <a class="code" href="../../df/d0a/io_8c.html#a1990ad98c29175470468993aed279507">rb_io_putc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ch)
<a name="l06402"></a>06402 {
<a name="l06403"></a>06403     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str;
<a name="l06404"></a>06404     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(ch) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a22a8c2a4bbaae9b68f65c9bb92fd4e39">T_STRING</a>) {
<a name="l06405"></a>06405         str = <a class="code" href="../../db/d2e/intern_8h.html#a61efad31b183f52fe068b4c0daf8fdd9">rb_str_substr</a>(ch, 0, 1);
<a name="l06406"></a>06406     }
<a name="l06407"></a>06407     <span class="keywordflow">else</span> {
<a name="l06408"></a>06408         <span class="keywordtype">char</span> c = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e590fcd88a41f2e258f98cc30ed4994">NUM2CHR</a>(ch);
<a name="l06409"></a>06409         str = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(&amp;c, 1);
<a name="l06410"></a>06410     }
<a name="l06411"></a>06411     <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(io, str);
<a name="l06412"></a>06412     <span class="keywordflow">return</span> ch;
<a name="l06413"></a>06413 }
<a name="l06414"></a>06414 
<a name="l06415"></a>06415 <span class="comment">/*</span>
<a name="l06416"></a>06416 <span class="comment"> *  call-seq:</span>
<a name="l06417"></a>06417 <span class="comment"> *     putc(int)   -&gt; int</span>
<a name="l06418"></a>06418 <span class="comment"> *</span>
<a name="l06419"></a>06419 <span class="comment"> *  Equivalent to:</span>
<a name="l06420"></a>06420 <span class="comment"> *</span>
<a name="l06421"></a>06421 <span class="comment"> *    $stdout.putc(int)</span>
<a name="l06422"></a>06422 <span class="comment"> *</span>
<a name="l06423"></a>06423 <span class="comment"> * Refer to the documentation for IO#putc for important information regarding</span>
<a name="l06424"></a>06424 <span class="comment"> * multi-byte characters.</span>
<a name="l06425"></a>06425 <span class="comment"> */</span>
<a name="l06426"></a>06426 
<a name="l06427"></a>06427 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06428"></a><a class="code" href="../../df/d0a/io_8c.html#a6abbd909304a63045cf3cef698eeb4f3">06428</a> <a class="code" href="../../df/d0a/io_8c.html#a6abbd909304a63045cf3cef698eeb4f3">rb_f_putc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> recv, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ch)
<a name="l06429"></a>06429 {
<a name="l06430"></a>06430     <span class="keywordflow">if</span> (recv == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>) {
<a name="l06431"></a>06431         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a1990ad98c29175470468993aed279507">rb_io_putc</a>(recv, ch);
<a name="l06432"></a>06432     }
<a name="l06433"></a>06433     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#adafa8fd17636821445380e7e1881355e" title="Calls a method.">rb_funcall2</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;putc&quot;</span>), 1, &amp;ch);
<a name="l06434"></a>06434 }
<a name="l06435"></a>06435 
<a name="l06436"></a>06436 
<a name="l06437"></a>06437 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l06438"></a><a class="code" href="../../df/d0a/io_8c.html#adb5dbcaa12cd91eacb4e1390df79c979">06438</a> <a class="code" href="../../df/d0a/io_8c.html#adb5dbcaa12cd91eacb4e1390df79c979">str_end_with_asciichar</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, <span class="keywordtype">int</span> c)
<a name="l06439"></a>06439 {
<a name="l06440"></a>06440     <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str);
<a name="l06441"></a>06441     <span class="keyword">const</span> <span class="keywordtype">char</span> *ptr = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str);
<a name="l06442"></a>06442     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc = <a class="code" href="../../d5/db5/encoding_8c.html#aef9c377b2d9d78b9f88e890b77593109">rb_enc_from_index</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a6ba07266a084d7a480377f1472aabfd8">ENCODING_GET</a>(str));
<a name="l06443"></a>06443     <span class="keywordtype">int</span> n;
<a name="l06444"></a>06444 
<a name="l06445"></a>06445     <span class="keywordflow">if</span> (len == 0) <span class="keywordflow">return</span> 0;
<a name="l06446"></a>06446     <span class="keywordflow">if</span> ((n = <a class="code" href="../../d5/de3/encoding_8h.html#aaffb0395eb9bf0b3ba3175fa5c9c1615">rb_enc_mbminlen</a>(enc)) == 1) {
<a name="l06447"></a>06447         <span class="keywordflow">return</span> ptr[len - 1] == c;
<a name="l06448"></a>06448     }
<a name="l06449"></a>06449     <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#af6663b51ce857cfe600a8bc48434d6f2">rb_enc_ascget</a>(ptr + ((len - 1) / n) * n, ptr + len, &amp;n, enc) == c;
<a name="l06450"></a>06450 }
<a name="l06451"></a>06451 
<a name="l06452"></a>06452 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06453"></a><a class="code" href="../../df/d0a/io_8c.html#a16370a12a33d8f6f0d1851d8ca72396f">06453</a> <a class="code" href="../../df/d0a/io_8c.html#a16370a12a33d8f6f0d1851d8ca72396f">io_puts_ary</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> out, <span class="keywordtype">int</span> <a class="code" href="../../d9/df5/date__strptime_8c.html#a554631207e429ff3f75bc8bacf3806d4">recur</a>)
<a name="l06454"></a>06454 {
<a name="l06455"></a>06455     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> tmp;
<a name="l06456"></a>06456     <span class="keywordtype">long</span> i;
<a name="l06457"></a>06457 
<a name="l06458"></a>06458     <span class="keywordflow">if</span> (recur) {
<a name="l06459"></a>06459         tmp = <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;[...]&quot;</span>);
<a name="l06460"></a>06460         <a class="code" href="../../db/d2e/intern_8h.html#ae85b97b8e0efba41ee0b0da17ae131c6">rb_io_puts</a>(1, &amp;tmp, out);
<a name="l06461"></a>06461         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l06462"></a>06462     }
<a name="l06463"></a>06463     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(ary); i++) {
<a name="l06464"></a>06464         tmp = <a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(ary)[i];
<a name="l06465"></a>06465         <a class="code" href="../../db/d2e/intern_8h.html#ae85b97b8e0efba41ee0b0da17ae131c6">rb_io_puts</a>(1, &amp;tmp, out);
<a name="l06466"></a>06466     }
<a name="l06467"></a>06467     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l06468"></a>06468 }
<a name="l06469"></a>06469 
<a name="l06470"></a>06470 <span class="comment">/*</span>
<a name="l06471"></a>06471 <span class="comment"> *  call-seq:</span>
<a name="l06472"></a>06472 <span class="comment"> *     ios.puts(obj, ...)    -&gt; nil</span>
<a name="l06473"></a>06473 <span class="comment"> *</span>
<a name="l06474"></a>06474 <span class="comment"> *  Writes the given objects to &lt;em&gt;ios&lt;/em&gt; as with</span>
<a name="l06475"></a>06475 <span class="comment"> *  &lt;code&gt;IO#print&lt;/code&gt;. Writes a record separator (typically a</span>
<a name="l06476"></a>06476 <span class="comment"> *  newline) after any that do not already end with a newline sequence.</span>
<a name="l06477"></a>06477 <span class="comment"> *  If called with an array argument, writes each element on a new line.</span>
<a name="l06478"></a>06478 <span class="comment"> *  If called without arguments, outputs a single record separator.</span>
<a name="l06479"></a>06479 <span class="comment"> *</span>
<a name="l06480"></a>06480 <span class="comment"> *     $stdout.puts(&quot;this&quot;, &quot;is&quot;, &quot;a&quot;, &quot;test&quot;)</span>
<a name="l06481"></a>06481 <span class="comment"> *</span>
<a name="l06482"></a>06482 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l06483"></a>06483 <span class="comment"> *</span>
<a name="l06484"></a>06484 <span class="comment"> *     this</span>
<a name="l06485"></a>06485 <span class="comment"> *     is</span>
<a name="l06486"></a>06486 <span class="comment"> *     a</span>
<a name="l06487"></a>06487 <span class="comment"> *     test</span>
<a name="l06488"></a>06488 <span class="comment"> */</span>
<a name="l06489"></a>06489 
<a name="l06490"></a>06490 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06491"></a><a class="code" href="../../df/d0a/io_8c.html#a7e73b2b54a67762b3ca384b738609106">06491</a> <a class="code" href="../../db/d2e/intern_8h.html#ae85b97b8e0efba41ee0b0da17ae131c6">rb_io_puts</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> out)
<a name="l06492"></a>06492 {
<a name="l06493"></a>06493     <span class="keywordtype">int</span> i;
<a name="l06494"></a>06494     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> line;
<a name="l06495"></a>06495 
<a name="l06496"></a>06496     <span class="comment">/* if no argument given, print newline. */</span>
<a name="l06497"></a>06497     <span class="keywordflow">if</span> (argc == 0) {
<a name="l06498"></a>06498         <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(out, <a class="code" href="../../db/d2e/intern_8h.html#ab707a74e9c34626c05d20431ad137570">rb_default_rs</a>);
<a name="l06499"></a>06499         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l06500"></a>06500     }
<a name="l06501"></a>06501     <span class="keywordflow">for</span> (i=0; i&lt;argc; i++) {
<a name="l06502"></a>06502         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(argv[i]) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a22a8c2a4bbaae9b68f65c9bb92fd4e39">T_STRING</a>) {
<a name="l06503"></a>06503             line = argv[i];
<a name="l06504"></a>06504             <span class="keywordflow">goto</span> string;
<a name="l06505"></a>06505         }
<a name="l06506"></a>06506         line = <a class="code" href="../../dc/dcc/array_8c.html#aaa66361aff757dd7ef869f5b84b3793e">rb_check_array_type</a>(argv[i]);
<a name="l06507"></a>06507         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(line)) {
<a name="l06508"></a>06508             <a class="code" href="../../db/d2e/intern_8h.html#ae2fc1974c9016956fcb6152effb4fdaa">rb_exec_recursive</a>(<a class="code" href="../../df/d0a/io_8c.html#a16370a12a33d8f6f0d1851d8ca72396f">io_puts_ary</a>, line, out);
<a name="l06509"></a>06509             <span class="keywordflow">continue</span>;
<a name="l06510"></a>06510         }
<a name="l06511"></a>06511         line = <a class="code" href="../../db/d2e/intern_8h.html#acae5350f5d539c4654e4e33690256a9f">rb_obj_as_string</a>(argv[i]);
<a name="l06512"></a>06512       <span class="keywordtype">string</span>:
<a name="l06513"></a>06513         <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(out, line);
<a name="l06514"></a>06514         <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(line) == 0 ||
<a name="l06515"></a>06515             !<a class="code" href="../../df/d0a/io_8c.html#adb5dbcaa12cd91eacb4e1390df79c979">str_end_with_asciichar</a>(line, <span class="charliteral">&apos;\n&apos;</span>)) {
<a name="l06516"></a>06516             <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(out, <a class="code" href="../../db/d2e/intern_8h.html#ab707a74e9c34626c05d20431ad137570">rb_default_rs</a>);
<a name="l06517"></a>06517         }
<a name="l06518"></a>06518     }
<a name="l06519"></a>06519 
<a name="l06520"></a>06520     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l06521"></a>06521 }
<a name="l06522"></a>06522 
<a name="l06523"></a>06523 <span class="comment">/*</span>
<a name="l06524"></a>06524 <span class="comment"> *  call-seq:</span>
<a name="l06525"></a>06525 <span class="comment"> *     puts(obj, ...)    -&gt; nil</span>
<a name="l06526"></a>06526 <span class="comment"> *</span>
<a name="l06527"></a>06527 <span class="comment"> *  Equivalent to</span>
<a name="l06528"></a>06528 <span class="comment"> *</span>
<a name="l06529"></a>06529 <span class="comment"> *      $stdout.puts(obj, ...)</span>
<a name="l06530"></a>06530 <span class="comment"> */</span>
<a name="l06531"></a>06531 
<a name="l06532"></a>06532 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06533"></a><a class="code" href="../../df/d0a/io_8c.html#a5d2f22da3b51899315d53e2f2b0aa998">06533</a> <a class="code" href="../../df/d0a/io_8c.html#a5d2f22da3b51899315d53e2f2b0aa998">rb_f_puts</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> recv)
<a name="l06534"></a>06534 {
<a name="l06535"></a>06535     <span class="keywordflow">if</span> (recv == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>) {
<a name="l06536"></a>06536         <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#ae85b97b8e0efba41ee0b0da17ae131c6">rb_io_puts</a>(argc, argv, recv);
<a name="l06537"></a>06537     }
<a name="l06538"></a>06538     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#adafa8fd17636821445380e7e1881355e" title="Calls a method.">rb_funcall2</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;puts&quot;</span>), argc, argv);
<a name="l06539"></a>06539 }
<a name="l06540"></a>06540 
<a name="l06541"></a>06541 <span class="keywordtype">void</span>
<a name="l06542"></a><a class="code" href="../../df/d0a/io_8c.html#a540ccadb4b2bebe4242fa6e8459849ea">06542</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a455308b23f64c612b0abbb2868056f78">rb_p</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj) <span class="comment">/* for debug print within C code */</span>
<a name="l06543"></a>06543 {
<a name="l06544"></a>06544     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str = <a class="code" href="../../db/d2e/intern_8h.html#acae5350f5d539c4654e4e33690256a9f">rb_obj_as_string</a>(<a class="code" href="../../db/d2e/intern_8h.html#acbb281bacf6b80f460143348e26142e9">rb_inspect</a>(obj));
<a name="l06545"></a>06545     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a> &amp;&amp;
<a name="l06546"></a>06546         <a class="code" href="../../db/d2e/intern_8h.html#a882b0bb698bfba8a3835bfd51018edba">rb_method_basic_definition_p</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad07df58de9895cbc33c10f02540d2d4d">CLASS_OF</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>), <a class="code" href="../../df/d0a/io_8c.html#a5a1310970981dfb309a18f6a1a9a771b">id_write</a>)) {
<a name="l06547"></a>06547         <a class="code" href="../../df/d0a/io_8c.html#abe88ebe32ee29a9e05e78f43385395de">io_write</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>, str, 1);
<a name="l06548"></a>06548         <a class="code" href="../../df/d0a/io_8c.html#abe88ebe32ee29a9e05e78f43385395de">io_write</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>, <a class="code" href="../../db/d2e/intern_8h.html#ab707a74e9c34626c05d20431ad137570">rb_default_rs</a>, 0);
<a name="l06549"></a>06549     }
<a name="l06550"></a>06550     <span class="keywordflow">else</span> {
<a name="l06551"></a>06551         <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>, str);
<a name="l06552"></a>06552         <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>, <a class="code" href="../../db/d2e/intern_8h.html#ab707a74e9c34626c05d20431ad137570">rb_default_rs</a>);
<a name="l06553"></a>06553     }
<a name="l06554"></a>06554 }
<a name="l06555"></a>06555 
<a name="l06556"></a>06556 <span class="comment">/*</span>
<a name="l06557"></a>06557 <span class="comment"> *  call-seq:</span>
<a name="l06558"></a>06558 <span class="comment"> *     p(obj)              -&gt; obj</span>
<a name="l06559"></a>06559 <span class="comment"> *     p(obj1, obj2, ...)  -&gt; [obj, ...]</span>
<a name="l06560"></a>06560 <span class="comment"> *     p()                 -&gt; nil</span>
<a name="l06561"></a>06561 <span class="comment"> *</span>
<a name="l06562"></a>06562 <span class="comment"> *  For each object, directly writes _obj_.+inspect+ followed by a</span>
<a name="l06563"></a>06563 <span class="comment"> *  newline to the program&apos;s standard output.</span>
<a name="l06564"></a>06564 <span class="comment"> *</span>
<a name="l06565"></a>06565 <span class="comment"> *     S = Struct.new(:name, :state)</span>
<a name="l06566"></a>06566 <span class="comment"> *     s = S[&apos;dave&apos;, &apos;TX&apos;]</span>
<a name="l06567"></a>06567 <span class="comment"> *     p s</span>
<a name="l06568"></a>06568 <span class="comment"> *</span>
<a name="l06569"></a>06569 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l06570"></a>06570 <span class="comment"> *</span>
<a name="l06571"></a>06571 <span class="comment"> *     #&lt;S name=&quot;dave&quot;, state=&quot;TX&quot;&gt;</span>
<a name="l06572"></a>06572 <span class="comment"> */</span>
<a name="l06573"></a>06573 
<a name="l06574"></a>06574 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06575"></a><a class="code" href="../../df/d0a/io_8c.html#a26f49efa8b190dcb42e32f0165bae7d9">06575</a> <a class="code" href="../../df/d0a/io_8c.html#a26f49efa8b190dcb42e32f0165bae7d9">rb_f_p</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l06576"></a>06576 {
<a name="l06577"></a>06577     <span class="keywordtype">int</span> i;
<a name="l06578"></a>06578     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ret = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l06579"></a>06579 
<a name="l06580"></a>06580     <span class="keywordflow">for</span> (i=0; i&lt;argc; i++) {
<a name="l06581"></a>06581         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a455308b23f64c612b0abbb2868056f78">rb_p</a>(argv[i]);
<a name="l06582"></a>06582     }
<a name="l06583"></a>06583     <span class="keywordflow">if</span> (argc == 1) {
<a name="l06584"></a>06584         ret = argv[0];
<a name="l06585"></a>06585     }
<a name="l06586"></a>06586     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argc &gt; 1) {
<a name="l06587"></a>06587         ret = <a class="code" href="../../dc/dcc/array_8c.html#a575a99eebf6ce65893ed83c2b6783d2d">rb_ary_new4</a>(argc, argv);
<a name="l06588"></a>06588     }
<a name="l06589"></a>06589     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a>) {
<a name="l06590"></a>06590         <a class="code" href="../../db/d2e/intern_8h.html#a773ecf32a05c03d4ca1da8cf31bbfc29">rb_io_flush</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>);
<a name="l06591"></a>06591     }
<a name="l06592"></a>06592     <span class="keywordflow">return</span> ret;
<a name="l06593"></a>06593 }
<a name="l06594"></a>06594 
<a name="l06595"></a>06595 <span class="comment">/*</span>
<a name="l06596"></a>06596 <span class="comment"> *  call-seq:</span>
<a name="l06597"></a>06597 <span class="comment"> *     obj.display(port=$&gt;)    -&gt; nil</span>
<a name="l06598"></a>06598 <span class="comment"> *</span>
<a name="l06599"></a>06599 <span class="comment"> *  Prints &lt;i&gt;obj&lt;/i&gt; on the given port (default &lt;code&gt;$&gt;&lt;/code&gt;).</span>
<a name="l06600"></a>06600 <span class="comment"> *  Equivalent to:</span>
<a name="l06601"></a>06601 <span class="comment"> *</span>
<a name="l06602"></a>06602 <span class="comment"> *     def display(port=$&gt;)</span>
<a name="l06603"></a>06603 <span class="comment"> *       port.write self</span>
<a name="l06604"></a>06604 <span class="comment"> *     end</span>
<a name="l06605"></a>06605 <span class="comment"> *</span>
<a name="l06606"></a>06606 <span class="comment"> *  For example:</span>
<a name="l06607"></a>06607 <span class="comment"> *</span>
<a name="l06608"></a>06608 <span class="comment"> *     1.display</span>
<a name="l06609"></a>06609 <span class="comment"> *     &quot;cat&quot;.display</span>
<a name="l06610"></a>06610 <span class="comment"> *     [ 4, 5, 6 ].display</span>
<a name="l06611"></a>06611 <span class="comment"> *     puts</span>
<a name="l06612"></a>06612 <span class="comment"> *</span>
<a name="l06613"></a>06613 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l06614"></a>06614 <span class="comment"> *</span>
<a name="l06615"></a>06615 <span class="comment"> *     1cat456</span>
<a name="l06616"></a>06616 <span class="comment"> */</span>
<a name="l06617"></a>06617 
<a name="l06618"></a>06618 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06619"></a><a class="code" href="../../df/d0a/io_8c.html#acf28c044ff9571013477cb02ca210959">06619</a> <a class="code" href="../../df/d0a/io_8c.html#acf28c044ff9571013477cb02ca210959">rb_obj_display</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l06620"></a>06620 {
<a name="l06621"></a>06621     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> out;
<a name="l06622"></a>06622 
<a name="l06623"></a>06623     <span class="keywordflow">if</span> (argc == 0) {
<a name="l06624"></a>06624         out = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>;
<a name="l06625"></a>06625     }
<a name="l06626"></a>06626     <span class="keywordflow">else</span> {
<a name="l06627"></a>06627         <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;01&quot;</span>, &amp;out);
<a name="l06628"></a>06628     }
<a name="l06629"></a>06629     <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(out, <span class="keyword">self</span>);
<a name="l06630"></a>06630 
<a name="l06631"></a>06631     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l06632"></a>06632 }
<a name="l06633"></a>06633 
<a name="l06634"></a>06634 <span class="keywordtype">void</span>
<a name="l06635"></a><a class="code" href="../../df/d0a/io_8c.html#af348719717ae6e8c20b575def9b482c8">06635</a> <a class="code" href="../../db/d2e/intern_8h.html#abf2dfce0fb7de77f5fe6ceaf50a23913">rb_write_error2</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mesg, <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>)
<a name="l06636"></a>06636 {
<a name="l06637"></a>06637     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1bc7a47b6913bb55b64d881d19da4d03">rb_stderr</a> == <a class="code" href="../../df/d0a/io_8c.html#acf8024d5428fdf61c44bea5ed3e40b55">orig_stderr</a> || <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(<a class="code" href="../../df/d0a/io_8c.html#acf8024d5428fdf61c44bea5ed3e40b55">orig_stderr</a>)-&gt;fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> &lt; 0) {
<a name="l06638"></a>06638         (void)fwrite(mesg, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), len, stderr);
<a name="l06639"></a>06639     }
<a name="l06640"></a>06640     <span class="keywordflow">else</span> {
<a name="l06641"></a>06641         <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1bc7a47b6913bb55b64d881d19da4d03">rb_stderr</a>, <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(mesg, len));
<a name="l06642"></a>06642     }
<a name="l06643"></a>06643 }
<a name="l06644"></a>06644 
<a name="l06645"></a>06645 <span class="keywordtype">void</span>
<a name="l06646"></a><a class="code" href="../../df/d0a/io_8c.html#ae74081450d3290eb71ee35f1be5f5f7e">06646</a> <a class="code" href="../../db/d2e/intern_8h.html#aa1fbc95b7e9c7e0697f0f5c19e2fb2d2">rb_write_error</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mesg)
<a name="l06647"></a>06647 {
<a name="l06648"></a>06648     <a class="code" href="../../db/d2e/intern_8h.html#abf2dfce0fb7de77f5fe6ceaf50a23913">rb_write_error2</a>(mesg, <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(mesg));
<a name="l06649"></a>06649 }
<a name="l06650"></a>06650 
<a name="l06651"></a>06651 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l06652"></a><a class="code" href="../../df/d0a/io_8c.html#ae82a8f23b3d9097a1d4a9c8c40db0f21">06652</a> <a class="code" href="../../df/d0a/io_8c.html#ae82a8f23b3d9097a1d4a9c8c40db0f21">must_respond_to</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> mid, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <span class="keywordtype">id</span>)
<a name="l06653"></a>06653 {
<a name="l06654"></a>06654     <span class="keywordflow">if</span> (!<a class="code" href="../../db/d2e/intern_8h.html#a5c6c63c2619b8c03df2e173ef1e73846">rb_respond_to</a>(val, mid)) {
<a name="l06655"></a>06655         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a565ed9d70f4089e1b4a36e9b3381b8c6">rb_eTypeError</a>, <span class="stringliteral">&quot;%s must have %s method, %s given&quot;</span>,
<a name="l06656"></a>06656                  <a class="code" href="../../d5/d11/ripper_8c.html#a877bc58c495643fcf49dc64c44631e72">rb_id2name</a>(<span class="keywordtype">id</span>), <a class="code" href="../../d5/d11/ripper_8c.html#a877bc58c495643fcf49dc64c44631e72">rb_id2name</a>(mid),
<a name="l06657"></a>06657                  <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9b4f42ada717bfbe7a78830639476aed">rb_obj_classname</a>(val));
<a name="l06658"></a>06658     }
<a name="l06659"></a>06659 }
<a name="l06660"></a>06660 
<a name="l06661"></a>06661 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l06662"></a><a class="code" href="../../df/d0a/io_8c.html#a62b05472f6b4dd7b912f3b3182f32b4d">06662</a> <a class="code" href="../../df/d0a/io_8c.html#a62b05472f6b4dd7b912f3b3182f32b4d">stdout_setter</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <span class="keywordtype">id</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *variable)
<a name="l06663"></a>06663 {
<a name="l06664"></a>06664     <a class="code" href="../../df/d0a/io_8c.html#ae82a8f23b3d9097a1d4a9c8c40db0f21">must_respond_to</a>(<a class="code" href="../../df/d0a/io_8c.html#a5a1310970981dfb309a18f6a1a9a771b">id_write</a>, val, <span class="keywordtype">id</span>);
<a name="l06665"></a>06665     *variable = val;
<a name="l06666"></a>06666 }
<a name="l06667"></a>06667 
<a name="l06668"></a>06668 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06669"></a><a class="code" href="../../df/d0a/io_8c.html#abb0bf6f7784d957186beeb62d0d9c211">06669</a> <a class="code" href="../../df/d0a/io_8c.html#abb0bf6f7784d957186beeb62d0d9c211">prep_io</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> fmode, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass, <span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l06670"></a>06670 {
<a name="l06671"></a>06671     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fp;
<a name="l06672"></a>06672     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io = <a class="code" href="../../df/d0a/io_8c.html#a47f57cf9a8f65858e5cfe7ed56cc65bb">io_alloc</a>(klass);
<a name="l06673"></a>06673 
<a name="l06674"></a>06674     <a class="code" href="../../dc/dac/io_8h.html#a806072dc06b95702f12c2d59e815cfde">MakeOpenFile</a>(io, fp);
<a name="l06675"></a>06675     fp-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> = fd;
<a name="l06676"></a>06676 <span class="preprocessor">#ifdef __CYGWIN__</span>
<a name="l06677"></a>06677 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!isatty(fd)) {
<a name="l06678"></a>06678         fmode |= <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>;
<a name="l06679"></a>06679         setmode(fd, <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>);
<a name="l06680"></a>06680     }
<a name="l06681"></a>06681 <span class="preprocessor">#endif</span>
<a name="l06682"></a>06682 <span class="preprocessor"></span>    fp-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> = fmode;
<a name="l06683"></a>06683     <a class="code" href="../../df/d0a/io_8c.html#a91e87f4790e897c6938dbb2213d0059f">io_check_tty</a>(fp);
<a name="l06684"></a>06684     <span class="keywordflow">if</span> (path) fp-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a> = <a class="code" href="../../db/d2e/intern_8h.html#a8ea3742679211f408cb5769de6cf0d46">rb_obj_freeze</a>(<a class="code" href="../../db/d2e/intern_8h.html#a2b9cc485b0aa1dc270744b8b9eb47569">rb_str_new_cstr</a>(path));
<a name="l06685"></a>06685     <a class="code" href="../../db/d2e/intern_8h.html#a6448f20b0936afe0cb85ab3186753db2">rb_update_max_fd</a>(fd);
<a name="l06686"></a>06686 
<a name="l06687"></a>06687     <span class="keywordflow">return</span> io;
<a name="l06688"></a>06688 }
<a name="l06689"></a>06689 
<a name="l06690"></a>06690 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06691"></a><a class="code" href="../../df/d0a/io_8c.html#a22bf78de24fea3875ff48351409c47f3">06691</a> <a class="code" href="../../db/d2e/intern_8h.html#a3c9f47fa38a9d0ec956e154d4e3d44fe">rb_io_fdopen</a>(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> oflags, <span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l06692"></a>06692 {
<a name="l06693"></a>06693     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>;
<a name="l06694"></a>06694 
<a name="l06695"></a>06695     <span class="keywordflow">if</span> (path &amp;&amp; strcmp(path, <span class="stringliteral">&quot;-&quot;</span>)) klass = <a class="code" href="../../d6/d13/file_8c.html#ae9f03997c2e7a3461524e83053a24ac2">rb_cFile</a>;
<a name="l06696"></a>06696     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#abb0bf6f7784d957186beeb62d0d9c211">prep_io</a>(fd, <a class="code" href="../../dc/dac/io_8h.html#a5c81f2aab2c1cf43fe65b926f8a5bd73">rb_io_oflags_fmode</a>(oflags), klass, path);
<a name="l06697"></a>06697 }
<a name="l06698"></a>06698 
<a name="l06699"></a>06699 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06700"></a><a class="code" href="../../df/d0a/io_8c.html#a1562c4ffdbefb2cfcedd7800789b3b8b">06700</a> <a class="code" href="../../df/d0a/io_8c.html#a1562c4ffdbefb2cfcedd7800789b3b8b">prep_stdio</a>(<a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *f, <span class="keywordtype">int</span> fmode, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass, <span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l06701"></a>06701 {
<a name="l06702"></a>06702     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l06703"></a>06703     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io = <a class="code" href="../../df/d0a/io_8c.html#abb0bf6f7784d957186beeb62d0d9c211">prep_io</a>(<a class="code" href="../../da/d50/vsnprintf_8c.html#a7aa82a32f4ad97a0107302dae80a2b1e">fileno</a>(f), fmode|<a class="code" href="../../df/d0a/io_8c.html#a8d840b75e901aaf536355307ebef1291">FMODE_PREP</a>|<a class="code" href="../../df/d0a/io_8c.html#ab2c655110073a066c789b7e92cf7377c">DEFAULT_TEXTMODE</a>, klass, path);
<a name="l06704"></a>06704 
<a name="l06705"></a>06705     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l06706"></a>06706     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags |= <a class="code" href="../../d5/de3/encoding_8h.html#afae8969f13c765a2a96d810d7049543a">ECONV_DEFAULT_NEWLINE_DECORATOR</a>;
<a name="l06707"></a>06707 <span class="preprocessor">#ifdef TEXTMODE_NEWLINE_DECORATOR_ON_WRITE</span>
<a name="l06708"></a>06708 <span class="preprocessor"></span>    fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags |= TEXTMODE_NEWLINE_DECORATOR_ON_WRITE;
<a name="l06709"></a>06709     <span class="keywordflow">if</span> (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>) {
<a name="l06710"></a>06710         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags |= <a class="code" href="../../d5/de3/encoding_8h.html#a122d5f3118774ae1a01a3262c73141eb">ECONV_UNIVERSAL_NEWLINE_DECORATOR</a>;
<a name="l06711"></a>06711     }
<a name="l06712"></a>06712 <span class="preprocessor">#endif</span>
<a name="l06713"></a>06713 <span class="preprocessor"></span>    fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a> = f;
<a name="l06714"></a>06714 
<a name="l06715"></a>06715     <span class="keywordflow">return</span> io;
<a name="l06716"></a>06716 }
<a name="l06717"></a>06717 
<a name="l06718"></a>06718 <a class="code" href="../../db/ddf/struct____s_f_i_l_e.html">FILE</a> *
<a name="l06719"></a><a class="code" href="../../df/d0a/io_8c.html#a5a0d6757d5f6624ea43d72323e1cb76f">06719</a> <a class="code" href="../../dc/dac/io_8h.html#a5a0d6757d5f6624ea43d72323e1cb76f">rb_io_stdio_file</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr)
<a name="l06720"></a>06720 {
<a name="l06721"></a>06721     <span class="keywordflow">if</span> (!fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a>) {
<a name="l06722"></a>06722         <span class="keywordtype">int</span> oflags = <a class="code" href="../../df/d0a/io_8c.html#abe73106951f1bd614c978445ace2af9e">rb_io_fmode_oflags</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a>);
<a name="l06723"></a>06723         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a> = <a class="code" href="../../dc/dac/io_8h.html#a07c2492c65dc6094210adc71cb362c72">rb_fdopen</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, <a class="code" href="../../df/d0a/io_8c.html#a36c0d38dddc4c2872ea006caf5c59471">rb_io_oflags_modestr</a>(oflags));
<a name="l06724"></a>06724     }
<a name="l06725"></a>06725     <span class="keywordflow">return</span> fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a>;
<a name="l06726"></a>06726 }
<a name="l06727"></a>06727 
<a name="l06728"></a>06728 <span class="comment">/*</span>
<a name="l06729"></a>06729 <span class="comment"> *  call-seq:</span>
<a name="l06730"></a>06730 <span class="comment"> *     IO.new(fd [, mode] [, opt])   -&gt; io</span>
<a name="l06731"></a>06731 <span class="comment"> *</span>
<a name="l06732"></a>06732 <span class="comment"> *  Returns a new IO object (a stream) for the given IO object or integer file</span>
<a name="l06733"></a>06733 <span class="comment"> *  descriptor and mode string.  See also IO.sysopen and IO.for_fd.</span>
<a name="l06734"></a>06734 <span class="comment"> *</span>
<a name="l06735"></a>06735 <span class="comment"> *  === Parameters</span>
<a name="l06736"></a>06736 <span class="comment"> *</span>
<a name="l06737"></a>06737 <span class="comment"> *  fd:: numeric file descriptor or IO object</span>
<a name="l06738"></a>06738 <span class="comment"> *  mode:: file mode. a string or an integer</span>
<a name="l06739"></a>06739 <span class="comment"> *  opt:: hash for specifying +mode+ by name.</span>
<a name="l06740"></a>06740 <span class="comment"> *</span>
<a name="l06741"></a>06741 <span class="comment"> *  ==== Mode</span>
<a name="l06742"></a>06742 <span class="comment"> *</span>
<a name="l06743"></a>06743 <span class="comment"> *  When mode is an integer it must be combination of the modes defined in</span>
<a name="l06744"></a>06744 <span class="comment"> *  File::Constants.</span>
<a name="l06745"></a>06745 <span class="comment"> *</span>
<a name="l06746"></a>06746 <span class="comment"> *  When mode is a string it must be in one of the following forms:</span>
<a name="l06747"></a>06747 <span class="comment"> *  - &quot;fmode&quot;,</span>
<a name="l06748"></a>06748 <span class="comment"> *  - &quot;fmode:extern&quot;,</span>
<a name="l06749"></a>06749 <span class="comment"> *  - &quot;fmode:extern:intern&quot;.</span>
<a name="l06750"></a>06750 <span class="comment"> *  &lt;code&gt;extern&lt;/code&gt; is the external encoding name for the IO.</span>
<a name="l06751"></a>06751 <span class="comment"> *  &lt;code&gt;intern&lt;/code&gt; is the internal encoding.</span>
<a name="l06752"></a>06752 <span class="comment"> *  &lt;code&gt;fmode&lt;/code&gt; must be a file open mode string. See the description of</span>
<a name="l06753"></a>06753 <span class="comment"> *  class IO for mode string directives.</span>
<a name="l06754"></a>06754 <span class="comment"> *</span>
<a name="l06755"></a>06755 <span class="comment"> *  When the mode of original IO is read only, the mode cannot be changed to</span>
<a name="l06756"></a>06756 <span class="comment"> *  be writable.  Similarly, the mode cannot be changed from write only to</span>
<a name="l06757"></a>06757 <span class="comment"> *  readable.</span>
<a name="l06758"></a>06758 <span class="comment"> *</span>
<a name="l06759"></a>06759 <span class="comment"> *  When such a change is attempted the error is raised in different locations</span>
<a name="l06760"></a>06760 <span class="comment"> *  according to the platform.</span>
<a name="l06761"></a>06761 <span class="comment"> *</span>
<a name="l06762"></a>06762 <span class="comment"> *  ==== Options</span>
<a name="l06763"></a>06763 <span class="comment"> *  +opt+ can have the following keys</span>
<a name="l06764"></a>06764 <span class="comment"> *  :mode ::</span>
<a name="l06765"></a>06765 <span class="comment"> *    Same as +mode+ parameter</span>
<a name="l06766"></a>06766 <span class="comment"> *  :external_encoding ::</span>
<a name="l06767"></a>06767 <span class="comment"> *    External encoding for the IO.  &quot;-&quot; is a synonym for the default external</span>
<a name="l06768"></a>06768 <span class="comment"> *    encoding.</span>
<a name="l06769"></a>06769 <span class="comment"> *  :internal_encoding ::</span>
<a name="l06770"></a>06770 <span class="comment"> *    Internal encoding for the IO.  &quot;-&quot; is a synonym for the default internal</span>
<a name="l06771"></a>06771 <span class="comment"> *    encoding.</span>
<a name="l06772"></a>06772 <span class="comment"> *</span>
<a name="l06773"></a>06773 <span class="comment"> *    If the value is nil no conversion occurs.</span>
<a name="l06774"></a>06774 <span class="comment"> *  :encoding ::</span>
<a name="l06775"></a>06775 <span class="comment"> *    Specifies external and internal encodings as &quot;extern:intern&quot;.</span>
<a name="l06776"></a>06776 <span class="comment"> *  :textmode ::</span>
<a name="l06777"></a>06777 <span class="comment"> *    If the value is truth value, same as &quot;t&quot; in argument +mode+.</span>
<a name="l06778"></a>06778 <span class="comment"> *  :binmode ::</span>
<a name="l06779"></a>06779 <span class="comment"> *    If the value is truth value, same as &quot;b&quot; in argument +mode+.</span>
<a name="l06780"></a>06780 <span class="comment"> *  :autoclose ::</span>
<a name="l06781"></a>06781 <span class="comment"> *    If the value is +false+, the +fd+ will be kept open after this IO</span>
<a name="l06782"></a>06782 <span class="comment"> *    instance gets finalized.</span>
<a name="l06783"></a>06783 <span class="comment"> *</span>
<a name="l06784"></a>06784 <span class="comment"> *  Also +opt+ can have same keys in String#encode for controlling conversion</span>
<a name="l06785"></a>06785 <span class="comment"> *  between the external encoding and the internal encoding.</span>
<a name="l06786"></a>06786 <span class="comment"> *</span>
<a name="l06787"></a>06787 <span class="comment"> *  === Example 1</span>
<a name="l06788"></a>06788 <span class="comment"> *</span>
<a name="l06789"></a>06789 <span class="comment"> *    fd = IO.sysopen(&quot;/dev/tty&quot;, &quot;w&quot;)</span>
<a name="l06790"></a>06790 <span class="comment"> *    a = IO.new(fd,&quot;w&quot;)</span>
<a name="l06791"></a>06791 <span class="comment"> *    $stderr.puts &quot;Hello&quot;</span>
<a name="l06792"></a>06792 <span class="comment"> *    a.puts &quot;World&quot;</span>
<a name="l06793"></a>06793 <span class="comment"> *</span>
<a name="l06794"></a>06794 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l06795"></a>06795 <span class="comment"> *</span>
<a name="l06796"></a>06796 <span class="comment"> *    Hello</span>
<a name="l06797"></a>06797 <span class="comment"> *    World</span>
<a name="l06798"></a>06798 <span class="comment"> *</span>
<a name="l06799"></a>06799 <span class="comment"> *  === Example 2</span>
<a name="l06800"></a>06800 <span class="comment"> *</span>
<a name="l06801"></a>06801 <span class="comment"> *    require &apos;fcntl&apos;</span>
<a name="l06802"></a>06802 <span class="comment"> *</span>
<a name="l06803"></a>06803 <span class="comment"> *    fd = STDERR.fcntl(Fcntl::F_DUPFD)</span>
<a name="l06804"></a>06804 <span class="comment"> *    io = IO.new(fd, mode: &apos;w:UTF-16LE&apos;, cr_newline: true)</span>
<a name="l06805"></a>06805 <span class="comment"> *    io.puts &quot;Hello, World!&quot;</span>
<a name="l06806"></a>06806 <span class="comment"> *</span>
<a name="l06807"></a>06807 <span class="comment"> *    fd = STDERR.fcntl(Fcntl::F_DUPFD)</span>
<a name="l06808"></a>06808 <span class="comment"> *    io = IO.new(fd, mode: &apos;w&apos;, cr_newline: true,</span>
<a name="l06809"></a>06809 <span class="comment"> *                external_encoding: Encoding::UTF_16LE)</span>
<a name="l06810"></a>06810 <span class="comment"> *    io.puts &quot;Hello, World!&quot;</span>
<a name="l06811"></a>06811 <span class="comment"> *</span>
<a name="l06812"></a>06812 <span class="comment"> *  Both of above print &quot;Hello, World!&quot; in UTF-16LE to standard error output</span>
<a name="l06813"></a>06813 <span class="comment"> *  with converting EOL generated by &lt;code&gt;puts&lt;/code&gt; to CR.</span>
<a name="l06814"></a>06814 <span class="comment"> */</span>
<a name="l06815"></a>06815 
<a name="l06816"></a>06816 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06817"></a><a class="code" href="../../df/d0a/io_8c.html#a807528178336e7c4195eeb5d95b106cb">06817</a> <a class="code" href="../../df/d0a/io_8c.html#a807528178336e7c4195eeb5d95b106cb">rb_io_initialize</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l06818"></a>06818 {
<a name="l06819"></a>06819     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> fnum, vmode;
<a name="l06820"></a>06820     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fp;
<a name="l06821"></a>06821     <span class="keywordtype">int</span> fd, <a class="code" href="../../df/d0a/io_8c.html#a8d9cc2340b814767e83294570cafa7fd">fmode</a>, oflags = O_RDONLY;
<a name="l06822"></a>06822     <a class="code" href="../../df/d0a/io_8c.html#a8a7a37633499f91b42907cfd1ecea043">convconfig_t</a> convconfig;
<a name="l06823"></a>06823     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opt;
<a name="l06824"></a>06824 <span class="preprocessor">#if defined(HAVE_FCNTL) &amp;&amp; defined(F_GETFL)</span>
<a name="l06825"></a>06825 <span class="preprocessor"></span>    <span class="keywordtype">int</span> ofmode;
<a name="l06826"></a>06826 <span class="preprocessor">#else</span>
<a name="l06827"></a>06827 <span class="preprocessor"></span>    <span class="keyword">struct </span><a class="code" href="../../dc/db1/win32_8h.html#a4feaac5e1913330bded57b059061965b">stat</a> st;
<a name="l06828"></a>06828 <span class="preprocessor">#endif</span>
<a name="l06829"></a>06829 <span class="preprocessor"></span>
<a name="l06830"></a>06830     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a98b91af598acb64fe8497413ce498766">rb_secure</a>(4);
<a name="l06831"></a>06831 
<a name="l06832"></a>06832     argc = <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;11:&quot;</span>, &amp;fnum, &amp;vmode, &amp;opt);
<a name="l06833"></a>06833     <a class="code" href="../../df/d0a/io_8c.html#a13ec2b7ce2ee691474894144cde6c82e">rb_io_extract_modeenc</a>(&amp;vmode, 0, opt, &amp;oflags, &amp;fmode, &amp;convconfig);
<a name="l06834"></a>06834 
<a name="l06835"></a>06835     fd = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(fnum);
<a name="l06836"></a>06836     <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#a99e6a1aee4d7f246bde93617c860767a">rb_reserved_fd_p</a>(fd)) {
<a name="l06837"></a>06837         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;The given fd is not accessible because RubyVM reserves it&quot;</span>);
<a name="l06838"></a>06838     }
<a name="l06839"></a>06839 <span class="preprocessor">#if defined(HAVE_FCNTL) &amp;&amp; defined(F_GETFL)</span>
<a name="l06840"></a>06840 <span class="preprocessor"></span>    oflags = <a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(fd, F_GETFL);
<a name="l06841"></a>06841     <span class="keywordflow">if</span> (oflags == -1) <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l06842"></a>06842 <span class="preprocessor">#else</span>
<a name="l06843"></a>06843 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../dc/db1/win32_8h.html#a8a2cf46df7f7017617df85cdb0afdc64">fstat</a>(fd, &amp;st) == -1) <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l06844"></a>06844 <span class="preprocessor">#endif</span>
<a name="l06845"></a>06845 <span class="preprocessor"></span>    <a class="code" href="../../db/d2e/intern_8h.html#a6448f20b0936afe0cb85ab3186753db2">rb_update_max_fd</a>(fd);
<a name="l06846"></a>06846 <span class="preprocessor">#if defined(HAVE_FCNTL) &amp;&amp; defined(F_GETFL)</span>
<a name="l06847"></a>06847 <span class="preprocessor"></span>    ofmode = <a class="code" href="../../dc/dac/io_8h.html#a5c81f2aab2c1cf43fe65b926f8a5bd73">rb_io_oflags_fmode</a>(oflags);
<a name="l06848"></a>06848     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(vmode)) {
<a name="l06849"></a>06849         fmode = ofmode;
<a name="l06850"></a>06850     }
<a name="l06851"></a>06851     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((~ofmode &amp; fmode) &amp; <a class="code" href="../../dc/dac/io_8h.html#a289245342d513a229938e5f8700648b5">FMODE_READWRITE</a>) {
<a name="l06852"></a>06852         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> error = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(EINVAL);
<a name="l06853"></a>06853         <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(<a class="code" href="../../db/d2e/intern_8h.html#a4e25a1a5ca0fc372179c4f429600bc2a">rb_class_new_instance</a>(1, &amp;error, <a class="code" href="../../db/dcc/error_8c.html#afc4d4f490053e95a5c7311ada9a2efdd">rb_eSystemCallError</a>));
<a name="l06854"></a>06854     }
<a name="l06855"></a>06855 <span class="preprocessor">#endif</span>
<a name="l06856"></a>06856 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(opt) &amp;&amp; <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opt, <a class="code" href="../../df/d0a/io_8c.html#adc69b3a7193b993c16b2db4379b4f90f">sym_autoclose</a>) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>) {
<a name="l06857"></a>06857         fmode |= <a class="code" href="../../df/d0a/io_8c.html#a8d840b75e901aaf536355307ebef1291">FMODE_PREP</a>;
<a name="l06858"></a>06858     }
<a name="l06859"></a>06859     <a class="code" href="../../dc/dac/io_8h.html#a806072dc06b95702f12c2d59e815cfde">MakeOpenFile</a>(io, fp);
<a name="l06860"></a>06860     fp-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a> = fd;
<a name="l06861"></a>06861     fp-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> = fmode;
<a name="l06862"></a>06862     fp-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a> = convconfig;
<a name="l06863"></a>06863     <a class="code" href="../../df/d0a/io_8c.html#a6a7e6fc03722338bbc29fc27ee59ea39">clear_codeconv</a>(fp);
<a name="l06864"></a>06864     <a class="code" href="../../df/d0a/io_8c.html#a91e87f4790e897c6938dbb2213d0059f">io_check_tty</a>(fp);
<a name="l06865"></a>06865     <span class="keywordflow">if</span> (<a class="code" href="../../da/d50/vsnprintf_8c.html#a7aa82a32f4ad97a0107302dae80a2b1e">fileno</a>(stdin) == fd)
<a name="l06866"></a>06866         fp-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a> = stdin;
<a name="l06867"></a>06867     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d50/vsnprintf_8c.html#a7aa82a32f4ad97a0107302dae80a2b1e">fileno</a>(stdout) == fd)
<a name="l06868"></a>06868         fp-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a> = stdout;
<a name="l06869"></a>06869     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../da/d50/vsnprintf_8c.html#a7aa82a32f4ad97a0107302dae80a2b1e">fileno</a>(stderr) == fd)
<a name="l06870"></a>06870         fp-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a91479ddab1e86af11cdac57099dee7f5">stdio_file</a> = stderr;
<a name="l06871"></a>06871 
<a name="l06872"></a>06872     <span class="keywordflow">if</span> (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a1887ab1ec5253a5f363e78092a55348c">FMODE_SETENC_BY_BOM</a>) <a class="code" href="../../df/d0a/io_8c.html#abc37d2836f249b72957c05de008f9963">io_set_encoding_by_bom</a>(io);
<a name="l06873"></a>06873     <span class="keywordflow">return</span> io;
<a name="l06874"></a>06874 }
<a name="l06875"></a>06875 
<a name="l06876"></a>06876 <span class="comment">/*</span>
<a name="l06877"></a>06877 <span class="comment"> *  call-seq:</span>
<a name="l06878"></a>06878 <span class="comment"> *     File.new(filename, mode=&quot;r&quot; [, opt])            -&gt; file</span>
<a name="l06879"></a>06879 <span class="comment"> *     File.new(filename [, mode [, perm]] [, opt])    -&gt; file</span>
<a name="l06880"></a>06880 <span class="comment"> *</span>
<a name="l06881"></a>06881 <span class="comment"> *  Opens the file named by +filename+ according to +mode+ (default is &quot;r&quot;)</span>
<a name="l06882"></a>06882 <span class="comment"> *  and returns a new &lt;code&gt;File&lt;/code&gt; object.</span>
<a name="l06883"></a>06883 <span class="comment"> *</span>
<a name="l06884"></a>06884 <span class="comment"> *  === Parameters</span>
<a name="l06885"></a>06885 <span class="comment"> *</span>
<a name="l06886"></a>06886 <span class="comment"> *  See the description of class IO for a description of +mode+.  The file</span>
<a name="l06887"></a>06887 <span class="comment"> *  mode may optionally be specified as a Fixnum by +or+-ing together the</span>
<a name="l06888"></a>06888 <span class="comment"> *  flags (O_RDONLY etc, again described under +IO+).</span>
<a name="l06889"></a>06889 <span class="comment"> *</span>
<a name="l06890"></a>06890 <span class="comment"> *  Optional permission bits may be given in +perm+.  These mode and</span>
<a name="l06891"></a>06891 <span class="comment"> *  permission bits are platform dependent; on Unix systems, see</span>
<a name="l06892"></a>06892 <span class="comment"> *  &lt;code&gt;open(2)&lt;/code&gt; for details.</span>
<a name="l06893"></a>06893 <span class="comment"> *</span>
<a name="l06894"></a>06894 <span class="comment"> *  Optional +opt+ parameter is same as in IO.open.</span>
<a name="l06895"></a>06895 <span class="comment"> *</span>
<a name="l06896"></a>06896 <span class="comment"> *  === Examples</span>
<a name="l06897"></a>06897 <span class="comment"> *</span>
<a name="l06898"></a>06898 <span class="comment"> *    f = File.new(&quot;testfile&quot;, &quot;r&quot;)</span>
<a name="l06899"></a>06899 <span class="comment"> *    f = File.new(&quot;newfile&quot;,  &quot;w+&quot;)</span>
<a name="l06900"></a>06900 <span class="comment"> *    f = File.new(&quot;newfile&quot;, File::CREAT|File::TRUNC|File::RDWR, 0644)</span>
<a name="l06901"></a>06901 <span class="comment"> */</span>
<a name="l06902"></a>06902 
<a name="l06903"></a>06903 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06904"></a><a class="code" href="../../df/d0a/io_8c.html#a2228ee986dddf2b1cb811eb460097797">06904</a> <a class="code" href="../../df/d0a/io_8c.html#a2228ee986dddf2b1cb811eb460097797">rb_file_initialize</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l06905"></a>06905 {
<a name="l06906"></a>06906     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9638ebe62bc0a0246b7b18a3afac833">RFILE</a>(io)-&gt;fptr) {
<a name="l06907"></a>06907         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a95ad3953d535707e2cf2b1d837f5e253">rb_eRuntimeError</a>, <span class="stringliteral">&quot;reinitializing File&quot;</span>);
<a name="l06908"></a>06908     }
<a name="l06909"></a>06909     <span class="keywordflow">if</span> (0 &lt; argc &amp;&amp; argc &lt; 3) {
<a name="l06910"></a>06910         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> fd = <a class="code" href="../../db/d2e/intern_8h.html#a16e59d05c8eb1641308bc1018c333cc1">rb_check_convert_type</a>(argv[0], <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a523855de5546c34061e030f4606db3e9">T_FIXNUM</a>, <span class="stringliteral">&quot;Fixnum&quot;</span>, <span class="stringliteral">&quot;to_int&quot;</span>);
<a name="l06911"></a>06911 
<a name="l06912"></a>06912         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(fd)) {
<a name="l06913"></a>06913             argv[0] = fd;
<a name="l06914"></a>06914             <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a807528178336e7c4195eeb5d95b106cb">rb_io_initialize</a>(argc, argv, io);
<a name="l06915"></a>06915         }
<a name="l06916"></a>06916     }
<a name="l06917"></a>06917     <a class="code" href="../../df/d0a/io_8c.html#a8b5d31f18b19cf07bbf1d4132b6fd247">rb_open_file</a>(argc, argv, io);
<a name="l06918"></a>06918 
<a name="l06919"></a>06919     <span class="keywordflow">return</span> io;
<a name="l06920"></a>06920 }
<a name="l06921"></a>06921 
<a name="l06922"></a>06922 <span class="comment">/* :nodoc: */</span>
<a name="l06923"></a>06923 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06924"></a><a class="code" href="../../df/d0a/io_8c.html#ade91f74d40154ad9363742520ff5ba10">06924</a> <a class="code" href="../../df/d0a/io_8c.html#ade91f74d40154ad9363742520ff5ba10">rb_io_s_new</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass)
<a name="l06925"></a>06925 {
<a name="l06926"></a>06926     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d57/eval_8c.html#aea346c4eb8bc06df88422e956bb05fec">rb_block_given_p</a>()) {
<a name="l06927"></a>06927         <span class="keyword">const</span> <span class="keywordtype">char</span> *cname = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afd98e957d0d96017f7a07dd83772fadc">rb_class2name</a>(klass);
<a name="l06928"></a>06928 
<a name="l06929"></a>06929         <a class="code" href="../../db/dcc/error_8c.html#aa5b1972d475e9a090c8ef607ce033008">rb_warn</a>(<span class="stringliteral">&quot;%s::new() does not take block; use %s::open() instead&quot;</span>,
<a name="l06930"></a>06930                 cname, cname);
<a name="l06931"></a>06931     }
<a name="l06932"></a>06932     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a4e25a1a5ca0fc372179c4f429600bc2a">rb_class_new_instance</a>(argc, argv, klass);
<a name="l06933"></a>06933 }
<a name="l06934"></a>06934 
<a name="l06935"></a>06935 
<a name="l06936"></a>06936 <span class="comment">/*</span>
<a name="l06937"></a>06937 <span class="comment"> *  call-seq:</span>
<a name="l06938"></a>06938 <span class="comment"> *     IO.for_fd(fd, mode [, opt])    -&gt; io</span>
<a name="l06939"></a>06939 <span class="comment"> *</span>
<a name="l06940"></a>06940 <span class="comment"> *  Synonym for &lt;code&gt;IO.new&lt;/code&gt;.</span>
<a name="l06941"></a>06941 <span class="comment"> *</span>
<a name="l06942"></a>06942 <span class="comment"> */</span>
<a name="l06943"></a>06943 
<a name="l06944"></a>06944 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06945"></a><a class="code" href="../../df/d0a/io_8c.html#ad368222f9c00ad845be00864e9cd0fbb">06945</a> <a class="code" href="../../df/d0a/io_8c.html#ad368222f9c00ad845be00864e9cd0fbb">rb_io_s_for_fd</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass)
<a name="l06946"></a>06946 {
<a name="l06947"></a>06947     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io = <a class="code" href="../../db/d2e/intern_8h.html#a4419d9ed52af0d0dbdcb02f491b1d88d">rb_obj_alloc</a>(klass);
<a name="l06948"></a>06948     <a class="code" href="../../df/d0a/io_8c.html#a807528178336e7c4195eeb5d95b106cb">rb_io_initialize</a>(argc, argv, io);
<a name="l06949"></a>06949     <span class="keywordflow">return</span> io;
<a name="l06950"></a>06950 }
<a name="l06951"></a>06951 
<a name="l06952"></a>06952 <span class="comment">/*</span>
<a name="l06953"></a>06953 <span class="comment"> *  call-seq:</span>
<a name="l06954"></a>06954 <span class="comment"> *     ios.autoclose?   -&gt; true or false</span>
<a name="l06955"></a>06955 <span class="comment"> *</span>
<a name="l06956"></a>06956 <span class="comment"> *  Returns +true+ if the underlying file descriptor of _ios_ will be</span>
<a name="l06957"></a>06957 <span class="comment"> *  closed automatically at its finalization, otherwise +false+.</span>
<a name="l06958"></a>06958 <span class="comment"> */</span>
<a name="l06959"></a>06959 
<a name="l06960"></a>06960 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06961"></a><a class="code" href="../../df/d0a/io_8c.html#adc0d64377d1dc768883a80d20fd9db69">06961</a> <a class="code" href="../../df/d0a/io_8c.html#adc0d64377d1dc768883a80d20fd9db69">rb_io_autoclose_p</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l06962"></a>06962 {
<a name="l06963"></a>06963     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l06964"></a>06964     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a98b91af598acb64fe8497413ce498766">rb_secure</a>(4);
<a name="l06965"></a>06965     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l06966"></a>06966     <span class="keywordflow">return</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../df/d0a/io_8c.html#a8d840b75e901aaf536355307ebef1291">FMODE_PREP</a>) ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l06967"></a>06967 }
<a name="l06968"></a>06968 
<a name="l06969"></a>06969 <span class="comment">/*</span>
<a name="l06970"></a>06970 <span class="comment"> *  call-seq:</span>
<a name="l06971"></a>06971 <span class="comment"> *     io.autoclose = bool    -&gt; true or false</span>
<a name="l06972"></a>06972 <span class="comment"> *</span>
<a name="l06973"></a>06973 <span class="comment"> *  Sets auto-close flag.</span>
<a name="l06974"></a>06974 <span class="comment"> *</span>
<a name="l06975"></a>06975 <span class="comment"> *     f = open(&quot;/dev/null&quot;)</span>
<a name="l06976"></a>06976 <span class="comment"> *     IO.for_fd(f.fileno)</span>
<a name="l06977"></a>06977 <span class="comment"> *     # ...</span>
<a name="l06978"></a>06978 <span class="comment"> *     f.gets # may cause IOError</span>
<a name="l06979"></a>06979 <span class="comment"> *</span>
<a name="l06980"></a>06980 <span class="comment"> *     f = open(&quot;/dev/null&quot;)</span>
<a name="l06981"></a>06981 <span class="comment"> *     IO.for_fd(f.fileno).autoclose = true</span>
<a name="l06982"></a>06982 <span class="comment"> *     # ...</span>
<a name="l06983"></a>06983 <span class="comment"> *     f.gets # won&apos;t cause IOError</span>
<a name="l06984"></a>06984 <span class="comment"> */</span>
<a name="l06985"></a>06985 
<a name="l06986"></a>06986 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l06987"></a><a class="code" href="../../df/d0a/io_8c.html#a3b0eb0d4cdf92e8a28b21a918a1288d7">06987</a> <a class="code" href="../../df/d0a/io_8c.html#a3b0eb0d4cdf92e8a28b21a918a1288d7">rb_io_set_autoclose</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> autoclose)
<a name="l06988"></a>06988 {
<a name="l06989"></a>06989     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l06990"></a>06990     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a98b91af598acb64fe8497413ce498766">rb_secure</a>(4);
<a name="l06991"></a>06991     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l06992"></a>06992     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(autoclose))
<a name="l06993"></a>06993         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> |= <a class="code" href="../../df/d0a/io_8c.html#a8d840b75e901aaf536355307ebef1291">FMODE_PREP</a>;
<a name="l06994"></a>06994     <span class="keywordflow">else</span>
<a name="l06995"></a>06995         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp;= ~<a class="code" href="../../df/d0a/io_8c.html#a8d840b75e901aaf536355307ebef1291">FMODE_PREP</a>;
<a name="l06996"></a>06996     <span class="keywordflow">return</span> io;
<a name="l06997"></a>06997 }
<a name="l06998"></a>06998 
<a name="l06999"></a>06999 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l07000"></a><a class="code" href="../../df/d0a/io_8c.html#a7b46ef52bb604c6adb8db01cad9ee357">07000</a> <a class="code" href="../../df/d0a/io_8c.html#a7b46ef52bb604c6adb8db01cad9ee357">argf_mark</a>(<span class="keywordtype">void</span> *ptr)
<a name="l07001"></a>07001 {
<a name="l07002"></a>07002     <span class="keyword">struct </span><a class="code" href="../../de/d05/structargf.html">argf</a> *p = ptr;
<a name="l07003"></a>07003     <a class="code" href="../../d8/d16/gc_8c.html#a98250264e6adf4924cf2becf80122325">rb_gc_mark</a>(p-&gt;<a class="code" href="../../de/d05/structargf.html#a4a848f6fb0012d835153262d0fe330c7">filename</a>);
<a name="l07004"></a>07004     <a class="code" href="../../d8/d16/gc_8c.html#a98250264e6adf4924cf2becf80122325">rb_gc_mark</a>(p-&gt;<a class="code" href="../../de/d05/structargf.html#abfa2b8324eb7097cebd4574121933a6d">current_file</a>);
<a name="l07005"></a>07005     <a class="code" href="../../d8/d16/gc_8c.html#a98250264e6adf4924cf2becf80122325">rb_gc_mark</a>(p-&gt;<a class="code" href="../../de/d05/structargf.html#ad47f40f415a34eec60ec2c4cda9434f6">argv</a>);
<a name="l07006"></a>07006     <a class="code" href="../../d8/d16/gc_8c.html#a98250264e6adf4924cf2becf80122325">rb_gc_mark</a>(p-&gt;<a class="code" href="../../de/d05/structargf.html#a129a87ec29eaeab30d052a2f3467fce6">encs</a>.ecopts);
<a name="l07007"></a>07007 }
<a name="l07008"></a>07008 
<a name="l07009"></a>07009 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l07010"></a><a class="code" href="../../df/d0a/io_8c.html#aa63b3d6041b083d47b52e4a14fccb805">07010</a> <a class="code" href="../../df/d0a/io_8c.html#aa63b3d6041b083d47b52e4a14fccb805">argf_free</a>(<span class="keywordtype">void</span> *ptr)
<a name="l07011"></a>07011 {
<a name="l07012"></a>07012     <span class="keyword">struct </span><a class="code" href="../../de/d05/structargf.html">argf</a> *p = ptr;
<a name="l07013"></a>07013     <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(p-&gt;<a class="code" href="../../de/d05/structargf.html#a11be549c64517da442bade959ce52f15">inplace</a>);
<a name="l07014"></a>07014     <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(p);
<a name="l07015"></a>07015 }
<a name="l07016"></a>07016 
<a name="l07017"></a>07017 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l07018"></a><a class="code" href="../../df/d0a/io_8c.html#a834888e4b224251128345384b8fb0f19">07018</a> <a class="code" href="../../df/d0a/io_8c.html#a834888e4b224251128345384b8fb0f19">argf_init</a>(<span class="keyword">struct</span> <a class="code" href="../../de/d05/structargf.html">argf</a> *p, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v)
<a name="l07019"></a>07019 {
<a name="l07020"></a>07020     p-&gt;<a class="code" href="../../de/d05/structargf.html#a4a848f6fb0012d835153262d0fe330c7">filename</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l07021"></a>07021     p-&gt;<a class="code" href="../../de/d05/structargf.html#abfa2b8324eb7097cebd4574121933a6d">current_file</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l07022"></a>07022     p-&gt;<a class="code" href="../../de/d05/structargf.html#a7ed7d87a54c68d718f958b304c78d824">lineno</a> = 0;
<a name="l07023"></a>07023     p-&gt;<a class="code" href="../../de/d05/structargf.html#ad47f40f415a34eec60ec2c4cda9434f6">argv</a> = v;
<a name="l07024"></a>07024 }
<a name="l07025"></a>07025 
<a name="l07026"></a>07026 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07027"></a><a class="code" href="../../df/d0a/io_8c.html#ab14e02f069e76464e948f02827440501">07027</a> <a class="code" href="../../df/d0a/io_8c.html#ab14e02f069e76464e948f02827440501">argf_alloc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass)
<a name="l07028"></a>07028 {
<a name="l07029"></a>07029     <span class="keyword">struct </span><a class="code" href="../../de/d05/structargf.html">argf</a> *p;
<a name="l07030"></a>07030     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad80ce51081780f829134de0338821b76">Data_Make_Struct</a>(klass, <span class="keyword">struct</span> argf, <a class="code" href="../../df/d0a/io_8c.html#a7b46ef52bb604c6adb8db01cad9ee357">argf_mark</a>, <a class="code" href="../../df/d0a/io_8c.html#aa63b3d6041b083d47b52e4a14fccb805">argf_free</a>, p);
<a name="l07031"></a>07031 
<a name="l07032"></a>07032     <a class="code" href="../../df/d0a/io_8c.html#a834888e4b224251128345384b8fb0f19">argf_init</a>(p, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l07033"></a>07033     <span class="keywordflow">return</span> argf;
<a name="l07034"></a>07034 }
<a name="l07035"></a>07035 
<a name="l07036"></a>07036 <span class="preprocessor">#undef rb_argv</span>
<a name="l07037"></a>07037 <span class="preprocessor"></span>
<a name="l07038"></a>07038 <span class="comment">/* :nodoc: */</span>
<a name="l07039"></a>07039 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07040"></a><a class="code" href="../../df/d0a/io_8c.html#a81ef7f50a7b4998e9640349bfda3ea03">07040</a> <a class="code" href="../../df/d0a/io_8c.html#a81ef7f50a7b4998e9640349bfda3ea03">argf_initialize</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>)
<a name="l07041"></a>07041 {
<a name="l07042"></a>07042     memset(&amp;<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>));
<a name="l07043"></a>07043     <a class="code" href="../../df/d0a/io_8c.html#a834888e4b224251128345384b8fb0f19">argf_init</a>(&amp;<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>, argv);
<a name="l07044"></a>07044 
<a name="l07045"></a>07045     <span class="keywordflow">return</span> argf;
<a name="l07046"></a>07046 }
<a name="l07047"></a>07047 
<a name="l07048"></a>07048 <span class="comment">/* :nodoc: */</span>
<a name="l07049"></a>07049 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07050"></a><a class="code" href="../../df/d0a/io_8c.html#ab39485d5f45342c7dd8aee8988fb4e1b">07050</a> <a class="code" href="../../df/d0a/io_8c.html#ab39485d5f45342c7dd8aee8988fb4e1b">argf_initialize_copy</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> orig)
<a name="l07051"></a>07051 {
<a name="l07052"></a>07052     <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a> = <a class="code" href="../../df/d0a/io_8c.html#a4054ac142b4963ff020a21031faae606">argf_of</a>(orig);
<a name="l07053"></a>07053     <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.argv = <a class="code" href="../../db/d2e/intern_8h.html#a303b384bd946cba1101841237c5c27d0">rb_obj_dup</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.argv);
<a name="l07054"></a>07054     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace) {
<a name="l07055"></a>07055         <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../de/d05/structargf.html#a11be549c64517da442bade959ce52f15">inplace</a> = <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace;
<a name="l07056"></a>07056         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace = 0;
<a name="l07057"></a>07057         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace = <a class="code" href="../../d8/d3c/util_8h.html#a29a29bcdf6e0d7cc6808f6253e4b0a7f">ruby_strdup</a>(inplace);
<a name="l07058"></a>07058     }
<a name="l07059"></a>07059     <span class="keywordflow">return</span> argf;
<a name="l07060"></a>07060 }
<a name="l07061"></a>07061 
<a name="l07062"></a>07062 <span class="comment">/*</span>
<a name="l07063"></a>07063 <span class="comment"> *  call-seq:</span>
<a name="l07064"></a>07064 <span class="comment"> *     ARGF.lineno = number  -&gt; nil</span>
<a name="l07065"></a>07065 <span class="comment"> *</span>
<a name="l07066"></a>07066 <span class="comment"> *  Sets the line number of +ARGF+ as a whole to the given +Integer+.</span>
<a name="l07067"></a>07067 <span class="comment"> *</span>
<a name="l07068"></a>07068 <span class="comment"> *  +ARGF+ sets the line number automatically as you read data, so normally</span>
<a name="l07069"></a>07069 <span class="comment"> *  you will not need to set it explicitly. To access the current line number</span>
<a name="l07070"></a>07070 <span class="comment"> *  use +ARGF.lineno+.</span>
<a name="l07071"></a>07071 <span class="comment"> *</span>
<a name="l07072"></a>07072 <span class="comment"> *  For example:</span>
<a name="l07073"></a>07073 <span class="comment"> *</span>
<a name="l07074"></a>07074 <span class="comment"> *      ARGF.lineno      #=&gt; 0</span>
<a name="l07075"></a>07075 <span class="comment"> *      ARGF.readline    #=&gt; &quot;This is line 1\n&quot;</span>
<a name="l07076"></a>07076 <span class="comment"> *      ARGF.lineno      #=&gt; 1</span>
<a name="l07077"></a>07077 <span class="comment"> *      ARGF.lineno = 0  #=&gt; nil</span>
<a name="l07078"></a>07078 <span class="comment"> *      ARGF.lineno      #=&gt; 0</span>
<a name="l07079"></a>07079 <span class="comment"> */</span>
<a name="l07080"></a>07080 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07081"></a><a class="code" href="../../df/d0a/io_8c.html#afd0eca424c27a9a9b6085270ba81398b">07081</a> <a class="code" href="../../df/d0a/io_8c.html#afd0eca424c27a9a9b6085270ba81398b">argf_set_lineno</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val)
<a name="l07082"></a>07082 {
<a name="l07083"></a>07083     <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(val);
<a name="l07084"></a>07084     <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.last_lineno = <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno;
<a name="l07085"></a>07085     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l07086"></a>07086 }
<a name="l07087"></a>07087 
<a name="l07088"></a>07088 <span class="comment">/*</span>
<a name="l07089"></a>07089 <span class="comment"> *  call-seq:</span>
<a name="l07090"></a>07090 <span class="comment"> *     ARGF.lineno -&gt; integer</span>
<a name="l07091"></a>07091 <span class="comment"> *</span>
<a name="l07092"></a>07092 <span class="comment"> *  Returns the current line number of ARGF as a whole. This value</span>
<a name="l07093"></a>07093 <span class="comment"> *  can be set manually with +ARGF.lineno=+.</span>
<a name="l07094"></a>07094 <span class="comment"> *</span>
<a name="l07095"></a>07095 <span class="comment"> *  For example:</span>
<a name="l07096"></a>07096 <span class="comment"> *</span>
<a name="l07097"></a>07097 <span class="comment"> *      ARGF.lineno   #=&gt; 0</span>
<a name="l07098"></a>07098 <span class="comment"> *      ARGF.readline #=&gt; &quot;This is line 1\n&quot;</span>
<a name="l07099"></a>07099 <span class="comment"> *      ARGF.lineno   #=&gt; 1</span>
<a name="l07100"></a>07100 <span class="comment"> */</span>
<a name="l07101"></a>07101 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07102"></a><a class="code" href="../../df/d0a/io_8c.html#a65741bcb3a0dd8a040edaefbd35241e8">07102</a> <a class="code" href="../../df/d0a/io_8c.html#a65741bcb3a0dd8a040edaefbd35241e8">argf_lineno</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l07103"></a>07103 {
<a name="l07104"></a>07104     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno);
<a name="l07105"></a>07105 }
<a name="l07106"></a>07106 
<a name="l07107"></a>07107 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07108"></a><a class="code" href="../../df/d0a/io_8c.html#a5f27de9c8fe3526f56c9c1760e40c335">07108</a> <a class="code" href="../../df/d0a/io_8c.html#a5f27de9c8fe3526f56c9c1760e40c335">argf_forward</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l07109"></a>07109 {
<a name="l07110"></a>07110     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae3d965c850380a1945152e5d1afa6d3c" title="Calls a method.">rb_funcall3</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file, <a class="code" href="../../d3/d57/eval_8c.html#a2adee42611e910ced8da650e59a961a3">rb_frame_this_func</a>(), argc, argv);
<a name="l07111"></a>07111 }
<a name="l07112"></a>07112 
<a name="l07113"></a><a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">07113</a> <span class="preprocessor">#define next_argv() argf_next_argv(argf)</span>
<a name="l07114"></a><a class="code" href="../../df/d0a/io_8c.html#a504096877bc856601d8eb0853652ecdf">07114</a> <span class="preprocessor"></span><span class="preprocessor">#define ARGF_GENERIC_INPUT_P() \</span>
<a name="l07115"></a>07115 <span class="preprocessor">    (ARGF.current_file == rb_stdin &amp;&amp; TYPE(ARGF.current_file) != T_FILE)</span>
<a name="l07116"></a><a class="code" href="../../df/d0a/io_8c.html#a8da8fc8e549d0a75d008086c60557177">07116</a> <span class="preprocessor"></span><span class="preprocessor">#define ARGF_FORWARD(argc, argv) do {\</span>
<a name="l07117"></a>07117 <span class="preprocessor">    if (ARGF_GENERIC_INPUT_P())\</span>
<a name="l07118"></a>07118 <span class="preprocessor">        return argf_forward((argc), (argv), argf);\</span>
<a name="l07119"></a>07119 <span class="preprocessor">} while (0)</span>
<a name="l07120"></a><a class="code" href="../../df/d0a/io_8c.html#a2766fd7f47d70bd3aabba7a3c12389e6">07120</a> <span class="preprocessor"></span><span class="preprocessor">#define NEXT_ARGF_FORWARD(argc, argv) do {\</span>
<a name="l07121"></a>07121 <span class="preprocessor">    if (!next_argv()) return Qnil;\</span>
<a name="l07122"></a>07122 <span class="preprocessor">    ARGF_FORWARD((argc), (argv));\</span>
<a name="l07123"></a>07123 <span class="preprocessor">} while (0)</span>
<a name="l07124"></a>07124 <span class="preprocessor"></span>
<a name="l07125"></a>07125 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l07126"></a><a class="code" href="../../df/d0a/io_8c.html#a6652b476f06e1f58748a525682013b3b">07126</a> <a class="code" href="../../df/d0a/io_8c.html#a6652b476f06e1f58748a525682013b3b">argf_close</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> file)
<a name="l07127"></a>07127 {
<a name="l07128"></a>07128     <span class="keywordflow">if</span> (file == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afafc64c52c6ab49dbc5699da872cad03">rb_stdin</a>) <span class="keywordflow">return</span>;
<a name="l07129"></a>07129     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac4f895997656c2abd27a29a8b8e982ca">RB_TYPE_P</a>(file, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a>)) {
<a name="l07130"></a>07130         <a class="code" href="../../dc/dac/io_8h.html#ae2ca9d075a7f1188906d9e23ed053bf5">rb_io_set_write_io</a>(file, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l07131"></a>07131     }
<a name="l07132"></a>07132     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae3d965c850380a1945152e5d1afa6d3c" title="Calls a method.">rb_funcall3</a>(file, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;close&quot;</span>), 0, 0);
<a name="l07133"></a>07133 }
<a name="l07134"></a>07134 
<a name="l07135"></a>07135 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l07136"></a><a class="code" href="../../df/d0a/io_8c.html#a6d61032f126f3e7986b428e55a13124e">07136</a> <a class="code" href="../../df/d0a/io_8c.html#a6d61032f126f3e7986b428e55a13124e">argf_next_argv</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l07137"></a>07137 {
<a name="l07138"></a>07138     <span class="keywordtype">char</span> *fn;
<a name="l07139"></a>07139     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l07140"></a>07140     <span class="keywordtype">int</span> stdout_binmode = 0;
<a name="l07141"></a>07141     <span class="keywordtype">int</span> <a class="code" href="../../df/d0a/io_8c.html#a8d9cc2340b814767e83294570cafa7fd">fmode</a>;
<a name="l07142"></a>07142 
<a name="l07143"></a>07143     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a>) {
<a name="l07144"></a>07144         <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>, fptr);
<a name="l07145"></a>07145         <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>)
<a name="l07146"></a>07146             stdout_binmode = 1;
<a name="l07147"></a>07147     }
<a name="l07148"></a>07148 
<a name="l07149"></a>07149     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.init_p == 0) {
<a name="l07150"></a>07150         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.argv) &amp;&amp; <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.argv) &gt; 0) {
<a name="l07151"></a>07151             <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 1;
<a name="l07152"></a>07152         }
<a name="l07153"></a>07153         <span class="keywordflow">else</span> {
<a name="l07154"></a>07154             <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = -1;
<a name="l07155"></a>07155         }
<a name="l07156"></a>07156         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.init_p = 1;
<a name="l07157"></a>07157     }
<a name="l07158"></a>07158     <span class="keywordflow">else</span> {
<a name="l07159"></a>07159         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.argv)) {
<a name="l07160"></a>07160             <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = -1;
<a name="l07161"></a>07161         }
<a name="l07162"></a>07162         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p == -1 &amp;&amp; <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.argv) &gt; 0) {
<a name="l07163"></a>07163             <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 1;
<a name="l07164"></a>07164         }
<a name="l07165"></a>07165     }
<a name="l07166"></a>07166 
<a name="l07167"></a>07167     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p == 1) {
<a name="l07168"></a>07168       retry:
<a name="l07169"></a>07169         <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.argv) &gt; 0) {
<a name="l07170"></a>07170             <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.filename = <a class="code" href="../../dc/dcc/array_8c.html#a2c4138c37c30471d4724bd8eee255a9d">rb_ary_shift</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.argv);
<a name="l07171"></a>07171             fn = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.filename);
<a name="l07172"></a>07172             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(fn) == 1 &amp;&amp; fn[0] == <span class="charliteral">&apos;-&apos;</span>) {
<a name="l07173"></a>07173                 <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afafc64c52c6ab49dbc5699da872cad03">rb_stdin</a>;
<a name="l07174"></a>07174                 <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace) {
<a name="l07175"></a>07175                     <a class="code" href="../../db/dcc/error_8c.html#aa5b1972d475e9a090c8ef607ce033008">rb_warn</a>(<span class="stringliteral">&quot;Can&apos;t do inplace edit for stdio; skipping&quot;</span>);
<a name="l07176"></a>07176                     <span class="keywordflow">goto</span> retry;
<a name="l07177"></a>07177                 }
<a name="l07178"></a>07178             }
<a name="l07179"></a>07179             <span class="keywordflow">else</span> {
<a name="l07180"></a>07180                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write_io = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l07181"></a>07181                 <span class="keywordtype">int</span> fr = <a class="code" href="../../df/d0a/io_8c.html#a42654a6f8234decb8c183204f42e1b8a">rb_sysopen</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.filename, O_RDONLY, 0);
<a name="l07182"></a>07182 
<a name="l07183"></a>07183                 <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace) {
<a name="l07184"></a>07184                     <span class="keyword">struct </span><a class="code" href="../../dc/db1/win32_8h.html#a4feaac5e1913330bded57b059061965b">stat</a> st;
<a name="l07185"></a>07185 <span class="preprocessor">#ifndef NO_SAFE_RENAME</span>
<a name="l07186"></a>07186 <span class="preprocessor"></span>                    <span class="keyword">struct </span><a class="code" href="../../dc/db1/win32_8h.html#a4feaac5e1913330bded57b059061965b">stat</a> st2;
<a name="l07187"></a>07187 <span class="preprocessor">#endif</span>
<a name="l07188"></a>07188 <span class="preprocessor"></span>                    <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str;
<a name="l07189"></a>07189                     <span class="keywordtype">int</span> fw;
<a name="l07190"></a>07190 
<a name="l07191"></a>07191                     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a> &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a> != <a class="code" href="../../df/d0a/io_8c.html#a51b183f14dd2be4d72bc7f5a9c5af041">orig_stdout</a>) {
<a name="l07192"></a>07192                         <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>);
<a name="l07193"></a>07193                     }
<a name="l07194"></a>07194                     <a class="code" href="../../dc/db1/win32_8h.html#a8a2cf46df7f7017617df85cdb0afdc64">fstat</a>(fr, &amp;st);
<a name="l07195"></a>07195                     <span class="keywordflow">if</span> (*<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace) {
<a name="l07196"></a>07196                         str = <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(fn);
<a name="l07197"></a>07197                         <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(str, <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace);
<a name="l07198"></a>07198 <span class="preprocessor">#ifdef NO_SAFE_RENAME</span>
<a name="l07199"></a>07199 <span class="preprocessor"></span>                        (void)close(fr);
<a name="l07200"></a>07200                         (void)unlink(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str));
<a name="l07201"></a>07201                         <span class="keywordflow">if</span> (rename(fn, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str)) &lt; 0) {
<a name="l07202"></a>07202                             <a class="code" href="../../db/dcc/error_8c.html#aa5b1972d475e9a090c8ef607ce033008">rb_warn</a>(<span class="stringliteral">&quot;Can&apos;t rename %s to %s: %s, skipping file&quot;</span>,
<a name="l07203"></a>07203                                     fn, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), <a class="code" href="../../d3/d90/missing_8h.html#afd46339e0e35acab03772ba959071313">strerror</a>(<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l07204"></a>07204                             <span class="keywordflow">goto</span> retry;
<a name="l07205"></a>07205                         }
<a name="l07206"></a>07206                         fr = <a class="code" href="../../df/d0a/io_8c.html#a42654a6f8234decb8c183204f42e1b8a">rb_sysopen</a>(str, O_RDONLY, 0);
<a name="l07207"></a>07207 <span class="preprocessor">#else</span>
<a name="l07208"></a>07208 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (rename(fn, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str)) &lt; 0) {
<a name="l07209"></a>07209                             <a class="code" href="../../db/dcc/error_8c.html#aa5b1972d475e9a090c8ef607ce033008">rb_warn</a>(<span class="stringliteral">&quot;Can&apos;t rename %s to %s: %s, skipping file&quot;</span>,
<a name="l07210"></a>07210                                     fn, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), <a class="code" href="../../d3/d90/missing_8h.html#afd46339e0e35acab03772ba959071313">strerror</a>(<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l07211"></a>07211                             close(fr);
<a name="l07212"></a>07212                             <span class="keywordflow">goto</span> retry;
<a name="l07213"></a>07213                         }
<a name="l07214"></a>07214 <span class="preprocessor">#endif</span>
<a name="l07215"></a>07215 <span class="preprocessor"></span>                    }
<a name="l07216"></a>07216                     <span class="keywordflow">else</span> {
<a name="l07217"></a>07217 <span class="preprocessor">#ifdef NO_SAFE_RENAME</span>
<a name="l07218"></a>07218 <span class="preprocessor"></span>                        <a class="code" href="../../db/dcc/error_8c.html#a643ceabe39fa1f8c99066a321397a115">rb_fatal</a>(<span class="stringliteral">&quot;Can&apos;t do inplace edit without backup&quot;</span>);
<a name="l07219"></a>07219 <span class="preprocessor">#else</span>
<a name="l07220"></a>07220 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (unlink(fn) &lt; 0) {
<a name="l07221"></a>07221                             <a class="code" href="../../db/dcc/error_8c.html#aa5b1972d475e9a090c8ef607ce033008">rb_warn</a>(<span class="stringliteral">&quot;Can&apos;t remove %s: %s, skipping file&quot;</span>,
<a name="l07222"></a>07222                                     fn, <a class="code" href="../../d3/d90/missing_8h.html#afd46339e0e35acab03772ba959071313">strerror</a>(<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l07223"></a>07223                             close(fr);
<a name="l07224"></a>07224                             <span class="keywordflow">goto</span> retry;
<a name="l07225"></a>07225                         }
<a name="l07226"></a>07226 <span class="preprocessor">#endif</span>
<a name="l07227"></a>07227 <span class="preprocessor"></span>                    }
<a name="l07228"></a>07228                     fw = <a class="code" href="../../df/d0a/io_8c.html#a42654a6f8234decb8c183204f42e1b8a">rb_sysopen</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.filename, O_WRONLY|O_CREAT|O_TRUNC, 0666);
<a name="l07229"></a>07229 <span class="preprocessor">#ifndef NO_SAFE_RENAME</span>
<a name="l07230"></a>07230 <span class="preprocessor"></span>                    <a class="code" href="../../dc/db1/win32_8h.html#a8a2cf46df7f7017617df85cdb0afdc64">fstat</a>(fw, &amp;st2);
<a name="l07231"></a>07231 <span class="preprocessor">#ifdef HAVE_FCHMOD</span>
<a name="l07232"></a>07232 <span class="preprocessor"></span>                    fchmod(fw, st.st_mode);
<a name="l07233"></a>07233 <span class="preprocessor">#else</span>
<a name="l07234"></a>07234 <span class="preprocessor"></span>                    chmod(fn, st.st_mode);
<a name="l07235"></a>07235 <span class="preprocessor">#endif</span>
<a name="l07236"></a>07236 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (st.st_uid!=st2.st_uid || st.st_gid!=st2.st_gid) {
<a name="l07237"></a>07237                         <span class="keywordtype">int</span> <a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a>;
<a name="l07238"></a>07238 <span class="preprocessor">#ifdef HAVE_FCHOWN</span>
<a name="l07239"></a>07239 <span class="preprocessor"></span>                        err = fchown(fw, st.st_uid, st.st_gid);
<a name="l07240"></a>07240 <span class="preprocessor">#else</span>
<a name="l07241"></a>07241 <span class="preprocessor"></span>                        err = <a class="code" href="../../dc/db1/win32_8h.html#ac7c7a6988eecb59569de9f51115a1df3">chown</a>(fn, st.st_uid, st.st_gid);
<a name="l07242"></a>07242 <span class="preprocessor">#endif</span>
<a name="l07243"></a>07243 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (err &amp;&amp; <a class="code" href="../../dc/db1/win32_8h.html#a2a3c17f15a0d34a8bba3277bfef2f56b">getuid</a>() == 0 &amp;&amp; st2.st_uid == 0) {
<a name="l07244"></a>07244                             <span class="keyword">const</span> <span class="keywordtype">char</span> *wkfn = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.filename);
<a name="l07245"></a>07245                             <a class="code" href="../../db/dcc/error_8c.html#aa5b1972d475e9a090c8ef607ce033008">rb_warn</a>(<span class="stringliteral">&quot;Can&apos;t set owner/group of %s to same as %s: %s, skipping file&quot;</span>,
<a name="l07246"></a>07246                                     wkfn, fn, <a class="code" href="../../d3/d90/missing_8h.html#afd46339e0e35acab03772ba959071313">strerror</a>(<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l07247"></a>07247                             (void)close(fr);
<a name="l07248"></a>07248                             (void)close(fw);
<a name="l07249"></a>07249                             (void)unlink(wkfn);
<a name="l07250"></a>07250                             <span class="keywordflow">goto</span> retry;
<a name="l07251"></a>07251                         }
<a name="l07252"></a>07252                     }
<a name="l07253"></a>07253 <span class="preprocessor">#endif</span>
<a name="l07254"></a>07254 <span class="preprocessor"></span>                    write_io = <a class="code" href="../../df/d0a/io_8c.html#abb0bf6f7784d957186beeb62d0d9c211">prep_io</a>(fw, <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>, <a class="code" href="../../d6/d13/file_8c.html#ae9f03997c2e7a3461524e83053a24ac2">rb_cFile</a>, fn);
<a name="l07255"></a>07255                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a> = write_io;
<a name="l07256"></a>07256                     <span class="keywordflow">if</span> (stdout_binmode) <a class="code" href="../../db/d2e/intern_8h.html#adb93518ea7f5fdcf897359c214c03254">rb_io_binmode</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>);
<a name="l07257"></a>07257                 }
<a name="l07258"></a>07258                 fmode = <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>;
<a name="l07259"></a>07259                 <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.binmode) {
<a name="l07260"></a>07260                     fmode |= <a class="code" href="../../df/d0a/io_8c.html#ab2c655110073a066c789b7e92cf7377c">DEFAULT_TEXTMODE</a>;
<a name="l07261"></a>07261                 }
<a name="l07262"></a>07262                 <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file = <a class="code" href="../../df/d0a/io_8c.html#abb0bf6f7784d957186beeb62d0d9c211">prep_io</a>(fr, fmode, <a class="code" href="../../d6/d13/file_8c.html#ae9f03997c2e7a3461524e83053a24ac2">rb_cFile</a>, fn);
<a name="l07263"></a>07263                 <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(write_io)) {
<a name="l07264"></a>07264                     <a class="code" href="../../dc/dac/io_8h.html#ae2ca9d075a7f1188906d9e23ed053bf5">rb_io_set_write_io</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file, write_io);
<a name="l07265"></a>07265                 }
<a name="l07266"></a>07266             }
<a name="l07267"></a>07267             <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.binmode) <a class="code" href="../../db/d2e/intern_8h.html#a5e93bb5b5a12f3c6638b443f4e6746b3">rb_io_ascii8bit_binmode</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l07268"></a>07268             <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file, fptr);
<a name="l07269"></a>07269             <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.encs.enc) {
<a name="l07270"></a>07270                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a> = <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.encs;
<a name="l07271"></a>07271                 <a class="code" href="../../df/d0a/io_8c.html#a6a7e6fc03722338bbc29fc27ee59ea39">clear_codeconv</a>(fptr);
<a name="l07272"></a>07272             }
<a name="l07273"></a>07273             <span class="keywordflow">else</span> {
<a name="l07274"></a>07274                 fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags &amp;= ~<a class="code" href="../../d5/de3/encoding_8h.html#aea188e77ea841e2c7741a9ef8c4c33a5">ECONV_NEWLINE_DECORATOR_MASK</a>;
<a name="l07275"></a>07275                 <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.binmode) {
<a name="l07276"></a>07276                     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags |= <a class="code" href="../../d5/de3/encoding_8h.html#afae8969f13c765a2a96d810d7049543a">ECONV_DEFAULT_NEWLINE_DECORATOR</a>;
<a name="l07277"></a>07277 <span class="preprocessor">#ifdef TEXTMODE_NEWLINE_DECORATOR_ON_WRITE</span>
<a name="l07278"></a>07278 <span class="preprocessor"></span>                    fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags |= TEXTMODE_NEWLINE_DECORATOR_ON_WRITE;
<a name="l07279"></a>07279 <span class="preprocessor">#endif</span>
<a name="l07280"></a>07280 <span class="preprocessor"></span>                }
<a name="l07281"></a>07281             }
<a name="l07282"></a>07282             <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 0;
<a name="l07283"></a>07283         }
<a name="l07284"></a>07284         <span class="keywordflow">else</span> {
<a name="l07285"></a>07285             <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 1;
<a name="l07286"></a>07286             <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l07287"></a>07287         }
<a name="l07288"></a>07288     }
<a name="l07289"></a>07289     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p == -1) {
<a name="l07290"></a>07290         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afafc64c52c6ab49dbc5699da872cad03">rb_stdin</a>;
<a name="l07291"></a>07291         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.filename = <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;-&quot;</span>);
<a name="l07292"></a>07292         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace) {
<a name="l07293"></a>07293             <a class="code" href="../../db/dcc/error_8c.html#aa5b1972d475e9a090c8ef607ce033008">rb_warn</a>(<span class="stringliteral">&quot;Can&apos;t do inplace edit for stdio&quot;</span>);
<a name="l07294"></a>07294             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a> = <a class="code" href="../../df/d0a/io_8c.html#a51b183f14dd2be4d72bc7f5a9c5af041">orig_stdout</a>;
<a name="l07295"></a>07295         }
<a name="l07296"></a>07296     }
<a name="l07297"></a>07297     <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l07298"></a>07298 }
<a name="l07299"></a>07299 
<a name="l07300"></a>07300 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07301"></a><a class="code" href="../../df/d0a/io_8c.html#a6dfd0b321999c60fecf6d91b94444373">07301</a> <a class="code" href="../../df/d0a/io_8c.html#a6dfd0b321999c60fecf6d91b94444373">argf_getline</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l07302"></a>07302 {
<a name="l07303"></a>07303     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> line;
<a name="l07304"></a>07304     <span class="keywordtype">long</span> lineno = <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno;
<a name="l07305"></a>07305 
<a name="l07306"></a>07306   retry:
<a name="l07307"></a>07307     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l07308"></a>07308     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a504096877bc856601d8eb0853652ecdf">ARGF_GENERIC_INPUT_P</a>()) {
<a name="l07309"></a>07309         line = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae3d965c850380a1945152e5d1afa6d3c" title="Calls a method.">rb_funcall3</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;gets&quot;</span>), argc, argv);
<a name="l07310"></a>07310     }
<a name="l07311"></a>07311     <span class="keywordflow">else</span> {
<a name="l07312"></a>07312         <span class="keywordflow">if</span> (argc == 0 &amp;&amp; <a class="code" href="../../db/d2e/intern_8h.html#a6d19bb99247117d9d8b880ab14ad8d25">rb_rs</a> == <a class="code" href="../../db/d2e/intern_8h.html#ab707a74e9c34626c05d20431ad137570">rb_default_rs</a>) {
<a name="l07313"></a>07313             line = <a class="code" href="../../db/d2e/intern_8h.html#a4f0d1bd3c88e8f31ee0b41afce9e94fb">rb_io_gets</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l07314"></a>07314         }
<a name="l07315"></a>07315         <span class="keywordflow">else</span> {
<a name="l07316"></a>07316             line = <a class="code" href="../../df/d0a/io_8c.html#aa2d3a2ac2bfedf356cd73efe1c16e837">rb_io_getline</a>(argc, argv, <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l07317"></a>07317         }
<a name="l07318"></a>07318         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(line) &amp;&amp; <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p != -1) {
<a name="l07319"></a>07319             <a class="code" href="../../df/d0a/io_8c.html#a6652b476f06e1f58748a525682013b3b">argf_close</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l07320"></a>07320             <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 1;
<a name="l07321"></a>07321             <span class="keywordflow">goto</span> retry;
<a name="l07322"></a>07322         }
<a name="l07323"></a>07323     }
<a name="l07324"></a>07324     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(line)) {
<a name="l07325"></a>07325         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno = ++lineno;
<a name="l07326"></a>07326         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.last_lineno = <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno;
<a name="l07327"></a>07327     }
<a name="l07328"></a>07328     <span class="keywordflow">return</span> line;
<a name="l07329"></a>07329 }
<a name="l07330"></a>07330 
<a name="l07331"></a>07331 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07332"></a><a class="code" href="../../df/d0a/io_8c.html#a323e913f6a1dd87adfde6dc077363506">07332</a> <a class="code" href="../../df/d0a/io_8c.html#a323e913f6a1dd87adfde6dc077363506">argf_lineno_getter</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <span class="keywordtype">id</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *var)
<a name="l07333"></a>07333 {
<a name="l07334"></a>07334     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a> = *var;
<a name="l07335"></a>07335     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.last_lineno);
<a name="l07336"></a>07336 }
<a name="l07337"></a>07337 
<a name="l07338"></a>07338 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l07339"></a><a class="code" href="../../df/d0a/io_8c.html#a8b8d45ef77e057303596b931880df316">07339</a> <a class="code" href="../../df/d0a/io_8c.html#a8b8d45ef77e057303596b931880df316">argf_lineno_setter</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <span class="keywordtype">id</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *var)
<a name="l07340"></a>07340 {
<a name="l07341"></a>07341     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a> = *var;
<a name="l07342"></a>07342     <span class="keywordtype">int</span> n = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(val);
<a name="l07343"></a>07343     <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.last_lineno = <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno = n;
<a name="l07344"></a>07344 }
<a name="l07345"></a>07345 
<a name="l07346"></a>07346 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../df/d0a/io_8c.html#ae6b1972ddde3d80cd6a5ae6a87b6c80c">argf_gets</a>(<span class="keywordtype">int</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>);
<a name="l07347"></a>07347 
<a name="l07348"></a>07348 <span class="comment">/*</span>
<a name="l07349"></a>07349 <span class="comment"> *  call-seq:</span>
<a name="l07350"></a>07350 <span class="comment"> *     gets(sep=$/)    -&gt; string or nil</span>
<a name="l07351"></a>07351 <span class="comment"> *     gets(limit)     -&gt; string or nil</span>
<a name="l07352"></a>07352 <span class="comment"> *     gets(sep,limit) -&gt; string or nil</span>
<a name="l07353"></a>07353 <span class="comment"> *</span>
<a name="l07354"></a>07354 <span class="comment"> *  Returns (and assigns to &lt;code&gt;$_&lt;/code&gt;) the next line from the list</span>
<a name="l07355"></a>07355 <span class="comment"> *  of files in +ARGV+ (or &lt;code&gt;$*&lt;/code&gt;), or from standard input if</span>
<a name="l07356"></a>07356 <span class="comment"> *  no files are present on the command line. Returns +nil+ at end of</span>
<a name="l07357"></a>07357 <span class="comment"> *  file. The optional argument specifies the record separator. The</span>
<a name="l07358"></a>07358 <span class="comment"> *  separator is included with the contents of each record. A separator</span>
<a name="l07359"></a>07359 <span class="comment"> *  of +nil+ reads the entire contents, and a zero-length separator</span>
<a name="l07360"></a>07360 <span class="comment"> *  reads the input one paragraph at a time, where paragraphs are</span>
<a name="l07361"></a>07361 <span class="comment"> *  divided by two consecutive newlines.  If the first argument is an</span>
<a name="l07362"></a>07362 <span class="comment"> *  integer, or optional second argument is given, the returning string</span>
<a name="l07363"></a>07363 <span class="comment"> *  would not be longer than the given value in bytes.  If multiple</span>
<a name="l07364"></a>07364 <span class="comment"> *  filenames are present in +ARGV+, +gets(nil)+ will read the contents</span>
<a name="l07365"></a>07365 <span class="comment"> *  one file at a time.</span>
<a name="l07366"></a>07366 <span class="comment"> *</span>
<a name="l07367"></a>07367 <span class="comment"> *     ARGV &lt;&lt; &quot;testfile&quot;</span>
<a name="l07368"></a>07368 <span class="comment"> *     print while gets</span>
<a name="l07369"></a>07369 <span class="comment"> *</span>
<a name="l07370"></a>07370 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l07371"></a>07371 <span class="comment"> *</span>
<a name="l07372"></a>07372 <span class="comment"> *     This is line one</span>
<a name="l07373"></a>07373 <span class="comment"> *     This is line two</span>
<a name="l07374"></a>07374 <span class="comment"> *     This is line three</span>
<a name="l07375"></a>07375 <span class="comment"> *     And so on...</span>
<a name="l07376"></a>07376 <span class="comment"> *</span>
<a name="l07377"></a>07377 <span class="comment"> *  The style of programming using &lt;code&gt;$_&lt;/code&gt; as an implicit</span>
<a name="l07378"></a>07378 <span class="comment"> *  parameter is gradually losing favor in the Ruby community.</span>
<a name="l07379"></a>07379 <span class="comment"> */</span>
<a name="l07380"></a>07380 
<a name="l07381"></a>07381 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07382"></a><a class="code" href="../../df/d0a/io_8c.html#a0a87a6ff48e0b00304eecf15adb747c9">07382</a> <a class="code" href="../../df/d0a/io_8c.html#a0a87a6ff48e0b00304eecf15adb747c9">rb_f_gets</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> recv)
<a name="l07383"></a>07383 {
<a name="l07384"></a>07384     <span class="keywordflow">if</span> (recv == <a class="code" href="../../de/d05/structargf.html">argf</a>) {
<a name="l07385"></a>07385         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#ae6b1972ddde3d80cd6a5ae6a87b6c80c">argf_gets</a>(argc, argv, <a class="code" href="../../de/d05/structargf.html">argf</a>);
<a name="l07386"></a>07386     }
<a name="l07387"></a>07387     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#adafa8fd17636821445380e7e1881355e" title="Calls a method.">rb_funcall2</a>(<a class="code" href="../../de/d05/structargf.html">argf</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;gets&quot;</span>), argc, argv);
<a name="l07388"></a>07388 }
<a name="l07389"></a>07389 
<a name="l07390"></a>07390 <span class="comment">/*</span>
<a name="l07391"></a>07391 <span class="comment"> *  call-seq:</span>
<a name="l07392"></a>07392 <span class="comment"> *     ARGF.gets(sep=$/)     -&gt; string</span>
<a name="l07393"></a>07393 <span class="comment"> *     ARGF.gets(limit)      -&gt; string</span>
<a name="l07394"></a>07394 <span class="comment"> *     ARGF.gets(sep, limit) -&gt; string</span>
<a name="l07395"></a>07395 <span class="comment"> *</span>
<a name="l07396"></a>07396 <span class="comment"> *  Returns the next line from the current file in +ARGF+.</span>
<a name="l07397"></a>07397 <span class="comment"> *</span>
<a name="l07398"></a>07398 <span class="comment"> *  By default lines are assumed to be separated by +$/+; to use a different</span>
<a name="l07399"></a>07399 <span class="comment"> *  character as a separator, supply it as a +String+ for the _sep_ argument.</span>
<a name="l07400"></a>07400 <span class="comment"> *</span>
<a name="l07401"></a>07401 <span class="comment"> *  The optional  _limit_ argument specifies how many characters of each line</span>
<a name="l07402"></a>07402 <span class="comment"> *  to return. By default all characters are returned.</span>
<a name="l07403"></a>07403 <span class="comment"> *</span>
<a name="l07404"></a>07404 <span class="comment"> */</span>
<a name="l07405"></a>07405 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07406"></a><a class="code" href="../../df/d0a/io_8c.html#ae6b1972ddde3d80cd6a5ae6a87b6c80c">07406</a> <a class="code" href="../../df/d0a/io_8c.html#ae6b1972ddde3d80cd6a5ae6a87b6c80c">argf_gets</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l07407"></a>07407 {
<a name="l07408"></a>07408     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> line;
<a name="l07409"></a>07409 
<a name="l07410"></a>07410     line = <a class="code" href="../../df/d0a/io_8c.html#a6dfd0b321999c60fecf6d91b94444373">argf_getline</a>(argc, argv, argf);
<a name="l07411"></a>07411     <a class="code" href="../../db/d2e/intern_8h.html#ada36b7e0e23335fa38937f0b5328601d">rb_lastline_set</a>(line);
<a name="l07412"></a>07412 
<a name="l07413"></a>07413     <span class="keywordflow">return</span> line;
<a name="l07414"></a>07414 }
<a name="l07415"></a>07415 
<a name="l07416"></a>07416 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07417"></a><a class="code" href="../../df/d0a/io_8c.html#ac2c12d1abbff798fea29d04298536b19">07417</a> <a class="code" href="../../db/d2e/intern_8h.html#ac2c12d1abbff798fea29d04298536b19">rb_gets</a>(<span class="keywordtype">void</span>)
<a name="l07418"></a>07418 {
<a name="l07419"></a>07419     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> line;
<a name="l07420"></a>07420 
<a name="l07421"></a>07421     <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#a6d19bb99247117d9d8b880ab14ad8d25">rb_rs</a> != <a class="code" href="../../db/d2e/intern_8h.html#ab707a74e9c34626c05d20431ad137570">rb_default_rs</a>) {
<a name="l07422"></a>07422         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a0a87a6ff48e0b00304eecf15adb747c9">rb_f_gets</a>(0, 0, <a class="code" href="../../de/d05/structargf.html">argf</a>);
<a name="l07423"></a>07423     }
<a name="l07424"></a>07424 
<a name="l07425"></a>07425   retry:
<a name="l07426"></a>07426     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l07427"></a>07427     line = <a class="code" href="../../db/d2e/intern_8h.html#a4f0d1bd3c88e8f31ee0b41afce9e94fb">rb_io_gets</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l07428"></a>07428     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(line) &amp;&amp; <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p != -1) {
<a name="l07429"></a>07429         <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l07430"></a>07430         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 1;
<a name="l07431"></a>07431         <span class="keywordflow">goto</span> retry;
<a name="l07432"></a>07432     }
<a name="l07433"></a>07433     <a class="code" href="../../db/d2e/intern_8h.html#ada36b7e0e23335fa38937f0b5328601d">rb_lastline_set</a>(line);
<a name="l07434"></a>07434     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(line)) {
<a name="l07435"></a>07435         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno++;
<a name="l07436"></a>07436         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.last_lineno = <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno;
<a name="l07437"></a>07437     }
<a name="l07438"></a>07438 
<a name="l07439"></a>07439     <span class="keywordflow">return</span> line;
<a name="l07440"></a>07440 }
<a name="l07441"></a>07441 
<a name="l07442"></a>07442 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../df/d0a/io_8c.html#a94c20d353b18697d6414542f59358f26">argf_readline</a>(<span class="keywordtype">int</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>);
<a name="l07443"></a>07443 
<a name="l07444"></a>07444 <span class="comment">/*</span>
<a name="l07445"></a>07445 <span class="comment"> *  call-seq:</span>
<a name="l07446"></a>07446 <span class="comment"> *     readline(sep=$/)     -&gt; string</span>
<a name="l07447"></a>07447 <span class="comment"> *     readline(limit)      -&gt; string</span>
<a name="l07448"></a>07448 <span class="comment"> *     readline(sep, limit) -&gt; string</span>
<a name="l07449"></a>07449 <span class="comment"> *</span>
<a name="l07450"></a>07450 <span class="comment"> *  Equivalent to &lt;code&gt;Kernel::gets&lt;/code&gt;, except</span>
<a name="l07451"></a>07451 <span class="comment"> *  +readline+ raises +EOFError+ at end of file.</span>
<a name="l07452"></a>07452 <span class="comment"> */</span>
<a name="l07453"></a>07453 
<a name="l07454"></a>07454 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07455"></a><a class="code" href="../../df/d0a/io_8c.html#a931715784831b280632e9c9613c7a5d5">07455</a> <a class="code" href="../../df/d0a/io_8c.html#a931715784831b280632e9c9613c7a5d5">rb_f_readline</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> recv)
<a name="l07456"></a>07456 {
<a name="l07457"></a>07457     <span class="keywordflow">if</span> (recv == <a class="code" href="../../de/d05/structargf.html">argf</a>) {
<a name="l07458"></a>07458         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a94c20d353b18697d6414542f59358f26">argf_readline</a>(argc, argv, <a class="code" href="../../de/d05/structargf.html">argf</a>);
<a name="l07459"></a>07459     }
<a name="l07460"></a>07460     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#adafa8fd17636821445380e7e1881355e" title="Calls a method.">rb_funcall2</a>(<a class="code" href="../../de/d05/structargf.html">argf</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;readline&quot;</span>), argc, argv);
<a name="l07461"></a>07461 }
<a name="l07462"></a>07462 
<a name="l07463"></a>07463 
<a name="l07464"></a>07464 <span class="comment">/*</span>
<a name="l07465"></a>07465 <span class="comment"> *  call-seq:</span>
<a name="l07466"></a>07466 <span class="comment"> *     ARGF.readline(sep=$/)     -&gt; string</span>
<a name="l07467"></a>07467 <span class="comment"> *     ARGF.readline(limit)      -&gt; string</span>
<a name="l07468"></a>07468 <span class="comment"> *     ARGF.readline(sep, limit) -&gt; string</span>
<a name="l07469"></a>07469 <span class="comment"> *</span>
<a name="l07470"></a>07470 <span class="comment"> *  Returns the next line from the current file in +ARGF+.</span>
<a name="l07471"></a>07471 <span class="comment"> *</span>
<a name="l07472"></a>07472 <span class="comment"> *  By default lines are assumed to be separated by +$/+; to use a different</span>
<a name="l07473"></a>07473 <span class="comment"> *  character as a separator, supply it as a +String+ for the _sep_ argument.</span>
<a name="l07474"></a>07474 <span class="comment"> *</span>
<a name="l07475"></a>07475 <span class="comment"> *  The optional  _limit_ argument specifies how many characters of each line</span>
<a name="l07476"></a>07476 <span class="comment"> *  to return. By default all characters are returned.</span>
<a name="l07477"></a>07477 <span class="comment"> *</span>
<a name="l07478"></a>07478 <span class="comment"> *  An +EOFError+ is raised at the end of the file.</span>
<a name="l07479"></a>07479 <span class="comment"> */</span>
<a name="l07480"></a>07480 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07481"></a><a class="code" href="../../df/d0a/io_8c.html#a94c20d353b18697d6414542f59358f26">07481</a> <a class="code" href="../../df/d0a/io_8c.html#a94c20d353b18697d6414542f59358f26">argf_readline</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l07482"></a>07482 {
<a name="l07483"></a>07483     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> line;
<a name="l07484"></a>07484 
<a name="l07485"></a>07485     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>();
<a name="l07486"></a>07486     <a class="code" href="../../df/d0a/io_8c.html#a8da8fc8e549d0a75d008086c60557177">ARGF_FORWARD</a>(argc, argv);
<a name="l07487"></a>07487     line = <a class="code" href="../../df/d0a/io_8c.html#ae6b1972ddde3d80cd6a5ae6a87b6c80c">argf_gets</a>(argc, argv, argf);
<a name="l07488"></a>07488     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(line)) {
<a name="l07489"></a>07489         <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>();
<a name="l07490"></a>07490     }
<a name="l07491"></a>07491 
<a name="l07492"></a>07492     <span class="keywordflow">return</span> line;
<a name="l07493"></a>07493 }
<a name="l07494"></a>07494 
<a name="l07495"></a>07495 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../df/d0a/io_8c.html#a76033f4a6e4e9e695d5cc1ac5baf6514">argf_readlines</a>(<span class="keywordtype">int</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>);
<a name="l07496"></a>07496 
<a name="l07497"></a>07497 <span class="comment">/*</span>
<a name="l07498"></a>07498 <span class="comment"> *  call-seq:</span>
<a name="l07499"></a>07499 <span class="comment"> *     readlines(sep=$/)    -&gt; array</span>
<a name="l07500"></a>07500 <span class="comment"> *     readlines(limit)     -&gt; array</span>
<a name="l07501"></a>07501 <span class="comment"> *     readlines(sep,limit) -&gt; array</span>
<a name="l07502"></a>07502 <span class="comment"> *</span>
<a name="l07503"></a>07503 <span class="comment"> *  Returns an array containing the lines returned by calling</span>
<a name="l07504"></a>07504 <span class="comment"> *  &lt;code&gt;Kernel.gets(&lt;i&gt;sep&lt;/i&gt;)&lt;/code&gt; until the end of file.</span>
<a name="l07505"></a>07505 <span class="comment"> */</span>
<a name="l07506"></a>07506 
<a name="l07507"></a>07507 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07508"></a><a class="code" href="../../df/d0a/io_8c.html#aa6bbcca736f9963747f5f8a329637fc8">07508</a> <a class="code" href="../../df/d0a/io_8c.html#aa6bbcca736f9963747f5f8a329637fc8">rb_f_readlines</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> recv)
<a name="l07509"></a>07509 {
<a name="l07510"></a>07510     <span class="keywordflow">if</span> (recv == <a class="code" href="../../de/d05/structargf.html">argf</a>) {
<a name="l07511"></a>07511         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a76033f4a6e4e9e695d5cc1ac5baf6514">argf_readlines</a>(argc, argv, <a class="code" href="../../de/d05/structargf.html">argf</a>);
<a name="l07512"></a>07512     }
<a name="l07513"></a>07513     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#adafa8fd17636821445380e7e1881355e" title="Calls a method.">rb_funcall2</a>(<a class="code" href="../../de/d05/structargf.html">argf</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;readlines&quot;</span>), argc, argv);
<a name="l07514"></a>07514 }
<a name="l07515"></a>07515 
<a name="l07516"></a>07516 <span class="comment">/*</span>
<a name="l07517"></a>07517 <span class="comment"> *  call-seq:</span>
<a name="l07518"></a>07518 <span class="comment"> *     ARGF.readlines(sep=$/)     -&gt; array</span>
<a name="l07519"></a>07519 <span class="comment"> *     ARGF.readlines(limit)      -&gt; array</span>
<a name="l07520"></a>07520 <span class="comment"> *     ARGF.readlines(sep, limit) -&gt; array</span>
<a name="l07521"></a>07521 <span class="comment"> *</span>
<a name="l07522"></a>07522 <span class="comment"> *     ARGF.to_a(sep=$/)     -&gt; array</span>
<a name="l07523"></a>07523 <span class="comment"> *     ARGF.to_a(limit)      -&gt; array</span>
<a name="l07524"></a>07524 <span class="comment"> *     ARGF.to_a(sep, limit) -&gt; array</span>
<a name="l07525"></a>07525 <span class="comment"> *</span>
<a name="l07526"></a>07526 <span class="comment"> *  Reads +ARGF+&apos;s current file in its entirety, returning an +Array+ of its</span>
<a name="l07527"></a>07527 <span class="comment"> *  lines, one line per element. Lines are assumed to be separated by _sep_.</span>
<a name="l07528"></a>07528 <span class="comment"> *</span>
<a name="l07529"></a>07529 <span class="comment"> *     lines = ARGF.readlines</span>
<a name="l07530"></a>07530 <span class="comment"> *     lines[0]                #=&gt; &quot;This is line one\n&quot;</span>
<a name="l07531"></a>07531 <span class="comment"> */</span>
<a name="l07532"></a>07532 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07533"></a><a class="code" href="../../df/d0a/io_8c.html#a76033f4a6e4e9e695d5cc1ac5baf6514">07533</a> <a class="code" href="../../df/d0a/io_8c.html#a76033f4a6e4e9e695d5cc1ac5baf6514">argf_readlines</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l07534"></a>07534 {
<a name="l07535"></a>07535     <span class="keywordtype">long</span> lineno = <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno;
<a name="l07536"></a>07536     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> lines, ary;
<a name="l07537"></a>07537 
<a name="l07538"></a>07538     ary = <a class="code" href="../../dc/dcc/array_8c.html#a9518114fd36cb4ef4656ec1dc63348c9">rb_ary_new</a>();
<a name="l07539"></a>07539     <span class="keywordflow">while</span> (<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) {
<a name="l07540"></a>07540         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a504096877bc856601d8eb0853652ecdf">ARGF_GENERIC_INPUT_P</a>()) {
<a name="l07541"></a>07541             lines = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae3d965c850380a1945152e5d1afa6d3c" title="Calls a method.">rb_funcall3</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;readlines&quot;</span>), argc, argv);
<a name="l07542"></a>07542         }
<a name="l07543"></a>07543         <span class="keywordflow">else</span> {
<a name="l07544"></a>07544             lines = <a class="code" href="../../df/d0a/io_8c.html#aedb3b02ed530d801262cea5cac06e1a9">rb_io_readlines</a>(argc, argv, <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l07545"></a>07545             <a class="code" href="../../df/d0a/io_8c.html#a6652b476f06e1f58748a525682013b3b">argf_close</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l07546"></a>07546         }
<a name="l07547"></a>07547         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 1;
<a name="l07548"></a>07548         <a class="code" href="../../dc/dcc/array_8c.html#a9569be4d3661f4ce54bf56b12a2d98a8">rb_ary_concat</a>(ary, lines);
<a name="l07549"></a>07549         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno = lineno + <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(ary);
<a name="l07550"></a>07550         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.last_lineno = <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno;
<a name="l07551"></a>07551     }
<a name="l07552"></a>07552     <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.init_p = 0;
<a name="l07553"></a>07553     <span class="keywordflow">return</span> ary;
<a name="l07554"></a>07554 }
<a name="l07555"></a>07555 
<a name="l07556"></a>07556 <span class="comment">/*</span>
<a name="l07557"></a>07557 <span class="comment"> *  call-seq:</span>
<a name="l07558"></a>07558 <span class="comment"> *     `cmd`    -&gt; string</span>
<a name="l07559"></a>07559 <span class="comment"> *</span>
<a name="l07560"></a>07560 <span class="comment"> *  Returns the standard output of running _cmd_ in a subshell.</span>
<a name="l07561"></a>07561 <span class="comment"> *  The built-in syntax &lt;code&gt;%x{...}&lt;/code&gt; uses</span>
<a name="l07562"></a>07562 <span class="comment"> *  this method. Sets &lt;code&gt;$?&lt;/code&gt; to the process status.</span>
<a name="l07563"></a>07563 <span class="comment"> *</span>
<a name="l07564"></a>07564 <span class="comment"> *     `date`                   #=&gt; &quot;Wed Apr  9 08:56:30 CDT 2003\n&quot;</span>
<a name="l07565"></a>07565 <span class="comment"> *     `ls testdir`.split[1]    #=&gt; &quot;main.rb&quot;</span>
<a name="l07566"></a>07566 <span class="comment"> *     `echo oops &amp;&amp; exit 99`   #=&gt; &quot;oops\n&quot;</span>
<a name="l07567"></a>07567 <span class="comment"> *     $?.exitstatus            #=&gt; 99</span>
<a name="l07568"></a>07568 <span class="comment"> */</span>
<a name="l07569"></a>07569 
<a name="l07570"></a>07570 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07571"></a><a class="code" href="../../df/d0a/io_8c.html#af46fd563e8e9458763ff5054a6b79ace">07571</a> <a class="code" href="../../df/d0a/io_8c.html#af46fd563e8e9458763ff5054a6b79ace">rb_f_backquote</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str)
<a name="l07572"></a>07572 {
<a name="l07573"></a>07573     <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> port;
<a name="l07574"></a>07574     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d8/d90/nkf_8c.html#a5ea5ac7abf5cce39283e422add1067d5">result</a>;
<a name="l07575"></a>07575     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l07576"></a>07576 
<a name="l07577"></a>07577     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0381640e2905c1b3e104194f91697ca4">SafeStringValue</a>(str);
<a name="l07578"></a>07578     port = <a class="code" href="../../df/d0a/io_8c.html#a9246eb91d966de94aff31ef562e051e9">pipe_open_s</a>(str, <span class="stringliteral">&quot;r&quot;</span>, <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>|<a class="code" href="../../df/d0a/io_8c.html#ab2c655110073a066c789b7e92cf7377c">DEFAULT_TEXTMODE</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l07579"></a>07579     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(port)) <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(0,0);
<a name="l07580"></a>07580 
<a name="l07581"></a>07581     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(port, fptr);
<a name="l07582"></a>07582     result = <a class="code" href="../../df/d0a/io_8c.html#af2554e01814c78482ef25c774bbf7477">read_all</a>(fptr, <a class="code" href="../../df/d0a/io_8c.html#a12126308ff477ec7e04e15db2f878285">remain_size</a>(fptr), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l07583"></a>07583     <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>(port);
<a name="l07584"></a>07584 
<a name="l07585"></a>07585     <span class="keywordflow">return</span> result;
<a name="l07586"></a>07586 }
<a name="l07587"></a>07587 
<a name="l07588"></a>07588 <span class="preprocessor">#ifdef HAVE_SYS_SELECT_H</span>
<a name="l07589"></a>07589 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/select.h&gt;</span>
<a name="l07590"></a>07590 <span class="preprocessor">#endif</span>
<a name="l07591"></a>07591 <span class="preprocessor"></span>
<a name="l07592"></a>07592 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07593"></a><a class="code" href="../../df/d0a/io_8c.html#a8669568c71e7a305c0bb2b9ede9138b4">07593</a> <a class="code" href="../../df/d0a/io_8c.html#a8669568c71e7a305c0bb2b9ede9138b4">select_internal</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> read, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> except, <span class="keyword">struct</span> <a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> *tp, <a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> *fds)
<a name="l07594"></a>07594 {
<a name="l07595"></a>07595     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> res, <a class="code" href="../../d5/db5/encoding_8c.html#a05f70dacbe595d27364e1e014efb0c8e">list</a>;
<a name="l07596"></a>07596     <a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> *rp, *wp, *ep;
<a name="l07597"></a>07597     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l07598"></a>07598     <span class="keywordtype">long</span> i;
<a name="l07599"></a>07599     <span class="keywordtype">int</span> max = 0, n;
<a name="l07600"></a>07600     <span class="keywordtype">int</span> pending = 0;
<a name="l07601"></a>07601     <span class="keyword">struct </span><a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> timerec;
<a name="l07602"></a>07602 
<a name="l07603"></a>07603     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(read)) {
<a name="l07604"></a>07604         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad5a1e03b0a66824f95f6aaf07b4a4052">Check_Type</a>(read, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a>);
<a name="l07605"></a>07605         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(read); i++) {
<a name="l07606"></a>07606             <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(<a class="code" href="../../db/d2e/intern_8h.html#abc8a40f163cccdca6e3b9c0db7ed24b3">rb_io_get_io</a>(<a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(read)[i]), fptr);
<a name="l07607"></a>07607             <a class="code" href="../../db/d2e/intern_8h.html#ab93b57ee695b8d0abe01904e952c3a6f">rb_fd_set</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, &amp;fds[0]);
<a name="l07608"></a>07608             <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a38357513887e9cae9c0b4a5dc0d4007e">READ_DATA_PENDING</a>(fptr) || <a class="code" href="../../df/d0a/io_8c.html#aa0377d67a404cdeebc3ad2ceab0ef054">READ_CHAR_PENDING</a>(fptr)) { <span class="comment">/* check for buffered data */</span>
<a name="l07609"></a>07609                 pending++;
<a name="l07610"></a>07610                 <a class="code" href="../../db/d2e/intern_8h.html#ab93b57ee695b8d0abe01904e952c3a6f">rb_fd_set</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, &amp;fds[3]);
<a name="l07611"></a>07611             }
<a name="l07612"></a>07612             <span class="keywordflow">if</span> (max &lt; fptr-&gt;fd) max = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>;
<a name="l07613"></a>07613         }
<a name="l07614"></a>07614         <span class="keywordflow">if</span> (pending) {          <span class="comment">/* no blocking if there&apos;s buffered data */</span>
<a name="l07615"></a>07615             timerec.<a class="code" href="../../d1/d1b/structtimeval.html#a3599199839a89e99a2ce29d45312b5cf">tv_sec</a> = timerec.<a class="code" href="../../d1/d1b/structtimeval.html#aa8396731f2914f9ed2a457d3da602b80">tv_usec</a> = 0;
<a name="l07616"></a>07616             tp = &amp;timerec;
<a name="l07617"></a>07617         }
<a name="l07618"></a>07618         rp = &amp;fds[0];
<a name="l07619"></a>07619     }
<a name="l07620"></a>07620     <span class="keywordflow">else</span>
<a name="l07621"></a>07621         rp = 0;
<a name="l07622"></a>07622 
<a name="l07623"></a>07623     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(write)) {
<a name="l07624"></a>07624         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad5a1e03b0a66824f95f6aaf07b4a4052">Check_Type</a>(write, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a>);
<a name="l07625"></a>07625         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(write); i++) {
<a name="l07626"></a>07626             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write_io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(<a class="code" href="../../db/d2e/intern_8h.html#abc8a40f163cccdca6e3b9c0db7ed24b3">rb_io_get_io</a>(<a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(write)[i]));
<a name="l07627"></a>07627             <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(write_io, fptr);
<a name="l07628"></a>07628             <a class="code" href="../../db/d2e/intern_8h.html#ab93b57ee695b8d0abe01904e952c3a6f">rb_fd_set</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, &amp;fds[1]);
<a name="l07629"></a>07629             <span class="keywordflow">if</span> (max &lt; fptr-&gt;fd) max = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>;
<a name="l07630"></a>07630         }
<a name="l07631"></a>07631         wp = &amp;fds[1];
<a name="l07632"></a>07632     }
<a name="l07633"></a>07633     <span class="keywordflow">else</span>
<a name="l07634"></a>07634         wp = 0;
<a name="l07635"></a>07635 
<a name="l07636"></a>07636     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(except)) {
<a name="l07637"></a>07637         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad5a1e03b0a66824f95f6aaf07b4a4052">Check_Type</a>(except, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a>);
<a name="l07638"></a>07638         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(except); i++) {
<a name="l07639"></a>07639             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io = <a class="code" href="../../db/d2e/intern_8h.html#abc8a40f163cccdca6e3b9c0db7ed24b3">rb_io_get_io</a>(<a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(except)[i]);
<a name="l07640"></a>07640             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write_io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l07641"></a>07641             <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l07642"></a>07642             <a class="code" href="../../db/d2e/intern_8h.html#ab93b57ee695b8d0abe01904e952c3a6f">rb_fd_set</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, &amp;fds[2]);
<a name="l07643"></a>07643             <span class="keywordflow">if</span> (max &lt; fptr-&gt;fd) max = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>;
<a name="l07644"></a>07644             <span class="keywordflow">if</span> (io != write_io) {
<a name="l07645"></a>07645                 <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(write_io, fptr);
<a name="l07646"></a>07646                 <a class="code" href="../../db/d2e/intern_8h.html#ab93b57ee695b8d0abe01904e952c3a6f">rb_fd_set</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, &amp;fds[2]);
<a name="l07647"></a>07647                 <span class="keywordflow">if</span> (max &lt; fptr-&gt;fd) max = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>;
<a name="l07648"></a>07648             }
<a name="l07649"></a>07649         }
<a name="l07650"></a>07650         ep = &amp;fds[2];
<a name="l07651"></a>07651     }
<a name="l07652"></a>07652     <span class="keywordflow">else</span> {
<a name="l07653"></a>07653         ep = 0;
<a name="l07654"></a>07654     }
<a name="l07655"></a>07655 
<a name="l07656"></a>07656     max++;
<a name="l07657"></a>07657 
<a name="l07658"></a>07658     n = <a class="code" href="../../db/d2e/intern_8h.html#a3dbecc01461a64d6b6fa6d1b229fbd91">rb_thread_fd_select</a>(max, rp, wp, ep, tp);
<a name="l07659"></a>07659     <span class="keywordflow">if</span> (n &lt; 0) {
<a name="l07660"></a>07660         <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l07661"></a>07661     }
<a name="l07662"></a>07662     <span class="keywordflow">if</span> (!pending &amp;&amp; n == 0) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>; <span class="comment">/* returns nil on timeout */</span>
<a name="l07663"></a>07663 
<a name="l07664"></a>07664     res = <a class="code" href="../../dc/dcc/array_8c.html#a43a7bd246935ab63c233b4ae34d61d75">rb_ary_new2</a>(3);
<a name="l07665"></a>07665     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(res, rp?<a class="code" href="../../dc/dcc/array_8c.html#a9518114fd36cb4ef4656ec1dc63348c9">rb_ary_new</a>():<a class="code" href="../../dc/dcc/array_8c.html#a43a7bd246935ab63c233b4ae34d61d75">rb_ary_new2</a>(0));
<a name="l07666"></a>07666     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(res, wp?<a class="code" href="../../dc/dcc/array_8c.html#a9518114fd36cb4ef4656ec1dc63348c9">rb_ary_new</a>():<a class="code" href="../../dc/dcc/array_8c.html#a43a7bd246935ab63c233b4ae34d61d75">rb_ary_new2</a>(0));
<a name="l07667"></a>07667     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(res, ep?<a class="code" href="../../dc/dcc/array_8c.html#a9518114fd36cb4ef4656ec1dc63348c9">rb_ary_new</a>():<a class="code" href="../../dc/dcc/array_8c.html#a43a7bd246935ab63c233b4ae34d61d75">rb_ary_new2</a>(0));
<a name="l07668"></a>07668 
<a name="l07669"></a>07669     <span class="keywordflow">if</span> (rp) {
<a name="l07670"></a>07670         list = <a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(res)[0];
<a name="l07671"></a>07671         <span class="keywordflow">for</span> (i=0; i&lt; <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(read); i++) {
<a name="l07672"></a>07672             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj = <a class="code" href="../../dc/dcc/array_8c.html#ae3c2ac6c88e666d5418855114eb8bcf8">rb_ary_entry</a>(read, i);
<a name="l07673"></a>07673             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io = <a class="code" href="../../db/d2e/intern_8h.html#abc8a40f163cccdca6e3b9c0db7ed24b3">rb_io_get_io</a>(obj);
<a name="l07674"></a>07674             <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l07675"></a>07675             <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#af82c3503c613d3ef54feb2ccbb3b1d6a">rb_fd_isset</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, &amp;fds[0]) ||
<a name="l07676"></a>07676                 <a class="code" href="../../db/d2e/intern_8h.html#af82c3503c613d3ef54feb2ccbb3b1d6a">rb_fd_isset</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, &amp;fds[3])) {
<a name="l07677"></a>07677                 <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(list, obj);
<a name="l07678"></a>07678             }
<a name="l07679"></a>07679         }
<a name="l07680"></a>07680     }
<a name="l07681"></a>07681 
<a name="l07682"></a>07682     <span class="keywordflow">if</span> (wp) {
<a name="l07683"></a>07683         list = <a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(res)[1];
<a name="l07684"></a>07684         <span class="keywordflow">for</span> (i=0; i&lt; <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(write); i++) {
<a name="l07685"></a>07685             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj = <a class="code" href="../../dc/dcc/array_8c.html#ae3c2ac6c88e666d5418855114eb8bcf8">rb_ary_entry</a>(write, i);
<a name="l07686"></a>07686             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io = <a class="code" href="../../db/d2e/intern_8h.html#abc8a40f163cccdca6e3b9c0db7ed24b3">rb_io_get_io</a>(obj);
<a name="l07687"></a>07687             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write_io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l07688"></a>07688             <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(write_io, fptr);
<a name="l07689"></a>07689             <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#af82c3503c613d3ef54feb2ccbb3b1d6a">rb_fd_isset</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, &amp;fds[1])) {
<a name="l07690"></a>07690                 <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(list, obj);
<a name="l07691"></a>07691             }
<a name="l07692"></a>07692         }
<a name="l07693"></a>07693     }
<a name="l07694"></a>07694 
<a name="l07695"></a>07695     <span class="keywordflow">if</span> (ep) {
<a name="l07696"></a>07696         list = <a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(res)[2];
<a name="l07697"></a>07697         <span class="keywordflow">for</span> (i=0; i&lt; <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(except); i++) {
<a name="l07698"></a>07698             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj = <a class="code" href="../../dc/dcc/array_8c.html#ae3c2ac6c88e666d5418855114eb8bcf8">rb_ary_entry</a>(except, i);
<a name="l07699"></a>07699             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io = <a class="code" href="../../db/d2e/intern_8h.html#abc8a40f163cccdca6e3b9c0db7ed24b3">rb_io_get_io</a>(obj);
<a name="l07700"></a>07700             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> write_io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l07701"></a>07701             <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l07702"></a>07702             <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#af82c3503c613d3ef54feb2ccbb3b1d6a">rb_fd_isset</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, &amp;fds[2])) {
<a name="l07703"></a>07703                 <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(list, obj);
<a name="l07704"></a>07704             }
<a name="l07705"></a>07705             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (io != write_io) {
<a name="l07706"></a>07706                 <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(write_io, fptr);
<a name="l07707"></a>07707                 <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#af82c3503c613d3ef54feb2ccbb3b1d6a">rb_fd_isset</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, &amp;fds[2])) {
<a name="l07708"></a>07708                     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(list, obj);
<a name="l07709"></a>07709                 }
<a name="l07710"></a>07710             }
<a name="l07711"></a>07711         }
<a name="l07712"></a>07712     }
<a name="l07713"></a>07713 
<a name="l07714"></a>07714     <span class="keywordflow">return</span> res;                 <span class="comment">/* returns an empty array on interrupt */</span>
<a name="l07715"></a>07715 }
<a name="l07716"></a>07716 
<a name="l07717"></a><a class="code" href="../../d9/d02/structselect__args.html">07717</a> <span class="keyword">struct </span><a class="code" href="../../d9/d02/structselect__args.html">select_args</a> {
<a name="l07718"></a><a class="code" href="../../d9/d02/structselect__args.html#a8eb87b49d6bafb9368cad5dc27718c11">07718</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d9/d02/structselect__args.html#ab50cab45a8ec9fbbd5e5649176c2f179">read</a>, <a class="code" href="../../d9/d02/structselect__args.html#a8eb87b49d6bafb9368cad5dc27718c11">write</a>, <a class="code" href="../../d9/d02/structselect__args.html#af19315c32394fc498874d2a246f2600a">except</a>;
<a name="l07719"></a><a class="code" href="../../d9/d02/structselect__args.html#a84de0527e02bc0a9c415c84d46f3635f">07719</a>     <span class="keyword">struct </span><a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> *<a class="code" href="../../d9/d02/structselect__args.html#a84de0527e02bc0a9c415c84d46f3635f">timeout</a>;
<a name="l07720"></a><a class="code" href="../../d9/d02/structselect__args.html#a1bd064fd13193589f354789ce3bf1b9d">07720</a>     <a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> <a class="code" href="../../d9/d02/structselect__args.html#a1bd064fd13193589f354789ce3bf1b9d">fdsets</a>[4];
<a name="l07721"></a>07721 };
<a name="l07722"></a>07722 
<a name="l07723"></a>07723 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07724"></a><a class="code" href="../../df/d0a/io_8c.html#aeef673565f567651a47458a567c6c0e3">07724</a> <a class="code" href="../../df/d0a/io_8c.html#aeef673565f567651a47458a567c6c0e3">select_call</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l07725"></a>07725 {
<a name="l07726"></a>07726     <span class="keyword">struct </span><a class="code" href="../../d9/d02/structselect__args.html">select_args</a> *p = (<span class="keyword">struct </span><a class="code" href="../../d9/d02/structselect__args.html">select_args</a> *)arg;
<a name="l07727"></a>07727 
<a name="l07728"></a>07728     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a8669568c71e7a305c0bb2b9ede9138b4">select_internal</a>(p-&gt;<a class="code" href="../../d9/d02/structselect__args.html#ab50cab45a8ec9fbbd5e5649176c2f179">read</a>, p-&gt;<a class="code" href="../../d9/d02/structselect__args.html#a8eb87b49d6bafb9368cad5dc27718c11">write</a>, p-&gt;<a class="code" href="../../d9/d02/structselect__args.html#af19315c32394fc498874d2a246f2600a">except</a>, p-&gt;<a class="code" href="../../d9/d02/structselect__args.html#a84de0527e02bc0a9c415c84d46f3635f">timeout</a>, p-&gt;<a class="code" href="../../d9/d02/structselect__args.html#a1bd064fd13193589f354789ce3bf1b9d">fdsets</a>);
<a name="l07729"></a>07729 }
<a name="l07730"></a>07730 
<a name="l07731"></a>07731 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07732"></a><a class="code" href="../../df/d0a/io_8c.html#a94190f0e1e02080c21687dfa92e77c8b">07732</a> <a class="code" href="../../df/d0a/io_8c.html#a94190f0e1e02080c21687dfa92e77c8b">select_end</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l07733"></a>07733 {
<a name="l07734"></a>07734     <span class="keyword">struct </span><a class="code" href="../../d9/d02/structselect__args.html">select_args</a> *p = (<span class="keyword">struct </span><a class="code" href="../../d9/d02/structselect__args.html">select_args</a> *)arg;
<a name="l07735"></a>07735     <span class="keywordtype">int</span> i;
<a name="l07736"></a>07736 
<a name="l07737"></a>07737     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(p-&gt;<a class="code" href="../../d9/d02/structselect__args.html#a1bd064fd13193589f354789ce3bf1b9d">fdsets</a>); ++i)
<a name="l07738"></a>07738         <a class="code" href="../../db/d2e/intern_8h.html#af5ba60171ec45c289183e9fa3e829b8a">rb_fd_term</a>(&amp;p-&gt;<a class="code" href="../../d9/d02/structselect__args.html#a1bd064fd13193589f354789ce3bf1b9d">fdsets</a>[i]);
<a name="l07739"></a>07739     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l07740"></a>07740 }
<a name="l07741"></a>07741 
<a name="l07742"></a><a class="code" href="../../df/d0a/io_8c.html#aa75d76cc61bf830ecb91654154ba185b">07742</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../df/d0a/io_8c.html#a1f4192ac27e2a625d13e2c69f3005753">sym_normal</a>,   <a class="code" href="../../df/d0a/io_8c.html#aed02150606a80358ce2b5855d563ed1b">sym_sequential</a>, <a class="code" href="../../df/d0a/io_8c.html#a8e8e14b5e88fb716835a72924abf23e8">sym_random</a>,
<a name="l07743"></a>07743              <a class="code" href="../../df/d0a/io_8c.html#aa75d76cc61bf830ecb91654154ba185b">sym_willneed</a>, <a class="code" href="../../df/d0a/io_8c.html#ae2c45fb35853553a1ec019a17ab04f5f">sym_dontneed</a>, <a class="code" href="../../df/d0a/io_8c.html#a53c6b4f96cf6ab82eeb3cb0213410ef7">sym_noreuse</a>;
<a name="l07744"></a>07744 
<a name="l07745"></a>07745 <span class="preprocessor">#ifdef HAVE_POSIX_FADVISE</span>
<a name="l07746"></a>07746 <span class="preprocessor"></span><span class="keyword">struct </span>io_advise_struct {
<a name="l07747"></a>07747     <span class="keywordtype">int</span> fd;
<a name="l07748"></a>07748     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> offset;
<a name="l07749"></a>07749     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l07750"></a>07750     <span class="keywordtype">int</span> advice;
<a name="l07751"></a>07751 };
<a name="l07752"></a>07752 
<a name="l07753"></a>07753 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07754"></a>07754 io_advise_internal(<span class="keywordtype">void</span> *arg)
<a name="l07755"></a>07755 {
<a name="l07756"></a>07756     <span class="keyword">struct </span>io_advise_struct *ptr = arg;
<a name="l07757"></a>07757     <span class="keywordflow">return</span> posix_fadvise(ptr-&gt;fd, ptr-&gt;offset, ptr-&gt;len, ptr-&gt;advice);
<a name="l07758"></a>07758 }
<a name="l07759"></a>07759 
<a name="l07760"></a>07760 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07761"></a>07761 io_advise_sym_to_const(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dd/dc0/date__core_8c.html#a8157485e687f56a6ae2f3ee0a8cb1580">sym</a>)
<a name="l07762"></a>07762 {
<a name="l07763"></a>07763 <span class="preprocessor">#ifdef POSIX_FADV_NORMAL</span>
<a name="l07764"></a>07764 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (sym == sym_normal)
<a name="l07765"></a>07765         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(POSIX_FADV_NORMAL);
<a name="l07766"></a>07766 <span class="preprocessor">#endif</span>
<a name="l07767"></a>07767 <span class="preprocessor"></span>
<a name="l07768"></a>07768 <span class="preprocessor">#ifdef POSIX_FADV_RANDOM</span>
<a name="l07769"></a>07769 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (sym == sym_random)
<a name="l07770"></a>07770         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(POSIX_FADV_RANDOM);
<a name="l07771"></a>07771 <span class="preprocessor">#endif</span>
<a name="l07772"></a>07772 <span class="preprocessor"></span>
<a name="l07773"></a>07773 <span class="preprocessor">#ifdef POSIX_FADV_SEQUENTIAL</span>
<a name="l07774"></a>07774 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (sym == sym_sequential)
<a name="l07775"></a>07775         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(POSIX_FADV_SEQUENTIAL);
<a name="l07776"></a>07776 <span class="preprocessor">#endif</span>
<a name="l07777"></a>07777 <span class="preprocessor"></span>
<a name="l07778"></a>07778 <span class="preprocessor">#ifdef POSIX_FADV_WILLNEED</span>
<a name="l07779"></a>07779 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (sym == sym_willneed)
<a name="l07780"></a>07780         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(POSIX_FADV_WILLNEED);
<a name="l07781"></a>07781 <span class="preprocessor">#endif</span>
<a name="l07782"></a>07782 <span class="preprocessor"></span>
<a name="l07783"></a>07783 <span class="preprocessor">#ifdef POSIX_FADV_DONTNEED</span>
<a name="l07784"></a>07784 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (sym == sym_dontneed)
<a name="l07785"></a>07785         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(POSIX_FADV_DONTNEED);
<a name="l07786"></a>07786 <span class="preprocessor">#endif</span>
<a name="l07787"></a>07787 <span class="preprocessor"></span>
<a name="l07788"></a>07788 <span class="preprocessor">#ifdef POSIX_FADV_NOREUSE</span>
<a name="l07789"></a>07789 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (sym == sym_noreuse)
<a name="l07790"></a>07790         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(POSIX_FADV_NOREUSE);
<a name="l07791"></a>07791 <span class="preprocessor">#endif</span>
<a name="l07792"></a>07792 <span class="preprocessor"></span>
<a name="l07793"></a>07793     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l07794"></a>07794 }
<a name="l07795"></a>07795 
<a name="l07796"></a>07796 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07797"></a>07797 do_io_advise(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> advice, <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> offset, <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>)
<a name="l07798"></a>07798 {
<a name="l07799"></a>07799     <span class="keywordtype">int</span> rv;
<a name="l07800"></a>07800     <span class="keyword">struct </span>io_advise_struct ias;
<a name="l07801"></a>07801     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> num_adv;
<a name="l07802"></a>07802 
<a name="l07803"></a>07803     num_adv = io_advise_sym_to_const(advice);
<a name="l07804"></a>07804 
<a name="l07805"></a>07805     <span class="comment">/*</span>
<a name="l07806"></a>07806 <span class="comment">     * The platform doesn&apos;t support this hint. We don&apos;t raise exception, instead</span>
<a name="l07807"></a>07807 <span class="comment">     * silently ignore it. Because IO::advise is only hint.</span>
<a name="l07808"></a>07808 <span class="comment">     */</span>
<a name="l07809"></a>07809     <span class="keywordflow">if</span> (num_adv == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>)
<a name="l07810"></a>07810         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l07811"></a>07811 
<a name="l07812"></a>07812     ias.fd     = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>;
<a name="l07813"></a>07813     ias.advice = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(num_adv);
<a name="l07814"></a>07814     ias.offset = offset;
<a name="l07815"></a>07815     ias.len    = len;
<a name="l07816"></a>07816 
<a name="l07817"></a>07817     rv = (int)<a class="code" href="../../d3/de7/thread_8c.html#af541b78962a7376bf184693fc4144441">rb_thread_io_blocking_region</a>(io_advise_internal, &amp;ias, fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>);
<a name="l07818"></a>07818     <span class="keywordflow">if</span> (rv)
<a name="l07819"></a>07819         <span class="comment">/* posix_fadvise(2) doesn&apos;t set errno. On success it returns 0; otherwise</span>
<a name="l07820"></a>07820 <span class="comment">           it returns the error code. */</span>
<a name="l07821"></a>07821         <a class="code" href="../../db/dcc/error_8c.html#a06d06c4b2c620b779a344884167df484">rb_syserr_fail</a>(rv, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>));
<a name="l07822"></a>07822 
<a name="l07823"></a>07823     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l07824"></a>07824 }
<a name="l07825"></a>07825 
<a name="l07826"></a>07826 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_POSIX_FADVISE */</span>
<a name="l07827"></a>07827 
<a name="l07828"></a>07828 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l07829"></a><a class="code" href="../../df/d0a/io_8c.html#a71453acac646284e824822c5b4cbcb75">07829</a> <a class="code" href="../../df/d0a/io_8c.html#a71453acac646284e824822c5b4cbcb75">advice_arg_check</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> advice)
<a name="l07830"></a>07830 {
<a name="l07831"></a>07831     <span class="keywordflow">if</span> (!<a class="code" href="../../dc/d0c/cparse_8c.html#a637bc5a232034ee3fd411f8bef091566">SYMBOL_P</a>(advice))
<a name="l07832"></a>07832         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a565ed9d70f4089e1b4a36e9b3381b8c6">rb_eTypeError</a>, <span class="stringliteral">&quot;advice must be a Symbol&quot;</span>);
<a name="l07833"></a>07833 
<a name="l07834"></a>07834     <span class="keywordflow">if</span> (advice != sym_normal &amp;&amp;
<a name="l07835"></a>07835         advice != sym_sequential &amp;&amp;
<a name="l07836"></a>07836         advice != sym_random &amp;&amp;
<a name="l07837"></a>07837         advice != sym_willneed &amp;&amp;
<a name="l07838"></a>07838         advice != sym_dontneed &amp;&amp;
<a name="l07839"></a>07839         advice != sym_noreuse) {
<a name="l07840"></a>07840         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> symname = <a class="code" href="../../db/d2e/intern_8h.html#acbb281bacf6b80f460143348e26142e9">rb_inspect</a>(advice);
<a name="l07841"></a>07841         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a1f4044eeff81eb1676037771628b555c">rb_eNotImpError</a>, <span class="stringliteral">&quot;Unsupported advice: %s&quot;</span>,
<a name="l07842"></a>07842                  <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2665a51abbd5b49c15abff3df00fa9db">StringValuePtr</a>(symname));
<a name="l07843"></a>07843     }
<a name="l07844"></a>07844 }
<a name="l07845"></a>07845 
<a name="l07846"></a>07846 <span class="comment">/*</span>
<a name="l07847"></a>07847 <span class="comment"> *  call-seq:</span>
<a name="l07848"></a>07848 <span class="comment"> *     ios.advise(advice, offset=0, len=0) -&gt; nil</span>
<a name="l07849"></a>07849 <span class="comment"> *</span>
<a name="l07850"></a>07850 <span class="comment"> *  Announce an intention to access data from the current file in a</span>
<a name="l07851"></a>07851 <span class="comment"> *  specific pattern. On platforms that do not support the</span>
<a name="l07852"></a>07852 <span class="comment"> *  &lt;em&gt;posix_fadvise(2)&lt;/em&gt; system call, this method is a no-op.</span>
<a name="l07853"></a>07853 <span class="comment"> *</span>
<a name="l07854"></a>07854 <span class="comment"> * _advice_ is one of the following symbols:</span>
<a name="l07855"></a>07855 <span class="comment"> *</span>
<a name="l07856"></a>07856 <span class="comment"> *  * :normal - No advice to give; the default assumption for an open file.</span>
<a name="l07857"></a>07857 <span class="comment"> *  * :sequential - The data will be accessed sequentially:</span>
<a name="l07858"></a>07858 <span class="comment"> *     with lower offsets read before higher ones.</span>
<a name="l07859"></a>07859 <span class="comment"> *  * :random - The data will be accessed in random order.</span>
<a name="l07860"></a>07860 <span class="comment"> *  * :willneed - The data will be accessed in the near future.</span>
<a name="l07861"></a>07861 <span class="comment"> *  * :dontneed - The data will not be accessed in the near future.</span>
<a name="l07862"></a>07862 <span class="comment"> *  * :noreuse - The data will only be accessed once.</span>
<a name="l07863"></a>07863 <span class="comment"> *</span>
<a name="l07864"></a>07864 <span class="comment"> * The semantics of a piece of advice are platform-dependent. See</span>
<a name="l07865"></a>07865 <span class="comment"> * &lt;em&gt;man 2 posix_fadvise&lt;/em&gt; for details.</span>
<a name="l07866"></a>07866 <span class="comment"> *</span>
<a name="l07867"></a>07867 <span class="comment"> *  &quot;data&quot; means the region of the current file that begins at</span>
<a name="l07868"></a>07868 <span class="comment"> *  _offset_ and extends for _len_ bytes. If _len_ is 0, the region</span>
<a name="l07869"></a>07869 <span class="comment"> *  ends at the last byte of the file. By default, both _offset_ and</span>
<a name="l07870"></a>07870 <span class="comment"> *  _len_ are 0, meaning that the advice applies to the entire file.</span>
<a name="l07871"></a>07871 <span class="comment"> *</span>
<a name="l07872"></a>07872 <span class="comment"> *  If an error occurs, one of the following exceptions will be raised:</span>
<a name="l07873"></a>07873 <span class="comment"> *</span>
<a name="l07874"></a>07874 <span class="comment"> *  * &lt;code&gt;IOError&lt;/code&gt; - The &lt;code&gt;IO&lt;/code&gt; stream is closed.</span>
<a name="l07875"></a>07875 <span class="comment"> *  * &lt;code&gt;Errno::EBADF&lt;/code&gt; - The file descriptor of the current file is</span>
<a name="l07876"></a>07876 <span class="comment">      invalid.</span>
<a name="l07877"></a>07877 <span class="comment"> *  * &lt;code&gt;Errno::EINVAL&lt;/code&gt; - An invalid value for _advice_ was given.</span>
<a name="l07878"></a>07878 <span class="comment"> *  * &lt;code&gt;Errno::ESPIPE&lt;/code&gt; - The file descriptor of the current</span>
<a name="l07879"></a>07879 <span class="comment"> *  * file refers to a FIFO or pipe. (Linux raises &lt;code&gt;Errno::EINVAL&lt;/code&gt;</span>
<a name="l07880"></a>07880 <span class="comment"> *  * in this case).</span>
<a name="l07881"></a>07881 <span class="comment"> *  * &lt;code&gt;TypeError&lt;/code&gt; - Either _advice_ was not a Symbol, or one of the</span>
<a name="l07882"></a>07882 <span class="comment">      other arguments was not an &lt;code&gt;Integer&lt;/code&gt;.</span>
<a name="l07883"></a>07883 <span class="comment"> *  * &lt;code&gt;RangeError&lt;/code&gt; - One of the arguments given was too big/small.</span>
<a name="l07884"></a>07884 <span class="comment"> *</span>
<a name="l07885"></a>07885 <span class="comment"> * This list is not exhaustive; other Errno:: exceptions are also possible.</span>
<a name="l07886"></a>07886 <span class="comment"> */</span>
<a name="l07887"></a>07887 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07888"></a><a class="code" href="../../df/d0a/io_8c.html#add531bf7e584e1453d967d8871495d76">07888</a> <a class="code" href="../../df/d0a/io_8c.html#add531bf7e584e1453d967d8871495d76">rb_io_advise</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l07889"></a>07889 {
<a name="l07890"></a>07890     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> advice, offset, len;
<a name="l07891"></a>07891     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> off, l;
<a name="l07892"></a>07892     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l07893"></a>07893 
<a name="l07894"></a>07894     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;12&quot;</span>, &amp;advice, &amp;offset, &amp;len);
<a name="l07895"></a>07895     <a class="code" href="../../df/d0a/io_8c.html#a71453acac646284e824822c5b4cbcb75">advice_arg_check</a>(advice);
<a name="l07896"></a>07896 
<a name="l07897"></a>07897     io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(io);
<a name="l07898"></a>07898     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l07899"></a>07899 
<a name="l07900"></a>07900     off = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(offset) ? 0 : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#adc3ee80338c33b87afa2a7047287c96f">NUM2OFFT</a>(offset);
<a name="l07901"></a>07901     l   = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(len)    ? 0 : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#adc3ee80338c33b87afa2a7047287c96f">NUM2OFFT</a>(len);
<a name="l07902"></a>07902 
<a name="l07903"></a>07903 <span class="preprocessor">#ifdef HAVE_POSIX_FADVISE</span>
<a name="l07904"></a>07904 <span class="preprocessor"></span>    <span class="keywordflow">return</span> do_io_advise(fptr, advice, off, l);
<a name="l07905"></a>07905 <span class="preprocessor">#else</span>
<a name="l07906"></a>07906 <span class="preprocessor"></span>    <span class="comment">/* Ignore all hint */</span>
<a name="l07907"></a>07907     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l07908"></a>07908 <span class="preprocessor">#endif</span>
<a name="l07909"></a>07909 <span class="preprocessor"></span>}
<a name="l07910"></a>07910 
<a name="l07911"></a>07911 <span class="comment">/*</span>
<a name="l07912"></a>07912 <span class="comment"> *  call-seq:</span>
<a name="l07913"></a>07913 <span class="comment"> *     IO.select(read_array</span>
<a name="l07914"></a>07914 <span class="comment"> *               [, write_array</span>
<a name="l07915"></a>07915 <span class="comment"> *               [, error_array</span>
<a name="l07916"></a>07916 <span class="comment"> *               [, timeout]]]) -&gt; array  or  nil</span>
<a name="l07917"></a>07917 <span class="comment"> *</span>
<a name="l07918"></a>07918 <span class="comment"> *  Calls select(2) system call.</span>
<a name="l07919"></a>07919 <span class="comment"> *  It monitors given arrays of &lt;code&gt;IO&lt;/code&gt; objects, waits one or more</span>
<a name="l07920"></a>07920 <span class="comment"> *  of &lt;code&gt;IO&lt;/code&gt; objects ready for reading, are ready for writing,</span>
<a name="l07921"></a>07921 <span class="comment"> *  and have pending exceptions respectably, and returns an array that</span>
<a name="l07922"></a>07922 <span class="comment"> *  contains arrays of those IO objects.  It will return &lt;code&gt;nil&lt;/code&gt;</span>
<a name="l07923"></a>07923 <span class="comment"> *  if optional &lt;i&gt;timeout&lt;/i&gt; value is given and no &lt;code&gt;IO&lt;/code&gt; object</span>
<a name="l07924"></a>07924 <span class="comment"> *  is ready in &lt;i&gt;timeout&lt;/i&gt; seconds.</span>
<a name="l07925"></a>07925 <span class="comment"> *</span>
<a name="l07926"></a>07926 <span class="comment"> *  === Parameters</span>
<a name="l07927"></a>07927 <span class="comment"> *  read_array:: an array of &lt;code&gt;IO&lt;/code&gt; objects that wait until ready for read</span>
<a name="l07928"></a>07928 <span class="comment"> *  write_array:: an array of &lt;code&gt;IO&lt;/code&gt; objects that wait until ready for write</span>
<a name="l07929"></a>07929 <span class="comment"> *  error_array:: an array of &lt;code&gt;IO&lt;/code&gt; objects that wait for exceptions</span>
<a name="l07930"></a>07930 <span class="comment"> *  timeout:: a numeric value in second</span>
<a name="l07931"></a>07931 <span class="comment"> *</span>
<a name="l07932"></a>07932 <span class="comment"> *  === Example</span>
<a name="l07933"></a>07933 <span class="comment"> *</span>
<a name="l07934"></a>07934 <span class="comment"> *      rp, wp = IO.pipe</span>
<a name="l07935"></a>07935 <span class="comment"> *      mesg = &quot;ping &quot;</span>
<a name="l07936"></a>07936 <span class="comment"> *      100.times {</span>
<a name="l07937"></a>07937 <span class="comment"> *        rs, ws, = IO.select([rp], [wp])</span>
<a name="l07938"></a>07938 <span class="comment"> *        if r = rs[0]</span>
<a name="l07939"></a>07939 <span class="comment"> *          ret = r.read(5)</span>
<a name="l07940"></a>07940 <span class="comment"> *          print ret</span>
<a name="l07941"></a>07941 <span class="comment"> *          case ret</span>
<a name="l07942"></a>07942 <span class="comment"> *          when /ping/</span>
<a name="l07943"></a>07943 <span class="comment"> *            mesg = &quot;pong\n&quot;</span>
<a name="l07944"></a>07944 <span class="comment"> *          when /pong/</span>
<a name="l07945"></a>07945 <span class="comment"> *            mesg = &quot;ping &quot;</span>
<a name="l07946"></a>07946 <span class="comment"> *          end</span>
<a name="l07947"></a>07947 <span class="comment"> *        end</span>
<a name="l07948"></a>07948 <span class="comment"> *        if w = ws[0]</span>
<a name="l07949"></a>07949 <span class="comment"> *          w.write(mesg)</span>
<a name="l07950"></a>07950 <span class="comment"> *        end</span>
<a name="l07951"></a>07951 <span class="comment"> *      }</span>
<a name="l07952"></a>07952 <span class="comment"> *</span>
<a name="l07953"></a>07953 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l07954"></a>07954 <span class="comment"> *</span>
<a name="l07955"></a>07955 <span class="comment"> *      ping pong</span>
<a name="l07956"></a>07956 <span class="comment"> *      ping pong</span>
<a name="l07957"></a>07957 <span class="comment"> *      ping pong</span>
<a name="l07958"></a>07958 <span class="comment"> *      (snipped)</span>
<a name="l07959"></a>07959 <span class="comment"> *      ping</span>
<a name="l07960"></a>07960 <span class="comment"> */</span>
<a name="l07961"></a>07961 
<a name="l07962"></a>07962 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l07963"></a><a class="code" href="../../df/d0a/io_8c.html#ae57cd3655f3a05891a74390f85110e9d">07963</a> <a class="code" href="../../df/d0a/io_8c.html#ae57cd3655f3a05891a74390f85110e9d">rb_f_select</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj)
<a name="l07964"></a>07964 {
<a name="l07965"></a>07965     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> timeout;
<a name="l07966"></a>07966     <span class="keyword">struct </span><a class="code" href="../../d9/d02/structselect__args.html">select_args</a> args;
<a name="l07967"></a>07967     <span class="keyword">struct </span><a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> timerec;
<a name="l07968"></a>07968     <span class="keywordtype">int</span> i;
<a name="l07969"></a>07969 
<a name="l07970"></a>07970     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;13&quot;</span>, &amp;args.<a class="code" href="../../d9/d02/structselect__args.html#ab50cab45a8ec9fbbd5e5649176c2f179">read</a>, &amp;args.<a class="code" href="../../d9/d02/structselect__args.html#a8eb87b49d6bafb9368cad5dc27718c11">write</a>, &amp;args.<a class="code" href="../../d9/d02/structselect__args.html#af19315c32394fc498874d2a246f2600a">except</a>, &amp;timeout);
<a name="l07971"></a>07971     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(timeout)) {
<a name="l07972"></a>07972         args.<a class="code" href="../../d9/d02/structselect__args.html#a84de0527e02bc0a9c415c84d46f3635f">timeout</a> = 0;
<a name="l07973"></a>07973     }
<a name="l07974"></a>07974     <span class="keywordflow">else</span> {
<a name="l07975"></a>07975         timerec = <a class="code" href="../../db/d2e/intern_8h.html#aa7480dcdaae719ff3ef89108d1b59d44">rb_time_interval</a>(timeout);
<a name="l07976"></a>07976         args.<a class="code" href="../../d9/d02/structselect__args.html#a84de0527e02bc0a9c415c84d46f3635f">timeout</a> = &amp;timerec;
<a name="l07977"></a>07977     }
<a name="l07978"></a>07978 
<a name="l07979"></a>07979     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(args.<a class="code" href="../../d9/d02/structselect__args.html#a1bd064fd13193589f354789ce3bf1b9d">fdsets</a>); ++i)
<a name="l07980"></a>07980         <a class="code" href="../../db/d2e/intern_8h.html#af5c7e378da9f236d57683a79c526ccd6">rb_fd_init</a>(&amp;args.<a class="code" href="../../d9/d02/structselect__args.html#a1bd064fd13193589f354789ce3bf1b9d">fdsets</a>[i]);
<a name="l07981"></a>07981 
<a name="l07982"></a>07982     <span class="keywordflow">return</span> <a class="code" href="../../d3/d57/eval_8c.html#a8061198378fb16adeb931f90540b2839">rb_ensure</a>(<a class="code" href="../../df/d0a/io_8c.html#aeef673565f567651a47458a567c6c0e3">select_call</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;args, <a class="code" href="../../df/d0a/io_8c.html#a94190f0e1e02080c21687dfa92e77c8b">select_end</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;args);
<a name="l07983"></a>07983 }
<a name="l07984"></a>07984 
<a name="l07985"></a>07985 <span class="preprocessor">#if defined(__linux__) || defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__) || defined(__APPLE__)</span>
<a name="l07986"></a>07986 <span class="preprocessor"></span> <span class="keyword">typedef</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="../../df/d0a/io_8c.html#aef279fecb5578ef012f93c93eef8bdcb">ioctl_req_t</a>;
<a name="l07987"></a>07987 <span class="preprocessor"> #define NUM2IOCTLREQ(num) NUM2ULONG(num)</span>
<a name="l07988"></a>07988 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l07989"></a><a class="code" href="../../df/d0a/io_8c.html#aef279fecb5578ef012f93c93eef8bdcb">07989</a> <span class="preprocessor"></span> <span class="keyword">typedef</span> <span class="keywordtype">int</span> ioctl_req_t;
<a name="l07990"></a><a class="code" href="../../df/d0a/io_8c.html#a34c742df681e3575eb8c0be3cfe0afea">07990</a> <span class="preprocessor"> #define NUM2IOCTLREQ(num) NUM2INT(num)</span>
<a name="l07991"></a>07991 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l07992"></a>07992 <span class="preprocessor"></span>
<a name="l07993"></a><a class="code" href="../../d6/d46/structioctl__arg.html">07993</a> <span class="keyword">struct </span><a class="code" href="../../d6/d46/structioctl__arg.html">ioctl_arg</a> {
<a name="l07994"></a><a class="code" href="../../d6/d46/structioctl__arg.html#a0ec0b556b9bad9106f63b43a6e6b0529">07994</a>     <span class="keywordtype">int</span>         fd;
<a name="l07995"></a><a class="code" href="../../d6/d46/structioctl__arg.html#a76e285845488dd21d10a7abcb75abd47">07995</a>     ioctl_req_t <a class="code" href="../../d6/d46/structioctl__arg.html#a76e285845488dd21d10a7abcb75abd47">cmd</a>;
<a name="l07996"></a><a class="code" href="../../d6/d46/structioctl__arg.html#afce9cb03abe2557082d876c163f2fdb6">07996</a>     <span class="keywordtype">long</span>        <a class="code" href="../../d6/d46/structioctl__arg.html#afce9cb03abe2557082d876c163f2fdb6">narg</a>;
<a name="l07997"></a>07997 };
<a name="l07998"></a>07998 
<a name="l07999"></a><a class="code" href="../../df/d0a/io_8c.html#afc4bef1507743f9eb29b0df1c663936d">07999</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../df/d0a/io_8c.html#afc4bef1507743f9eb29b0df1c663936d">nogvl_ioctl</a>(<span class="keywordtype">void</span> *ptr)
<a name="l08000"></a>08000 {
<a name="l08001"></a>08001     <span class="keyword">struct </span><a class="code" href="../../d6/d46/structioctl__arg.html">ioctl_arg</a> *arg = ptr;
<a name="l08002"></a>08002 
<a name="l08003"></a>08003     <span class="keywordflow">return</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)<a class="code" href="../../dc/db1/win32_8h.html#ae3a230c65883ec8edc50e3a09ca80003">ioctl</a>(arg-&gt;<a class="code" href="../../d6/d46/structioctl__arg.html#a0ec0b556b9bad9106f63b43a6e6b0529">fd</a>, arg-&gt;<a class="code" href="../../d6/d46/structioctl__arg.html#a76e285845488dd21d10a7abcb75abd47">cmd</a>, arg-&gt;<a class="code" href="../../d6/d46/structioctl__arg.html#afce9cb03abe2557082d876c163f2fdb6">narg</a>);
<a name="l08004"></a>08004 }
<a name="l08005"></a>08005 
<a name="l08006"></a>08006 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l08007"></a><a class="code" href="../../df/d0a/io_8c.html#a0e5213ae1d3667d9b82ae36f20a580a6">08007</a> <a class="code" href="../../df/d0a/io_8c.html#a0e5213ae1d3667d9b82ae36f20a580a6">do_ioctl</a>(<span class="keywordtype">int</span> fd, ioctl_req_t <a class="code" href="../../d6/d46/structioctl__arg.html#a76e285845488dd21d10a7abcb75abd47">cmd</a>, <span class="keywordtype">long</span> <a class="code" href="../../d6/d46/structioctl__arg.html#afce9cb03abe2557082d876c163f2fdb6">narg</a>)
<a name="l08008"></a>08008 {
<a name="l08009"></a>08009     <span class="keywordtype">int</span> retval;
<a name="l08010"></a>08010     <span class="keyword">struct </span><a class="code" href="../../d6/d46/structioctl__arg.html">ioctl_arg</a> arg;
<a name="l08011"></a>08011 
<a name="l08012"></a>08012     arg.<a class="code" href="../../d6/d46/structioctl__arg.html#a0ec0b556b9bad9106f63b43a6e6b0529">fd</a> = fd;
<a name="l08013"></a>08013     arg.<a class="code" href="../../d6/d46/structioctl__arg.html#a76e285845488dd21d10a7abcb75abd47">cmd</a> = cmd;
<a name="l08014"></a>08014     arg.<a class="code" href="../../d6/d46/structioctl__arg.html#afce9cb03abe2557082d876c163f2fdb6">narg</a> = narg;
<a name="l08015"></a>08015 
<a name="l08016"></a>08016     retval = (int)<a class="code" href="../../d3/de7/thread_8c.html#af541b78962a7376bf184693fc4144441">rb_thread_io_blocking_region</a>(<a class="code" href="../../df/d0a/io_8c.html#afc4bef1507743f9eb29b0df1c663936d">nogvl_ioctl</a>, &amp;arg, fd);
<a name="l08017"></a>08017 
<a name="l08018"></a>08018     <span class="keywordflow">return</span> retval;
<a name="l08019"></a>08019 }
<a name="l08020"></a>08020 
<a name="l08021"></a><a class="code" href="../../df/d0a/io_8c.html#a80cf79d156c63a8f4420344f76ea9cea">08021</a> <span class="preprocessor">#define DEFULT_IOCTL_NARG_LEN (256)</span>
<a name="l08022"></a>08022 <span class="preprocessor"></span>
<a name="l08023"></a>08023 <span class="preprocessor">#ifdef __linux__</span>
<a name="l08024"></a>08024 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">long</span>
<a name="l08025"></a>08025 linux_iocparm_len(ioctl_req_t <a class="code" href="../../d6/d46/structioctl__arg.html#a76e285845488dd21d10a7abcb75abd47">cmd</a>)
<a name="l08026"></a>08026 {
<a name="l08027"></a>08027     <span class="keywordtype">long</span> len;
<a name="l08028"></a>08028 
<a name="l08029"></a>08029     <span class="keywordflow">if</span> ((cmd &amp; 0xFFFF0000) == 0) {
<a name="l08030"></a>08030         <span class="comment">/* legacy and unstructured ioctl number. */</span>
<a name="l08031"></a>08031         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a80cf79d156c63a8f4420344f76ea9cea">DEFULT_IOCTL_NARG_LEN</a>;
<a name="l08032"></a>08032     }
<a name="l08033"></a>08033 
<a name="l08034"></a>08034     len = _IOC_SIZE(cmd);
<a name="l08035"></a>08035 
<a name="l08036"></a>08036     <span class="comment">/* paranoia check for silly drivers which don&apos;t keep ioctl convention */</span>
<a name="l08037"></a>08037     <span class="keywordflow">if</span> (len &lt; <a class="code" href="../../df/d0a/io_8c.html#a80cf79d156c63a8f4420344f76ea9cea">DEFULT_IOCTL_NARG_LEN</a>)
<a name="l08038"></a>08038         len = <a class="code" href="../../df/d0a/io_8c.html#a80cf79d156c63a8f4420344f76ea9cea">DEFULT_IOCTL_NARG_LEN</a>;
<a name="l08039"></a>08039 
<a name="l08040"></a>08040     <span class="keywordflow">return</span> len;
<a name="l08041"></a>08041 }
<a name="l08042"></a>08042 <span class="preprocessor">#endif</span>
<a name="l08043"></a>08043 <span class="preprocessor"></span>
<a name="l08044"></a>08044 <span class="keyword">static</span> <span class="keywordtype">long</span>
<a name="l08045"></a><a class="code" href="../../df/d0a/io_8c.html#a6ea2530d7e79602477674d461ad1e3e1">08045</a> <a class="code" href="../../df/d0a/io_8c.html#a6ea2530d7e79602477674d461ad1e3e1">ioctl_narg_len</a>(ioctl_req_t <a class="code" href="../../d6/d46/structioctl__arg.html#a76e285845488dd21d10a7abcb75abd47">cmd</a>)
<a name="l08046"></a>08046 {
<a name="l08047"></a>08047     <span class="keywordtype">long</span> len;
<a name="l08048"></a>08048 
<a name="l08049"></a>08049 <span class="preprocessor">#ifdef IOCPARM_MASK</span>
<a name="l08050"></a>08050 <span class="preprocessor"></span><span class="preprocessor">#ifndef IOCPARM_LEN</span>
<a name="l08051"></a>08051 <span class="preprocessor"></span><span class="preprocessor">#define IOCPARM_LEN(x)  (((x) &gt;&gt; 16) &amp; IOCPARM_MASK)</span>
<a name="l08052"></a>08052 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l08053"></a>08053 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l08054"></a>08054 <span class="preprocessor"></span><span class="preprocessor">#ifdef IOCPARM_LEN</span>
<a name="l08055"></a>08055 <span class="preprocessor"></span>    len = IOCPARM_LEN(cmd);     <span class="comment">/* on BSDish systems we&apos;re safe */</span>
<a name="l08056"></a>08056 <span class="preprocessor">#elif defined(__linux__)</span>
<a name="l08057"></a>08057 <span class="preprocessor"></span>    len = linux_iocparm_len(cmd);
<a name="l08058"></a>08058 <span class="preprocessor">#else</span>
<a name="l08059"></a>08059 <span class="preprocessor"></span>    <span class="comment">/* otherwise guess at what&apos;s safe */</span>
<a name="l08060"></a>08060     len = <a class="code" href="../../df/d0a/io_8c.html#a80cf79d156c63a8f4420344f76ea9cea">DEFULT_IOCTL_NARG_LEN</a>;
<a name="l08061"></a>08061 <span class="preprocessor">#endif</span>
<a name="l08062"></a>08062 <span class="preprocessor"></span>
<a name="l08063"></a>08063     <span class="keywordflow">return</span> len;
<a name="l08064"></a>08064 }
<a name="l08065"></a>08065 
<a name="l08066"></a>08066 <span class="preprocessor">#ifdef HAVE_FCNTL</span>
<a name="l08067"></a>08067 <span class="preprocessor"></span><span class="preprocessor">#ifdef __linux__</span>
<a name="l08068"></a>08068 <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keywordtype">long</span> fcntl_arg_t;
<a name="l08069"></a>08069 <span class="preprocessor">#else</span>
<a name="l08070"></a>08070 <span class="preprocessor"></span><span class="comment">/* posix */</span>
<a name="l08071"></a>08071 <span class="keyword">typedef</span> <span class="keywordtype">int</span> fcntl_arg_t;
<a name="l08072"></a>08072 <span class="preprocessor">#endif</span>
<a name="l08073"></a>08073 <span class="preprocessor"></span>
<a name="l08074"></a>08074 <span class="keyword">static</span> <span class="keywordtype">long</span>
<a name="l08075"></a>08075 <a class="code" href="../../df/d0a/io_8c.html#af2673bc3a7ac64416e1b138e0fa2cebd">fcntl_narg_len</a>(<span class="keywordtype">int</span> <a class="code" href="../../d6/d46/structioctl__arg.html#a76e285845488dd21d10a7abcb75abd47">cmd</a>)
<a name="l08076"></a>08076 {
<a name="l08077"></a>08077     <span class="keywordtype">long</span> len;
<a name="l08078"></a>08078 
<a name="l08079"></a>08079     <span class="keywordflow">switch</span> (cmd) {
<a name="l08080"></a>08080 <span class="preprocessor">#ifdef F_DUPFD</span>
<a name="l08081"></a>08081 <span class="preprocessor"></span>      <span class="keywordflow">case</span> F_DUPFD:
<a name="l08082"></a>08082         len = <span class="keyword">sizeof</span>(fcntl_arg_t);
<a name="l08083"></a>08083         <span class="keywordflow">break</span>;
<a name="l08084"></a>08084 <span class="preprocessor">#endif</span>
<a name="l08085"></a>08085 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_DUP2FD </span><span class="comment">/* bsd specific */</span>
<a name="l08086"></a>08086       <span class="keywordflow">case</span> F_DUP2FD:
<a name="l08087"></a>08087         len = <span class="keyword">sizeof</span>(int);
<a name="l08088"></a>08088         <span class="keywordflow">break</span>;
<a name="l08089"></a>08089 <span class="preprocessor">#endif</span>
<a name="l08090"></a>08090 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_DUPFD_CLOEXEC </span><span class="comment">/* linux specific */</span>
<a name="l08091"></a>08091       <span class="keywordflow">case</span> F_DUPFD_CLOEXEC:
<a name="l08092"></a>08092         len = <span class="keyword">sizeof</span>(fcntl_arg_t);
<a name="l08093"></a>08093         <span class="keywordflow">break</span>;
<a name="l08094"></a>08094 <span class="preprocessor">#endif</span>
<a name="l08095"></a>08095 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_GETFD</span>
<a name="l08096"></a>08096 <span class="preprocessor"></span>      <span class="keywordflow">case</span> F_GETFD:
<a name="l08097"></a>08097         len = 1;
<a name="l08098"></a>08098         <span class="keywordflow">break</span>;
<a name="l08099"></a>08099 <span class="preprocessor">#endif</span>
<a name="l08100"></a>08100 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_SETFD</span>
<a name="l08101"></a>08101 <span class="preprocessor"></span>      <span class="keywordflow">case</span> F_SETFD:
<a name="l08102"></a>08102         len = <span class="keyword">sizeof</span>(fcntl_arg_t);
<a name="l08103"></a>08103         <span class="keywordflow">break</span>;
<a name="l08104"></a>08104 <span class="preprocessor">#endif</span>
<a name="l08105"></a>08105 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_GETFL</span>
<a name="l08106"></a>08106 <span class="preprocessor"></span>      <span class="keywordflow">case</span> F_GETFL:
<a name="l08107"></a>08107         len = 1;
<a name="l08108"></a>08108         <span class="keywordflow">break</span>;
<a name="l08109"></a>08109 <span class="preprocessor">#endif</span>
<a name="l08110"></a>08110 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_SETFL</span>
<a name="l08111"></a>08111 <span class="preprocessor"></span>      <span class="keywordflow">case</span> <a class="code" href="../../dc/db1/win32_8h.html#af2939853c650561d3495ed40f68f6249">F_SETFL</a>:
<a name="l08112"></a>08112         len = <span class="keyword">sizeof</span>(fcntl_arg_t);
<a name="l08113"></a>08113         <span class="keywordflow">break</span>;
<a name="l08114"></a>08114 <span class="preprocessor">#endif</span>
<a name="l08115"></a>08115 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_GETOWN</span>
<a name="l08116"></a>08116 <span class="preprocessor"></span>      <span class="keywordflow">case</span> F_GETOWN:
<a name="l08117"></a>08117         len = 1;
<a name="l08118"></a>08118         <span class="keywordflow">break</span>;
<a name="l08119"></a>08119 <span class="preprocessor">#endif</span>
<a name="l08120"></a>08120 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_SETOWN</span>
<a name="l08121"></a>08121 <span class="preprocessor"></span>      <span class="keywordflow">case</span> F_SETOWN:
<a name="l08122"></a>08122         len = <span class="keyword">sizeof</span>(fcntl_arg_t);
<a name="l08123"></a>08123         <span class="keywordflow">break</span>;
<a name="l08124"></a>08124 <span class="preprocessor">#endif</span>
<a name="l08125"></a>08125 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_GETOWN_EX </span><span class="comment">/* linux specific */</span>
<a name="l08126"></a>08126       <span class="keywordflow">case</span> F_GETOWN_EX:
<a name="l08127"></a>08127         len = <span class="keyword">sizeof</span>(<span class="keyword">struct </span>f_owner_ex);
<a name="l08128"></a>08128         <span class="keywordflow">break</span>;
<a name="l08129"></a>08129 <span class="preprocessor">#endif</span>
<a name="l08130"></a>08130 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_SETOWN_EX </span><span class="comment">/* linux specific */</span>
<a name="l08131"></a>08131       <span class="keywordflow">case</span> F_SETOWN_EX:
<a name="l08132"></a>08132         len = <span class="keyword">sizeof</span>(<span class="keyword">struct </span>f_owner_ex);
<a name="l08133"></a>08133         <span class="keywordflow">break</span>;
<a name="l08134"></a>08134 <span class="preprocessor">#endif</span>
<a name="l08135"></a>08135 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_GETLK</span>
<a name="l08136"></a>08136 <span class="preprocessor"></span>      <span class="keywordflow">case</span> F_GETLK:
<a name="l08137"></a>08137         len = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="../../d6/d13/file_8c.html#adfd2c00559413ba0c3cbbaa019401f36">flock</a>);
<a name="l08138"></a>08138         <span class="keywordflow">break</span>;
<a name="l08139"></a>08139 <span class="preprocessor">#endif</span>
<a name="l08140"></a>08140 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_SETLK</span>
<a name="l08141"></a>08141 <span class="preprocessor"></span>      <span class="keywordflow">case</span> F_SETLK:
<a name="l08142"></a>08142         len = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="../../d6/d13/file_8c.html#adfd2c00559413ba0c3cbbaa019401f36">flock</a>);
<a name="l08143"></a>08143         <span class="keywordflow">break</span>;
<a name="l08144"></a>08144 <span class="preprocessor">#endif</span>
<a name="l08145"></a>08145 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_SETLKW</span>
<a name="l08146"></a>08146 <span class="preprocessor"></span>      <span class="keywordflow">case</span> F_SETLKW:
<a name="l08147"></a>08147         len = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="../../d6/d13/file_8c.html#adfd2c00559413ba0c3cbbaa019401f36">flock</a>);
<a name="l08148"></a>08148         <span class="keywordflow">break</span>;
<a name="l08149"></a>08149 <span class="preprocessor">#endif</span>
<a name="l08150"></a>08150 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_READAHEAD </span><span class="comment">/* bsd specific */</span>
<a name="l08151"></a>08151       <span class="keywordflow">case</span> F_READAHEAD:
<a name="l08152"></a>08152         len = <span class="keyword">sizeof</span>(int);
<a name="l08153"></a>08153         <span class="keywordflow">break</span>;
<a name="l08154"></a>08154 <span class="preprocessor">#endif</span>
<a name="l08155"></a>08155 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_RDAHEAD </span><span class="comment">/* Darwin specific */</span>
<a name="l08156"></a>08156       <span class="keywordflow">case</span> F_RDAHEAD:
<a name="l08157"></a>08157         len = <span class="keyword">sizeof</span>(int);
<a name="l08158"></a>08158         <span class="keywordflow">break</span>;
<a name="l08159"></a>08159 <span class="preprocessor">#endif</span>
<a name="l08160"></a>08160 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_GETSIG </span><span class="comment">/* linux specific */</span>
<a name="l08161"></a>08161       <span class="keywordflow">case</span> F_GETSIG:
<a name="l08162"></a>08162         len = 1;
<a name="l08163"></a>08163         <span class="keywordflow">break</span>;
<a name="l08164"></a>08164 <span class="preprocessor">#endif</span>
<a name="l08165"></a>08165 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_SETSIG </span><span class="comment">/* linux specific */</span>
<a name="l08166"></a>08166       <span class="keywordflow">case</span> F_SETSIG:
<a name="l08167"></a>08167         len = <span class="keyword">sizeof</span>(fcntl_arg_t);
<a name="l08168"></a>08168         <span class="keywordflow">break</span>;
<a name="l08169"></a>08169 <span class="preprocessor">#endif</span>
<a name="l08170"></a>08170 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_GETLEASE </span><span class="comment">/* linux specific */</span>
<a name="l08171"></a>08171       <span class="keywordflow">case</span> F_GETLEASE:
<a name="l08172"></a>08172         len = 1;
<a name="l08173"></a>08173         <span class="keywordflow">break</span>;
<a name="l08174"></a>08174 <span class="preprocessor">#endif</span>
<a name="l08175"></a>08175 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_SETLEASE </span><span class="comment">/* linux specific */</span>
<a name="l08176"></a>08176       <span class="keywordflow">case</span> F_SETLEASE:
<a name="l08177"></a>08177         len = <span class="keyword">sizeof</span>(fcntl_arg_t);
<a name="l08178"></a>08178         <span class="keywordflow">break</span>;
<a name="l08179"></a>08179 <span class="preprocessor">#endif</span>
<a name="l08180"></a>08180 <span class="preprocessor"></span><span class="preprocessor">#ifdef F_NOTIFY </span><span class="comment">/* linux specific */</span>
<a name="l08181"></a>08181       <span class="keywordflow">case</span> F_NOTIFY:
<a name="l08182"></a>08182         len = <span class="keyword">sizeof</span>(fcntl_arg_t);
<a name="l08183"></a>08183         <span class="keywordflow">break</span>;
<a name="l08184"></a>08184 <span class="preprocessor">#endif</span>
<a name="l08185"></a>08185 <span class="preprocessor"></span>
<a name="l08186"></a>08186       <span class="keywordflow">default</span>:
<a name="l08187"></a>08187         len = 256;
<a name="l08188"></a>08188         <span class="keywordflow">break</span>;
<a name="l08189"></a>08189     }
<a name="l08190"></a>08190 
<a name="l08191"></a>08191     <span class="keywordflow">return</span> len;
<a name="l08192"></a>08192 }
<a name="l08193"></a>08193 <span class="preprocessor">#else </span><span class="comment">/* HAVE_FCNTL */</span>
<a name="l08194"></a>08194 <span class="keyword">static</span> <span class="keywordtype">long</span>
<a name="l08195"></a><a class="code" href="../../df/d0a/io_8c.html#af2673bc3a7ac64416e1b138e0fa2cebd">08195</a> <a class="code" href="../../df/d0a/io_8c.html#af2673bc3a7ac64416e1b138e0fa2cebd">fcntl_narg_len</a>(<span class="keywordtype">int</span> cmd)
<a name="l08196"></a>08196 {
<a name="l08197"></a>08197     <span class="keywordflow">return</span> 0;
<a name="l08198"></a>08198 }
<a name="l08199"></a>08199 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_FCNTL */</span>
<a name="l08200"></a>08200 
<a name="l08201"></a>08201 <span class="keyword">static</span> <span class="keywordtype">long</span>
<a name="l08202"></a><a class="code" href="../../df/d0a/io_8c.html#a278555c4d2928063dbc795e033e6a330">08202</a> <a class="code" href="../../df/d0a/io_8c.html#a278555c4d2928063dbc795e033e6a330">setup_narg</a>(ioctl_req_t cmd, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *argp, <span class="keywordtype">int</span> io_p)
<a name="l08203"></a>08203 {
<a name="l08204"></a>08204     <span class="keywordtype">long</span> narg = 0;
<a name="l08205"></a>08205     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg = *argp;
<a name="l08206"></a>08206 
<a name="l08207"></a>08207     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(arg) || arg == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>) {
<a name="l08208"></a>08208         narg = 0;
<a name="l08209"></a>08209     }
<a name="l08210"></a>08210     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#acf2fcf97dcf9c7c35452730eb3e2aeb2">FIXNUM_P</a>(arg)) {
<a name="l08211"></a>08211         narg = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae9390780cd6d04a2e0ac3d6282cdefea">FIX2LONG</a>(arg);
<a name="l08212"></a>08212     }
<a name="l08213"></a>08213     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (arg == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>) {
<a name="l08214"></a>08214         narg = 1;
<a name="l08215"></a>08215     }
<a name="l08216"></a>08216     <span class="keywordflow">else</span> {
<a name="l08217"></a>08217         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> tmp = <a class="code" href="../../db/d2e/intern_8h.html#a669b6063704b2d304844bd1553217cf0">rb_check_string_type</a>(arg);
<a name="l08218"></a>08218 
<a name="l08219"></a>08219         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(tmp)) {
<a name="l08220"></a>08220             narg = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(arg);
<a name="l08221"></a>08221         }
<a name="l08222"></a>08222         <span class="keywordflow">else</span> {
<a name="l08223"></a>08223             <span class="keywordtype">long</span> len;
<a name="l08224"></a>08224 
<a name="l08225"></a>08225             *argp = arg = tmp;
<a name="l08226"></a>08226             <span class="keywordflow">if</span> (io_p)
<a name="l08227"></a>08227                 len = <a class="code" href="../../df/d0a/io_8c.html#a6ea2530d7e79602477674d461ad1e3e1">ioctl_narg_len</a>(cmd);
<a name="l08228"></a>08228             <span class="keywordflow">else</span>
<a name="l08229"></a>08229                 len = <a class="code" href="../../df/d0a/io_8c.html#af2673bc3a7ac64416e1b138e0fa2cebd">fcntl_narg_len</a>((<span class="keywordtype">int</span>)cmd);
<a name="l08230"></a>08230             <a class="code" href="../../db/d2e/intern_8h.html#a63a6d05687cf812131dce11743581b9d">rb_str_modify</a>(arg);
<a name="l08231"></a>08231 
<a name="l08232"></a>08232             <span class="comment">/* expand for data + sentinel. */</span>
<a name="l08233"></a>08233             <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(arg) &lt; len+1) {
<a name="l08234"></a>08234                 <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(arg, len+1);
<a name="l08235"></a>08235             }
<a name="l08236"></a>08236             <span class="comment">/* a little sanity check here */</span>
<a name="l08237"></a>08237             <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(arg)[<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(arg) - 1] = 17;
<a name="l08238"></a>08238             narg = (<a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a>)(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac1cf124db1e117ff7d61d608024f63ee">SIGNED_VALUE</a>)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(arg);
<a name="l08239"></a>08239         }
<a name="l08240"></a>08240     }
<a name="l08241"></a>08241         <span class="keywordflow">return</span> narg;
<a name="l08242"></a>08242     }
<a name="l08243"></a>08243 
<a name="l08244"></a>08244 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08245"></a><a class="code" href="../../df/d0a/io_8c.html#a2afca1f88b49ceb446448e197f8494a1">08245</a> <a class="code" href="../../df/d0a/io_8c.html#a2afca1f88b49ceb446448e197f8494a1">rb_ioctl</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> req, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l08246"></a>08246 {
<a name="l08247"></a>08247     ioctl_req_t cmd = <a class="code" href="../../df/d0a/io_8c.html#a34c742df681e3575eb8c0be3cfe0afea">NUM2IOCTLREQ</a>(req);
<a name="l08248"></a>08248     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l08249"></a>08249     <span class="keywordtype">long</span> narg;
<a name="l08250"></a>08250     <span class="keywordtype">int</span> retval;
<a name="l08251"></a>08251   
<a name="l08252"></a>08252     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a98b91af598acb64fe8497413ce498766">rb_secure</a>(2);
<a name="l08253"></a>08253 
<a name="l08254"></a>08254     narg = <a class="code" href="../../df/d0a/io_8c.html#a278555c4d2928063dbc795e033e6a330">setup_narg</a>(cmd, &amp;arg, 1);
<a name="l08255"></a>08255     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l08256"></a>08256     retval = <a class="code" href="../../df/d0a/io_8c.html#a0e5213ae1d3667d9b82ae36f20a580a6">do_ioctl</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, cmd, narg);
<a name="l08257"></a>08257     <span class="keywordflow">if</span> (retval &lt; 0) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l08258"></a>08258     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac4f895997656c2abd27a29a8b8e982ca">RB_TYPE_P</a>(arg, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a22a8c2a4bbaae9b68f65c9bb92fd4e39">T_STRING</a>)) {
<a name="l08259"></a>08259         <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(arg)[<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(arg)-1] != 17)
<a name="l08260"></a>08260             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;return value overflowed string&quot;</span>);
<a name="l08261"></a>08261         <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(arg)[<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(arg)-1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l08262"></a>08262     }
<a name="l08263"></a>08263 
<a name="l08264"></a>08264     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(retval);
<a name="l08265"></a>08265 }
<a name="l08266"></a>08266 
<a name="l08267"></a>08267 <span class="comment">/*</span>
<a name="l08268"></a>08268 <span class="comment"> *  call-seq:</span>
<a name="l08269"></a>08269 <span class="comment"> *     ios.ioctl(integer_cmd, arg)    -&gt; integer</span>
<a name="l08270"></a>08270 <span class="comment"> *</span>
<a name="l08271"></a>08271 <span class="comment"> *  Provides a mechanism for issuing low-level commands to control or</span>
<a name="l08272"></a>08272 <span class="comment"> *  query I/O devices. Arguments and results are platform dependent. If</span>
<a name="l08273"></a>08273 <span class="comment"> *  &lt;i&gt;arg&lt;/i&gt; is a number, its value is passed directly. If it is a</span>
<a name="l08274"></a>08274 <span class="comment"> *  string, it is interpreted as a binary sequence of bytes. On Unix</span>
<a name="l08275"></a>08275 <span class="comment"> *  platforms, see &lt;code&gt;ioctl(2)&lt;/code&gt; for details. Not implemented on</span>
<a name="l08276"></a>08276 <span class="comment"> *  all platforms.</span>
<a name="l08277"></a>08277 <span class="comment"> */</span>
<a name="l08278"></a>08278 
<a name="l08279"></a>08279 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08280"></a><a class="code" href="../../df/d0a/io_8c.html#a58befea47265398d533bb9a2760e8eca">08280</a> <a class="code" href="../../df/d0a/io_8c.html#a58befea47265398d533bb9a2760e8eca">rb_io_ioctl</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l08281"></a>08281 {
<a name="l08282"></a>08282     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> req, arg;
<a name="l08283"></a>08283 
<a name="l08284"></a>08284     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;11&quot;</span>, &amp;req, &amp;arg);
<a name="l08285"></a>08285     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a2afca1f88b49ceb446448e197f8494a1">rb_ioctl</a>(io, req, arg);
<a name="l08286"></a>08286 }
<a name="l08287"></a>08287 
<a name="l08288"></a>08288 <span class="preprocessor">#ifdef HAVE_FCNTL</span>
<a name="l08289"></a>08289 <span class="preprocessor"></span><span class="keyword">struct </span>fcntl_arg {
<a name="l08290"></a>08290     <span class="keywordtype">int</span>         fd;
<a name="l08291"></a>08291     <span class="keywordtype">int</span>         cmd;
<a name="l08292"></a>08292     <span class="keywordtype">long</span>        narg;
<a name="l08293"></a>08293 };
<a name="l08294"></a>08294 
<a name="l08295"></a>08295 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> nogvl_fcntl(<span class="keywordtype">void</span> *ptr)
<a name="l08296"></a>08296 {
<a name="l08297"></a>08297     <span class="keyword">struct </span>fcntl_arg *arg = ptr;
<a name="l08298"></a>08298 
<a name="l08299"></a>08299 <span class="preprocessor">#if defined(F_DUPFD)</span>
<a name="l08300"></a>08300 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (arg-&gt;cmd == F_DUPFD)
<a name="l08301"></a>08301         <span class="keywordflow">return</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)<a class="code" href="../../df/d0a/io_8c.html#ac731a84d6bdd57dfcbdf468660dc38e5">rb_cloexec_fcntl_dupfd</a>(arg-&gt;fd, (<span class="keywordtype">int</span>)arg-&gt;narg);
<a name="l08302"></a>08302 <span class="preprocessor">#endif</span>
<a name="l08303"></a>08303 <span class="preprocessor"></span>    <span class="keywordflow">return</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)<a class="code" href="../../dc/db1/win32_8h.html#aa7a55dad56032ce4c5a40eab1d9c8e01">fcntl</a>(arg-&gt;fd, arg-&gt;cmd, arg-&gt;narg);
<a name="l08304"></a>08304 }
<a name="l08305"></a>08305 
<a name="l08306"></a>08306 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l08307"></a>08307 do_fcntl(<span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> cmd, <span class="keywordtype">long</span> narg)
<a name="l08308"></a>08308 {
<a name="l08309"></a>08309     <span class="keywordtype">int</span> retval;
<a name="l08310"></a>08310     <span class="keyword">struct </span>fcntl_arg arg;
<a name="l08311"></a>08311 
<a name="l08312"></a>08312     arg.fd = fd;
<a name="l08313"></a>08313     arg.cmd = cmd;
<a name="l08314"></a>08314     arg.narg = narg;
<a name="l08315"></a>08315 
<a name="l08316"></a>08316     retval = (int)<a class="code" href="../../d3/de7/thread_8c.html#af541b78962a7376bf184693fc4144441">rb_thread_io_blocking_region</a>(nogvl_fcntl, &amp;arg, fd);
<a name="l08317"></a>08317 <span class="preprocessor">#if defined(F_DUPFD)</span>
<a name="l08318"></a>08318 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (retval != -1 &amp;&amp; cmd == F_DUPFD) {
<a name="l08319"></a>08319         <a class="code" href="../../db/d2e/intern_8h.html#a6448f20b0936afe0cb85ab3186753db2">rb_update_max_fd</a>(retval);
<a name="l08320"></a>08320     }
<a name="l08321"></a>08321 <span class="preprocessor">#endif</span>
<a name="l08322"></a>08322 <span class="preprocessor"></span>
<a name="l08323"></a>08323     <span class="keywordflow">return</span> retval;
<a name="l08324"></a>08324 }
<a name="l08325"></a>08325 
<a name="l08326"></a>08326 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08327"></a>08327 rb_fcntl(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> req, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l08328"></a>08328 {
<a name="l08329"></a>08329     <span class="keywordtype">int</span> cmd = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(req);
<a name="l08330"></a>08330     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l08331"></a>08331     <span class="keywordtype">long</span> narg;
<a name="l08332"></a>08332     <span class="keywordtype">int</span> retval;
<a name="l08333"></a>08333 
<a name="l08334"></a>08334     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a98b91af598acb64fe8497413ce498766">rb_secure</a>(2);
<a name="l08335"></a>08335 
<a name="l08336"></a>08336     narg = <a class="code" href="../../df/d0a/io_8c.html#a278555c4d2928063dbc795e033e6a330">setup_narg</a>(cmd, &amp;arg, 0);
<a name="l08337"></a>08337     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l08338"></a>08338     retval = do_fcntl(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, cmd, narg);
<a name="l08339"></a>08339     <span class="keywordflow">if</span> (retval &lt; 0) <a class="code" href="../../de/d32/dir_8c.html#a33600c779917508425c20181f0f45366">rb_sys_fail_path</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aaaa2c729a8c1c1550505ea250338353e">pathv</a>);
<a name="l08340"></a>08340     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac4f895997656c2abd27a29a8b8e982ca">RB_TYPE_P</a>(arg, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a22a8c2a4bbaae9b68f65c9bb92fd4e39">T_STRING</a>)) {
<a name="l08341"></a>08341         <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(arg)[<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(arg)-1] != 17)
<a name="l08342"></a>08342             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;return value overflowed string&quot;</span>);
<a name="l08343"></a>08343         <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(arg)[<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(arg)-1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l08344"></a>08344     }
<a name="l08345"></a>08345 
<a name="l08346"></a>08346     <span class="keywordflow">if</span> (cmd == <a class="code" href="../../dc/db1/win32_8h.html#af2939853c650561d3495ed40f68f6249">F_SETFL</a>) {
<a name="l08347"></a>08347         <span class="keywordflow">if</span> (narg &amp; <a class="code" href="../../dc/db1/win32_8h.html#a39d33ce33804efd4d52606d59071c6d8">O_NONBLOCK</a>) {
<a name="l08348"></a>08348             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> |= <a class="code" href="../../dc/dac/io_8h.html#a549273c107e35c00c202299a498bd758">FMODE_WSPLIT_INITIALIZED</a>;
<a name="l08349"></a>08349             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp;= ~<a class="code" href="../../dc/dac/io_8h.html#ac4bc328ba5e87fac5381cf7b4afa7153">FMODE_WSPLIT</a>;
<a name="l08350"></a>08350         }
<a name="l08351"></a>08351         <span class="keywordflow">else</span> {
<a name="l08352"></a>08352             fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp;= ~(<a class="code" href="../../dc/dac/io_8h.html#a549273c107e35c00c202299a498bd758">FMODE_WSPLIT_INITIALIZED</a>|<a class="code" href="../../dc/dac/io_8h.html#ac4bc328ba5e87fac5381cf7b4afa7153">FMODE_WSPLIT</a>);
<a name="l08353"></a>08353         }
<a name="l08354"></a>08354     }
<a name="l08355"></a>08355 
<a name="l08356"></a>08356     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(retval);
<a name="l08357"></a>08357 }
<a name="l08358"></a>08358 
<a name="l08359"></a>08359 <span class="comment">/*</span>
<a name="l08360"></a>08360 <span class="comment"> *  call-seq:</span>
<a name="l08361"></a>08361 <span class="comment"> *     ios.fcntl(integer_cmd, arg)    -&gt; integer</span>
<a name="l08362"></a>08362 <span class="comment"> *</span>
<a name="l08363"></a>08363 <span class="comment"> *  Provides a mechanism for issuing low-level commands to control or</span>
<a name="l08364"></a>08364 <span class="comment"> *  query file-oriented I/O streams. Arguments and results are platform</span>
<a name="l08365"></a>08365 <span class="comment"> *  dependent. If &lt;i&gt;arg&lt;/i&gt; is a number, its value is passed</span>
<a name="l08366"></a>08366 <span class="comment"> *  directly. If it is a string, it is interpreted as a binary sequence</span>
<a name="l08367"></a>08367 <span class="comment"> *  of bytes (&lt;code&gt;Array#pack&lt;/code&gt; might be a useful way to build this</span>
<a name="l08368"></a>08368 <span class="comment"> *  string). On Unix platforms, see &lt;code&gt;fcntl(2)&lt;/code&gt; for details.</span>
<a name="l08369"></a>08369 <span class="comment"> *  Not implemented on all platforms.</span>
<a name="l08370"></a>08370 <span class="comment"> */</span>
<a name="l08371"></a>08371 
<a name="l08372"></a>08372 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08373"></a>08373 <a class="code" href="../../df/d0a/io_8c.html#a25757b08216839966226387375c027e2">rb_io_fcntl</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l08374"></a>08374 {
<a name="l08375"></a>08375     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> req, arg;
<a name="l08376"></a>08376 
<a name="l08377"></a>08377     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;11&quot;</span>, &amp;req, &amp;arg);
<a name="l08378"></a>08378     <span class="keywordflow">return</span> rb_fcntl(io, req, arg);
<a name="l08379"></a>08379 }
<a name="l08380"></a>08380 <span class="preprocessor">#else</span>
<a name="l08381"></a><a class="code" href="../../df/d0a/io_8c.html#a25757b08216839966226387375c027e2">08381</a> <span class="preprocessor"></span><span class="preprocessor">#define rb_io_fcntl rb_f_notimplement</span>
<a name="l08382"></a>08382 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l08383"></a>08383 <span class="preprocessor"></span>
<a name="l08384"></a>08384 <span class="preprocessor">#if defined(HAVE_SYSCALL) || defined(HAVE___SYSCALL)</span>
<a name="l08385"></a>08385 <span class="preprocessor"></span><span class="comment">/*</span>
<a name="l08386"></a>08386 <span class="comment"> *  call-seq:</span>
<a name="l08387"></a>08387 <span class="comment"> *     syscall(num [, args...])   -&gt; integer</span>
<a name="l08388"></a>08388 <span class="comment"> *</span>
<a name="l08389"></a>08389 <span class="comment"> *  Calls the operating system function identified by _num_ and</span>
<a name="l08390"></a>08390 <span class="comment"> *  returns the result of the function or raises SystemCallError if</span>
<a name="l08391"></a>08391 <span class="comment"> *  it failed.</span>
<a name="l08392"></a>08392 <span class="comment"> *</span>
<a name="l08393"></a>08393 <span class="comment"> *  Arguments for the function can follow _num_. They must be either</span>
<a name="l08394"></a>08394 <span class="comment"> *  +String+ objects or +Integer+ objects. A +String+ object is passed</span>
<a name="l08395"></a>08395 <span class="comment"> *  as a pointer to the byte sequence. An +Integer+ object is passed</span>
<a name="l08396"></a>08396 <span class="comment"> *  as an integer whose bit size is same as a pointer.</span>
<a name="l08397"></a>08397 <span class="comment"> *  Up to nine parameters may be passed (14 on the Atari-ST).</span>
<a name="l08398"></a>08398 <span class="comment"> *</span>
<a name="l08399"></a>08399 <span class="comment"> *  The function identified by _num_ is system</span>
<a name="l08400"></a>08400 <span class="comment"> *  dependent. On some Unix systems, the numbers may be obtained from a</span>
<a name="l08401"></a>08401 <span class="comment"> *  header file called &lt;code&gt;syscall.h&lt;/code&gt;.</span>
<a name="l08402"></a>08402 <span class="comment"> *</span>
<a name="l08403"></a>08403 <span class="comment"> *     syscall 4, 1, &quot;hello\n&quot;, 6   # &apos;4&apos; is write(2) on our box</span>
<a name="l08404"></a>08404 <span class="comment"> *</span>
<a name="l08405"></a>08405 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l08406"></a>08406 <span class="comment"> *</span>
<a name="l08407"></a>08407 <span class="comment"> *     hello</span>
<a name="l08408"></a>08408 <span class="comment"> *</span>
<a name="l08409"></a>08409 <span class="comment"> *</span>
<a name="l08410"></a>08410 <span class="comment"> *  Calling +syscall+ on a platform which does not have any way to</span>
<a name="l08411"></a>08411 <span class="comment"> *  an arbitrary system function just fails with NotImplementedError.</span>
<a name="l08412"></a>08412 <span class="comment"> *</span>
<a name="l08413"></a>08413 <span class="comment"> * Note::</span>
<a name="l08414"></a>08414 <span class="comment"> *   +syscall+ is essentially unsafe and unportable. Feel free to shoot your foot.</span>
<a name="l08415"></a>08415 <span class="comment"> *   DL (Fiddle) library is preferred for safer and a bit more portable programming.</span>
<a name="l08416"></a>08416 <span class="comment"> */</span>
<a name="l08417"></a>08417 
<a name="l08418"></a>08418 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08419"></a>08419 <a class="code" href="../../df/d0a/io_8c.html#a3c2b7c028963b354af16cbba3e6a915b">rb_f_syscall</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>)
<a name="l08420"></a>08420 {
<a name="l08421"></a>08421 <span class="preprocessor">#ifdef atarist</span>
<a name="l08422"></a>08422 <span class="preprocessor"></span>    <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg[13]; <span class="comment">/* yes, we really need that many ! */</span>
<a name="l08423"></a>08423 <span class="preprocessor">#else</span>
<a name="l08424"></a>08424 <span class="preprocessor"></span>    <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg[8];
<a name="l08425"></a>08425 <span class="preprocessor">#endif</span>
<a name="l08426"></a>08426 <span class="preprocessor"></span><span class="preprocessor">#if SIZEOF_VOIDP == 8 &amp;&amp; defined(HAVE___SYSCALL) &amp;&amp; SIZEOF_INT != 8 </span><span class="comment">/* mainly *BSD */</span>
<a name="l08427"></a>08427 <span class="preprocessor"># define SYSCALL __syscall</span>
<a name="l08428"></a>08428 <span class="preprocessor"></span><span class="preprocessor"># define NUM2SYSCALLID(x) NUM2LONG(x)</span>
<a name="l08429"></a>08429 <span class="preprocessor"></span><span class="preprocessor"># define RETVAL2NUM(x) LONG2NUM(x)</span>
<a name="l08430"></a>08430 <span class="preprocessor"></span><span class="preprocessor"># if SIZEOF_LONG == 8</span>
<a name="l08431"></a>08431 <span class="preprocessor"></span>    <span class="keywordtype">long</span> num, retval = -1;
<a name="l08432"></a>08432 <span class="preprocessor"># elif SIZEOF_LONG_LONG == 8</span>
<a name="l08433"></a>08433 <span class="preprocessor"></span>    <span class="keywordtype">long</span> <span class="keywordtype">long</span> num, retval = -1;
<a name="l08434"></a>08434 <span class="preprocessor"># else</span>
<a name="l08435"></a>08435 <span class="preprocessor"></span><span class="preprocessor">#  error ----&gt;&gt; it is asserted that __syscall takes the first argument and returns retval in 64bit signed integer. &lt;&lt;----</span>
<a name="l08436"></a>08436 <span class="preprocessor"></span><span class="preprocessor"># endif</span>
<a name="l08437"></a>08437 <span class="preprocessor"></span><span class="preprocessor">#elif defined linux</span>
<a name="l08438"></a>08438 <span class="preprocessor"></span><span class="preprocessor"># define SYSCALL syscall</span>
<a name="l08439"></a>08439 <span class="preprocessor"></span><span class="preprocessor"># define NUM2SYSCALLID(x) NUM2LONG(x)</span>
<a name="l08440"></a>08440 <span class="preprocessor"></span><span class="preprocessor"># define RETVAL2NUM(x) LONG2NUM(x)</span>
<a name="l08441"></a>08441 <span class="preprocessor"></span>    <span class="comment">/*</span>
<a name="l08442"></a>08442 <span class="comment">     * Linux man page says, syscall(2) function prototype is below.</span>
<a name="l08443"></a>08443 <span class="comment">     *</span>
<a name="l08444"></a>08444 <span class="comment">     *     int syscall(int number, ...);</span>
<a name="l08445"></a>08445 <span class="comment">     *</span>
<a name="l08446"></a>08446 <span class="comment">     * But, it&apos;s incorrect. Actual one takes and returned long. (see unistd.h)</span>
<a name="l08447"></a>08447 <span class="comment">     */</span>
<a name="l08448"></a>08448     <span class="keywordtype">long</span> num, retval = -1;
<a name="l08449"></a>08449 <span class="preprocessor">#else</span>
<a name="l08450"></a>08450 <span class="preprocessor"></span><span class="preprocessor"># define SYSCALL syscall</span>
<a name="l08451"></a>08451 <span class="preprocessor"></span><span class="preprocessor"># define NUM2SYSCALLID(x) NUM2INT(x)</span>
<a name="l08452"></a>08452 <span class="preprocessor"></span><span class="preprocessor"># define RETVAL2NUM(x) INT2NUM(x)</span>
<a name="l08453"></a>08453 <span class="preprocessor"></span>    <span class="keywordtype">int</span> num, retval = -1;
<a name="l08454"></a>08454 <span class="preprocessor">#endif</span>
<a name="l08455"></a>08455 <span class="preprocessor"></span>    <span class="keywordtype">int</span> i;
<a name="l08456"></a>08456 
<a name="l08457"></a>08457     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a56087d5316e4c73027105c023006cb15">ruby_verbose</a>)) {
<a name="l08458"></a>08458         <a class="code" href="../../db/dcc/error_8c.html#afd461c64916576849b159b21a26123da">rb_warning</a>(<span class="stringliteral">&quot;We plan to remove a syscall function at future release. DL(Fiddle) provides safer alternative.&quot;</span>);
<a name="l08459"></a>08459     }
<a name="l08460"></a>08460 
<a name="l08461"></a>08461     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a98b91af598acb64fe8497413ce498766">rb_secure</a>(2);
<a name="l08462"></a>08462     <span class="keywordflow">if</span> (argc == 0)
<a name="l08463"></a>08463         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;too few arguments for syscall&quot;</span>);
<a name="l08464"></a>08464     <span class="keywordflow">if</span> (argc &gt; <a class="code" href="../../dc/dcc/array_8c.html#a4ac8fee05a285361c33a2b0d9c2d555c">numberof</a>(arg))
<a name="l08465"></a>08465         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;too many arguments for syscall&quot;</span>);
<a name="l08466"></a>08466     num = NUM2SYSCALLID(argv[0]); ++argv;
<a name="l08467"></a>08467     <span class="keywordflow">for</span> (i = argc - 1; i--; ) {
<a name="l08468"></a>08468         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v = <a class="code" href="../../db/d2e/intern_8h.html#a669b6063704b2d304844bd1553217cf0">rb_check_string_type</a>(argv[i]);
<a name="l08469"></a>08469 
<a name="l08470"></a>08470         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v)) {
<a name="l08471"></a>08471             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0381640e2905c1b3e104194f91697ca4">SafeStringValue</a>(v);
<a name="l08472"></a>08472             <a class="code" href="../../db/d2e/intern_8h.html#a63a6d05687cf812131dce11743581b9d">rb_str_modify</a>(v);
<a name="l08473"></a>08473             arg[i] = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(v);
<a name="l08474"></a>08474         }
<a name="l08475"></a>08475         <span class="keywordflow">else</span> {
<a name="l08476"></a>08476             arg[i] = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(argv[i]);
<a name="l08477"></a>08477         }
<a name="l08478"></a>08478     }
<a name="l08479"></a>08479 
<a name="l08480"></a>08480     <span class="keywordflow">switch</span> (argc) {
<a name="l08481"></a>08481       <span class="keywordflow">case</span> 1:
<a name="l08482"></a>08482         retval = SYSCALL(num);
<a name="l08483"></a>08483         <span class="keywordflow">break</span>;
<a name="l08484"></a>08484       <span class="keywordflow">case</span> 2:
<a name="l08485"></a>08485         retval = SYSCALL(num, arg[0]);
<a name="l08486"></a>08486         <span class="keywordflow">break</span>;
<a name="l08487"></a>08487       <span class="keywordflow">case</span> 3:
<a name="l08488"></a>08488         retval = SYSCALL(num, arg[0],arg[1]);
<a name="l08489"></a>08489         <span class="keywordflow">break</span>;
<a name="l08490"></a>08490       <span class="keywordflow">case</span> 4:
<a name="l08491"></a>08491         retval = SYSCALL(num, arg[0],arg[1],arg[2]);
<a name="l08492"></a>08492         <span class="keywordflow">break</span>;
<a name="l08493"></a>08493       <span class="keywordflow">case</span> 5:
<a name="l08494"></a>08494         retval = SYSCALL(num, arg[0],arg[1],arg[2],arg[3]);
<a name="l08495"></a>08495         <span class="keywordflow">break</span>;
<a name="l08496"></a>08496       <span class="keywordflow">case</span> 6:
<a name="l08497"></a>08497         retval = SYSCALL(num, arg[0],arg[1],arg[2],arg[3],arg[4]);
<a name="l08498"></a>08498         <span class="keywordflow">break</span>;
<a name="l08499"></a>08499       <span class="keywordflow">case</span> 7:
<a name="l08500"></a>08500         retval = SYSCALL(num, arg[0],arg[1],arg[2],arg[3],arg[4],arg[5]);
<a name="l08501"></a>08501         <span class="keywordflow">break</span>;
<a name="l08502"></a>08502       <span class="keywordflow">case</span> 8:
<a name="l08503"></a>08503         retval = SYSCALL(num, arg[0],arg[1],arg[2],arg[3],arg[4],arg[5],arg[6]);
<a name="l08504"></a>08504         <span class="keywordflow">break</span>;
<a name="l08505"></a>08505 <span class="preprocessor">#ifdef atarist</span>
<a name="l08506"></a>08506 <span class="preprocessor"></span>      <span class="keywordflow">case</span> 9:
<a name="l08507"></a>08507         retval = SYSCALL(num, arg[0],arg[1],arg[2],arg[3],arg[4],arg[5],arg[6],
<a name="l08508"></a>08508           arg[7]);
<a name="l08509"></a>08509         <span class="keywordflow">break</span>;
<a name="l08510"></a>08510       <span class="keywordflow">case</span> 10:
<a name="l08511"></a>08511         retval = SYSCALL(num, arg[0],arg[1],arg[2],arg[3],arg[4],arg[5],arg[6],
<a name="l08512"></a>08512           arg[7], arg[8]);
<a name="l08513"></a>08513         <span class="keywordflow">break</span>;
<a name="l08514"></a>08514       <span class="keywordflow">case</span> 11:
<a name="l08515"></a>08515         retval = SYSCALL(num, arg[0],arg[1],arg[2],arg[3],arg[4],arg[5],arg[6],
<a name="l08516"></a>08516           arg[7], arg[8], arg[9]);
<a name="l08517"></a>08517         <span class="keywordflow">break</span>;
<a name="l08518"></a>08518       <span class="keywordflow">case</span> 12:
<a name="l08519"></a>08519         retval = SYSCALL(num, arg[0],arg[1],arg[2],arg[3],arg[4],arg[5],arg[6],
<a name="l08520"></a>08520           arg[7], arg[8], arg[9], arg[10]);
<a name="l08521"></a>08521         <span class="keywordflow">break</span>;
<a name="l08522"></a>08522       <span class="keywordflow">case</span> 13:
<a name="l08523"></a>08523         retval = SYSCALL(num, arg[0],arg[1],arg[2],arg[3],arg[4],arg[5],arg[6],
<a name="l08524"></a>08524           arg[7], arg[8], arg[9], arg[10], arg[11]);
<a name="l08525"></a>08525         <span class="keywordflow">break</span>;
<a name="l08526"></a>08526       <span class="keywordflow">case</span> 14:
<a name="l08527"></a>08527         retval = SYSCALL(num, arg[0],arg[1],arg[2],arg[3],arg[4],arg[5],arg[6],
<a name="l08528"></a>08528           arg[7], arg[8], arg[9], arg[10], arg[11], arg[12]);
<a name="l08529"></a>08529         <span class="keywordflow">break</span>;
<a name="l08530"></a>08530 <span class="preprocessor">#endif</span>
<a name="l08531"></a>08531 <span class="preprocessor"></span>    }
<a name="l08532"></a>08532 
<a name="l08533"></a>08533     <span class="keywordflow">if</span> (retval == -1)
<a name="l08534"></a>08534         <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l08535"></a>08535     <span class="keywordflow">return</span> RETVAL2NUM(retval);
<a name="l08536"></a>08536 <span class="preprocessor">#undef SYSCALL</span>
<a name="l08537"></a>08537 <span class="preprocessor"></span><span class="preprocessor">#undef NUM2SYSCALLID</span>
<a name="l08538"></a>08538 <span class="preprocessor"></span><span class="preprocessor">#undef RETVAL2NUM</span>
<a name="l08539"></a>08539 <span class="preprocessor"></span>}
<a name="l08540"></a>08540 <span class="preprocessor">#else</span>
<a name="l08541"></a><a class="code" href="../../df/d0a/io_8c.html#a3c2b7c028963b354af16cbba3e6a915b">08541</a> <span class="preprocessor"></span><span class="preprocessor">#define rb_f_syscall rb_f_notimplement</span>
<a name="l08542"></a>08542 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l08543"></a>08543 <span class="preprocessor"></span>
<a name="l08544"></a>08544 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08545"></a><a class="code" href="../../df/d0a/io_8c.html#abbdd4f0a24520eaaf3e5ebe30249d0c4">08545</a> <a class="code" href="../../df/d0a/io_8c.html#abbdd4f0a24520eaaf3e5ebe30249d0c4">io_new_instance</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d09/ripper_8y.html#a8187411843a6284ffb964ef3fb9fcab3">args</a>)
<a name="l08546"></a>08546 {
<a name="l08547"></a>08547     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a4e25a1a5ca0fc372179c4f429600bc2a">rb_class_new_instance</a>(2, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>*)args+1, *(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>*)args);
<a name="l08548"></a>08548 }
<a name="l08549"></a>08549 
<a name="l08550"></a>08550 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l08551"></a><a class="code" href="../../df/d0a/io_8c.html#a5a1a8cba1be8081b15952fa0945a1692">08551</a> <a class="code" href="../../df/d0a/io_8c.html#a5a1a8cba1be8081b15952fa0945a1692">io_encoding_set</a>(<a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v2, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opt)
<a name="l08552"></a>08552 {
<a name="l08553"></a>08553     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc, *enc2;
<a name="l08554"></a>08554     <span class="keywordtype">int</span> ecflags = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags;
<a name="l08555"></a>08555     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ecopts, tmp;
<a name="l08556"></a>08556 
<a name="l08557"></a>08557     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v2)) {
<a name="l08558"></a>08558         enc2 = <a class="code" href="../../d5/db5/encoding_8c.html#a73a17b842b857bdaf2062107fe898304">rb_to_encoding</a>(v1);
<a name="l08559"></a>08559         tmp = <a class="code" href="../../db/d2e/intern_8h.html#a669b6063704b2d304844bd1553217cf0">rb_check_string_type</a>(v2);
<a name="l08560"></a>08560         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(tmp)) {
<a name="l08561"></a>08561             <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(tmp) == 1 &amp;&amp; <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(tmp)[0] == <span class="charliteral">&apos;-&apos;</span>) {
<a name="l08562"></a>08562                 <span class="comment">/* Special case - &quot;-&quot; =&gt; no transcoding */</span>
<a name="l08563"></a>08563                 enc = enc2;
<a name="l08564"></a>08564                 enc2 = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l08565"></a>08565             }
<a name="l08566"></a>08566             <span class="keywordflow">else</span>
<a name="l08567"></a>08567                 enc = <a class="code" href="../../d5/db5/encoding_8c.html#a73a17b842b857bdaf2062107fe898304">rb_to_encoding</a>(v2);
<a name="l08568"></a>08568             <span class="keywordflow">if</span> (enc == enc2) {
<a name="l08569"></a>08569                 <span class="comment">/* Special case - &quot;-&quot; =&gt; no transcoding */</span>
<a name="l08570"></a>08570                 enc2 = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l08571"></a>08571             }
<a name="l08572"></a>08572         }
<a name="l08573"></a>08573         <span class="keywordflow">else</span>
<a name="l08574"></a>08574             enc = <a class="code" href="../../d5/db5/encoding_8c.html#a73a17b842b857bdaf2062107fe898304">rb_to_encoding</a>(v2);
<a name="l08575"></a>08575         <a class="code" href="../../df/d0a/io_8c.html#aed67cd777d990c58045b8877ed5c65fc">SET_UNIVERSAL_NEWLINE_DECORATOR_IF_ENC2</a>(enc2, ecflags);
<a name="l08576"></a>08576         ecflags = <a class="code" href="../../d5/de3/encoding_8h.html#a044a268a72d78b9e549136b55745af1d">rb_econv_prepare_options</a>(opt, &amp;ecopts, ecflags);
<a name="l08577"></a>08577     }
<a name="l08578"></a>08578     <span class="keywordflow">else</span> {
<a name="l08579"></a>08579         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v1)) {
<a name="l08580"></a>08580             <span class="comment">/* Set to default encodings */</span>
<a name="l08581"></a>08581             <a class="code" href="../../df/d0a/io_8c.html#a8dcac7969c25237c0f4620b5e074727a">rb_io_ext_int_to_encs</a>(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;enc, &amp;enc2);
<a name="l08582"></a>08582             <a class="code" href="../../df/d0a/io_8c.html#aed67cd777d990c58045b8877ed5c65fc">SET_UNIVERSAL_NEWLINE_DECORATOR_IF_ENC2</a>(enc2, ecflags);
<a name="l08583"></a>08583             ecopts = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l08584"></a>08584         }
<a name="l08585"></a>08585         <span class="keywordflow">else</span> {
<a name="l08586"></a>08586             tmp = <a class="code" href="../../db/d2e/intern_8h.html#a669b6063704b2d304844bd1553217cf0">rb_check_string_type</a>(v1);
<a name="l08587"></a>08587             <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(tmp) &amp;&amp; <a class="code" href="../../d5/de3/encoding_8h.html#a8b18a09a3055d3006c6d5baeaa6e7c72">rb_enc_asciicompat</a>(<a class="code" href="../../d5/db5/encoding_8c.html#ac21ed764f3b39453b6a848dd64a19585">rb_enc_get</a>(tmp))) {
<a name="l08588"></a>08588                 <a class="code" href="../../df/d0a/io_8c.html#a83cf2bfe6afeb749627027cf09e6c7d4">parse_mode_enc</a>(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(tmp), &amp;enc, &amp;enc2, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l08589"></a>08589                 <a class="code" href="../../df/d0a/io_8c.html#aed67cd777d990c58045b8877ed5c65fc">SET_UNIVERSAL_NEWLINE_DECORATOR_IF_ENC2</a>(enc2, ecflags);
<a name="l08590"></a>08590                 ecflags = <a class="code" href="../../d5/de3/encoding_8h.html#a044a268a72d78b9e549136b55745af1d">rb_econv_prepare_options</a>(opt, &amp;ecopts, ecflags);
<a name="l08591"></a>08591             }
<a name="l08592"></a>08592             <span class="keywordflow">else</span> {
<a name="l08593"></a>08593                 <a class="code" href="../../df/d0a/io_8c.html#a8dcac7969c25237c0f4620b5e074727a">rb_io_ext_int_to_encs</a>(<a class="code" href="../../d5/db5/encoding_8c.html#a73a17b842b857bdaf2062107fe898304">rb_to_encoding</a>(v1), <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;enc, &amp;enc2);
<a name="l08594"></a>08594                 <a class="code" href="../../df/d0a/io_8c.html#aed67cd777d990c58045b8877ed5c65fc">SET_UNIVERSAL_NEWLINE_DECORATOR_IF_ENC2</a>(enc2, ecflags);
<a name="l08595"></a>08595                 ecopts = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l08596"></a>08596             }
<a name="l08597"></a>08597         }
<a name="l08598"></a>08598     }
<a name="l08599"></a>08599     <a class="code" href="../../df/d0a/io_8c.html#aa9b7bb2abeafdd599f98d4b7db988f1b">validate_enc_binmode</a>(&amp;fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a>, ecflags, enc, enc2);
<a name="l08600"></a>08600     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc = enc;
<a name="l08601"></a>08601     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc2 = enc2;
<a name="l08602"></a>08602     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags = ecflags;
<a name="l08603"></a>08603     fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecopts = ecopts;
<a name="l08604"></a>08604     <a class="code" href="../../df/d0a/io_8c.html#a6a7e6fc03722338bbc29fc27ee59ea39">clear_codeconv</a>(fptr);
<a name="l08605"></a>08605 
<a name="l08606"></a>08606 }
<a name="l08607"></a>08607 
<a name="l08608"></a>08608 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08609"></a><a class="code" href="../../df/d0a/io_8c.html#a4b880cb51c08f3a6b226d431aa502a74">08609</a> <a class="code" href="../../df/d0a/io_8c.html#a4b880cb51c08f3a6b226d431aa502a74">pipe_pair_close</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> rw)
<a name="l08610"></a>08610 {
<a name="l08611"></a>08611     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *rwp = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *)rw;
<a name="l08612"></a>08612     <span class="keywordflow">return</span> <a class="code" href="../../d3/d57/eval_8c.html#a8061198378fb16adeb931f90540b2839">rb_ensure</a>(<a class="code" href="../../df/d0a/io_8c.html#a7816bea23b5170be49ecb1a7ff8aafcf">io_close</a>, rwp[0], <a class="code" href="../../df/d0a/io_8c.html#a7816bea23b5170be49ecb1a7ff8aafcf">io_close</a>, rwp[1]);
<a name="l08613"></a>08613 }
<a name="l08614"></a>08614 
<a name="l08615"></a>08615 <span class="comment">/*</span>
<a name="l08616"></a>08616 <span class="comment"> *  call-seq:</span>
<a name="l08617"></a>08617 <span class="comment"> *     IO.pipe                             -&gt;  [read_io, write_io]</span>
<a name="l08618"></a>08618 <span class="comment"> *     IO.pipe(ext_enc)                    -&gt;  [read_io, write_io]</span>
<a name="l08619"></a>08619 <span class="comment"> *     IO.pipe(&quot;ext_enc:int_enc&quot; [, opt])  -&gt;  [read_io, write_io]</span>
<a name="l08620"></a>08620 <span class="comment"> *     IO.pipe(ext_enc, int_enc [, opt])   -&gt;  [read_io, write_io]</span>
<a name="l08621"></a>08621 <span class="comment"> *</span>
<a name="l08622"></a>08622 <span class="comment"> *     IO.pipe(...) {|read_io, write_io| ... }</span>
<a name="l08623"></a>08623 <span class="comment"> *</span>
<a name="l08624"></a>08624 <span class="comment"> *  Creates a pair of pipe endpoints (connected to each other) and</span>
<a name="l08625"></a>08625 <span class="comment"> *  returns them as a two-element array of &lt;code&gt;IO&lt;/code&gt; objects:</span>
<a name="l08626"></a>08626 <span class="comment"> *  &lt;code&gt;[&lt;/code&gt; &lt;i&gt;read_io&lt;/i&gt;, &lt;i&gt;write_io&lt;/i&gt; &lt;code&gt;]&lt;/code&gt;.</span>
<a name="l08627"></a>08627 <span class="comment"> *</span>
<a name="l08628"></a>08628 <span class="comment"> *  If a block is given, the block is called and</span>
<a name="l08629"></a>08629 <span class="comment"> *  returns the value of the block.</span>
<a name="l08630"></a>08630 <span class="comment"> *  &lt;i&gt;read_io&lt;/i&gt; and &lt;i&gt;write_io&lt;/i&gt; are sent to the block as arguments.</span>
<a name="l08631"></a>08631 <span class="comment"> *  If read_io and write_io are not closed when the block exits, they are closed.</span>
<a name="l08632"></a>08632 <span class="comment"> *  i.e. closing read_io and/or write_io doesn&apos;t cause an error.</span>
<a name="l08633"></a>08633 <span class="comment"> *</span>
<a name="l08634"></a>08634 <span class="comment"> *  Not available on all platforms.</span>
<a name="l08635"></a>08635 <span class="comment"> *</span>
<a name="l08636"></a>08636 <span class="comment"> *  If an encoding (encoding name or encoding object) is specified as an optional argument,</span>
<a name="l08637"></a>08637 <span class="comment"> *  read string from pipe is tagged with the encoding specified.</span>
<a name="l08638"></a>08638 <span class="comment"> *  If the argument is a colon separated two encoding names &quot;A:B&quot;,</span>
<a name="l08639"></a>08639 <span class="comment"> *  the read string is converted from encoding A (external encoding)</span>
<a name="l08640"></a>08640 <span class="comment"> *  to encoding B (internal encoding), then tagged with B.</span>
<a name="l08641"></a>08641 <span class="comment"> *  If two optional arguments are specified, those must be</span>
<a name="l08642"></a>08642 <span class="comment"> *  encoding objects or encoding names,</span>
<a name="l08643"></a>08643 <span class="comment"> *  and the first one is the external encoding,</span>
<a name="l08644"></a>08644 <span class="comment"> *  and the second one is the internal encoding.</span>
<a name="l08645"></a>08645 <span class="comment"> *  If the external encoding and the internal encoding is specified,</span>
<a name="l08646"></a>08646 <span class="comment"> *  optional hash argument specify the conversion option.</span>
<a name="l08647"></a>08647 <span class="comment"> *</span>
<a name="l08648"></a>08648 <span class="comment"> *  In the example below, the two processes close the ends of the pipe</span>
<a name="l08649"></a>08649 <span class="comment"> *  that they are not using. This is not just a cosmetic nicety. The</span>
<a name="l08650"></a>08650 <span class="comment"> *  read end of a pipe will not generate an end of file condition if</span>
<a name="l08651"></a>08651 <span class="comment"> *  there are any writers with the pipe still open. In the case of the</span>
<a name="l08652"></a>08652 <span class="comment"> *  parent process, the &lt;code&gt;rd.read&lt;/code&gt; will never return if it</span>
<a name="l08653"></a>08653 <span class="comment"> *  does not first issue a &lt;code&gt;wr.close&lt;/code&gt;.</span>
<a name="l08654"></a>08654 <span class="comment"> *</span>
<a name="l08655"></a>08655 <span class="comment"> *     rd, wr = IO.pipe</span>
<a name="l08656"></a>08656 <span class="comment"> *</span>
<a name="l08657"></a>08657 <span class="comment"> *     if fork</span>
<a name="l08658"></a>08658 <span class="comment"> *       wr.close</span>
<a name="l08659"></a>08659 <span class="comment"> *       puts &quot;Parent got: &lt;#{rd.read}&gt;&quot;</span>
<a name="l08660"></a>08660 <span class="comment"> *       rd.close</span>
<a name="l08661"></a>08661 <span class="comment"> *       Process.wait</span>
<a name="l08662"></a>08662 <span class="comment"> *     else</span>
<a name="l08663"></a>08663 <span class="comment"> *       rd.close</span>
<a name="l08664"></a>08664 <span class="comment"> *       puts &quot;Sending message to parent&quot;</span>
<a name="l08665"></a>08665 <span class="comment"> *       wr.write &quot;Hi Dad&quot;</span>
<a name="l08666"></a>08666 <span class="comment"> *       wr.close</span>
<a name="l08667"></a>08667 <span class="comment"> *     end</span>
<a name="l08668"></a>08668 <span class="comment"> *</span>
<a name="l08669"></a>08669 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l08670"></a>08670 <span class="comment"> *</span>
<a name="l08671"></a>08671 <span class="comment"> *     Sending message to parent</span>
<a name="l08672"></a>08672 <span class="comment"> *     Parent got: &lt;Hi Dad&gt;</span>
<a name="l08673"></a>08673 <span class="comment"> */</span>
<a name="l08674"></a>08674 
<a name="l08675"></a>08675 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08676"></a><a class="code" href="../../df/d0a/io_8c.html#a0a63a0eca24701df132b146a9b88aebc">08676</a> <a class="code" href="../../df/d0a/io_8c.html#a0a63a0eca24701df132b146a9b88aebc">rb_io_s_pipe</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass)
<a name="l08677"></a>08677 {
<a name="l08678"></a>08678     <span class="keywordtype">int</span> pipes[2], <a class="code" href="../../d5/d1d/gb18030_8c.html#adc6e5733fc3c22f0a7b2914188c49c90">state</a>;
<a name="l08679"></a>08679     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> r, w, <a class="code" href="../../d3/d09/ripper_8y.html#a8187411843a6284ffb964ef3fb9fcab3">args</a>[3], v1, v2;
<a name="l08680"></a>08680     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opt;
<a name="l08681"></a>08681     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr, *fptr2;
<a name="l08682"></a>08682     <span class="keywordtype">int</span> <a class="code" href="../../df/d0a/io_8c.html#a8d9cc2340b814767e83294570cafa7fd">fmode</a> = 0;
<a name="l08683"></a>08683     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ret;
<a name="l08684"></a>08684 
<a name="l08685"></a>08685     argc = <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;02:&quot;</span>, &amp;v1, &amp;v2, &amp;opt);
<a name="l08686"></a>08686     <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#abbfdd28892be7ef48b8c7f4fba55cbe4">rb_pipe</a>(pipes) == -1)
<a name="l08687"></a>08687         <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l08688"></a>08688 
<a name="l08689"></a>08689     args[0] = klass;
<a name="l08690"></a>08690     args[1] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(pipes[0]);
<a name="l08691"></a>08691     args[2] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(O_RDONLY);
<a name="l08692"></a>08692     r = <a class="code" href="../../d3/d57/eval_8c.html#a6aa7fb1169ed41978a16375b6f921b0e">rb_protect</a>(<a class="code" href="../../df/d0a/io_8c.html#abbdd4f0a24520eaaf3e5ebe30249d0c4">io_new_instance</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)args, &amp;state);
<a name="l08693"></a>08693     <span class="keywordflow">if</span> (state) {
<a name="l08694"></a>08694         close(pipes[0]);
<a name="l08695"></a>08695         close(pipes[1]);
<a name="l08696"></a>08696         <a class="code" href="../../d3/d57/eval_8c.html#ae48d70c45901eab8b89fb181fc9d1f3b">rb_jump_tag</a>(state);
<a name="l08697"></a>08697     }
<a name="l08698"></a>08698     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(r, fptr);
<a name="l08699"></a>08699     <a class="code" href="../../df/d0a/io_8c.html#a5a1a8cba1be8081b15952fa0945a1692">io_encoding_set</a>(fptr, v1, v2, opt);
<a name="l08700"></a>08700     args[1] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(pipes[1]);
<a name="l08701"></a>08701     args[2] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(O_WRONLY);
<a name="l08702"></a>08702     w = <a class="code" href="../../d3/d57/eval_8c.html#a6aa7fb1169ed41978a16375b6f921b0e">rb_protect</a>(<a class="code" href="../../df/d0a/io_8c.html#abbdd4f0a24520eaaf3e5ebe30249d0c4">io_new_instance</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)args, &amp;state);
<a name="l08703"></a>08703     <span class="keywordflow">if</span> (state) {
<a name="l08704"></a>08704         close(pipes[1]);
<a name="l08705"></a>08705         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(r)) <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>(r);
<a name="l08706"></a>08706         <a class="code" href="../../d3/d57/eval_8c.html#ae48d70c45901eab8b89fb181fc9d1f3b">rb_jump_tag</a>(state);
<a name="l08707"></a>08707     }
<a name="l08708"></a>08708     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(w, fptr2);
<a name="l08709"></a>08709     <a class="code" href="../../dc/dac/io_8h.html#aeb14fb21179cb04f2a87dec384f8236b">rb_io_synchronized</a>(fptr2);
<a name="l08710"></a>08710 
<a name="l08711"></a>08711     <a class="code" href="../../df/d0a/io_8c.html#a0f1670258d74dfbb4562e6ab4e6e7118">extract_binmode</a>(opt, &amp;fmode);
<a name="l08712"></a>08712 <span class="preprocessor">#if DEFAULT_TEXTMODE</span>
<a name="l08713"></a>08713 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#aaf5edfb63656cca0368d0de8324015c1">FMODE_TEXTMODE</a>) &amp;&amp; (fmode &amp; <a class="code" href="../../dc/dac/io_8h.html#a7bd9a8d38431a018c8de1edd5829e14f">FMODE_BINMODE</a>)) {
<a name="l08714"></a>08714         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp;= ~<a class="code" href="../../dc/dac/io_8h.html#aaf5edfb63656cca0368d0de8324015c1">FMODE_TEXTMODE</a>;
<a name="l08715"></a>08715         setmode(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>);
<a name="l08716"></a>08716     }
<a name="l08717"></a>08717 <span class="preprocessor">#if defined(RUBY_TEST_CRLF_ENVIRONMENT) || defined(_WIN32)</span>
<a name="l08718"></a>08718 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#afae8969f13c765a2a96d810d7049543a">ECONV_DEFAULT_NEWLINE_DECORATOR</a>) {
<a name="l08719"></a>08719         fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.ecflags |= <a class="code" href="../../d5/de3/encoding_8h.html#a122d5f3118774ae1a01a3262c73141eb">ECONV_UNIVERSAL_NEWLINE_DECORATOR</a>;
<a name="l08720"></a>08720     }
<a name="l08721"></a>08721 <span class="preprocessor">#endif</span>
<a name="l08722"></a>08722 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l08723"></a>08723 <span class="preprocessor"></span>    fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> |= fmode;
<a name="l08724"></a>08724 <span class="preprocessor">#if DEFAULT_TEXTMODE</span>
<a name="l08725"></a>08725 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((fptr2-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#aaf5edfb63656cca0368d0de8324015c1">FMODE_TEXTMODE</a>) &amp;&amp; (fmode &amp; FMODE_BINMODE)) {
<a name="l08726"></a>08726         fptr2-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp;= ~<a class="code" href="../../dc/dac/io_8h.html#aaf5edfb63656cca0368d0de8324015c1">FMODE_TEXTMODE</a>;
<a name="l08727"></a>08727         setmode(fptr2-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>, <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>);
<a name="l08728"></a>08728     }
<a name="l08729"></a>08729 <span class="preprocessor">#endif</span>
<a name="l08730"></a>08730 <span class="preprocessor"></span>    fptr2-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> |= fmode;
<a name="l08731"></a>08731 
<a name="l08732"></a>08732     ret = <a class="code" href="../../dc/dcc/array_8c.html#af3085ceab406e3f4f4b90f383c440d6a">rb_assoc_new</a>(r, w);
<a name="l08733"></a>08733     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d57/eval_8c.html#aea346c4eb8bc06df88422e956bb05fec">rb_block_given_p</a>()) {
<a name="l08734"></a>08734         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> rw[2];
<a name="l08735"></a>08735         rw[0] = r;
<a name="l08736"></a>08736         rw[1] = w;
<a name="l08737"></a>08737         <span class="keywordflow">return</span> <a class="code" href="../../d3/d57/eval_8c.html#a8061198378fb16adeb931f90540b2839">rb_ensure</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae6bd0c4ea4db971ebd569ca8f05c6b4a">rb_yield</a>, ret, <a class="code" href="../../df/d0a/io_8c.html#a4b880cb51c08f3a6b226d431aa502a74">pipe_pair_close</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)rw);
<a name="l08738"></a>08738     }
<a name="l08739"></a>08739     <span class="keywordflow">return</span> ret;
<a name="l08740"></a>08740 }
<a name="l08741"></a>08741 
<a name="l08742"></a><a class="code" href="../../df/d24/structforeach__arg.html">08742</a> <span class="keyword">struct </span><a class="code" href="../../df/d24/structforeach__arg.html">foreach_arg</a> {
<a name="l08743"></a><a class="code" href="../../df/d24/structforeach__arg.html#a82b95a5e5f4cc6bd6c2db3f296eebd09">08743</a>     <span class="keywordtype">int</span> <a class="code" href="../../df/d24/structforeach__arg.html#a82b95a5e5f4cc6bd6c2db3f296eebd09">argc</a>;
<a name="l08744"></a><a class="code" href="../../df/d24/structforeach__arg.html#a7007ee143ebe081ccc12769a70cf34bd">08744</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d24/structforeach__arg.html#a7007ee143ebe081ccc12769a70cf34bd">argv</a>;
<a name="l08745"></a><a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">08745</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io;
<a name="l08746"></a>08746 };
<a name="l08747"></a>08747 
<a name="l08748"></a>08748 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l08749"></a><a class="code" href="../../df/d0a/io_8c.html#a122517ae79eb9ffb55e8de983d88b936">08749</a> <a class="code" href="../../df/d0a/io_8c.html#a122517ae79eb9ffb55e8de983d88b936">open_key_args</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opt, <span class="keyword">struct</span> <a class="code" href="../../df/d24/structforeach__arg.html">foreach_arg</a> *arg)
<a name="l08750"></a>08750 {
<a name="l08751"></a>08751     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> path, v;
<a name="l08752"></a>08752 
<a name="l08753"></a>08753     path = *argv++;
<a name="l08754"></a>08754     argc--;
<a name="l08755"></a>08755     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a66b35e3e022b499db72f5df63bb1d358">FilePathValue</a>(path);
<a name="l08756"></a>08756     arg-&gt;<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a> = 0;
<a name="l08757"></a>08757     arg-&gt;<a class="code" href="../../df/d24/structforeach__arg.html#a82b95a5e5f4cc6bd6c2db3f296eebd09">argc</a> = argc;
<a name="l08758"></a>08758     arg-&gt;<a class="code" href="../../df/d24/structforeach__arg.html#a7007ee143ebe081ccc12769a70cf34bd">argv</a> = argv;
<a name="l08759"></a>08759     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(opt)) {
<a name="l08760"></a>08760         arg-&gt;<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a> = <a class="code" href="../../df/d0a/io_8c.html#ad3a0800448e149c31b1adc110bf94fc6">rb_io_open</a>(path, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(O_RDONLY), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0666), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l08761"></a>08761         <span class="keywordflow">return</span>;
<a name="l08762"></a>08762     }
<a name="l08763"></a>08763     v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opt, <a class="code" href="../../df/d0a/io_8c.html#aa4c5f56edec4d64183c04d42acbdef60">sym_open_args</a>);
<a name="l08764"></a>08764     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v)) {
<a name="l08765"></a>08765         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d09/ripper_8y.html#a8187411843a6284ffb964ef3fb9fcab3">args</a>;
<a name="l08766"></a>08766         <span class="keywordtype">long</span> n;
<a name="l08767"></a>08767 
<a name="l08768"></a>08768         v = <a class="code" href="../../db/d2e/intern_8h.html#a692c7c3caf5cdcf40d3812136f757fb5">rb_convert_type</a>(v, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a>, <span class="stringliteral">&quot;Array&quot;</span>, <span class="stringliteral">&quot;to_ary&quot;</span>);
<a name="l08769"></a>08769         n = <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(v) + 1;
<a name="l08770"></a>08770 <span class="preprocessor">#if SIZEOF_LONG &gt; SIZEOF_INT</span>
<a name="l08771"></a>08771 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (n &gt; INT_MAX) {
<a name="l08772"></a>08772             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;too many arguments&quot;</span>);
<a name="l08773"></a>08773         }
<a name="l08774"></a>08774 <span class="preprocessor">#endif</span>
<a name="l08775"></a>08775 <span class="preprocessor"></span>        args = <a class="code" href="../../dc/dcc/array_8c.html#aaf7e3ca42191580b60f398d5ec466766">rb_ary_tmp_new</a>(n);
<a name="l08776"></a>08776         <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(args, path);
<a name="l08777"></a>08777         <a class="code" href="../../dc/dcc/array_8c.html#a9569be4d3661f4ce54bf56b12a2d98a8">rb_ary_concat</a>(args, v);
<a name="l08778"></a>08778         arg-&gt;<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a> = <a class="code" href="../../df/d0a/io_8c.html#a9c8dcf11db3bf78262fdf7e7f8635c06">rb_io_open_with_args</a>((<span class="keywordtype">int</span>)n, <a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(args));
<a name="l08779"></a>08779         <a class="code" href="../../dc/dcc/array_8c.html#aaf8c74d0eef61073fadf2c631fa9540f">rb_ary_clear</a>(args);     <span class="comment">/* prevent from GC */</span>
<a name="l08780"></a>08780         <span class="keywordflow">return</span>;
<a name="l08781"></a>08781     }
<a name="l08782"></a>08782     arg-&gt;<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a> = <a class="code" href="../../df/d0a/io_8c.html#ad3a0800448e149c31b1adc110bf94fc6">rb_io_open</a>(path, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>, opt);
<a name="l08783"></a>08783 }
<a name="l08784"></a>08784 
<a name="l08785"></a>08785 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08786"></a><a class="code" href="../../df/d0a/io_8c.html#a6219c56483cc70ba7f2abbfe87c0c1d7">08786</a> <a class="code" href="../../df/d0a/io_8c.html#a6219c56483cc70ba7f2abbfe87c0c1d7">io_s_foreach</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d24/structforeach__arg.html">foreach_arg</a> *arg)
<a name="l08787"></a>08787 {
<a name="l08788"></a>08788     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str;
<a name="l08789"></a>08789 
<a name="l08790"></a>08790     <span class="keywordflow">while</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str = <a class="code" href="../../df/d0a/io_8c.html#a82aa0c7d60448d8caca4fccd7ced8e3f">rb_io_gets_m</a>(arg-&gt;<a class="code" href="../../df/d24/structforeach__arg.html#a82b95a5e5f4cc6bd6c2db3f296eebd09">argc</a>, arg-&gt;<a class="code" href="../../df/d24/structforeach__arg.html#a7007ee143ebe081ccc12769a70cf34bd">argv</a>, arg-&gt;<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a>))) {
<a name="l08791"></a>08791         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae6bd0c4ea4db971ebd569ca8f05c6b4a">rb_yield</a>(str);
<a name="l08792"></a>08792     }
<a name="l08793"></a>08793     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l08794"></a>08794 }
<a name="l08795"></a>08795 
<a name="l08796"></a>08796 <span class="comment">/*</span>
<a name="l08797"></a>08797 <span class="comment"> *  call-seq:</span>
<a name="l08798"></a>08798 <span class="comment"> *     IO.foreach(name, sep=$/ [, open_args]) {|line| block }     -&gt; nil</span>
<a name="l08799"></a>08799 <span class="comment"> *     IO.foreach(name, limit [, open_args]) {|line| block }      -&gt; nil</span>
<a name="l08800"></a>08800 <span class="comment"> *     IO.foreach(name, sep, limit [, open_args]) {|line| block } -&gt; nil</span>
<a name="l08801"></a>08801 <span class="comment"> *     IO.foreach(...)                                            -&gt; an_enumerator</span>
<a name="l08802"></a>08802 <span class="comment"> *</span>
<a name="l08803"></a>08803 <span class="comment"> *  Executes the block for every line in the named I/O port, where lines</span>
<a name="l08804"></a>08804 <span class="comment"> *  are separated by &lt;em&gt;sep&lt;/em&gt;.</span>
<a name="l08805"></a>08805 <span class="comment"> *</span>
<a name="l08806"></a>08806 <span class="comment"> *  If no block is given, an enumerator is returned instead.</span>
<a name="l08807"></a>08807 <span class="comment"> *</span>
<a name="l08808"></a>08808 <span class="comment"> *     IO.foreach(&quot;testfile&quot;) {|x| print &quot;GOT &quot;, x }</span>
<a name="l08809"></a>08809 <span class="comment"> *</span>
<a name="l08810"></a>08810 <span class="comment"> *  &lt;em&gt;produces:&lt;/em&gt;</span>
<a name="l08811"></a>08811 <span class="comment"> *</span>
<a name="l08812"></a>08812 <span class="comment"> *     GOT This is line one</span>
<a name="l08813"></a>08813 <span class="comment"> *     GOT This is line two</span>
<a name="l08814"></a>08814 <span class="comment"> *     GOT This is line three</span>
<a name="l08815"></a>08815 <span class="comment"> *     GOT And so on...</span>
<a name="l08816"></a>08816 <span class="comment"> *</span>
<a name="l08817"></a>08817 <span class="comment"> *  If the last argument is a hash, it&apos;s the keyword argument to open.</span>
<a name="l08818"></a>08818 <span class="comment"> *  See &lt;code&gt;IO.read&lt;/code&gt; for detail.</span>
<a name="l08819"></a>08819 <span class="comment"> *</span>
<a name="l08820"></a>08820 <span class="comment"> */</span>
<a name="l08821"></a>08821 
<a name="l08822"></a>08822 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08823"></a><a class="code" href="../../df/d0a/io_8c.html#a0a29684a634384a06813d4cb240bf75f">08823</a> <a class="code" href="../../df/d0a/io_8c.html#a0a29684a634384a06813d4cb240bf75f">rb_io_s_foreach</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l08824"></a>08824 {
<a name="l08825"></a>08825     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opt;
<a name="l08826"></a>08826     <span class="keywordtype">int</span> orig_argc = argc;
<a name="l08827"></a>08827     <span class="keyword">struct </span><a class="code" href="../../df/d24/structforeach__arg.html">foreach_arg</a> arg;
<a name="l08828"></a>08828 
<a name="l08829"></a>08829     argc = <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;13:&quot;</span>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;opt);
<a name="l08830"></a>08830     <a class="code" href="../../db/d2e/intern_8h.html#ad174dd963d99ac27a67c8ef9cfa1eb58">RETURN_ENUMERATOR</a>(<span class="keyword">self</span>, orig_argc, argv);
<a name="l08831"></a>08831     <a class="code" href="../../df/d0a/io_8c.html#a122517ae79eb9ffb55e8de983d88b936">open_key_args</a>(argc, argv, opt, &amp;arg);
<a name="l08832"></a>08832     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(arg.<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a>)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l08833"></a>08833     <span class="keywordflow">return</span> <a class="code" href="../../d3/d57/eval_8c.html#a8061198378fb16adeb931f90540b2839">rb_ensure</a>(<a class="code" href="../../df/d0a/io_8c.html#a6219c56483cc70ba7f2abbfe87c0c1d7">io_s_foreach</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;arg, <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>, arg.io);
<a name="l08834"></a>08834 }
<a name="l08835"></a>08835 
<a name="l08836"></a>08836 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08837"></a><a class="code" href="../../df/d0a/io_8c.html#a16e834abc5c946d9a706f0c069d4b933">08837</a> <a class="code" href="../../df/d0a/io_8c.html#a16e834abc5c946d9a706f0c069d4b933">io_s_readlines</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d24/structforeach__arg.html">foreach_arg</a> *arg)
<a name="l08838"></a>08838 {
<a name="l08839"></a>08839     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#aedb3b02ed530d801262cea5cac06e1a9">rb_io_readlines</a>(arg-&gt;<a class="code" href="../../df/d24/structforeach__arg.html#a82b95a5e5f4cc6bd6c2db3f296eebd09">argc</a>, arg-&gt;<a class="code" href="../../df/d24/structforeach__arg.html#a7007ee143ebe081ccc12769a70cf34bd">argv</a>, arg-&gt;<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a>);
<a name="l08840"></a>08840 }
<a name="l08841"></a>08841 
<a name="l08842"></a>08842 <span class="comment">/*</span>
<a name="l08843"></a>08843 <span class="comment"> *  call-seq:</span>
<a name="l08844"></a>08844 <span class="comment"> *     IO.readlines(name, sep=$/ [, open_args])     -&gt; array</span>
<a name="l08845"></a>08845 <span class="comment"> *     IO.readlines(name, limit [, open_args])      -&gt; array</span>
<a name="l08846"></a>08846 <span class="comment"> *     IO.readlines(name, sep, limit [, open_args]) -&gt; array</span>
<a name="l08847"></a>08847 <span class="comment"> *</span>
<a name="l08848"></a>08848 <span class="comment"> *  Reads the entire file specified by &lt;i&gt;name&lt;/i&gt; as individual</span>
<a name="l08849"></a>08849 <span class="comment"> *  lines, and returns those lines in an array. Lines are separated by</span>
<a name="l08850"></a>08850 <span class="comment"> *  &lt;i&gt;sep&lt;/i&gt;.</span>
<a name="l08851"></a>08851 <span class="comment"> *</span>
<a name="l08852"></a>08852 <span class="comment"> *     a = IO.readlines(&quot;testfile&quot;)</span>
<a name="l08853"></a>08853 <span class="comment"> *     a[0]   #=&gt; &quot;This is line one\n&quot;</span>
<a name="l08854"></a>08854 <span class="comment"> *</span>
<a name="l08855"></a>08855 <span class="comment"> *  If the last argument is a hash, it&apos;s the keyword argument to open.</span>
<a name="l08856"></a>08856 <span class="comment"> *  See &lt;code&gt;IO.read&lt;/code&gt; for detail.</span>
<a name="l08857"></a>08857 <span class="comment"> *</span>
<a name="l08858"></a>08858 <span class="comment"> */</span>
<a name="l08859"></a>08859 
<a name="l08860"></a>08860 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08861"></a><a class="code" href="../../df/d0a/io_8c.html#a35d73ca8a9a83aa9c12344598656078b">08861</a> <a class="code" href="../../df/d0a/io_8c.html#a35d73ca8a9a83aa9c12344598656078b">rb_io_s_readlines</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l08862"></a>08862 {
<a name="l08863"></a>08863     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opt;
<a name="l08864"></a>08864     <span class="keyword">struct </span><a class="code" href="../../df/d24/structforeach__arg.html">foreach_arg</a> arg;
<a name="l08865"></a>08865 
<a name="l08866"></a>08866     argc = <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;13:&quot;</span>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;opt);
<a name="l08867"></a>08867     <a class="code" href="../../df/d0a/io_8c.html#a122517ae79eb9ffb55e8de983d88b936">open_key_args</a>(argc, argv, opt, &amp;arg);
<a name="l08868"></a>08868     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(arg.<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a>)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l08869"></a>08869     <span class="keywordflow">return</span> <a class="code" href="../../d3/d57/eval_8c.html#a8061198378fb16adeb931f90540b2839">rb_ensure</a>(<a class="code" href="../../df/d0a/io_8c.html#a16e834abc5c946d9a706f0c069d4b933">io_s_readlines</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;arg, <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>, arg.io);
<a name="l08870"></a>08870 }
<a name="l08871"></a>08871 
<a name="l08872"></a>08872 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08873"></a><a class="code" href="../../df/d0a/io_8c.html#ad71a85012a41df9928a0e67483aa0b7d">08873</a> <a class="code" href="../../df/d0a/io_8c.html#ad71a85012a41df9928a0e67483aa0b7d">io_s_read</a>(<span class="keyword">struct</span> <a class="code" href="../../df/d24/structforeach__arg.html">foreach_arg</a> *arg)
<a name="l08874"></a>08874 {
<a name="l08875"></a>08875     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#aabba878d4b639aa789e090114d1023f9">io_read</a>(arg-&gt;<a class="code" href="../../df/d24/structforeach__arg.html#a82b95a5e5f4cc6bd6c2db3f296eebd09">argc</a>, arg-&gt;<a class="code" href="../../df/d24/structforeach__arg.html#a7007ee143ebe081ccc12769a70cf34bd">argv</a>, arg-&gt;<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a>);
<a name="l08876"></a>08876 }
<a name="l08877"></a>08877 
<a name="l08878"></a><a class="code" href="../../d2/d0a/structseek__arg.html">08878</a> <span class="keyword">struct </span><a class="code" href="../../d2/d0a/structseek__arg.html">seek_arg</a> {
<a name="l08879"></a><a class="code" href="../../d2/d0a/structseek__arg.html#a0562595cadce6b2f841ff3460744e7b3">08879</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io;
<a name="l08880"></a><a class="code" href="../../d2/d0a/structseek__arg.html#aea7b23ca507a8349c8ae58eecd51592c">08880</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> offset;
<a name="l08881"></a><a class="code" href="../../d2/d0a/structseek__arg.html#a949bd95b090dcaba81557a831705f192">08881</a>     <span class="keywordtype">int</span> <a class="code" href="../../d2/d0a/structseek__arg.html#a949bd95b090dcaba81557a831705f192">mode</a>;
<a name="l08882"></a>08882 };
<a name="l08883"></a>08883 
<a name="l08884"></a>08884 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08885"></a><a class="code" href="../../df/d0a/io_8c.html#a54f1dd60cb028b38f2ba2b912652d510">08885</a> <a class="code" href="../../df/d0a/io_8c.html#a54f1dd60cb028b38f2ba2b912652d510">seek_before_access</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> argp)
<a name="l08886"></a>08886 {
<a name="l08887"></a>08887     <span class="keyword">struct </span><a class="code" href="../../d2/d0a/structseek__arg.html">seek_arg</a> *arg = (<span class="keyword">struct </span><a class="code" href="../../d2/d0a/structseek__arg.html">seek_arg</a> *)argp;
<a name="l08888"></a>08888     <a class="code" href="../../db/d2e/intern_8h.html#adb93518ea7f5fdcf897359c214c03254">rb_io_binmode</a>(arg-&gt;<a class="code" href="../../d2/d0a/structseek__arg.html#a0562595cadce6b2f841ff3460744e7b3">io</a>);
<a name="l08889"></a>08889     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a7de72531da99cf086e643d54f60d21c6">rb_io_seek</a>(arg-&gt;<a class="code" href="../../d2/d0a/structseek__arg.html#a0562595cadce6b2f841ff3460744e7b3">io</a>, arg-&gt;<a class="code" href="../../d2/d0a/structseek__arg.html#aea7b23ca507a8349c8ae58eecd51592c">offset</a>, arg-&gt;<a class="code" href="../../d2/d0a/structseek__arg.html#a949bd95b090dcaba81557a831705f192">mode</a>);
<a name="l08890"></a>08890 }
<a name="l08891"></a>08891 
<a name="l08892"></a>08892 <span class="comment">/*</span>
<a name="l08893"></a>08893 <span class="comment"> *  call-seq:</span>
<a name="l08894"></a>08894 <span class="comment"> *     IO.read(name, [length [, offset]] )   -&gt; string</span>
<a name="l08895"></a>08895 <span class="comment"> *     IO.read(name, [length [, offset]], open_args)   -&gt; string</span>
<a name="l08896"></a>08896 <span class="comment"> *</span>
<a name="l08897"></a>08897 <span class="comment"> *  Opens the file, optionally seeks to the given &lt;i&gt;offset&lt;/i&gt;, then returns</span>
<a name="l08898"></a>08898 <span class="comment"> *  &lt;i&gt;length&lt;/i&gt; bytes (defaulting to the rest of the file).</span>
<a name="l08899"></a>08899 <span class="comment"> *  &lt;code&gt;read&lt;/code&gt; ensures the file is closed before returning.</span>
<a name="l08900"></a>08900 <span class="comment"> *</span>
<a name="l08901"></a>08901 <span class="comment"> *  If the last argument is a hash, it specifies option for internal</span>
<a name="l08902"></a>08902 <span class="comment"> *  open().  The key would be the following.  open_args: is exclusive</span>
<a name="l08903"></a>08903 <span class="comment"> *  to others.</span>
<a name="l08904"></a>08904 <span class="comment"> *</span>
<a name="l08905"></a>08905 <span class="comment"> *   encoding: string or encoding</span>
<a name="l08906"></a>08906 <span class="comment"> *</span>
<a name="l08907"></a>08907 <span class="comment"> *    specifies encoding of the read string.  encoding will be ignored</span>
<a name="l08908"></a>08908 <span class="comment"> *    if length is specified.</span>
<a name="l08909"></a>08909 <span class="comment"> *</span>
<a name="l08910"></a>08910 <span class="comment"> *   mode: string</span>
<a name="l08911"></a>08911 <span class="comment"> *</span>
<a name="l08912"></a>08912 <span class="comment"> *    specifies mode argument for open().  it should start with &quot;r&quot;</span>
<a name="l08913"></a>08913 <span class="comment"> *    otherwise it would cause error.</span>
<a name="l08914"></a>08914 <span class="comment"> *</span>
<a name="l08915"></a>08915 <span class="comment"> *   open_args: array of strings</span>
<a name="l08916"></a>08916 <span class="comment"> *</span>
<a name="l08917"></a>08917 <span class="comment"> *    specifies arguments for open() as an array.</span>
<a name="l08918"></a>08918 <span class="comment"> *</span>
<a name="l08919"></a>08919 <span class="comment"> *     IO.read(&quot;testfile&quot;)           #=&gt; &quot;This is line one\nThis is line two\nThis is line three\nAnd so on...\n&quot;</span>
<a name="l08920"></a>08920 <span class="comment"> *     IO.read(&quot;testfile&quot;, 20)       #=&gt; &quot;This is line one\nThi&quot;</span>
<a name="l08921"></a>08921 <span class="comment"> *     IO.read(&quot;testfile&quot;, 20, 10)   #=&gt; &quot;ne one\nThis is line &quot;</span>
<a name="l08922"></a>08922 <span class="comment"> */</span>
<a name="l08923"></a>08923 
<a name="l08924"></a>08924 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08925"></a><a class="code" href="../../df/d0a/io_8c.html#a27e0238169257152036e6ab2dc7dd689">08925</a> <a class="code" href="../../df/d0a/io_8c.html#a27e0238169257152036e6ab2dc7dd689">rb_io_s_read</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l08926"></a>08926 {
<a name="l08927"></a>08927     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opt, offset;
<a name="l08928"></a>08928     <span class="keyword">struct </span><a class="code" href="../../df/d24/structforeach__arg.html">foreach_arg</a> arg;
<a name="l08929"></a>08929 
<a name="l08930"></a>08930     argc = <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;13:&quot;</span>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;offset, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;opt);
<a name="l08931"></a>08931     <a class="code" href="../../df/d0a/io_8c.html#a122517ae79eb9ffb55e8de983d88b936">open_key_args</a>(argc, argv, opt, &amp;arg);
<a name="l08932"></a>08932     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(arg.<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a>)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l08933"></a>08933     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(offset)) {
<a name="l08934"></a>08934         <span class="keyword">struct </span><a class="code" href="../../d2/d0a/structseek__arg.html">seek_arg</a> sarg;
<a name="l08935"></a>08935         <span class="keywordtype">int</span> <a class="code" href="../../d5/d1d/gb18030_8c.html#adc6e5733fc3c22f0a7b2914188c49c90">state</a> = 0;
<a name="l08936"></a>08936         sarg.<a class="code" href="../../d2/d0a/structseek__arg.html#a0562595cadce6b2f841ff3460744e7b3">io</a> = arg.<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a>;
<a name="l08937"></a>08937         sarg.<a class="code" href="../../d2/d0a/structseek__arg.html#aea7b23ca507a8349c8ae58eecd51592c">offset</a> = offset;
<a name="l08938"></a>08938         sarg.<a class="code" href="../../d2/d0a/structseek__arg.html#a949bd95b090dcaba81557a831705f192">mode</a> = <a class="code" href="../../df/d0a/io_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">SEEK_SET</a>;
<a name="l08939"></a>08939         <a class="code" href="../../d3/d57/eval_8c.html#a6aa7fb1169ed41978a16375b6f921b0e">rb_protect</a>(<a class="code" href="../../df/d0a/io_8c.html#a54f1dd60cb028b38f2ba2b912652d510">seek_before_access</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;sarg, &amp;state);
<a name="l08940"></a>08940         <span class="keywordflow">if</span> (state) {
<a name="l08941"></a>08941             <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>(arg.<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a>);
<a name="l08942"></a>08942             <a class="code" href="../../d3/d57/eval_8c.html#ae48d70c45901eab8b89fb181fc9d1f3b">rb_jump_tag</a>(state);
<a name="l08943"></a>08943         }
<a name="l08944"></a>08944         <span class="keywordflow">if</span> (arg.<a class="code" href="../../df/d24/structforeach__arg.html#a82b95a5e5f4cc6bd6c2db3f296eebd09">argc</a> == 2) arg.<a class="code" href="../../df/d24/structforeach__arg.html#a82b95a5e5f4cc6bd6c2db3f296eebd09">argc</a> = 1;
<a name="l08945"></a>08945     }
<a name="l08946"></a>08946     <span class="keywordflow">return</span> <a class="code" href="../../d3/d57/eval_8c.html#a8061198378fb16adeb931f90540b2839">rb_ensure</a>(<a class="code" href="../../df/d0a/io_8c.html#ad71a85012a41df9928a0e67483aa0b7d">io_s_read</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;arg, <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>, arg.io);
<a name="l08947"></a>08947 }
<a name="l08948"></a>08948 
<a name="l08949"></a>08949 <span class="comment">/*</span>
<a name="l08950"></a>08950 <span class="comment"> *  call-seq:</span>
<a name="l08951"></a>08951 <span class="comment"> *     IO.binread(name, [length [, offset]] )   -&gt; string</span>
<a name="l08952"></a>08952 <span class="comment"> *</span>
<a name="l08953"></a>08953 <span class="comment"> *  Opens the file, optionally seeks to the given &lt;i&gt;offset&lt;/i&gt;, then returns</span>
<a name="l08954"></a>08954 <span class="comment"> *  &lt;i&gt;length&lt;/i&gt; bytes (defaulting to the rest of the file).</span>
<a name="l08955"></a>08955 <span class="comment"> *  &lt;code&gt;binread&lt;/code&gt; ensures the file is closed before returning.</span>
<a name="l08956"></a>08956 <span class="comment"> *  The open mode would be &quot;rb:ASCII-8BIT&quot;.</span>
<a name="l08957"></a>08957 <span class="comment"> *</span>
<a name="l08958"></a>08958 <span class="comment"> *     IO.binread(&quot;testfile&quot;)           #=&gt; &quot;This is line one\nThis is line two\nThis is line three\nAnd so on...\n&quot;</span>
<a name="l08959"></a>08959 <span class="comment"> *     IO.binread(&quot;testfile&quot;, 20)       #=&gt; &quot;This is line one\nThi&quot;</span>
<a name="l08960"></a>08960 <span class="comment"> *     IO.binread(&quot;testfile&quot;, 20, 10)   #=&gt; &quot;ne one\nThis is line &quot;</span>
<a name="l08961"></a>08961 <span class="comment"> */</span>
<a name="l08962"></a>08962 
<a name="l08963"></a>08963 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08964"></a><a class="code" href="../../df/d0a/io_8c.html#a7f691c3c4fb19ca6aed0f542c53e86fe">08964</a> <a class="code" href="../../df/d0a/io_8c.html#a7f691c3c4fb19ca6aed0f542c53e86fe">rb_io_s_binread</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l08965"></a>08965 {
<a name="l08966"></a>08966     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> offset;
<a name="l08967"></a>08967     <span class="keyword">struct </span><a class="code" href="../../df/d24/structforeach__arg.html">foreach_arg</a> arg;
<a name="l08968"></a>08968 
<a name="l08969"></a>08969     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;12&quot;</span>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;offset);
<a name="l08970"></a>08970     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a66b35e3e022b499db72f5df63bb1d358">FilePathValue</a>(argv[0]);
<a name="l08971"></a>08971     arg.<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a> = <a class="code" href="../../df/d0a/io_8c.html#ad3a0800448e149c31b1adc110bf94fc6">rb_io_open</a>(argv[0], <a class="code" href="../../db/d2e/intern_8h.html#a2b9cc485b0aa1dc270744b8b9eb47569">rb_str_new_cstr</a>(<span class="stringliteral">&quot;rb:ASCII-8BIT&quot;</span>), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l08972"></a>08972     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(arg.<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a>)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l08973"></a>08973     arg.<a class="code" href="../../df/d24/structforeach__arg.html#a7007ee143ebe081ccc12769a70cf34bd">argv</a> = argv+1;
<a name="l08974"></a>08974     arg.<a class="code" href="../../df/d24/structforeach__arg.html#a82b95a5e5f4cc6bd6c2db3f296eebd09">argc</a> = (argc &gt; 1) ? 1 : 0;
<a name="l08975"></a>08975     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(offset)) {
<a name="l08976"></a>08976         <a class="code" href="../../df/d0a/io_8c.html#a7de72531da99cf086e643d54f60d21c6">rb_io_seek</a>(arg.<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a>, offset, <a class="code" href="../../df/d0a/io_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">SEEK_SET</a>);
<a name="l08977"></a>08977     }
<a name="l08978"></a>08978     <span class="keywordflow">return</span> <a class="code" href="../../d3/d57/eval_8c.html#a8061198378fb16adeb931f90540b2839">rb_ensure</a>(<a class="code" href="../../df/d0a/io_8c.html#ad71a85012a41df9928a0e67483aa0b7d">io_s_read</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;arg, <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>, arg.io);
<a name="l08979"></a>08979 }
<a name="l08980"></a>08980 
<a name="l08981"></a>08981 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08982"></a><a class="code" href="../../df/d0a/io_8c.html#ad938a74978da6ea995b02abce08efd6d">08982</a> <a class="code" href="../../df/d0a/io_8c.html#ad938a74978da6ea995b02abce08efd6d">io_s_write0</a>(<span class="keyword">struct</span> <a class="code" href="../../dd/d4b/structwrite__arg.html">write_arg</a> *arg)
<a name="l08983"></a>08983 {
<a name="l08984"></a>08984     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#abe88ebe32ee29a9e05e78f43385395de">io_write</a>(arg-&gt;<a class="code" href="../../dd/d4b/structwrite__arg.html#a65f4fa015e8e859209abdec4352945ec">io</a>,arg-&gt;<a class="code" href="../../dd/d4b/structwrite__arg.html#a3c20be56c3ea9c09f7d16e14b7485089">str</a>,arg-&gt;<a class="code" href="../../dd/d4b/structwrite__arg.html#a4e40b1c7b2f0897112040b6e247a475c">nosync</a>);
<a name="l08985"></a>08985 }
<a name="l08986"></a>08986 
<a name="l08987"></a>08987 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l08988"></a><a class="code" href="../../df/d0a/io_8c.html#af72127a6234c80759cf0cdf5a8d0f955">08988</a> <a class="code" href="../../df/d0a/io_8c.html#af72127a6234c80759cf0cdf5a8d0f955">io_s_write</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <span class="keywordtype">int</span> binary)
<a name="l08989"></a>08989 {
<a name="l08990"></a>08990     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> string, offset, opt;
<a name="l08991"></a>08991     <span class="keyword">struct </span><a class="code" href="../../df/d24/structforeach__arg.html">foreach_arg</a> arg;
<a name="l08992"></a>08992     <span class="keyword">struct </span><a class="code" href="../../dd/d4b/structwrite__arg.html">write_arg</a> warg;
<a name="l08993"></a>08993 
<a name="l08994"></a>08994     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;21:&quot;</span>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;<span class="keywordtype">string</span>, &amp;offset, &amp;opt);
<a name="l08995"></a>08995 
<a name="l08996"></a>08996     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(opt)) opt = <a class="code" href="../../d1/d04/hash_8c.html#af1da586524a3a1739fd5b91272037815">rb_hash_new</a>();
<a name="l08997"></a>08997     <span class="keywordflow">else</span> opt = <a class="code" href="../../d1/d04/hash_8c.html#ada1f543a0e9c570602124841a5c3764f">rb_hash_dup</a>(opt);
<a name="l08998"></a>08998 
<a name="l08999"></a>08999 
<a name="l09000"></a>09000     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(<a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opt,<a class="code" href="../../df/d0a/io_8c.html#a6fe1eaa40920fbfda47e7975c8b75f37">sym_mode</a>))) {
<a name="l09001"></a>09001        <span class="keywordtype">int</span> mode = O_WRONLY|O_CREAT;
<a name="l09002"></a>09002 <span class="preprocessor">#ifdef O_BINARY</span>
<a name="l09003"></a>09003 <span class="preprocessor"></span>       <span class="keywordflow">if</span> (binary) mode |= <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>;
<a name="l09004"></a>09004 <span class="preprocessor">#endif</span>
<a name="l09005"></a>09005 <span class="preprocessor"></span>       <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(offset)) mode |= O_TRUNC;
<a name="l09006"></a>09006        <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(opt,<a class="code" href="../../df/d0a/io_8c.html#a6fe1eaa40920fbfda47e7975c8b75f37">sym_mode</a>,<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(mode));
<a name="l09007"></a>09007     }
<a name="l09008"></a>09008     <a class="code" href="../../df/d0a/io_8c.html#a122517ae79eb9ffb55e8de983d88b936">open_key_args</a>(argc,argv,opt,&amp;arg);
<a name="l09009"></a>09009 
<a name="l09010"></a>09010 <span class="preprocessor">#ifndef O_BINARY</span>
<a name="l09011"></a>09011 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (binary) <a class="code" href="../../df/d0a/io_8c.html#afb263b3801efd8532104ec93253ee380">rb_io_binmode_m</a>(arg.<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a>);
<a name="l09012"></a>09012 <span class="preprocessor">#endif</span>
<a name="l09013"></a>09013 <span class="preprocessor"></span>
<a name="l09014"></a>09014     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(arg.<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a>)) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l09015"></a>09015     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(offset)) {
<a name="l09016"></a>09016        <span class="keyword">struct </span><a class="code" href="../../d2/d0a/structseek__arg.html">seek_arg</a> sarg;
<a name="l09017"></a>09017        <span class="keywordtype">int</span> <a class="code" href="../../d5/d1d/gb18030_8c.html#adc6e5733fc3c22f0a7b2914188c49c90">state</a> = 0;
<a name="l09018"></a>09018        sarg.<a class="code" href="../../d2/d0a/structseek__arg.html#a0562595cadce6b2f841ff3460744e7b3">io</a> = arg.<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a>;
<a name="l09019"></a>09019        sarg.<a class="code" href="../../d2/d0a/structseek__arg.html#aea7b23ca507a8349c8ae58eecd51592c">offset</a> = offset;
<a name="l09020"></a>09020        sarg.<a class="code" href="../../d2/d0a/structseek__arg.html#a949bd95b090dcaba81557a831705f192">mode</a> = <a class="code" href="../../df/d0a/io_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">SEEK_SET</a>;
<a name="l09021"></a>09021        <a class="code" href="../../d3/d57/eval_8c.html#a6aa7fb1169ed41978a16375b6f921b0e">rb_protect</a>(<a class="code" href="../../df/d0a/io_8c.html#a54f1dd60cb028b38f2ba2b912652d510">seek_before_access</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;sarg, &amp;state);
<a name="l09022"></a>09022        <span class="keywordflow">if</span> (state) {
<a name="l09023"></a>09023            <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>(arg.<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a>);
<a name="l09024"></a>09024            <a class="code" href="../../d3/d57/eval_8c.html#ae48d70c45901eab8b89fb181fc9d1f3b">rb_jump_tag</a>(state);
<a name="l09025"></a>09025        }
<a name="l09026"></a>09026     }
<a name="l09027"></a>09027 
<a name="l09028"></a>09028     warg.<a class="code" href="../../dd/d4b/structwrite__arg.html#a65f4fa015e8e859209abdec4352945ec">io</a> = arg.<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a>;
<a name="l09029"></a>09029     warg.<a class="code" href="../../dd/d4b/structwrite__arg.html#a3c20be56c3ea9c09f7d16e14b7485089">str</a> = string;
<a name="l09030"></a>09030     warg.<a class="code" href="../../dd/d4b/structwrite__arg.html#a4e40b1c7b2f0897112040b6e247a475c">nosync</a> = 0;
<a name="l09031"></a>09031 
<a name="l09032"></a>09032     <span class="keywordflow">return</span> <a class="code" href="../../d3/d57/eval_8c.html#a8061198378fb16adeb931f90540b2839">rb_ensure</a>(<a class="code" href="../../df/d0a/io_8c.html#ad938a74978da6ea995b02abce08efd6d">io_s_write0</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;warg, <a class="code" href="../../db/d2e/intern_8h.html#a3b37c38f6b8a9fc60eeee87a7d58d232">rb_io_close</a>, arg.<a class="code" href="../../df/d24/structforeach__arg.html#a3e959ddb67c552d9735cc26a17551289">io</a>);
<a name="l09033"></a>09033 }
<a name="l09034"></a>09034 
<a name="l09035"></a>09035 <span class="comment">/*</span>
<a name="l09036"></a>09036 <span class="comment"> *  call-seq:</span>
<a name="l09037"></a>09037 <span class="comment"> *     IO.write(name, string, [offset] )   =&gt; fixnum</span>
<a name="l09038"></a>09038 <span class="comment"> *     IO.write(name, string, [offset], open_args )   =&gt; fixnum</span>
<a name="l09039"></a>09039 <span class="comment"> *</span>
<a name="l09040"></a>09040 <span class="comment"> *  Opens the file, optionally seeks to the given &lt;i&gt;offset&lt;/i&gt;, writes</span>
<a name="l09041"></a>09041 <span class="comment"> *  &lt;i&gt;string&lt;/i&gt;, then returns the length written.</span>
<a name="l09042"></a>09042 <span class="comment"> *  &lt;code&gt;write&lt;/code&gt; ensures the file is closed before returning.</span>
<a name="l09043"></a>09043 <span class="comment"> *  If &lt;i&gt;offset&lt;/i&gt; is not given, the file is truncated.  Otherwise,</span>
<a name="l09044"></a>09044 <span class="comment"> *  it is not truncated.</span>
<a name="l09045"></a>09045 <span class="comment"> *</span>
<a name="l09046"></a>09046 <span class="comment"> *  If the last argument is a hash, it specifies option for internal</span>
<a name="l09047"></a>09047 <span class="comment"> *  open().  The key would be the following.  open_args: is exclusive</span>
<a name="l09048"></a>09048 <span class="comment"> *  to others.</span>
<a name="l09049"></a>09049 <span class="comment"> *</span>
<a name="l09050"></a>09050 <span class="comment"> *   encoding: string or encoding</span>
<a name="l09051"></a>09051 <span class="comment"> *</span>
<a name="l09052"></a>09052 <span class="comment"> *    specifies encoding of the read string.  encoding will be ignored</span>
<a name="l09053"></a>09053 <span class="comment"> *    if length is specified.</span>
<a name="l09054"></a>09054 <span class="comment"> *</span>
<a name="l09055"></a>09055 <span class="comment"> *   mode: string</span>
<a name="l09056"></a>09056 <span class="comment"> *</span>
<a name="l09057"></a>09057 <span class="comment"> *    specifies mode argument for open().  it should start with &quot;w&quot; or &quot;a&quot; or &quot;r+&quot;</span>
<a name="l09058"></a>09058 <span class="comment"> *    otherwise it would cause error.</span>
<a name="l09059"></a>09059 <span class="comment"> *</span>
<a name="l09060"></a>09060 <span class="comment"> *   perm: fixnum</span>
<a name="l09061"></a>09061 <span class="comment"> *</span>
<a name="l09062"></a>09062 <span class="comment"> *    specifies perm argument for open().</span>
<a name="l09063"></a>09063 <span class="comment"> *</span>
<a name="l09064"></a>09064 <span class="comment"> *   open_args: array</span>
<a name="l09065"></a>09065 <span class="comment"> *</span>
<a name="l09066"></a>09066 <span class="comment"> *    specifies arguments for open() as an array.</span>
<a name="l09067"></a>09067 <span class="comment"> *</span>
<a name="l09068"></a>09068 <span class="comment"> *     IO.write(&quot;testfile&quot;, &quot;0123456789&quot;, 20) # =&gt; 10</span>
<a name="l09069"></a>09069 <span class="comment"> *     # File could contain:  &quot;This is line one\nThi0123456789two\nThis is line three\nAnd so on...\n&quot;</span>
<a name="l09070"></a>09070 <span class="comment"> *     IO.write(&quot;testfile&quot;, &quot;0123456789&quot;)      #=&gt; 10</span>
<a name="l09071"></a>09071 <span class="comment"> *     # File would now read: &quot;0123456789&quot;</span>
<a name="l09072"></a>09072 <span class="comment"> */</span>
<a name="l09073"></a>09073 
<a name="l09074"></a>09074 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l09075"></a><a class="code" href="../../df/d0a/io_8c.html#af4609cf0a1d82f03ac7d46be18b1d7d2">09075</a> <a class="code" href="../../df/d0a/io_8c.html#af4609cf0a1d82f03ac7d46be18b1d7d2">rb_io_s_write</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l09076"></a>09076 {
<a name="l09077"></a>09077     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#af72127a6234c80759cf0cdf5a8d0f955">io_s_write</a>(argc, argv, 0);
<a name="l09078"></a>09078 }
<a name="l09079"></a>09079 
<a name="l09080"></a>09080 <span class="comment">/*</span>
<a name="l09081"></a>09081 <span class="comment"> *  call-seq:</span>
<a name="l09082"></a>09082 <span class="comment"> *     IO.binwrite(name, string, [offset] )   =&gt; fixnum</span>
<a name="l09083"></a>09083 <span class="comment"> *</span>
<a name="l09084"></a>09084 <span class="comment"> *  Opens the file, optionally seeks to the given &lt;i&gt;offset&lt;/i&gt;, writes</span>
<a name="l09085"></a>09085 <span class="comment"> *  &lt;i&gt;string&lt;/i&gt; then returns the length written.</span>
<a name="l09086"></a>09086 <span class="comment"> *  &lt;code&gt;binwrite&lt;/code&gt; ensures the file is closed before returning.</span>
<a name="l09087"></a>09087 <span class="comment"> *  The open mode would be &quot;wb:ASCII-8BIT&quot;.</span>
<a name="l09088"></a>09088 <span class="comment"> *  If &lt;i&gt;offset&lt;/i&gt; is not given, the file is truncated.  Otherwise,</span>
<a name="l09089"></a>09089 <span class="comment"> *  it is not truncated.</span>
<a name="l09090"></a>09090 <span class="comment"> *</span>
<a name="l09091"></a>09091 <span class="comment"> *     IO.binwrite(&quot;testfile&quot;, &quot;0123456789&quot;, 20) # =&gt; 10</span>
<a name="l09092"></a>09092 <span class="comment"> *     # File could contain:  &quot;This is line one\nThi0123456789two\nThis is line three\nAnd so on...\n&quot;</span>
<a name="l09093"></a>09093 <span class="comment"> *     IO.binwrite(&quot;testfile&quot;, &quot;0123456789&quot;)      #=&gt; 10</span>
<a name="l09094"></a>09094 <span class="comment"> *     # File would now read: &quot;0123456789&quot;</span>
<a name="l09095"></a>09095 <span class="comment"> */</span>
<a name="l09096"></a>09096 
<a name="l09097"></a>09097 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l09098"></a><a class="code" href="../../df/d0a/io_8c.html#a6a8e1fee0518e265455edab84c0c69fc">09098</a> <a class="code" href="../../df/d0a/io_8c.html#a6a8e1fee0518e265455edab84c0c69fc">rb_io_s_binwrite</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l09099"></a>09099 {
<a name="l09100"></a>09100     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#af72127a6234c80759cf0cdf5a8d0f955">io_s_write</a>(argc, argv, 1);
<a name="l09101"></a>09101 }
<a name="l09102"></a>09102 
<a name="l09103"></a><a class="code" href="../../d0/dc4/structcopy__stream__struct.html">09103</a> <span class="keyword">struct </span><a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> {
<a name="l09104"></a><a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a51988012bbf94748a256ed458addaebc">09104</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a51988012bbf94748a256ed458addaebc">src</a>;
<a name="l09105"></a><a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">09105</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">dst</a>;
<a name="l09106"></a><a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a0fa5e59ed0df9af7028b8fb48deac3c9">09106</a>     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a0fa5e59ed0df9af7028b8fb48deac3c9">copy_length</a>; <span class="comment">/* (off_t)-1 if not specified */</span>
<a name="l09107"></a><a class="code" href="../../d0/dc4/structcopy__stream__struct.html#ad80aa47b6021a723066bdfc932f3edfc">09107</a>     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html#ad80aa47b6021a723066bdfc932f3edfc">src_offset</a>; <span class="comment">/* (off_t)-1 if not specified */</span>
<a name="l09108"></a>09108 
<a name="l09109"></a><a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aade81d18407cdf11552cd13ca9487125">09109</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aade81d18407cdf11552cd13ca9487125">src_fd</a>;
<a name="l09110"></a><a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a05ba2b245729cc65b62ac08f95a7157f">09110</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a05ba2b245729cc65b62ac08f95a7157f">dst_fd</a>;
<a name="l09111"></a><a class="code" href="../../d0/dc4/structcopy__stream__struct.html#ac841877b36e821619cf9062dbb735ddf">09111</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html#ac841877b36e821619cf9062dbb735ddf">close_src</a>;
<a name="l09112"></a><a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a10344cf9fba64fb9720513415533c811">09112</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a10344cf9fba64fb9720513415533c811">close_dst</a>;
<a name="l09113"></a><a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4937d0016dcb8e8be8d5448c7898d90b">09113</a>     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4937d0016dcb8e8be8d5448c7898d90b">total</a>;
<a name="l09114"></a><a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4e75652b4c7805c78c46bb07d1ceaef5">09114</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4e75652b4c7805c78c46bb07d1ceaef5">syserr</a>;
<a name="l09115"></a><a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a9c70284bc00ad270a1d91a2c51796f29">09115</a>     <span class="keywordtype">int</span> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a9c70284bc00ad270a1d91a2c51796f29">error_no</a>;
<a name="l09116"></a><a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a75c3be8de223b45e0b1a18317d44a125">09116</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a75c3be8de223b45e0b1a18317d44a125">notimp</a>;
<a name="l09117"></a><a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a9a13c274cc9d0a524235fc837eff9a">09117</a>     <a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a9a13c274cc9d0a524235fc837eff9a">fds</a>;
<a name="l09118"></a><a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aaddebcd620255dfbe053ba86c17047b6">09118</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aaddebcd620255dfbe053ba86c17047b6">th</a>;
<a name="l09119"></a>09119 };
<a name="l09120"></a>09120 
<a name="l09121"></a>09121 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l09122"></a><a class="code" href="../../df/d0a/io_8c.html#adc2c4ed9f2c7eb23bd7da70ca8d20cf9">09122</a> <a class="code" href="../../df/d0a/io_8c.html#adc2c4ed9f2c7eb23bd7da70ca8d20cf9">exec_interrupts</a>(<span class="keywordtype">void</span> *arg)
<a name="l09123"></a>09123 {
<a name="l09124"></a>09124     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> th = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)arg;
<a name="l09125"></a>09125     <a class="code" href="../../d3/de7/thread_8c.html#aebfe3d635f71a21d8f47a9a79e6d3ab1">rb_thread_execute_interrupts</a>(th);
<a name="l09126"></a>09126     <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l09127"></a>09127 }
<a name="l09128"></a>09128 
<a name="l09129"></a>09129 <span class="comment">/*</span>
<a name="l09130"></a>09130 <span class="comment"> * returns TRUE if the preceding system call was interrupted</span>
<a name="l09131"></a>09131 <span class="comment"> * so we can continue.  If the thread was interrupted, we</span>
<a name="l09132"></a>09132 <span class="comment"> * reacquire the GVL to execute interrupts before continuing.</span>
<a name="l09133"></a>09133 <span class="comment"> */</span>
<a name="l09134"></a>09134 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l09135"></a><a class="code" href="../../df/d0a/io_8c.html#a7a692fe877ed16282bf13b5b4e89ab38">09135</a> <a class="code" href="../../df/d0a/io_8c.html#a7a692fe877ed16282bf13b5b4e89ab38">maygvl_copy_stream_continue_p</a>(<span class="keywordtype">int</span> has_gvl, <span class="keyword">struct</span> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> *stp)
<a name="l09136"></a>09136 {
<a name="l09137"></a>09137     <span class="keywordflow">switch</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l09138"></a>09138       <span class="keywordflow">case</span> EINTR:
<a name="l09139"></a>09139 <span class="preprocessor">#if defined(ERESTART)</span>
<a name="l09140"></a>09140 <span class="preprocessor"></span>      <span class="keywordflow">case</span> ERESTART:
<a name="l09141"></a>09141 <span class="preprocessor">#endif</span>
<a name="l09142"></a>09142 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#a09fe8c6b6e8ac42cba5f0b5b7e8fe24d">rb_thread_interrupted</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aaddebcd620255dfbe053ba86c17047b6">th</a>)) {
<a name="l09143"></a>09143             <span class="keywordflow">if</span> (has_gvl)
<a name="l09144"></a>09144                 <a class="code" href="../../d3/de7/thread_8c.html#aebfe3d635f71a21d8f47a9a79e6d3ab1">rb_thread_execute_interrupts</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aaddebcd620255dfbe053ba86c17047b6">th</a>);
<a name="l09145"></a>09145             <span class="keywordflow">else</span>
<a name="l09146"></a>09146                 <a class="code" href="../../d3/de7/thread_8c.html#a750cc265be9b084ee41c51157948f756">rb_thread_call_with_gvl</a>(<a class="code" href="../../df/d0a/io_8c.html#adc2c4ed9f2c7eb23bd7da70ca8d20cf9">exec_interrupts</a>, (<span class="keywordtype">void</span> *)stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aaddebcd620255dfbe053ba86c17047b6">th</a>);
<a name="l09147"></a>09147         }
<a name="l09148"></a>09148         <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l09149"></a>09149     }
<a name="l09150"></a>09150     <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l09151"></a>09151 }
<a name="l09152"></a>09152 
<a name="l09153"></a>09153 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l09154"></a><a class="code" href="../../df/d0a/io_8c.html#a4e3847281a44dbaff4efdcc53bc5398c">09154</a> <a class="code" href="../../df/d0a/io_8c.html#a4e3847281a44dbaff4efdcc53bc5398c">maygvl_select</a>(<span class="keywordtype">int</span> has_gvl, <span class="keywordtype">int</span> n, <a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> *rfds, <a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> *wfds, <a class="code" href="../../db/d2e/intern_8h.html#a8521734f4dea98f847217bda96b2f47a">rb_fdset_t</a> *efds, <span class="keyword">struct</span> <a class="code" href="../../d1/d1b/structtimeval.html">timeval</a> *timeout)
<a name="l09155"></a>09155 {
<a name="l09156"></a>09156     <span class="keywordflow">if</span> (has_gvl)
<a name="l09157"></a>09157         <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a3dbecc01461a64d6b6fa6d1b229fbd91">rb_thread_fd_select</a>(n, rfds, wfds, efds, timeout);
<a name="l09158"></a>09158     <span class="keywordflow">else</span>
<a name="l09159"></a>09159         <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a8858bd4ae76f7668fd73b317f1c2c43d">rb_fd_select</a>(n, rfds, wfds, efds, timeout);
<a name="l09160"></a>09160 }
<a name="l09161"></a>09161 
<a name="l09162"></a>09162 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l09163"></a><a class="code" href="../../df/d0a/io_8c.html#a70a2a1c908d19bf3fc20578e32610dcb">09163</a> <a class="code" href="../../df/d0a/io_8c.html#a70a2a1c908d19bf3fc20578e32610dcb">maygvl_copy_stream_wait_read</a>(<span class="keywordtype">int</span> has_gvl, <span class="keyword">struct</span> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> *stp)
<a name="l09164"></a>09164 {
<a name="l09165"></a>09165     <span class="keywordtype">int</span> ret;
<a name="l09166"></a>09166 
<a name="l09167"></a>09167     <span class="keywordflow">do</span> {
<a name="l09168"></a>09168         <a class="code" href="../../db/d2e/intern_8h.html#ad7af25c68710c749aa408c9502f217a0">rb_fd_zero</a>(&amp;stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a9a13c274cc9d0a524235fc837eff9a">fds</a>);
<a name="l09169"></a>09169         <a class="code" href="../../db/d2e/intern_8h.html#ab93b57ee695b8d0abe01904e952c3a6f">rb_fd_set</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aade81d18407cdf11552cd13ca9487125">src_fd</a>, &amp;stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a9a13c274cc9d0a524235fc837eff9a">fds</a>);
<a name="l09170"></a>09170         ret = <a class="code" href="../../df/d0a/io_8c.html#a4e3847281a44dbaff4efdcc53bc5398c">maygvl_select</a>(has_gvl, <a class="code" href="../../db/d2e/intern_8h.html#aa8414e6f26aec3f70660a7db60938df5">rb_fd_max</a>(&amp;stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a9a13c274cc9d0a524235fc837eff9a">fds</a>), &amp;stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a9a13c274cc9d0a524235fc837eff9a">fds</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l09171"></a>09171     } <span class="keywordflow">while</span> (ret == -1 &amp;&amp; <a class="code" href="../../df/d0a/io_8c.html#a7a692fe877ed16282bf13b5b4e89ab38">maygvl_copy_stream_continue_p</a>(has_gvl, stp));
<a name="l09172"></a>09172 
<a name="l09173"></a>09173     <span class="keywordflow">if</span> (ret == -1) {
<a name="l09174"></a>09174         stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4e75652b4c7805c78c46bb07d1ceaef5">syserr</a> = <span class="stringliteral">&quot;select&quot;</span>;
<a name="l09175"></a>09175         stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a9c70284bc00ad270a1d91a2c51796f29">error_no</a> = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l09176"></a>09176         <span class="keywordflow">return</span> -1;
<a name="l09177"></a>09177     }
<a name="l09178"></a>09178     <span class="keywordflow">return</span> 0;
<a name="l09179"></a>09179 }
<a name="l09180"></a>09180 
<a name="l09181"></a>09181 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l09182"></a><a class="code" href="../../df/d0a/io_8c.html#a7991de8a2af4d0ed4c4e9a611ee1b52c">09182</a> <a class="code" href="../../df/d0a/io_8c.html#a7991de8a2af4d0ed4c4e9a611ee1b52c">nogvl_copy_stream_wait_write</a>(<span class="keyword">struct</span> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> *stp)
<a name="l09183"></a>09183 {
<a name="l09184"></a>09184     <span class="keywordtype">int</span> ret;
<a name="l09185"></a>09185 
<a name="l09186"></a>09186     <span class="keywordflow">do</span> {
<a name="l09187"></a>09187         <a class="code" href="../../db/d2e/intern_8h.html#ad7af25c68710c749aa408c9502f217a0">rb_fd_zero</a>(&amp;stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a9a13c274cc9d0a524235fc837eff9a">fds</a>);
<a name="l09188"></a>09188         <a class="code" href="../../db/d2e/intern_8h.html#ab93b57ee695b8d0abe01904e952c3a6f">rb_fd_set</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a05ba2b245729cc65b62ac08f95a7157f">dst_fd</a>, &amp;stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a9a13c274cc9d0a524235fc837eff9a">fds</a>);
<a name="l09189"></a>09189         ret = <a class="code" href="../../db/d2e/intern_8h.html#a8858bd4ae76f7668fd73b317f1c2c43d">rb_fd_select</a>(<a class="code" href="../../db/d2e/intern_8h.html#aa8414e6f26aec3f70660a7db60938df5">rb_fd_max</a>(&amp;stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a9a13c274cc9d0a524235fc837eff9a">fds</a>), <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a9a13c274cc9d0a524235fc837eff9a">fds</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l09190"></a>09190     } <span class="keywordflow">while</span> (ret == -1 &amp;&amp; <a class="code" href="../../df/d0a/io_8c.html#a7a692fe877ed16282bf13b5b4e89ab38">maygvl_copy_stream_continue_p</a>(0, stp));
<a name="l09191"></a>09191 
<a name="l09192"></a>09192     <span class="keywordflow">if</span> (ret == -1) {
<a name="l09193"></a>09193         stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4e75652b4c7805c78c46bb07d1ceaef5">syserr</a> = <span class="stringliteral">&quot;select&quot;</span>;
<a name="l09194"></a>09194         stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a9c70284bc00ad270a1d91a2c51796f29">error_no</a> = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l09195"></a>09195         <span class="keywordflow">return</span> -1;
<a name="l09196"></a>09196     }
<a name="l09197"></a>09197     <span class="keywordflow">return</span> 0;
<a name="l09198"></a>09198 }
<a name="l09199"></a>09199 
<a name="l09200"></a>09200 <span class="preprocessor">#ifdef HAVE_SENDFILE</span>
<a name="l09201"></a>09201 <span class="preprocessor"></span>
<a name="l09202"></a>09202 <span class="preprocessor"># ifdef __linux__</span>
<a name="l09203"></a>09203 <span class="preprocessor"></span><span class="preprocessor">#  define USE_SENDFILE</span>
<a name="l09204"></a>09204 <span class="preprocessor"></span>
<a name="l09205"></a>09205 <span class="preprocessor">#  ifdef HAVE_SYS_SENDFILE_H</span>
<a name="l09206"></a>09206 <span class="preprocessor"></span><span class="preprocessor">#   include &lt;sys/sendfile.h&gt;</span>
<a name="l09207"></a>09207 <span class="preprocessor">#  endif</span>
<a name="l09208"></a>09208 <span class="preprocessor"></span>
<a name="l09209"></a>09209 <span class="keyword">static</span> ssize_t
<a name="l09210"></a>09210 simple_sendfile(<span class="keywordtype">int</span> out_fd, <span class="keywordtype">int</span> in_fd, <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> *offset, <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> <a class="code" href="../../d5/db5/encoding_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>)
<a name="l09211"></a>09211 {
<a name="l09212"></a>09212     <span class="keywordflow">return</span> sendfile(out_fd, in_fd, offset, (<span class="keywordtype">size_t</span>)count);
<a name="l09213"></a>09213 }
<a name="l09214"></a>09214 
<a name="l09215"></a>09215 <span class="preprocessor"># elif 0 </span><span class="comment">/* defined(__FreeBSD__) || defined(__DragonFly__) */</span> || defined(__APPLE__)
<a name="l09216"></a>09216 <span class="comment">/* This runs on FreeBSD8.1 r30210, but sendfiles blocks its execution</span>
<a name="l09217"></a>09217 <span class="comment"> * without cpuset -l 0.</span>
<a name="l09218"></a>09218 <span class="comment"> */</span>
<a name="l09219"></a>09219 <span class="preprocessor">#  define USE_SENDFILE</span>
<a name="l09220"></a>09220 <span class="preprocessor"></span>
<a name="l09221"></a>09221 <span class="preprocessor">#  ifdef HAVE_SYS_UIO_H</span>
<a name="l09222"></a>09222 <span class="preprocessor"></span><span class="preprocessor">#   include &lt;sys/uio.h&gt;</span>
<a name="l09223"></a>09223 <span class="preprocessor">#  endif</span>
<a name="l09224"></a>09224 <span class="preprocessor"></span>
<a name="l09225"></a>09225 <span class="keyword">static</span> ssize_t
<a name="l09226"></a>09226 simple_sendfile(<span class="keywordtype">int</span> out_fd, <span class="keywordtype">int</span> in_fd, <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> *offset, <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> count)
<a name="l09227"></a>09227 {
<a name="l09228"></a>09228     <span class="keywordtype">int</span> r;
<a name="l09229"></a>09229     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> pos = offset ? *offset : lseek(in_fd, 0, <a class="code" href="../../df/d0a/io_8c.html#a4c8d0b76b470ba65a43ca46a88320f39">SEEK_CUR</a>);
<a name="l09230"></a>09230     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> sbytes;
<a name="l09231"></a>09231 <span class="preprocessor">#  ifdef __APPLE__</span>
<a name="l09232"></a>09232 <span class="preprocessor"></span>    r = sendfile(in_fd, out_fd, pos, &amp;count, NULL, 0);
<a name="l09233"></a>09233     sbytes = count;
<a name="l09234"></a>09234 <span class="preprocessor">#  else</span>
<a name="l09235"></a>09235 <span class="preprocessor"></span>    r = sendfile(in_fd, out_fd, pos, (<span class="keywordtype">size_t</span>)count, NULL, &amp;sbytes, 0);
<a name="l09236"></a>09236 <span class="preprocessor">#  endif</span>
<a name="l09237"></a>09237 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (r != 0 &amp;&amp; sbytes == 0) <span class="keywordflow">return</span> -1;
<a name="l09238"></a>09238     <span class="keywordflow">if</span> (offset) {
<a name="l09239"></a>09239         *offset += sbytes;
<a name="l09240"></a>09240     }
<a name="l09241"></a>09241     <span class="keywordflow">else</span> {
<a name="l09242"></a>09242         lseek(in_fd, sbytes, <a class="code" href="../../df/d0a/io_8c.html#a4c8d0b76b470ba65a43ca46a88320f39">SEEK_CUR</a>);
<a name="l09243"></a>09243     }
<a name="l09244"></a>09244     <span class="keywordflow">return</span> (ssize_t)sbytes;
<a name="l09245"></a>09245 }
<a name="l09246"></a>09246 
<a name="l09247"></a>09247 <span class="preprocessor"># endif</span>
<a name="l09248"></a>09248 <span class="preprocessor"></span>
<a name="l09249"></a>09249 <span class="preprocessor">#endif</span>
<a name="l09250"></a>09250 <span class="preprocessor"></span>
<a name="l09251"></a>09251 <span class="preprocessor">#ifdef USE_SENDFILE</span>
<a name="l09252"></a>09252 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l09253"></a>09253 nogvl_copy_stream_sendfile(<span class="keyword">struct</span> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> *stp)
<a name="l09254"></a>09254 {
<a name="l09255"></a>09255     <span class="keyword">struct </span><a class="code" href="../../dc/db1/win32_8h.html#a4feaac5e1913330bded57b059061965b">stat</a> src_stat, dst_stat;
<a name="l09256"></a>09256     ssize_t ss;
<a name="l09257"></a>09257     <span class="keywordtype">int</span> ret;
<a name="l09258"></a>09258 
<a name="l09259"></a>09259     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> copy_length;
<a name="l09260"></a>09260     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> src_offset;
<a name="l09261"></a>09261     <span class="keywordtype">int</span> use_pread;
<a name="l09262"></a>09262 
<a name="l09263"></a>09263     ret = <a class="code" href="../../dc/db1/win32_8h.html#a8a2cf46df7f7017617df85cdb0afdc64">fstat</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aade81d18407cdf11552cd13ca9487125">src_fd</a>, &amp;src_stat);
<a name="l09264"></a>09264     <span class="keywordflow">if</span> (ret == -1) {
<a name="l09265"></a>09265         stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4e75652b4c7805c78c46bb07d1ceaef5">syserr</a> = <span class="stringliteral">&quot;fstat&quot;</span>;
<a name="l09266"></a>09266         stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a9c70284bc00ad270a1d91a2c51796f29">error_no</a> = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l09267"></a>09267         <span class="keywordflow">return</span> -1;
<a name="l09268"></a>09268     }
<a name="l09269"></a>09269     <span class="keywordflow">if</span> (!<a class="code" href="../../d6/d13/file_8c.html#abf68371159fa46b5cc47d0f3ac9ab723">S_ISREG</a>(src_stat.st_mode))
<a name="l09270"></a>09270         <span class="keywordflow">return</span> 0;
<a name="l09271"></a>09271 
<a name="l09272"></a>09272     ret = <a class="code" href="../../dc/db1/win32_8h.html#a8a2cf46df7f7017617df85cdb0afdc64">fstat</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a05ba2b245729cc65b62ac08f95a7157f">dst_fd</a>, &amp;dst_stat);
<a name="l09273"></a>09273     <span class="keywordflow">if</span> (ret == -1) {
<a name="l09274"></a>09274         stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4e75652b4c7805c78c46bb07d1ceaef5">syserr</a> = <span class="stringliteral">&quot;fstat&quot;</span>;
<a name="l09275"></a>09275         stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a9c70284bc00ad270a1d91a2c51796f29">error_no</a> = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l09276"></a>09276         <span class="keywordflow">return</span> -1;
<a name="l09277"></a>09277     }
<a name="l09278"></a>09278     <span class="keywordflow">if</span> ((dst_stat.st_mode &amp; S_IFMT) != S_IFSOCK)
<a name="l09279"></a>09279         <span class="keywordflow">return</span> 0;
<a name="l09280"></a>09280 
<a name="l09281"></a>09281     src_offset = stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#ad80aa47b6021a723066bdfc932f3edfc">src_offset</a>;
<a name="l09282"></a>09282     use_pread = src_offset != (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1;
<a name="l09283"></a>09283 
<a name="l09284"></a>09284     copy_length = stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a0fa5e59ed0df9af7028b8fb48deac3c9">copy_length</a>;
<a name="l09285"></a>09285     <span class="keywordflow">if</span> (copy_length == (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1) {
<a name="l09286"></a>09286         <span class="keywordflow">if</span> (use_pread)
<a name="l09287"></a>09287             copy_length = src_stat.st_size - src_offset;
<a name="l09288"></a>09288         <span class="keywordflow">else</span> {
<a name="l09289"></a>09289             <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> cur;
<a name="l09290"></a>09290             <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0;
<a name="l09291"></a>09291             cur = lseek(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aade81d18407cdf11552cd13ca9487125">src_fd</a>, 0, <a class="code" href="../../df/d0a/io_8c.html#a4c8d0b76b470ba65a43ca46a88320f39">SEEK_CUR</a>);
<a name="l09292"></a>09292             <span class="keywordflow">if</span> (cur == (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1 &amp;&amp; errno) {
<a name="l09293"></a>09293                 stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4e75652b4c7805c78c46bb07d1ceaef5">syserr</a> = <span class="stringliteral">&quot;lseek&quot;</span>;
<a name="l09294"></a>09294                 stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a9c70284bc00ad270a1d91a2c51796f29">error_no</a> = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l09295"></a>09295                 <span class="keywordflow">return</span> -1;
<a name="l09296"></a>09296             }
<a name="l09297"></a>09297             copy_length = src_stat.st_size - cur;
<a name="l09298"></a>09298         }
<a name="l09299"></a>09299     }
<a name="l09300"></a>09300 
<a name="l09301"></a>09301   retry_sendfile:
<a name="l09302"></a>09302 <span class="preprocessor"># if SIZEOF_OFF_T &gt; SIZEOF_SIZE_T</span>
<a name="l09303"></a>09303 <span class="preprocessor"></span>    <span class="comment">/* we are limited by the 32-bit ssize_t return value on 32-bit */</span>
<a name="l09304"></a>09304     ss = (copy_length &gt; (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2d6569aa794c2f23e90691e60d2f3ad2">SSIZE_MAX</a>) ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2d6569aa794c2f23e90691e60d2f3ad2">SSIZE_MAX</a> : (ssize_t)copy_length;
<a name="l09305"></a>09305 <span class="preprocessor"># else</span>
<a name="l09306"></a>09306 <span class="preprocessor"></span>    ss = (ssize_t)copy_length;
<a name="l09307"></a>09307 <span class="preprocessor"># endif</span>
<a name="l09308"></a>09308 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (use_pread) {
<a name="l09309"></a>09309         ss = simple_sendfile(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a05ba2b245729cc65b62ac08f95a7157f">dst_fd</a>, stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aade81d18407cdf11552cd13ca9487125">src_fd</a>, &amp;src_offset, ss);
<a name="l09310"></a>09310     }
<a name="l09311"></a>09311     <span class="keywordflow">else</span> {
<a name="l09312"></a>09312         ss = simple_sendfile(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a05ba2b245729cc65b62ac08f95a7157f">dst_fd</a>, stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aade81d18407cdf11552cd13ca9487125">src_fd</a>, NULL, ss);
<a name="l09313"></a>09313     }
<a name="l09314"></a>09314     <span class="keywordflow">if</span> (0 &lt; ss) {
<a name="l09315"></a>09315         stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4937d0016dcb8e8be8d5448c7898d90b">total</a> += ss;
<a name="l09316"></a>09316         copy_length -= ss;
<a name="l09317"></a>09317         <span class="keywordflow">if</span> (0 &lt; copy_length) {
<a name="l09318"></a>09318             <span class="keywordflow">goto</span> retry_sendfile;
<a name="l09319"></a>09319         }
<a name="l09320"></a>09320     }
<a name="l09321"></a>09321     <span class="keywordflow">if</span> (ss == -1) {
<a name="l09322"></a>09322         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a7a692fe877ed16282bf13b5b4e89ab38">maygvl_copy_stream_continue_p</a>(0, stp))
<a name="l09323"></a>09323             <span class="keywordflow">goto</span> retry_sendfile;
<a name="l09324"></a>09324         <span class="keywordflow">switch</span> (errno) {
<a name="l09325"></a>09325           <span class="keywordflow">case</span> EINVAL:
<a name="l09326"></a>09326 <span class="preprocessor">#ifdef ENOSYS</span>
<a name="l09327"></a>09327 <span class="preprocessor"></span>          <span class="keywordflow">case</span> ENOSYS:
<a name="l09328"></a>09328 <span class="preprocessor">#endif</span>
<a name="l09329"></a>09329 <span class="preprocessor"></span>            <span class="keywordflow">return</span> 0;
<a name="l09330"></a>09330           <span class="keywordflow">case</span> EAGAIN:
<a name="l09331"></a>09331 <span class="preprocessor">#if defined(EWOULDBLOCK) &amp;&amp; EWOULDBLOCK != EAGAIN</span>
<a name="l09332"></a>09332 <span class="preprocessor"></span>          <span class="keywordflow">case</span> <a class="code" href="../../dd/d8c/rubysocket_8h.html#a4a3a0b3605fd3b2336455062ee8e25f0">EWOULDBLOCK</a>:
<a name="l09333"></a>09333 <span class="preprocessor">#endif</span>
<a name="l09334"></a>09334 <span class="preprocessor"></span><span class="preprocessor">#ifndef linux</span>
<a name="l09335"></a>09335 <span class="preprocessor"></span>           <span class="comment">/*</span>
<a name="l09336"></a>09336 <span class="comment">            * Linux requires stp-&gt;src_fd to be a mmap-able (regular) file,</span>
<a name="l09337"></a>09337 <span class="comment">            * select() reports regular files to always be &quot;ready&quot;, so</span>
<a name="l09338"></a>09338 <span class="comment">            * there is no need to select() on it.</span>
<a name="l09339"></a>09339 <span class="comment">            * Other OSes may have the same limitation for sendfile() which</span>
<a name="l09340"></a>09340 <span class="comment">            * allow us to bypass maygvl_copy_stream_wait_read()...</span>
<a name="l09341"></a>09341 <span class="comment">            */</span>
<a name="l09342"></a>09342             <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a70a2a1c908d19bf3fc20578e32610dcb">maygvl_copy_stream_wait_read</a>(0, stp) == -1)
<a name="l09343"></a>09343                 <span class="keywordflow">return</span> -1;
<a name="l09344"></a>09344 <span class="preprocessor">#endif</span>
<a name="l09345"></a>09345 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a7991de8a2af4d0ed4c4e9a611ee1b52c">nogvl_copy_stream_wait_write</a>(stp) == -1)
<a name="l09346"></a>09346                 <span class="keywordflow">return</span> -1;
<a name="l09347"></a>09347             <span class="keywordflow">goto</span> retry_sendfile;
<a name="l09348"></a>09348         }
<a name="l09349"></a>09349         stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4e75652b4c7805c78c46bb07d1ceaef5">syserr</a> = <span class="stringliteral">&quot;sendfile&quot;</span>;
<a name="l09350"></a>09350         stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a9c70284bc00ad270a1d91a2c51796f29">error_no</a> = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l09351"></a>09351         <span class="keywordflow">return</span> -1;
<a name="l09352"></a>09352     }
<a name="l09353"></a>09353     <span class="keywordflow">return</span> 1;
<a name="l09354"></a>09354 }
<a name="l09355"></a>09355 <span class="preprocessor">#endif</span>
<a name="l09356"></a>09356 <span class="preprocessor"></span>
<a name="l09357"></a>09357 <span class="keyword">static</span> ssize_t
<a name="l09358"></a><a class="code" href="../../df/d0a/io_8c.html#a69a7abf634e8dd5b5272aaa3ebc6b613">09358</a> <a class="code" href="../../df/d0a/io_8c.html#a69a7abf634e8dd5b5272aaa3ebc6b613">maygvl_read</a>(<span class="keywordtype">int</span> has_gvl, <span class="keywordtype">int</span> fd, <span class="keywordtype">void</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>, <span class="keywordtype">size_t</span> count)
<a name="l09359"></a>09359 {
<a name="l09360"></a>09360     <span class="keywordflow">if</span> (has_gvl)
<a name="l09361"></a>09361         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#aa992ea0a36c7c173ae889134907d2b22">rb_read_internal</a>(fd, buf, count);
<a name="l09362"></a>09362     <span class="keywordflow">else</span>
<a name="l09363"></a>09363         <span class="keywordflow">return</span> read(fd, buf, count);
<a name="l09364"></a>09364 }
<a name="l09365"></a>09365 
<a name="l09366"></a>09366 <span class="keyword">static</span> ssize_t
<a name="l09367"></a><a class="code" href="../../df/d0a/io_8c.html#a02d60fc395af5cfebe0de1943e88e2dc">09367</a> <a class="code" href="../../df/d0a/io_8c.html#a02d60fc395af5cfebe0de1943e88e2dc">maygvl_copy_stream_read</a>(<span class="keywordtype">int</span> has_gvl, <span class="keyword">struct</span> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> *stp, <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>, <span class="keywordtype">size_t</span> len, <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> offset)
<a name="l09368"></a>09368 {
<a name="l09369"></a>09369     ssize_t ss;
<a name="l09370"></a>09370   retry_read:
<a name="l09371"></a>09371     <span class="keywordflow">if</span> (offset == (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1) {
<a name="l09372"></a>09372         ss = <a class="code" href="../../df/d0a/io_8c.html#a69a7abf634e8dd5b5272aaa3ebc6b613">maygvl_read</a>(has_gvl, stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aade81d18407cdf11552cd13ca9487125">src_fd</a>, buf, len);
<a name="l09373"></a>09373     }
<a name="l09374"></a>09374     <span class="keywordflow">else</span> {
<a name="l09375"></a>09375 <span class="preprocessor">#ifdef HAVE_PREAD</span>
<a name="l09376"></a>09376 <span class="preprocessor"></span>        ss = pread(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aade81d18407cdf11552cd13ca9487125">src_fd</a>, buf, len, offset);
<a name="l09377"></a>09377 <span class="preprocessor">#else</span>
<a name="l09378"></a>09378 <span class="preprocessor"></span>        stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a75c3be8de223b45e0b1a18317d44a125">notimp</a> = <span class="stringliteral">&quot;pread&quot;</span>;
<a name="l09379"></a>09379         <span class="keywordflow">return</span> -1;
<a name="l09380"></a>09380 <span class="preprocessor">#endif</span>
<a name="l09381"></a>09381 <span class="preprocessor"></span>    }
<a name="l09382"></a>09382     <span class="keywordflow">if</span> (ss == 0) {
<a name="l09383"></a>09383         <span class="keywordflow">return</span> 0;
<a name="l09384"></a>09384     }
<a name="l09385"></a>09385     <span class="keywordflow">if</span> (ss == -1) {
<a name="l09386"></a>09386         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a7a692fe877ed16282bf13b5b4e89ab38">maygvl_copy_stream_continue_p</a>(has_gvl, stp))
<a name="l09387"></a>09387             <span class="keywordflow">goto</span> retry_read;
<a name="l09388"></a>09388         <span class="keywordflow">switch</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l09389"></a>09389           <span class="keywordflow">case</span> EAGAIN:
<a name="l09390"></a>09390 <span class="preprocessor">#if defined(EWOULDBLOCK) &amp;&amp; EWOULDBLOCK != EAGAIN</span>
<a name="l09391"></a>09391 <span class="preprocessor"></span>          <span class="keywordflow">case</span> <a class="code" href="../../dd/d8c/rubysocket_8h.html#a4a3a0b3605fd3b2336455062ee8e25f0">EWOULDBLOCK</a>:
<a name="l09392"></a>09392 <span class="preprocessor">#endif</span>
<a name="l09393"></a>09393 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a70a2a1c908d19bf3fc20578e32610dcb">maygvl_copy_stream_wait_read</a>(has_gvl, stp) == -1)
<a name="l09394"></a>09394                 <span class="keywordflow">return</span> -1;
<a name="l09395"></a>09395             <span class="keywordflow">goto</span> retry_read;
<a name="l09396"></a>09396 <span class="preprocessor">#ifdef ENOSYS</span>
<a name="l09397"></a>09397 <span class="preprocessor"></span>          <span class="keywordflow">case</span> ENOSYS:
<a name="l09398"></a>09398 <span class="preprocessor">#endif</span>
<a name="l09399"></a>09399 <span class="preprocessor"></span>            stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a75c3be8de223b45e0b1a18317d44a125">notimp</a> = <span class="stringliteral">&quot;pread&quot;</span>;
<a name="l09400"></a>09400             <span class="keywordflow">return</span> -1;
<a name="l09401"></a>09401         }
<a name="l09402"></a>09402         stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4e75652b4c7805c78c46bb07d1ceaef5">syserr</a> = offset == (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1 ?  <span class="stringliteral">&quot;read&quot;</span> : <span class="stringliteral">&quot;pread&quot;</span>;
<a name="l09403"></a>09403         stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a9c70284bc00ad270a1d91a2c51796f29">error_no</a> = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l09404"></a>09404         <span class="keywordflow">return</span> -1;
<a name="l09405"></a>09405     }
<a name="l09406"></a>09406     <span class="keywordflow">return</span> ss;
<a name="l09407"></a>09407 }
<a name="l09408"></a>09408 
<a name="l09409"></a>09409 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l09410"></a><a class="code" href="../../df/d0a/io_8c.html#aa07d6c6f64bbcc1b79f2a58fb8c1900c">09410</a> <a class="code" href="../../df/d0a/io_8c.html#aa07d6c6f64bbcc1b79f2a58fb8c1900c">nogvl_copy_stream_write</a>(<span class="keyword">struct</span> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> *stp, <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>, <span class="keywordtype">size_t</span> len)
<a name="l09411"></a>09411 {
<a name="l09412"></a>09412     ssize_t ss;
<a name="l09413"></a>09413     <span class="keywordtype">int</span> off = 0;
<a name="l09414"></a>09414     <span class="keywordflow">while</span> (len) {
<a name="l09415"></a>09415         ss = write(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a05ba2b245729cc65b62ac08f95a7157f">dst_fd</a>, buf+off, len);
<a name="l09416"></a>09416         <span class="keywordflow">if</span> (ss == -1) {
<a name="l09417"></a>09417             <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a7a692fe877ed16282bf13b5b4e89ab38">maygvl_copy_stream_continue_p</a>(0, stp))
<a name="l09418"></a>09418                 <span class="keywordflow">continue</span>;
<a name="l09419"></a>09419             <span class="keywordflow">if</span> (<a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == EAGAIN || <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == <a class="code" href="../../dd/d8c/rubysocket_8h.html#a4a3a0b3605fd3b2336455062ee8e25f0">EWOULDBLOCK</a>) {
<a name="l09420"></a>09420                 <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a7991de8a2af4d0ed4c4e9a611ee1b52c">nogvl_copy_stream_wait_write</a>(stp) == -1)
<a name="l09421"></a>09421                     <span class="keywordflow">return</span> -1;
<a name="l09422"></a>09422                 <span class="keywordflow">continue</span>;
<a name="l09423"></a>09423             }
<a name="l09424"></a>09424             stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4e75652b4c7805c78c46bb07d1ceaef5">syserr</a> = <span class="stringliteral">&quot;write&quot;</span>;
<a name="l09425"></a>09425             stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a9c70284bc00ad270a1d91a2c51796f29">error_no</a> = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l09426"></a>09426             <span class="keywordflow">return</span> -1;
<a name="l09427"></a>09427         }
<a name="l09428"></a>09428         off += (int)ss;
<a name="l09429"></a>09429         len -= (int)ss;
<a name="l09430"></a>09430         stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4937d0016dcb8e8be8d5448c7898d90b">total</a> += ss;
<a name="l09431"></a>09431     }
<a name="l09432"></a>09432     <span class="keywordflow">return</span> 0;
<a name="l09433"></a>09433 }
<a name="l09434"></a>09434 
<a name="l09435"></a>09435 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l09436"></a><a class="code" href="../../df/d0a/io_8c.html#a6b962337d33a75b53c72e44dca38eba2">09436</a> <a class="code" href="../../df/d0a/io_8c.html#a6b962337d33a75b53c72e44dca38eba2">nogvl_copy_stream_read_write</a>(<span class="keyword">struct</span> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> *stp)
<a name="l09437"></a>09437 {
<a name="l09438"></a>09438     <span class="keywordtype">char</span> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>[1024*16];
<a name="l09439"></a>09439     <span class="keywordtype">size_t</span> len;
<a name="l09440"></a>09440     ssize_t ss;
<a name="l09441"></a>09441     <span class="keywordtype">int</span> ret;
<a name="l09442"></a>09442     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> copy_length;
<a name="l09443"></a>09443     <span class="keywordtype">int</span> use_eof;
<a name="l09444"></a>09444     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> src_offset;
<a name="l09445"></a>09445     <span class="keywordtype">int</span> use_pread;
<a name="l09446"></a>09446 
<a name="l09447"></a>09447     copy_length = stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a0fa5e59ed0df9af7028b8fb48deac3c9">copy_length</a>;
<a name="l09448"></a>09448     use_eof = copy_length == (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1;
<a name="l09449"></a>09449     src_offset = stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#ad80aa47b6021a723066bdfc932f3edfc">src_offset</a>;
<a name="l09450"></a>09450     use_pread = src_offset != (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1;
<a name="l09451"></a>09451 
<a name="l09452"></a>09452     <span class="keywordflow">if</span> (use_pread &amp;&amp; stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#ac841877b36e821619cf9062dbb735ddf">close_src</a>) {
<a name="l09453"></a>09453         <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> r;
<a name="l09454"></a>09454         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0;
<a name="l09455"></a>09455         r = lseek(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aade81d18407cdf11552cd13ca9487125">src_fd</a>, src_offset, <a class="code" href="../../df/d0a/io_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">SEEK_SET</a>);
<a name="l09456"></a>09456         <span class="keywordflow">if</span> (r == (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1 &amp;&amp; <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l09457"></a>09457             stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4e75652b4c7805c78c46bb07d1ceaef5">syserr</a> = <span class="stringliteral">&quot;lseek&quot;</span>;
<a name="l09458"></a>09458             stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a9c70284bc00ad270a1d91a2c51796f29">error_no</a> = <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>;
<a name="l09459"></a>09459             <span class="keywordflow">return</span>;
<a name="l09460"></a>09460         }
<a name="l09461"></a>09461         src_offset = (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1;
<a name="l09462"></a>09462         use_pread = 0;
<a name="l09463"></a>09463     }
<a name="l09464"></a>09464 
<a name="l09465"></a>09465     <span class="keywordflow">while</span> (use_eof || 0 &lt; copy_length) {
<a name="l09466"></a>09466         <span class="keywordflow">if</span> (!use_eof &amp;&amp; copy_length &lt; (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)<span class="keyword">sizeof</span>(buf)) {
<a name="l09467"></a>09467             len = (size_t)copy_length;
<a name="l09468"></a>09468         }
<a name="l09469"></a>09469         <span class="keywordflow">else</span> {
<a name="l09470"></a>09470             len = <span class="keyword">sizeof</span>(buf);
<a name="l09471"></a>09471         }
<a name="l09472"></a>09472         <span class="keywordflow">if</span> (use_pread) {
<a name="l09473"></a>09473             ss = <a class="code" href="../../df/d0a/io_8c.html#a02d60fc395af5cfebe0de1943e88e2dc">maygvl_copy_stream_read</a>(0, stp, buf, len, src_offset);
<a name="l09474"></a>09474             <span class="keywordflow">if</span> (0 &lt; ss)
<a name="l09475"></a>09475                 src_offset += ss;
<a name="l09476"></a>09476         }
<a name="l09477"></a>09477         <span class="keywordflow">else</span> {
<a name="l09478"></a>09478             ss = <a class="code" href="../../df/d0a/io_8c.html#a02d60fc395af5cfebe0de1943e88e2dc">maygvl_copy_stream_read</a>(0, stp, buf, len, (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1);
<a name="l09479"></a>09479         }
<a name="l09480"></a>09480         <span class="keywordflow">if</span> (ss &lt;= 0) <span class="comment">/* EOF or error */</span>
<a name="l09481"></a>09481             <span class="keywordflow">return</span>;
<a name="l09482"></a>09482 
<a name="l09483"></a>09483         ret = <a class="code" href="../../df/d0a/io_8c.html#aa07d6c6f64bbcc1b79f2a58fb8c1900c">nogvl_copy_stream_write</a>(stp, buf, ss);
<a name="l09484"></a>09484         <span class="keywordflow">if</span> (ret &lt; 0)
<a name="l09485"></a>09485             <span class="keywordflow">return</span>;
<a name="l09486"></a>09486 
<a name="l09487"></a>09487         <span class="keywordflow">if</span> (!use_eof)
<a name="l09488"></a>09488             copy_length -= ss;
<a name="l09489"></a>09489     }
<a name="l09490"></a>09490 }
<a name="l09491"></a>09491 
<a name="l09492"></a>09492 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l09493"></a><a class="code" href="../../df/d0a/io_8c.html#a240df81d707f3fe176edc8e89476a17e">09493</a> <a class="code" href="../../df/d0a/io_8c.html#a240df81d707f3fe176edc8e89476a17e">nogvl_copy_stream_func</a>(<span class="keywordtype">void</span> *arg)
<a name="l09494"></a>09494 {
<a name="l09495"></a>09495     <span class="keyword">struct </span><a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> *stp = (<span class="keyword">struct </span><a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> *)arg;
<a name="l09496"></a>09496 <span class="preprocessor">#ifdef USE_SENDFILE</span>
<a name="l09497"></a>09497 <span class="preprocessor"></span>    <span class="keywordtype">int</span> ret;
<a name="l09498"></a>09498 <span class="preprocessor">#endif</span>
<a name="l09499"></a>09499 <span class="preprocessor"></span>
<a name="l09500"></a>09500 <span class="preprocessor">#ifdef USE_SENDFILE</span>
<a name="l09501"></a>09501 <span class="preprocessor"></span>    ret = nogvl_copy_stream_sendfile(stp);
<a name="l09502"></a>09502     <span class="keywordflow">if</span> (ret != 0)
<a name="l09503"></a>09503         <span class="keywordflow">goto</span> finish; <span class="comment">/* error or success */</span>
<a name="l09504"></a>09504 <span class="preprocessor">#endif</span>
<a name="l09505"></a>09505 <span class="preprocessor"></span>
<a name="l09506"></a>09506     <a class="code" href="../../df/d0a/io_8c.html#a6b962337d33a75b53c72e44dca38eba2">nogvl_copy_stream_read_write</a>(stp);
<a name="l09507"></a>09507 
<a name="l09508"></a>09508 <span class="preprocessor">#ifdef USE_SENDFILE</span>
<a name="l09509"></a>09509 <span class="preprocessor"></span>  finish:
<a name="l09510"></a>09510 <span class="preprocessor">#endif</span>
<a name="l09511"></a>09511 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l09512"></a>09512 }
<a name="l09513"></a>09513 
<a name="l09514"></a>09514 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l09515"></a><a class="code" href="../../df/d0a/io_8c.html#a54c9907babfbe1a0033a92ffae5b3b44">09515</a> <a class="code" href="../../df/d0a/io_8c.html#a54c9907babfbe1a0033a92ffae5b3b44">copy_stream_fallback_body</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l09516"></a>09516 {
<a name="l09517"></a>09517     <span class="keyword">struct </span><a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> *stp = (<span class="keyword">struct </span><a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> *)arg;
<a name="l09518"></a>09518     <span class="keyword">const</span> <span class="keywordtype">int</span> buflen = 16*1024;
<a name="l09519"></a>09519     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> n;
<a name="l09520"></a>09520     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a> = <a class="code" href="../../db/d2e/intern_8h.html#a65dee742ae2daaab92ac8974cb2fbff2">rb_str_buf_new</a>(buflen);
<a name="l09521"></a>09521     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> rest = stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a0fa5e59ed0df9af7028b8fb48deac3c9">copy_length</a>;
<a name="l09522"></a>09522     <a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a> off = stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#ad80aa47b6021a723066bdfc932f3edfc">src_offset</a>;
<a name="l09523"></a>09523     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> read_method = <a class="code" href="../../df/d0a/io_8c.html#a5b4f2a8b420ec7588f0a9983fb513b81">id_readpartial</a>;
<a name="l09524"></a>09524 
<a name="l09525"></a>09525     <span class="keywordflow">if</span> (stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aade81d18407cdf11552cd13ca9487125">src_fd</a> == -1) {
<a name="l09526"></a>09526         <span class="keywordflow">if</span> (!<a class="code" href="../../db/d2e/intern_8h.html#a5c6c63c2619b8c03df2e173ef1e73846">rb_respond_to</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a51988012bbf94748a256ed458addaebc">src</a>, read_method)) {
<a name="l09527"></a>09527             read_method = <a class="code" href="../../df/d0a/io_8c.html#aaab409b2dac658da354cd7efc5ad39ae">id_read</a>;
<a name="l09528"></a>09528         }
<a name="l09529"></a>09529     }
<a name="l09530"></a>09530 
<a name="l09531"></a>09531     <span class="keywordflow">while</span> (1) {
<a name="l09532"></a>09532         <span class="keywordtype">long</span> numwrote;
<a name="l09533"></a>09533         <span class="keywordtype">long</span> l;
<a name="l09534"></a>09534         <span class="keywordflow">if</span> (stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a0fa5e59ed0df9af7028b8fb48deac3c9">copy_length</a> == (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1) {
<a name="l09535"></a>09535             l = buflen;
<a name="l09536"></a>09536         }
<a name="l09537"></a>09537         <span class="keywordflow">else</span> {
<a name="l09538"></a>09538             <span class="keywordflow">if</span> (rest == 0)
<a name="l09539"></a>09539                 <span class="keywordflow">break</span>;
<a name="l09540"></a>09540             l = buflen &lt; rest ? buflen : (<a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a>)rest;
<a name="l09541"></a>09541         }
<a name="l09542"></a>09542         <span class="keywordflow">if</span> (stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aade81d18407cdf11552cd13ca9487125">src_fd</a> == -1) {
<a name="l09543"></a>09543             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6a973fe624aa9aa9ba0cdeb6792d3187" title="Calls a method.">rb_funcall</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a51988012bbf94748a256ed458addaebc">src</a>, read_method, 2, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(l), buf);
<a name="l09544"></a>09544         }
<a name="l09545"></a>09545         <span class="keywordflow">else</span> {
<a name="l09546"></a>09546             ssize_t ss;
<a name="l09547"></a>09547             <a class="code" href="../../db/d2e/intern_8h.html#a38e5ff660fd6c045c7242de575e8a5f2">rb_thread_wait_fd</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aade81d18407cdf11552cd13ca9487125">src_fd</a>);
<a name="l09548"></a>09548             <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(buf, buflen);
<a name="l09549"></a>09549             ss = <a class="code" href="../../df/d0a/io_8c.html#a02d60fc395af5cfebe0de1943e88e2dc">maygvl_copy_stream_read</a>(1, stp, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(buf), l, off);
<a name="l09550"></a>09550             <span class="keywordflow">if</span> (ss == -1)
<a name="l09551"></a>09551                 <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l09552"></a>09552             <span class="keywordflow">if</span> (ss == 0)
<a name="l09553"></a>09553                 <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>();
<a name="l09554"></a>09554             <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(buf, ss);
<a name="l09555"></a>09555             <span class="keywordflow">if</span> (off != (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1)
<a name="l09556"></a>09556                 off += ss;
<a name="l09557"></a>09557         }
<a name="l09558"></a>09558         n = <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">dst</a>, buf);
<a name="l09559"></a>09559         numwrote = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(n);
<a name="l09560"></a>09560         stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4937d0016dcb8e8be8d5448c7898d90b">total</a> += numwrote;
<a name="l09561"></a>09561         rest -= numwrote;
<a name="l09562"></a>09562         <span class="keywordflow">if</span> (read_method == <a class="code" href="../../df/d0a/io_8c.html#aaab409b2dac658da354cd7efc5ad39ae">id_read</a> &amp;&amp; <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(buf) == 0) {
<a name="l09563"></a>09563             <span class="keywordflow">break</span>;
<a name="l09564"></a>09564         }
<a name="l09565"></a>09565     }
<a name="l09566"></a>09566 
<a name="l09567"></a>09567     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l09568"></a>09568 }
<a name="l09569"></a>09569 
<a name="l09570"></a>09570 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l09571"></a><a class="code" href="../../df/d0a/io_8c.html#a474afe661b27e32a34fffe32c53a43f7">09571</a> <a class="code" href="../../df/d0a/io_8c.html#a474afe661b27e32a34fffe32c53a43f7">copy_stream_fallback</a>(<span class="keyword">struct</span> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> *stp)
<a name="l09572"></a>09572 {
<a name="l09573"></a>09573     <span class="keywordflow">if</span> (stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aade81d18407cdf11552cd13ca9487125">src_fd</a> == -1 &amp;&amp; stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#ad80aa47b6021a723066bdfc932f3edfc">src_offset</a> != (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1) {
<a name="l09574"></a>09574         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;cannot specify src_offset for non-IO&quot;</span>);
<a name="l09575"></a>09575     }
<a name="l09576"></a>09576     <a class="code" href="../../d3/d57/eval_8c.html#a2e28de157b82ffc63ecff4782dba649c">rb_rescue2</a>(<a class="code" href="../../df/d0a/io_8c.html#a54c9907babfbe1a0033a92ffae5b3b44">copy_stream_fallback_body</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)stp,
<a name="l09577"></a>09577                (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> (*) (<a class="code" href="../../d8/db0/defines_8h.html#af4fd7cbafda9af704310f78516042dfb">ANYARGS</a>))0, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)0,
<a name="l09578"></a>09578                <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a64459141201c6d17c834b04b905a4dc5">rb_eEOFError</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)0);
<a name="l09579"></a>09579     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l09580"></a>09580 }
<a name="l09581"></a>09581 
<a name="l09582"></a>09582 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l09583"></a><a class="code" href="../../df/d0a/io_8c.html#a01366b2c88aa915b024e0d8835659707">09583</a> <a class="code" href="../../df/d0a/io_8c.html#a01366b2c88aa915b024e0d8835659707">copy_stream_body</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l09584"></a>09584 {
<a name="l09585"></a>09585     <span class="keyword">struct </span><a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> *stp = (<span class="keyword">struct </span><a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> *)arg;
<a name="l09586"></a>09586     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> src_io, dst_io;
<a name="l09587"></a>09587     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *src_fptr = 0, *dst_fptr = 0;
<a name="l09588"></a>09588     <span class="keywordtype">int</span> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aade81d18407cdf11552cd13ca9487125">src_fd</a>, <a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a05ba2b245729cc65b62ac08f95a7157f">dst_fd</a>;
<a name="l09589"></a>09589 
<a name="l09590"></a>09590     stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aaddebcd620255dfbe053ba86c17047b6">th</a> = <a class="code" href="../../db/d2e/intern_8h.html#ac41dd89ae3df1fc1d9968c8239659ce3">rb_thread_current</a>();
<a name="l09591"></a>09591 
<a name="l09592"></a>09592     stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4937d0016dcb8e8be8d5448c7898d90b">total</a> = 0;
<a name="l09593"></a>09593 
<a name="l09594"></a>09594     <span class="keywordflow">if</span> (stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a51988012bbf94748a256ed458addaebc">src</a> == <a class="code" href="../../de/d05/structargf.html">argf</a> ||
<a name="l09595"></a>09595         !(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a51988012bbf94748a256ed458addaebc">src</a>) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a> ||
<a name="l09596"></a>09596           <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a51988012bbf94748a256ed458addaebc">src</a>) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a22a8c2a4bbaae9b68f65c9bb92fd4e39">T_STRING</a> ||
<a name="l09597"></a>09597           <a class="code" href="../../db/d2e/intern_8h.html#a5c6c63c2619b8c03df2e173ef1e73846">rb_respond_to</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a51988012bbf94748a256ed458addaebc">src</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;to_path&quot;</span>)))) {
<a name="l09598"></a>09598         src_fd = -1;
<a name="l09599"></a>09599     }
<a name="l09600"></a>09600     <span class="keywordflow">else</span> {
<a name="l09601"></a>09601         src_io = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a51988012bbf94748a256ed458addaebc">src</a>) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a> ? stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a51988012bbf94748a256ed458addaebc">src</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l09602"></a>09602         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(src_io)) {
<a name="l09603"></a>09603             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d09/ripper_8y.html#a8187411843a6284ffb964ef3fb9fcab3">args</a>[2];
<a name="l09604"></a>09604             <span class="keywordtype">int</span> oflags = O_RDONLY;
<a name="l09605"></a>09605 <span class="preprocessor">#ifdef O_NOCTTY</span>
<a name="l09606"></a>09606 <span class="preprocessor"></span>            oflags |= O_NOCTTY;
<a name="l09607"></a>09607 <span class="preprocessor">#endif</span>
<a name="l09608"></a>09608 <span class="preprocessor"></span>            <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a66b35e3e022b499db72f5df63bb1d358">FilePathValue</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a51988012bbf94748a256ed458addaebc">src</a>);
<a name="l09609"></a>09609             args[0] = stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a51988012bbf94748a256ed458addaebc">src</a>;
<a name="l09610"></a>09610             args[1] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(oflags);
<a name="l09611"></a>09611             src_io = <a class="code" href="../../db/d2e/intern_8h.html#a4e25a1a5ca0fc372179c4f429600bc2a">rb_class_new_instance</a>(2, args, <a class="code" href="../../d6/d13/file_8c.html#ae9f03997c2e7a3461524e83053a24ac2">rb_cFile</a>);
<a name="l09612"></a>09612             stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a51988012bbf94748a256ed458addaebc">src</a> = src_io;
<a name="l09613"></a>09613             stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#ac841877b36e821619cf9062dbb735ddf">close_src</a> = 1;
<a name="l09614"></a>09614         }
<a name="l09615"></a>09615         <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(src_io, src_fptr);
<a name="l09616"></a>09616         <a class="code" href="../../dc/dac/io_8h.html#a38b3a618992ee85d5510dc70db4e2b36">rb_io_check_byte_readable</a>(src_fptr);
<a name="l09617"></a>09617         src_fd = src_fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#a0d48f8e91d24ff4f382564b30c1b41c2">fd</a>;
<a name="l09618"></a>09618     }
<a name="l09619"></a>09619     stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#aade81d18407cdf11552cd13ca9487125">src_fd</a> = src_fd;
<a name="l09620"></a>09620 
<a name="l09621"></a>09621     <span class="keywordflow">if</span> (stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">dst</a> == <a class="code" href="../../de/d05/structargf.html">argf</a> ||
<a name="l09622"></a>09622         !(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">dst</a>) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a> ||
<a name="l09623"></a>09623           <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">dst</a>) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a22a8c2a4bbaae9b68f65c9bb92fd4e39">T_STRING</a> ||
<a name="l09624"></a>09624           <a class="code" href="../../db/d2e/intern_8h.html#a5c6c63c2619b8c03df2e173ef1e73846">rb_respond_to</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">dst</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;to_path&quot;</span>)))) {
<a name="l09625"></a>09625         dst_fd = -1;
<a name="l09626"></a>09626     }
<a name="l09627"></a>09627     <span class="keywordflow">else</span> {
<a name="l09628"></a>09628         dst_io = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">dst</a>) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a> ? stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">dst</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l09629"></a>09629         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(dst_io)) {
<a name="l09630"></a>09630             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d09/ripper_8y.html#a8187411843a6284ffb964ef3fb9fcab3">args</a>[3];
<a name="l09631"></a>09631             <span class="keywordtype">int</span> oflags = O_WRONLY|O_CREAT|O_TRUNC;
<a name="l09632"></a>09632 <span class="preprocessor">#ifdef O_NOCTTY</span>
<a name="l09633"></a>09633 <span class="preprocessor"></span>            oflags |= O_NOCTTY;
<a name="l09634"></a>09634 <span class="preprocessor">#endif</span>
<a name="l09635"></a>09635 <span class="preprocessor"></span>            <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a66b35e3e022b499db72f5df63bb1d358">FilePathValue</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">dst</a>);
<a name="l09636"></a>09636             args[0] = stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">dst</a>;
<a name="l09637"></a>09637             args[1] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(oflags);
<a name="l09638"></a>09638             args[2] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(0600);
<a name="l09639"></a>09639             dst_io = <a class="code" href="../../db/d2e/intern_8h.html#a4e25a1a5ca0fc372179c4f429600bc2a">rb_class_new_instance</a>(3, args, <a class="code" href="../../d6/d13/file_8c.html#ae9f03997c2e7a3461524e83053a24ac2">rb_cFile</a>);
<a name="l09640"></a>09640             stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">dst</a> = dst_io;
<a name="l09641"></a>09641             stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a10344cf9fba64fb9720513415533c811">close_dst</a> = 1;
<a name="l09642"></a>09642         }
<a name="l09643"></a>09643         <span class="keywordflow">else</span> {
<a name="l09644"></a>09644             dst_io = <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(dst_io);
<a name="l09645"></a>09645             stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">dst</a> = dst_io;
<a name="l09646"></a>09646         }
<a name="l09647"></a>09647         <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(dst_io, dst_fptr);
<a name="l09648"></a>09648         <a class="code" href="../../dc/dac/io_8h.html#a728977df67c656197402bb30a14af953">rb_io_check_writable</a>(dst_fptr);
<a name="l09649"></a>09649         dst_fd = dst_fptr-&gt;fd;
<a name="l09650"></a>09650     }
<a name="l09651"></a>09651     stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a05ba2b245729cc65b62ac08f95a7157f">dst_fd</a> = dst_fd;
<a name="l09652"></a>09652 
<a name="l09653"></a>09653 <span class="preprocessor">#ifdef O_BINARY</span>
<a name="l09654"></a>09654 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (src_fptr)
<a name="l09655"></a>09655         <a class="code" href="../../df/d0a/io_8c.html#a325ff952c6a51577331c216377353886">SET_BINARY_MODE_WITH_SEEK_CUR</a>(src_fptr);
<a name="l09656"></a>09656     <span class="keywordflow">if</span> (dst_fptr)
<a name="l09657"></a>09657         setmode(dst_fd, <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>);
<a name="l09658"></a>09658 <span class="preprocessor">#endif</span>
<a name="l09659"></a>09659 <span class="preprocessor"></span>
<a name="l09660"></a>09660     <span class="keywordflow">if</span> (stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#ad80aa47b6021a723066bdfc932f3edfc">src_offset</a> == (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1 &amp;&amp; src_fptr &amp;&amp; src_fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>) {
<a name="l09661"></a>09661         <span class="keywordtype">size_t</span> len = src_fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#afeb1762330048aede7e7383dee981304">rbuf</a>.<a class="code" href="../../d7/d6b/structrb__io__buffer__t.html#a4d7a7af58ce1b4a5fb0c6c76f8186a05">len</a>;
<a name="l09662"></a>09662         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str;
<a name="l09663"></a>09663         <span class="keywordflow">if</span> (stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a0fa5e59ed0df9af7028b8fb48deac3c9">copy_length</a> != (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1 &amp;&amp; stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a0fa5e59ed0df9af7028b8fb48deac3c9">copy_length</a> &lt; (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)len) {
<a name="l09664"></a>09664             len = (size_t)stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a0fa5e59ed0df9af7028b8fb48deac3c9">copy_length</a>;
<a name="l09665"></a>09665         }
<a name="l09666"></a>09666         str = <a class="code" href="../../db/d2e/intern_8h.html#a65dee742ae2daaab92ac8974cb2fbff2">rb_str_buf_new</a>(len);
<a name="l09667"></a>09667         <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(str,len);
<a name="l09668"></a>09668         <a class="code" href="../../df/d0a/io_8c.html#af0cb01766b96b9ba7f84b4ebd4e2099d">read_buffered_data</a>(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), len, src_fptr);
<a name="l09669"></a>09669         <span class="keywordflow">if</span> (dst_fptr) { <span class="comment">/* IO or filename */</span>
<a name="l09670"></a>09670             <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a434d0bad3a6a4a85ab3a2932204b8d83">io_binwrite</a>(str, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str), dst_fptr, 0) &lt; 0)
<a name="l09671"></a>09671                 <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(0);
<a name="l09672"></a>09672         }
<a name="l09673"></a>09673         <span class="keywordflow">else</span> <span class="comment">/* others such as StringIO */</span>
<a name="l09674"></a>09674             <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">dst</a>, str);
<a name="l09675"></a>09675         stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4937d0016dcb8e8be8d5448c7898d90b">total</a> += len;
<a name="l09676"></a>09676         <span class="keywordflow">if</span> (stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a0fa5e59ed0df9af7028b8fb48deac3c9">copy_length</a> != (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1)
<a name="l09677"></a>09677             stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a0fa5e59ed0df9af7028b8fb48deac3c9">copy_length</a> -= len;
<a name="l09678"></a>09678     }
<a name="l09679"></a>09679 
<a name="l09680"></a>09680     <span class="keywordflow">if</span> (dst_fptr &amp;&amp; <a class="code" href="../../df/d0a/io_8c.html#a3519b9245db7f69f9b7ff105a93e4b8a">io_fflush</a>(dst_fptr) &lt; 0) {
<a name="l09681"></a>09681         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;flush failed&quot;</span>);
<a name="l09682"></a>09682     }
<a name="l09683"></a>09683 
<a name="l09684"></a>09684     <span class="keywordflow">if</span> (stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a0fa5e59ed0df9af7028b8fb48deac3c9">copy_length</a> == 0)
<a name="l09685"></a>09685         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l09686"></a>09686 
<a name="l09687"></a>09687     <span class="keywordflow">if</span> (src_fd == -1 || dst_fd == -1) {
<a name="l09688"></a>09688         <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a474afe661b27e32a34fffe32c53a43f7">copy_stream_fallback</a>(stp);
<a name="l09689"></a>09689     }
<a name="l09690"></a>09690 
<a name="l09691"></a>09691     <a class="code" href="../../db/d2e/intern_8h.html#ab93b57ee695b8d0abe01904e952c3a6f">rb_fd_set</a>(src_fd, &amp;stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a9a13c274cc9d0a524235fc837eff9a">fds</a>);
<a name="l09692"></a>09692     <a class="code" href="../../db/d2e/intern_8h.html#ab93b57ee695b8d0abe01904e952c3a6f">rb_fd_set</a>(dst_fd, &amp;stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a9a13c274cc9d0a524235fc837eff9a">fds</a>);
<a name="l09693"></a>09693 
<a name="l09694"></a>09694     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a08ae0a0abef66341ce134880e8e37934">rb_thread_blocking_region</a>(<a class="code" href="../../df/d0a/io_8c.html#a240df81d707f3fe176edc8e89476a17e">nogvl_copy_stream_func</a>, (<span class="keywordtype">void</span>*)stp, <a class="code" href="../../db/d2e/intern_8h.html#a42eb65c31dbcdaa74496ed9668b7889f">RUBY_UBF_IO</a>, 0);
<a name="l09695"></a>09695 }
<a name="l09696"></a>09696 
<a name="l09697"></a>09697 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l09698"></a><a class="code" href="../../df/d0a/io_8c.html#ad019bd475718fd2fd80f6eaa5877b3d2">09698</a> <a class="code" href="../../df/d0a/io_8c.html#ad019bd475718fd2fd80f6eaa5877b3d2">copy_stream_finalize</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l09699"></a>09699 {
<a name="l09700"></a>09700     <span class="keyword">struct </span><a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> *stp = (<span class="keyword">struct </span><a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> *)arg;
<a name="l09701"></a>09701     <span class="keywordflow">if</span> (stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#ac841877b36e821619cf9062dbb735ddf">close_src</a>) {
<a name="l09702"></a>09702         <a class="code" href="../../df/d0a/io_8c.html#af420b3bd2e69cd4d8ac0a7f1eebefc8d">rb_io_close_m</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a51988012bbf94748a256ed458addaebc">src</a>);
<a name="l09703"></a>09703     }
<a name="l09704"></a>09704     <span class="keywordflow">if</span> (stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a10344cf9fba64fb9720513415533c811">close_dst</a>) {
<a name="l09705"></a>09705         <a class="code" href="../../df/d0a/io_8c.html#af420b3bd2e69cd4d8ac0a7f1eebefc8d">rb_io_close_m</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">dst</a>);
<a name="l09706"></a>09706     }
<a name="l09707"></a>09707     <a class="code" href="../../db/d2e/intern_8h.html#af5ba60171ec45c289183e9fa3e829b8a">rb_fd_term</a>(&amp;stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a9a13c274cc9d0a524235fc837eff9a">fds</a>);
<a name="l09708"></a>09708     <span class="keywordflow">if</span> (stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4e75652b4c7805c78c46bb07d1ceaef5">syserr</a>) {
<a name="l09709"></a>09709         <a class="code" href="../../d4/db0/__sdbm_8c.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a9c70284bc00ad270a1d91a2c51796f29">error_no</a>;
<a name="l09710"></a>09710         <a class="code" href="../../da/d01/iconv_8c.html#aec8c58a2938d615c2e79659048c6ef60">rb_sys_fail</a>(stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a4e75652b4c7805c78c46bb07d1ceaef5">syserr</a>);
<a name="l09711"></a>09711     }
<a name="l09712"></a>09712     <span class="keywordflow">if</span> (stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a75c3be8de223b45e0b1a18317d44a125">notimp</a>) {
<a name="l09713"></a>09713         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a1f4044eeff81eb1676037771628b555c">rb_eNotImpError</a>, <span class="stringliteral">&quot;%s() not implemented&quot;</span>, stp-&gt;<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a75c3be8de223b45e0b1a18317d44a125">notimp</a>);
<a name="l09714"></a>09714     }
<a name="l09715"></a>09715     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l09716"></a>09716 }
<a name="l09717"></a>09717 
<a name="l09718"></a>09718 <span class="comment">/*</span>
<a name="l09719"></a>09719 <span class="comment"> *  call-seq:</span>
<a name="l09720"></a>09720 <span class="comment"> *     IO.copy_stream(src, dst)</span>
<a name="l09721"></a>09721 <span class="comment"> *     IO.copy_stream(src, dst, copy_length)</span>
<a name="l09722"></a>09722 <span class="comment"> *     IO.copy_stream(src, dst, copy_length, src_offset)</span>
<a name="l09723"></a>09723 <span class="comment"> *</span>
<a name="l09724"></a>09724 <span class="comment"> *  IO.copy_stream copies &lt;i&gt;src&lt;/i&gt; to &lt;i&gt;dst&lt;/i&gt;.</span>
<a name="l09725"></a>09725 <span class="comment"> *  &lt;i&gt;src&lt;/i&gt; and &lt;i&gt;dst&lt;/i&gt; is either a filename or an IO.</span>
<a name="l09726"></a>09726 <span class="comment"> *</span>
<a name="l09727"></a>09727 <span class="comment"> *  This method returns the number of bytes copied.</span>
<a name="l09728"></a>09728 <span class="comment"> *</span>
<a name="l09729"></a>09729 <span class="comment"> *  If optional arguments are not given,</span>
<a name="l09730"></a>09730 <span class="comment"> *  the start position of the copy is</span>
<a name="l09731"></a>09731 <span class="comment"> *  the beginning of the filename or</span>
<a name="l09732"></a>09732 <span class="comment"> *  the current file offset of the IO.</span>
<a name="l09733"></a>09733 <span class="comment"> *  The end position of the copy is the end of file.</span>
<a name="l09734"></a>09734 <span class="comment"> *</span>
<a name="l09735"></a>09735 <span class="comment"> *  If &lt;i&gt;copy_length&lt;/i&gt; is given,</span>
<a name="l09736"></a>09736 <span class="comment"> *  No more than &lt;i&gt;copy_length&lt;/i&gt; bytes are copied.</span>
<a name="l09737"></a>09737 <span class="comment"> *</span>
<a name="l09738"></a>09738 <span class="comment"> *  If &lt;i&gt;src_offset&lt;/i&gt; is given,</span>
<a name="l09739"></a>09739 <span class="comment"> *  it specifies the start position of the copy.</span>
<a name="l09740"></a>09740 <span class="comment"> *</span>
<a name="l09741"></a>09741 <span class="comment"> *  When &lt;i&gt;src_offset&lt;/i&gt; is specified and</span>
<a name="l09742"></a>09742 <span class="comment"> *  &lt;i&gt;src&lt;/i&gt; is an IO,</span>
<a name="l09743"></a>09743 <span class="comment"> *  IO.copy_stream doesn&apos;t move the current file offset.</span>
<a name="l09744"></a>09744 <span class="comment"> *</span>
<a name="l09745"></a>09745 <span class="comment"> */</span>
<a name="l09746"></a>09746 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l09747"></a><a class="code" href="../../df/d0a/io_8c.html#af17502cf63e52e072d284891d89915ad">09747</a> <a class="code" href="../../df/d0a/io_8c.html#af17502cf63e52e072d284891d89915ad">rb_io_s_copy_stream</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l09748"></a>09748 {
<a name="l09749"></a>09749     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a51988012bbf94748a256ed458addaebc">src</a>, <a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">dst</a>, length, src_offset;
<a name="l09750"></a>09750     <span class="keyword">struct </span><a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a> st;
<a name="l09751"></a>09751 
<a name="l09752"></a>09752     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a56d620b94b668ed7665d1616b2c54e48">MEMZERO</a>(&amp;st, <span class="keyword">struct</span> <a class="code" href="../../d0/dc4/structcopy__stream__struct.html">copy_stream_struct</a>, 1);
<a name="l09753"></a>09753 
<a name="l09754"></a>09754     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;22&quot;</span>, &amp;src, &amp;dst, &amp;length, &amp;src_offset);
<a name="l09755"></a>09755 
<a name="l09756"></a>09756     st.<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a51988012bbf94748a256ed458addaebc">src</a> = src;
<a name="l09757"></a>09757     st.<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a439b236c5e4d252ecd0baba1267f0b">dst</a> = dst;
<a name="l09758"></a>09758 
<a name="l09759"></a>09759     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(length))
<a name="l09760"></a>09760         st.<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a0fa5e59ed0df9af7028b8fb48deac3c9">copy_length</a> = (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1;
<a name="l09761"></a>09761     <span class="keywordflow">else</span>
<a name="l09762"></a>09762         st.<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a0fa5e59ed0df9af7028b8fb48deac3c9">copy_length</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#adc3ee80338c33b87afa2a7047287c96f">NUM2OFFT</a>(length);
<a name="l09763"></a>09763 
<a name="l09764"></a>09764     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(src_offset))
<a name="l09765"></a>09765         st.<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#ad80aa47b6021a723066bdfc932f3edfc">src_offset</a> = (<a class="code" href="../../df/d0a/io_8c.html#ae498af04567b740d66e09d36613c2cd8">off_t</a>)-1;
<a name="l09766"></a>09766     <span class="keywordflow">else</span>
<a name="l09767"></a>09767         st.<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#ad80aa47b6021a723066bdfc932f3edfc">src_offset</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#adc3ee80338c33b87afa2a7047287c96f">NUM2OFFT</a>(src_offset);
<a name="l09768"></a>09768 
<a name="l09769"></a>09769     <a class="code" href="../../db/d2e/intern_8h.html#af5c7e378da9f236d57683a79c526ccd6">rb_fd_init</a>(&amp;st.<a class="code" href="../../d0/dc4/structcopy__stream__struct.html#a8a9a13c274cc9d0a524235fc837eff9a">fds</a>);
<a name="l09770"></a>09770     <a class="code" href="../../d3/d57/eval_8c.html#a8061198378fb16adeb931f90540b2839">rb_ensure</a>(<a class="code" href="../../df/d0a/io_8c.html#a01366b2c88aa915b024e0d8835659707">copy_stream_body</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;st, <a class="code" href="../../df/d0a/io_8c.html#ad019bd475718fd2fd80f6eaa5877b3d2">copy_stream_finalize</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;st);
<a name="l09771"></a>09771 
<a name="l09772"></a>09772     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0272a51f5dbad0d6413d4de5d24c4aad">OFFT2NUM</a>(st.total);
<a name="l09773"></a>09773 }
<a name="l09774"></a>09774 
<a name="l09775"></a>09775 <span class="comment">/*</span>
<a name="l09776"></a>09776 <span class="comment"> *  call-seq:</span>
<a name="l09777"></a>09777 <span class="comment"> *     io.external_encoding   -&gt; encoding</span>
<a name="l09778"></a>09778 <span class="comment"> *</span>
<a name="l09779"></a>09779 <span class="comment"> *  Returns the Encoding object that represents the encoding of the file.</span>
<a name="l09780"></a>09780 <span class="comment"> *  If io is write mode and no encoding is specified, returns &lt;code&gt;nil&lt;/code&gt;.</span>
<a name="l09781"></a>09781 <span class="comment"> */</span>
<a name="l09782"></a>09782 
<a name="l09783"></a>09783 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l09784"></a><a class="code" href="../../df/d0a/io_8c.html#af2d7a69851929321fc9353de62e3f363">09784</a> <a class="code" href="../../df/d0a/io_8c.html#af2d7a69851929321fc9353de62e3f363">rb_io_external_encoding</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l09785"></a>09785 {
<a name="l09786"></a>09786     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l09787"></a>09787 
<a name="l09788"></a>09788     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l09789"></a>09789     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc2) {
<a name="l09790"></a>09790         <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc2);
<a name="l09791"></a>09791     }
<a name="l09792"></a>09792     <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#aab130221afcebe4a7029434091ed6104">mode</a> &amp; <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>) {
<a name="l09793"></a>09793         <span class="keywordflow">if</span> (fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc)
<a name="l09794"></a>09794             <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc);
<a name="l09795"></a>09795         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l09796"></a>09796     }
<a name="l09797"></a>09797     <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(<a class="code" href="../../df/d0a/io_8c.html#aa3b568197b019bda6a9aea4fbe2153eb">io_read_encoding</a>(fptr));
<a name="l09798"></a>09798 }
<a name="l09799"></a>09799 
<a name="l09800"></a>09800 <span class="comment">/*</span>
<a name="l09801"></a>09801 <span class="comment"> *  call-seq:</span>
<a name="l09802"></a>09802 <span class="comment"> *     io.internal_encoding   -&gt; encoding</span>
<a name="l09803"></a>09803 <span class="comment"> *</span>
<a name="l09804"></a>09804 <span class="comment"> *  Returns the Encoding of the internal string if conversion is</span>
<a name="l09805"></a>09805 <span class="comment"> *  specified.  Otherwise returns nil.</span>
<a name="l09806"></a>09806 <span class="comment"> */</span>
<a name="l09807"></a>09807 
<a name="l09808"></a>09808 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l09809"></a><a class="code" href="../../df/d0a/io_8c.html#a48ce1fe48cfa72a42f99111bfe1c6077">09809</a> <a class="code" href="../../df/d0a/io_8c.html#a48ce1fe48cfa72a42f99111bfe1c6077">rb_io_internal_encoding</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l09810"></a>09810 {
<a name="l09811"></a>09811     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l09812"></a>09812 
<a name="l09813"></a>09813     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l09814"></a>09814     <span class="keywordflow">if</span> (!fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>.enc2) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l09815"></a>09815     <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(<a class="code" href="../../df/d0a/io_8c.html#aa3b568197b019bda6a9aea4fbe2153eb">io_read_encoding</a>(fptr));
<a name="l09816"></a>09816 }
<a name="l09817"></a>09817 
<a name="l09818"></a>09818 <span class="comment">/*</span>
<a name="l09819"></a>09819 <span class="comment"> *  call-seq:</span>
<a name="l09820"></a>09820 <span class="comment"> *     io.set_encoding(ext_enc)                -&gt; io</span>
<a name="l09821"></a>09821 <span class="comment"> *     io.set_encoding(&quot;ext_enc:int_enc&quot;)      -&gt; io</span>
<a name="l09822"></a>09822 <span class="comment"> *     io.set_encoding(ext_enc, int_enc)       -&gt; io</span>
<a name="l09823"></a>09823 <span class="comment"> *     io.set_encoding(&quot;ext_enc:int_enc&quot;, opt) -&gt; io</span>
<a name="l09824"></a>09824 <span class="comment"> *     io.set_encoding(ext_enc, int_enc, opt)  -&gt; io</span>
<a name="l09825"></a>09825 <span class="comment"> *</span>
<a name="l09826"></a>09826 <span class="comment"> *  If single argument is specified, read string from io is tagged</span>
<a name="l09827"></a>09827 <span class="comment"> *  with the encoding specified.  If encoding is a colon separated two</span>
<a name="l09828"></a>09828 <span class="comment"> *  encoding names &quot;A:B&quot;, the read string is converted from encoding A</span>
<a name="l09829"></a>09829 <span class="comment"> *  (external encoding) to encoding B (internal encoding), then tagged</span>
<a name="l09830"></a>09830 <span class="comment"> *  with B.  If two arguments are specified, those must be encoding</span>
<a name="l09831"></a>09831 <span class="comment"> *  objects or encoding names, and the first one is the external encoding, and the</span>
<a name="l09832"></a>09832 <span class="comment"> *  second one is the internal encoding.</span>
<a name="l09833"></a>09833 <span class="comment"> *  If the external encoding and the internal encoding is specified,</span>
<a name="l09834"></a>09834 <span class="comment"> *  optional hash argument specify the conversion option.</span>
<a name="l09835"></a>09835 <span class="comment"> */</span>
<a name="l09836"></a>09836 
<a name="l09837"></a>09837 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l09838"></a><a class="code" href="../../df/d0a/io_8c.html#ababeae37e439326a1f3e7685063df707">09838</a> <a class="code" href="../../df/d0a/io_8c.html#ababeae37e439326a1f3e7685063df707">rb_io_set_encoding</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> io)
<a name="l09839"></a>09839 {
<a name="l09840"></a>09840     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l09841"></a>09841     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v1, v2, opt;
<a name="l09842"></a>09842 
<a name="l09843"></a>09843     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(io) != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a>) {
<a name="l09844"></a>09844         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#adafa8fd17636821445380e7e1881355e" title="Calls a method.">rb_funcall2</a>(io, <a class="code" href="../../df/d0a/io_8c.html#a666eb54f6ebe3c9e4220669471fe098c">id_set_encoding</a>, argc, argv);
<a name="l09845"></a>09845     }
<a name="l09846"></a>09846 
<a name="l09847"></a>09847     argc = <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;11:&quot;</span>, &amp;v1, &amp;v2, &amp;opt);
<a name="l09848"></a>09848     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(io, fptr);
<a name="l09849"></a>09849     <a class="code" href="../../df/d0a/io_8c.html#a5a1a8cba1be8081b15952fa0945a1692">io_encoding_set</a>(fptr, v1, v2, opt);
<a name="l09850"></a>09850     <span class="keywordflow">return</span> io;
<a name="l09851"></a>09851 }
<a name="l09852"></a>09852 
<a name="l09853"></a>09853 <span class="keywordtype">void</span>
<a name="l09854"></a><a class="code" href="../../df/d0a/io_8c.html#a88e07bc6eaf013e80242a1740e56c9a0">09854</a> <a class="code" href="../../df/d0a/io_8c.html#a88e07bc6eaf013e80242a1740e56c9a0">rb_stdio_set_default_encoding</a>(<span class="keywordtype">void</span>)
<a name="l09855"></a>09855 {
<a name="l09856"></a>09856     <span class="keyword">extern</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afafc64c52c6ab49dbc5699da872cad03">rb_stdin</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1bc7a47b6913bb55b64d881d19da4d03">rb_stderr</a>;
<a name="l09857"></a>09857     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l09858"></a>09858 
<a name="l09859"></a>09859     <a class="code" href="../../df/d0a/io_8c.html#ababeae37e439326a1f3e7685063df707">rb_io_set_encoding</a>(1, &amp;val, rb_stdin);
<a name="l09860"></a>09860     <a class="code" href="../../df/d0a/io_8c.html#ababeae37e439326a1f3e7685063df707">rb_io_set_encoding</a>(1, &amp;val, rb_stdout);
<a name="l09861"></a>09861     <a class="code" href="../../df/d0a/io_8c.html#ababeae37e439326a1f3e7685063df707">rb_io_set_encoding</a>(1, &amp;val, rb_stderr);
<a name="l09862"></a>09862 }
<a name="l09863"></a>09863 
<a name="l09864"></a>09864 <span class="comment">/*</span>
<a name="l09865"></a>09865 <span class="comment"> *  call-seq:</span>
<a name="l09866"></a>09866 <span class="comment"> *     ARGF.external_encoding   -&gt; encoding</span>
<a name="l09867"></a>09867 <span class="comment"> *</span>
<a name="l09868"></a>09868 <span class="comment"> *  Returns the external encoding for files read from +ARGF+ as an +Encoding+</span>
<a name="l09869"></a>09869 <span class="comment"> *  object. The external encoding is the encoding of the text as stored in a</span>
<a name="l09870"></a>09870 <span class="comment"> *  file. Contrast with +ARGF.internal_encoding+, which is the encoding used</span>
<a name="l09871"></a>09871 <span class="comment"> *  to represent this text within Ruby.</span>
<a name="l09872"></a>09872 <span class="comment"> *</span>
<a name="l09873"></a>09873 <span class="comment"> *  To set the external encoding use +ARGF.set_encoding+.</span>
<a name="l09874"></a>09874 <span class="comment"> *</span>
<a name="l09875"></a>09875 <span class="comment"> * For example:</span>
<a name="l09876"></a>09876 <span class="comment"> *</span>
<a name="l09877"></a>09877 <span class="comment"> *     ARGF.external_encoding  #=&gt;  #&lt;Encoding:UTF-8&gt;</span>
<a name="l09878"></a>09878 <span class="comment"> *</span>
<a name="l09879"></a>09879 <span class="comment"> */</span>
<a name="l09880"></a>09880 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l09881"></a><a class="code" href="../../df/d0a/io_8c.html#abffb821e6d243b7a716294f200c0a575">09881</a> <a class="code" href="../../df/d0a/io_8c.html#abffb821e6d243b7a716294f200c0a575">argf_external_encoding</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l09882"></a>09882 {
<a name="l09883"></a>09883     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file)) {
<a name="l09884"></a>09884         <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(<a class="code" href="../../d5/db5/encoding_8c.html#a0724183879562529f7d3365ef5115b6d">rb_default_external_encoding</a>());
<a name="l09885"></a>09885     }
<a name="l09886"></a>09886     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#af2d7a69851929321fc9353de62e3f363">rb_io_external_encoding</a>(<a class="code" href="../../df/d0a/io_8c.html#ab5d27e6f0fb8f238d3ab912a34316563">rb_io_check_io</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file));
<a name="l09887"></a>09887 }
<a name="l09888"></a>09888 
<a name="l09889"></a>09889 <span class="comment">/*</span>
<a name="l09890"></a>09890 <span class="comment"> *  call-seq:</span>
<a name="l09891"></a>09891 <span class="comment"> *     ARGF.internal_encoding   -&gt; encoding</span>
<a name="l09892"></a>09892 <span class="comment"> *</span>
<a name="l09893"></a>09893 <span class="comment"> *  Returns the internal encoding for strings read from +ARGF+ as an</span>
<a name="l09894"></a>09894 <span class="comment"> *  +Encoding+ object.</span>
<a name="l09895"></a>09895 <span class="comment"> *</span>
<a name="l09896"></a>09896 <span class="comment"> *  If +ARGF.set_encoding+ has been called with two encoding names, the second</span>
<a name="l09897"></a>09897 <span class="comment"> *  is returned. Otherwise, if +Encoding.default_external+ has been set, that</span>
<a name="l09898"></a>09898 <span class="comment"> *  value is returned. Failing that, if a default external encoding was</span>
<a name="l09899"></a>09899 <span class="comment"> *  specified on the command-line, that value is used. If the encoding is</span>
<a name="l09900"></a>09900 <span class="comment"> *  unknown, nil is returned.</span>
<a name="l09901"></a>09901 <span class="comment"> */</span>
<a name="l09902"></a>09902 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l09903"></a><a class="code" href="../../df/d0a/io_8c.html#a67784196b0000caf3ce7c411c39aaa0e">09903</a> <a class="code" href="../../df/d0a/io_8c.html#a67784196b0000caf3ce7c411c39aaa0e">argf_internal_encoding</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l09904"></a>09904 {
<a name="l09905"></a>09905     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file)) {
<a name="l09906"></a>09906         <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(<a class="code" href="../../d5/db5/encoding_8c.html#a0724183879562529f7d3365ef5115b6d">rb_default_external_encoding</a>());
<a name="l09907"></a>09907     }
<a name="l09908"></a>09908     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a48ce1fe48cfa72a42f99111bfe1c6077">rb_io_internal_encoding</a>(<a class="code" href="../../df/d0a/io_8c.html#ab5d27e6f0fb8f238d3ab912a34316563">rb_io_check_io</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file));
<a name="l09909"></a>09909 }
<a name="l09910"></a>09910 
<a name="l09911"></a>09911 <span class="comment">/*</span>
<a name="l09912"></a>09912 <span class="comment"> *  call-seq:</span>
<a name="l09913"></a>09913 <span class="comment"> *     ARGF.set_encoding(ext_enc)                -&gt; ARGF</span>
<a name="l09914"></a>09914 <span class="comment"> *     ARGF.set_encoding(&quot;ext_enc:int_enc&quot;)      -&gt; ARGF</span>
<a name="l09915"></a>09915 <span class="comment"> *     ARGF.set_encoding(ext_enc, int_enc)       -&gt; ARGF</span>
<a name="l09916"></a>09916 <span class="comment"> *     ARGF.set_encoding(&quot;ext_enc:int_enc&quot;, opt) -&gt; ARGF</span>
<a name="l09917"></a>09917 <span class="comment"> *     ARGF.set_encoding(ext_enc, int_enc, opt)  -&gt; ARGF</span>
<a name="l09918"></a>09918 <span class="comment"> *</span>
<a name="l09919"></a>09919 <span class="comment"> *  If single argument is specified, strings read from ARGF are tagged with</span>
<a name="l09920"></a>09920 <span class="comment"> *  the encoding specified.</span>
<a name="l09921"></a>09921 <span class="comment"> *</span>
<a name="l09922"></a>09922 <span class="comment"> *  If two encoding names separated by a colon are given, e.g. &quot;ascii:utf-8&quot;,</span>
<a name="l09923"></a>09923 <span class="comment"> *  the read string is converted from the first encoding (external encoding)</span>
<a name="l09924"></a>09924 <span class="comment"> *  to the second encoding (internal encoding), then tagged with the second</span>
<a name="l09925"></a>09925 <span class="comment"> *  encoding.</span>
<a name="l09926"></a>09926 <span class="comment"> *</span>
<a name="l09927"></a>09927 <span class="comment"> *  If two arguments are specified, they must be encoding objects or encoding</span>
<a name="l09928"></a>09928 <span class="comment"> *  names. Again, the first specifies the external encoding; the second</span>
<a name="l09929"></a>09929 <span class="comment"> *  specifies the internal encoding.</span>
<a name="l09930"></a>09930 <span class="comment"> *</span>
<a name="l09931"></a>09931 <span class="comment"> *  If the external encoding and the internal encoding are specified, the</span>
<a name="l09932"></a>09932 <span class="comment"> *  optional +Hash+ argument can be used to adjust the conversion process. The</span>
<a name="l09933"></a>09933 <span class="comment"> *  structure of this hash is explained in the +String#encode+ documentation.</span>
<a name="l09934"></a>09934 <span class="comment"> *</span>
<a name="l09935"></a>09935 <span class="comment"> *  For example:</span>
<a name="l09936"></a>09936 <span class="comment"> *</span>
<a name="l09937"></a>09937 <span class="comment"> *      ARGF.set_encoding(&apos;ascii&apos;)         # Tag the input as US-ASCII text</span>
<a name="l09938"></a>09938 <span class="comment"> *      ARGF.set_encoding(Encoding::UTF_8) # Tag the input as UTF-8 text</span>
<a name="l09939"></a>09939 <span class="comment"> *      ARGF.set_encoding(&apos;utf-8&apos;,&apos;ascii&apos;) # Transcode the input from US-ASCII</span>
<a name="l09940"></a>09940 <span class="comment"> *                                         # to UTF-8.</span>
<a name="l09941"></a>09941 <span class="comment"> */</span>
<a name="l09942"></a>09942 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l09943"></a><a class="code" href="../../df/d0a/io_8c.html#ab6f4ad582572dadc3f6d99533dcd8ce9">09943</a> <a class="code" href="../../df/d0a/io_8c.html#ab6f4ad582572dadc3f6d99533dcd8ce9">argf_set_encoding</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l09944"></a>09944 {
<a name="l09945"></a>09945     <a class="code" href="../../dd/d7e/structrb__io__t.html">rb_io_t</a> *fptr;
<a name="l09946"></a>09946 
<a name="l09947"></a>09947     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) {
<a name="l09948"></a>09948         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;no stream to set encoding&quot;</span>);
<a name="l09949"></a>09949     }
<a name="l09950"></a>09950     <a class="code" href="../../df/d0a/io_8c.html#ababeae37e439326a1f3e7685063df707">rb_io_set_encoding</a>(argc, argv, <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l09951"></a>09951     <a class="code" href="../../dc/dac/io_8h.html#aa00f0dca97539a5dd0c4e67ad5be93a3">GetOpenFile</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file, fptr);
<a name="l09952"></a>09952     <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.encs = fptr-&gt;<a class="code" href="../../dd/d7e/structrb__io__t.html#adf64bf1f8a1cb22baf17da43266932cf">encs</a>;
<a name="l09953"></a>09953     <span class="keywordflow">return</span> argf;
<a name="l09954"></a>09954 }
<a name="l09955"></a>09955 
<a name="l09956"></a>09956 <span class="comment">/*</span>
<a name="l09957"></a>09957 <span class="comment"> *  call-seq:</span>
<a name="l09958"></a>09958 <span class="comment"> *     ARGF.tell  -&gt; Integer</span>
<a name="l09959"></a>09959 <span class="comment"> *     ARGF.pos   -&gt; Integer</span>
<a name="l09960"></a>09960 <span class="comment"> *</span>
<a name="l09961"></a>09961 <span class="comment"> *  Returns the current offset (in bytes) of the current file in +ARGF+.</span>
<a name="l09962"></a>09962 <span class="comment"> *</span>
<a name="l09963"></a>09963 <span class="comment"> *     ARGF.pos    #=&gt; 0</span>
<a name="l09964"></a>09964 <span class="comment"> *     ARGF.gets   #=&gt; &quot;This is line one\n&quot;</span>
<a name="l09965"></a>09965 <span class="comment"> *     ARGF.pos    #=&gt; 17</span>
<a name="l09966"></a>09966 <span class="comment"> *</span>
<a name="l09967"></a>09967 <span class="comment"> */</span>
<a name="l09968"></a>09968 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l09969"></a><a class="code" href="../../df/d0a/io_8c.html#a3cea62b881dccfdfdda42d1d5e09ef69">09969</a> <a class="code" href="../../df/d0a/io_8c.html#a3cea62b881dccfdfdda42d1d5e09ef69">argf_tell</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l09970"></a>09970 {
<a name="l09971"></a>09971     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) {
<a name="l09972"></a>09972         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;no stream to tell&quot;</span>);
<a name="l09973"></a>09973     }
<a name="l09974"></a>09974     <a class="code" href="../../df/d0a/io_8c.html#a8da8fc8e549d0a75d008086c60557177">ARGF_FORWARD</a>(0, 0);
<a name="l09975"></a>09975     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a9dfbc6591e022d6d91a1590d3a329d79">rb_io_tell</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l09976"></a>09976 }
<a name="l09977"></a>09977 
<a name="l09978"></a>09978 <span class="comment">/*</span>
<a name="l09979"></a>09979 <span class="comment"> *  call-seq:</span>
<a name="l09980"></a>09980 <span class="comment"> *     ARGF.seek(amount, whence=IO::SEEK_SET)  -&gt;  0</span>
<a name="l09981"></a>09981 <span class="comment"> *</span>
<a name="l09982"></a>09982 <span class="comment"> *  Seeks to offset _amount_ (an +Integer+) in the +ARGF+ stream according to</span>
<a name="l09983"></a>09983 <span class="comment"> *  the value of _whence_. See +IO#seek+ for further details.</span>
<a name="l09984"></a>09984 <span class="comment"> */</span>
<a name="l09985"></a>09985 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l09986"></a><a class="code" href="../../df/d0a/io_8c.html#aa11c69ae62e275821eb45207ce26e8b6">09986</a> <a class="code" href="../../df/d0a/io_8c.html#aa11c69ae62e275821eb45207ce26e8b6">argf_seek_m</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l09987"></a>09987 {
<a name="l09988"></a>09988     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) {
<a name="l09989"></a>09989         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;no stream to seek&quot;</span>);
<a name="l09990"></a>09990     }
<a name="l09991"></a>09991     <a class="code" href="../../df/d0a/io_8c.html#a8da8fc8e549d0a75d008086c60557177">ARGF_FORWARD</a>(argc, argv);
<a name="l09992"></a>09992     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a3da22b51f3d8dfd33f72a6640597ffad">rb_io_seek_m</a>(argc, argv, <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l09993"></a>09993 }
<a name="l09994"></a>09994 
<a name="l09995"></a>09995 <span class="comment">/*</span>
<a name="l09996"></a>09996 <span class="comment"> *  call-seq:</span>
<a name="l09997"></a>09997 <span class="comment"> *     ARGF.pos = position  -&gt; Integer</span>
<a name="l09998"></a>09998 <span class="comment"> *</span>
<a name="l09999"></a>09999 <span class="comment"> *  Seeks to the position given by _position_ (in bytes) in +ARGF+.</span>
<a name="l10000"></a>10000 <span class="comment"> *</span>
<a name="l10001"></a>10001 <span class="comment"> *  For example:</span>
<a name="l10002"></a>10002 <span class="comment"> *</span>
<a name="l10003"></a>10003 <span class="comment"> *      ARGF.pos = 17</span>
<a name="l10004"></a>10004 <span class="comment"> *      ARGF.gets   #=&gt; &quot;This is line two\n&quot;</span>
<a name="l10005"></a>10005 <span class="comment"> */</span>
<a name="l10006"></a>10006 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10007"></a><a class="code" href="../../df/d0a/io_8c.html#aa64aa449a44625b35365a99ac681231a">10007</a> <a class="code" href="../../df/d0a/io_8c.html#aa64aa449a44625b35365a99ac681231a">argf_set_pos</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> offset)
<a name="l10008"></a>10008 {
<a name="l10009"></a>10009     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) {
<a name="l10010"></a>10010         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;no stream to set position&quot;</span>);
<a name="l10011"></a>10011     }
<a name="l10012"></a>10012     <a class="code" href="../../df/d0a/io_8c.html#a8da8fc8e549d0a75d008086c60557177">ARGF_FORWARD</a>(1, &amp;offset);
<a name="l10013"></a>10013     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#abbcb6b6b0e2f4b79f198c78c203deea6">rb_io_set_pos</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file, offset);
<a name="l10014"></a>10014 }
<a name="l10015"></a>10015 
<a name="l10016"></a>10016 <span class="comment">/*</span>
<a name="l10017"></a>10017 <span class="comment"> *  call-seq:</span>
<a name="l10018"></a>10018 <span class="comment"> *     ARGF.rewind   -&gt; 0</span>
<a name="l10019"></a>10019 <span class="comment"> *</span>
<a name="l10020"></a>10020 <span class="comment"> *  Positions the current file to the beginning of input, resetting</span>
<a name="l10021"></a>10021 <span class="comment"> *  +ARGF.lineno+ to zero.</span>
<a name="l10022"></a>10022 <span class="comment"> *</span>
<a name="l10023"></a>10023 <span class="comment"> *     ARGF.readline   #=&gt; &quot;This is line one\n&quot;</span>
<a name="l10024"></a>10024 <span class="comment"> *     ARGF.rewind     #=&gt; 0</span>
<a name="l10025"></a>10025 <span class="comment"> *     ARGF.lineno     #=&gt; 0</span>
<a name="l10026"></a>10026 <span class="comment"> *     ARGF.readline   #=&gt; &quot;This is line one\n&quot;</span>
<a name="l10027"></a>10027 <span class="comment"> */</span>
<a name="l10028"></a>10028 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10029"></a><a class="code" href="../../df/d0a/io_8c.html#a1911e4073634bb1da51ae0a5550b304c">10029</a> <a class="code" href="../../df/d0a/io_8c.html#a1911e4073634bb1da51ae0a5550b304c">argf_rewind</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10030"></a>10030 {
<a name="l10031"></a>10031     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) {
<a name="l10032"></a>10032         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;no stream to rewind&quot;</span>);
<a name="l10033"></a>10033     }
<a name="l10034"></a>10034     <a class="code" href="../../df/d0a/io_8c.html#a8da8fc8e549d0a75d008086c60557177">ARGF_FORWARD</a>(0, 0);
<a name="l10035"></a>10035     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a2990bd35f03a7105058cc973bb5d2ce5">rb_io_rewind</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l10036"></a>10036 }
<a name="l10037"></a>10037 
<a name="l10038"></a>10038 <span class="comment">/*</span>
<a name="l10039"></a>10039 <span class="comment"> *  call-seq:</span>
<a name="l10040"></a>10040 <span class="comment"> *     ARGF.fileno    -&gt; fixnum</span>
<a name="l10041"></a>10041 <span class="comment"> *     ARGF.to_i      -&gt; fixnum</span>
<a name="l10042"></a>10042 <span class="comment"> *</span>
<a name="l10043"></a>10043 <span class="comment"> *  Returns an integer representing the numeric file descriptor for</span>
<a name="l10044"></a>10044 <span class="comment"> *  the current file. Raises an +ArgumentError+ if there isn&apos;t a current file.</span>
<a name="l10045"></a>10045 <span class="comment"> *</span>
<a name="l10046"></a>10046 <span class="comment"> *     ARGF.fileno    #=&gt; 3</span>
<a name="l10047"></a>10047 <span class="comment"> */</span>
<a name="l10048"></a>10048 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10049"></a><a class="code" href="../../df/d0a/io_8c.html#a8c6b32e1740fc5d7c1ad700b66f28ec7">10049</a> <a class="code" href="../../df/d0a/io_8c.html#a8c6b32e1740fc5d7c1ad700b66f28ec7">argf_fileno</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10050"></a>10050 {
<a name="l10051"></a>10051     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) {
<a name="l10052"></a>10052         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;no stream&quot;</span>);
<a name="l10053"></a>10053     }
<a name="l10054"></a>10054     <a class="code" href="../../df/d0a/io_8c.html#a8da8fc8e549d0a75d008086c60557177">ARGF_FORWARD</a>(0, 0);
<a name="l10055"></a>10055     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a62dd820b5e3ae52bc5afc5afb5c2f3bd">rb_io_fileno</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l10056"></a>10056 }
<a name="l10057"></a>10057 
<a name="l10058"></a>10058 <span class="comment">/*</span>
<a name="l10059"></a>10059 <span class="comment"> *  call-seq:</span>
<a name="l10060"></a>10060 <span class="comment"> *     ARGF.to_io     -&gt; IO</span>
<a name="l10061"></a>10061 <span class="comment"> *</span>
<a name="l10062"></a>10062 <span class="comment"> *  Returns an +IO+ object representing the current file. This will be a</span>
<a name="l10063"></a>10063 <span class="comment"> *  +File+ object unless the current file is a stream such as STDIN.</span>
<a name="l10064"></a>10064 <span class="comment"> *</span>
<a name="l10065"></a>10065 <span class="comment"> *  For example:</span>
<a name="l10066"></a>10066 <span class="comment"> *</span>
<a name="l10067"></a>10067 <span class="comment"> *     ARGF.to_io    #=&gt; #&lt;File:glark.txt&gt;</span>
<a name="l10068"></a>10068 <span class="comment"> *     ARGF.to_io    #=&gt; #&lt;IO:&lt;STDIN&gt;&gt;</span>
<a name="l10069"></a>10069 <span class="comment"> */</span>
<a name="l10070"></a>10070 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10071"></a><a class="code" href="../../df/d0a/io_8c.html#a64216fcaf7dd3beb5b65efcd7bc239b2">10071</a> <a class="code" href="../../df/d0a/io_8c.html#a64216fcaf7dd3beb5b65efcd7bc239b2">argf_to_io</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10072"></a>10072 {
<a name="l10073"></a>10073     <a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>();
<a name="l10074"></a>10074     <a class="code" href="../../df/d0a/io_8c.html#a8da8fc8e549d0a75d008086c60557177">ARGF_FORWARD</a>(0, 0);
<a name="l10075"></a>10075     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file;
<a name="l10076"></a>10076 }
<a name="l10077"></a>10077 
<a name="l10078"></a>10078 <span class="comment">/*</span>
<a name="l10079"></a>10079 <span class="comment"> *  call-seq:</span>
<a name="l10080"></a>10080 <span class="comment"> *     ARGF.eof?  -&gt; true or false</span>
<a name="l10081"></a>10081 <span class="comment"> *     ARGF.eof   -&gt; true or false</span>
<a name="l10082"></a>10082 <span class="comment"> *</span>
<a name="l10083"></a>10083 <span class="comment"> *  Returns true if the current file in +ARGF+ is at end of file, i.e. it has</span>
<a name="l10084"></a>10084 <span class="comment"> *  no data to read. The stream must be opened for reading or an +IOError+</span>
<a name="l10085"></a>10085 <span class="comment"> *  will be raised.</span>
<a name="l10086"></a>10086 <span class="comment"> *</span>
<a name="l10087"></a>10087 <span class="comment"> *     $ echo &quot;eof&quot; | ruby argf.rb</span>
<a name="l10088"></a>10088 <span class="comment"> *</span>
<a name="l10089"></a>10089 <span class="comment"> *     ARGF.eof?                 #=&gt; false</span>
<a name="l10090"></a>10090 <span class="comment"> *     3.times { ARGF.readchar }</span>
<a name="l10091"></a>10091 <span class="comment"> *     ARGF.eof?                 #=&gt; false</span>
<a name="l10092"></a>10092 <span class="comment"> *     ARGF.readchar             #=&gt; &quot;\n&quot;</span>
<a name="l10093"></a>10093 <span class="comment"> *     ARGF.eof?                 #=&gt; true</span>
<a name="l10094"></a>10094 <span class="comment"> */</span>
<a name="l10095"></a>10095 
<a name="l10096"></a>10096 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10097"></a><a class="code" href="../../df/d0a/io_8c.html#a464d0dfc59239ae72a4f58031f93ff60">10097</a> <a class="code" href="../../df/d0a/io_8c.html#a464d0dfc59239ae72a4f58031f93ff60">argf_eof</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10098"></a>10098 {
<a name="l10099"></a>10099     <a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>();
<a name="l10100"></a>10100     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file)) {
<a name="l10101"></a>10101         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.init_p == 0) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l10102"></a>10102         <a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>();
<a name="l10103"></a>10103         <a class="code" href="../../df/d0a/io_8c.html#a8da8fc8e549d0a75d008086c60557177">ARGF_FORWARD</a>(0, 0);
<a name="l10104"></a>10104         <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#a25dc0631238847713d9cb4ea9bebdb13">rb_io_eof</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file)) {
<a name="l10105"></a>10105             <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l10106"></a>10106         }
<a name="l10107"></a>10107     }
<a name="l10108"></a>10108     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l10109"></a>10109 }
<a name="l10110"></a>10110 
<a name="l10111"></a>10111 <span class="comment">/*</span>
<a name="l10112"></a>10112 <span class="comment"> *  call-seq:</span>
<a name="l10113"></a>10113 <span class="comment"> *     ARGF.read([length [, buffer]])    -&gt; string, buffer, or nil</span>
<a name="l10114"></a>10114 <span class="comment"> *</span>
<a name="l10115"></a>10115 <span class="comment"> *  Reads _length_ bytes from ARGF. The files named on the command line</span>
<a name="l10116"></a>10116 <span class="comment"> *  are concatenated and treated as a single file by this method, so when</span>
<a name="l10117"></a>10117 <span class="comment"> *  called without arguments the contents of this pseudo file are returned in</span>
<a name="l10118"></a>10118 <span class="comment"> *  their entirety.</span>
<a name="l10119"></a>10119 <span class="comment"> *</span>
<a name="l10120"></a>10120 <span class="comment"> *  _length_ must be a non-negative integer or nil. If it is a positive</span>
<a name="l10121"></a>10121 <span class="comment"> *  integer, +read+ tries to read at most _length_ bytes. It returns nil</span>
<a name="l10122"></a>10122 <span class="comment"> *  if an EOF was encountered before anything could be read. Fewer than</span>
<a name="l10123"></a>10123 <span class="comment"> *  _length_ bytes may be returned if an EOF is encountered during the read.</span>
<a name="l10124"></a>10124 <span class="comment"> *</span>
<a name="l10125"></a>10125 <span class="comment"> *  If _length_ is omitted or is _nil_, it reads until EOF. A String is</span>
<a name="l10126"></a>10126 <span class="comment"> *  returned even if EOF is encountered before any data is read.</span>
<a name="l10127"></a>10127 <span class="comment"> *</span>
<a name="l10128"></a>10128 <span class="comment"> *  If _length_ is zero, it returns _&quot;&quot;_.</span>
<a name="l10129"></a>10129 <span class="comment"> *</span>
<a name="l10130"></a>10130 <span class="comment"> *  If the optional _buffer_ argument is present, it must reference a String,</span>
<a name="l10131"></a>10131 <span class="comment"> *  which will receive the data.</span>
<a name="l10132"></a>10132 <span class="comment"> *</span>
<a name="l10133"></a>10133 <span class="comment"> * For example:</span>
<a name="l10134"></a>10134 <span class="comment"> *</span>
<a name="l10135"></a>10135 <span class="comment"> *     $ echo &quot;small&quot; &gt; small.txt</span>
<a name="l10136"></a>10136 <span class="comment"> *     $ echo &quot;large&quot; &gt; large.txt</span>
<a name="l10137"></a>10137 <span class="comment"> *     $ ./glark.rb small.txt large.txt</span>
<a name="l10138"></a>10138 <span class="comment"> *</span>
<a name="l10139"></a>10139 <span class="comment"> *     ARGF.read      #=&gt; &quot;small\nlarge&quot;</span>
<a name="l10140"></a>10140 <span class="comment"> *     ARGF.read(200) #=&gt; &quot;small\nlarge&quot;</span>
<a name="l10141"></a>10141 <span class="comment"> *     ARGF.read(2)   #=&gt; &quot;sm&quot;</span>
<a name="l10142"></a>10142 <span class="comment"> *     ARGF.read(0)   #=&gt; &quot;&quot;</span>
<a name="l10143"></a>10143 <span class="comment"> *</span>
<a name="l10144"></a>10144 <span class="comment"> *  Note that this method behaves like fread() function in C.  If you need the</span>
<a name="l10145"></a>10145 <span class="comment"> *  behavior like read(2) system call, consider +ARGF.readpartial+.</span>
<a name="l10146"></a>10146 <span class="comment"> */</span>
<a name="l10147"></a>10147 
<a name="l10148"></a>10148 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10149"></a><a class="code" href="../../df/d0a/io_8c.html#a1e1d57b782524ac6c23b4514e2d64828">10149</a> <a class="code" href="../../df/d0a/io_8c.html#a1e1d57b782524ac6c23b4514e2d64828">argf_read</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10150"></a>10150 {
<a name="l10151"></a>10151     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> tmp, str, length;
<a name="l10152"></a>10152     <span class="keywordtype">long</span> len = 0;
<a name="l10153"></a>10153 
<a name="l10154"></a>10154     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;02&quot;</span>, &amp;length, &amp;str);
<a name="l10155"></a>10155     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(length)) {
<a name="l10156"></a>10156         len = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(argv[0]);
<a name="l10157"></a>10157     }
<a name="l10158"></a>10158     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str)) {
<a name="l10159"></a>10159         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(str);
<a name="l10160"></a>10160         <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(str,0);
<a name="l10161"></a>10161         argv[1] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l10162"></a>10162     }
<a name="l10163"></a>10163 
<a name="l10164"></a>10164   retry:
<a name="l10165"></a>10165     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) {
<a name="l10166"></a>10166         <span class="keywordflow">return</span> str;
<a name="l10167"></a>10167     }
<a name="l10168"></a>10168     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a504096877bc856601d8eb0853652ecdf">ARGF_GENERIC_INPUT_P</a>()) {
<a name="l10169"></a>10169         tmp = <a class="code" href="../../df/d0a/io_8c.html#a5f27de9c8fe3526f56c9c1760e40c335">argf_forward</a>(argc, argv, argf);
<a name="l10170"></a>10170     }
<a name="l10171"></a>10171     <span class="keywordflow">else</span> {
<a name="l10172"></a>10172         tmp = <a class="code" href="../../df/d0a/io_8c.html#aabba878d4b639aa789e090114d1023f9">io_read</a>(argc, argv, <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l10173"></a>10173     }
<a name="l10174"></a>10174     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str)) str = tmp;
<a name="l10175"></a>10175     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(tmp)) <a class="code" href="../../db/d2e/intern_8h.html#ab592dcd9e193dea76fb0ff58b5d907e4">rb_str_append</a>(str, tmp);
<a name="l10176"></a>10176     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(tmp) || <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(length)) {
<a name="l10177"></a>10177         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p != -1) {
<a name="l10178"></a>10178             <a class="code" href="../../df/d0a/io_8c.html#a6652b476f06e1f58748a525682013b3b">argf_close</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l10179"></a>10179             <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 1;
<a name="l10180"></a>10180             <span class="keywordflow">goto</span> retry;
<a name="l10181"></a>10181         }
<a name="l10182"></a>10182     }
<a name="l10183"></a>10183     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (argc &gt;= 1) {
<a name="l10184"></a>10184         <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str) &lt; len) {
<a name="l10185"></a>10185             len -= <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str);
<a name="l10186"></a>10186             argv[0] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(len);
<a name="l10187"></a>10187             <span class="keywordflow">goto</span> retry;
<a name="l10188"></a>10188         }
<a name="l10189"></a>10189     }
<a name="l10190"></a>10190     <span class="keywordflow">return</span> str;
<a name="l10191"></a>10191 }
<a name="l10192"></a>10192 
<a name="l10193"></a><a class="code" href="../../db/d25/structargf__call__arg.html">10193</a> <span class="keyword">struct </span><a class="code" href="../../db/d25/structargf__call__arg.html">argf_call_arg</a> {
<a name="l10194"></a><a class="code" href="../../db/d25/structargf__call__arg.html#ad177d8166a188e1f179c4ac1bb7819f8">10194</a>     <span class="keywordtype">int</span> <a class="code" href="../../db/d25/structargf__call__arg.html#ad177d8166a188e1f179c4ac1bb7819f8">argc</a>;
<a name="l10195"></a><a class="code" href="../../db/d25/structargf__call__arg.html#aa8acb1f61c52b84a40c13819dbb060f7">10195</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../db/d25/structargf__call__arg.html#aa8acb1f61c52b84a40c13819dbb060f7">argv</a>;
<a name="l10196"></a><a class="code" href="../../db/d25/structargf__call__arg.html#a70d54a1906d216b18dcd858cba537dd9">10196</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>;
<a name="l10197"></a>10197 };
<a name="l10198"></a>10198 
<a name="l10199"></a>10199 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10200"></a><a class="code" href="../../df/d0a/io_8c.html#a2757992f81f3ae9619d99582b30b4843">10200</a> <a class="code" href="../../df/d0a/io_8c.html#a2757992f81f3ae9619d99582b30b4843">argf_forward_call</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l10201"></a>10201 {
<a name="l10202"></a>10202     <span class="keyword">struct </span><a class="code" href="../../db/d25/structargf__call__arg.html">argf_call_arg</a> *p = (<span class="keyword">struct </span><a class="code" href="../../db/d25/structargf__call__arg.html">argf_call_arg</a> *)arg;
<a name="l10203"></a>10203     <a class="code" href="../../df/d0a/io_8c.html#a5f27de9c8fe3526f56c9c1760e40c335">argf_forward</a>(p-&gt;<a class="code" href="../../db/d25/structargf__call__arg.html#ad177d8166a188e1f179c4ac1bb7819f8">argc</a>, p-&gt;<a class="code" href="../../db/d25/structargf__call__arg.html#aa8acb1f61c52b84a40c13819dbb060f7">argv</a>, p-&gt;<a class="code" href="../../db/d25/structargf__call__arg.html#a70d54a1906d216b18dcd858cba537dd9">argf</a>);
<a name="l10204"></a>10204     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l10205"></a>10205 }
<a name="l10206"></a>10206 
<a name="l10207"></a>10207 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../df/d0a/io_8c.html#a9b85a7eb04e0f2a9361740ade7102410">argf_getpartial</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>, <span class="keywordtype">int</span> nonblock);
<a name="l10208"></a>10208 
<a name="l10209"></a>10209 <span class="comment">/*</span>
<a name="l10210"></a>10210 <span class="comment"> *  call-seq:</span>
<a name="l10211"></a>10211 <span class="comment"> *     ARGF.readpartial(maxlen)              -&gt; string</span>
<a name="l10212"></a>10212 <span class="comment"> *     ARGF.readpartial(maxlen, outbuf)      -&gt; outbuf</span>
<a name="l10213"></a>10213 <span class="comment"> *</span>
<a name="l10214"></a>10214 <span class="comment"> *  Reads at most _maxlen_ bytes from the ARGF stream. It blocks only if</span>
<a name="l10215"></a>10215 <span class="comment"> *  +ARGF+ has no data immediately available. If the optional _outbuf_</span>
<a name="l10216"></a>10216 <span class="comment"> *  argument is present, it must reference a String, which will receive the</span>
<a name="l10217"></a>10217 <span class="comment"> *  data. It raises &lt;code&gt;EOFError&lt;/code&gt; on end of file.</span>
<a name="l10218"></a>10218 <span class="comment"> *</span>
<a name="l10219"></a>10219 <span class="comment"> *  +readpartial+ is designed for streams such as pipes, sockets, and ttys. It</span>
<a name="l10220"></a>10220 <span class="comment"> *  blocks only when no data is immediately available. This means that it</span>
<a name="l10221"></a>10221 <span class="comment"> *  blocks only when following all conditions hold:</span>
<a name="l10222"></a>10222 <span class="comment"> *</span>
<a name="l10223"></a>10223 <span class="comment"> *  * The byte buffer in the +IO+ object is empty.</span>
<a name="l10224"></a>10224 <span class="comment"> *  * The content of the stream is empty.</span>
<a name="l10225"></a>10225 <span class="comment"> *  * The stream has not reached EOF.</span>
<a name="l10226"></a>10226 <span class="comment"> *</span>
<a name="l10227"></a>10227 <span class="comment"> *  When +readpartial+ blocks, it waits for data or EOF. If some data is read,</span>
<a name="l10228"></a>10228 <span class="comment"> *  +readpartial+ returns with the data. If EOF is reached, readpartial raises</span>
<a name="l10229"></a>10229 <span class="comment"> *  an +EOFError+.</span>
<a name="l10230"></a>10230 <span class="comment"> *</span>
<a name="l10231"></a>10231 <span class="comment"> *  When +readpartial+ doesn&apos;t block, it returns or raises immediately.  If</span>
<a name="l10232"></a>10232 <span class="comment"> *  the byte buffer is not empty, it returns the data in the buffer. Otherwise, if</span>
<a name="l10233"></a>10233 <span class="comment"> *  the stream has some content, it returns the data in the stream. If the</span>
<a name="l10234"></a>10234 <span class="comment"> *  stream reaches EOF an +EOFError+ is raised.</span>
<a name="l10235"></a>10235 <span class="comment"> */</span>
<a name="l10236"></a>10236 
<a name="l10237"></a>10237 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10238"></a><a class="code" href="../../df/d0a/io_8c.html#aacf9293d88c72e4dd9670e9eb2b1c83a">10238</a> <a class="code" href="../../df/d0a/io_8c.html#aacf9293d88c72e4dd9670e9eb2b1c83a">argf_readpartial</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10239"></a>10239 {
<a name="l10240"></a>10240     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a9b85a7eb04e0f2a9361740ade7102410">argf_getpartial</a>(argc, argv, argf, 0);
<a name="l10241"></a>10241 }
<a name="l10242"></a>10242 
<a name="l10243"></a>10243 <span class="comment">/*</span>
<a name="l10244"></a>10244 <span class="comment"> *  call-seq:</span>
<a name="l10245"></a>10245 <span class="comment"> *     ARGF.read_nonblock(maxlen)              -&gt; string</span>
<a name="l10246"></a>10246 <span class="comment"> *     ARGF.read_nonblock(maxlen, outbuf)      -&gt; outbuf</span>
<a name="l10247"></a>10247 <span class="comment"> *</span>
<a name="l10248"></a>10248 <span class="comment"> *  Reads at most _maxlen_ bytes from the ARGF stream in non-blocking mode.</span>
<a name="l10249"></a>10249 <span class="comment"> */</span>
<a name="l10250"></a>10250 
<a name="l10251"></a>10251 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10252"></a><a class="code" href="../../df/d0a/io_8c.html#a115823c6f877f41e2134fa6de8b8c2e6">10252</a> <a class="code" href="../../df/d0a/io_8c.html#a115823c6f877f41e2134fa6de8b8c2e6">argf_read_nonblock</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10253"></a>10253 {
<a name="l10254"></a>10254     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a9b85a7eb04e0f2a9361740ade7102410">argf_getpartial</a>(argc, argv, argf, 1);
<a name="l10255"></a>10255 }
<a name="l10256"></a>10256 
<a name="l10257"></a>10257 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10258"></a><a class="code" href="../../df/d0a/io_8c.html#a9b85a7eb04e0f2a9361740ade7102410">10258</a> <a class="code" href="../../df/d0a/io_8c.html#a9b85a7eb04e0f2a9361740ade7102410">argf_getpartial</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>, <span class="keywordtype">int</span> nonblock)
<a name="l10259"></a>10259 {
<a name="l10260"></a>10260     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> tmp, str, length;
<a name="l10261"></a>10261 
<a name="l10262"></a>10262     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;11&quot;</span>, &amp;length, &amp;str);
<a name="l10263"></a>10263     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str)) {
<a name="l10264"></a>10264         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(str);
<a name="l10265"></a>10265         argv[1] = str;
<a name="l10266"></a>10266     }
<a name="l10267"></a>10267 
<a name="l10268"></a>10268     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) {
<a name="l10269"></a>10269         <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(str, 0);
<a name="l10270"></a>10270         <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>();
<a name="l10271"></a>10271     }
<a name="l10272"></a>10272     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a504096877bc856601d8eb0853652ecdf">ARGF_GENERIC_INPUT_P</a>()) {
<a name="l10273"></a>10273         <span class="keyword">struct </span><a class="code" href="../../db/d25/structargf__call__arg.html">argf_call_arg</a> arg;
<a name="l10274"></a>10274         arg.<a class="code" href="../../db/d25/structargf__call__arg.html#ad177d8166a188e1f179c4ac1bb7819f8">argc</a> = argc;
<a name="l10275"></a>10275         arg.<a class="code" href="../../db/d25/structargf__call__arg.html#aa8acb1f61c52b84a40c13819dbb060f7">argv</a> = argv;
<a name="l10276"></a>10276         arg.<a class="code" href="../../db/d25/structargf__call__arg.html#a70d54a1906d216b18dcd858cba537dd9">argf</a> = argf;
<a name="l10277"></a>10277         tmp = <a class="code" href="../../d3/d57/eval_8c.html#a2e28de157b82ffc63ecff4782dba649c">rb_rescue2</a>(<a class="code" href="../../df/d0a/io_8c.html#a2757992f81f3ae9619d99582b30b4843">argf_forward_call</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;arg,
<a name="l10278"></a>10278                          <a class="code" href="../../de/de6/ruby_2ruby_8h.html#af6b7ea8c069561feacdc47f089ce1b7c">RUBY_METHOD_FUNC</a>(0), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a64459141201c6d17c834b04b905a4dc5">rb_eEOFError</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)0);
<a name="l10279"></a>10279     }
<a name="l10280"></a>10280     <span class="keywordflow">else</span> {
<a name="l10281"></a>10281         tmp = <a class="code" href="../../df/d0a/io_8c.html#a76ca56b9974b8eb9840baf8a6a30b146">io_getpartial</a>(argc, argv, <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file, nonblock);
<a name="l10282"></a>10282     }
<a name="l10283"></a>10283     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(tmp)) {
<a name="l10284"></a>10284         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p == -1) {
<a name="l10285"></a>10285             <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>();
<a name="l10286"></a>10286         }
<a name="l10287"></a>10287         <a class="code" href="../../df/d0a/io_8c.html#a6652b476f06e1f58748a525682013b3b">argf_close</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l10288"></a>10288         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 1;
<a name="l10289"></a>10289         <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.argv) == 0)
<a name="l10290"></a>10290             <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>();
<a name="l10291"></a>10291         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(str))
<a name="l10292"></a>10292             str = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l10293"></a>10293         <span class="keywordflow">return</span> str;
<a name="l10294"></a>10294     }
<a name="l10295"></a>10295     <span class="keywordflow">return</span> tmp;
<a name="l10296"></a>10296 }
<a name="l10297"></a>10297 
<a name="l10298"></a>10298 <span class="comment">/*</span>
<a name="l10299"></a>10299 <span class="comment"> *  call-seq:</span>
<a name="l10300"></a>10300 <span class="comment"> *     ARGF.getc  -&gt; String or nil</span>
<a name="l10301"></a>10301 <span class="comment"> *</span>
<a name="l10302"></a>10302 <span class="comment"> *  Reads the next character from +ARGF+ and returns it as a +String+. Returns</span>
<a name="l10303"></a>10303 <span class="comment"> *  +nil+ at the end of the stream.</span>
<a name="l10304"></a>10304 <span class="comment"> *</span>
<a name="l10305"></a>10305 <span class="comment"> *  +ARGF+ treats the files named on the command line as a single file created</span>
<a name="l10306"></a>10306 <span class="comment"> *  by concatenating their contents. After returning the last character of the</span>
<a name="l10307"></a>10307 <span class="comment"> *  first file, it returns the first character of the second file, and so on.</span>
<a name="l10308"></a>10308 <span class="comment"> *</span>
<a name="l10309"></a>10309 <span class="comment"> *  For example:</span>
<a name="l10310"></a>10310 <span class="comment"> *</span>
<a name="l10311"></a>10311 <span class="comment"> *     $ echo &quot;foo&quot; &gt; file</span>
<a name="l10312"></a>10312 <span class="comment"> *     $ ruby argf.rb file</span>
<a name="l10313"></a>10313 <span class="comment"> *</span>
<a name="l10314"></a>10314 <span class="comment"> *     ARGF.getc  #=&gt; &quot;f&quot;</span>
<a name="l10315"></a>10315 <span class="comment"> *     ARGF.getc  #=&gt; &quot;o&quot;</span>
<a name="l10316"></a>10316 <span class="comment"> *     ARGF.getc  #=&gt; &quot;o&quot;</span>
<a name="l10317"></a>10317 <span class="comment"> *     ARGF.getc  #=&gt; &quot;\n&quot;</span>
<a name="l10318"></a>10318 <span class="comment"> *     ARGF.getc  #=&gt; nil</span>
<a name="l10319"></a>10319 <span class="comment"> *     ARGF.getc  #=&gt; nil</span>
<a name="l10320"></a>10320 <span class="comment"> */</span>
<a name="l10321"></a>10321 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10322"></a><a class="code" href="../../df/d0a/io_8c.html#a908a68e8d15e927e47783feef67413a4">10322</a> <a class="code" href="../../df/d0a/io_8c.html#a908a68e8d15e927e47783feef67413a4">argf_getc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10323"></a>10323 {
<a name="l10324"></a>10324     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ch;
<a name="l10325"></a>10325 
<a name="l10326"></a>10326   retry:
<a name="l10327"></a>10327     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l10328"></a>10328     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#a504096877bc856601d8eb0853652ecdf">ARGF_GENERIC_INPUT_P</a>()) {
<a name="l10329"></a>10329         ch = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae3d965c850380a1945152e5d1afa6d3c" title="Calls a method.">rb_funcall3</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;getc&quot;</span>), 0, 0);
<a name="l10330"></a>10330     }
<a name="l10331"></a>10331     <span class="keywordflow">else</span> {
<a name="l10332"></a>10332         ch = <a class="code" href="../../df/d0a/io_8c.html#a970e65fde195f4283b34493c26c74dab">rb_io_getc</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l10333"></a>10333     }
<a name="l10334"></a>10334     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(ch) &amp;&amp; <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p != -1) {
<a name="l10335"></a>10335         <a class="code" href="../../df/d0a/io_8c.html#a6652b476f06e1f58748a525682013b3b">argf_close</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l10336"></a>10336         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 1;
<a name="l10337"></a>10337         <span class="keywordflow">goto</span> retry;
<a name="l10338"></a>10338     }
<a name="l10339"></a>10339 
<a name="l10340"></a>10340     <span class="keywordflow">return</span> ch;
<a name="l10341"></a>10341 }
<a name="l10342"></a>10342 
<a name="l10343"></a>10343 <span class="comment">/*</span>
<a name="l10344"></a>10344 <span class="comment"> *  call-seq:</span>
<a name="l10345"></a>10345 <span class="comment"> *     ARGF.getbyte  -&gt; Fixnum or nil</span>
<a name="l10346"></a>10346 <span class="comment"> *</span>
<a name="l10347"></a>10347 <span class="comment"> *  Gets the next 8-bit byte (0..255) from +ARGF+. Returns +nil+ if called at</span>
<a name="l10348"></a>10348 <span class="comment"> *  the end of the stream.</span>
<a name="l10349"></a>10349 <span class="comment"> *</span>
<a name="l10350"></a>10350 <span class="comment"> *  For example:</span>
<a name="l10351"></a>10351 <span class="comment"> *</span>
<a name="l10352"></a>10352 <span class="comment"> *     $ echo &quot;foo&quot; &gt; file</span>
<a name="l10353"></a>10353 <span class="comment"> *     $ ruby argf.rb file</span>
<a name="l10354"></a>10354 <span class="comment"> *</span>
<a name="l10355"></a>10355 <span class="comment"> *     ARGF.getbyte #=&gt; 102</span>
<a name="l10356"></a>10356 <span class="comment"> *     ARGF.getbyte #=&gt; 111</span>
<a name="l10357"></a>10357 <span class="comment"> *     ARGF.getbyte #=&gt; 111</span>
<a name="l10358"></a>10358 <span class="comment"> *     ARGF.getbyte #=&gt; 10</span>
<a name="l10359"></a>10359 <span class="comment"> *     ARGF.getbyte #=&gt; nil</span>
<a name="l10360"></a>10360 <span class="comment"> */</span>
<a name="l10361"></a>10361 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10362"></a><a class="code" href="../../df/d0a/io_8c.html#a45dcc71a6bac0844ac45766ae20bc72d">10362</a> <a class="code" href="../../df/d0a/io_8c.html#a45dcc71a6bac0844ac45766ae20bc72d">argf_getbyte</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10363"></a>10363 {
<a name="l10364"></a>10364     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ch;
<a name="l10365"></a>10365 
<a name="l10366"></a>10366   retry:
<a name="l10367"></a>10367     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l10368"></a>10368     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file) != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a>) {
<a name="l10369"></a>10369         ch = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae3d965c850380a1945152e5d1afa6d3c" title="Calls a method.">rb_funcall3</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;getbyte&quot;</span>), 0, 0);
<a name="l10370"></a>10370     }
<a name="l10371"></a>10371     <span class="keywordflow">else</span> {
<a name="l10372"></a>10372         ch = <a class="code" href="../../db/d2e/intern_8h.html#a13c20887173177e30ccd7bb42708dc2b">rb_io_getbyte</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l10373"></a>10373     }
<a name="l10374"></a>10374     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(ch) &amp;&amp; <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p != -1) {
<a name="l10375"></a>10375         <a class="code" href="../../df/d0a/io_8c.html#a6652b476f06e1f58748a525682013b3b">argf_close</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l10376"></a>10376         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 1;
<a name="l10377"></a>10377         <span class="keywordflow">goto</span> retry;
<a name="l10378"></a>10378     }
<a name="l10379"></a>10379 
<a name="l10380"></a>10380     <span class="keywordflow">return</span> ch;
<a name="l10381"></a>10381 }
<a name="l10382"></a>10382 
<a name="l10383"></a>10383 <span class="comment">/*</span>
<a name="l10384"></a>10384 <span class="comment"> *  call-seq:</span>
<a name="l10385"></a>10385 <span class="comment"> *     ARGF.readchar  -&gt; String or nil</span>
<a name="l10386"></a>10386 <span class="comment"> *</span>
<a name="l10387"></a>10387 <span class="comment"> *  Reads the next character from +ARGF+ and returns it as a +String+. Raises</span>
<a name="l10388"></a>10388 <span class="comment"> *  an +EOFError+ after the last character of the last file has been read.</span>
<a name="l10389"></a>10389 <span class="comment"> *</span>
<a name="l10390"></a>10390 <span class="comment"> *  For example:</span>
<a name="l10391"></a>10391 <span class="comment"> *</span>
<a name="l10392"></a>10392 <span class="comment"> *     $ echo &quot;foo&quot; &gt; file</span>
<a name="l10393"></a>10393 <span class="comment"> *     $ ruby argf.rb file</span>
<a name="l10394"></a>10394 <span class="comment"> *</span>
<a name="l10395"></a>10395 <span class="comment"> *     ARGF.readchar  #=&gt; &quot;f&quot;</span>
<a name="l10396"></a>10396 <span class="comment"> *     ARGF.readchar  #=&gt; &quot;o&quot;</span>
<a name="l10397"></a>10397 <span class="comment"> *     ARGF.readchar  #=&gt; &quot;o&quot;</span>
<a name="l10398"></a>10398 <span class="comment"> *     ARGF.readchar  #=&gt; &quot;\n&quot;</span>
<a name="l10399"></a>10399 <span class="comment"> *     ARGF.readchar  #=&gt; end of file reached (EOFError)</span>
<a name="l10400"></a>10400 <span class="comment"> */</span>
<a name="l10401"></a>10401 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10402"></a><a class="code" href="../../df/d0a/io_8c.html#ac88435ec99664d0a1828ac2dbb9e1b02">10402</a> <a class="code" href="../../df/d0a/io_8c.html#ac88435ec99664d0a1828ac2dbb9e1b02">argf_readchar</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10403"></a>10403 {
<a name="l10404"></a>10404     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ch;
<a name="l10405"></a>10405 
<a name="l10406"></a>10406   retry:
<a name="l10407"></a>10407     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>();
<a name="l10408"></a>10408     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file) != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0a8afbed81f5fb3930e9d153fbd51737">T_FILE</a>) {
<a name="l10409"></a>10409         ch = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae3d965c850380a1945152e5d1afa6d3c" title="Calls a method.">rb_funcall3</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;getc&quot;</span>), 0, 0);
<a name="l10410"></a>10410     }
<a name="l10411"></a>10411     <span class="keywordflow">else</span> {
<a name="l10412"></a>10412         ch = <a class="code" href="../../df/d0a/io_8c.html#a970e65fde195f4283b34493c26c74dab">rb_io_getc</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l10413"></a>10413     }
<a name="l10414"></a>10414     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(ch) &amp;&amp; <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p != -1) {
<a name="l10415"></a>10415         <a class="code" href="../../df/d0a/io_8c.html#a6652b476f06e1f58748a525682013b3b">argf_close</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l10416"></a>10416         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 1;
<a name="l10417"></a>10417         <span class="keywordflow">goto</span> retry;
<a name="l10418"></a>10418     }
<a name="l10419"></a>10419 
<a name="l10420"></a>10420     <span class="keywordflow">return</span> ch;
<a name="l10421"></a>10421 }
<a name="l10422"></a>10422 
<a name="l10423"></a>10423 <span class="comment">/*</span>
<a name="l10424"></a>10424 <span class="comment"> *  call-seq:</span>
<a name="l10425"></a>10425 <span class="comment"> *     ARGF.readbyte  -&gt; Fixnum</span>
<a name="l10426"></a>10426 <span class="comment"> *</span>
<a name="l10427"></a>10427 <span class="comment"> *  Reads the next 8-bit byte from ARGF and returns it as a +Fixnum+. Raises</span>
<a name="l10428"></a>10428 <span class="comment"> *  an +EOFError+ after the last byte of the last file has been read.</span>
<a name="l10429"></a>10429 <span class="comment"> *</span>
<a name="l10430"></a>10430 <span class="comment"> *  For example:</span>
<a name="l10431"></a>10431 <span class="comment"> *</span>
<a name="l10432"></a>10432 <span class="comment"> *     $ echo &quot;foo&quot; &gt; file</span>
<a name="l10433"></a>10433 <span class="comment"> *     $ ruby argf.rb file</span>
<a name="l10434"></a>10434 <span class="comment"> *</span>
<a name="l10435"></a>10435 <span class="comment"> *     ARGF.readbyte  #=&gt; 102</span>
<a name="l10436"></a>10436 <span class="comment"> *     ARGF.readbyte  #=&gt; 111</span>
<a name="l10437"></a>10437 <span class="comment"> *     ARGF.readbyte  #=&gt; 111</span>
<a name="l10438"></a>10438 <span class="comment"> *     ARGF.readbyte  #=&gt; 10</span>
<a name="l10439"></a>10439 <span class="comment"> *     ARGF.readbyte  #=&gt; end of file reached (EOFError)</span>
<a name="l10440"></a>10440 <span class="comment"> */</span>
<a name="l10441"></a>10441 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10442"></a><a class="code" href="../../df/d0a/io_8c.html#a025432f1251b070cf907afb8a756139a">10442</a> <a class="code" href="../../df/d0a/io_8c.html#a025432f1251b070cf907afb8a756139a">argf_readbyte</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10443"></a>10443 {
<a name="l10444"></a>10444     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> c;
<a name="l10445"></a>10445 
<a name="l10446"></a>10446     <a class="code" href="../../df/d0a/io_8c.html#a2766fd7f47d70bd3aabba7a3c12389e6">NEXT_ARGF_FORWARD</a>(0, 0);
<a name="l10447"></a>10447     c = <a class="code" href="../../df/d0a/io_8c.html#a45dcc71a6bac0844ac45766ae20bc72d">argf_getbyte</a>(argf);
<a name="l10448"></a>10448     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(c)) {
<a name="l10449"></a>10449         <a class="code" href="../../df/d0a/io_8c.html#af29c366cc0b8091e08b0c2f5b32ca59f">rb_eof_error</a>();
<a name="l10450"></a>10450     }
<a name="l10451"></a>10451     <span class="keywordflow">return</span> c;
<a name="l10452"></a>10452 }
<a name="l10453"></a>10453 
<a name="l10454"></a>10454 <span class="comment">/*</span>
<a name="l10455"></a>10455 <span class="comment"> *  call-seq:</span>
<a name="l10456"></a>10456 <span class="comment"> *     ARGF.each(sep=$/)            {|line| block }  -&gt; ARGF</span>
<a name="l10457"></a>10457 <span class="comment"> *     ARGF.each(sep=$/,limit)      {|line| block }  -&gt; ARGF</span>
<a name="l10458"></a>10458 <span class="comment"> *     ARGF.each(...)                                -&gt; an_enumerator</span>
<a name="l10459"></a>10459 <span class="comment"> *</span>
<a name="l10460"></a>10460 <span class="comment"> *     ARGF.each_line(sep=$/)       {|line| block }  -&gt; ARGF</span>
<a name="l10461"></a>10461 <span class="comment"> *     ARGF.each_line(sep=$/,limit) {|line| block }  -&gt; ARGF</span>
<a name="l10462"></a>10462 <span class="comment"> *     ARGF.each_line(...)                           -&gt; an_enumerator</span>
<a name="l10463"></a>10463 <span class="comment"> *</span>
<a name="l10464"></a>10464 <span class="comment"> *     ARGF.lines(sep=$/)           {|line| block }   -&gt; ARGF</span>
<a name="l10465"></a>10465 <span class="comment"> *     ARGF.lines(sep=$/,limit)     {|line| block }   -&gt; ARGF</span>
<a name="l10466"></a>10466 <span class="comment"> *     ARGF.lines(...)                                -&gt; an_enumerator</span>
<a name="l10467"></a>10467 <span class="comment"> *</span>
<a name="l10468"></a>10468 <span class="comment"> *  Returns an enumerator which iterates over each line (separated by _sep_,</span>
<a name="l10469"></a>10469 <span class="comment"> *  which defaults to your platform&apos;s newline character) of each file in</span>
<a name="l10470"></a>10470 <span class="comment"> *  +ARGV+. If a block is supplied, each line in turn will be yielded to the</span>
<a name="l10471"></a>10471 <span class="comment"> *  block, otherwise an enumerator is returned.</span>
<a name="l10472"></a>10472 <span class="comment"> *  The optional _limit_ argument is a +Fixnum+ specifying the maximum</span>
<a name="l10473"></a>10473 <span class="comment"> *  length of each line; longer lines will be split according to this limit.</span>
<a name="l10474"></a>10474 <span class="comment"> *</span>
<a name="l10475"></a>10475 <span class="comment"> *  This method allows you to treat the files supplied on the command line as</span>
<a name="l10476"></a>10476 <span class="comment"> *  a single file consisting of the concatenation of each named file. After</span>
<a name="l10477"></a>10477 <span class="comment"> *  the last line of the first file has been returned, the first line of the</span>
<a name="l10478"></a>10478 <span class="comment"> *  second file is returned. The +ARGF.filename+ and +ARGF.lineno+ methods can</span>
<a name="l10479"></a>10479 <span class="comment"> *  be used to determine the filename and line number, respectively, of the</span>
<a name="l10480"></a>10480 <span class="comment"> *  current line.</span>
<a name="l10481"></a>10481 <span class="comment"> *</span>
<a name="l10482"></a>10482 <span class="comment"> *  For example, the following code prints out each line of each named file</span>
<a name="l10483"></a>10483 <span class="comment"> *  prefixed with its line number, displaying the filename once per file:</span>
<a name="l10484"></a>10484 <span class="comment"> *</span>
<a name="l10485"></a>10485 <span class="comment"> *     ARGF.lines do |line|</span>
<a name="l10486"></a>10486 <span class="comment"> *       puts ARGF.filename if ARGF.lineno == 1</span>
<a name="l10487"></a>10487 <span class="comment"> *       puts &quot;#{ARGF.lineno}: #{line}&quot;</span>
<a name="l10488"></a>10488 <span class="comment"> *     end</span>
<a name="l10489"></a>10489 <span class="comment"> */</span>
<a name="l10490"></a>10490 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10491"></a><a class="code" href="../../df/d0a/io_8c.html#a8db67ab436811670abc562d82cb9b0ab">10491</a> <a class="code" href="../../df/d0a/io_8c.html#a8db67ab436811670abc562d82cb9b0ab">argf_each_line</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10492"></a>10492 {
<a name="l10493"></a>10493     <a class="code" href="../../db/d2e/intern_8h.html#ad174dd963d99ac27a67c8ef9cfa1eb58">RETURN_ENUMERATOR</a>(argf, argc, argv);
<a name="l10494"></a>10494     <span class="keywordflow">for</span> (;;) {
<a name="l10495"></a>10495         <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) <span class="keywordflow">return</span> argf;
<a name="l10496"></a>10496         <a class="code" href="../../d8/d81/ruby__missing_8h.html#a57ef4ad7ebd72a2a8bc8d68e38439db5">rb_block_call</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;each_line&quot;</span>), argc, argv, 0, 0);
<a name="l10497"></a>10497         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 1;
<a name="l10498"></a>10498     }
<a name="l10499"></a>10499 }
<a name="l10500"></a>10500 
<a name="l10501"></a>10501 <span class="comment">/*</span>
<a name="l10502"></a>10502 <span class="comment"> *  call-seq:</span>
<a name="l10503"></a>10503 <span class="comment"> *     ARGF.bytes     {|byte| block }  -&gt; ARGF</span>
<a name="l10504"></a>10504 <span class="comment"> *     ARGF.bytes                      -&gt; an_enumerator</span>
<a name="l10505"></a>10505 <span class="comment"> *</span>
<a name="l10506"></a>10506 <span class="comment"> *     ARGF.each_byte {|byte| block }  -&gt; ARGF</span>
<a name="l10507"></a>10507 <span class="comment"> *     ARGF.each_byte                  -&gt; an_enumerator</span>
<a name="l10508"></a>10508 <span class="comment"> *</span>
<a name="l10509"></a>10509 <span class="comment"> *  Iterates over each byte of each file in +ARGV+.</span>
<a name="l10510"></a>10510 <span class="comment"> *  A byte is returned as a +Fixnum+ in the range 0..255.</span>
<a name="l10511"></a>10511 <span class="comment"> *</span>
<a name="l10512"></a>10512 <span class="comment"> *  This method allows you to treat the files supplied on the command line as</span>
<a name="l10513"></a>10513 <span class="comment"> *  a single file consisting of the concatenation of each named file. After</span>
<a name="l10514"></a>10514 <span class="comment"> *  the last byte of the first file has been returned, the first byte of the</span>
<a name="l10515"></a>10515 <span class="comment"> *  second file is returned. The +ARGF.filename+ method can be used to</span>
<a name="l10516"></a>10516 <span class="comment"> *  determine the filename of the current byte.</span>
<a name="l10517"></a>10517 <span class="comment"> *</span>
<a name="l10518"></a>10518 <span class="comment"> *  If no block is given, an enumerator is returned instead.</span>
<a name="l10519"></a>10519 <span class="comment"> *</span>
<a name="l10520"></a>10520 <span class="comment"> * For example:</span>
<a name="l10521"></a>10521 <span class="comment"> *</span>
<a name="l10522"></a>10522 <span class="comment"> *     ARGF.bytes.to_a  #=&gt; [35, 32, ... 95, 10]</span>
<a name="l10523"></a>10523 <span class="comment"> *</span>
<a name="l10524"></a>10524 <span class="comment"> */</span>
<a name="l10525"></a>10525 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10526"></a><a class="code" href="../../df/d0a/io_8c.html#a6bf3a2d4d2891eb19f7e78cf93b10635">10526</a> <a class="code" href="../../df/d0a/io_8c.html#a6bf3a2d4d2891eb19f7e78cf93b10635">argf_each_byte</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10527"></a>10527 {
<a name="l10528"></a>10528     <a class="code" href="../../db/d2e/intern_8h.html#ad174dd963d99ac27a67c8ef9cfa1eb58">RETURN_ENUMERATOR</a>(argf, 0, 0);
<a name="l10529"></a>10529     <span class="keywordflow">for</span> (;;) {
<a name="l10530"></a>10530         <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) <span class="keywordflow">return</span> argf;
<a name="l10531"></a>10531         <a class="code" href="../../d8/d81/ruby__missing_8h.html#a57ef4ad7ebd72a2a8bc8d68e38439db5">rb_block_call</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;each_byte&quot;</span>), 0, 0, 0, 0);
<a name="l10532"></a>10532         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 1;
<a name="l10533"></a>10533     }
<a name="l10534"></a>10534 }
<a name="l10535"></a>10535 
<a name="l10536"></a>10536 <span class="comment">/*</span>
<a name="l10537"></a>10537 <span class="comment"> *  call-seq:</span>
<a name="l10538"></a>10538 <span class="comment"> *     ARGF.chars      {|char| block }  -&gt; ARGF</span>
<a name="l10539"></a>10539 <span class="comment"> *     ARGF.chars                       -&gt; an_enumerator</span>
<a name="l10540"></a>10540 <span class="comment"> *</span>
<a name="l10541"></a>10541 <span class="comment"> *     ARGF.each_char  {|char| block }  -&gt; ARGF</span>
<a name="l10542"></a>10542 <span class="comment"> *     ARGF.each_char                   -&gt; an_enumerator</span>
<a name="l10543"></a>10543 <span class="comment"> *</span>
<a name="l10544"></a>10544 <span class="comment"> *  Iterates over each character of each file in +ARGF+.</span>
<a name="l10545"></a>10545 <span class="comment"> *</span>
<a name="l10546"></a>10546 <span class="comment"> *  This method allows you to treat the files supplied on the command line as</span>
<a name="l10547"></a>10547 <span class="comment"> *  a single file consisting of the concatenation of each named file. After</span>
<a name="l10548"></a>10548 <span class="comment"> *  the last character of the first file has been returned, the first</span>
<a name="l10549"></a>10549 <span class="comment"> *  character of the second file is returned. The +ARGF.filename+ method can</span>
<a name="l10550"></a>10550 <span class="comment"> *  be used to determine the name of the file in which the current character</span>
<a name="l10551"></a>10551 <span class="comment"> *  appears.</span>
<a name="l10552"></a>10552 <span class="comment"> *</span>
<a name="l10553"></a>10553 <span class="comment"> *  If no block is given, an enumerator is returned instead.</span>
<a name="l10554"></a>10554 <span class="comment"> */</span>
<a name="l10555"></a>10555 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10556"></a><a class="code" href="../../df/d0a/io_8c.html#a07a848069980be1b953edf89bcd3aa2e">10556</a> <a class="code" href="../../df/d0a/io_8c.html#a07a848069980be1b953edf89bcd3aa2e">argf_each_char</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10557"></a>10557 {
<a name="l10558"></a>10558     <a class="code" href="../../db/d2e/intern_8h.html#ad174dd963d99ac27a67c8ef9cfa1eb58">RETURN_ENUMERATOR</a>(argf, 0, 0);
<a name="l10559"></a>10559     <span class="keywordflow">for</span> (;;) {
<a name="l10560"></a>10560         <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>()) <span class="keywordflow">return</span> argf;
<a name="l10561"></a>10561         <a class="code" href="../../d8/d81/ruby__missing_8h.html#a57ef4ad7ebd72a2a8bc8d68e38439db5">rb_block_call</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;each_char&quot;</span>), 0, 0, 0, 0);
<a name="l10562"></a>10562         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 1;
<a name="l10563"></a>10563     }
<a name="l10564"></a>10564 }
<a name="l10565"></a>10565 
<a name="l10566"></a>10566 <span class="comment">/*</span>
<a name="l10567"></a>10567 <span class="comment"> *  call-seq:</span>
<a name="l10568"></a>10568 <span class="comment"> *     ARGF.filename  -&gt; String</span>
<a name="l10569"></a>10569 <span class="comment"> *     ARGF.path      -&gt; String</span>
<a name="l10570"></a>10570 <span class="comment"> *</span>
<a name="l10571"></a>10571 <span class="comment"> *  Returns the current filename. &quot;-&quot; is returned when the current file is</span>
<a name="l10572"></a>10572 <span class="comment"> *  STDIN.</span>
<a name="l10573"></a>10573 <span class="comment"> *</span>
<a name="l10574"></a>10574 <span class="comment"> *  For example:</span>
<a name="l10575"></a>10575 <span class="comment"> *</span>
<a name="l10576"></a>10576 <span class="comment"> *     $ echo &quot;foo&quot; &gt; foo</span>
<a name="l10577"></a>10577 <span class="comment"> *     $ echo &quot;bar&quot; &gt; bar</span>
<a name="l10578"></a>10578 <span class="comment"> *     $ echo &quot;glark&quot; &gt; glark</span>
<a name="l10579"></a>10579 <span class="comment"> *</span>
<a name="l10580"></a>10580 <span class="comment"> *     $ ruby argf.rb foo bar glark</span>
<a name="l10581"></a>10581 <span class="comment"> *</span>
<a name="l10582"></a>10582 <span class="comment"> *     ARGF.filename  #=&gt; &quot;foo&quot;</span>
<a name="l10583"></a>10583 <span class="comment"> *     ARGF.read(5)   #=&gt; &quot;foo\nb&quot;</span>
<a name="l10584"></a>10584 <span class="comment"> *     ARGF.filename  #=&gt; &quot;bar&quot;</span>
<a name="l10585"></a>10585 <span class="comment"> *     ARGF.skip</span>
<a name="l10586"></a>10586 <span class="comment"> *     ARGF.filename  #=&gt; &quot;glark&quot;</span>
<a name="l10587"></a>10587 <span class="comment"> */</span>
<a name="l10588"></a>10588 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10589"></a><a class="code" href="../../df/d0a/io_8c.html#a5be506430f4e6666c2f7a149ee796494">10589</a> <a class="code" href="../../df/d0a/io_8c.html#a5be506430f4e6666c2f7a149ee796494">argf_filename</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10590"></a>10590 {
<a name="l10591"></a>10591     <a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>();
<a name="l10592"></a>10592     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.filename;
<a name="l10593"></a>10593 }
<a name="l10594"></a>10594 
<a name="l10595"></a>10595 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10596"></a><a class="code" href="../../df/d0a/io_8c.html#ab7fc95380f06eaf8a2c5929c56c72773">10596</a> <a class="code" href="../../df/d0a/io_8c.html#ab7fc95380f06eaf8a2c5929c56c72773">argf_filename_getter</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <span class="keywordtype">id</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *var)
<a name="l10597"></a>10597 {
<a name="l10598"></a>10598     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a5be506430f4e6666c2f7a149ee796494">argf_filename</a>(*var);
<a name="l10599"></a>10599 }
<a name="l10600"></a>10600 
<a name="l10601"></a>10601 <span class="comment">/*</span>
<a name="l10602"></a>10602 <span class="comment"> *  call-seq:</span>
<a name="l10603"></a>10603 <span class="comment"> *     ARGF.file  -&gt; IO or File object</span>
<a name="l10604"></a>10604 <span class="comment"> *</span>
<a name="l10605"></a>10605 <span class="comment"> *  Returns the current file as an +IO+ or +File+ object. #&lt;IO:&lt;STDIN&gt;&gt; is</span>
<a name="l10606"></a>10606 <span class="comment"> *  returned when the current file is STDIN.</span>
<a name="l10607"></a>10607 <span class="comment"> *</span>
<a name="l10608"></a>10608 <span class="comment"> *  For example:</span>
<a name="l10609"></a>10609 <span class="comment"> *</span>
<a name="l10610"></a>10610 <span class="comment"> *     $ echo &quot;foo&quot; &gt; foo</span>
<a name="l10611"></a>10611 <span class="comment"> *     $ echo &quot;bar&quot; &gt; bar</span>
<a name="l10612"></a>10612 <span class="comment"> *</span>
<a name="l10613"></a>10613 <span class="comment"> *     $ ruby argf.rb foo bar</span>
<a name="l10614"></a>10614 <span class="comment"> *</span>
<a name="l10615"></a>10615 <span class="comment"> *     ARGF.file      #=&gt; #&lt;File:foo&gt;</span>
<a name="l10616"></a>10616 <span class="comment"> *     ARGF.read(5)   #=&gt; &quot;foo\nb&quot;</span>
<a name="l10617"></a>10617 <span class="comment"> *     ARGF.file      #=&gt; #&lt;File:bar&gt;</span>
<a name="l10618"></a>10618 <span class="comment"> */</span>
<a name="l10619"></a>10619 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10620"></a><a class="code" href="../../df/d0a/io_8c.html#a82ddd43df6e497891ef0208591bd5e42">10620</a> <a class="code" href="../../df/d0a/io_8c.html#a82ddd43df6e497891ef0208591bd5e42">argf_file</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10621"></a>10621 {
<a name="l10622"></a>10622     <a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>();
<a name="l10623"></a>10623     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file;
<a name="l10624"></a>10624 }
<a name="l10625"></a>10625 
<a name="l10626"></a>10626 <span class="comment">/*</span>
<a name="l10627"></a>10627 <span class="comment"> *  call-seq:</span>
<a name="l10628"></a>10628 <span class="comment"> *     ARGF.binmode  -&gt; ARGF</span>
<a name="l10629"></a>10629 <span class="comment"> *</span>
<a name="l10630"></a>10630 <span class="comment"> *  Puts +ARGF+ into binary mode. Once a stream is in binary mode, it cannot</span>
<a name="l10631"></a>10631 <span class="comment"> *  be reset to non-binary mode. This option has the following effects:</span>
<a name="l10632"></a>10632 <span class="comment"> *</span>
<a name="l10633"></a>10633 <span class="comment"> *  *  Newline conversion is disabled.</span>
<a name="l10634"></a>10634 <span class="comment"> *  *  Encoding conversion is disabled.</span>
<a name="l10635"></a>10635 <span class="comment"> *  *  Content is treated as ASCII-8BIT.</span>
<a name="l10636"></a>10636 <span class="comment"> */</span>
<a name="l10637"></a>10637 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10638"></a><a class="code" href="../../df/d0a/io_8c.html#a95d0f53f0a2ecb7f293bba29445c262e">10638</a> <a class="code" href="../../df/d0a/io_8c.html#a95d0f53f0a2ecb7f293bba29445c262e">argf_binmode_m</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10639"></a>10639 {
<a name="l10640"></a>10640     <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.binmode = 1;
<a name="l10641"></a>10641     <a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>();
<a name="l10642"></a>10642     <a class="code" href="../../df/d0a/io_8c.html#a8da8fc8e549d0a75d008086c60557177">ARGF_FORWARD</a>(0, 0);
<a name="l10643"></a>10643     <a class="code" href="../../db/d2e/intern_8h.html#a5e93bb5b5a12f3c6638b443f4e6746b3">rb_io_ascii8bit_binmode</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l10644"></a>10644     <span class="keywordflow">return</span> argf;
<a name="l10645"></a>10645 }
<a name="l10646"></a>10646 
<a name="l10647"></a>10647 <span class="comment">/*</span>
<a name="l10648"></a>10648 <span class="comment"> *  call-seq:</span>
<a name="l10649"></a>10649 <span class="comment"> *     ARGF.binmode?  -&gt; true or false</span>
<a name="l10650"></a>10650 <span class="comment"> *</span>
<a name="l10651"></a>10651 <span class="comment"> *  Returns true if +ARGF+ is being read in binary mode; false otherwise. (To</span>
<a name="l10652"></a>10652 <span class="comment"> *  enable binary mode use +ARGF.binmode+.</span>
<a name="l10653"></a>10653 <span class="comment"> *</span>
<a name="l10654"></a>10654 <span class="comment"> * For example:</span>
<a name="l10655"></a>10655 <span class="comment"> *</span>
<a name="l10656"></a>10656 <span class="comment"> *     ARGF.binmode?  #=&gt; false</span>
<a name="l10657"></a>10657 <span class="comment"> *     ARGF.binmode</span>
<a name="l10658"></a>10658 <span class="comment"> *     ARGF.binmode?  #=&gt; true</span>
<a name="l10659"></a>10659 <span class="comment"> */</span>
<a name="l10660"></a>10660 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10661"></a><a class="code" href="../../df/d0a/io_8c.html#ab9a38b17af7fd653c1c3ca63cdd5b0d1">10661</a> <a class="code" href="../../df/d0a/io_8c.html#ab9a38b17af7fd653c1c3ca63cdd5b0d1">argf_binmode_p</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10662"></a>10662 {
<a name="l10663"></a>10663     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.binmode ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l10664"></a>10664 }
<a name="l10665"></a>10665 
<a name="l10666"></a>10666 <span class="comment">/*</span>
<a name="l10667"></a>10667 <span class="comment"> *  call-seq:</span>
<a name="l10668"></a>10668 <span class="comment"> *     ARGF.skip  -&gt; ARGF</span>
<a name="l10669"></a>10669 <span class="comment"> *</span>
<a name="l10670"></a>10670 <span class="comment"> *  Sets the current file to the next file in ARGV. If there aren&apos;t any more</span>
<a name="l10671"></a>10671 <span class="comment"> *  files it has no effect.</span>
<a name="l10672"></a>10672 <span class="comment"> *</span>
<a name="l10673"></a>10673 <span class="comment"> * For example:</span>
<a name="l10674"></a>10674 <span class="comment"> *</span>
<a name="l10675"></a>10675 <span class="comment"> *     $ ruby argf.rb foo bar</span>
<a name="l10676"></a>10676 <span class="comment"> *     ARGF.filename  #=&gt; &quot;foo&quot;</span>
<a name="l10677"></a>10677 <span class="comment"> *     ARGF.skip</span>
<a name="l10678"></a>10678 <span class="comment"> *     ARGF.filename  #=&gt; &quot;bar&quot;</span>
<a name="l10679"></a>10679 <span class="comment"> */</span>
<a name="l10680"></a>10680 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10681"></a><a class="code" href="../../df/d0a/io_8c.html#ac729aab8be71494ea0fcfe1765e8bd86">10681</a> <a class="code" href="../../df/d0a/io_8c.html#ac729aab8be71494ea0fcfe1765e8bd86">argf_skip</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10682"></a>10682 {
<a name="l10683"></a>10683     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.init_p &amp;&amp; <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p == 0) {
<a name="l10684"></a>10684         <a class="code" href="../../df/d0a/io_8c.html#a6652b476f06e1f58748a525682013b3b">argf_close</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l10685"></a>10685         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 1;
<a name="l10686"></a>10686     }
<a name="l10687"></a>10687     <span class="keywordflow">return</span> argf;
<a name="l10688"></a>10688 }
<a name="l10689"></a>10689 
<a name="l10690"></a>10690 <span class="comment">/*</span>
<a name="l10691"></a>10691 <span class="comment"> *  call-seq:</span>
<a name="l10692"></a>10692 <span class="comment"> *     ARGF.close  -&gt; ARGF</span>
<a name="l10693"></a>10693 <span class="comment"> *</span>
<a name="l10694"></a>10694 <span class="comment"> *  Closes the current file and skips to the next in the stream. Trying to</span>
<a name="l10695"></a>10695 <span class="comment"> *  close a file that has already been closed causes an +IOError+ to be</span>
<a name="l10696"></a>10696 <span class="comment"> *  raised.</span>
<a name="l10697"></a>10697 <span class="comment"> *</span>
<a name="l10698"></a>10698 <span class="comment"> * For example:</span>
<a name="l10699"></a>10699 <span class="comment"> *</span>
<a name="l10700"></a>10700 <span class="comment"> *     $ ruby argf.rb foo bar</span>
<a name="l10701"></a>10701 <span class="comment"> *</span>
<a name="l10702"></a>10702 <span class="comment"> *     ARGF.filename  #=&gt; &quot;foo&quot;</span>
<a name="l10703"></a>10703 <span class="comment"> *     ARGF.close</span>
<a name="l10704"></a>10704 <span class="comment"> *     ARGF.filename  #=&gt; &quot;bar&quot;</span>
<a name="l10705"></a>10705 <span class="comment"> *     ARGF.close</span>
<a name="l10706"></a>10706 <span class="comment"> *     ARGF.close     #=&gt; closed stream (IOError)</span>
<a name="l10707"></a>10707 <span class="comment"> */</span>
<a name="l10708"></a>10708 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10709"></a><a class="code" href="../../df/d0a/io_8c.html#ab5a9d6a5a1d870b3bfb42a7fd5c7e6ce">10709</a> <a class="code" href="../../df/d0a/io_8c.html#ab5a9d6a5a1d870b3bfb42a7fd5c7e6ce">argf_close_m</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10710"></a>10710 {
<a name="l10711"></a>10711     <a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>();
<a name="l10712"></a>10712     <a class="code" href="../../df/d0a/io_8c.html#a6652b476f06e1f58748a525682013b3b">argf_close</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l10713"></a>10713     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p != -1) {
<a name="l10714"></a>10714         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.next_p = 1;
<a name="l10715"></a>10715     }
<a name="l10716"></a>10716     <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.lineno = 0;
<a name="l10717"></a>10717     <span class="keywordflow">return</span> argf;
<a name="l10718"></a>10718 }
<a name="l10719"></a>10719 
<a name="l10720"></a>10720 <span class="comment">/*</span>
<a name="l10721"></a>10721 <span class="comment"> *  call-seq:</span>
<a name="l10722"></a>10722 <span class="comment"> *     ARGF.closed?  -&gt; true or false</span>
<a name="l10723"></a>10723 <span class="comment"> *</span>
<a name="l10724"></a>10724 <span class="comment"> *  Returns _true_ if the current file has been closed; _false_ otherwise. Use</span>
<a name="l10725"></a>10725 <span class="comment"> *  +ARGF.close+ to actually close the current file.</span>
<a name="l10726"></a>10726 <span class="comment"> */</span>
<a name="l10727"></a>10727 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10728"></a><a class="code" href="../../df/d0a/io_8c.html#a5461eac9ab8ff02da5bcb646b25f7bea">10728</a> <a class="code" href="../../df/d0a/io_8c.html#a5461eac9ab8ff02da5bcb646b25f7bea">argf_closed</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10729"></a>10729 {
<a name="l10730"></a>10730     <a class="code" href="../../df/d0a/io_8c.html#a70c27bd6cfc351def1fad47a8eb5ec1c">next_argv</a>();
<a name="l10731"></a>10731     <a class="code" href="../../df/d0a/io_8c.html#a8da8fc8e549d0a75d008086c60557177">ARGF_FORWARD</a>(0, 0);
<a name="l10732"></a>10732     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#add81852a736e6068e5619df3f4e92509">rb_io_closed</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l10733"></a>10733 }
<a name="l10734"></a>10734 
<a name="l10735"></a>10735 <span class="comment">/*</span>
<a name="l10736"></a>10736 <span class="comment"> *  call-seq:</span>
<a name="l10737"></a>10737 <span class="comment"> *     ARGF.to_s  -&gt; String</span>
<a name="l10738"></a>10738 <span class="comment"> *</span>
<a name="l10739"></a>10739 <span class="comment"> *  Returns &quot;ARGF&quot;.</span>
<a name="l10740"></a>10740 <span class="comment"> */</span>
<a name="l10741"></a>10741 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10742"></a><a class="code" href="../../df/d0a/io_8c.html#ae5bebad10738ceab7f5c39e1a1a6079e">10742</a> <a class="code" href="../../df/d0a/io_8c.html#ae5bebad10738ceab7f5c39e1a1a6079e">argf_to_s</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10743"></a>10743 {
<a name="l10744"></a>10744     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;ARGF&quot;</span>);
<a name="l10745"></a>10745 }
<a name="l10746"></a>10746 
<a name="l10747"></a>10747 <span class="comment">/*</span>
<a name="l10748"></a>10748 <span class="comment"> *  call-seq:</span>
<a name="l10749"></a>10749 <span class="comment"> *     ARGF.inplace_mode  -&gt; String</span>
<a name="l10750"></a>10750 <span class="comment"> *</span>
<a name="l10751"></a>10751 <span class="comment"> *  Returns the file extension appended to the names of modified files under</span>
<a name="l10752"></a>10752 <span class="comment"> *  inplace-edit mode. This value can be set using +ARGF.inplace_mode=+ or</span>
<a name="l10753"></a>10753 <span class="comment"> *  passing the +-i+ switch to the Ruby binary.</span>
<a name="l10754"></a>10754 <span class="comment"> */</span>
<a name="l10755"></a>10755 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10756"></a><a class="code" href="../../df/d0a/io_8c.html#a02985834d1074ba27696b8ece4f127ad">10756</a> <a class="code" href="../../df/d0a/io_8c.html#a02985834d1074ba27696b8ece4f127ad">argf_inplace_mode_get</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10757"></a>10757 {
<a name="l10758"></a>10758     <span class="keywordflow">if</span> (!<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l10759"></a>10759     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace);
<a name="l10760"></a>10760 }
<a name="l10761"></a>10761 
<a name="l10762"></a>10762 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10763"></a><a class="code" href="../../df/d0a/io_8c.html#a24d50d92f0d0e536b208a81052c9cbbc">10763</a> <a class="code" href="../../df/d0a/io_8c.html#a24d50d92f0d0e536b208a81052c9cbbc">opt_i_get</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <span class="keywordtype">id</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *var)
<a name="l10764"></a>10764 {
<a name="l10765"></a>10765     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a02985834d1074ba27696b8ece4f127ad">argf_inplace_mode_get</a>(*var);
<a name="l10766"></a>10766 }
<a name="l10767"></a>10767 
<a name="l10768"></a>10768 <span class="comment">/*</span>
<a name="l10769"></a>10769 <span class="comment"> *  call-seq:</span>
<a name="l10770"></a>10770 <span class="comment"> *     ARGF.inplace_mode = ext  -&gt; ARGF</span>
<a name="l10771"></a>10771 <span class="comment"> *</span>
<a name="l10772"></a>10772 <span class="comment"> *  Sets the filename extension for inplace editing mode to the given String.</span>
<a name="l10773"></a>10773 <span class="comment"> *  Each file being edited has this value appended to its filename. The</span>
<a name="l10774"></a>10774 <span class="comment"> *  modified file is saved under this new name.</span>
<a name="l10775"></a>10775 <span class="comment"> *</span>
<a name="l10776"></a>10776 <span class="comment"> *  For example:</span>
<a name="l10777"></a>10777 <span class="comment"> *</span>
<a name="l10778"></a>10778 <span class="comment"> *      $ ruby argf.rb file.txt</span>
<a name="l10779"></a>10779 <span class="comment"> *</span>
<a name="l10780"></a>10780 <span class="comment"> *      ARGF.inplace_mode = &apos;.bak&apos;</span>
<a name="l10781"></a>10781 <span class="comment"> *      ARGF.lines do |line|</span>
<a name="l10782"></a>10782 <span class="comment"> *        print line.sub(&quot;foo&quot;,&quot;bar&quot;)</span>
<a name="l10783"></a>10783 <span class="comment"> *      end</span>
<a name="l10784"></a>10784 <span class="comment"> *</span>
<a name="l10785"></a>10785 <span class="comment"> * Each line of _file.txt_ has the first occurrence of &quot;foo&quot; replaced with</span>
<a name="l10786"></a>10786 <span class="comment"> * &quot;bar&quot;, then the new line is written out to _file.txt.bak_.</span>
<a name="l10787"></a>10787 <span class="comment"> */</span>
<a name="l10788"></a>10788 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10789"></a><a class="code" href="../../df/d0a/io_8c.html#a5c98be2a1d5b392c9b3e97202ee60fdf">10789</a> <a class="code" href="../../df/d0a/io_8c.html#a5c98be2a1d5b392c9b3e97202ee60fdf">argf_inplace_mode_set</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val)
<a name="l10790"></a>10790 {
<a name="l10791"></a>10791     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9d/tcltklib_8c.html#a6f520624fabb8332dc98fd223491bf8d">rb_safe_level</a>() &gt;= 1 &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a621bc62b1fd82640c1078daf90e1c061">OBJ_TAINTED</a>(val))
<a name="l10792"></a>10792         <a class="code" href="../../da/d2d/safe_8c.html#aa044289e0f51478acb5dcd2a7dcddc74">rb_insecure_operation</a>();
<a name="l10793"></a>10793 
<a name="l10794"></a>10794     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(val)) {
<a name="l10795"></a>10795         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace) <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace);
<a name="l10796"></a>10796         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace = 0;
<a name="l10797"></a>10797     }
<a name="l10798"></a>10798     <span class="keywordflow">else</span> {
<a name="l10799"></a>10799         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(val);
<a name="l10800"></a>10800         <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace) <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace);
<a name="l10801"></a>10801         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace = 0;
<a name="l10802"></a>10802         <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace = <a class="code" href="../../d8/d3c/util_8h.html#ad832104a69551cf1e4e347fffa9dc77c">strdup</a>(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(val));
<a name="l10803"></a>10803     }
<a name="l10804"></a>10804     <span class="keywordflow">return</span> argf;
<a name="l10805"></a>10805 }
<a name="l10806"></a>10806 
<a name="l10807"></a>10807 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l10808"></a><a class="code" href="../../df/d0a/io_8c.html#aab66241c74156834b4ed491ccfb494b3">10808</a> <a class="code" href="../../df/d0a/io_8c.html#aab66241c74156834b4ed491ccfb494b3">opt_i_set</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <span class="keywordtype">id</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *var)
<a name="l10809"></a>10809 {
<a name="l10810"></a>10810     <a class="code" href="../../df/d0a/io_8c.html#a5c98be2a1d5b392c9b3e97202ee60fdf">argf_inplace_mode_set</a>(*var, val);
<a name="l10811"></a>10811 }
<a name="l10812"></a>10812 
<a name="l10813"></a>10813 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l10814"></a><a class="code" href="../../df/d0a/io_8c.html#ac776d2fa88cef372b4bdac7a8d085e73">10814</a> <a class="code" href="../../df/d0a/io_8c.html#ac776d2fa88cef372b4bdac7a8d085e73">ruby_get_inplace_mode</a>(<span class="keywordtype">void</span>)
<a name="l10815"></a>10815 {
<a name="l10816"></a>10816     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace;
<a name="l10817"></a>10817 }
<a name="l10818"></a>10818 
<a name="l10819"></a>10819 <span class="keywordtype">void</span>
<a name="l10820"></a><a class="code" href="../../df/d0a/io_8c.html#a33e56a1b137ee7df1e73be6c922dbaee">10820</a> <a class="code" href="../../df/d0a/io_8c.html#a33e56a1b137ee7df1e73be6c922dbaee">ruby_set_inplace_mode</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *suffix)
<a name="l10821"></a>10821 {
<a name="l10822"></a>10822     <span class="keywordflow">if</span> (<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace) <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace);
<a name="l10823"></a>10823     <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace = 0;
<a name="l10824"></a>10824     <span class="keywordflow">if</span> (suffix) <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.inplace = <a class="code" href="../../d8/d3c/util_8h.html#ad832104a69551cf1e4e347fffa9dc77c">strdup</a>(suffix);
<a name="l10825"></a>10825 }
<a name="l10826"></a>10826 
<a name="l10827"></a>10827 <span class="comment">/*</span>
<a name="l10828"></a>10828 <span class="comment"> *  call-seq:</span>
<a name="l10829"></a>10829 <span class="comment"> *     ARGF.argv  -&gt; ARGV</span>
<a name="l10830"></a>10830 <span class="comment"> *</span>
<a name="l10831"></a>10831 <span class="comment"> *  Returns the +ARGV+ array, which contains the arguments passed to your</span>
<a name="l10832"></a>10832 <span class="comment"> *  script, one per element.</span>
<a name="l10833"></a>10833 <span class="comment"> *</span>
<a name="l10834"></a>10834 <span class="comment"> *  For example:</span>
<a name="l10835"></a>10835 <span class="comment"> *</span>
<a name="l10836"></a>10836 <span class="comment"> *      $ ruby argf.rb -v glark.txt</span>
<a name="l10837"></a>10837 <span class="comment"> *</span>
<a name="l10838"></a>10838 <span class="comment"> *      ARGF.argv   #=&gt; [&quot;-v&quot;, &quot;glark.txt&quot;]</span>
<a name="l10839"></a>10839 <span class="comment"> *</span>
<a name="l10840"></a>10840 <span class="comment"> */</span>
<a name="l10841"></a>10841 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10842"></a><a class="code" href="../../df/d0a/io_8c.html#ab08f8bbe4528726cfa413df1e0e443f8">10842</a> <a class="code" href="../../df/d0a/io_8c.html#ab08f8bbe4528726cfa413df1e0e443f8">argf_argv</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10843"></a>10843 {
<a name="l10844"></a>10844     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.argv;
<a name="l10845"></a>10845 }
<a name="l10846"></a>10846 
<a name="l10847"></a>10847 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10848"></a><a class="code" href="../../df/d0a/io_8c.html#a5c76b8282648c1a28cb319d07525ad46">10848</a> <a class="code" href="../../df/d0a/io_8c.html#a5c76b8282648c1a28cb319d07525ad46">argf_argv_getter</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <span class="keywordtype">id</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *var)
<a name="l10849"></a>10849 {
<a name="l10850"></a>10850     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#ab08f8bbe4528726cfa413df1e0e443f8">argf_argv</a>(*var);
<a name="l10851"></a>10851 }
<a name="l10852"></a>10852 
<a name="l10853"></a>10853 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10854"></a><a class="code" href="../../df/d0a/io_8c.html#a0ce5cd73653ff1abc46778c5efe790d5">10854</a> <a class="code" href="../../db/d2e/intern_8h.html#a0ce5cd73653ff1abc46778c5efe790d5">rb_get_argv</a>(<span class="keywordtype">void</span>)
<a name="l10855"></a>10855 {
<a name="l10856"></a>10856     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.argv;
<a name="l10857"></a>10857 }
<a name="l10858"></a>10858 
<a name="l10859"></a>10859 <span class="comment">/*</span>
<a name="l10860"></a>10860 <span class="comment"> *  call-seq:</span>
<a name="l10861"></a>10861 <span class="comment"> *     ARGF.to_write_io  -&gt; io</span>
<a name="l10862"></a>10862 <span class="comment"> *</span>
<a name="l10863"></a>10863 <span class="comment"> *  Returns IO instance tied to _ARGF_ for writing if inplace mode is</span>
<a name="l10864"></a>10864 <span class="comment"> *  enabled.</span>
<a name="l10865"></a>10865 <span class="comment"> */</span>
<a name="l10866"></a>10866 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10867"></a><a class="code" href="../../df/d0a/io_8c.html#ac162a2df5c2a2add4f9c438a0dd4f6c8">10867</a> <a class="code" href="../../df/d0a/io_8c.html#ac162a2df5c2a2add4f9c438a0dd4f6c8">argf_write_io</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>)
<a name="l10868"></a>10868 {
<a name="l10869"></a>10869     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file)) {
<a name="l10870"></a>10870         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>, <span class="stringliteral">&quot;not opened for writing&quot;</span>);
<a name="l10871"></a>10871     }
<a name="l10872"></a>10872     <span class="keywordflow">return</span> <a class="code" href="../../df/d0a/io_8c.html#a899de66e8d05ebafa24186aa461ed010">GetWriteIO</a>(<a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.current_file);
<a name="l10873"></a>10873 }
<a name="l10874"></a>10874 
<a name="l10875"></a>10875 <span class="comment">/*</span>
<a name="l10876"></a>10876 <span class="comment"> *  call-seq:</span>
<a name="l10877"></a>10877 <span class="comment"> *     ARGF.write(string)   -&gt; integer</span>
<a name="l10878"></a>10878 <span class="comment"> *</span>
<a name="l10879"></a>10879 <span class="comment"> *  Writes _string_ if inplace mode.</span>
<a name="l10880"></a>10880 <span class="comment"> */</span>
<a name="l10881"></a>10881 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l10882"></a><a class="code" href="../../df/d0a/io_8c.html#ad9dc04c7dc6e6a7c722f3fe60c48926a">10882</a> <a class="code" href="../../df/d0a/io_8c.html#ad9dc04c7dc6e6a7c722f3fe60c48926a">argf_write</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d05/structargf.html">argf</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str)
<a name="l10883"></a>10883 {
<a name="l10884"></a>10884     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a57f7dccae9fa179bd7a44230ca836cf9">rb_io_write</a>(<a class="code" href="../../df/d0a/io_8c.html#ac162a2df5c2a2add4f9c438a0dd4f6c8">argf_write_io</a>(argf), str);
<a name="l10885"></a>10885 }
<a name="l10886"></a>10886 
<a name="l10887"></a>10887 <span class="comment">/*</span>
<a name="l10888"></a>10888 <span class="comment"> * Document-class: IOError</span>
<a name="l10889"></a>10889 <span class="comment"> *</span>
<a name="l10890"></a>10890 <span class="comment"> * Raised when an IO operation fails.</span>
<a name="l10891"></a>10891 <span class="comment"> *</span>
<a name="l10892"></a>10892 <span class="comment"> *    File.open(&quot;/etc/hosts&quot;) {|f| f &lt;&lt; &quot;example&quot;}</span>
<a name="l10893"></a>10893 <span class="comment"> *      #=&gt; IOError: not opened for writing</span>
<a name="l10894"></a>10894 <span class="comment"> *</span>
<a name="l10895"></a>10895 <span class="comment"> *    File.open(&quot;/etc/hosts&quot;) {|f| f.close; f.read }</span>
<a name="l10896"></a>10896 <span class="comment"> *      #=&gt; IOError: closed stream</span>
<a name="l10897"></a>10897 <span class="comment"> *</span>
<a name="l10898"></a>10898 <span class="comment"> * Note that some IO failures raise +SystemCallError+s and these are not</span>
<a name="l10899"></a>10899 <span class="comment"> * subclasses of IOError:</span>
<a name="l10900"></a>10900 <span class="comment"> *</span>
<a name="l10901"></a>10901 <span class="comment"> *    File.open(&quot;does/not/exist&quot;)</span>
<a name="l10902"></a>10902 <span class="comment"> *      #=&gt; Errno::ENOENT: No such file or directory - does/not/exist</span>
<a name="l10903"></a>10903 <span class="comment"> */</span>
<a name="l10904"></a>10904 
<a name="l10905"></a>10905 <span class="comment">/*</span>
<a name="l10906"></a>10906 <span class="comment"> * Document-class: EOFError</span>
<a name="l10907"></a>10907 <span class="comment"> *</span>
<a name="l10908"></a>10908 <span class="comment"> * Raised by some IO operations when reaching the end of file. Many IO</span>
<a name="l10909"></a>10909 <span class="comment"> * methods exist in two forms,</span>
<a name="l10910"></a>10910 <span class="comment"> *</span>
<a name="l10911"></a>10911 <span class="comment"> * one that returns +nil+ when the end of file is reached, the other</span>
<a name="l10912"></a>10912 <span class="comment"> * raises EOFError +EOFError+.</span>
<a name="l10913"></a>10913 <span class="comment"> *</span>
<a name="l10914"></a>10914 <span class="comment"> * +EOFError+ is a subclass of +IOError+.</span>
<a name="l10915"></a>10915 <span class="comment"> *</span>
<a name="l10916"></a>10916 <span class="comment"> *    file = File.open(&quot;/etc/hosts&quot;)</span>
<a name="l10917"></a>10917 <span class="comment"> *    file.read</span>
<a name="l10918"></a>10918 <span class="comment"> *    file.gets     #=&gt; nil</span>
<a name="l10919"></a>10919 <span class="comment"> *    file.readline #=&gt; EOFError: end of file reached</span>
<a name="l10920"></a>10920 <span class="comment"> */</span>
<a name="l10921"></a>10921 
<a name="l10922"></a>10922 <span class="comment">/*</span>
<a name="l10923"></a>10923 <span class="comment"> * Document-class:  ARGF</span>
<a name="l10924"></a>10924 <span class="comment"> *</span>
<a name="l10925"></a>10925 <span class="comment"> * +ARGF+ is a stream designed for use in scripts that process files given as</span>
<a name="l10926"></a>10926 <span class="comment"> * command-line arguments or passed in via STDIN.</span>
<a name="l10927"></a>10927 <span class="comment"> *</span>
<a name="l10928"></a>10928 <span class="comment"> * The arguments passed to your script are stored in the +ARGV+ Array, one</span>
<a name="l10929"></a>10929 <span class="comment"> * argument per element. +ARGF+ assumes that any arguments that aren&apos;t</span>
<a name="l10930"></a>10930 <span class="comment"> * filenames have been removed from +ARGV+. For example:</span>
<a name="l10931"></a>10931 <span class="comment"> *</span>
<a name="l10932"></a>10932 <span class="comment"> *     $ ruby argf.rb --verbose file1 file2</span>
<a name="l10933"></a>10933 <span class="comment"> *</span>
<a name="l10934"></a>10934 <span class="comment"> *     ARGV  #=&gt; [&quot;--verbose&quot;, &quot;file1&quot;, &quot;file2&quot;]</span>
<a name="l10935"></a>10935 <span class="comment"> *     option = ARGV.shift #=&gt; &quot;--verbose&quot;</span>
<a name="l10936"></a>10936 <span class="comment"> *     ARGV  #=&gt; [&quot;file1&quot;, &quot;file2&quot;]</span>
<a name="l10937"></a>10937 <span class="comment"> *</span>
<a name="l10938"></a>10938 <span class="comment"> * You can now use +ARGF+ to work with a concatenation of each of these named</span>
<a name="l10939"></a>10939 <span class="comment"> * files. For instance, +ARGF.read+ will return the contents of _file1_</span>
<a name="l10940"></a>10940 <span class="comment"> * followed by the contents of _file2_.</span>
<a name="l10941"></a>10941 <span class="comment"> *</span>
<a name="l10942"></a>10942 <span class="comment"> * After a file in +ARGV+ has been read +ARGF+ removes it from the Array.</span>
<a name="l10943"></a>10943 <span class="comment"> * Thus, after all files have been read +ARGV+ will be empty.</span>
<a name="l10944"></a>10944 <span class="comment"> *</span>
<a name="l10945"></a>10945 <span class="comment"> * You can manipulate +ARGV+ yourself to control what +ARGF+ operates on. If</span>
<a name="l10946"></a>10946 <span class="comment"> * you remove a file from +ARGV+, it is ignored by +ARGF+; if you add files to</span>
<a name="l10947"></a>10947 <span class="comment"> * +ARGV+, they are treated as if they were named on the command line. For</span>
<a name="l10948"></a>10948 <span class="comment"> * example:</span>
<a name="l10949"></a>10949 <span class="comment"> *</span>
<a name="l10950"></a>10950 <span class="comment"> *     ARGV.replace [&quot;file1&quot;]</span>
<a name="l10951"></a>10951 <span class="comment"> *     ARGF.readlines # Returns the contents of file1 as an Array</span>
<a name="l10952"></a>10952 <span class="comment"> *     ARGV           #=&gt; []</span>
<a name="l10953"></a>10953 <span class="comment"> *     ARGV.replace [&quot;file2&quot;, &quot;file3&quot;]</span>
<a name="l10954"></a>10954 <span class="comment"> *     ARGF.read      # Returns the contents of file2 and file3</span>
<a name="l10955"></a>10955 <span class="comment"> *</span>
<a name="l10956"></a>10956 <span class="comment"> * If +ARGV+ is empty, +ARGF+ acts as if it contained STDIN, i.e. the data</span>
<a name="l10957"></a>10957 <span class="comment"> * piped to your script. For example:</span>
<a name="l10958"></a>10958 <span class="comment"> *</span>
<a name="l10959"></a>10959 <span class="comment"> *     $ echo &quot;glark&quot; | ruby -e &apos;p ARGF.read&apos;</span>
<a name="l10960"></a>10960 <span class="comment"> *     &quot;glark\n&quot;</span>
<a name="l10961"></a>10961 <span class="comment"> */</span>
<a name="l10962"></a>10962 
<a name="l10963"></a>10963 <span class="comment">/*</span>
<a name="l10964"></a>10964 <span class="comment"> *  Class &lt;code&gt;IO&lt;/code&gt; is the basis for all input and output in Ruby.</span>
<a name="l10965"></a>10965 <span class="comment"> *  An I/O stream may be &lt;em&gt;duplexed&lt;/em&gt; (that is, bidirectional), and</span>
<a name="l10966"></a>10966 <span class="comment"> *  so may use more than one native operating system stream.</span>
<a name="l10967"></a>10967 <span class="comment"> *</span>
<a name="l10968"></a>10968 <span class="comment"> *  Many of the examples in this section use class &lt;code&gt;File&lt;/code&gt;,</span>
<a name="l10969"></a>10969 <span class="comment"> *  the only standard subclass of &lt;code&gt;IO&lt;/code&gt;. The two classes are</span>
<a name="l10970"></a>10970 <span class="comment"> *  closely associated.</span>
<a name="l10971"></a>10971 <span class="comment"> *</span>
<a name="l10972"></a>10972 <span class="comment"> *  As used in this section, &lt;em&gt;portname&lt;/em&gt; may take any of the</span>
<a name="l10973"></a>10973 <span class="comment"> *  following forms.</span>
<a name="l10974"></a>10974 <span class="comment"> *</span>
<a name="l10975"></a>10975 <span class="comment"> *  * A plain string represents a filename suitable for the underlying</span>
<a name="l10976"></a>10976 <span class="comment"> *    operating system.</span>
<a name="l10977"></a>10977 <span class="comment"> *</span>
<a name="l10978"></a>10978 <span class="comment"> *  * A string starting with ``&lt;code&gt;|&lt;/code&gt;&apos;&apos; indicates a subprocess.</span>
<a name="l10979"></a>10979 <span class="comment"> *    The remainder of the string following the ``&lt;code&gt;|&lt;/code&gt;&apos;&apos; is</span>
<a name="l10980"></a>10980 <span class="comment"> *    invoked as a process with appropriate input/output channels</span>
<a name="l10981"></a>10981 <span class="comment"> *    connected to it.</span>
<a name="l10982"></a>10982 <span class="comment"> *</span>
<a name="l10983"></a>10983 <span class="comment"> *  * A string equal to ``&lt;code&gt;|-&lt;/code&gt;&apos;&apos; will create another Ruby</span>
<a name="l10984"></a>10984 <span class="comment"> *    instance as a subprocess.</span>
<a name="l10985"></a>10985 <span class="comment"> *</span>
<a name="l10986"></a>10986 <span class="comment"> *  Ruby will convert pathnames between different operating system</span>
<a name="l10987"></a>10987 <span class="comment"> *  conventions if possible. For instance, on a Windows system the</span>
<a name="l10988"></a>10988 <span class="comment"> *  filename ``&lt;code&gt;/gumby/ruby/test.rb&lt;/code&gt;&apos;&apos; will be opened as</span>
<a name="l10989"></a>10989 <span class="comment"> *  ``&lt;code&gt;\gumby\ruby\test.rb&lt;/code&gt;&apos;&apos;. When specifying a</span>
<a name="l10990"></a>10990 <span class="comment"> *  Windows-style filename in a Ruby string, remember to escape the</span>
<a name="l10991"></a>10991 <span class="comment"> *  backslashes:</span>
<a name="l10992"></a>10992 <span class="comment"> *</span>
<a name="l10993"></a>10993 <span class="comment"> *     &quot;c:\\gumby\\ruby\\test.rb&quot;</span>
<a name="l10994"></a>10994 <span class="comment"> *</span>
<a name="l10995"></a>10995 <span class="comment"> *  Our examples here will use the Unix-style forward slashes;</span>
<a name="l10996"></a>10996 <span class="comment"> *  &lt;code&gt;File::SEPARATOR&lt;/code&gt; can be used to get the</span>
<a name="l10997"></a>10997 <span class="comment"> *  platform-specific separator character.</span>
<a name="l10998"></a>10998 <span class="comment"> *</span>
<a name="l10999"></a>10999 <span class="comment"> *  I/O ports may be opened in any one of several different modes, which</span>
<a name="l11000"></a>11000 <span class="comment"> *  are shown in this section as &lt;em&gt;mode&lt;/em&gt;. The mode may</span>
<a name="l11001"></a>11001 <span class="comment"> *  either be a Fixnum or a String. If numeric, it should be</span>
<a name="l11002"></a>11002 <span class="comment"> *  one of the operating system specific constants (O_RDONLY,</span>
<a name="l11003"></a>11003 <span class="comment"> *  O_WRONLY, O_RDWR, O_APPEND and so on). See man open(2) for</span>
<a name="l11004"></a>11004 <span class="comment"> *  more information.</span>
<a name="l11005"></a>11005 <span class="comment"> *</span>
<a name="l11006"></a>11006 <span class="comment"> *  If the mode is given as a String, it must be one of the</span>
<a name="l11007"></a>11007 <span class="comment"> *  values listed in the following table.</span>
<a name="l11008"></a>11008 <span class="comment"> *</span>
<a name="l11009"></a>11009 <span class="comment"> *    Mode |  Meaning</span>
<a name="l11010"></a>11010 <span class="comment"> *    -----+--------------------------------------------------------</span>
<a name="l11011"></a>11011 <span class="comment"> *    &quot;r&quot;  |  Read-only, starts at beginning of file  (default mode).</span>
<a name="l11012"></a>11012 <span class="comment"> *    -----+--------------------------------------------------------</span>
<a name="l11013"></a>11013 <span class="comment"> *    &quot;r+&quot; |  Read-write, starts at beginning of file.</span>
<a name="l11014"></a>11014 <span class="comment"> *    -----+--------------------------------------------------------</span>
<a name="l11015"></a>11015 <span class="comment"> *    &quot;w&quot;  |  Write-only, truncates existing file</span>
<a name="l11016"></a>11016 <span class="comment"> *         |  to zero length or creates a new file for writing.</span>
<a name="l11017"></a>11017 <span class="comment"> *    -----+--------------------------------------------------------</span>
<a name="l11018"></a>11018 <span class="comment"> *    &quot;w+&quot; |  Read-write, truncates existing file to zero length</span>
<a name="l11019"></a>11019 <span class="comment"> *         |  or creates a new file for reading and writing.</span>
<a name="l11020"></a>11020 <span class="comment"> *    -----+--------------------------------------------------------</span>
<a name="l11021"></a>11021 <span class="comment"> *    &quot;a&quot;  |  Write-only, starts at end of file if file exists,</span>
<a name="l11022"></a>11022 <span class="comment"> *         |  otherwise creates a new file for writing.</span>
<a name="l11023"></a>11023 <span class="comment"> *    -----+--------------------------------------------------------</span>
<a name="l11024"></a>11024 <span class="comment"> *    &quot;a+&quot; |  Read-write, starts at end of file if file exists,</span>
<a name="l11025"></a>11025 <span class="comment"> *         |  otherwise creates a new file for reading and</span>
<a name="l11026"></a>11026 <span class="comment"> *         |  writing.</span>
<a name="l11027"></a>11027 <span class="comment"> *    -----+--------------------------------------------------------</span>
<a name="l11028"></a>11028 <span class="comment"> *     &quot;b&quot; |  Binary file mode (may appear with</span>
<a name="l11029"></a>11029 <span class="comment"> *         |  any of the key letters listed above).</span>
<a name="l11030"></a>11030 <span class="comment"> *         |  Suppresses EOL &lt;-&gt; CRLF conversion on Windows. And</span>
<a name="l11031"></a>11031 <span class="comment"> *         |  sets external encoding to ASCII-8BIT unless explicitly</span>
<a name="l11032"></a>11032 <span class="comment"> *         |  specified.</span>
<a name="l11033"></a>11033 <span class="comment"> *    -----+--------------------------------------------------------</span>
<a name="l11034"></a>11034 <span class="comment"> *     &quot;t&quot; |  Text file mode (may appear with</span>
<a name="l11035"></a>11035 <span class="comment"> *         |  any of the key letters listed above except &quot;b&quot;).</span>
<a name="l11036"></a>11036 <span class="comment"> *</span>
<a name="l11037"></a>11037 <span class="comment"> *</span>
<a name="l11038"></a>11038 <span class="comment"> *  The global constant ARGF (also accessible as $&lt;) provides an</span>
<a name="l11039"></a>11039 <span class="comment"> *  IO-like stream which allows access to all files mentioned on the</span>
<a name="l11040"></a>11040 <span class="comment"> *  command line (or STDIN if no files are mentioned). ARGF provides</span>
<a name="l11041"></a>11041 <span class="comment"> *  the methods &lt;code&gt;#path&lt;/code&gt; and &lt;code&gt;#filename&lt;/code&gt; to access</span>
<a name="l11042"></a>11042 <span class="comment"> *  the name of the file currently being read.</span>
<a name="l11043"></a>11043 <span class="comment"> *</span>
<a name="l11044"></a>11044 <span class="comment"> *  == io/console</span>
<a name="l11045"></a>11045 <span class="comment"> *</span>
<a name="l11046"></a>11046 <span class="comment"> *  The io/console extension provides methods for interacting with the</span>
<a name="l11047"></a>11047 <span class="comment"> *  console.  The console can be accessed from &lt;code&gt;IO.console&lt;/code&gt; or</span>
<a name="l11048"></a>11048 <span class="comment"> *  the standard input/output/error IO objects.</span>
<a name="l11049"></a>11049 <span class="comment"> *</span>
<a name="l11050"></a>11050 <span class="comment"> *  Requiring io/console adds the following methods:</span>
<a name="l11051"></a>11051 <span class="comment"> *</span>
<a name="l11052"></a>11052 <span class="comment"> *  * IO::console</span>
<a name="l11053"></a>11053 <span class="comment"> *  * IO#raw</span>
<a name="l11054"></a>11054 <span class="comment"> *  * IO#raw!</span>
<a name="l11055"></a>11055 <span class="comment"> *  * IO#cooked</span>
<a name="l11056"></a>11056 <span class="comment"> *  * IO#cooked!</span>
<a name="l11057"></a>11057 <span class="comment"> *  * IO#getch</span>
<a name="l11058"></a>11058 <span class="comment"> *  * IO#echo=</span>
<a name="l11059"></a>11059 <span class="comment"> *  * IO#echo?</span>
<a name="l11060"></a>11060 <span class="comment"> *  * IO#noecho</span>
<a name="l11061"></a>11061 <span class="comment"> *  * IO#winsize</span>
<a name="l11062"></a>11062 <span class="comment"> *  * IO#winsize=</span>
<a name="l11063"></a>11063 <span class="comment"> *  * IO#iflush</span>
<a name="l11064"></a>11064 <span class="comment"> *  * IO#ioflush</span>
<a name="l11065"></a>11065 <span class="comment"> *  * IO#oflush</span>
<a name="l11066"></a>11066 <span class="comment"> *</span>
<a name="l11067"></a>11067 <span class="comment"> *  Example:</span>
<a name="l11068"></a>11068 <span class="comment"> *</span>
<a name="l11069"></a>11069 <span class="comment"> *    require &apos;io/console&apos;</span>
<a name="l11070"></a>11070 <span class="comment"> *    rows, columns = $stdin.winsize</span>
<a name="l11071"></a>11071 <span class="comment"> *    puts &quot;You screen is #{columns} wide and #{rows} tall&quot;</span>
<a name="l11072"></a>11072 <span class="comment"> */</span>
<a name="l11073"></a>11073 
<a name="l11074"></a>11074 <span class="keywordtype">void</span>
<a name="l11075"></a><a class="code" href="../../df/d0a/io_8c.html#afae9c31090d8aac38fa3967d0d80905b">11075</a> <a class="code" href="../../df/d0a/io_8c.html#afae9c31090d8aac38fa3967d0d80905b">Init_IO</a>(<span class="keywordtype">void</span>)
<a name="l11076"></a>11076 {
<a name="l11077"></a>11077 <span class="preprocessor">#undef rb_intern</span>
<a name="l11078"></a>11078 <span class="preprocessor"></span><span class="preprocessor">#define rb_intern(str) rb_intern_const(str)</span>
<a name="l11079"></a>11079 <span class="preprocessor"></span>
<a name="l11080"></a>11080     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> rb_cARGF;
<a name="l11081"></a>11081 <span class="preprocessor">#ifdef __CYGWIN__</span>
<a name="l11082"></a>11082 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/cygwin.h&gt;</span>
<a name="l11083"></a>11083     <span class="keyword">static</span> <span class="keyword">struct </span>__cygwin_perfile pf[] =
<a name="l11084"></a>11084     {
<a name="l11085"></a>11085         {<span class="stringliteral">&quot;&quot;</span>, O_RDONLY | <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>},
<a name="l11086"></a>11086         {<span class="stringliteral">&quot;&quot;</span>, O_WRONLY | <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>},
<a name="l11087"></a>11087         {<span class="stringliteral">&quot;&quot;</span>, O_RDWR | <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>},
<a name="l11088"></a>11088         {<span class="stringliteral">&quot;&quot;</span>, O_APPEND | <a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>},
<a name="l11089"></a>11089         {<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0}
<a name="l11090"></a>11090     };
<a name="l11091"></a>11091     cygwin_internal(CW_PERFILE, pf);
<a name="l11092"></a>11092 <span class="preprocessor">#endif</span>
<a name="l11093"></a>11093 <span class="preprocessor"></span>
<a name="l11094"></a>11094     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a> = <a class="code" href="../../de/ddf/group__class.html#ga15d068dbe88a3bab3700b03bebb7fbac" title="Defines a top-level class.">rb_define_class</a>(<span class="stringliteral">&quot;IOError&quot;</span>, <a class="code" href="../../db/dcc/error_8c.html#a3fc1bd0a9e1211aef38f81d600345ed9">rb_eStandardError</a>);
<a name="l11095"></a>11095     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a64459141201c6d17c834b04b905a4dc5">rb_eEOFError</a> = <a class="code" href="../../de/ddf/group__class.html#ga15d068dbe88a3bab3700b03bebb7fbac" title="Defines a top-level class.">rb_define_class</a>(<span class="stringliteral">&quot;EOFError&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7119571f9a2729f4f8731b3656edfa28">rb_eIOError</a>);
<a name="l11096"></a>11096 
<a name="l11097"></a>11097     <a class="code" href="../../df/d0a/io_8c.html#a5a1310970981dfb309a18f6a1a9a771b">id_write</a> = <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;write&quot;</span>);
<a name="l11098"></a>11098     <a class="code" href="../../df/d0a/io_8c.html#aaab409b2dac658da354cd7efc5ad39ae">id_read</a> = <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;read&quot;</span>);
<a name="l11099"></a>11099     <a class="code" href="../../df/d0a/io_8c.html#a8902818fa89b386103fb16fb33041525">id_getc</a> = <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;getc&quot;</span>);
<a name="l11100"></a>11100     <a class="code" href="../../df/d0a/io_8c.html#a3096167a3c55f32a5fa2535e5ee0c2c4">id_flush</a> = <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;flush&quot;</span>);
<a name="l11101"></a>11101     <a class="code" href="../../df/d0a/io_8c.html#a5b4f2a8b420ec7588f0a9983fb513b81">id_readpartial</a> = <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;readpartial&quot;</span>);
<a name="l11102"></a>11102     <a class="code" href="../../df/d0a/io_8c.html#a666eb54f6ebe3c9e4220669471fe098c">id_set_encoding</a> = <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;set_encoding&quot;</span>);
<a name="l11103"></a>11103 
<a name="l11104"></a>11104     <a class="code" href="../../d7/d19/group__defmethod.html#gac08f58e00836e4e2586689e45b781bdd" title="Defines a global function.">rb_define_global_function</a>(<span class="stringliteral">&quot;syscall&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a3c2b7c028963b354af16cbba3e6a915b">rb_f_syscall</a>, -1);
<a name="l11105"></a>11105 
<a name="l11106"></a>11106     <a class="code" href="../../d7/d19/group__defmethod.html#gac08f58e00836e4e2586689e45b781bdd" title="Defines a global function.">rb_define_global_function</a>(<span class="stringliteral">&quot;open&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a3862359d3b7422dcf99eb607724beb43">rb_f_open</a>, -1);
<a name="l11107"></a>11107     <a class="code" href="../../d7/d19/group__defmethod.html#gac08f58e00836e4e2586689e45b781bdd" title="Defines a global function.">rb_define_global_function</a>(<span class="stringliteral">&quot;printf&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a7eb879db72bbf694163f5808c4729b75">rb_f_printf</a>, -1);
<a name="l11108"></a>11108     <a class="code" href="../../d7/d19/group__defmethod.html#gac08f58e00836e4e2586689e45b781bdd" title="Defines a global function.">rb_define_global_function</a>(<span class="stringliteral">&quot;print&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a0630de87ee55f257fef2426aaa6887de">rb_f_print</a>, -1);
<a name="l11109"></a>11109     <a class="code" href="../../d7/d19/group__defmethod.html#gac08f58e00836e4e2586689e45b781bdd" title="Defines a global function.">rb_define_global_function</a>(<span class="stringliteral">&quot;putc&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a6abbd909304a63045cf3cef698eeb4f3">rb_f_putc</a>, 1);
<a name="l11110"></a>11110     <a class="code" href="../../d7/d19/group__defmethod.html#gac08f58e00836e4e2586689e45b781bdd" title="Defines a global function.">rb_define_global_function</a>(<span class="stringliteral">&quot;puts&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a5d2f22da3b51899315d53e2f2b0aa998">rb_f_puts</a>, -1);
<a name="l11111"></a>11111     <a class="code" href="../../d7/d19/group__defmethod.html#gac08f58e00836e4e2586689e45b781bdd" title="Defines a global function.">rb_define_global_function</a>(<span class="stringliteral">&quot;gets&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a0a87a6ff48e0b00304eecf15adb747c9">rb_f_gets</a>, -1);
<a name="l11112"></a>11112     <a class="code" href="../../d7/d19/group__defmethod.html#gac08f58e00836e4e2586689e45b781bdd" title="Defines a global function.">rb_define_global_function</a>(<span class="stringliteral">&quot;readline&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a931715784831b280632e9c9613c7a5d5">rb_f_readline</a>, -1);
<a name="l11113"></a>11113     <a class="code" href="../../d7/d19/group__defmethod.html#gac08f58e00836e4e2586689e45b781bdd" title="Defines a global function.">rb_define_global_function</a>(<span class="stringliteral">&quot;select&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ae57cd3655f3a05891a74390f85110e9d">rb_f_select</a>, -1);
<a name="l11114"></a>11114 
<a name="l11115"></a>11115     <a class="code" href="../../d7/d19/group__defmethod.html#gac08f58e00836e4e2586689e45b781bdd" title="Defines a global function.">rb_define_global_function</a>(<span class="stringliteral">&quot;readlines&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#aa6bbcca736f9963747f5f8a329637fc8">rb_f_readlines</a>, -1);
<a name="l11116"></a>11116 
<a name="l11117"></a>11117     <a class="code" href="../../d7/d19/group__defmethod.html#gac08f58e00836e4e2586689e45b781bdd" title="Defines a global function.">rb_define_global_function</a>(<span class="stringliteral">&quot;`&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#af46fd563e8e9458763ff5054a6b79ace">rb_f_backquote</a>, 1);
<a name="l11118"></a>11118 
<a name="l11119"></a>11119     <a class="code" href="../../d7/d19/group__defmethod.html#gac08f58e00836e4e2586689e45b781bdd" title="Defines a global function.">rb_define_global_function</a>(<span class="stringliteral">&quot;p&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a26f49efa8b190dcb42e32f0165bae7d9">rb_f_p</a>, -1);
<a name="l11120"></a>11120     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2f79a80cd4cd92563255889fdcc303b8">rb_mKernel</a>, <span class="stringliteral">&quot;display&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#acf28c044ff9571013477cb02ca210959">rb_obj_display</a>, -1);
<a name="l11121"></a>11121 
<a name="l11122"></a>11122     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a> = <a class="code" href="../../de/ddf/group__class.html#ga15d068dbe88a3bab3700b03bebb7fbac" title="Defines a top-level class.">rb_define_class</a>(<span class="stringliteral">&quot;IO&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a57c96ead3ef230b4838e65fe037c346e">rb_cObject</a>);
<a name="l11123"></a>11123     <a class="code" href="../../de/ddf/group__class.html#ga1301940bb86315055d67464ed2cee477">rb_include_module</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <a class="code" href="../../d9/d69/enum_8c.html#a429f536baa7b3e9892b3a68325b28e71">rb_mEnumerable</a>);
<a name="l11124"></a>11124 
<a name="l11125"></a>11125     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac2d47e89b7cb8311129ec7566608a0b2">rb_mWaitReadable</a> = <a class="code" href="../../de/ddf/group__class.html#gad0eeed44f413060a2417852168747388">rb_define_module_under</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;WaitReadable&quot;</span>);
<a name="l11126"></a>11126     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac0e6048c512add5b6659c01f7f134d8a">rb_mWaitWritable</a> = <a class="code" href="../../de/ddf/group__class.html#gad0eeed44f413060a2417852168747388">rb_define_module_under</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;WaitWritable&quot;</span>);
<a name="l11127"></a>11127 
<a name="l11128"></a>11128 <span class="preprocessor">#if 0</span>
<a name="l11129"></a>11129 <span class="preprocessor"></span>    <span class="comment">/* This is necessary only for forcing rdoc handle File::open */</span>
<a name="l11130"></a>11130     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../d6/d13/file_8c.html#ae9f03997c2e7a3461524e83053a24ac2">rb_cFile</a>, <span class="stringliteral">&quot;open&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a6276032e5c6c91c0b13a7196b844e709">rb_io_s_open</a>, -1);
<a name="l11131"></a>11131 <span class="preprocessor">#endif</span>
<a name="l11132"></a>11132 <span class="preprocessor"></span>
<a name="l11133"></a>11133     <a class="code" href="../../db/d2e/intern_8h.html#a6c99ed7f070458b961026d43d27d0642">rb_define_alloc_func</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <a class="code" href="../../df/d0a/io_8c.html#a47f57cf9a8f65858e5cfe7ed56cc65bb">io_alloc</a>);
<a name="l11134"></a>11134     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;new&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ade91f74d40154ad9363742520ff5ba10">rb_io_s_new</a>, -1);
<a name="l11135"></a>11135     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;open&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a6276032e5c6c91c0b13a7196b844e709">rb_io_s_open</a>, -1);
<a name="l11136"></a>11136     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;sysopen&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#ad2594a367b3df93ed7126d26aa790ea9">rb_io_s_sysopen</a>, -1);
<a name="l11137"></a>11137     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;for_fd&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ad368222f9c00ad845be00864e9cd0fbb">rb_io_s_for_fd</a>, -1);
<a name="l11138"></a>11138     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;popen&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a163d2de63a404ee68d91b01a1e60b397">rb_io_s_popen</a>, -1);
<a name="l11139"></a>11139     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;foreach&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a0a29684a634384a06813d4cb240bf75f">rb_io_s_foreach</a>, -1);
<a name="l11140"></a>11140     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;readlines&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a35d73ca8a9a83aa9c12344598656078b">rb_io_s_readlines</a>, -1);
<a name="l11141"></a>11141     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;read&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a27e0238169257152036e6ab2dc7dd689">rb_io_s_read</a>, -1);
<a name="l11142"></a>11142     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;binread&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a7f691c3c4fb19ca6aed0f542c53e86fe">rb_io_s_binread</a>, -1);
<a name="l11143"></a>11143     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;write&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#af4609cf0a1d82f03ac7d46be18b1d7d2">rb_io_s_write</a>, -1);
<a name="l11144"></a>11144     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;binwrite&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a6a8e1fee0518e265455edab84c0c69fc">rb_io_s_binwrite</a>, -1);
<a name="l11145"></a>11145     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;select&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ae57cd3655f3a05891a74390f85110e9d">rb_f_select</a>, -1);
<a name="l11146"></a>11146     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;pipe&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a0a63a0eca24701df132b146a9b88aebc">rb_io_s_pipe</a>, -1);
<a name="l11147"></a>11147     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;try_convert&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ad8f4ce5dbba3a552cba019e81f0d49e7">rb_io_s_try_convert</a>, 1);
<a name="l11148"></a>11148     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;copy_stream&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#af17502cf63e52e072d284891d89915ad">rb_io_s_copy_stream</a>, -1);
<a name="l11149"></a>11149 
<a name="l11150"></a>11150     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;initialize&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a807528178336e7c4195eeb5d95b106cb">rb_io_initialize</a>, -1);
<a name="l11151"></a>11151 
<a name="l11152"></a>11152     <a class="code" href="../../dc/dcc/array_8c.html#ac8351f37c8a5de2cc8cd638f7d515396">rb_output_fs</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l11153"></a>11153     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a196d9fa3b954ec50f5ab17501d46c4ec">rb_define_hooked_variable</a>(<span class="stringliteral">&quot;$,&quot;</span>, &amp;<a class="code" href="../../dc/dcc/array_8c.html#ac8351f37c8a5de2cc8cd638f7d515396">rb_output_fs</a>, 0, <a class="code" href="../../db/d2e/intern_8h.html#a7fa2184f1d911ae1342228f818cf376f">rb_str_setter</a>);
<a name="l11154"></a>11154 
<a name="l11155"></a>11155     <a class="code" href="../../db/d2e/intern_8h.html#a6d19bb99247117d9d8b880ab14ad8d25">rb_rs</a> = <a class="code" href="../../db/d2e/intern_8h.html#ab707a74e9c34626c05d20431ad137570">rb_default_rs</a> = <a class="code" href="../../db/d2e/intern_8h.html#a99895fce59be905b7c7f0a88bd32fa1f">rb_usascii_str_new2</a>(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l11156"></a>11156     <a class="code" href="../../d8/d16/gc_8c.html#adc7efe8997f04b5c275d7e7aed9169e3">rb_gc_register_mark_object</a>(<a class="code" href="../../db/d2e/intern_8h.html#ab707a74e9c34626c05d20431ad137570">rb_default_rs</a>);
<a name="l11157"></a>11157     <a class="code" href="../../db/d2e/intern_8h.html#aad25f1b1b54e12dcb609374f46cfd0e5">rb_output_rs</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l11158"></a>11158     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7ae8fa209abf837905d53c1c4be7c75d">OBJ_FREEZE</a>(<a class="code" href="../../db/d2e/intern_8h.html#ab707a74e9c34626c05d20431ad137570">rb_default_rs</a>);  <span class="comment">/* avoid modifying RS_default */</span>
<a name="l11159"></a>11159     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a196d9fa3b954ec50f5ab17501d46c4ec">rb_define_hooked_variable</a>(<span class="stringliteral">&quot;$/&quot;</span>, &amp;<a class="code" href="../../db/d2e/intern_8h.html#a6d19bb99247117d9d8b880ab14ad8d25">rb_rs</a>, 0, <a class="code" href="../../db/d2e/intern_8h.html#a7fa2184f1d911ae1342228f818cf376f">rb_str_setter</a>);
<a name="l11160"></a>11160     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a196d9fa3b954ec50f5ab17501d46c4ec">rb_define_hooked_variable</a>(<span class="stringliteral">&quot;$-0&quot;</span>, &amp;<a class="code" href="../../db/d2e/intern_8h.html#a6d19bb99247117d9d8b880ab14ad8d25">rb_rs</a>, 0, <a class="code" href="../../db/d2e/intern_8h.html#a7fa2184f1d911ae1342228f818cf376f">rb_str_setter</a>);
<a name="l11161"></a>11161     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a196d9fa3b954ec50f5ab17501d46c4ec">rb_define_hooked_variable</a>(<span class="stringliteral">&quot;$\\&quot;</span>, &amp;<a class="code" href="../../db/d2e/intern_8h.html#aad25f1b1b54e12dcb609374f46cfd0e5">rb_output_rs</a>, 0, <a class="code" href="../../db/d2e/intern_8h.html#a7fa2184f1d911ae1342228f818cf376f">rb_str_setter</a>);
<a name="l11162"></a>11162 
<a name="l11163"></a>11163     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a16645ebd6327288fc96a4df38d58f36b">rb_define_virtual_variable</a>(<span class="stringliteral">&quot;$_&quot;</span>, <a class="code" href="../../db/d2e/intern_8h.html#ac185acdaeb1aadf3f4297609e05fd083">rb_lastline_get</a>, <a class="code" href="../../db/d2e/intern_8h.html#ada36b7e0e23335fa38937f0b5328601d">rb_lastline_set</a>);
<a name="l11164"></a>11164 
<a name="l11165"></a>11165     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;initialize_copy&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a53737e0fba68b3e6b773e78f2873c4ad">rb_io_init_copy</a>, 1);
<a name="l11166"></a>11166     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;reopen&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a31c3d0d5ac3fed0515858687beef0c97">rb_io_reopen</a>, -1);
<a name="l11167"></a>11167 
<a name="l11168"></a>11168     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;print&quot;</span>, <a class="code" href="../../db/d2e/intern_8h.html#a5224149a04b11c155dd7ed90abca45a4">rb_io_print</a>, -1);
<a name="l11169"></a>11169     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;putc&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a1990ad98c29175470468993aed279507">rb_io_putc</a>, 1);
<a name="l11170"></a>11170     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;puts&quot;</span>, <a class="code" href="../../db/d2e/intern_8h.html#ae85b97b8e0efba41ee0b0da17ae131c6">rb_io_puts</a>, -1);
<a name="l11171"></a>11171     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;printf&quot;</span>, <a class="code" href="../../db/d2e/intern_8h.html#ab73b37851177d15273fb23ed21b8c564">rb_io_printf</a>, -1);
<a name="l11172"></a>11172 
<a name="l11173"></a>11173     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;each&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a49a636ecf7eb2394814596c05d0b4ce0">rb_io_each_line</a>, -1);
<a name="l11174"></a>11174     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;each_line&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a49a636ecf7eb2394814596c05d0b4ce0">rb_io_each_line</a>, -1);
<a name="l11175"></a>11175     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;each_byte&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a04ad573d5a1e3b71730740743e6ee42b">rb_io_each_byte</a>, 0);
<a name="l11176"></a>11176     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;each_char&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a8508906b0294323f5d53a7847cb5fb92">rb_io_each_char</a>, 0);
<a name="l11177"></a>11177     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;each_codepoint&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a954bc2cc1261b29fad52ccfdbfbbb419">rb_io_each_codepoint</a>, 0);
<a name="l11178"></a>11178     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;lines&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a49a636ecf7eb2394814596c05d0b4ce0">rb_io_each_line</a>, -1);
<a name="l11179"></a>11179     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;bytes&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a04ad573d5a1e3b71730740743e6ee42b">rb_io_each_byte</a>, 0);
<a name="l11180"></a>11180     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;chars&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a8508906b0294323f5d53a7847cb5fb92">rb_io_each_char</a>, 0);
<a name="l11181"></a>11181     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;codepoints&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a954bc2cc1261b29fad52ccfdbfbbb419">rb_io_each_codepoint</a>, 0);
<a name="l11182"></a>11182 
<a name="l11183"></a>11183     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;syswrite&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a99ae5729cea4de9ec885a3aebe7b89d1">rb_io_syswrite</a>, 1);
<a name="l11184"></a>11184     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;sysread&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#ac593f1d6d740b68e649f17c66f428954">rb_io_sysread</a>, -1);
<a name="l11185"></a>11185 
<a name="l11186"></a>11186     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;fileno&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a62dd820b5e3ae52bc5afc5afb5c2f3bd">rb_io_fileno</a>, 0);
<a name="l11187"></a>11187     <a class="code" href="../../d7/d19/group__defmethod.html#ga9ee2c97671d010bcb7a27614ab28bba7" title="Defines an alias of a method.">rb_define_alias</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;to_i&quot;</span>, <span class="stringliteral">&quot;fileno&quot;</span>);
<a name="l11188"></a>11188     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;to_io&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ac204e4088139945a77d8f6fa621a66d8">rb_io_to_io</a>, 0);
<a name="l11189"></a>11189 
<a name="l11190"></a>11190     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;fsync&quot;</span>,   <a class="code" href="../../df/d0a/io_8c.html#aa68742bd88c7650ea90208b70d080d0d">rb_io_fsync</a>, 0);
<a name="l11191"></a>11191     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;fdatasync&quot;</span>,   <a class="code" href="../../df/d0a/io_8c.html#ae7ae82560cc5e5b9042a822f9f7596d2">rb_io_fdatasync</a>, 0);
<a name="l11192"></a>11192     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;sync&quot;</span>,   <a class="code" href="../../df/d0a/io_8c.html#a276e193f9a2406f345608aabfcb2e9aa">rb_io_sync</a>, 0);
<a name="l11193"></a>11193     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;sync=&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#acfe156cb7906a6541fd2ffb1e1d86cb4">rb_io_set_sync</a>, 1);
<a name="l11194"></a>11194 
<a name="l11195"></a>11195     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;lineno&quot;</span>,   <a class="code" href="../../df/d0a/io_8c.html#aa0553726b71a5f77990f61214eae6172">rb_io_lineno</a>, 0);
<a name="l11196"></a>11196     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;lineno=&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#ae0bd7719ba31dc8500b31617eeea28b9">rb_io_set_lineno</a>, 1);
<a name="l11197"></a>11197 
<a name="l11198"></a>11198     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;readlines&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#aedb3b02ed530d801262cea5cac06e1a9">rb_io_readlines</a>, -1);
<a name="l11199"></a>11199 
<a name="l11200"></a>11200     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;read_nonblock&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a56b8f1fad1cec08e3e85cdd2bbe3fe1e">io_read_nonblock</a>, -1);
<a name="l11201"></a>11201     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;write_nonblock&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a84c56d8dfcf86bd09b8d064c976fda9e">rb_io_write_nonblock</a>, 1);
<a name="l11202"></a>11202     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;readpartial&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#acddb1da73471e25d175a447beacf11f8">io_readpartial</a>, -1);
<a name="l11203"></a>11203     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;read&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#aabba878d4b639aa789e090114d1023f9">io_read</a>, -1);
<a name="l11204"></a>11204     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;write&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a6929fbb0b7bb6756e549bff399334093">io_write_m</a>, 1);
<a name="l11205"></a>11205     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;gets&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a82aa0c7d60448d8caca4fccd7ced8e3f">rb_io_gets_m</a>, -1);
<a name="l11206"></a>11206     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;readline&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a2faee7a572ab37aacf1227fca325f7fc">rb_io_readline</a>, -1);
<a name="l11207"></a>11207     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;getc&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a970e65fde195f4283b34493c26c74dab">rb_io_getc</a>, 0);
<a name="l11208"></a>11208     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;getbyte&quot;</span>,  <a class="code" href="../../db/d2e/intern_8h.html#a13c20887173177e30ccd7bb42708dc2b">rb_io_getbyte</a>, 0);
<a name="l11209"></a>11209     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;readchar&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#ace92bfe94affa64705d88a37ee0ad8f3">rb_io_readchar</a>, 0);
<a name="l11210"></a>11210     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;readbyte&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a512f661818d07b0e13bda85f72677c16">rb_io_readbyte</a>, 0);
<a name="l11211"></a>11211     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;ungetbyte&quot;</span>,<a class="code" href="../../db/d2e/intern_8h.html#ad5e3541ec00f5805a8bfb10fbe71a33a">rb_io_ungetbyte</a>, 1);
<a name="l11212"></a>11212     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;ungetc&quot;</span>,<a class="code" href="../../db/d2e/intern_8h.html#a494a6de694f10dfe1b8da289e6479c51">rb_io_ungetc</a>, 1);
<a name="l11213"></a>11213     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;&lt;&lt;&quot;</span>,    <a class="code" href="../../db/d2e/intern_8h.html#a9660780630812f5149c578517e5a1796">rb_io_addstr</a>, 1);
<a name="l11214"></a>11214     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;flush&quot;</span>, <a class="code" href="../../db/d2e/intern_8h.html#a773ecf32a05c03d4ca1da8cf31bbfc29">rb_io_flush</a>, 0);
<a name="l11215"></a>11215     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;tell&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a9dfbc6591e022d6d91a1590d3a329d79">rb_io_tell</a>, 0);
<a name="l11216"></a>11216     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;seek&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a3da22b51f3d8dfd33f72a6640597ffad">rb_io_seek_m</a>, -1);
<a name="l11217"></a>11217     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;SEEK_SET&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../df/d0a/io_8c.html#a0d112bae8fd35be772185b6ec6bcbe64">SEEK_SET</a>));
<a name="l11218"></a>11218     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;SEEK_CUR&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../df/d0a/io_8c.html#a4c8d0b76b470ba65a43ca46a88320f39">SEEK_CUR</a>));
<a name="l11219"></a>11219     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;SEEK_END&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../df/d0a/io_8c.html#ad2a2e6c114780c3071efd24f16c7f7d8">SEEK_END</a>));
<a name="l11220"></a>11220     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;rewind&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a2990bd35f03a7105058cc973bb5d2ce5">rb_io_rewind</a>, 0);
<a name="l11221"></a>11221     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;pos&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a9dfbc6591e022d6d91a1590d3a329d79">rb_io_tell</a>, 0);
<a name="l11222"></a>11222     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;pos=&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#abbcb6b6b0e2f4b79f198c78c203deea6">rb_io_set_pos</a>, 1);
<a name="l11223"></a>11223     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;eof&quot;</span>, <a class="code" href="../../db/d2e/intern_8h.html#a25dc0631238847713d9cb4ea9bebdb13">rb_io_eof</a>, 0);
<a name="l11224"></a>11224     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;eof?&quot;</span>, <a class="code" href="../../db/d2e/intern_8h.html#a25dc0631238847713d9cb4ea9bebdb13">rb_io_eof</a>, 0);
<a name="l11225"></a>11225 
<a name="l11226"></a>11226     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;close_on_exec?&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a4c9604f6272d5c09e1613ceffde9e27e">rb_io_close_on_exec_p</a>, 0);
<a name="l11227"></a>11227     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;close_on_exec=&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#adc297d05a298e421011648796d6d844f">rb_io_set_close_on_exec</a>, 1);
<a name="l11228"></a>11228 
<a name="l11229"></a>11229     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;close&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#af420b3bd2e69cd4d8ac0a7f1eebefc8d">rb_io_close_m</a>, 0);
<a name="l11230"></a>11230     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;closed?&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#add81852a736e6068e5619df3f4e92509">rb_io_closed</a>, 0);
<a name="l11231"></a>11231     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;close_read&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#afc1297e52e07c3407b90ec0342c00306">rb_io_close_read</a>, 0);
<a name="l11232"></a>11232     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;close_write&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a46dd9f01ddd88b96f7e0acab4ab41dc2">rb_io_close_write</a>, 0);
<a name="l11233"></a>11233 
<a name="l11234"></a>11234     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;isatty&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a732eb09f86dbbb17e14babef8752afaf">rb_io_isatty</a>, 0);
<a name="l11235"></a>11235     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;tty?&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a732eb09f86dbbb17e14babef8752afaf">rb_io_isatty</a>, 0);
<a name="l11236"></a>11236     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;binmode&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#afb263b3801efd8532104ec93253ee380">rb_io_binmode_m</a>, 0);
<a name="l11237"></a>11237     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;binmode?&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a886960de6c88a81db8156c06e3dadb98">rb_io_binmode_p</a>, 0);
<a name="l11238"></a>11238     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;sysseek&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ab69172e0b3ab8dcf5f6fcd84e26d7021">rb_io_sysseek</a>, -1);
<a name="l11239"></a>11239     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;advise&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#add531bf7e584e1453d967d8871495d76">rb_io_advise</a>, -1);
<a name="l11240"></a>11240 
<a name="l11241"></a>11241     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;ioctl&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a58befea47265398d533bb9a2760e8eca">rb_io_ioctl</a>, -1);
<a name="l11242"></a>11242     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;fcntl&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a25757b08216839966226387375c027e2">rb_io_fcntl</a>, -1);
<a name="l11243"></a>11243     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;pid&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a240fbf1fce3d93824fc901c8a717d68a">rb_io_pid</a>, 0);
<a name="l11244"></a>11244     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;inspect&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#aadf9911657d145787d4f1b196de78913">rb_io_inspect</a>, 0);
<a name="l11245"></a>11245 
<a name="l11246"></a>11246     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;external_encoding&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#af2d7a69851929321fc9353de62e3f363">rb_io_external_encoding</a>, 0);
<a name="l11247"></a>11247     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;internal_encoding&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a48ce1fe48cfa72a42f99111bfe1c6077">rb_io_internal_encoding</a>, 0);
<a name="l11248"></a>11248     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;set_encoding&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ababeae37e439326a1f3e7685063df707">rb_io_set_encoding</a>, -1);
<a name="l11249"></a>11249 
<a name="l11250"></a>11250     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;autoclose?&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#adc0d64377d1dc768883a80d20fd9db69">rb_io_autoclose_p</a>, 0);
<a name="l11251"></a>11251     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;autoclose=&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a3b0eb0d4cdf92e8a28b21a918a1288d7">rb_io_set_autoclose</a>, 1);
<a name="l11252"></a>11252 
<a name="l11253"></a>11253     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a57dd061565d9e4115ba7a19838b0f0f4">rb_define_variable</a>(<span class="stringliteral">&quot;$stdin&quot;</span>, &amp;<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afafc64c52c6ab49dbc5699da872cad03">rb_stdin</a>);
<a name="l11254"></a>11254     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afafc64c52c6ab49dbc5699da872cad03">rb_stdin</a> = <a class="code" href="../../df/d0a/io_8c.html#a1562c4ffdbefb2cfcedd7800789b3b8b">prep_stdio</a>(stdin, <a class="code" href="../../dc/dac/io_8h.html#a00c37fcd07f39f8f5b374b94f91c7203">FMODE_READABLE</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;&lt;STDIN&gt;&quot;</span>);
<a name="l11255"></a>11255     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a196d9fa3b954ec50f5ab17501d46c4ec">rb_define_hooked_variable</a>(<span class="stringliteral">&quot;$stdout&quot;</span>, &amp;<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>, 0, <a class="code" href="../../df/d0a/io_8c.html#a62b05472f6b4dd7b912f3b3182f32b4d">stdout_setter</a>);
<a name="l11256"></a>11256     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a> = <a class="code" href="../../df/d0a/io_8c.html#a1562c4ffdbefb2cfcedd7800789b3b8b">prep_stdio</a>(stdout, <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;&lt;STDOUT&gt;&quot;</span>);
<a name="l11257"></a>11257     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a196d9fa3b954ec50f5ab17501d46c4ec">rb_define_hooked_variable</a>(<span class="stringliteral">&quot;$stderr&quot;</span>, &amp;<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1bc7a47b6913bb55b64d881d19da4d03">rb_stderr</a>, 0, <a class="code" href="../../df/d0a/io_8c.html#a62b05472f6b4dd7b912f3b3182f32b4d">stdout_setter</a>);
<a name="l11258"></a>11258     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1bc7a47b6913bb55b64d881d19da4d03">rb_stderr</a> = <a class="code" href="../../df/d0a/io_8c.html#a1562c4ffdbefb2cfcedd7800789b3b8b">prep_stdio</a>(stderr, <a class="code" href="../../dc/dac/io_8h.html#a6c4c198b6b4a8bbc3659802101b6c3e8">FMODE_WRITABLE</a>|<a class="code" href="../../dc/dac/io_8h.html#a95a89e4b35429fb51d7c3e52ec405d90">FMODE_SYNC</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aed01d7f8e7222def13a869f4bc45530a">rb_cIO</a>, <span class="stringliteral">&quot;&lt;STDERR&gt;&quot;</span>);
<a name="l11259"></a>11259     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a196d9fa3b954ec50f5ab17501d46c4ec">rb_define_hooked_variable</a>(<span class="stringliteral">&quot;$&gt;&quot;</span>, &amp;<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>, 0, <a class="code" href="../../df/d0a/io_8c.html#a62b05472f6b4dd7b912f3b3182f32b4d">stdout_setter</a>);
<a name="l11260"></a>11260     <a class="code" href="../../df/d0a/io_8c.html#a51b183f14dd2be4d72bc7f5a9c5af041">orig_stdout</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>;
<a name="l11261"></a>11261     <a class="code" href="../../df/d0a/io_8c.html#a1de1da4197f3c858df455fc43f5bf79c">rb_deferr</a> = <a class="code" href="../../df/d0a/io_8c.html#acf8024d5428fdf61c44bea5ed3e40b55">orig_stderr</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1bc7a47b6913bb55b64d881d19da4d03">rb_stderr</a>;
<a name="l11262"></a>11262 
<a name="l11263"></a>11263     <span class="comment">/* Holds the original stdin */</span>
<a name="l11264"></a>11264     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5a25f6effbffe412ebda3391132e7129">rb_define_global_const</a>(<span class="stringliteral">&quot;STDIN&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afafc64c52c6ab49dbc5699da872cad03">rb_stdin</a>);
<a name="l11265"></a>11265     <span class="comment">/* Holds the original stdout */</span>
<a name="l11266"></a>11266     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5a25f6effbffe412ebda3391132e7129">rb_define_global_const</a>(<span class="stringliteral">&quot;STDOUT&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8e88e429d335a5cd323cc848ac18ff58">rb_stdout</a>);
<a name="l11267"></a>11267     <span class="comment">/* Holds the original stderr */</span>
<a name="l11268"></a>11268     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5a25f6effbffe412ebda3391132e7129">rb_define_global_const</a>(<span class="stringliteral">&quot;STDERR&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1bc7a47b6913bb55b64d881d19da4d03">rb_stderr</a>);
<a name="l11269"></a>11269 
<a name="l11270"></a>11270 <span class="preprocessor">#if 0</span>
<a name="l11271"></a>11271 <span class="preprocessor"></span>    <span class="comment">/* Hack to get rdoc to regard ARGF as a class: */</span>
<a name="l11272"></a>11272     rb_cARGF = <a class="code" href="../../de/ddf/group__class.html#ga15d068dbe88a3bab3700b03bebb7fbac" title="Defines a top-level class.">rb_define_class</a>(<span class="stringliteral">&quot;ARGF&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a57c96ead3ef230b4838e65fe037c346e">rb_cObject</a>);
<a name="l11273"></a>11273 <span class="preprocessor">#endif</span>
<a name="l11274"></a>11274 <span class="preprocessor"></span>
<a name="l11275"></a>11275     rb_cARGF = <a class="code" href="../../de/ddf/group__class.html#ga164285b5b5225740d582d4c3773f9179" title="Creates a new class.">rb_class_new</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a57c96ead3ef230b4838e65fe037c346e">rb_cObject</a>);
<a name="l11276"></a>11276     <a class="code" href="../../db/d2e/intern_8h.html#a1a9624e0ea92f52099d790e00feeb8b7">rb_set_class_path</a>(rb_cARGF, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a57c96ead3ef230b4838e65fe037c346e">rb_cObject</a>, <span class="stringliteral">&quot;ARGF.class&quot;</span>);
<a name="l11277"></a>11277     <a class="code" href="../../db/d2e/intern_8h.html#a6c99ed7f070458b961026d43d27d0642">rb_define_alloc_func</a>(rb_cARGF, <a class="code" href="../../df/d0a/io_8c.html#ab14e02f069e76464e948f02827440501">argf_alloc</a>);
<a name="l11278"></a>11278 
<a name="l11279"></a>11279     <a class="code" href="../../de/ddf/group__class.html#ga1301940bb86315055d67464ed2cee477">rb_include_module</a>(rb_cARGF, <a class="code" href="../../d9/d69/enum_8c.html#a429f536baa7b3e9892b3a68325b28e71">rb_mEnumerable</a>);
<a name="l11280"></a>11280 
<a name="l11281"></a>11281     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;initialize&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a81ef7f50a7b4998e9640349bfda3ea03">argf_initialize</a>, -2);
<a name="l11282"></a>11282     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;initialize_copy&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ab39485d5f45342c7dd8aee8988fb4e1b">argf_initialize_copy</a>, 1);
<a name="l11283"></a>11283     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;to_s&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ae5bebad10738ceab7f5c39e1a1a6079e">argf_to_s</a>, 0);
<a name="l11284"></a>11284     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;argv&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ab08f8bbe4528726cfa413df1e0e443f8">argf_argv</a>, 0);
<a name="l11285"></a>11285 
<a name="l11286"></a>11286     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;fileno&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a8c6b32e1740fc5d7c1ad700b66f28ec7">argf_fileno</a>, 0);
<a name="l11287"></a>11287     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;to_i&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a8c6b32e1740fc5d7c1ad700b66f28ec7">argf_fileno</a>, 0);
<a name="l11288"></a>11288     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;to_io&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a64216fcaf7dd3beb5b65efcd7bc239b2">argf_to_io</a>, 0);
<a name="l11289"></a>11289     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;to_write_io&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ac162a2df5c2a2add4f9c438a0dd4f6c8">argf_write_io</a>, 0);
<a name="l11290"></a>11290     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;each&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a8db67ab436811670abc562d82cb9b0ab">argf_each_line</a>, -1);
<a name="l11291"></a>11291     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;each_line&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a8db67ab436811670abc562d82cb9b0ab">argf_each_line</a>, -1);
<a name="l11292"></a>11292     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;each_byte&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a6bf3a2d4d2891eb19f7e78cf93b10635">argf_each_byte</a>, 0);
<a name="l11293"></a>11293     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;each_char&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a07a848069980be1b953edf89bcd3aa2e">argf_each_char</a>, 0);
<a name="l11294"></a>11294     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;lines&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a8db67ab436811670abc562d82cb9b0ab">argf_each_line</a>, -1);
<a name="l11295"></a>11295     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;bytes&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a6bf3a2d4d2891eb19f7e78cf93b10635">argf_each_byte</a>, 0);
<a name="l11296"></a>11296     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;chars&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a07a848069980be1b953edf89bcd3aa2e">argf_each_char</a>, 0);
<a name="l11297"></a>11297 
<a name="l11298"></a>11298     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;read&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a1e1d57b782524ac6c23b4514e2d64828">argf_read</a>, -1);
<a name="l11299"></a>11299     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;readpartial&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#aacf9293d88c72e4dd9670e9eb2b1c83a">argf_readpartial</a>, -1);
<a name="l11300"></a>11300     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;read_nonblock&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a115823c6f877f41e2134fa6de8b8c2e6">argf_read_nonblock</a>, -1);
<a name="l11301"></a>11301     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;readlines&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a76033f4a6e4e9e695d5cc1ac5baf6514">argf_readlines</a>, -1);
<a name="l11302"></a>11302     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;to_a&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a76033f4a6e4e9e695d5cc1ac5baf6514">argf_readlines</a>, -1);
<a name="l11303"></a>11303     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;gets&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ae6b1972ddde3d80cd6a5ae6a87b6c80c">argf_gets</a>, -1);
<a name="l11304"></a>11304     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;readline&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a94c20d353b18697d6414542f59358f26">argf_readline</a>, -1);
<a name="l11305"></a>11305     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;getc&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a908a68e8d15e927e47783feef67413a4">argf_getc</a>, 0);
<a name="l11306"></a>11306     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;getbyte&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a45dcc71a6bac0844ac45766ae20bc72d">argf_getbyte</a>, 0);
<a name="l11307"></a>11307     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;readchar&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ac88435ec99664d0a1828ac2dbb9e1b02">argf_readchar</a>, 0);
<a name="l11308"></a>11308     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;readbyte&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a025432f1251b070cf907afb8a756139a">argf_readbyte</a>, 0);
<a name="l11309"></a>11309     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;tell&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a3cea62b881dccfdfdda42d1d5e09ef69">argf_tell</a>, 0);
<a name="l11310"></a>11310     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;seek&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#aa11c69ae62e275821eb45207ce26e8b6">argf_seek_m</a>, -1);
<a name="l11311"></a>11311     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;rewind&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a1911e4073634bb1da51ae0a5550b304c">argf_rewind</a>, 0);
<a name="l11312"></a>11312     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;pos&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a3cea62b881dccfdfdda42d1d5e09ef69">argf_tell</a>, 0);
<a name="l11313"></a>11313     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;pos=&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#aa64aa449a44625b35365a99ac681231a">argf_set_pos</a>, 1);
<a name="l11314"></a>11314     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;eof&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a464d0dfc59239ae72a4f58031f93ff60">argf_eof</a>, 0);
<a name="l11315"></a>11315     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;eof?&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a464d0dfc59239ae72a4f58031f93ff60">argf_eof</a>, 0);
<a name="l11316"></a>11316     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;binmode&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a95d0f53f0a2ecb7f293bba29445c262e">argf_binmode_m</a>, 0);
<a name="l11317"></a>11317     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;binmode?&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ab9a38b17af7fd653c1c3ca63cdd5b0d1">argf_binmode_p</a>, 0);
<a name="l11318"></a>11318 
<a name="l11319"></a>11319     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;write&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ad9dc04c7dc6e6a7c722f3fe60c48926a">argf_write</a>, 1);
<a name="l11320"></a>11320     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;print&quot;</span>, <a class="code" href="../../db/d2e/intern_8h.html#a5224149a04b11c155dd7ed90abca45a4">rb_io_print</a>, -1);
<a name="l11321"></a>11321     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;putc&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a1990ad98c29175470468993aed279507">rb_io_putc</a>, 1);
<a name="l11322"></a>11322     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;puts&quot;</span>, <a class="code" href="../../db/d2e/intern_8h.html#ae85b97b8e0efba41ee0b0da17ae131c6">rb_io_puts</a>, -1);
<a name="l11323"></a>11323     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;printf&quot;</span>, <a class="code" href="../../db/d2e/intern_8h.html#ab73b37851177d15273fb23ed21b8c564">rb_io_printf</a>, -1);
<a name="l11324"></a>11324 
<a name="l11325"></a>11325     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;filename&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a5be506430f4e6666c2f7a149ee796494">argf_filename</a>, 0);
<a name="l11326"></a>11326     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;path&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a5be506430f4e6666c2f7a149ee796494">argf_filename</a>, 0);
<a name="l11327"></a>11327     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;file&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a82ddd43df6e497891ef0208591bd5e42">argf_file</a>, 0);
<a name="l11328"></a>11328     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;skip&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ac729aab8be71494ea0fcfe1765e8bd86">argf_skip</a>, 0);
<a name="l11329"></a>11329     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;close&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ab5a9d6a5a1d870b3bfb42a7fd5c7e6ce">argf_close_m</a>, 0);
<a name="l11330"></a>11330     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;closed?&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a5461eac9ab8ff02da5bcb646b25f7bea">argf_closed</a>, 0);
<a name="l11331"></a>11331 
<a name="l11332"></a>11332     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;lineno&quot;</span>,   <a class="code" href="../../df/d0a/io_8c.html#a65741bcb3a0dd8a040edaefbd35241e8">argf_lineno</a>, 0);
<a name="l11333"></a>11333     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;lineno=&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#afd0eca424c27a9a9b6085270ba81398b">argf_set_lineno</a>, 1);
<a name="l11334"></a>11334 
<a name="l11335"></a>11335     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;inplace_mode&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a02985834d1074ba27696b8ece4f127ad">argf_inplace_mode_get</a>, 0);
<a name="l11336"></a>11336     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;inplace_mode=&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a5c98be2a1d5b392c9b3e97202ee60fdf">argf_inplace_mode_set</a>, 1);
<a name="l11337"></a>11337 
<a name="l11338"></a>11338     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;external_encoding&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#abffb821e6d243b7a716294f200c0a575">argf_external_encoding</a>, 0);
<a name="l11339"></a>11339     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;internal_encoding&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#a67784196b0000caf3ce7c411c39aaa0e">argf_internal_encoding</a>, 0);
<a name="l11340"></a>11340     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(rb_cARGF, <span class="stringliteral">&quot;set_encoding&quot;</span>, <a class="code" href="../../df/d0a/io_8c.html#ab6f4ad582572dadc3f6d99533dcd8ce9">argf_set_encoding</a>, -1);
<a name="l11341"></a>11341 
<a name="l11342"></a>11342     <a class="code" href="../../de/d05/structargf.html">argf</a> = <a class="code" href="../../db/d2e/intern_8h.html#a4e25a1a5ca0fc372179c4f429600bc2a">rb_class_new_instance</a>(0, 0, rb_cARGF);
<a name="l11343"></a>11343 
<a name="l11344"></a>11344     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8bf856e572381b0d273fe783a058f47c">rb_define_readonly_variable</a>(<span class="stringliteral">&quot;$&lt;&quot;</span>, &amp;<a class="code" href="../../de/d05/structargf.html">argf</a>);
<a name="l11345"></a>11345     <span class="comment">/*</span>
<a name="l11346"></a>11346 <span class="comment">     * ARGF is a stream designed for use in scripts that process files given</span>
<a name="l11347"></a>11347 <span class="comment">     * as command-line arguments or passed in via STDIN.</span>
<a name="l11348"></a>11348 <span class="comment">     *</span>
<a name="l11349"></a>11349 <span class="comment">     * See ARGF (the class) for more details.</span>
<a name="l11350"></a>11350 <span class="comment">     */</span>
<a name="l11351"></a>11351     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5a25f6effbffe412ebda3391132e7129">rb_define_global_const</a>(<span class="stringliteral">&quot;ARGF&quot;</span>, <a class="code" href="../../de/d05/structargf.html">argf</a>);
<a name="l11352"></a>11352 
<a name="l11353"></a>11353     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a196d9fa3b954ec50f5ab17501d46c4ec">rb_define_hooked_variable</a>(<span class="stringliteral">&quot;$.&quot;</span>, &amp;<a class="code" href="../../de/d05/structargf.html">argf</a>, <a class="code" href="../../df/d0a/io_8c.html#a323e913f6a1dd87adfde6dc077363506">argf_lineno_getter</a>, <a class="code" href="../../df/d0a/io_8c.html#a8b8d45ef77e057303596b931880df316">argf_lineno_setter</a>);
<a name="l11354"></a>11354     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a196d9fa3b954ec50f5ab17501d46c4ec">rb_define_hooked_variable</a>(<span class="stringliteral">&quot;$FILENAME&quot;</span>, &amp;<a class="code" href="../../de/d05/structargf.html">argf</a>, <a class="code" href="../../df/d0a/io_8c.html#ab7fc95380f06eaf8a2c5929c56c72773">argf_filename_getter</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2e765570aa5fb68b36e0ee87ed60de5f">rb_gvar_readonly_setter</a>);
<a name="l11355"></a>11355     <a class="code" href="../../df/d0a/io_8c.html#afb56bc7fa1b600ed3613eeb47a408a77">ARGF</a>.filename = <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;-&quot;</span>);
<a name="l11356"></a>11356 
<a name="l11357"></a>11357     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a196d9fa3b954ec50f5ab17501d46c4ec">rb_define_hooked_variable</a>(<span class="stringliteral">&quot;$-i&quot;</span>, &amp;<a class="code" href="../../de/d05/structargf.html">argf</a>, <a class="code" href="../../df/d0a/io_8c.html#a24d50d92f0d0e536b208a81052c9cbbc">opt_i_get</a>, <a class="code" href="../../df/d0a/io_8c.html#aab66241c74156834b4ed491ccfb494b3">opt_i_set</a>);
<a name="l11358"></a>11358     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a196d9fa3b954ec50f5ab17501d46c4ec">rb_define_hooked_variable</a>(<span class="stringliteral">&quot;$*&quot;</span>, &amp;<a class="code" href="../../de/d05/structargf.html">argf</a>, <a class="code" href="../../df/d0a/io_8c.html#a5c76b8282648c1a28cb319d07525ad46">argf_argv_getter</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2e765570aa5fb68b36e0ee87ed60de5f">rb_gvar_readonly_setter</a>);
<a name="l11359"></a>11359 
<a name="l11360"></a>11360 <span class="preprocessor">#if defined (_WIN32) || defined(__CYGWIN__)</span>
<a name="l11361"></a>11361 <span class="preprocessor"></span>    atexit(<a class="code" href="../../df/d0a/io_8c.html#a13b5c96773a093946c181cd2e563fabb">pipe_atexit</a>);
<a name="l11362"></a>11362 <span class="preprocessor">#endif</span>
<a name="l11363"></a>11363 <span class="preprocessor"></span>
<a name="l11364"></a>11364     <a class="code" href="../../d6/d13/file_8c.html#aecc76512cdd81557c5d0a26ef8aad7f4">Init_File</a>();
<a name="l11365"></a>11365 
<a name="l11366"></a>11366     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d6/d13/file_8c.html#ae9f03997c2e7a3461524e83053a24ac2">rb_cFile</a>, <span class="stringliteral">&quot;initialize&quot;</span>,  <a class="code" href="../../df/d0a/io_8c.html#a2228ee986dddf2b1cb811eb460097797">rb_file_initialize</a>, -1);
<a name="l11367"></a>11367 
<a name="l11368"></a>11368     <span class="comment">/* open for reading only */</span>
<a name="l11369"></a>11369     <a class="code" href="../../d6/d13/file_8c.html#ae4c9383cc8cedb0d7adaa045ded54ed4">rb_file_const</a>(<span class="stringliteral">&quot;RDONLY&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(O_RDONLY));
<a name="l11370"></a>11370     <span class="comment">/* open for writing only */</span>
<a name="l11371"></a>11371     <a class="code" href="../../d6/d13/file_8c.html#ae4c9383cc8cedb0d7adaa045ded54ed4">rb_file_const</a>(<span class="stringliteral">&quot;WRONLY&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(O_WRONLY));
<a name="l11372"></a>11372     <span class="comment">/* open for reading and writing */</span>
<a name="l11373"></a>11373     <a class="code" href="../../d6/d13/file_8c.html#ae4c9383cc8cedb0d7adaa045ded54ed4">rb_file_const</a>(<span class="stringliteral">&quot;RDWR&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(O_RDWR));
<a name="l11374"></a>11374     <span class="comment">/* append on each write */</span>
<a name="l11375"></a>11375     <a class="code" href="../../d6/d13/file_8c.html#ae4c9383cc8cedb0d7adaa045ded54ed4">rb_file_const</a>(<span class="stringliteral">&quot;APPEND&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(O_APPEND));
<a name="l11376"></a>11376     <span class="comment">/* create file if it does not exist */</span>
<a name="l11377"></a>11377     <a class="code" href="../../d6/d13/file_8c.html#ae4c9383cc8cedb0d7adaa045ded54ed4">rb_file_const</a>(<span class="stringliteral">&quot;CREAT&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(O_CREAT));
<a name="l11378"></a>11378     <span class="comment">/* error if CREAT and the file exists */</span>
<a name="l11379"></a>11379     <a class="code" href="../../d6/d13/file_8c.html#ae4c9383cc8cedb0d7adaa045ded54ed4">rb_file_const</a>(<span class="stringliteral">&quot;EXCL&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(O_EXCL));
<a name="l11380"></a>11380 <span class="preprocessor">#if defined(O_NDELAY) || defined(O_NONBLOCK)</span>
<a name="l11381"></a>11381 <span class="preprocessor"></span><span class="preprocessor"># ifndef O_NONBLOCK</span>
<a name="l11382"></a>11382 <span class="preprocessor"></span><span class="preprocessor">#   define O_NONBLOCK O_NDELAY</span>
<a name="l11383"></a>11383 <span class="preprocessor"></span><span class="preprocessor"># endif</span>
<a name="l11384"></a>11384 <span class="preprocessor"></span>    <span class="comment">/* do not block on open or for data to become available */</span>
<a name="l11385"></a>11385     <a class="code" href="../../d6/d13/file_8c.html#ae4c9383cc8cedb0d7adaa045ded54ed4">rb_file_const</a>(<span class="stringliteral">&quot;NONBLOCK&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../dc/db1/win32_8h.html#a39d33ce33804efd4d52606d59071c6d8">O_NONBLOCK</a>));
<a name="l11386"></a>11386 <span class="preprocessor">#endif</span>
<a name="l11387"></a>11387 <span class="preprocessor"></span>    <span class="comment">/* truncate size to 0 */</span>
<a name="l11388"></a>11388     <a class="code" href="../../d6/d13/file_8c.html#ae4c9383cc8cedb0d7adaa045ded54ed4">rb_file_const</a>(<span class="stringliteral">&quot;TRUNC&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(O_TRUNC));
<a name="l11389"></a>11389 <span class="preprocessor">#ifdef O_NOCTTY</span>
<a name="l11390"></a>11390 <span class="preprocessor"></span>    <span class="comment">/* not to make opened IO the controlling terminal device */</span>
<a name="l11391"></a>11391     <a class="code" href="../../d6/d13/file_8c.html#ae4c9383cc8cedb0d7adaa045ded54ed4">rb_file_const</a>(<span class="stringliteral">&quot;NOCTTY&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(O_NOCTTY));
<a name="l11392"></a>11392 <span class="preprocessor">#endif</span>
<a name="l11393"></a>11393 <span class="preprocessor"></span><span class="preprocessor">#ifndef O_BINARY</span>
<a name="l11394"></a>11394 <span class="preprocessor"></span><span class="preprocessor"># define  O_BINARY 0</span>
<a name="l11395"></a>11395 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l11396"></a>11396 <span class="preprocessor"></span>    <span class="comment">/* disable line code conversion and make ASCII-8BIT */</span>
<a name="l11397"></a>11397     <a class="code" href="../../d6/d13/file_8c.html#ae4c9383cc8cedb0d7adaa045ded54ed4">rb_file_const</a>(<span class="stringliteral">&quot;BINARY&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../d4/db0/__sdbm_8c.html#a36fa9b2e726512bc17a7a6d3e39002be">O_BINARY</a>));
<a name="l11398"></a>11398 <span class="preprocessor">#ifdef O_SYNC</span>
<a name="l11399"></a>11399 <span class="preprocessor"></span>    <a class="code" href="../../d6/d13/file_8c.html#ae4c9383cc8cedb0d7adaa045ded54ed4">rb_file_const</a>(<span class="stringliteral">&quot;SYNC&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(O_SYNC));
<a name="l11400"></a>11400 <span class="preprocessor">#endif</span>
<a name="l11401"></a>11401 <span class="preprocessor"></span><span class="preprocessor">#ifdef O_DSYNC</span>
<a name="l11402"></a>11402 <span class="preprocessor"></span>    <a class="code" href="../../d6/d13/file_8c.html#ae4c9383cc8cedb0d7adaa045ded54ed4">rb_file_const</a>(<span class="stringliteral">&quot;DSYNC&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(O_DSYNC));
<a name="l11403"></a>11403 <span class="preprocessor">#endif</span>
<a name="l11404"></a>11404 <span class="preprocessor"></span><span class="preprocessor">#ifdef O_RSYNC</span>
<a name="l11405"></a>11405 <span class="preprocessor"></span>    <a class="code" href="../../d6/d13/file_8c.html#ae4c9383cc8cedb0d7adaa045ded54ed4">rb_file_const</a>(<span class="stringliteral">&quot;RSYNC&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(O_RSYNC));
<a name="l11406"></a>11406 <span class="preprocessor">#endif</span>
<a name="l11407"></a>11407 <span class="preprocessor"></span><span class="preprocessor">#ifdef O_NOFOLLOW</span>
<a name="l11408"></a>11408 <span class="preprocessor"></span>    <span class="comment">/* do not follow symlinks */</span>
<a name="l11409"></a>11409     <a class="code" href="../../d6/d13/file_8c.html#ae4c9383cc8cedb0d7adaa045ded54ed4">rb_file_const</a>(<span class="stringliteral">&quot;NOFOLLOW&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(O_NOFOLLOW)); <span class="comment">/* FreeBSD, Linux */</span>
<a name="l11410"></a>11410 <span class="preprocessor">#endif</span>
<a name="l11411"></a>11411 <span class="preprocessor"></span><span class="preprocessor">#ifdef O_NOATIME</span>
<a name="l11412"></a>11412 <span class="preprocessor"></span>    <span class="comment">/* do not change atime */</span>
<a name="l11413"></a>11413     <a class="code" href="../../d6/d13/file_8c.html#ae4c9383cc8cedb0d7adaa045ded54ed4">rb_file_const</a>(<span class="stringliteral">&quot;NOATIME&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(O_NOATIME)); <span class="comment">/* Linux */</span>
<a name="l11414"></a>11414 <span class="preprocessor">#endif</span>
<a name="l11415"></a>11415 <span class="preprocessor"></span><span class="preprocessor">#ifdef O_DIRECT</span>
<a name="l11416"></a>11416 <span class="preprocessor"></span>    <span class="comment">/*  Try to minimize cache effects of the I/O to and from this file. */</span>
<a name="l11417"></a>11417     <a class="code" href="../../d6/d13/file_8c.html#ae4c9383cc8cedb0d7adaa045ded54ed4">rb_file_const</a>(<span class="stringliteral">&quot;DIRECT&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(O_DIRECT));
<a name="l11418"></a>11418 <span class="preprocessor">#endif</span>
<a name="l11419"></a>11419 <span class="preprocessor"></span>
<a name="l11420"></a>11420     <a class="code" href="../../df/d0a/io_8c.html#a6fe1eaa40920fbfda47e7975c8b75f37">sym_mode</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;mode&quot;</span>));
<a name="l11421"></a>11421     <a class="code" href="../../df/d0a/io_8c.html#a950cb0a17937f0c0dfe5d07d0f683e62">sym_perm</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;perm&quot;</span>));
<a name="l11422"></a>11422     <a class="code" href="../../df/d0a/io_8c.html#a2bea26a74e408e997bfd7fc4d5af334e">sym_extenc</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;external_encoding&quot;</span>));
<a name="l11423"></a>11423     <a class="code" href="../../df/d0a/io_8c.html#a5ae55baafa10e068146f943efaccd871">sym_intenc</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;internal_encoding&quot;</span>));
<a name="l11424"></a>11424     <a class="code" href="../../df/d0a/io_8c.html#acbc60bfefe79b70198c8b537ba5ffefb">sym_encoding</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;encoding&quot;</span>));
<a name="l11425"></a>11425     <a class="code" href="../../df/d0a/io_8c.html#aa4c5f56edec4d64183c04d42acbdef60">sym_open_args</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;open_args&quot;</span>));
<a name="l11426"></a>11426     <a class="code" href="../../df/d0a/io_8c.html#a059a73cfb0046b6b226bd2ecffc7b20c">sym_textmode</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;textmode&quot;</span>));
<a name="l11427"></a>11427     <a class="code" href="../../df/d0a/io_8c.html#a3dd84f3dee23c52a99275e865290c722">sym_binmode</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;binmode&quot;</span>));
<a name="l11428"></a>11428     <a class="code" href="../../df/d0a/io_8c.html#adc69b3a7193b993c16b2db4379b4f90f">sym_autoclose</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;autoclose&quot;</span>));
<a name="l11429"></a>11429     sym_normal = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;normal&quot;</span>));
<a name="l11430"></a>11430     sym_sequential = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;sequential&quot;</span>));
<a name="l11431"></a>11431     sym_random = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;random&quot;</span>));
<a name="l11432"></a>11432     sym_willneed = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;willneed&quot;</span>));
<a name="l11433"></a>11433     sym_dontneed = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;dontneed&quot;</span>));
<a name="l11434"></a>11434     sym_noreuse = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;noreuse&quot;</span>));
<a name="l11435"></a>11435 }
<a name="l11436"></a>11436 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Mar 2013 for Ruby by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
