<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Ruby: transcode.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>transcode.c</h1><a href="../../d3/d26/transcode_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/**********************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  transcode.c -</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">  $Author: naruse $</span>
<a name="l00006"></a>00006 <span class="comment">  created at: Tue Oct 30 16:10:22 JST 2007</span>
<a name="l00007"></a>00007 <span class="comment"></span>
<a name="l00008"></a>00008 <span class="comment">  Copyright (C) 2007 Martin Duerst</span>
<a name="l00009"></a>00009 <span class="comment"></span>
<a name="l00010"></a>00010 <span class="comment">**********************************************************************/</span>
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="../../de/de6/ruby_2ruby_8h.html">ruby/ruby.h</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/de3/encoding_8h.html">ruby/encoding.h</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="../../db/dde/internal_8h.html">internal.h</a>&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="../../d1/daa/transcode__data_8h.html">transcode_data.h</a>&quot;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00017"></a>00017 
<a name="l00018"></a><a class="code" href="../../d3/d26/transcode_8c.html#a4166cb222753fc273813e1305ea4201d">00018</a> <span class="preprocessor">#define ENABLE_ECONV_NEWLINE_OPTION 1</span>
<a name="l00019"></a>00019 <span class="preprocessor"></span>
<a name="l00020"></a>00020 <span class="comment">/* VALUE rb_cEncoding = rb_define_class(&quot;Encoding&quot;, rb_cObject); */</span>
<a name="l00021"></a><a class="code" href="../../d3/d26/transcode_8c.html#a7e3c5b7bbf0d72e13a75254e8ab972ee">00021</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#a7e3c5b7bbf0d72e13a75254e8ab972ee">rb_eUndefinedConversionError</a>;
<a name="l00022"></a><a class="code" href="../../d3/d26/transcode_8c.html#a03c8ae0d4551172220b5981e68539795">00022</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#a03c8ae0d4551172220b5981e68539795">rb_eInvalidByteSequenceError</a>;
<a name="l00023"></a><a class="code" href="../../d3/d26/transcode_8c.html#a17f7c97579ac483f021702f0a8f190ec">00023</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#a17f7c97579ac483f021702f0a8f190ec">rb_eConverterNotFoundError</a>;
<a name="l00024"></a>00024 
<a name="l00025"></a><a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">00025</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>;
<a name="l00026"></a>00026 
<a name="l00027"></a><a class="code" href="../../d3/d26/transcode_8c.html#ade065fa49e1a8a7c21017d79d31da9a7">00027</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#a386d27e7ebcb09b9e3beb9c1be41aabe">sym_invalid</a>, <a class="code" href="../../d3/d26/transcode_8c.html#ade065fa49e1a8a7c21017d79d31da9a7">sym_undef</a>, <a class="code" href="../../d3/d26/transcode_8c.html#ab15aaca5bc3b3652d2c7b243bec3c342">sym_replace</a>, <a class="code" href="../../d3/d26/transcode_8c.html#a338cb4cb4bd7d8994da411e0b1bfbb21">sym_fallback</a>, <a class="code" href="../../d3/d26/transcode_8c.html#a000881fcf4572b2a9a3216b3aeae05dc">sym_aref</a>;
<a name="l00028"></a><a class="code" href="../../d3/d26/transcode_8c.html#a6280c8826ff0dd1c47767aab5d17452b">00028</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#a6280c8826ff0dd1c47767aab5d17452b">sym_xml</a>, <a class="code" href="../../d3/d26/transcode_8c.html#a7a02b57ce7a33ad046278fbee16b0224">sym_text</a>, <a class="code" href="../../d3/d26/transcode_8c.html#a131583b160da3ae2c6ba8c0686037596">sym_attr</a>;
<a name="l00029"></a><a class="code" href="../../d3/d26/transcode_8c.html#a544876157eb56fdee18d20866275045d">00029</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#a544876157eb56fdee18d20866275045d">sym_universal_newline</a>;
<a name="l00030"></a><a class="code" href="../../d3/d26/transcode_8c.html#a4eb4af234eff2e556aaff8d5583a182e">00030</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#a4eb4af234eff2e556aaff8d5583a182e">sym_crlf_newline</a>;
<a name="l00031"></a><a class="code" href="../../d3/d26/transcode_8c.html#ad2b9d4c5055c29b3f5ead8fe8218d74c">00031</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#ad2b9d4c5055c29b3f5ead8fe8218d74c">sym_cr_newline</a>;
<a name="l00032"></a>00032 <span class="preprocessor">#ifdef ENABLE_ECONV_NEWLINE_OPTION</span>
<a name="l00033"></a><a class="code" href="../../d3/d26/transcode_8c.html#a865013f3f9a72c761d4f62c492bdac32">00033</a> <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#a2e8f88ddab931a79be2bb4dabf52e5f3">sym_newline</a>, <a class="code" href="../../d3/d26/transcode_8c.html#a865013f3f9a72c761d4f62c492bdac32">sym_universal</a>, <a class="code" href="../../d3/d26/transcode_8c.html#a9e00c2b0789779dc6c482d37301c11e2">sym_crlf</a>, <a class="code" href="../../d3/d26/transcode_8c.html#ab80c9d144cbc45017e4a43a1edfa6839">sym_cr</a>, <a class="code" href="../../d3/d26/transcode_8c.html#ac7906406a2eed9ca677be5ee09187c36">sym_lf</a>;
<a name="l00034"></a>00034 <span class="preprocessor">#endif</span>
<a name="l00035"></a><a class="code" href="../../d3/d26/transcode_8c.html#a1bcb1cddad7f1faa7bcac7e136592a7f">00035</a> <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#a1bcb1cddad7f1faa7bcac7e136592a7f">sym_partial_input</a>;
<a name="l00036"></a>00036 
<a name="l00037"></a><a class="code" href="../../d3/d26/transcode_8c.html#a030b203c7ef931bd8f26d07580e6bdd2">00037</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#a030b203c7ef931bd8f26d07580e6bdd2">sym_invalid_byte_sequence</a>;
<a name="l00038"></a><a class="code" href="../../d3/d26/transcode_8c.html#ad2faaaa9fca9c44a031ef9b9dbee67c9">00038</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#ad2faaaa9fca9c44a031ef9b9dbee67c9">sym_undefined_conversion</a>;
<a name="l00039"></a><a class="code" href="../../d3/d26/transcode_8c.html#ad1e9bae611dd45dfca6a189c14a332dc">00039</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#ad1e9bae611dd45dfca6a189c14a332dc">sym_destination_buffer_full</a>;
<a name="l00040"></a><a class="code" href="../../d3/d26/transcode_8c.html#afb60cd128cc303ec90f2f093e90c6784">00040</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#afb60cd128cc303ec90f2f093e90c6784">sym_source_buffer_empty</a>;
<a name="l00041"></a><a class="code" href="../../d3/d26/transcode_8c.html#ac483d0155fcd9b9db482928ebd1ef465">00041</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#ac483d0155fcd9b9db482928ebd1ef465">sym_finished</a>;
<a name="l00042"></a><a class="code" href="../../d3/d26/transcode_8c.html#a4eefe22a7d2bf258488987a25134318c">00042</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#a4eefe22a7d2bf258488987a25134318c">sym_after_output</a>;
<a name="l00043"></a><a class="code" href="../../d3/d26/transcode_8c.html#aaabae663ba3655668c5f4a2149091a12">00043</a> <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#aaabae663ba3655668c5f4a2149091a12">sym_incomplete_input</a>;
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *
<a name="l00046"></a>00046 <a class="code" href="../../d3/d26/transcode_8c.html#a0fc07e0e3b60bf263ead254b4245a56b">allocate_converted_string</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sname, <span class="keyword">const</span> <span class="keywordtype">char</span> *dname,
<a name="l00047"></a>00047         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *str, <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>,
<a name="l00048"></a>00048         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *caller_dst_buf, <span class="keywordtype">size_t</span> caller_dst_bufsize,
<a name="l00049"></a>00049         <span class="keywordtype">size_t</span> *dst_len_ptr);
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="comment">/* dynamic structure, one per conversion (similar to iconv_t) */</span>
<a name="l00052"></a>00052 <span class="comment">/* may carry conversion state (e.g. for iso-2022-jp) */</span>
<a name="l00053"></a><a class="code" href="../../de/d43/structrb__transcoding.html">00053</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> {
<a name="l00054"></a><a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">00054</a>     <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>;
<a name="l00055"></a>00055 
<a name="l00056"></a><a class="code" href="../../de/d43/structrb__transcoding.html#a550eb155bcb2efe7f5583691467d12a3">00056</a>     <span class="keywordtype">int</span> <a class="code" href="../../de/d43/structrb__transcoding.html#a550eb155bcb2efe7f5583691467d12a3">flags</a>;
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="../../de/d43/structrb__transcoding.html#a59b9de3ef003aa4d036bdc73382e6d14">00058</a>     <span class="keywordtype">int</span> <a class="code" href="../../de/d43/structrb__transcoding.html#a59b9de3ef003aa4d036bdc73382e6d14">resume_position</a>;
<a name="l00059"></a><a class="code" href="../../de/d43/structrb__transcoding.html#a4e49f092f04f49a36246beb182e98e82">00059</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d43/structrb__transcoding.html#a4e49f092f04f49a36246beb182e98e82">next_table</a>;
<a name="l00060"></a><a class="code" href="../../de/d43/structrb__transcoding.html#a8be28d9a4c1ded892b1bb7d8a283fdd2">00060</a>     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/d43/structrb__transcoding.html#a8be28d9a4c1ded892b1bb7d8a283fdd2">next_info</a>;
<a name="l00061"></a><a class="code" href="../../de/d43/structrb__transcoding.html#a44aaa8a3694b5ce749951647d9d7b5e1">00061</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../de/d43/structrb__transcoding.html#a44aaa8a3694b5ce749951647d9d7b5e1">next_byte</a>;
<a name="l00062"></a><a class="code" href="../../de/d43/structrb__transcoding.html#a1bcd79e5de50ab64e6ddf07ffb8b8ee8">00062</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="../../de/d43/structrb__transcoding.html#a1bcd79e5de50ab64e6ddf07ffb8b8ee8">output_index</a>;
<a name="l00063"></a>00063 
<a name="l00064"></a><a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">00064</a>     ssize_t <a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a>; <span class="comment">/* already interpreted */</span>
<a name="l00065"></a><a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">00065</a>     ssize_t <a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a>; <span class="comment">/* not yet interpreted */</span>
<a name="l00066"></a>00066     <span class="keyword">union </span>{
<a name="l00067"></a><a class="code" href="../../de/d43/structrb__transcoding.html#a827892114bcb2e6ffa9c712cf903b50e">00067</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../de/d43/structrb__transcoding.html#a827892114bcb2e6ffa9c712cf903b50e">ary</a>[8]; <span class="comment">/* max_input &lt;= sizeof(ary) */</span>
<a name="l00068"></a><a class="code" href="../../de/d43/structrb__transcoding.html#abb4a3730587e9a87391ab6328cc08c3c">00068</a>         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../de/d43/structrb__transcoding.html#abb4a3730587e9a87391ab6328cc08c3c">ptr</a>; <span class="comment">/* length: max_input */</span>
<a name="l00069"></a>00069     } <a class="code" href="../../de/d43/structrb__transcoding.html#adee4c9606257219f0aa293751e086066">readbuf</a>; <span class="comment">/* recognized_len + readagain_len used */</span>
<a name="l00070"></a>00070 
<a name="l00071"></a><a class="code" href="../../de/d43/structrb__transcoding.html#afb83f2ba03f3b9050623abd8d7cd80e4">00071</a>     ssize_t <a class="code" href="../../de/d43/structrb__transcoding.html#afb83f2ba03f3b9050623abd8d7cd80e4">writebuf_off</a>;
<a name="l00072"></a><a class="code" href="../../de/d43/structrb__transcoding.html#a829bec6102fbf1f8670412aa8354c799">00072</a>     ssize_t <a class="code" href="../../de/d43/structrb__transcoding.html#a829bec6102fbf1f8670412aa8354c799">writebuf_len</a>;
<a name="l00073"></a>00073     <span class="keyword">union </span>{
<a name="l00074"></a>00074         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="../../de/d43/structrb__transcoding.html#a827892114bcb2e6ffa9c712cf903b50e">ary</a>[8]; <span class="comment">/* max_output &lt;= sizeof(ary) */</span>
<a name="l00075"></a>00075         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../de/d43/structrb__transcoding.html#abb4a3730587e9a87391ab6328cc08c3c">ptr</a>; <span class="comment">/* length: max_output */</span>
<a name="l00076"></a>00076     } <a class="code" href="../../de/d43/structrb__transcoding.html#a92fdfeb12592a34773f23e30ce1adc19">writebuf</a>;
<a name="l00077"></a>00077 
<a name="l00078"></a><a class="code" href="../../d5/db5/unionrb__transcoding_1_1rb__transcoding__state__t.html">00078</a>     <span class="keyword">union </span><a class="code" href="../../d5/db5/unionrb__transcoding_1_1rb__transcoding__state__t.html">rb_transcoding_state_t</a> { <span class="comment">/* opaque data for stateful encoding */</span>
<a name="l00079"></a><a class="code" href="../../d5/db5/unionrb__transcoding_1_1rb__transcoding__state__t.html#ad9caf1273f0e388d06679cdf16acbbb2">00079</a>         <span class="keywordtype">void</span> *<a class="code" href="../../d5/db5/unionrb__transcoding_1_1rb__transcoding__state__t.html#ad9caf1273f0e388d06679cdf16acbbb2">ptr</a>;
<a name="l00080"></a><a class="code" href="../../d5/db5/unionrb__transcoding_1_1rb__transcoding__state__t.html#a7a7504989a4eb93bbf254d84d9e83c1d">00080</a>         <span class="keywordtype">char</span> <a class="code" href="../../d5/db5/unionrb__transcoding_1_1rb__transcoding__state__t.html#a7a7504989a4eb93bbf254d84d9e83c1d">ary</a>[<span class="keyword">sizeof</span>(double) &gt; <span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*) ? <span class="keyword">sizeof</span>(double) : <span class="keyword">sizeof</span>(<span class="keywordtype">void</span>*)];
<a name="l00081"></a><a class="code" href="../../d5/db5/unionrb__transcoding_1_1rb__transcoding__state__t.html#a4f1bac5b505b7c0aa9735accba1d75fa">00081</a>         <span class="keywordtype">double</span> <a class="code" href="../../d5/db5/unionrb__transcoding_1_1rb__transcoding__state__t.html#a4f1bac5b505b7c0aa9735accba1d75fa">dummy_for_alignment</a>;
<a name="l00082"></a>00082     } <a class="code" href="../../d5/d1d/gb18030_8c.html#adc6e5733fc3c22f0a7b2914188c49c90">state</a>;
<a name="l00083"></a>00083 } <a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a>;
<a name="l00084"></a><a class="code" href="../../d3/d26/transcode_8c.html#ac3dbd4c95ffc9795e96366aa0aa0301a">00084</a> <span class="preprocessor">#define TRANSCODING_READBUF(tc) \</span>
<a name="l00085"></a>00085 <span class="preprocessor">    ((tc)-&gt;transcoder-&gt;max_input &lt;= (int)sizeof((tc)-&gt;readbuf.ary) ? \</span>
<a name="l00086"></a>00086 <span class="preprocessor">     (tc)-&gt;readbuf.ary : \</span>
<a name="l00087"></a>00087 <span class="preprocessor">     (tc)-&gt;readbuf.ptr)</span>
<a name="l00088"></a><a class="code" href="../../d3/d26/transcode_8c.html#a00f64a48e2cbd506b8c949985577ba54">00088</a> <span class="preprocessor"></span><span class="preprocessor">#define TRANSCODING_WRITEBUF(tc) \</span>
<a name="l00089"></a>00089 <span class="preprocessor">    ((tc)-&gt;transcoder-&gt;max_output &lt;= (int)sizeof((tc)-&gt;writebuf.ary) ? \</span>
<a name="l00090"></a>00090 <span class="preprocessor">     (tc)-&gt;writebuf.ary : \</span>
<a name="l00091"></a>00091 <span class="preprocessor">     (tc)-&gt;writebuf.ptr)</span>
<a name="l00092"></a><a class="code" href="../../d3/d26/transcode_8c.html#a65291fffd0cc25a799eaa04206628689">00092</a> <span class="preprocessor"></span><span class="preprocessor">#define TRANSCODING_WRITEBUF_SIZE(tc) \</span>
<a name="l00093"></a>00093 <span class="preprocessor">    ((tc)-&gt;transcoder-&gt;max_output &lt;= (int)sizeof((tc)-&gt;writebuf.ary) ? \</span>
<a name="l00094"></a>00094 <span class="preprocessor">     sizeof((tc)-&gt;writebuf.ary) : \</span>
<a name="l00095"></a>00095 <span class="preprocessor">     (size_t)(tc)-&gt;transcoder-&gt;max_output)</span>
<a name="l00096"></a><a class="code" href="../../d3/d26/transcode_8c.html#af3e05177b0c8338d3ebc0733af9b3e85">00096</a> <span class="preprocessor"></span><span class="preprocessor">#define TRANSCODING_STATE_EMBED_MAX ((int)sizeof(union rb_transcoding_state_t))</span>
<a name="l00097"></a><a class="code" href="../../d3/d26/transcode_8c.html#a2fc6206e66155edb648615350dfd7f26">00097</a> <span class="preprocessor"></span><span class="preprocessor">#define TRANSCODING_STATE(tc) \</span>
<a name="l00098"></a>00098 <span class="preprocessor">    ((tc)-&gt;transcoder-&gt;state_size &lt;= (int)sizeof((tc)-&gt;state) ? \</span>
<a name="l00099"></a>00099 <span class="preprocessor">     (tc)-&gt;state.ary : \</span>
<a name="l00100"></a>00100 <span class="preprocessor">     (tc)-&gt;state.ptr)</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>
<a name="l00102"></a><a class="code" href="../../d5/d6c/structrb__econv__elem__t.html">00102</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00103"></a><a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">00103</a>     <span class="keyword">struct </span><a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *tc;
<a name="l00104"></a><a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a854388ef0bc7a190f14bc1ff6c99494a">00104</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out_buf_start;
<a name="l00105"></a><a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a4022fc650a937371403f1b17ebd1d24d">00105</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out_data_start;
<a name="l00106"></a><a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#af6319607c08232cd7c528a5e0f18c408">00106</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out_data_end;
<a name="l00107"></a><a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#aeb112d51d22fbc31883328b8855a7ee4">00107</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out_buf_end;
<a name="l00108"></a><a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#ab0e4131eb67e1748b32a847875731c95">00108</a>     <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a> last_result;
<a name="l00109"></a>00109 } <a class="code" href="../../d5/d6c/structrb__econv__elem__t.html">rb_econv_elem_t</a>;
<a name="l00110"></a>00110 
<a name="l00111"></a><a class="code" href="../../d3/d06/structrb__econv__t.html">00111</a> <span class="keyword">struct </span><a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> {
<a name="l00112"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#afe610e62515fe51de0398ca90a6a891b">00112</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/d06/structrb__econv__t.html#afe610e62515fe51de0398ca90a6a891b">flags</a>;
<a name="l00113"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#a22bbe71170a0fbfce6b1ac29c7677f4c">00113</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/d06/structrb__econv__t.html#a22bbe71170a0fbfce6b1ac29c7677f4c">source_encoding_name</a>;
<a name="l00114"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#afd32fa6d348fa4997c2ec5dde2001c79">00114</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/d06/structrb__econv__t.html#afd32fa6d348fa4997c2ec5dde2001c79">destination_encoding_name</a>;
<a name="l00115"></a>00115 
<a name="l00116"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#a7e2bbe100caa442ca786b221a06a3e7b">00116</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/d06/structrb__econv__t.html#a7e2bbe100caa442ca786b221a06a3e7b">started</a>;
<a name="l00117"></a>00117 
<a name="l00118"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#ac9ef89b6cd3baa02b8ec83f49a2d3a2b">00118</a>     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9ef89b6cd3baa02b8ec83f49a2d3a2b">replacement_str</a>;
<a name="l00119"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#a40e67fdbe80e48a19ecfeaa9358fd4c2">00119</a>     <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d06/structrb__econv__t.html#a40e67fdbe80e48a19ecfeaa9358fd4c2">replacement_len</a>;
<a name="l00120"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#a875d42c5055651a75e9172e89a53c7c8">00120</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/d06/structrb__econv__t.html#a875d42c5055651a75e9172e89a53c7c8">replacement_enc</a>;
<a name="l00121"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#ab257a4ed6f3ca457a32ee1304af2c038">00121</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/d06/structrb__econv__t.html#ab257a4ed6f3ca457a32ee1304af2c038">replacement_allocated</a>;
<a name="l00122"></a>00122 
<a name="l00123"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#a0604b16d6b3c882135b53011c762d1a2">00123</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/d06/structrb__econv__t.html#a0604b16d6b3c882135b53011c762d1a2">in_buf_start</a>;
<a name="l00124"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#a79204dbf92e8b20a7e7fd3513667a6fb">00124</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/d06/structrb__econv__t.html#a79204dbf92e8b20a7e7fd3513667a6fb">in_data_start</a>;
<a name="l00125"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#ade30d9cec3597c3d2d44df9e312760d9">00125</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/d06/structrb__econv__t.html#ade30d9cec3597c3d2d44df9e312760d9">in_data_end</a>;
<a name="l00126"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#a40505b1017d6d6c00a616509e42d50f0">00126</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/d06/structrb__econv__t.html#a40505b1017d6d6c00a616509e42d50f0">in_buf_end</a>;
<a name="l00127"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">00127</a>     <a class="code" href="../../d5/d6c/structrb__econv__elem__t.html">rb_econv_elem_t</a> *<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>;
<a name="l00128"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#aec32851f840def8d195bcaa7de1ea4ad">00128</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/d06/structrb__econv__t.html#aec32851f840def8d195bcaa7de1ea4ad">num_allocated</a>;
<a name="l00129"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">00129</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>;
<a name="l00130"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#affe06137c41d5acc36b506e3222be524">00130</a>     <span class="keywordtype">int</span> <a class="code" href="../../d3/d06/structrb__econv__t.html#affe06137c41d5acc36b506e3222be524">num_finished</a>;
<a name="l00131"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#acb260f341ee3fbd97d43a8b5f2c067bd">00131</a>     <span class="keyword">struct </span><a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *<a class="code" href="../../d3/d06/structrb__econv__t.html#acb260f341ee3fbd97d43a8b5f2c067bd">last_tc</a>;
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     <span class="comment">/* last error */</span>
<a name="l00134"></a>00134     <span class="keyword">struct </span>{
<a name="l00135"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#ac9db5877b884b6345adb4bd2a0b65b70">00135</a>         <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a> <a class="code" href="../../d3/d06/structrb__econv__t.html#ac9db5877b884b6345adb4bd2a0b65b70">result</a>;
<a name="l00136"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#a5b07cda3f87918e9a3c3b957dbca3522">00136</a>         <span class="keyword">struct </span><a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *<a class="code" href="../../d3/d06/structrb__econv__t.html#a5b07cda3f87918e9a3c3b957dbca3522">error_tc</a>;
<a name="l00137"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">00137</a>         <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>;
<a name="l00138"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">00138</a>         <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a>;
<a name="l00139"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#afa032001f9163782b3ffd3f7719c01b2">00139</a>         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../d3/d06/structrb__econv__t.html#afa032001f9163782b3ffd3f7719c01b2">error_bytes_start</a>;
<a name="l00140"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#a18f4b226842af7c0c379bf21646409af">00140</a>         <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d06/structrb__econv__t.html#a18f4b226842af7c0c379bf21646409af">error_bytes_len</a>;
<a name="l00141"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#a2eb533677cfc48e764a7940f034b1634">00141</a>         <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d06/structrb__econv__t.html#a2eb533677cfc48e764a7940f034b1634">readagain_len</a>;
<a name="l00142"></a>00142     } <a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>;
<a name="l00143"></a>00143 
<a name="l00144"></a>00144     <span class="comment">/* The following fields are only for Encoding::Converter.</span>
<a name="l00145"></a>00145 <span class="comment">     * rb_econv_open set them NULL. */</span>
<a name="l00146"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#a79c2a21d69ba7e8f8e9810346cd4a18b">00146</a>     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>;
<a name="l00147"></a><a class="code" href="../../d3/d06/structrb__econv__t.html#a05a434e12b48303b08940fcc6e181f12">00147</a>     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a>;
<a name="l00148"></a>00148 };
<a name="l00149"></a>00149 
<a name="l00150"></a>00150 <span class="comment">/*</span>
<a name="l00151"></a>00151 <span class="comment"> *  Dispatch data and logic</span>
<a name="l00152"></a>00152 <span class="comment"> */</span>
<a name="l00153"></a>00153 
<a name="l00154"></a><a class="code" href="../../d3/d26/transcode_8c.html#a7a9d71f951b9b292988b798f4f6bc29b">00154</a> <span class="preprocessor">#define DECORATOR_P(sname, dname) (*(sname) == &apos;\0&apos;)</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span>
<a name="l00156"></a><a class="code" href="../../d0/dce/structtranscoder__entry__t.html">00156</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00157"></a><a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a132676776d5c8c4ed6e70c15bbba323c">00157</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *sname;
<a name="l00158"></a><a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a601b28ba13d193332a7233804e3342d8">00158</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *dname;
<a name="l00159"></a><a class="code" href="../../d0/dce/structtranscoder__entry__t.html#ab623030b340d3d991d48d9424c4b1b38">00159</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *lib; <span class="comment">/* null means means no need to load a library */</span>
<a name="l00160"></a><a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a5bfe980db45acff299fe669432518b8b">00160</a>     <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>;
<a name="l00161"></a>00161 } <a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a>;
<a name="l00162"></a>00162 
<a name="l00163"></a><a class="code" href="../../d3/d26/transcode_8c.html#a1bd7fa18ed26f3b87bbf36a1fbbd86e0">00163</a> <span class="keyword">static</span> <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *<a class="code" href="../../d3/d26/transcode_8c.html#a1bd7fa18ed26f3b87bbf36a1fbbd86e0">transcoder_table</a>;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165 <span class="keyword">static</span> <a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> *
<a name="l00166"></a><a class="code" href="../../d3/d26/transcode_8c.html#a765fc5d7118ae84a35679056b8262975">00166</a> <a class="code" href="../../d3/d26/transcode_8c.html#a765fc5d7118ae84a35679056b8262975">make_transcoder_entry</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sname, <span class="keyword">const</span> <span class="keywordtype">char</span> *dname)
<a name="l00167"></a>00167 {
<a name="l00168"></a>00168     <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> val;
<a name="l00169"></a>00169     <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table2;
<a name="l00170"></a>00170 
<a name="l00171"></a>00171     <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(transcoder_table, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)sname, &amp;val)) {
<a name="l00172"></a>00172         val = (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)<a class="code" href="../../dd/d24/st_8h.html#a60f14cceadd837db51e110881258944a">st_init_strcasetable</a>();
<a name="l00173"></a>00173         <a class="code" href="../../dd/d24/st_8h.html#aee4e16ae99cd543ddf851107d5ea5408">st_add_direct</a>(transcoder_table, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)sname, val);
<a name="l00174"></a>00174     }
<a name="l00175"></a>00175     table2 = (<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *)val;
<a name="l00176"></a>00176     <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(table2, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)dname, &amp;val)) {
<a name="l00177"></a>00177         <a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> *entry = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac8df5a8a8961bd9e16be385fef28c2f2">ALLOC</a>(<a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a>);
<a name="l00178"></a>00178         entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a132676776d5c8c4ed6e70c15bbba323c">sname</a> = sname;
<a name="l00179"></a>00179         entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a601b28ba13d193332a7233804e3342d8">dname</a> = dname;
<a name="l00180"></a>00180         entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#ab623030b340d3d991d48d9424c4b1b38">lib</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00181"></a>00181         entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a5bfe980db45acff299fe669432518b8b">transcoder</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00182"></a>00182         val = (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)entry;
<a name="l00183"></a>00183         <a class="code" href="../../dd/d24/st_8h.html#aee4e16ae99cd543ddf851107d5ea5408">st_add_direct</a>(table2, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)dname, val);
<a name="l00184"></a>00184     }
<a name="l00185"></a>00185     <span class="keywordflow">return</span> (<a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> *)val;
<a name="l00186"></a>00186 }
<a name="l00187"></a>00187 
<a name="l00188"></a>00188 <span class="keyword">static</span> <a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> *
<a name="l00189"></a><a class="code" href="../../d3/d26/transcode_8c.html#a0d3a31f80907a117b9c8b3170e3f8bbd">00189</a> <a class="code" href="../../d3/d26/transcode_8c.html#a0d3a31f80907a117b9c8b3170e3f8bbd">get_transcoder_entry</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sname, <span class="keyword">const</span> <span class="keywordtype">char</span> *dname)
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191     <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> val;
<a name="l00192"></a>00192     <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table2;
<a name="l00193"></a>00193 
<a name="l00194"></a>00194     <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(transcoder_table, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)sname, &amp;val)) {
<a name="l00195"></a>00195         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00196"></a>00196     }
<a name="l00197"></a>00197     table2 = (<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *)val;
<a name="l00198"></a>00198     <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(table2, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)dname, &amp;val)) {
<a name="l00199"></a>00199         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00200"></a>00200     }
<a name="l00201"></a>00201     <span class="keywordflow">return</span> (<a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> *)val;
<a name="l00202"></a>00202 }
<a name="l00203"></a>00203 
<a name="l00204"></a>00204 <span class="keywordtype">void</span>
<a name="l00205"></a><a class="code" href="../../d1/daa/transcode__data_8h.html#aac1b9547f321e5a6b63c2be50c42e238">00205</a> <a class="code" href="../../d3/d26/transcode_8c.html#ae96f79670ec5f2a03fc84f51f220d194">rb_register_transcoder</a>(<span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a>)
<a name="l00206"></a>00206 {
<a name="l00207"></a>00207     <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> sname = tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a6f79077ecbd8da45cc181b53dc280a90">src_encoding</a>;
<a name="l00208"></a>00208     <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> dname = tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a06f17fbc59c9055646b1a147d05f33eb">dst_encoding</a>;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> *entry;
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     entry = <a class="code" href="../../d3/d26/transcode_8c.html#a765fc5d7118ae84a35679056b8262975">make_transcoder_entry</a>(sname, dname);
<a name="l00213"></a>00213     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a5bfe980db45acff299fe669432518b8b">transcoder</a>) {
<a name="l00214"></a>00214         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;transcoder from %s to %s has been already registered&quot;</span>,
<a name="l00215"></a>00215                  sname, dname);
<a name="l00216"></a>00216     }
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a5bfe980db45acff299fe669432518b8b">transcoder</a> = tr;
<a name="l00219"></a>00219 }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00222"></a><a class="code" href="../../d3/d26/transcode_8c.html#a08e0c719fb9bb79869ff915e099fd142">00222</a> <a class="code" href="../../d3/d26/transcode_8c.html#a08e0c719fb9bb79869ff915e099fd142">declare_transcoder</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sname, <span class="keyword">const</span> <span class="keywordtype">char</span> *dname, <span class="keyword">const</span> <span class="keywordtype">char</span> *lib)
<a name="l00223"></a>00223 {
<a name="l00224"></a>00224     <a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> *entry;
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     entry = <a class="code" href="../../d3/d26/transcode_8c.html#a765fc5d7118ae84a35679056b8262975">make_transcoder_entry</a>(sname, dname);
<a name="l00227"></a>00227     entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#ab623030b340d3d991d48d9424c4b1b38">lib</a> = lib;
<a name="l00228"></a>00228 }
<a name="l00229"></a>00229 
<a name="l00230"></a><a class="code" href="../../d3/d26/transcode_8c.html#a13ad25fb43f455d7c5f0f1a1f9d2e22c">00230</a> <span class="preprocessor">#define MAX_TRANSCODER_LIBNAME_LEN 64</span>
<a name="l00231"></a><a class="code" href="../../d3/d26/transcode_8c.html#ae2cabb61a2f1e8f92b9a0e1835daf2a7">00231</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="../../d3/d26/transcode_8c.html#ae2cabb61a2f1e8f92b9a0e1835daf2a7">transcoder_lib_prefix</a>[] = <span class="stringliteral">&quot;enc/trans/&quot;</span>;
<a name="l00232"></a>00232 
<a name="l00233"></a>00233 <span class="keywordtype">void</span>
<a name="l00234"></a><a class="code" href="../../d1/daa/transcode__data_8h.html#a5448d6a5fe7f3ab1200f0b3a017e4bed">00234</a> <a class="code" href="../../da/d56/transdb_8c.html#a5448d6a5fe7f3ab1200f0b3a017e4bed">rb_declare_transcoder</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *enc1, <span class="keyword">const</span> <span class="keywordtype">char</span> *enc2, <span class="keyword">const</span> <span class="keywordtype">char</span> *lib)
<a name="l00235"></a>00235 {
<a name="l00236"></a>00236     <span class="keywordflow">if</span> (!lib || <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(lib) &gt; <a class="code" href="../../d3/d26/transcode_8c.html#a13ad25fb43f455d7c5f0f1a1f9d2e22c">MAX_TRANSCODER_LIBNAME_LEN</a>) {
<a name="l00237"></a>00237         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;invalid library name - %s&quot;</span>,
<a name="l00238"></a>00238                  lib ? lib : <span class="stringliteral">&quot;(null)&quot;</span>);
<a name="l00239"></a>00239     }
<a name="l00240"></a>00240     <a class="code" href="../../d3/d26/transcode_8c.html#a08e0c719fb9bb79869ff915e099fd142">declare_transcoder</a>(enc1, enc2, lib);
<a name="l00241"></a>00241 }
<a name="l00242"></a>00242 
<a name="l00243"></a><a class="code" href="../../d3/d26/transcode_8c.html#adc12ab3195f23d65f243fe172370e950">00243</a> <span class="preprocessor">#define encoding_equal(enc1, enc2) (STRCASECMP((enc1), (enc2)) == 0)</span>
<a name="l00244"></a>00244 <span class="preprocessor"></span>
<a name="l00245"></a><a class="code" href="../../dd/d63/structsearch__path__queue__tag.html">00245</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../dd/d63/structsearch__path__queue__tag.html">search_path_queue_tag</a> {
<a name="l00246"></a><a class="code" href="../../dd/d63/structsearch__path__queue__tag.html#aadf9b6c8c2b14719f51c720fc1e1e54c">00246</a>     <span class="keyword">struct </span><a class="code" href="../../dd/d63/structsearch__path__queue__tag.html">search_path_queue_tag</a> *<a class="code" href="../../dd/d63/structsearch__path__queue__tag.html#aadf9b6c8c2b14719f51c720fc1e1e54c">next</a>;
<a name="l00247"></a><a class="code" href="../../dd/d63/structsearch__path__queue__tag.html#a202f4cee576807c070edde8f67877700">00247</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../dd/d63/structsearch__path__queue__tag.html#a202f4cee576807c070edde8f67877700">enc</a>;
<a name="l00248"></a>00248 } <a class="code" href="../../dd/d63/structsearch__path__queue__tag.html">search_path_queue_t</a>;
<a name="l00249"></a>00249 
<a name="l00250"></a><a class="code" href="../../df/dde/structsearch__path__bfs__t.html">00250</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00251"></a><a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3111865e63aadaec38b6c221ec79f1b4">00251</a>     <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *visited;
<a name="l00252"></a><a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3fc436af46bf07935d44c974005011f3">00252</a>     <a class="code" href="../../dd/d63/structsearch__path__queue__tag.html">search_path_queue_t</a> *queue;
<a name="l00253"></a><a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a825474e006eb27a81b7aae5e7112e1b2">00253</a>     <a class="code" href="../../dd/d63/structsearch__path__queue__tag.html">search_path_queue_t</a> **queue_last_ptr;
<a name="l00254"></a><a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a78341adf1bb149c42fd6b2422b20641c">00254</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *base_enc;
<a name="l00255"></a>00255 } <a class="code" href="../../df/dde/structsearch__path__bfs__t.html">search_path_bfs_t</a>;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00258"></a><a class="code" href="../../d3/d26/transcode_8c.html#a844d13cedcde71ccd96d3033d50d8c42">00258</a> <a class="code" href="../../d3/d26/transcode_8c.html#a844d13cedcde71ccd96d3033d50d8c42">transcode_search_path_i</a>(<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> val, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> arg)
<a name="l00259"></a>00259 {
<a name="l00260"></a>00260     <span class="keyword">const</span> <span class="keywordtype">char</span> *dname = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)key;
<a name="l00261"></a>00261     <a class="code" href="../../df/dde/structsearch__path__bfs__t.html">search_path_bfs_t</a> *bfs = (<a class="code" href="../../df/dde/structsearch__path__bfs__t.html">search_path_bfs_t</a> *)arg;
<a name="l00262"></a>00262     <a class="code" href="../../dd/d63/structsearch__path__queue__tag.html">search_path_queue_t</a> *q;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(bfs-&gt;<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3111865e63aadaec38b6c221ec79f1b4">visited</a>, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)dname, &amp;val)) {
<a name="l00265"></a>00265         <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>;
<a name="l00266"></a>00266     }
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     q = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac8df5a8a8961bd9e16be385fef28c2f2">ALLOC</a>(<a class="code" href="../../dd/d63/structsearch__path__queue__tag.html">search_path_queue_t</a>);
<a name="l00269"></a>00269     q-&gt;<a class="code" href="../../dd/d63/structsearch__path__queue__tag.html#a202f4cee576807c070edde8f67877700">enc</a> = dname;
<a name="l00270"></a>00270     q-&gt;<a class="code" href="../../dd/d63/structsearch__path__queue__tag.html#aadf9b6c8c2b14719f51c720fc1e1e54c">next</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00271"></a>00271     *bfs-&gt;<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a825474e006eb27a81b7aae5e7112e1b2">queue_last_ptr</a> = q;
<a name="l00272"></a>00272     bfs-&gt;<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a825474e006eb27a81b7aae5e7112e1b2">queue_last_ptr</a> = &amp;q-&gt;<a class="code" href="../../dd/d63/structsearch__path__queue__tag.html#aadf9b6c8c2b14719f51c720fc1e1e54c">next</a>;
<a name="l00273"></a>00273 
<a name="l00274"></a>00274     <a class="code" href="../../dd/d24/st_8h.html#aee4e16ae99cd543ddf851107d5ea5408">st_add_direct</a>(bfs-&gt;<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3111865e63aadaec38b6c221ec79f1b4">visited</a>, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)dname, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)bfs-&gt;<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a78341adf1bb149c42fd6b2422b20641c">base_enc</a>);
<a name="l00275"></a>00275     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>;
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00279"></a><a class="code" href="../../d3/d26/transcode_8c.html#afc49640284e9c9fdda17cea6952a4026">00279</a> <a class="code" href="../../d3/d26/transcode_8c.html#afc49640284e9c9fdda17cea6952a4026">transcode_search_path</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sname, <span class="keyword">const</span> <span class="keywordtype">char</span> *dname,
<a name="l00280"></a>00280     <span class="keywordtype">void</span> (*<a class="code" href="../../d2/d34/closure_8c.html#aae67b2d791319e3a2e38ef8f3eebb1e9">callback</a>)(<span class="keyword">const</span> <span class="keywordtype">char</span> *sname, <span class="keyword">const</span> <span class="keywordtype">char</span> *dname, <span class="keywordtype">int</span> depth, <span class="keywordtype">void</span> *arg),
<a name="l00281"></a>00281     <span class="keywordtype">void</span> *arg)
<a name="l00282"></a>00282 {
<a name="l00283"></a>00283     <a class="code" href="../../df/dde/structsearch__path__bfs__t.html">search_path_bfs_t</a> bfs;
<a name="l00284"></a>00284     <a class="code" href="../../dd/d63/structsearch__path__queue__tag.html">search_path_queue_t</a> *q;
<a name="l00285"></a>00285     <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> val;
<a name="l00286"></a>00286     <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table2;
<a name="l00287"></a>00287     <span class="keywordtype">int</span> found;
<a name="l00288"></a>00288     <span class="keywordtype">int</span> pathlen = -1;
<a name="l00289"></a>00289 
<a name="l00290"></a>00290     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#adc12ab3195f23d65f243fe172370e950">encoding_equal</a>(sname, dname))
<a name="l00291"></a>00291         <span class="keywordflow">return</span> -1;
<a name="l00292"></a>00292 
<a name="l00293"></a>00293     q = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac8df5a8a8961bd9e16be385fef28c2f2">ALLOC</a>(<a class="code" href="../../dd/d63/structsearch__path__queue__tag.html">search_path_queue_t</a>);
<a name="l00294"></a>00294     q-&gt;<a class="code" href="../../dd/d63/structsearch__path__queue__tag.html#a202f4cee576807c070edde8f67877700">enc</a> = sname;
<a name="l00295"></a>00295     q-&gt;<a class="code" href="../../dd/d63/structsearch__path__queue__tag.html#aadf9b6c8c2b14719f51c720fc1e1e54c">next</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00296"></a>00296     bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a825474e006eb27a81b7aae5e7112e1b2">queue_last_ptr</a> = &amp;q-&gt;<a class="code" href="../../dd/d63/structsearch__path__queue__tag.html#aadf9b6c8c2b14719f51c720fc1e1e54c">next</a>;
<a name="l00297"></a>00297     bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3fc436af46bf07935d44c974005011f3">queue</a> = q;
<a name="l00298"></a>00298 
<a name="l00299"></a>00299     bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3111865e63aadaec38b6c221ec79f1b4">visited</a> = <a class="code" href="../../dd/d24/st_8h.html#a60f14cceadd837db51e110881258944a">st_init_strcasetable</a>();
<a name="l00300"></a>00300     <a class="code" href="../../dd/d24/st_8h.html#aee4e16ae99cd543ddf851107d5ea5408">st_add_direct</a>(bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3111865e63aadaec38b6c221ec79f1b4">visited</a>, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)sname, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l00301"></a>00301 
<a name="l00302"></a>00302     <span class="keywordflow">while</span> (bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3fc436af46bf07935d44c974005011f3">queue</a>) {
<a name="l00303"></a>00303         q = bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3fc436af46bf07935d44c974005011f3">queue</a>;
<a name="l00304"></a>00304         bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3fc436af46bf07935d44c974005011f3">queue</a> = q-&gt;<a class="code" href="../../dd/d63/structsearch__path__queue__tag.html#aadf9b6c8c2b14719f51c720fc1e1e54c">next</a>;
<a name="l00305"></a>00305         <span class="keywordflow">if</span> (!bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3fc436af46bf07935d44c974005011f3">queue</a>)
<a name="l00306"></a>00306             bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a825474e006eb27a81b7aae5e7112e1b2">queue_last_ptr</a> = &amp;bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3fc436af46bf07935d44c974005011f3">queue</a>;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308         <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(transcoder_table, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)q-&gt;<a class="code" href="../../dd/d63/structsearch__path__queue__tag.html#a202f4cee576807c070edde8f67877700">enc</a>, &amp;val)) {
<a name="l00309"></a>00309             <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(q);
<a name="l00310"></a>00310             <span class="keywordflow">continue</span>;
<a name="l00311"></a>00311         }
<a name="l00312"></a>00312         table2 = (<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *)val;
<a name="l00313"></a>00313 
<a name="l00314"></a>00314         <span class="keywordflow">if</span> (<a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(table2, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)dname, &amp;val)) {
<a name="l00315"></a>00315             <a class="code" href="../../dd/d24/st_8h.html#aee4e16ae99cd543ddf851107d5ea5408">st_add_direct</a>(bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3111865e63aadaec38b6c221ec79f1b4">visited</a>, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)dname, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)q-&gt;<a class="code" href="../../dd/d63/structsearch__path__queue__tag.html#a202f4cee576807c070edde8f67877700">enc</a>);
<a name="l00316"></a>00316             <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(q);
<a name="l00317"></a>00317             found = 1;
<a name="l00318"></a>00318             <span class="keywordflow">goto</span> cleanup;
<a name="l00319"></a>00319         }
<a name="l00320"></a>00320 
<a name="l00321"></a>00321         bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a78341adf1bb149c42fd6b2422b20641c">base_enc</a> = q-&gt;<a class="code" href="../../dd/d63/structsearch__path__queue__tag.html#a202f4cee576807c070edde8f67877700">enc</a>;
<a name="l00322"></a>00322         <a class="code" href="../../dd/d24/st_8h.html#ace5a79870d2800659a653fceeca55262">st_foreach</a>(table2, <a class="code" href="../../d3/d26/transcode_8c.html#a844d13cedcde71ccd96d3033d50d8c42">transcode_search_path_i</a>, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)&amp;bfs);
<a name="l00323"></a>00323         bfs.base_enc = NULL;
<a name="l00324"></a>00324 
<a name="l00325"></a>00325         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(q);
<a name="l00326"></a>00326     }
<a name="l00327"></a>00327     found = 0;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329   cleanup:
<a name="l00330"></a>00330     <span class="keywordflow">while</span> (bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3fc436af46bf07935d44c974005011f3">queue</a>) {
<a name="l00331"></a>00331         q = bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3fc436af46bf07935d44c974005011f3">queue</a>;
<a name="l00332"></a>00332         bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3fc436af46bf07935d44c974005011f3">queue</a> = q-&gt;<a class="code" href="../../dd/d63/structsearch__path__queue__tag.html#aadf9b6c8c2b14719f51c720fc1e1e54c">next</a>;
<a name="l00333"></a>00333         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(q);
<a name="l00334"></a>00334     }
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     <span class="keywordflow">if</span> (found) {
<a name="l00337"></a>00337         <span class="keyword">const</span> <span class="keywordtype">char</span> *enc = dname;
<a name="l00338"></a>00338         <span class="keywordtype">int</span> depth;
<a name="l00339"></a>00339         pathlen = 0;
<a name="l00340"></a>00340         <span class="keywordflow">while</span> (1) {
<a name="l00341"></a>00341             <a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3111865e63aadaec38b6c221ec79f1b4">visited</a>, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)enc, &amp;val);
<a name="l00342"></a>00342             <span class="keywordflow">if</span> (!val)
<a name="l00343"></a>00343                 <span class="keywordflow">break</span>;
<a name="l00344"></a>00344             pathlen++;
<a name="l00345"></a>00345             enc = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)val;
<a name="l00346"></a>00346         }
<a name="l00347"></a>00347         depth = pathlen;
<a name="l00348"></a>00348         enc = dname;
<a name="l00349"></a>00349         <span class="keywordflow">while</span> (1) {
<a name="l00350"></a>00350             <a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3111865e63aadaec38b6c221ec79f1b4">visited</a>, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)enc, &amp;val);
<a name="l00351"></a>00351             <span class="keywordflow">if</span> (!val)
<a name="l00352"></a>00352                 <span class="keywordflow">break</span>;
<a name="l00353"></a>00353             <a class="code" href="../../d2/d34/closure_8c.html#aae67b2d791319e3a2e38ef8f3eebb1e9">callback</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *)val, enc, --depth, arg);
<a name="l00354"></a>00354             enc = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)val;
<a name="l00355"></a>00355         }
<a name="l00356"></a>00356     }
<a name="l00357"></a>00357 
<a name="l00358"></a>00358     <a class="code" href="../../dd/d24/st_8h.html#acb004847ef312373d65bfb0d1a21c5b3">st_free_table</a>(bfs.<a class="code" href="../../df/dde/structsearch__path__bfs__t.html#a3111865e63aadaec38b6c221ec79f1b4">visited</a>);
<a name="l00359"></a>00359 
<a name="l00360"></a>00360     <span class="keywordflow">return</span> pathlen; <span class="comment">/* is -1 if not found */</span>
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *
<a name="l00364"></a><a class="code" href="../../d3/d26/transcode_8c.html#adb7762bdd8e4e7e429d3aea08468d936">00364</a> <a class="code" href="../../d3/d26/transcode_8c.html#adb7762bdd8e4e7e429d3aea08468d936">load_transcoder_entry</a>(<a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> *entry)
<a name="l00365"></a>00365 {
<a name="l00366"></a>00366     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a5bfe980db45acff299fe669432518b8b">transcoder</a>)
<a name="l00367"></a>00367         <span class="keywordflow">return</span> entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a5bfe980db45acff299fe669432518b8b">transcoder</a>;
<a name="l00368"></a>00368 
<a name="l00369"></a>00369     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#ab623030b340d3d991d48d9424c4b1b38">lib</a>) {
<a name="l00370"></a>00370         <span class="keyword">const</span> <span class="keywordtype">char</span> *lib = entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#ab623030b340d3d991d48d9424c4b1b38">lib</a>;
<a name="l00371"></a>00371         <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(lib);
<a name="l00372"></a>00372         <span class="keywordtype">char</span> path[<span class="keyword">sizeof</span>(transcoder_lib_prefix) + <a class="code" href="../../d3/d26/transcode_8c.html#a13ad25fb43f455d7c5f0f1a1f9d2e22c">MAX_TRANSCODER_LIBNAME_LEN</a>];
<a name="l00373"></a>00373         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> fn;
<a name="l00374"></a>00374         <span class="keyword">const</span> <span class="keywordtype">int</span> safe = <a class="code" href="../../d5/d9d/tcltklib_8c.html#a6f520624fabb8332dc98fd223491bf8d">rb_safe_level</a>();
<a name="l00375"></a>00375 
<a name="l00376"></a>00376         entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#ab623030b340d3d991d48d9424c4b1b38">lib</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00377"></a>00377 
<a name="l00378"></a>00378         <span class="keywordflow">if</span> (len &gt; <a class="code" href="../../d3/d26/transcode_8c.html#a13ad25fb43f455d7c5f0f1a1f9d2e22c">MAX_TRANSCODER_LIBNAME_LEN</a>)
<a name="l00379"></a>00379             <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00380"></a>00380         memcpy(path, transcoder_lib_prefix, <span class="keyword">sizeof</span>(transcoder_lib_prefix) - 1);
<a name="l00381"></a>00381         memcpy(path + <span class="keyword">sizeof</span>(transcoder_lib_prefix) - 1, lib, len + 1);
<a name="l00382"></a>00382         fn = <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(path);
<a name="l00383"></a>00383         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a6db7676c6cc4059a7cf021be34f53840">FL_UNSET</a>(fn, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aada6cee56453d224febc8a330e6bafdb">FL_TAINT</a>|<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a286c82e73243296cb52dafb7dae7ea70">FL_UNTRUSTED</a>);
<a name="l00384"></a>00384         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7ae8fa209abf837905d53c1c4be7c75d">OBJ_FREEZE</a>(fn);
<a name="l00385"></a>00385         <span class="keywordflow">if</span> (!<a class="code" href="../../db/d2e/intern_8h.html#acf17cb44b59868c4b4b5453117a20ea0">rb_require_safe</a>(fn, safe &gt; 3 ? 3 : safe))
<a name="l00386"></a>00386             <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00387"></a>00387     }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a5bfe980db45acff299fe669432518b8b">transcoder</a>)
<a name="l00390"></a>00390         <span class="keywordflow">return</span> entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a5bfe980db45acff299fe669432518b8b">transcoder</a>;
<a name="l00391"></a>00391 
<a name="l00392"></a>00392     <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00393"></a>00393 }
<a name="l00394"></a>00394 
<a name="l00395"></a>00395 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>*
<a name="l00396"></a><a class="code" href="../../d3/d26/transcode_8c.html#aebe9fe767e9e0f22d52acc50b080a444">00396</a> <a class="code" href="../../d3/d26/transcode_8c.html#aebe9fe767e9e0f22d52acc50b080a444">get_replacement_character</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *encname, <span class="keywordtype">size_t</span> *len_ret, <span class="keyword">const</span> <span class="keywordtype">char</span> **repl_encname_ptr)
<a name="l00397"></a>00397 {
<a name="l00398"></a>00398     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#adc12ab3195f23d65f243fe172370e950">encoding_equal</a>(encname, <span class="stringliteral">&quot;UTF-8&quot;</span>)) {
<a name="l00399"></a>00399         *len_ret = 3;
<a name="l00400"></a>00400         *repl_encname_ptr = <span class="stringliteral">&quot;UTF-8&quot;</span>;
<a name="l00401"></a>00401         <span class="keywordflow">return</span> <span class="stringliteral">&quot;\xEF\xBF\xBD&quot;</span>;
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403     <span class="keywordflow">else</span> {
<a name="l00404"></a>00404         *len_ret = 1;
<a name="l00405"></a>00405         *repl_encname_ptr = <span class="stringliteral">&quot;US-ASCII&quot;</span>;
<a name="l00406"></a>00406         <span class="keywordflow">return</span> <span class="stringliteral">&quot;?&quot;</span>;
<a name="l00407"></a>00407     }
<a name="l00408"></a>00408 }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410 <span class="comment">/*</span>
<a name="l00411"></a>00411 <span class="comment"> *  Transcoding engine logic</span>
<a name="l00412"></a>00412 <span class="comment"> */</span>
<a name="l00413"></a>00413 
<a name="l00414"></a>00414 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *
<a name="l00415"></a><a class="code" href="../../d3/d26/transcode_8c.html#a7d5026678b378b63217777a1a1c2a373">00415</a> <a class="code" href="../../d3/d26/transcode_8c.html#a7d5026678b378b63217777a1a1c2a373">transcode_char_start</a>(<a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *tc,
<a name="l00416"></a>00416                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in_start,
<a name="l00417"></a>00417                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *inchar_start,
<a name="l00418"></a>00418                          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in_p,
<a name="l00419"></a>00419                          <span class="keywordtype">size_t</span> *char_len_ptr)
<a name="l00420"></a>00420 {
<a name="l00421"></a>00421     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ptr;
<a name="l00422"></a>00422     <span class="keywordflow">if</span> (inchar_start - in_start &lt; tc-&gt;recognized_len) {
<a name="l00423"></a>00423         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a04ab67335215e8362c63ed27ae2d1c40">MEMCPY</a>(<a class="code" href="../../d3/d26/transcode_8c.html#ac3dbd4c95ffc9795e96366aa0aa0301a">TRANSCODING_READBUF</a>(tc) + tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a>,
<a name="l00424"></a>00424                inchar_start, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, in_p - inchar_start);
<a name="l00425"></a>00425         ptr = <a class="code" href="../../d3/d26/transcode_8c.html#ac3dbd4c95ffc9795e96366aa0aa0301a">TRANSCODING_READBUF</a>(tc);
<a name="l00426"></a>00426     }
<a name="l00427"></a>00427     <span class="keywordflow">else</span> {
<a name="l00428"></a>00428         ptr = inchar_start - tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a>;
<a name="l00429"></a>00429     }
<a name="l00430"></a>00430     *char_len_ptr = tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a> + (in_p - inchar_start);
<a name="l00431"></a>00431     <span class="keywordflow">return</span> ptr;
<a name="l00432"></a>00432 }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434 <span class="keyword">static</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a>
<a name="l00435"></a><a class="code" href="../../d3/d26/transcode_8c.html#a72cd8ad6a77fe7d741e528e825524524">00435</a> <a class="code" href="../../d3/d26/transcode_8c.html#a72cd8ad6a77fe7d741e528e825524524">transcode_restartable0</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **in_pos, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **out_pos,
<a name="l00436"></a>00436                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in_stop, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out_stop,
<a name="l00437"></a>00437                       <a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *tc,
<a name="l00438"></a>00438                       <span class="keyword">const</span> <span class="keywordtype">int</span> opt)
<a name="l00439"></a>00439 {
<a name="l00440"></a>00440     <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a> = tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>;
<a name="l00441"></a>00441     <span class="keywordtype">int</span> unitlen = tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a624a373c9f3c111180b654fa9a926f53">input_unit_length</a>;
<a name="l00442"></a>00442     ssize_t readagain_len = 0;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *inchar_start;
<a name="l00445"></a>00445     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in_p;
<a name="l00446"></a>00446 
<a name="l00447"></a>00447     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out_p;
<a name="l00448"></a>00448 
<a name="l00449"></a>00449     in_p = inchar_start = *in_pos;
<a name="l00450"></a>00450 
<a name="l00451"></a>00451     out_p = *out_pos;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453 <span class="preprocessor">#define SUSPEND(ret, num) \</span>
<a name="l00454"></a>00454 <span class="preprocessor">    do { \</span>
<a name="l00455"></a>00455 <span class="preprocessor">        tc-&gt;resume_position = (num); \</span>
<a name="l00456"></a>00456 <span class="preprocessor">        if (0 &lt; in_p - inchar_start) \</span>
<a name="l00457"></a>00457 <span class="preprocessor">            MEMMOVE(TRANSCODING_READBUF(tc)+tc-&gt;recognized_len, \</span>
<a name="l00458"></a>00458 <span class="preprocessor">                   inchar_start, unsigned char, in_p - inchar_start); \</span>
<a name="l00459"></a>00459 <span class="preprocessor">        *in_pos = in_p; \</span>
<a name="l00460"></a>00460 <span class="preprocessor">        *out_pos = out_p; \</span>
<a name="l00461"></a>00461 <span class="preprocessor">        tc-&gt;recognized_len += in_p - inchar_start; \</span>
<a name="l00462"></a>00462 <span class="preprocessor">        if (readagain_len) { \</span>
<a name="l00463"></a>00463 <span class="preprocessor">            tc-&gt;recognized_len -= readagain_len; \</span>
<a name="l00464"></a>00464 <span class="preprocessor">            tc-&gt;readagain_len = readagain_len; \</span>
<a name="l00465"></a>00465 <span class="preprocessor">        } \</span>
<a name="l00466"></a>00466 <span class="preprocessor">        return (ret); \</span>
<a name="l00467"></a>00467 <span class="preprocessor">        resume_label ## num:; \</span>
<a name="l00468"></a>00468 <span class="preprocessor">    } while (0)</span>
<a name="l00469"></a>00469 <span class="preprocessor"></span><span class="preprocessor">#define SUSPEND_OBUF(num) \</span>
<a name="l00470"></a>00470 <span class="preprocessor">    do { \</span>
<a name="l00471"></a>00471 <span class="preprocessor">        while (out_stop - out_p &lt; 1) { SUSPEND(econv_destination_buffer_full, num); } \</span>
<a name="l00472"></a>00472 <span class="preprocessor">    } while (0)</span>
<a name="l00473"></a>00473 <span class="preprocessor"></span>
<a name="l00474"></a>00474 <span class="preprocessor">#define SUSPEND_AFTER_OUTPUT(num) \</span>
<a name="l00475"></a>00475 <span class="preprocessor">    if ((opt &amp; ECONV_AFTER_OUTPUT) &amp;&amp; *out_pos != out_p) { \</span>
<a name="l00476"></a>00476 <span class="preprocessor">        SUSPEND(econv_after_output, num); \</span>
<a name="l00477"></a>00477 <span class="preprocessor">    }</span>
<a name="l00478"></a>00478 <span class="preprocessor"></span>
<a name="l00479"></a>00479 <span class="preprocessor">#define next_table (tc-&gt;next_table)</span>
<a name="l00480"></a>00480 <span class="preprocessor"></span><span class="preprocessor">#define next_info (tc-&gt;next_info)</span>
<a name="l00481"></a>00481 <span class="preprocessor"></span><span class="preprocessor">#define next_byte (tc-&gt;next_byte)</span>
<a name="l00482"></a>00482 <span class="preprocessor"></span><span class="preprocessor">#define writebuf_len (tc-&gt;writebuf_len)</span>
<a name="l00483"></a>00483 <span class="preprocessor"></span><span class="preprocessor">#define writebuf_off (tc-&gt;writebuf_off)</span>
<a name="l00484"></a>00484 <span class="preprocessor"></span>
<a name="l00485"></a>00485     <span class="keywordflow">switch</span> (tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a59b9de3ef003aa4d036bdc73382e6d14">resume_position</a>) {
<a name="l00486"></a>00486       <span class="keywordflow">case</span> 0: <span class="keywordflow">break</span>;
<a name="l00487"></a>00487       <span class="keywordflow">case</span> 1: <span class="keywordflow">goto</span> resume_label1;
<a name="l00488"></a>00488       <span class="keywordflow">case</span> 2: <span class="keywordflow">goto</span> resume_label2;
<a name="l00489"></a>00489       <span class="keywordflow">case</span> 3: <span class="keywordflow">goto</span> resume_label3;
<a name="l00490"></a>00490       <span class="keywordflow">case</span> 4: <span class="keywordflow">goto</span> resume_label4;
<a name="l00491"></a>00491       <span class="keywordflow">case</span> 5: <span class="keywordflow">goto</span> resume_label5;
<a name="l00492"></a>00492       <span class="keywordflow">case</span> 6: <span class="keywordflow">goto</span> resume_label6;
<a name="l00493"></a>00493       <span class="keywordflow">case</span> 7: <span class="keywordflow">goto</span> resume_label7;
<a name="l00494"></a>00494       <span class="keywordflow">case</span> 8: <span class="keywordflow">goto</span> resume_label8;
<a name="l00495"></a>00495       <span class="keywordflow">case</span> 9: <span class="keywordflow">goto</span> resume_label9;
<a name="l00496"></a>00496       <span class="keywordflow">case</span> 10: <span class="keywordflow">goto</span> resume_label10;
<a name="l00497"></a>00497       <span class="keywordflow">case</span> 11: <span class="keywordflow">goto</span> resume_label11;
<a name="l00498"></a>00498       <span class="keywordflow">case</span> 12: <span class="keywordflow">goto</span> resume_label12;
<a name="l00499"></a>00499       <span class="keywordflow">case</span> 13: <span class="keywordflow">goto</span> resume_label13;
<a name="l00500"></a>00500       <span class="keywordflow">case</span> 14: <span class="keywordflow">goto</span> resume_label14;
<a name="l00501"></a>00501       <span class="keywordflow">case</span> 15: <span class="keywordflow">goto</span> resume_label15;
<a name="l00502"></a>00502       <span class="keywordflow">case</span> 16: <span class="keywordflow">goto</span> resume_label16;
<a name="l00503"></a>00503       <span class="keywordflow">case</span> 17: <span class="keywordflow">goto</span> resume_label17;
<a name="l00504"></a>00504       <span class="keywordflow">case</span> 18: <span class="keywordflow">goto</span> resume_label18;
<a name="l00505"></a>00505       <span class="keywordflow">case</span> 19: <span class="keywordflow">goto</span> resume_label19;
<a name="l00506"></a>00506       <span class="keywordflow">case</span> 20: <span class="keywordflow">goto</span> resume_label20;
<a name="l00507"></a>00507       <span class="keywordflow">case</span> 21: <span class="keywordflow">goto</span> resume_label21;
<a name="l00508"></a>00508       <span class="keywordflow">case</span> 22: <span class="keywordflow">goto</span> resume_label22;
<a name="l00509"></a>00509       <span class="keywordflow">case</span> 23: <span class="keywordflow">goto</span> resume_label23;
<a name="l00510"></a>00510       <span class="keywordflow">case</span> 24: <span class="keywordflow">goto</span> resume_label24;
<a name="l00511"></a>00511       <span class="keywordflow">case</span> 25: <span class="keywordflow">goto</span> resume_label25;
<a name="l00512"></a>00512       <span class="keywordflow">case</span> 26: <span class="keywordflow">goto</span> resume_label26;
<a name="l00513"></a>00513       <span class="keywordflow">case</span> 27: <span class="keywordflow">goto</span> resume_label27;
<a name="l00514"></a>00514       <span class="keywordflow">case</span> 28: <span class="keywordflow">goto</span> resume_label28;
<a name="l00515"></a>00515       <span class="keywordflow">case</span> 29: <span class="keywordflow">goto</span> resume_label29;
<a name="l00516"></a>00516       <span class="keywordflow">case</span> 30: <span class="keywordflow">goto</span> resume_label30;
<a name="l00517"></a>00517       <span class="keywordflow">case</span> 31: <span class="keywordflow">goto</span> resume_label31;
<a name="l00518"></a>00518       <span class="keywordflow">case</span> 32: <span class="keywordflow">goto</span> resume_label32;
<a name="l00519"></a>00519       <span class="keywordflow">case</span> 33: <span class="keywordflow">goto</span> resume_label33;
<a name="l00520"></a>00520       <span class="keywordflow">case</span> 34: <span class="keywordflow">goto</span> resume_label34;
<a name="l00521"></a>00521     }
<a name="l00522"></a>00522 
<a name="l00523"></a>00523     <span class="keywordflow">while</span> (1) {
<a name="l00524"></a>00524         inchar_start = in_p;
<a name="l00525"></a>00525         tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a> = 0;
<a name="l00526"></a>00526         <a class="code" href="../../d3/d26/transcode_8c.html#a53268c26758c35f844da5815fe840d78">next_table</a> = tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#ae3c8cd177deff8424e14f4887f287a55">conv_tree_start</a>;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528         <a class="code" href="../../d3/d26/transcode_8c.html#a4e0080a0bb2ddce94e79bde783b89356">SUSPEND_AFTER_OUTPUT</a>(24);
<a name="l00529"></a>00529 
<a name="l00530"></a>00530         <span class="keywordflow">if</span> (in_stop &lt;= in_p) {
<a name="l00531"></a>00531             <span class="keywordflow">if</span> (!(opt &amp; <a class="code" href="../../d5/de3/encoding_8h.html#ab1eeed22e1b00841e21fa4715df0029e">ECONV_PARTIAL_INPUT</a>))
<a name="l00532"></a>00532                 <span class="keywordflow">break</span>;
<a name="l00533"></a>00533             <a class="code" href="../../d3/d26/transcode_8c.html#a8e5757dc6c1bee80d2f4990d23aa973d">SUSPEND</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>, 7);
<a name="l00534"></a>00534             <span class="keywordflow">continue</span>;
<a name="l00535"></a>00535         }
<a name="l00536"></a>00536 
<a name="l00537"></a>00537 <span class="preprocessor">#define BYTE_ADDR(index) (tr-&gt;byte_array + (index))</span>
<a name="l00538"></a>00538 <span class="preprocessor"></span><span class="preprocessor">#define WORD_ADDR(index) (tr-&gt;word_array + INFO2WORDINDEX(index))</span>
<a name="l00539"></a>00539 <span class="preprocessor"></span><span class="preprocessor">#define BL_BASE BYTE_ADDR(BYTE_LOOKUP_BASE(WORD_ADDR(next_table)))</span>
<a name="l00540"></a>00540 <span class="preprocessor"></span><span class="preprocessor">#define BL_INFO WORD_ADDR(BYTE_LOOKUP_INFO(WORD_ADDR(next_table)))</span>
<a name="l00541"></a>00541 <span class="preprocessor"></span><span class="preprocessor">#define BL_MIN_BYTE     (BL_BASE[0])</span>
<a name="l00542"></a>00542 <span class="preprocessor"></span><span class="preprocessor">#define BL_MAX_BYTE     (BL_BASE[1])</span>
<a name="l00543"></a>00543 <span class="preprocessor"></span><span class="preprocessor">#define BL_OFFSET(byte) (BL_BASE[2+(byte)-BL_MIN_BYTE])</span>
<a name="l00544"></a>00544 <span class="preprocessor"></span><span class="preprocessor">#define BL_ACTION(byte) (BL_INFO[BL_OFFSET((byte))])</span>
<a name="l00545"></a>00545 <span class="preprocessor"></span>
<a name="l00546"></a>00546         <a class="code" href="../../d3/d26/transcode_8c.html#aef6f22e6a88b45d08ee8872a2eddaf88">next_byte</a> = (<span class="keywordtype">unsigned</span> char)*in_p++;
<a name="l00547"></a>00547       follow_byte:
<a name="l00548"></a>00548         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#aef6f22e6a88b45d08ee8872a2eddaf88">next_byte</a> &lt; <a class="code" href="../../d5/d63/utf8__mac_8c.html#a18aa3ce00c0e00faa5e45e492a518fee">BL_MIN_BYTE</a> || <a class="code" href="../../d5/d63/utf8__mac_8c.html#af85774cbf3b2f7fad125f44b09a79b3a">BL_MAX_BYTE</a> &lt; <a class="code" href="../../d3/d26/transcode_8c.html#aef6f22e6a88b45d08ee8872a2eddaf88">next_byte</a>)
<a name="l00549"></a>00549             <a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a> = <a class="code" href="../../d1/daa/transcode__data_8h.html#adf770fe2eec438e3758ffe905dbae208">INVALID</a>;
<a name="l00550"></a>00550         <span class="keywordflow">else</span> {
<a name="l00551"></a>00551             <a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a> = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)<a class="code" href="../../d5/d63/utf8__mac_8c.html#a014d69ad9bef10ce0c9758ea9be8f459">BL_ACTION</a>(<a class="code" href="../../d3/d26/transcode_8c.html#aef6f22e6a88b45d08ee8872a2eddaf88">next_byte</a>);
<a name="l00552"></a>00552         }
<a name="l00553"></a>00553       follow_info:
<a name="l00554"></a>00554         <span class="keywordflow">switch</span> (<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a> &amp; 0x1F) {
<a name="l00555"></a>00555           <span class="keywordflow">case</span> <a class="code" href="../../d1/daa/transcode__data_8h.html#ac9306121bd3c0255492802d9f4c3347d">NOMAP</a>:
<a name="l00556"></a>00556             {
<a name="l00557"></a>00557                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p = inchar_start;
<a name="l00558"></a>00558                 <a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a> = 0;
<a name="l00559"></a>00559                 <span class="keywordflow">while</span> (p &lt; in_p) {
<a name="l00560"></a>00560                     <a class="code" href="../../d3/d26/transcode_8c.html#a00f64a48e2cbd506b8c949985577ba54">TRANSCODING_WRITEBUF</a>(tc)[<a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a>++] = (<span class="keywordtype">unsigned</span> char)*p++;
<a name="l00561"></a>00561                 }
<a name="l00562"></a>00562                 <a class="code" href="../../d3/d26/transcode_8c.html#a01a2293e9796b648363189ee1a0c091c">writebuf_len</a> = <a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a>;
<a name="l00563"></a>00563                 <a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a> = 0;
<a name="l00564"></a>00564                 <span class="keywordflow">while</span> (<a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a> &lt; <a class="code" href="../../d3/d26/transcode_8c.html#a01a2293e9796b648363189ee1a0c091c">writebuf_len</a>) {
<a name="l00565"></a>00565                     <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(3);
<a name="l00566"></a>00566                     *out_p++ = <a class="code" href="../../d3/d26/transcode_8c.html#a00f64a48e2cbd506b8c949985577ba54">TRANSCODING_WRITEBUF</a>(tc)[<a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a>++];
<a name="l00567"></a>00567                 }
<a name="l00568"></a>00568             }
<a name="l00569"></a>00569             <span class="keywordflow">continue</span>;
<a name="l00570"></a>00570           <span class="keywordflow">case</span> 0x00: <span class="keywordflow">case</span> 0x04: <span class="keywordflow">case</span> 0x08: <span class="keywordflow">case</span> 0x0C:
<a name="l00571"></a>00571           <span class="keywordflow">case</span> 0x10: <span class="keywordflow">case</span> 0x14: <span class="keywordflow">case</span> 0x18: <span class="keywordflow">case</span> 0x1C:
<a name="l00572"></a>00572             <a class="code" href="../../d3/d26/transcode_8c.html#a4e0080a0bb2ddce94e79bde783b89356">SUSPEND_AFTER_OUTPUT</a>(25);
<a name="l00573"></a>00573             <span class="keywordflow">while</span> (in_p &gt;= in_stop) {
<a name="l00574"></a>00574                 <span class="keywordflow">if</span> (!(opt &amp; <a class="code" href="../../d5/de3/encoding_8h.html#ab1eeed22e1b00841e21fa4715df0029e">ECONV_PARTIAL_INPUT</a>))
<a name="l00575"></a>00575                     <span class="keywordflow">goto</span> incomplete;
<a name="l00576"></a>00576                 <a class="code" href="../../d3/d26/transcode_8c.html#a8e5757dc6c1bee80d2f4990d23aa973d">SUSPEND</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>, 5);
<a name="l00577"></a>00577             }
<a name="l00578"></a>00578             <a class="code" href="../../d3/d26/transcode_8c.html#aef6f22e6a88b45d08ee8872a2eddaf88">next_byte</a> = (<span class="keywordtype">unsigned</span> char)*in_p++;
<a name="l00579"></a>00579             <a class="code" href="../../d3/d26/transcode_8c.html#a53268c26758c35f844da5815fe840d78">next_table</a> = (<span class="keywordtype">unsigned</span> int)<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>;
<a name="l00580"></a>00580             <span class="keywordflow">goto</span> follow_byte;
<a name="l00581"></a>00581           <span class="keywordflow">case</span> <a class="code" href="../../d1/daa/transcode__data_8h.html#a6122456f802bd1c9ddf1dd02e7cb08c1">ZERObt</a>: <span class="comment">/* drop input */</span>
<a name="l00582"></a>00582             <span class="keywordflow">continue</span>;
<a name="l00583"></a>00583           <span class="keywordflow">case</span> <a class="code" href="../../d1/daa/transcode__data_8h.html#aa65f26ef0f867b6f69fffb1583fdfec0">ONEbt</a>:
<a name="l00584"></a>00584             <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(9); *out_p++ = <a class="code" href="../../d1/daa/transcode__data_8h.html#a6353069062116e77a04b0355faf2bf23">getBT1</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>);
<a name="l00585"></a>00585             <span class="keywordflow">continue</span>;
<a name="l00586"></a>00586           <span class="keywordflow">case</span> <a class="code" href="../../d1/daa/transcode__data_8h.html#a8f7a9570989c43f52c4eae9288e060de">TWObt</a>:
<a name="l00587"></a>00587             <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(10); *out_p++ = <a class="code" href="../../d1/daa/transcode__data_8h.html#a6353069062116e77a04b0355faf2bf23">getBT1</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>);
<a name="l00588"></a>00588             <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(21); *out_p++ = <a class="code" href="../../d1/daa/transcode__data_8h.html#a5c6555da273eb810f89e3c7b680b8971">getBT2</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>);
<a name="l00589"></a>00589             <span class="keywordflow">continue</span>;
<a name="l00590"></a>00590           <span class="keywordflow">case</span> <a class="code" href="../../d1/daa/transcode__data_8h.html#ac04661db01854270bce09c26bc219bf2">THREEbt</a>:
<a name="l00591"></a>00591             <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(11); *out_p++ = <a class="code" href="../../d1/daa/transcode__data_8h.html#a6353069062116e77a04b0355faf2bf23">getBT1</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>);
<a name="l00592"></a>00592             <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(15); *out_p++ = <a class="code" href="../../d1/daa/transcode__data_8h.html#a5c6555da273eb810f89e3c7b680b8971">getBT2</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>);
<a name="l00593"></a>00593             <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(16); *out_p++ = <a class="code" href="../../d1/daa/transcode__data_8h.html#a4a83168ba4d1eafae81fe9f13dfba708">getBT3</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>);
<a name="l00594"></a>00594             <span class="keywordflow">continue</span>;
<a name="l00595"></a>00595           <span class="keywordflow">case</span> <a class="code" href="../../d1/daa/transcode__data_8h.html#a259b31a1f0ec05e7bd54fcd2e572b3e9">FOURbt</a>:
<a name="l00596"></a>00596             <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(12); *out_p++ = <a class="code" href="../../d1/daa/transcode__data_8h.html#a8115e78e8d22fdb181dfa3e30ee07eb0">getBT0</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>);
<a name="l00597"></a>00597             <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(17); *out_p++ = <a class="code" href="../../d1/daa/transcode__data_8h.html#a6353069062116e77a04b0355faf2bf23">getBT1</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>);
<a name="l00598"></a>00598             <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(18); *out_p++ = <a class="code" href="../../d1/daa/transcode__data_8h.html#a5c6555da273eb810f89e3c7b680b8971">getBT2</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>);
<a name="l00599"></a>00599             <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(19); *out_p++ = <a class="code" href="../../d1/daa/transcode__data_8h.html#a4a83168ba4d1eafae81fe9f13dfba708">getBT3</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>);
<a name="l00600"></a>00600             <span class="keywordflow">continue</span>;
<a name="l00601"></a>00601           <span class="keywordflow">case</span> <a class="code" href="../../d1/daa/transcode__data_8h.html#af7768162b1f9f7aeecd74ebd10c2af94">GB4bt</a>:
<a name="l00602"></a>00602             <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(29); *out_p++ = <a class="code" href="../../d1/daa/transcode__data_8h.html#acba95d59c35756822dd3cc3f0ca0d914">getGB4bt0</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>);
<a name="l00603"></a>00603             <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(30); *out_p++ = <a class="code" href="../../d1/daa/transcode__data_8h.html#a861d8d8d20055cbbfaab41f3cf5a57da">getGB4bt1</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>);
<a name="l00604"></a>00604             <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(31); *out_p++ = <a class="code" href="../../d1/daa/transcode__data_8h.html#a69f2aab1f76694b085ccedadd00f976e">getGB4bt2</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>);
<a name="l00605"></a>00605             <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(32); *out_p++ = <a class="code" href="../../d1/daa/transcode__data_8h.html#af6e7a34ec6de2a8dc09334d6e2c850b4">getGB4bt3</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>);
<a name="l00606"></a>00606             <span class="keywordflow">continue</span>;
<a name="l00607"></a>00607           <span class="keywordflow">case</span> <a class="code" href="../../d1/daa/transcode__data_8h.html#a4071a01b93b50fd24795ebaff49d2918">STR1</a>:
<a name="l00608"></a>00608             tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a1bcd79e5de50ab64e6ddf07ffb8b8ee8">output_index</a> = 0;
<a name="l00609"></a>00609             <span class="keywordflow">while</span> (tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a1bcd79e5de50ab64e6ddf07ffb8b8ee8">output_index</a> &lt; <a class="code" href="../../d1/daa/transcode__data_8h.html#a9f288be82fee978ba9eb5493f76d33a6">STR1_LENGTH</a>(<a class="code" href="../../d5/d63/utf8__mac_8c.html#a55bf08f4afa658281ba4fc1e47842a5f">BYTE_ADDR</a>(<a class="code" href="../../d1/daa/transcode__data_8h.html#af4f5e0178d83091544d371f141f1f648">STR1_BYTEINDEX</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>)))) {
<a name="l00610"></a>00610                 <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(28); *out_p++ = <a class="code" href="../../d5/d63/utf8__mac_8c.html#a55bf08f4afa658281ba4fc1e47842a5f">BYTE_ADDR</a>(<a class="code" href="../../d1/daa/transcode__data_8h.html#af4f5e0178d83091544d371f141f1f648">STR1_BYTEINDEX</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>))[1+tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a1bcd79e5de50ab64e6ddf07ffb8b8ee8">output_index</a>];
<a name="l00611"></a>00611                 tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a1bcd79e5de50ab64e6ddf07ffb8b8ee8">output_index</a>++;
<a name="l00612"></a>00612             }
<a name="l00613"></a>00613             <span class="keywordflow">continue</span>;
<a name="l00614"></a>00614           <span class="keywordflow">case</span> <a class="code" href="../../d1/daa/transcode__data_8h.html#ae9f94907fe5a667e2a45332aacb2bba7">FUNii</a>:
<a name="l00615"></a>00615             <a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a> = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)(*tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a0cac680e286538a423d8b6a7ca6358d4">func_ii</a>)(<a class="code" href="../../d3/d26/transcode_8c.html#a2fc6206e66155edb648615350dfd7f26">TRANSCODING_STATE</a>(tc), <a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>);
<a name="l00616"></a>00616             <span class="keywordflow">goto</span> follow_info;
<a name="l00617"></a>00617           <span class="keywordflow">case</span> <a class="code" href="../../d1/daa/transcode__data_8h.html#a92d1df2c2d0111a3d367ce33a0f51e55">FUNsi</a>:
<a name="l00618"></a>00618             {
<a name="l00619"></a>00619                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *char_start;
<a name="l00620"></a>00620                 <span class="keywordtype">size_t</span> char_len;
<a name="l00621"></a>00621                 char_start = <a class="code" href="../../d3/d26/transcode_8c.html#a7d5026678b378b63217777a1a1c2a373">transcode_char_start</a>(tc, *in_pos, inchar_start, in_p, &amp;char_len);
<a name="l00622"></a>00622                 <a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a> = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)(*tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#ad00cfd7800bbb6d3c46ea0ab5afeb513">func_si</a>)(<a class="code" href="../../d3/d26/transcode_8c.html#a2fc6206e66155edb648615350dfd7f26">TRANSCODING_STATE</a>(tc), char_start, (size_t)char_len);
<a name="l00623"></a>00623                 <span class="keywordflow">goto</span> follow_info;
<a name="l00624"></a>00624             }
<a name="l00625"></a>00625           <span class="keywordflow">case</span> <a class="code" href="../../d1/daa/transcode__data_8h.html#a2113b2ceeff14f517c363f82dc714193">FUNio</a>:
<a name="l00626"></a>00626             <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(13);
<a name="l00627"></a>00627             <span class="keywordflow">if</span> (tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a85dad54f3fff0861b37d422e69ebb8ab">max_output</a> &lt;= out_stop - out_p)
<a name="l00628"></a>00628                 out_p += tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a424be329f86677cf7c1e8040281ebd54">func_io</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a2fc6206e66155edb648615350dfd7f26">TRANSCODING_STATE</a>(tc),
<a name="l00629"></a>00629                     <a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>, out_p, out_stop - out_p);
<a name="l00630"></a>00630             <span class="keywordflow">else</span> {
<a name="l00631"></a>00631                 <a class="code" href="../../d3/d26/transcode_8c.html#a01a2293e9796b648363189ee1a0c091c">writebuf_len</a> = tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a424be329f86677cf7c1e8040281ebd54">func_io</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a2fc6206e66155edb648615350dfd7f26">TRANSCODING_STATE</a>(tc),
<a name="l00632"></a>00632                     <a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>,
<a name="l00633"></a>00633                     <a class="code" href="../../d3/d26/transcode_8c.html#a00f64a48e2cbd506b8c949985577ba54">TRANSCODING_WRITEBUF</a>(tc), <a class="code" href="../../d3/d26/transcode_8c.html#a65291fffd0cc25a799eaa04206628689">TRANSCODING_WRITEBUF_SIZE</a>(tc));
<a name="l00634"></a>00634                 <a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a> = 0;
<a name="l00635"></a>00635                 <span class="keywordflow">while</span> (<a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a> &lt; <a class="code" href="../../d3/d26/transcode_8c.html#a01a2293e9796b648363189ee1a0c091c">writebuf_len</a>) {
<a name="l00636"></a>00636                     <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(20);
<a name="l00637"></a>00637                     *out_p++ = <a class="code" href="../../d3/d26/transcode_8c.html#a00f64a48e2cbd506b8c949985577ba54">TRANSCODING_WRITEBUF</a>(tc)[<a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a>++];
<a name="l00638"></a>00638                 }
<a name="l00639"></a>00639             }
<a name="l00640"></a>00640             <span class="keywordflow">break</span>;
<a name="l00641"></a>00641           <span class="keywordflow">case</span> <a class="code" href="../../d1/daa/transcode__data_8h.html#a34132fe458fa1bb691350ff710ef8ddf">FUNso</a>:
<a name="l00642"></a>00642             {
<a name="l00643"></a>00643                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *char_start;
<a name="l00644"></a>00644                 <span class="keywordtype">size_t</span> char_len;
<a name="l00645"></a>00645                 <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(14);
<a name="l00646"></a>00646                 <span class="keywordflow">if</span> (tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a85dad54f3fff0861b37d422e69ebb8ab">max_output</a> &lt;= out_stop - out_p) {
<a name="l00647"></a>00647                     char_start = <a class="code" href="../../d3/d26/transcode_8c.html#a7d5026678b378b63217777a1a1c2a373">transcode_char_start</a>(tc, *in_pos, inchar_start, in_p, &amp;char_len);
<a name="l00648"></a>00648                     out_p += tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a9774ae2d7b1ba3b43fc934a68d1d4535">func_so</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a2fc6206e66155edb648615350dfd7f26">TRANSCODING_STATE</a>(tc),
<a name="l00649"></a>00649                         char_start, (<span class="keywordtype">size_t</span>)char_len,
<a name="l00650"></a>00650                         out_p, out_stop - out_p);
<a name="l00651"></a>00651                 }
<a name="l00652"></a>00652                 <span class="keywordflow">else</span> {
<a name="l00653"></a>00653                     char_start = <a class="code" href="../../d3/d26/transcode_8c.html#a7d5026678b378b63217777a1a1c2a373">transcode_char_start</a>(tc, *in_pos, inchar_start, in_p, &amp;char_len);
<a name="l00654"></a>00654                     <a class="code" href="../../d3/d26/transcode_8c.html#a01a2293e9796b648363189ee1a0c091c">writebuf_len</a> = tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a9774ae2d7b1ba3b43fc934a68d1d4535">func_so</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a2fc6206e66155edb648615350dfd7f26">TRANSCODING_STATE</a>(tc),
<a name="l00655"></a>00655                         char_start, (<span class="keywordtype">size_t</span>)char_len,
<a name="l00656"></a>00656                         <a class="code" href="../../d3/d26/transcode_8c.html#a00f64a48e2cbd506b8c949985577ba54">TRANSCODING_WRITEBUF</a>(tc), <a class="code" href="../../d3/d26/transcode_8c.html#a65291fffd0cc25a799eaa04206628689">TRANSCODING_WRITEBUF_SIZE</a>(tc));
<a name="l00657"></a>00657                     <a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a> = 0;
<a name="l00658"></a>00658                     <span class="keywordflow">while</span> (<a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a> &lt; <a class="code" href="../../d3/d26/transcode_8c.html#a01a2293e9796b648363189ee1a0c091c">writebuf_len</a>) {
<a name="l00659"></a>00659                         <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(22);
<a name="l00660"></a>00660                         *out_p++ = <a class="code" href="../../d3/d26/transcode_8c.html#a00f64a48e2cbd506b8c949985577ba54">TRANSCODING_WRITEBUF</a>(tc)[<a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a>++];
<a name="l00661"></a>00661                     }
<a name="l00662"></a>00662                 }
<a name="l00663"></a>00663                 <span class="keywordflow">break</span>;
<a name="l00664"></a>00664             }
<a name="l00665"></a>00665       <span class="keywordflow">case</span> <a class="code" href="../../d1/daa/transcode__data_8h.html#a3db7e583c791007be43f8e25aca2f8df">FUNsio</a>:
<a name="l00666"></a>00666             {
<a name="l00667"></a>00667                 <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *char_start;
<a name="l00668"></a>00668                 <span class="keywordtype">size_t</span> char_len;
<a name="l00669"></a>00669                 <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(33);
<a name="l00670"></a>00670                 <span class="keywordflow">if</span> (tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a85dad54f3fff0861b37d422e69ebb8ab">max_output</a> &lt;= out_stop - out_p) {
<a name="l00671"></a>00671                     char_start = <a class="code" href="../../d3/d26/transcode_8c.html#a7d5026678b378b63217777a1a1c2a373">transcode_char_start</a>(tc, *in_pos, inchar_start, in_p, &amp;char_len);
<a name="l00672"></a>00672                     out_p += tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#abd4bf5417cf3d4097c2deff1561b085b">func_sio</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a2fc6206e66155edb648615350dfd7f26">TRANSCODING_STATE</a>(tc),
<a name="l00673"></a>00673                         char_start, (<span class="keywordtype">size_t</span>)char_len, <a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>,
<a name="l00674"></a>00674                         out_p, out_stop - out_p);
<a name="l00675"></a>00675                 }
<a name="l00676"></a>00676                 <span class="keywordflow">else</span> {
<a name="l00677"></a>00677                     char_start = <a class="code" href="../../d3/d26/transcode_8c.html#a7d5026678b378b63217777a1a1c2a373">transcode_char_start</a>(tc, *in_pos, inchar_start, in_p, &amp;char_len);
<a name="l00678"></a>00678                     <a class="code" href="../../d3/d26/transcode_8c.html#a01a2293e9796b648363189ee1a0c091c">writebuf_len</a> = tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#abd4bf5417cf3d4097c2deff1561b085b">func_sio</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a2fc6206e66155edb648615350dfd7f26">TRANSCODING_STATE</a>(tc),
<a name="l00679"></a>00679                         char_start, (<span class="keywordtype">size_t</span>)char_len, <a class="code" href="../../d3/d26/transcode_8c.html#a20510f2c320976ac18ae40a4ee5f432e">next_info</a>,
<a name="l00680"></a>00680                         <a class="code" href="../../d3/d26/transcode_8c.html#a00f64a48e2cbd506b8c949985577ba54">TRANSCODING_WRITEBUF</a>(tc), <a class="code" href="../../d3/d26/transcode_8c.html#a65291fffd0cc25a799eaa04206628689">TRANSCODING_WRITEBUF_SIZE</a>(tc));
<a name="l00681"></a>00681                     <a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a> = 0;
<a name="l00682"></a>00682                     <span class="keywordflow">while</span> (<a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a> &lt; <a class="code" href="../../d3/d26/transcode_8c.html#a01a2293e9796b648363189ee1a0c091c">writebuf_len</a>) {
<a name="l00683"></a>00683                         <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(34);
<a name="l00684"></a>00684                         *out_p++ = <a class="code" href="../../d3/d26/transcode_8c.html#a00f64a48e2cbd506b8c949985577ba54">TRANSCODING_WRITEBUF</a>(tc)[<a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a>++];
<a name="l00685"></a>00685                     }
<a name="l00686"></a>00686                 }
<a name="l00687"></a>00687                 <span class="keywordflow">break</span>;
<a name="l00688"></a>00688             }
<a name="l00689"></a>00689           <span class="keywordflow">case</span> <a class="code" href="../../d1/daa/transcode__data_8h.html#adf770fe2eec438e3758ffe905dbae208">INVALID</a>:
<a name="l00690"></a>00690             <span class="keywordflow">if</span> (tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a> + (in_p - inchar_start) &lt;= unitlen) {
<a name="l00691"></a>00691                 <span class="keywordflow">if</span> (tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a> + (in_p - inchar_start) &lt; unitlen)
<a name="l00692"></a>00692                     <a class="code" href="../../d3/d26/transcode_8c.html#a4e0080a0bb2ddce94e79bde783b89356">SUSPEND_AFTER_OUTPUT</a>(26);
<a name="l00693"></a>00693                 <span class="keywordflow">while</span> ((opt &amp; <a class="code" href="../../d5/de3/encoding_8h.html#ab1eeed22e1b00841e21fa4715df0029e">ECONV_PARTIAL_INPUT</a>) &amp;&amp; tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a> + (in_stop - inchar_start) &lt; unitlen) {
<a name="l00694"></a>00694                     in_p = in_stop;
<a name="l00695"></a>00695                     <a class="code" href="../../d3/d26/transcode_8c.html#a8e5757dc6c1bee80d2f4990d23aa973d">SUSPEND</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>, 8);
<a name="l00696"></a>00696                 }
<a name="l00697"></a>00697                 <span class="keywordflow">if</span> (tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a> + (in_stop - inchar_start) &lt;= unitlen) {
<a name="l00698"></a>00698                     in_p = in_stop;
<a name="l00699"></a>00699                 }
<a name="l00700"></a>00700                 <span class="keywordflow">else</span> {
<a name="l00701"></a>00701                     in_p = inchar_start + (unitlen - tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a>);
<a name="l00702"></a>00702                 }
<a name="l00703"></a>00703             }
<a name="l00704"></a>00704             <span class="keywordflow">else</span> {
<a name="l00705"></a>00705                 ssize_t invalid_len; <span class="comment">/* including the last byte which causes invalid */</span>
<a name="l00706"></a>00706                 ssize_t discard_len;
<a name="l00707"></a>00707                 invalid_len = tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a> + (in_p - inchar_start);
<a name="l00708"></a>00708                 discard_len = ((invalid_len - 1) / unitlen) * unitlen;
<a name="l00709"></a>00709                 readagain_len = invalid_len - discard_len;
<a name="l00710"></a>00710             }
<a name="l00711"></a>00711             <span class="keywordflow">goto</span> invalid;
<a name="l00712"></a>00712           <span class="keywordflow">case</span> <a class="code" href="../../d1/daa/transcode__data_8h.html#abde25a67f4046530ae1c572cefeb5869">UNDEF</a>:
<a name="l00713"></a>00713             <span class="keywordflow">goto</span> undef;
<a name="l00714"></a>00714           <span class="keywordflow">default</span>:
<a name="l00715"></a>00715             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a95ad3953d535707e2cf2b1d837f5e253">rb_eRuntimeError</a>, <span class="stringliteral">&quot;unknown transcoding instruction&quot;</span>);
<a name="l00716"></a>00716         }
<a name="l00717"></a>00717         <span class="keywordflow">continue</span>;
<a name="l00718"></a>00718 
<a name="l00719"></a>00719       invalid:
<a name="l00720"></a>00720         <a class="code" href="../../d3/d26/transcode_8c.html#a8e5757dc6c1bee80d2f4990d23aa973d">SUSPEND</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad43244977ecc5d0f0cda6d003b1e37d1">econv_invalid_byte_sequence</a>, 1);
<a name="l00721"></a>00721         <span class="keywordflow">continue</span>;
<a name="l00722"></a>00722 
<a name="l00723"></a>00723       incomplete:
<a name="l00724"></a>00724         <a class="code" href="../../d3/d26/transcode_8c.html#a8e5757dc6c1bee80d2f4990d23aa973d">SUSPEND</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa42fe600023b5129588324a787ade662d">econv_incomplete_input</a>, 27);
<a name="l00725"></a>00725         <span class="keywordflow">continue</span>;
<a name="l00726"></a>00726 
<a name="l00727"></a>00727       undef:
<a name="l00728"></a>00728         <a class="code" href="../../d3/d26/transcode_8c.html#a8e5757dc6c1bee80d2f4990d23aa973d">SUSPEND</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7e59e5dc4cb8b9db559a803ee88aec57">econv_undefined_conversion</a>, 2);
<a name="l00729"></a>00729         <span class="keywordflow">continue</span>;
<a name="l00730"></a>00730     }
<a name="l00731"></a>00731 
<a name="l00732"></a>00732     <span class="comment">/* cleanup */</span>
<a name="l00733"></a>00733     <span class="keywordflow">if</span> (tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a10220d3b9b4cfc6527dc7da90b706814">finish_func</a>) {
<a name="l00734"></a>00734         <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(4);
<a name="l00735"></a>00735         <span class="keywordflow">if</span> (tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a85dad54f3fff0861b37d422e69ebb8ab">max_output</a> &lt;= out_stop - out_p) {
<a name="l00736"></a>00736             out_p += tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a10220d3b9b4cfc6527dc7da90b706814">finish_func</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a2fc6206e66155edb648615350dfd7f26">TRANSCODING_STATE</a>(tc),
<a name="l00737"></a>00737                 out_p, out_stop - out_p);
<a name="l00738"></a>00738         }
<a name="l00739"></a>00739         <span class="keywordflow">else</span> {
<a name="l00740"></a>00740             <a class="code" href="../../d3/d26/transcode_8c.html#a01a2293e9796b648363189ee1a0c091c">writebuf_len</a> = tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a10220d3b9b4cfc6527dc7da90b706814">finish_func</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a2fc6206e66155edb648615350dfd7f26">TRANSCODING_STATE</a>(tc),
<a name="l00741"></a>00741                 <a class="code" href="../../d3/d26/transcode_8c.html#a00f64a48e2cbd506b8c949985577ba54">TRANSCODING_WRITEBUF</a>(tc), <a class="code" href="../../d3/d26/transcode_8c.html#a65291fffd0cc25a799eaa04206628689">TRANSCODING_WRITEBUF_SIZE</a>(tc));
<a name="l00742"></a>00742             <a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a> = 0;
<a name="l00743"></a>00743             <span class="keywordflow">while</span> (<a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a> &lt; <a class="code" href="../../d3/d26/transcode_8c.html#a01a2293e9796b648363189ee1a0c091c">writebuf_len</a>) {
<a name="l00744"></a>00744                 <a class="code" href="../../d3/d26/transcode_8c.html#a4e4468d76c2332033a88d97727f904a5">SUSPEND_OBUF</a>(23);
<a name="l00745"></a>00745                 *out_p++ = <a class="code" href="../../d3/d26/transcode_8c.html#a00f64a48e2cbd506b8c949985577ba54">TRANSCODING_WRITEBUF</a>(tc)[<a class="code" href="../../d3/d26/transcode_8c.html#af2e23d44edf7a7ea7394c5373491f947">writebuf_off</a>++];
<a name="l00746"></a>00746             }
<a name="l00747"></a>00747         }
<a name="l00748"></a>00748     }
<a name="l00749"></a>00749     <span class="keywordflow">while</span> (1)
<a name="l00750"></a>00750         <a class="code" href="../../d3/d26/transcode_8c.html#a8e5757dc6c1bee80d2f4990d23aa973d">SUSPEND</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa50dc17a7e8399ca9dcd98a7b6e652764">econv_finished</a>, 6);
<a name="l00751"></a>00751 <span class="preprocessor">#undef SUSPEND</span>
<a name="l00752"></a>00752 <span class="preprocessor"></span><span class="preprocessor">#undef next_table</span>
<a name="l00753"></a>00753 <span class="preprocessor"></span><span class="preprocessor">#undef next_info</span>
<a name="l00754"></a>00754 <span class="preprocessor"></span><span class="preprocessor">#undef next_byte</span>
<a name="l00755"></a>00755 <span class="preprocessor"></span><span class="preprocessor">#undef writebuf_len</span>
<a name="l00756"></a>00756 <span class="preprocessor"></span><span class="preprocessor">#undef writebuf_off</span>
<a name="l00757"></a>00757 <span class="preprocessor"></span>}
<a name="l00758"></a>00758 
<a name="l00759"></a>00759 <span class="keyword">static</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a>
<a name="l00760"></a><a class="code" href="../../d3/d26/transcode_8c.html#adbb49df74100c20913c8aaeac7bf23ee">00760</a> <a class="code" href="../../d3/d26/transcode_8c.html#adbb49df74100c20913c8aaeac7bf23ee">transcode_restartable</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **in_pos, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **out_pos,
<a name="l00761"></a>00761                       <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in_stop, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out_stop,
<a name="l00762"></a>00762                       <a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *tc,
<a name="l00763"></a>00763                       <span class="keyword">const</span> <span class="keywordtype">int</span> opt)
<a name="l00764"></a>00764 {
<a name="l00765"></a>00765     <span class="keywordflow">if</span> (tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a>) {
<a name="l00766"></a>00766         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *readagain_buf = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1408f4b967485afd869990b67e766ceb">ALLOCA_N</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a>);
<a name="l00767"></a>00767         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *readagain_pos = readagain_buf;
<a name="l00768"></a>00768         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *readagain_stop = readagain_buf + tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a>;
<a name="l00769"></a>00769         <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a> res;
<a name="l00770"></a>00770 
<a name="l00771"></a>00771         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a04ab67335215e8362c63ed27ae2d1c40">MEMCPY</a>(readagain_buf, <a class="code" href="../../d3/d26/transcode_8c.html#ac3dbd4c95ffc9795e96366aa0aa0301a">TRANSCODING_READBUF</a>(tc) + tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a>,
<a name="l00772"></a>00772                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a>);
<a name="l00773"></a>00773         tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a> = 0;
<a name="l00774"></a>00774         res = <a class="code" href="../../d3/d26/transcode_8c.html#a72cd8ad6a77fe7d741e528e825524524">transcode_restartable0</a>(&amp;readagain_pos, out_pos, readagain_stop, out_stop, tc, opt|<a class="code" href="../../d5/de3/encoding_8h.html#ab1eeed22e1b00841e21fa4715df0029e">ECONV_PARTIAL_INPUT</a>);
<a name="l00775"></a>00775         <span class="keywordflow">if</span> (res != <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>) {
<a name="l00776"></a>00776             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a04ab67335215e8362c63ed27ae2d1c40">MEMCPY</a>(<a class="code" href="../../d3/d26/transcode_8c.html#ac3dbd4c95ffc9795e96366aa0aa0301a">TRANSCODING_READBUF</a>(tc) + tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a> + tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a>,
<a name="l00777"></a>00777                    readagain_pos, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, readagain_stop - readagain_pos);
<a name="l00778"></a>00778             tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a> += readagain_stop - readagain_pos;
<a name="l00779"></a>00779             <span class="keywordflow">return</span> res;
<a name="l00780"></a>00780         }
<a name="l00781"></a>00781     }
<a name="l00782"></a>00782     <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a72cd8ad6a77fe7d741e528e825524524">transcode_restartable0</a>(in_pos, out_pos, in_stop, out_stop, tc, opt);
<a name="l00783"></a>00783 }
<a name="l00784"></a>00784 
<a name="l00785"></a>00785 <span class="keyword">static</span> <a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *
<a name="l00786"></a><a class="code" href="../../d3/d26/transcode_8c.html#a9fe6fbc542df7d925921672e63490941">00786</a> <a class="code" href="../../d3/d26/transcode_8c.html#a9fe6fbc542df7d925921672e63490941">rb_transcoding_open_by_transcoder</a>(<span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a>, <span class="keywordtype">int</span> flags)
<a name="l00787"></a>00787 {
<a name="l00788"></a>00788     <a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *tc;
<a name="l00789"></a>00789 
<a name="l00790"></a>00790     tc = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac8df5a8a8961bd9e16be385fef28c2f2">ALLOC</a>(<a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a>);
<a name="l00791"></a>00791     tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a> = tr;
<a name="l00792"></a>00792     tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a550eb155bcb2efe7f5583691467d12a3">flags</a> = flags;
<a name="l00793"></a>00793     <span class="keywordflow">if</span> (TRANSCODING_STATE_EMBED_MAX &lt; tr-&gt;state_size)
<a name="l00794"></a>00794         tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a78a9399f8fa8439dccfc41858f5e8047">state</a>.<a class="code" href="../../d5/db5/unionrb__transcoding_1_1rb__transcoding__state__t.html#ad9caf1273f0e388d06679cdf16acbbb2">ptr</a> = <a class="code" href="../../d8/db0/defines_8h.html#a6af5faec3f9662b20ffc9903f923dec0">xmalloc</a>(tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#ae1d173ae9a91d981430bc1ad1e07748f">state_size</a>);
<a name="l00795"></a>00795     <span class="keywordflow">if</span> (tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#abefe1853eb65a1e76356ee6fe8872353">state_init_func</a>) {
<a name="l00796"></a>00796         (tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#abefe1853eb65a1e76356ee6fe8872353">state_init_func</a>)(<a class="code" href="../../d3/d26/transcode_8c.html#a2fc6206e66155edb648615350dfd7f26">TRANSCODING_STATE</a>(tc)); <span class="comment">/* xxx: check return value */</span>
<a name="l00797"></a>00797     }
<a name="l00798"></a>00798     tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a59b9de3ef003aa4d036bdc73382e6d14">resume_position</a> = 0;
<a name="l00799"></a>00799     tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a> = 0;
<a name="l00800"></a>00800     tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a> = 0;
<a name="l00801"></a>00801     tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a829bec6102fbf1f8670412aa8354c799">writebuf_len</a> = 0;
<a name="l00802"></a>00802     tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#afb83f2ba03f3b9050623abd8d7cd80e4">writebuf_off</a> = 0;
<a name="l00803"></a>00803     <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adee4c9606257219f0aa293751e086066">readbuf</a>.<a class="code" href="../../de/d43/structrb__transcoding.html#a827892114bcb2e6ffa9c712cf903b50e">ary</a>) &lt; tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#af9c239e13bf5ee7d03dfe916c2dc902c">max_input</a>) {
<a name="l00804"></a>00804         tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adee4c9606257219f0aa293751e086066">readbuf</a>.<a class="code" href="../../de/d43/structrb__transcoding.html#abb4a3730587e9a87391ab6328cc08c3c">ptr</a> = <a class="code" href="../../d8/db0/defines_8h.html#a6af5faec3f9662b20ffc9903f923dec0">xmalloc</a>(tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#af9c239e13bf5ee7d03dfe916c2dc902c">max_input</a>);
<a name="l00805"></a>00805     }
<a name="l00806"></a>00806     <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a92fdfeb12592a34773f23e30ce1adc19">writebuf</a>.<a class="code" href="../../de/d43/structrb__transcoding.html#a827892114bcb2e6ffa9c712cf903b50e">ary</a>) &lt; tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a85dad54f3fff0861b37d422e69ebb8ab">max_output</a>) {
<a name="l00807"></a>00807         tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a92fdfeb12592a34773f23e30ce1adc19">writebuf</a>.<a class="code" href="../../de/d43/structrb__transcoding.html#abb4a3730587e9a87391ab6328cc08c3c">ptr</a> = <a class="code" href="../../d8/db0/defines_8h.html#a6af5faec3f9662b20ffc9903f923dec0">xmalloc</a>(tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a85dad54f3fff0861b37d422e69ebb8ab">max_output</a>);
<a name="l00808"></a>00808     }
<a name="l00809"></a>00809     <span class="keywordflow">return</span> tc;
<a name="l00810"></a>00810 }
<a name="l00811"></a>00811 
<a name="l00812"></a>00812 <span class="keyword">static</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a>
<a name="l00813"></a><a class="code" href="../../d3/d26/transcode_8c.html#a59e3e6d05fb5ed6f8927e1f64de83c8c">00813</a> <a class="code" href="../../d3/d26/transcode_8c.html#a59e3e6d05fb5ed6f8927e1f64de83c8c">rb_transcoding_convert</a>(<a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *tc,
<a name="l00814"></a>00814   <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **input_ptr, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *input_stop,
<a name="l00815"></a>00815   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **output_ptr, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *output_stop,
<a name="l00816"></a>00816   <span class="keywordtype">int</span> flags)
<a name="l00817"></a>00817 {
<a name="l00818"></a>00818     <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#adbb49df74100c20913c8aaeac7bf23ee">transcode_restartable</a>(
<a name="l00819"></a>00819                 input_ptr, output_ptr,
<a name="l00820"></a>00820                 input_stop, output_stop,
<a name="l00821"></a>00821                 tc, flags);
<a name="l00822"></a>00822 }
<a name="l00823"></a>00823 
<a name="l00824"></a>00824 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00825"></a><a class="code" href="../../d3/d26/transcode_8c.html#accae10f454b739a2de1515e9fd70f25e">00825</a> <a class="code" href="../../d3/d26/transcode_8c.html#accae10f454b739a2de1515e9fd70f25e">rb_transcoding_close</a>(<a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *tc)
<a name="l00826"></a>00826 {
<a name="l00827"></a>00827     <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a> = tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>;
<a name="l00828"></a>00828     <span class="keywordflow">if</span> (tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a4fbb8957cbb8559774d5eadd726b66a9">state_fini_func</a>) {
<a name="l00829"></a>00829         (tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a4fbb8957cbb8559774d5eadd726b66a9">state_fini_func</a>)(<a class="code" href="../../d3/d26/transcode_8c.html#a2fc6206e66155edb648615350dfd7f26">TRANSCODING_STATE</a>(tc)); <span class="comment">/* check return value? */</span>
<a name="l00830"></a>00830     }
<a name="l00831"></a>00831     <span class="keywordflow">if</span> (TRANSCODING_STATE_EMBED_MAX &lt; tr-&gt;state_size)
<a name="l00832"></a>00832         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a78a9399f8fa8439dccfc41858f5e8047">state</a>.<a class="code" href="../../d5/db5/unionrb__transcoding_1_1rb__transcoding__state__t.html#ad9caf1273f0e388d06679cdf16acbbb2">ptr</a>);
<a name="l00833"></a>00833     <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adee4c9606257219f0aa293751e086066">readbuf</a>.<a class="code" href="../../de/d43/structrb__transcoding.html#a827892114bcb2e6ffa9c712cf903b50e">ary</a>) &lt; tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#af9c239e13bf5ee7d03dfe916c2dc902c">max_input</a>)
<a name="l00834"></a>00834         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adee4c9606257219f0aa293751e086066">readbuf</a>.<a class="code" href="../../de/d43/structrb__transcoding.html#abb4a3730587e9a87391ab6328cc08c3c">ptr</a>);
<a name="l00835"></a>00835     <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a92fdfeb12592a34773f23e30ce1adc19">writebuf</a>.<a class="code" href="../../de/d43/structrb__transcoding.html#a827892114bcb2e6ffa9c712cf903b50e">ary</a>) &lt; tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a85dad54f3fff0861b37d422e69ebb8ab">max_output</a>)
<a name="l00836"></a>00836         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a92fdfeb12592a34773f23e30ce1adc19">writebuf</a>.<a class="code" href="../../de/d43/structrb__transcoding.html#abb4a3730587e9a87391ab6328cc08c3c">ptr</a>);
<a name="l00837"></a>00837     <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(tc);
<a name="l00838"></a>00838 }
<a name="l00839"></a>00839 
<a name="l00840"></a>00840 <span class="keyword">static</span> <span class="keywordtype">size_t</span>
<a name="l00841"></a><a class="code" href="../../d3/d26/transcode_8c.html#a125dfbb2bee556ee97181ff53f107200">00841</a> <a class="code" href="../../d3/d26/transcode_8c.html#a125dfbb2bee556ee97181ff53f107200">rb_transcoding_memsize</a>(<a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *tc)
<a name="l00842"></a>00842 {
<a name="l00843"></a>00843     <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a>);
<a name="l00844"></a>00844     <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a> = tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>;
<a name="l00845"></a>00845 
<a name="l00846"></a>00846     <span class="keywordflow">if</span> (TRANSCODING_STATE_EMBED_MAX &lt; tr-&gt;state_size) {
<a name="l00847"></a>00847         size += tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#ae1d173ae9a91d981430bc1ad1e07748f">state_size</a>;
<a name="l00848"></a>00848     }
<a name="l00849"></a>00849     <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adee4c9606257219f0aa293751e086066">readbuf</a>.<a class="code" href="../../de/d43/structrb__transcoding.html#a827892114bcb2e6ffa9c712cf903b50e">ary</a>) &lt; tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#af9c239e13bf5ee7d03dfe916c2dc902c">max_input</a>) {
<a name="l00850"></a>00850         size += tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#af9c239e13bf5ee7d03dfe916c2dc902c">max_input</a>;
<a name="l00851"></a>00851     }
<a name="l00852"></a>00852     <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a92fdfeb12592a34773f23e30ce1adc19">writebuf</a>.<a class="code" href="../../de/d43/structrb__transcoding.html#a827892114bcb2e6ffa9c712cf903b50e">ary</a>) &lt; tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a85dad54f3fff0861b37d422e69ebb8ab">max_output</a>) {
<a name="l00853"></a>00853         size += tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a85dad54f3fff0861b37d422e69ebb8ab">max_output</a>;
<a name="l00854"></a>00854     }
<a name="l00855"></a>00855     <span class="keywordflow">return</span> size;
<a name="l00856"></a>00856 }
<a name="l00857"></a>00857 
<a name="l00858"></a>00858 <span class="keyword">static</span> <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *
<a name="l00859"></a><a class="code" href="../../d3/d26/transcode_8c.html#a0f64078d94078a76b5e3756471b95fa7">00859</a> <a class="code" href="../../d3/d26/transcode_8c.html#a0f64078d94078a76b5e3756471b95fa7">rb_econv_alloc</a>(<span class="keywordtype">int</span> n_hint)
<a name="l00860"></a>00860 {
<a name="l00861"></a>00861     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec;
<a name="l00862"></a>00862 
<a name="l00863"></a>00863     <span class="keywordflow">if</span> (n_hint &lt;= 0)
<a name="l00864"></a>00864         n_hint = 1;
<a name="l00865"></a>00865 
<a name="l00866"></a>00866     ec = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac8df5a8a8961bd9e16be385fef28c2f2">ALLOC</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a>);
<a name="l00867"></a>00867     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afe610e62515fe51de0398ca90a6a891b">flags</a> = 0;
<a name="l00868"></a>00868     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a22bbe71170a0fbfce6b1ac29c7677f4c">source_encoding_name</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00869"></a>00869     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afd32fa6d348fa4997c2ec5dde2001c79">destination_encoding_name</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00870"></a>00870     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7e2bbe100caa442ca786b221a06a3e7b">started</a> = 0;
<a name="l00871"></a>00871     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9ef89b6cd3baa02b8ec83f49a2d3a2b">replacement_str</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00872"></a>00872     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a40e67fdbe80e48a19ecfeaa9358fd4c2">replacement_len</a> = 0;
<a name="l00873"></a>00873     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a875d42c5055651a75e9172e89a53c7c8">replacement_enc</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00874"></a>00874     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab257a4ed6f3ca457a32ee1304af2c038">replacement_allocated</a> = 0;
<a name="l00875"></a>00875     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a0604b16d6b3c882135b53011c762d1a2">in_buf_start</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00876"></a>00876     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a79204dbf92e8b20a7e7fd3513667a6fb">in_data_start</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00877"></a>00877     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ade30d9cec3597c3d2d44df9e312760d9">in_data_end</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00878"></a>00878     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a40505b1017d6d6c00a616509e42d50f0">in_buf_end</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00879"></a>00879     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#aec32851f840def8d195bcaa7de1ea4ad">num_allocated</a> = n_hint;
<a name="l00880"></a>00880     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a> = 0;
<a name="l00881"></a>00881     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a79041aa2bc7439c11906a86f82a52eb6">ALLOC_N</a>(<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html">rb_econv_elem_t</a>, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#aec32851f840def8d195bcaa7de1ea4ad">num_allocated</a>);
<a name="l00882"></a>00882     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#affe06137c41d5acc36b506e3222be524">num_finished</a> = 0;
<a name="l00883"></a>00883     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#acb260f341ee3fbd97d43a8b5f2c067bd">last_tc</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00884"></a>00884     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9db5877b884b6345adb4bd2a0b65b70">result</a> = <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>;
<a name="l00885"></a>00885     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a5b07cda3f87918e9a3c3b957dbca3522">error_tc</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00886"></a>00886     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00887"></a>00887     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00888"></a>00888     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#afa032001f9163782b3ffd3f7719c01b2">error_bytes_start</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00889"></a>00889     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a18f4b226842af7c0c379bf21646409af">error_bytes_len</a> = 0;
<a name="l00890"></a>00890     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a2eb533677cfc48e764a7940f034b1634">readagain_len</a> = 0;
<a name="l00891"></a>00891     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00892"></a>00892     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00893"></a>00893     <span class="keywordflow">return</span> ec;
<a name="l00894"></a>00894 }
<a name="l00895"></a>00895 
<a name="l00896"></a>00896 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00897"></a><a class="code" href="../../d3/d26/transcode_8c.html#a587a6cc35b2fdd295151cdde5c4d56fb">00897</a> <a class="code" href="../../d3/d26/transcode_8c.html#a587a6cc35b2fdd295151cdde5c4d56fb">rb_econv_add_transcoder_at</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec, <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a>, <span class="keywordtype">int</span> i)
<a name="l00898"></a>00898 {
<a name="l00899"></a>00899     <span class="keywordtype">int</span> n, j;
<a name="l00900"></a>00900     <span class="keywordtype">int</span> bufsize = 4096;
<a name="l00901"></a>00901     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p;
<a name="l00902"></a>00902 
<a name="l00903"></a>00903     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a> == ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#aec32851f840def8d195bcaa7de1ea4ad">num_allocated</a>) {
<a name="l00904"></a>00904         n = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#aec32851f840def8d195bcaa7de1ea4ad">num_allocated</a> * 2;
<a name="l00905"></a>00905         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5160cad2d7d090e4d2e8803f1ba5ee3c">REALLOC_N</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>, <a class="code" href="../../d5/d6c/structrb__econv__elem__t.html">rb_econv_elem_t</a>, n);
<a name="l00906"></a>00906         ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#aec32851f840def8d195bcaa7de1ea4ad">num_allocated</a> = n;
<a name="l00907"></a>00907     }
<a name="l00908"></a>00908 
<a name="l00909"></a>00909     p = <a class="code" href="../../d8/db0/defines_8h.html#a6af5faec3f9662b20ffc9903f923dec0">xmalloc</a>(bufsize);
<a name="l00910"></a>00910 
<a name="l00911"></a>00911     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aad09de334c9b8c7f717d314b14679e62">MEMMOVE</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>+i+1, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>+i, <a class="code" href="../../d5/d6c/structrb__econv__elem__t.html">rb_econv_elem_t</a>, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-i);
<a name="l00912"></a>00912 
<a name="l00913"></a>00913     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a> = <a class="code" href="../../d3/d26/transcode_8c.html#a9fe6fbc542df7d925921672e63490941">rb_transcoding_open_by_transcoder</a>(tr, 0);
<a name="l00914"></a>00914     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a854388ef0bc7a190f14bc1ff6c99494a">out_buf_start</a> = p;
<a name="l00915"></a>00915     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#aeb112d51d22fbc31883328b8855a7ee4">out_buf_end</a> = p + bufsize;
<a name="l00916"></a>00916     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a4022fc650a937371403f1b17ebd1d24d">out_data_start</a> = p;
<a name="l00917"></a>00917     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#af6319607c08232cd7c528a5e0f18c408">out_data_end</a> = p;
<a name="l00918"></a>00918     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#ab0e4131eb67e1748b32a847875731c95">last_result</a> = <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>;
<a name="l00919"></a>00919 
<a name="l00920"></a>00920     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>++;
<a name="l00921"></a>00921 
<a name="l00922"></a>00922     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d26/transcode_8c.html#a7a9d71f951b9b292988b798f4f6bc29b">DECORATOR_P</a>(tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a6f79077ecbd8da45cc181b53dc280a90">src_encoding</a>, tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a06f17fbc59c9055646b1a147d05f33eb">dst_encoding</a>))
<a name="l00923"></a>00923         <span class="keywordflow">for</span> (j = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1; i &lt;= j; j--) {
<a name="l00924"></a>00924             <a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *tc = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[j].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>;
<a name="l00925"></a>00925             <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *tr2 = tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>;
<a name="l00926"></a>00926             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d26/transcode_8c.html#a7a9d71f951b9b292988b798f4f6bc29b">DECORATOR_P</a>(tr2-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a6f79077ecbd8da45cc181b53dc280a90">src_encoding</a>, tr2-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a06f17fbc59c9055646b1a147d05f33eb">dst_encoding</a>)) {
<a name="l00927"></a>00927                 ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#acb260f341ee3fbd97d43a8b5f2c067bd">last_tc</a> = tc;
<a name="l00928"></a>00928                 <span class="keywordflow">break</span>;
<a name="l00929"></a>00929             }
<a name="l00930"></a>00930         }
<a name="l00931"></a>00931 
<a name="l00932"></a>00932     <span class="keywordflow">return</span> 0;
<a name="l00933"></a>00933 }
<a name="l00934"></a>00934 
<a name="l00935"></a>00935 <span class="keyword">static</span> <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *
<a name="l00936"></a><a class="code" href="../../d3/d26/transcode_8c.html#af5f6f9d88dd8a47c54cd624d93698078">00936</a> <a class="code" href="../../d3/d26/transcode_8c.html#af5f6f9d88dd8a47c54cd624d93698078">rb_econv_open_by_transcoder_entries</a>(<span class="keywordtype">int</span> n, <a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> **entries)
<a name="l00937"></a>00937 {
<a name="l00938"></a>00938     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec;
<a name="l00939"></a>00939     <span class="keywordtype">int</span> i, ret;
<a name="l00940"></a>00940 
<a name="l00941"></a>00941     <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {
<a name="l00942"></a>00942         <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a>;
<a name="l00943"></a>00943         tr = <a class="code" href="../../d3/d26/transcode_8c.html#adb7762bdd8e4e7e429d3aea08468d936">load_transcoder_entry</a>(entries[i]);
<a name="l00944"></a>00944         <span class="keywordflow">if</span> (!tr)
<a name="l00945"></a>00945             <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00946"></a>00946     }
<a name="l00947"></a>00947 
<a name="l00948"></a>00948     ec = <a class="code" href="../../d3/d26/transcode_8c.html#a0f64078d94078a76b5e3756471b95fa7">rb_econv_alloc</a>(n);
<a name="l00949"></a>00949 
<a name="l00950"></a>00950     <span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {
<a name="l00951"></a>00951         <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a> = <a class="code" href="../../d3/d26/transcode_8c.html#adb7762bdd8e4e7e429d3aea08468d936">load_transcoder_entry</a>(entries[i]);
<a name="l00952"></a>00952         ret = <a class="code" href="../../d3/d26/transcode_8c.html#a587a6cc35b2fdd295151cdde5c4d56fb">rb_econv_add_transcoder_at</a>(ec, tr, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>);
<a name="l00953"></a>00953         <span class="keywordflow">if</span> (ret == -1) {
<a name="l00954"></a>00954             <a class="code" href="../../d5/de3/encoding_8h.html#adaf53306799f8796d7e6437bc98d0b0e">rb_econv_close</a>(ec);
<a name="l00955"></a>00955             <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00956"></a>00956         }
<a name="l00957"></a>00957     }
<a name="l00958"></a>00958 
<a name="l00959"></a>00959     <span class="keywordflow">return</span> ec;
<a name="l00960"></a>00960 }
<a name="l00961"></a>00961 
<a name="l00962"></a><a class="code" href="../../d8/d00/structtrans__open__t.html">00962</a> <span class="keyword">struct </span><a class="code" href="../../d8/d00/structtrans__open__t.html">trans_open_t</a> {
<a name="l00963"></a><a class="code" href="../../d8/d00/structtrans__open__t.html#a2408af148ed792b7f35a60d87f8ea079">00963</a>     <a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> **<a class="code" href="../../d8/d00/structtrans__open__t.html#a2408af148ed792b7f35a60d87f8ea079">entries</a>;
<a name="l00964"></a><a class="code" href="../../d8/d00/structtrans__open__t.html#a3e89ac80ddc7a1996f1d2047629cd702">00964</a>     <span class="keywordtype">int</span> <a class="code" href="../../d8/d00/structtrans__open__t.html#a3e89ac80ddc7a1996f1d2047629cd702">num_additional</a>;
<a name="l00965"></a>00965 };
<a name="l00966"></a>00966 
<a name="l00967"></a>00967 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00968"></a><a class="code" href="../../d3/d26/transcode_8c.html#a09c230919cbcf4967062c7e268d218f8">00968</a> <a class="code" href="../../d3/d26/transcode_8c.html#a09c230919cbcf4967062c7e268d218f8">trans_open_i</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sname, <span class="keyword">const</span> <span class="keywordtype">char</span> *dname, <span class="keywordtype">int</span> depth, <span class="keywordtype">void</span> *arg)
<a name="l00969"></a>00969 {
<a name="l00970"></a>00970     <span class="keyword">struct </span><a class="code" href="../../d8/d00/structtrans__open__t.html">trans_open_t</a> *toarg = arg;
<a name="l00971"></a>00971 
<a name="l00972"></a>00972     <span class="keywordflow">if</span> (!toarg-&gt;<a class="code" href="../../d8/d00/structtrans__open__t.html#a2408af148ed792b7f35a60d87f8ea079">entries</a>) {
<a name="l00973"></a>00973         toarg-&gt;<a class="code" href="../../d8/d00/structtrans__open__t.html#a2408af148ed792b7f35a60d87f8ea079">entries</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a79041aa2bc7439c11906a86f82a52eb6">ALLOC_N</a>(<a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> *, depth+1+toarg-&gt;<a class="code" href="../../d8/d00/structtrans__open__t.html#a3e89ac80ddc7a1996f1d2047629cd702">num_additional</a>);
<a name="l00974"></a>00974     }
<a name="l00975"></a>00975     toarg-&gt;<a class="code" href="../../d8/d00/structtrans__open__t.html#a2408af148ed792b7f35a60d87f8ea079">entries</a>[depth] = <a class="code" href="../../d3/d26/transcode_8c.html#a0d3a31f80907a117b9c8b3170e3f8bbd">get_transcoder_entry</a>(sname, dname);
<a name="l00976"></a>00976 }
<a name="l00977"></a>00977 
<a name="l00978"></a>00978 <span class="keyword">static</span> <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *
<a name="l00979"></a><a class="code" href="../../d3/d26/transcode_8c.html#a15f584f7b49e59c0910acdac6b7c2e81">00979</a> <a class="code" href="../../d3/d26/transcode_8c.html#a15f584f7b49e59c0910acdac6b7c2e81">rb_econv_open0</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sname, <span class="keyword">const</span> <span class="keywordtype">char</span> *dname, <span class="keywordtype">int</span> ecflags)
<a name="l00980"></a>00980 {
<a name="l00981"></a>00981     <a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> **<a class="code" href="../../d8/d00/structtrans__open__t.html#a2408af148ed792b7f35a60d87f8ea079">entries</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00982"></a>00982     <span class="keywordtype">int</span> num_trans;
<a name="l00983"></a>00983     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec;
<a name="l00984"></a>00984 
<a name="l00985"></a>00985     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *senc, *denc;
<a name="l00986"></a>00986     <span class="keywordtype">int</span> sidx, didx;
<a name="l00987"></a>00987 
<a name="l00988"></a>00988     senc = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00989"></a>00989     <span class="keywordflow">if</span> (*sname) {
<a name="l00990"></a>00990         sidx = <a class="code" href="../../d5/db5/encoding_8c.html#adeb5f5b97ea43528a55d717add8f64c5">rb_enc_find_index</a>(sname);
<a name="l00991"></a>00991         <span class="keywordflow">if</span> (0 &lt;= sidx) {
<a name="l00992"></a>00992             senc = <a class="code" href="../../d5/db5/encoding_8c.html#aef9c377b2d9d78b9f88e890b77593109">rb_enc_from_index</a>(sidx);
<a name="l00993"></a>00993         }
<a name="l00994"></a>00994     }
<a name="l00995"></a>00995 
<a name="l00996"></a>00996     denc = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l00997"></a>00997     <span class="keywordflow">if</span> (*dname) {
<a name="l00998"></a>00998         didx = <a class="code" href="../../d5/db5/encoding_8c.html#adeb5f5b97ea43528a55d717add8f64c5">rb_enc_find_index</a>(dname);
<a name="l00999"></a>00999         <span class="keywordflow">if</span> (0 &lt;= didx) {
<a name="l01000"></a>01000             denc = <a class="code" href="../../d5/db5/encoding_8c.html#aef9c377b2d9d78b9f88e890b77593109">rb_enc_from_index</a>(didx);
<a name="l01001"></a>01001         }
<a name="l01002"></a>01002     }
<a name="l01003"></a>01003 
<a name="l01004"></a>01004     <span class="keywordflow">if</span> (*sname == <span class="charliteral">&apos;\0&apos;</span> &amp;&amp; *dname == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l01005"></a>01005         num_trans = 0;
<a name="l01006"></a>01006         entries = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01007"></a>01007     }
<a name="l01008"></a>01008     <span class="keywordflow">else</span> {
<a name="l01009"></a>01009         <span class="keyword">struct </span><a class="code" href="../../d8/d00/structtrans__open__t.html">trans_open_t</a> toarg;
<a name="l01010"></a>01010         toarg.<a class="code" href="../../d8/d00/structtrans__open__t.html#a2408af148ed792b7f35a60d87f8ea079">entries</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01011"></a>01011         toarg.<a class="code" href="../../d8/d00/structtrans__open__t.html#a3e89ac80ddc7a1996f1d2047629cd702">num_additional</a> = 0;
<a name="l01012"></a>01012         num_trans = <a class="code" href="../../d3/d26/transcode_8c.html#afc49640284e9c9fdda17cea6952a4026">transcode_search_path</a>(sname, dname, <a class="code" href="../../d3/d26/transcode_8c.html#a09c230919cbcf4967062c7e268d218f8">trans_open_i</a>, (<span class="keywordtype">void</span> *)&amp;toarg);
<a name="l01013"></a>01013         entries = toarg.entries;
<a name="l01014"></a>01014         <span class="keywordflow">if</span> (num_trans &lt; 0) {
<a name="l01015"></a>01015             <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(entries);
<a name="l01016"></a>01016             <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01017"></a>01017         }
<a name="l01018"></a>01018     }
<a name="l01019"></a>01019 
<a name="l01020"></a>01020     ec = <a class="code" href="../../d3/d26/transcode_8c.html#af5f6f9d88dd8a47c54cd624d93698078">rb_econv_open_by_transcoder_entries</a>(num_trans, entries);
<a name="l01021"></a>01021     <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(entries);
<a name="l01022"></a>01022     <span class="keywordflow">if</span> (!ec)
<a name="l01023"></a>01023         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01024"></a>01024 
<a name="l01025"></a>01025     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afe610e62515fe51de0398ca90a6a891b">flags</a> = ecflags;
<a name="l01026"></a>01026     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a22bbe71170a0fbfce6b1ac29c7677f4c">source_encoding_name</a> = sname;
<a name="l01027"></a>01027     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afd32fa6d348fa4997c2ec5dde2001c79">destination_encoding_name</a> = dname;
<a name="l01028"></a>01028 
<a name="l01029"></a>01029     <span class="keywordflow">return</span> ec;
<a name="l01030"></a>01030 }
<a name="l01031"></a>01031 
<a name="l01032"></a><a class="code" href="../../d3/d26/transcode_8c.html#acd3ef07bd13c8bb9dd12a7aaff4fd0a1">01032</a> <span class="preprocessor">#define MAX_ECFLAGS_DECORATORS 32</span>
<a name="l01033"></a>01033 <span class="preprocessor"></span>
<a name="l01034"></a>01034 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01035"></a><a class="code" href="../../d3/d26/transcode_8c.html#a20f5177a1affe9471f536f9ace54b42e">01035</a> <a class="code" href="../../d3/d26/transcode_8c.html#a20f5177a1affe9471f536f9ace54b42e">decorator_names</a>(<span class="keywordtype">int</span> ecflags, <span class="keyword">const</span> <span class="keywordtype">char</span> **decorators_ret)
<a name="l01036"></a>01036 {
<a name="l01037"></a>01037     <span class="keywordtype">int</span> num_decorators;
<a name="l01038"></a>01038 
<a name="l01039"></a>01039     <span class="keywordflow">switch</span> (ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#aea188e77ea841e2c7741a9ef8c4c33a5">ECONV_NEWLINE_DECORATOR_MASK</a>) {
<a name="l01040"></a>01040       <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a122d5f3118774ae1a01a3262c73141eb">ECONV_UNIVERSAL_NEWLINE_DECORATOR</a>:
<a name="l01041"></a>01041       <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a38b80a28fd1ac8423761193a71d7752c">ECONV_CRLF_NEWLINE_DECORATOR</a>:
<a name="l01042"></a>01042       <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a64019d94f530b33a149a2016278cc940">ECONV_CR_NEWLINE_DECORATOR</a>:
<a name="l01043"></a>01043       <span class="keywordflow">case</span> 0:
<a name="l01044"></a>01044         <span class="keywordflow">break</span>;
<a name="l01045"></a>01045       <span class="keywordflow">default</span>:
<a name="l01046"></a>01046         <span class="keywordflow">return</span> -1;
<a name="l01047"></a>01047     }
<a name="l01048"></a>01048 
<a name="l01049"></a>01049     <span class="keywordflow">if</span> ((ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a5477824dfc0b7b9f38411f309610fe69">ECONV_XML_TEXT_DECORATOR</a>) &amp;&amp;
<a name="l01050"></a>01050         (ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a30366abfd546975d8e5c945289afb9a2">ECONV_XML_ATTR_CONTENT_DECORATOR</a>))
<a name="l01051"></a>01051         <span class="keywordflow">return</span> -1;
<a name="l01052"></a>01052 
<a name="l01053"></a>01053     num_decorators = 0;
<a name="l01054"></a>01054 
<a name="l01055"></a>01055     <span class="keywordflow">if</span> (ecflags &amp; ECONV_XML_TEXT_DECORATOR)
<a name="l01056"></a>01056         decorators_ret[num_decorators++] = <span class="stringliteral">&quot;xml_text_escape&quot;</span>;
<a name="l01057"></a>01057     <span class="keywordflow">if</span> (ecflags &amp; ECONV_XML_ATTR_CONTENT_DECORATOR)
<a name="l01058"></a>01058         decorators_ret[num_decorators++] = <span class="stringliteral">&quot;xml_attr_content_escape&quot;</span>;
<a name="l01059"></a>01059     <span class="keywordflow">if</span> (ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a01a2578ca9179596c418d8ad3ce946d5">ECONV_XML_ATTR_QUOTE_DECORATOR</a>)
<a name="l01060"></a>01060         decorators_ret[num_decorators++] = <span class="stringliteral">&quot;xml_attr_quote&quot;</span>;
<a name="l01061"></a>01061 
<a name="l01062"></a>01062     <span class="keywordflow">if</span> (ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a38b80a28fd1ac8423761193a71d7752c">ECONV_CRLF_NEWLINE_DECORATOR</a>)
<a name="l01063"></a>01063         decorators_ret[num_decorators++] = <span class="stringliteral">&quot;crlf_newline&quot;</span>;
<a name="l01064"></a>01064     <span class="keywordflow">if</span> (ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a64019d94f530b33a149a2016278cc940">ECONV_CR_NEWLINE_DECORATOR</a>)
<a name="l01065"></a>01065         decorators_ret[num_decorators++] = <span class="stringliteral">&quot;cr_newline&quot;</span>;
<a name="l01066"></a>01066     <span class="keywordflow">if</span> (ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a122d5f3118774ae1a01a3262c73141eb">ECONV_UNIVERSAL_NEWLINE_DECORATOR</a>)
<a name="l01067"></a>01067         decorators_ret[num_decorators++] = <span class="stringliteral">&quot;universal_newline&quot;</span>;
<a name="l01068"></a>01068 
<a name="l01069"></a>01069     <span class="keywordflow">return</span> num_decorators;
<a name="l01070"></a>01070 }
<a name="l01071"></a>01071 
<a name="l01072"></a>01072 <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *
<a name="l01073"></a><a class="code" href="../../d3/d26/transcode_8c.html#a3a97a8567b4b57f2aa75be24e1616105">01073</a> <a class="code" href="../../d5/de3/encoding_8h.html#af532021ea48e3846a419d3b8263a9311">rb_econv_open</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sname, <span class="keyword">const</span> <span class="keywordtype">char</span> *dname, <span class="keywordtype">int</span> ecflags)
<a name="l01074"></a>01074 {
<a name="l01075"></a>01075     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec;
<a name="l01076"></a>01076     <span class="keywordtype">int</span> num_decorators;
<a name="l01077"></a>01077     <span class="keyword">const</span> <span class="keywordtype">char</span> *decorators[<a class="code" href="../../d3/d26/transcode_8c.html#acd3ef07bd13c8bb9dd12a7aaff4fd0a1">MAX_ECFLAGS_DECORATORS</a>];
<a name="l01078"></a>01078     <span class="keywordtype">int</span> i;
<a name="l01079"></a>01079 
<a name="l01080"></a>01080     num_decorators = <a class="code" href="../../d3/d26/transcode_8c.html#a20f5177a1affe9471f536f9ace54b42e">decorator_names</a>(ecflags, decorators);
<a name="l01081"></a>01081     <span class="keywordflow">if</span> (num_decorators == -1)
<a name="l01082"></a>01082         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01083"></a>01083 
<a name="l01084"></a>01084     ec = <a class="code" href="../../d3/d26/transcode_8c.html#a15f584f7b49e59c0910acdac6b7c2e81">rb_econv_open0</a>(sname, dname, ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#ab6cbd026c964d4c120c79d8cbe0cb7d0">ECONV_ERROR_HANDLER_MASK</a>);
<a name="l01085"></a>01085     <span class="keywordflow">if</span> (!ec)
<a name="l01086"></a>01086         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01087"></a>01087 
<a name="l01088"></a>01088     <span class="keywordflow">for</span> (i = 0; i &lt; num_decorators; i++)
<a name="l01089"></a>01089         <span class="keywordflow">if</span> (<a class="code" href="../../d5/de3/encoding_8h.html#a8bde6e4cc6a48be6ee512559223f3b85">rb_econv_decorate_at_last</a>(ec, decorators[i]) == -1) {
<a name="l01090"></a>01090             <a class="code" href="../../d5/de3/encoding_8h.html#adaf53306799f8796d7e6437bc98d0b0e">rb_econv_close</a>(ec);
<a name="l01091"></a>01091             <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01092"></a>01092         }
<a name="l01093"></a>01093 
<a name="l01094"></a>01094     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afe610e62515fe51de0398ca90a6a891b">flags</a> |= ecflags &amp; ~ECONV_ERROR_HANDLER_MASK;
<a name="l01095"></a>01095 
<a name="l01096"></a>01096     <span class="keywordflow">return</span> ec;
<a name="l01097"></a>01097 }
<a name="l01098"></a>01098 
<a name="l01099"></a>01099 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01100"></a><a class="code" href="../../d3/d26/transcode_8c.html#abc543e02383e75ca192176096c6b3646">01100</a> <a class="code" href="../../d3/d26/transcode_8c.html#abc543e02383e75ca192176096c6b3646">trans_sweep</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec,
<a name="l01101"></a>01101     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **input_ptr, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *input_stop,
<a name="l01102"></a>01102     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **output_ptr, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *output_stop,
<a name="l01103"></a>01103     <span class="keywordtype">int</span> flags,
<a name="l01104"></a>01104     <span class="keywordtype">int</span> start)
<a name="l01105"></a>01105 {
<a name="l01106"></a>01106     <span class="keywordtype">int</span> <span class="keywordflow">try</span>;
<a name="l01107"></a>01107     <span class="keywordtype">int</span> i, f;
<a name="l01108"></a>01108 
<a name="l01109"></a>01109     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **ipp, *is, *iold;
<a name="l01110"></a>01110     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **opp, *os, *oold;
<a name="l01111"></a>01111     <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a> res;
<a name="l01112"></a>01112 
<a name="l01113"></a>01113     <span class="keywordflow">try</span> = 1;
<a name="l01114"></a>01114     <span class="keywordflow">while</span> (<span class="keywordflow">try</span>) {
<a name="l01115"></a>01115         <span class="keywordflow">try</span> = 0;
<a name="l01116"></a>01116         <span class="keywordflow">for</span> (i = start; i &lt; ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>; i++) {
<a name="l01117"></a>01117             <a class="code" href="../../d5/d6c/structrb__econv__elem__t.html">rb_econv_elem_t</a> *te = &amp;ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i];
<a name="l01118"></a>01118 
<a name="l01119"></a>01119             <span class="keywordflow">if</span> (i == 0) {
<a name="l01120"></a>01120                 ipp = input_ptr;
<a name="l01121"></a>01121                 is = input_stop;
<a name="l01122"></a>01122             }
<a name="l01123"></a>01123             <span class="keywordflow">else</span> {
<a name="l01124"></a>01124                 <a class="code" href="../../d5/d6c/structrb__econv__elem__t.html">rb_econv_elem_t</a> *prev_te = &amp;ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i-1];
<a name="l01125"></a>01125                 ipp = (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **)&amp;prev_te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a4022fc650a937371403f1b17ebd1d24d">out_data_start</a>;
<a name="l01126"></a>01126                 is = prev_te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#af6319607c08232cd7c528a5e0f18c408">out_data_end</a>;
<a name="l01127"></a>01127             }
<a name="l01128"></a>01128 
<a name="l01129"></a>01129             <span class="keywordflow">if</span> (i == ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1) {
<a name="l01130"></a>01130                 opp = output_ptr;
<a name="l01131"></a>01131                 os = output_stop;
<a name="l01132"></a>01132             }
<a name="l01133"></a>01133             <span class="keywordflow">else</span> {
<a name="l01134"></a>01134                 <span class="keywordflow">if</span> (te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a854388ef0bc7a190f14bc1ff6c99494a">out_buf_start</a> != te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a4022fc650a937371403f1b17ebd1d24d">out_data_start</a>) {
<a name="l01135"></a>01135                     ssize_t <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#af6319607c08232cd7c528a5e0f18c408">out_data_end</a> - te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a4022fc650a937371403f1b17ebd1d24d">out_data_start</a>;
<a name="l01136"></a>01136                     ssize_t off = te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a4022fc650a937371403f1b17ebd1d24d">out_data_start</a> - te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a854388ef0bc7a190f14bc1ff6c99494a">out_buf_start</a>;
<a name="l01137"></a>01137                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aad09de334c9b8c7f717d314b14679e62">MEMMOVE</a>(te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a854388ef0bc7a190f14bc1ff6c99494a">out_buf_start</a>, te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a4022fc650a937371403f1b17ebd1d24d">out_data_start</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, len);
<a name="l01138"></a>01138                     te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a4022fc650a937371403f1b17ebd1d24d">out_data_start</a> = te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a854388ef0bc7a190f14bc1ff6c99494a">out_buf_start</a>;
<a name="l01139"></a>01139                     te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#af6319607c08232cd7c528a5e0f18c408">out_data_end</a> -= off;
<a name="l01140"></a>01140                 }
<a name="l01141"></a>01141                 opp = &amp;te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#af6319607c08232cd7c528a5e0f18c408">out_data_end</a>;
<a name="l01142"></a>01142                 os = te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#aeb112d51d22fbc31883328b8855a7ee4">out_buf_end</a>;
<a name="l01143"></a>01143             }
<a name="l01144"></a>01144 
<a name="l01145"></a>01145             f = flags;
<a name="l01146"></a>01146             <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#affe06137c41d5acc36b506e3222be524">num_finished</a> != i)
<a name="l01147"></a>01147                 f |= <a class="code" href="../../d5/de3/encoding_8h.html#ab1eeed22e1b00841e21fa4715df0029e">ECONV_PARTIAL_INPUT</a>;
<a name="l01148"></a>01148             <span class="keywordflow">if</span> (i == 0 &amp;&amp; (flags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a0311828d8ad5d3ba4bdce5fd9244301b">ECONV_AFTER_OUTPUT</a>)) {
<a name="l01149"></a>01149                 start = 1;
<a name="l01150"></a>01150                 flags &amp;= ~ECONV_AFTER_OUTPUT;
<a name="l01151"></a>01151             }
<a name="l01152"></a>01152             <span class="keywordflow">if</span> (i != 0)
<a name="l01153"></a>01153                 f &amp;= ~ECONV_AFTER_OUTPUT;
<a name="l01154"></a>01154             iold = *ipp;
<a name="l01155"></a>01155             oold = *opp;
<a name="l01156"></a>01156             te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#ab0e4131eb67e1748b32a847875731c95">last_result</a> = res = <a class="code" href="../../d3/d26/transcode_8c.html#a59e3e6d05fb5ed6f8927e1f64de83c8c">rb_transcoding_convert</a>(te-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>, ipp, is, opp, os, f);
<a name="l01157"></a>01157             <span class="keywordflow">if</span> (iold != *ipp || oold != *opp)
<a name="l01158"></a>01158                 <span class="keywordflow">try</span> = 1;
<a name="l01159"></a>01159 
<a name="l01160"></a>01160             <span class="keywordflow">switch</span> (res) {
<a name="l01161"></a>01161               <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad43244977ecc5d0f0cda6d003b1e37d1">econv_invalid_byte_sequence</a>:
<a name="l01162"></a>01162               <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa42fe600023b5129588324a787ade662d">econv_incomplete_input</a>:
<a name="l01163"></a>01163               <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7e59e5dc4cb8b9db559a803ee88aec57">econv_undefined_conversion</a>:
<a name="l01164"></a>01164               <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7fc541cded41d5957480dcf17859e782">econv_after_output</a>:
<a name="l01165"></a>01165                 <span class="keywordflow">return</span> i;
<a name="l01166"></a>01166 
<a name="l01167"></a>01167               <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a>:
<a name="l01168"></a>01168               <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>:
<a name="l01169"></a>01169                 <span class="keywordflow">break</span>;
<a name="l01170"></a>01170 
<a name="l01171"></a>01171               <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa50dc17a7e8399ca9dcd98a7b6e652764">econv_finished</a>:
<a name="l01172"></a>01172                 ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#affe06137c41d5acc36b506e3222be524">num_finished</a> = i+1;
<a name="l01173"></a>01173                 <span class="keywordflow">break</span>;
<a name="l01174"></a>01174             }
<a name="l01175"></a>01175         }
<a name="l01176"></a>01176     }
<a name="l01177"></a>01177     <span class="keywordflow">return</span> -1;
<a name="l01178"></a>01178 }
<a name="l01179"></a>01179 
<a name="l01180"></a>01180 <span class="keyword">static</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a>
<a name="l01181"></a><a class="code" href="../../d3/d26/transcode_8c.html#aac73300aeb5329e1e981cb53640c2605">01181</a> <a class="code" href="../../d3/d26/transcode_8c.html#aac73300aeb5329e1e981cb53640c2605">rb_trans_conv</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec,
<a name="l01182"></a>01182     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **input_ptr, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *input_stop,
<a name="l01183"></a>01183     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **output_ptr, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *output_stop,
<a name="l01184"></a>01184     <span class="keywordtype">int</span> flags,
<a name="l01185"></a>01185     <span class="keywordtype">int</span> *result_position_ptr)
<a name="l01186"></a>01186 {
<a name="l01187"></a>01187     <span class="keywordtype">int</span> i;
<a name="l01188"></a>01188     <span class="keywordtype">int</span> needreport_index;
<a name="l01189"></a>01189     <span class="keywordtype">int</span> sweep_start;
<a name="l01190"></a>01190 
<a name="l01191"></a>01191     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> empty_buf;
<a name="l01192"></a>01192     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *empty_ptr = &amp;empty_buf;
<a name="l01193"></a>01193 
<a name="l01194"></a>01194     <span class="keywordflow">if</span> (!input_ptr) {
<a name="l01195"></a>01195         input_ptr = (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **)&amp;empty_ptr;
<a name="l01196"></a>01196         input_stop = empty_ptr;
<a name="l01197"></a>01197     }
<a name="l01198"></a>01198 
<a name="l01199"></a>01199     <span class="keywordflow">if</span> (!output_ptr) {
<a name="l01200"></a>01200         output_ptr = &amp;empty_ptr;
<a name="l01201"></a>01201         output_stop = empty_ptr;
<a name="l01202"></a>01202     }
<a name="l01203"></a>01203 
<a name="l01204"></a>01204     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[0].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#ab0e4131eb67e1748b32a847875731c95">last_result</a> == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7fc541cded41d5957480dcf17859e782">econv_after_output</a>)
<a name="l01205"></a>01205         ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[0].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#ab0e4131eb67e1748b32a847875731c95">last_result</a> = <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>;
<a name="l01206"></a>01206 
<a name="l01207"></a>01207     needreport_index = -1;
<a name="l01208"></a>01208     <span class="keywordflow">for</span> (i = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1; 0 &lt;= i; i--) {
<a name="l01209"></a>01209         <span class="keywordflow">switch</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#ab0e4131eb67e1748b32a847875731c95">last_result</a>) {
<a name="l01210"></a>01210           <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad43244977ecc5d0f0cda6d003b1e37d1">econv_invalid_byte_sequence</a>:
<a name="l01211"></a>01211           <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa42fe600023b5129588324a787ade662d">econv_incomplete_input</a>:
<a name="l01212"></a>01212           <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7e59e5dc4cb8b9db559a803ee88aec57">econv_undefined_conversion</a>:
<a name="l01213"></a>01213           <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7fc541cded41d5957480dcf17859e782">econv_after_output</a>:
<a name="l01214"></a>01214           <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa50dc17a7e8399ca9dcd98a7b6e652764">econv_finished</a>:
<a name="l01215"></a>01215             sweep_start = i+1;
<a name="l01216"></a>01216             needreport_index = i;
<a name="l01217"></a>01217             <span class="keywordflow">goto</span> found_needreport;
<a name="l01218"></a>01218 
<a name="l01219"></a>01219           <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a>:
<a name="l01220"></a>01220           <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>:
<a name="l01221"></a>01221             <span class="keywordflow">break</span>;
<a name="l01222"></a>01222 
<a name="l01223"></a>01223           <span class="keywordflow">default</span>:
<a name="l01224"></a>01224             <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;unexpected transcode last result&quot;</span>);
<a name="l01225"></a>01225         }
<a name="l01226"></a>01226     }
<a name="l01227"></a>01227 
<a name="l01228"></a>01228     <span class="comment">/* /^[sd]+$/ is confirmed.  but actually /^s*d*$/. */</span>
<a name="l01229"></a>01229 
<a name="l01230"></a>01230     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#ab0e4131eb67e1748b32a847875731c95">last_result</a> == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a> &amp;&amp;
<a name="l01231"></a>01231         (flags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a0311828d8ad5d3ba4bdce5fd9244301b">ECONV_AFTER_OUTPUT</a>)) {
<a name="l01232"></a>01232         <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a> res;
<a name="l01233"></a>01233 
<a name="l01234"></a>01234         res = <a class="code" href="../../d3/d26/transcode_8c.html#aac73300aeb5329e1e981cb53640c2605">rb_trans_conv</a>(ec, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, output_ptr, output_stop,
<a name="l01235"></a>01235                 (flags &amp; ~ECONV_AFTER_OUTPUT)|<a class="code" href="../../d5/de3/encoding_8h.html#ab1eeed22e1b00841e21fa4715df0029e">ECONV_PARTIAL_INPUT</a>,
<a name="l01236"></a>01236                 result_position_ptr);
<a name="l01237"></a>01237 
<a name="l01238"></a>01238         <span class="keywordflow">if</span> (res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>)
<a name="l01239"></a>01239             <span class="keywordflow">return</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7fc541cded41d5957480dcf17859e782">econv_after_output</a>;
<a name="l01240"></a>01240         <span class="keywordflow">return</span> res;
<a name="l01241"></a>01241     }
<a name="l01242"></a>01242 
<a name="l01243"></a>01243     sweep_start = 0;
<a name="l01244"></a>01244 
<a name="l01245"></a>01245   found_needreport:
<a name="l01246"></a>01246 
<a name="l01247"></a>01247     <span class="keywordflow">do</span> {
<a name="l01248"></a>01248         needreport_index = <a class="code" href="../../d3/d26/transcode_8c.html#abc543e02383e75ca192176096c6b3646">trans_sweep</a>(ec, input_ptr, input_stop, output_ptr, output_stop, flags, sweep_start);
<a name="l01249"></a>01249         sweep_start = needreport_index + 1;
<a name="l01250"></a>01250     } <span class="keywordflow">while</span> (needreport_index != -1 &amp;&amp; needreport_index != ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1);
<a name="l01251"></a>01251 
<a name="l01252"></a>01252     <span class="keywordflow">for</span> (i = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1; 0 &lt;= i; i--) {
<a name="l01253"></a>01253         <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#ab0e4131eb67e1748b32a847875731c95">last_result</a> != <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>) {
<a name="l01254"></a>01254             <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a> res = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#ab0e4131eb67e1748b32a847875731c95">last_result</a>;
<a name="l01255"></a>01255             <span class="keywordflow">if</span> (res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad43244977ecc5d0f0cda6d003b1e37d1">econv_invalid_byte_sequence</a> ||
<a name="l01256"></a>01256                 res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa42fe600023b5129588324a787ade662d">econv_incomplete_input</a> ||
<a name="l01257"></a>01257                 res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7e59e5dc4cb8b9db559a803ee88aec57">econv_undefined_conversion</a> ||
<a name="l01258"></a>01258                 res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7fc541cded41d5957480dcf17859e782">econv_after_output</a>) {
<a name="l01259"></a>01259                 ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#ab0e4131eb67e1748b32a847875731c95">last_result</a> = <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>;
<a name="l01260"></a>01260             }
<a name="l01261"></a>01261             <span class="keywordflow">if</span> (result_position_ptr)
<a name="l01262"></a>01262                 *result_position_ptr = i;
<a name="l01263"></a>01263             <span class="keywordflow">return</span> res;
<a name="l01264"></a>01264         }
<a name="l01265"></a>01265     }
<a name="l01266"></a>01266     <span class="keywordflow">if</span> (result_position_ptr)
<a name="l01267"></a>01267         *result_position_ptr = -1;
<a name="l01268"></a>01268     <span class="keywordflow">return</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>;
<a name="l01269"></a>01269 }
<a name="l01270"></a>01270 
<a name="l01271"></a>01271 <span class="keyword">static</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a>
<a name="l01272"></a><a class="code" href="../../d3/d26/transcode_8c.html#ac0afadb8f8f1827a472fd16873645849">01272</a> <a class="code" href="../../d3/d26/transcode_8c.html#ac0afadb8f8f1827a472fd16873645849">rb_econv_convert0</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec,
<a name="l01273"></a>01273     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **input_ptr, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *input_stop,
<a name="l01274"></a>01274     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **output_ptr, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *output_stop,
<a name="l01275"></a>01275     <span class="keywordtype">int</span> flags)
<a name="l01276"></a>01276 {
<a name="l01277"></a>01277     <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a> res;
<a name="l01278"></a>01278     <span class="keywordtype">int</span> result_position;
<a name="l01279"></a>01279     <span class="keywordtype">int</span> has_output = 0;
<a name="l01280"></a>01280 
<a name="l01281"></a>01281     memset(&amp;ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>, 0, <span class="keyword">sizeof</span>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>));
<a name="l01282"></a>01282 
<a name="l01283"></a>01283     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a> == 0) {
<a name="l01284"></a>01284         <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l01285"></a>01285         <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a0604b16d6b3c882135b53011c762d1a2">in_buf_start</a> &amp;&amp; ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a79204dbf92e8b20a7e7fd3513667a6fb">in_data_start</a> != ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ade30d9cec3597c3d2d44df9e312760d9">in_data_end</a>) {
<a name="l01286"></a>01286             <span class="keywordflow">if</span> (output_stop - *output_ptr &lt; ec-&gt;in_data_end - ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a79204dbf92e8b20a7e7fd3513667a6fb">in_data_start</a>) {
<a name="l01287"></a>01287                 len = output_stop - *output_ptr;
<a name="l01288"></a>01288                 memcpy(*output_ptr, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a79204dbf92e8b20a7e7fd3513667a6fb">in_data_start</a>, len);
<a name="l01289"></a>01289                 *output_ptr = output_stop;
<a name="l01290"></a>01290                 ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a79204dbf92e8b20a7e7fd3513667a6fb">in_data_start</a> += len;
<a name="l01291"></a>01291                 res = <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a>;
<a name="l01292"></a>01292                 <span class="keywordflow">goto</span> gotresult;
<a name="l01293"></a>01293             }
<a name="l01294"></a>01294             len = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ade30d9cec3597c3d2d44df9e312760d9">in_data_end</a> - ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a79204dbf92e8b20a7e7fd3513667a6fb">in_data_start</a>;
<a name="l01295"></a>01295             memcpy(*output_ptr, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a79204dbf92e8b20a7e7fd3513667a6fb">in_data_start</a>, len);
<a name="l01296"></a>01296             *output_ptr += len;
<a name="l01297"></a>01297             ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a79204dbf92e8b20a7e7fd3513667a6fb">in_data_start</a> = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ade30d9cec3597c3d2d44df9e312760d9">in_data_end</a> = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a0604b16d6b3c882135b53011c762d1a2">in_buf_start</a>;
<a name="l01298"></a>01298             <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a0311828d8ad5d3ba4bdce5fd9244301b">ECONV_AFTER_OUTPUT</a>) {
<a name="l01299"></a>01299                 res = <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7fc541cded41d5957480dcf17859e782">econv_after_output</a>;
<a name="l01300"></a>01300                 <span class="keywordflow">goto</span> gotresult;
<a name="l01301"></a>01301             }
<a name="l01302"></a>01302         }
<a name="l01303"></a>01303         <span class="keywordflow">if</span> (output_stop - *output_ptr &lt; input_stop - *input_ptr) {
<a name="l01304"></a>01304             len = output_stop - *output_ptr;
<a name="l01305"></a>01305         }
<a name="l01306"></a>01306         <span class="keywordflow">else</span> {
<a name="l01307"></a>01307             len = input_stop - *input_ptr;
<a name="l01308"></a>01308         }
<a name="l01309"></a>01309         <span class="keywordflow">if</span> (0 &lt; len &amp;&amp; (flags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a0311828d8ad5d3ba4bdce5fd9244301b">ECONV_AFTER_OUTPUT</a>)) {
<a name="l01310"></a>01310             *(*output_ptr)++ = *(*input_ptr)++;
<a name="l01311"></a>01311             res = <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7fc541cded41d5957480dcf17859e782">econv_after_output</a>;
<a name="l01312"></a>01312             <span class="keywordflow">goto</span> gotresult;
<a name="l01313"></a>01313         }
<a name="l01314"></a>01314         memcpy(*output_ptr, *input_ptr, len);
<a name="l01315"></a>01315         *output_ptr += len;
<a name="l01316"></a>01316         *input_ptr += len;
<a name="l01317"></a>01317         <span class="keywordflow">if</span> (*input_ptr != input_stop)
<a name="l01318"></a>01318             res = <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a>;
<a name="l01319"></a>01319         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#ab1eeed22e1b00841e21fa4715df0029e">ECONV_PARTIAL_INPUT</a>)
<a name="l01320"></a>01320             res = <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>;
<a name="l01321"></a>01321         <span class="keywordflow">else</span>
<a name="l01322"></a>01322             res = <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa50dc17a7e8399ca9dcd98a7b6e652764">econv_finished</a>;
<a name="l01323"></a>01323         <span class="keywordflow">goto</span> gotresult;
<a name="l01324"></a>01324     }
<a name="l01325"></a>01325 
<a name="l01326"></a>01326     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a4022fc650a937371403f1b17ebd1d24d">out_data_start</a>) {
<a name="l01327"></a>01327         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data_start = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a4022fc650a937371403f1b17ebd1d24d">out_data_start</a>;
<a name="l01328"></a>01328         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data_end = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#af6319607c08232cd7c528a5e0f18c408">out_data_end</a>;
<a name="l01329"></a>01329         <span class="keywordflow">if</span> (data_start != data_end) {
<a name="l01330"></a>01330             <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l01331"></a>01331             <span class="keywordflow">if</span> (output_stop - *output_ptr &lt; data_end - data_start) {
<a name="l01332"></a>01332                 len = output_stop - *output_ptr;
<a name="l01333"></a>01333                 memcpy(*output_ptr, data_start, len);
<a name="l01334"></a>01334                 *output_ptr = output_stop;
<a name="l01335"></a>01335                 ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a4022fc650a937371403f1b17ebd1d24d">out_data_start</a> += len;
<a name="l01336"></a>01336                 res = <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a>;
<a name="l01337"></a>01337                 <span class="keywordflow">goto</span> gotresult;
<a name="l01338"></a>01338             }
<a name="l01339"></a>01339             len = data_end - data_start;
<a name="l01340"></a>01340             memcpy(*output_ptr, data_start, len);
<a name="l01341"></a>01341             *output_ptr += len;
<a name="l01342"></a>01342             ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a4022fc650a937371403f1b17ebd1d24d">out_data_start</a> =
<a name="l01343"></a>01343                 ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#af6319607c08232cd7c528a5e0f18c408">out_data_end</a> =
<a name="l01344"></a>01344                 ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a854388ef0bc7a190f14bc1ff6c99494a">out_buf_start</a>;
<a name="l01345"></a>01345             has_output = 1;
<a name="l01346"></a>01346         }
<a name="l01347"></a>01347     }
<a name="l01348"></a>01348 
<a name="l01349"></a>01349     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a0604b16d6b3c882135b53011c762d1a2">in_buf_start</a> &amp;&amp;
<a name="l01350"></a>01350         ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a79204dbf92e8b20a7e7fd3513667a6fb">in_data_start</a> != ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ade30d9cec3597c3d2d44df9e312760d9">in_data_end</a>) {
<a name="l01351"></a>01351         res = <a class="code" href="../../d3/d26/transcode_8c.html#aac73300aeb5329e1e981cb53640c2605">rb_trans_conv</a>(ec, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **)&amp;ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a79204dbf92e8b20a7e7fd3513667a6fb">in_data_start</a>, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ade30d9cec3597c3d2d44df9e312760d9">in_data_end</a>, output_ptr, output_stop,
<a name="l01352"></a>01352                 (flags&amp;~<a class="code" href="../../d5/de3/encoding_8h.html#a0311828d8ad5d3ba4bdce5fd9244301b">ECONV_AFTER_OUTPUT</a>)|<a class="code" href="../../d5/de3/encoding_8h.html#ab1eeed22e1b00841e21fa4715df0029e">ECONV_PARTIAL_INPUT</a>, &amp;result_position);
<a name="l01353"></a>01353         <span class="keywordflow">if</span> (res != <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>)
<a name="l01354"></a>01354             <span class="keywordflow">goto</span> gotresult;
<a name="l01355"></a>01355     }
<a name="l01356"></a>01356 
<a name="l01357"></a>01357     <span class="keywordflow">if</span> (has_output &amp;&amp;
<a name="l01358"></a>01358         (flags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a0311828d8ad5d3ba4bdce5fd9244301b">ECONV_AFTER_OUTPUT</a>) &amp;&amp;
<a name="l01359"></a>01359         *input_ptr != input_stop) {
<a name="l01360"></a>01360         input_stop = *input_ptr;
<a name="l01361"></a>01361         res = <a class="code" href="../../d3/d26/transcode_8c.html#aac73300aeb5329e1e981cb53640c2605">rb_trans_conv</a>(ec, input_ptr, input_stop, output_ptr, output_stop, flags, &amp;result_position);
<a name="l01362"></a>01362         <span class="keywordflow">if</span> (res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>)
<a name="l01363"></a>01363             res = <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7fc541cded41d5957480dcf17859e782">econv_after_output</a>;
<a name="l01364"></a>01364     }
<a name="l01365"></a>01365     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((flags &amp; ECONV_AFTER_OUTPUT) ||
<a name="l01366"></a>01366         ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a> == 1) {
<a name="l01367"></a>01367         res = <a class="code" href="../../d3/d26/transcode_8c.html#aac73300aeb5329e1e981cb53640c2605">rb_trans_conv</a>(ec, input_ptr, input_stop, output_ptr, output_stop, flags, &amp;result_position);
<a name="l01368"></a>01368     }
<a name="l01369"></a>01369     <span class="keywordflow">else</span> {
<a name="l01370"></a>01370         flags |= ECONV_AFTER_OUTPUT;
<a name="l01371"></a>01371         <span class="keywordflow">do</span> {
<a name="l01372"></a>01372             res = <a class="code" href="../../d3/d26/transcode_8c.html#aac73300aeb5329e1e981cb53640c2605">rb_trans_conv</a>(ec, input_ptr, input_stop, output_ptr, output_stop, flags, &amp;result_position);
<a name="l01373"></a>01373         } <span class="keywordflow">while</span> (res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7fc541cded41d5957480dcf17859e782">econv_after_output</a>);
<a name="l01374"></a>01374     }
<a name="l01375"></a>01375 
<a name="l01376"></a>01376   gotresult:
<a name="l01377"></a>01377     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9db5877b884b6345adb4bd2a0b65b70">result</a> = res;
<a name="l01378"></a>01378     <span class="keywordflow">if</span> (res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad43244977ecc5d0f0cda6d003b1e37d1">econv_invalid_byte_sequence</a> ||
<a name="l01379"></a>01379         res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa42fe600023b5129588324a787ade662d">econv_incomplete_input</a> ||
<a name="l01380"></a>01380         res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7e59e5dc4cb8b9db559a803ee88aec57">econv_undefined_conversion</a>) {
<a name="l01381"></a>01381         <a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *error_tc = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[result_position].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>;
<a name="l01382"></a>01382         ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a5b07cda3f87918e9a3c3b957dbca3522">error_tc</a> = error_tc;
<a name="l01383"></a>01383         ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a> = error_tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a6f79077ecbd8da45cc181b53dc280a90">src_encoding</a>;
<a name="l01384"></a>01384         ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a> = error_tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a06f17fbc59c9055646b1a147d05f33eb">dst_encoding</a>;
<a name="l01385"></a>01385         ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#afa032001f9163782b3ffd3f7719c01b2">error_bytes_start</a> = <a class="code" href="../../d3/d26/transcode_8c.html#ac3dbd4c95ffc9795e96366aa0aa0301a">TRANSCODING_READBUF</a>(error_tc);
<a name="l01386"></a>01386         ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a18f4b226842af7c0c379bf21646409af">error_bytes_len</a> = error_tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a>;
<a name="l01387"></a>01387         ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a2eb533677cfc48e764a7940f034b1634">readagain_len</a> = error_tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a>;
<a name="l01388"></a>01388     }
<a name="l01389"></a>01389 
<a name="l01390"></a>01390     <span class="keywordflow">return</span> res;
<a name="l01391"></a>01391 }
<a name="l01392"></a>01392 
<a name="l01393"></a>01393 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d3/d26/transcode_8c.html#a3e3f66ef2f6f9ea42db516d420825690">output_replacement_character</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec);
<a name="l01394"></a>01394 
<a name="l01395"></a>01395 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01396"></a><a class="code" href="../../d3/d26/transcode_8c.html#a9a3dc1d50906e44d7be58047d29b7fa4">01396</a> <a class="code" href="../../d3/d26/transcode_8c.html#a9a3dc1d50906e44d7be58047d29b7fa4">output_hex_charref</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec)
<a name="l01397"></a>01397 {
<a name="l01398"></a>01398     <span class="keywordtype">int</span> ret;
<a name="l01399"></a>01399     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> utfbuf[1024];
<a name="l01400"></a>01400     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *utf;
<a name="l01401"></a>01401     <span class="keywordtype">size_t</span> utf_len;
<a name="l01402"></a>01402     <span class="keywordtype">int</span> utf_allocated = 0;
<a name="l01403"></a>01403     <span class="keywordtype">char</span> charef_buf[16];
<a name="l01404"></a>01404     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p;
<a name="l01405"></a>01405 
<a name="l01406"></a>01406     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#adc12ab3195f23d65f243fe172370e950">encoding_equal</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>, <span class="stringliteral">&quot;UTF-32BE&quot;</span>)) {
<a name="l01407"></a>01407         utf = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#afa032001f9163782b3ffd3f7719c01b2">error_bytes_start</a>;
<a name="l01408"></a>01408         utf_len = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a18f4b226842af7c0c379bf21646409af">error_bytes_len</a>;
<a name="l01409"></a>01409     }
<a name="l01410"></a>01410     <span class="keywordflow">else</span> {
<a name="l01411"></a>01411         utf = <a class="code" href="../../d3/d26/transcode_8c.html#a0fc07e0e3b60bf263ead254b4245a56b">allocate_converted_string</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>, <span class="stringliteral">&quot;UTF-32BE&quot;</span>,
<a name="l01412"></a>01412                 ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#afa032001f9163782b3ffd3f7719c01b2">error_bytes_start</a>, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a18f4b226842af7c0c379bf21646409af">error_bytes_len</a>,
<a name="l01413"></a>01413                 utfbuf, <span class="keyword">sizeof</span>(utfbuf),
<a name="l01414"></a>01414                 &amp;utf_len);
<a name="l01415"></a>01415         <span class="keywordflow">if</span> (!utf)
<a name="l01416"></a>01416             <span class="keywordflow">return</span> -1;
<a name="l01417"></a>01417         <span class="keywordflow">if</span> (utf != utfbuf &amp;&amp; utf != ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#afa032001f9163782b3ffd3f7719c01b2">error_bytes_start</a>)
<a name="l01418"></a>01418             utf_allocated = 1;
<a name="l01419"></a>01419     }
<a name="l01420"></a>01420 
<a name="l01421"></a>01421     <span class="keywordflow">if</span> (utf_len % 4 != 0)
<a name="l01422"></a>01422         <span class="keywordflow">goto</span> <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>;
<a name="l01423"></a>01423 
<a name="l01424"></a>01424     p = utf;
<a name="l01425"></a>01425     <span class="keywordflow">while</span> (4 &lt;= utf_len) {
<a name="l01426"></a>01426         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> u = 0;
<a name="l01427"></a>01427         u += p[0] &lt;&lt; 24;
<a name="l01428"></a>01428         u += p[1] &lt;&lt; 16;
<a name="l01429"></a>01429         u += p[2] &lt;&lt; 8;
<a name="l01430"></a>01430         u += p[3];
<a name="l01431"></a>01431         <a class="code" href="../../d7/d72/subst_8h.html#aa367b75c5aed883fef5befbdf04835a4">snprintf</a>(charef_buf, <span class="keyword">sizeof</span>(charef_buf), <span class="stringliteral">&quot;&amp;#x%X;&quot;</span>, u);
<a name="l01432"></a>01432 
<a name="l01433"></a>01433         ret = <a class="code" href="../../d5/de3/encoding_8h.html#a7c02ec315df0f70b167a76155cc97f1c">rb_econv_insert_output</a>(ec, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)charef_buf, <a class="code" href="../../d6/d7b/strchr_8c.html#a219836f542ce53545052bed5353820ca">strlen</a>(charef_buf), <span class="stringliteral">&quot;US-ASCII&quot;</span>);
<a name="l01434"></a>01434         <span class="keywordflow">if</span> (ret == -1)
<a name="l01435"></a>01435             <span class="keywordflow">goto</span> <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>;
<a name="l01436"></a>01436 
<a name="l01437"></a>01437         p += 4;
<a name="l01438"></a>01438         utf_len -= 4;
<a name="l01439"></a>01439     }
<a name="l01440"></a>01440 
<a name="l01441"></a>01441     <span class="keywordflow">if</span> (utf_allocated)
<a name="l01442"></a>01442         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>((<span class="keywordtype">void</span> *)utf);
<a name="l01443"></a>01443     <span class="keywordflow">return</span> 0;
<a name="l01444"></a>01444 
<a name="l01445"></a>01445   <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>:
<a name="l01446"></a>01446     <span class="keywordflow">if</span> (utf_allocated)
<a name="l01447"></a>01447         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>((<span class="keywordtype">void</span> *)utf);
<a name="l01448"></a>01448     <span class="keywordflow">return</span> -1;
<a name="l01449"></a>01449 }
<a name="l01450"></a>01450 
<a name="l01451"></a>01451 <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a>
<a name="l01452"></a><a class="code" href="../../d3/d26/transcode_8c.html#ab2084ec5329c3c729708279d0144c19d">01452</a> <a class="code" href="../../d5/de3/encoding_8h.html#a346451a419b3ce73da0d2323eb3238ee">rb_econv_convert</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec,
<a name="l01453"></a>01453     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **input_ptr, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *input_stop,
<a name="l01454"></a>01454     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **output_ptr, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *output_stop,
<a name="l01455"></a>01455     <span class="keywordtype">int</span> flags)
<a name="l01456"></a>01456 {
<a name="l01457"></a>01457     <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a> ret;
<a name="l01458"></a>01458 
<a name="l01459"></a>01459     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> empty_buf;
<a name="l01460"></a>01460     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *empty_ptr = &amp;empty_buf;
<a name="l01461"></a>01461 
<a name="l01462"></a>01462     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7e2bbe100caa442ca786b221a06a3e7b">started</a> = 1;
<a name="l01463"></a>01463 
<a name="l01464"></a>01464     <span class="keywordflow">if</span> (!input_ptr) {
<a name="l01465"></a>01465         input_ptr = (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **)&amp;empty_ptr;
<a name="l01466"></a>01466         input_stop = empty_ptr;
<a name="l01467"></a>01467     }
<a name="l01468"></a>01468 
<a name="l01469"></a>01469     <span class="keywordflow">if</span> (!output_ptr) {
<a name="l01470"></a>01470         output_ptr = &amp;empty_ptr;
<a name="l01471"></a>01471         output_stop = empty_ptr;
<a name="l01472"></a>01472     }
<a name="l01473"></a>01473 
<a name="l01474"></a>01474   resume:
<a name="l01475"></a>01475     ret = <a class="code" href="../../d3/d26/transcode_8c.html#ac0afadb8f8f1827a472fd16873645849">rb_econv_convert0</a>(ec, input_ptr, input_stop, output_ptr, output_stop, flags);
<a name="l01476"></a>01476 
<a name="l01477"></a>01477     <span class="keywordflow">if</span> (ret == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad43244977ecc5d0f0cda6d003b1e37d1">econv_invalid_byte_sequence</a> ||
<a name="l01478"></a>01478         ret == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa42fe600023b5129588324a787ade662d">econv_incomplete_input</a>) {
<a name="l01479"></a>01479         <span class="comment">/* deal with invalid byte sequence */</span>
<a name="l01480"></a>01480         <span class="comment">/* todo: add more alternative behaviors */</span>
<a name="l01481"></a>01481         <span class="keywordflow">switch</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afe610e62515fe51de0398ca90a6a891b">flags</a> &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a35362ab9dd9238808cc988ec66fd686b">ECONV_INVALID_MASK</a>) {
<a name="l01482"></a>01482           <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a6ebf7f037784cbfd05d0d7930532f796">ECONV_INVALID_REPLACE</a>:
<a name="l01483"></a>01483             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#a3e3f66ef2f6f9ea42db516d420825690">output_replacement_character</a>(ec) == 0)
<a name="l01484"></a>01484                 <span class="keywordflow">goto</span> resume;
<a name="l01485"></a>01485         }
<a name="l01486"></a>01486     }
<a name="l01487"></a>01487 
<a name="l01488"></a>01488     <span class="keywordflow">if</span> (ret == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7e59e5dc4cb8b9db559a803ee88aec57">econv_undefined_conversion</a>) {
<a name="l01489"></a>01489         <span class="comment">/* valid character in source encoding</span>
<a name="l01490"></a>01490 <span class="comment">         * but no related character(s) in destination encoding */</span>
<a name="l01491"></a>01491         <span class="comment">/* todo: add more alternative behaviors */</span>
<a name="l01492"></a>01492         <span class="keywordflow">switch</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afe610e62515fe51de0398ca90a6a891b">flags</a> &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a9ed00f64e0c2ec41df7747700fb17f24">ECONV_UNDEF_MASK</a>) {
<a name="l01493"></a>01493           <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a4f8674ffeb3e7e562628f54ff0a10f4e">ECONV_UNDEF_REPLACE</a>:
<a name="l01494"></a>01494             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#a3e3f66ef2f6f9ea42db516d420825690">output_replacement_character</a>(ec) == 0)
<a name="l01495"></a>01495                 <span class="keywordflow">goto</span> resume;
<a name="l01496"></a>01496             <span class="keywordflow">break</span>;
<a name="l01497"></a>01497 
<a name="l01498"></a>01498           <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#acc5cca239974f158070f17e09202fb69">ECONV_UNDEF_HEX_CHARREF</a>:
<a name="l01499"></a>01499             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#a9a3dc1d50906e44d7be58047d29b7fa4">output_hex_charref</a>(ec) == 0)
<a name="l01500"></a>01500                 <span class="keywordflow">goto</span> resume;
<a name="l01501"></a>01501             <span class="keywordflow">break</span>;
<a name="l01502"></a>01502         }
<a name="l01503"></a>01503     }
<a name="l01504"></a>01504 
<a name="l01505"></a>01505     <span class="keywordflow">return</span> ret;
<a name="l01506"></a>01506 }
<a name="l01507"></a>01507 
<a name="l01508"></a>01508 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l01509"></a><a class="code" href="../../d3/d26/transcode_8c.html#afed8d708b68f78b68ca62c51b56f0cf0">01509</a> <a class="code" href="../../d5/de3/encoding_8h.html#afed8d708b68f78b68ca62c51b56f0cf0">rb_econv_encoding_to_insert_output</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec)
<a name="l01510"></a>01510 {
<a name="l01511"></a>01511     <a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *tc = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#acb260f341ee3fbd97d43a8b5f2c067bd">last_tc</a>;
<a name="l01512"></a>01512     <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a>;
<a name="l01513"></a>01513 
<a name="l01514"></a>01514     <span class="keywordflow">if</span> (tc == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01515"></a>01515         <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01516"></a>01516 
<a name="l01517"></a>01517     tr = tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>;
<a name="l01518"></a>01518 
<a name="l01519"></a>01519     <span class="keywordflow">if</span> (tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#abe099f27f11c75c44025c06a2facdd74">asciicompat_type</a> == <a class="code" href="../../d1/daa/transcode__data_8h.html#adb434037dc10de8e7522f906cd7a8198ad010137686b51916bbf36c9595e89d61">asciicompat_encoder</a>)
<a name="l01520"></a>01520         <span class="keywordflow">return</span> tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a6f79077ecbd8da45cc181b53dc280a90">src_encoding</a>;
<a name="l01521"></a>01521     <span class="keywordflow">return</span> tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a06f17fbc59c9055646b1a147d05f33eb">dst_encoding</a>;
<a name="l01522"></a>01522 }
<a name="l01523"></a>01523 
<a name="l01524"></a>01524 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *
<a name="l01525"></a><a class="code" href="../../d3/d26/transcode_8c.html#a0fc07e0e3b60bf263ead254b4245a56b">01525</a> <a class="code" href="../../d3/d26/transcode_8c.html#a0fc07e0e3b60bf263ead254b4245a56b">allocate_converted_string</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sname, <span class="keyword">const</span> <span class="keywordtype">char</span> *dname,
<a name="l01526"></a>01526         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *str, <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>,
<a name="l01527"></a>01527         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *caller_dst_buf, <span class="keywordtype">size_t</span> caller_dst_bufsize,
<a name="l01528"></a>01528         <span class="keywordtype">size_t</span> *dst_len_ptr)
<a name="l01529"></a>01529 {
<a name="l01530"></a>01530     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *dst_str;
<a name="l01531"></a>01531     <span class="keywordtype">size_t</span> dst_len;
<a name="l01532"></a>01532     <span class="keywordtype">size_t</span> dst_bufsize;
<a name="l01533"></a>01533 
<a name="l01534"></a>01534     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec;
<a name="l01535"></a>01535     <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a> res;
<a name="l01536"></a>01536 
<a name="l01537"></a>01537     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *sp;
<a name="l01538"></a>01538     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../db/d16/debug_8h.html#a08a47aff6867e5ae146382e66d2cc26b">dp</a>;
<a name="l01539"></a>01539 
<a name="l01540"></a>01540     <span class="keywordflow">if</span> (caller_dst_buf)
<a name="l01541"></a>01541         dst_bufsize = caller_dst_bufsize;
<a name="l01542"></a>01542     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len == 0)
<a name="l01543"></a>01543         dst_bufsize = 1;
<a name="l01544"></a>01544     <span class="keywordflow">else</span>
<a name="l01545"></a>01545         dst_bufsize = len;
<a name="l01546"></a>01546 
<a name="l01547"></a>01547     ec = <a class="code" href="../../d5/de3/encoding_8h.html#af532021ea48e3846a419d3b8263a9311">rb_econv_open</a>(sname, dname, 0);
<a name="l01548"></a>01548     <span class="keywordflow">if</span> (ec == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01549"></a>01549         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01550"></a>01550     <span class="keywordflow">if</span> (caller_dst_buf)
<a name="l01551"></a>01551         dst_str = caller_dst_buf;
<a name="l01552"></a>01552     <span class="keywordflow">else</span>
<a name="l01553"></a>01553         dst_str = <a class="code" href="../../d8/db0/defines_8h.html#a6af5faec3f9662b20ffc9903f923dec0">xmalloc</a>(dst_bufsize);
<a name="l01554"></a>01554     dst_len = 0;
<a name="l01555"></a>01555     sp = str;
<a name="l01556"></a>01556     dp = dst_str+dst_len;
<a name="l01557"></a>01557     res = <a class="code" href="../../d5/de3/encoding_8h.html#a346451a419b3ce73da0d2323eb3238ee">rb_econv_convert</a>(ec, &amp;sp, str+len, &amp;dp, dst_str+dst_bufsize, 0);
<a name="l01558"></a>01558     dst_len = dp - dst_str;
<a name="l01559"></a>01559     <span class="keywordflow">while</span> (res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a>) {
<a name="l01560"></a>01560         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c75bb398badb69c7577b21486f9963f">SIZE_MAX</a>/2 &lt; dst_bufsize) {
<a name="l01561"></a>01561             <span class="keywordflow">goto</span> <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>;
<a name="l01562"></a>01562         }
<a name="l01563"></a>01563         dst_bufsize *= 2;
<a name="l01564"></a>01564         <span class="keywordflow">if</span> (dst_str == caller_dst_buf) {
<a name="l01565"></a>01565             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *tmp;
<a name="l01566"></a>01566             tmp = <a class="code" href="../../d8/db0/defines_8h.html#a6af5faec3f9662b20ffc9903f923dec0">xmalloc</a>(dst_bufsize);
<a name="l01567"></a>01567             memcpy(tmp, dst_str, dst_bufsize/2);
<a name="l01568"></a>01568             dst_str = tmp;
<a name="l01569"></a>01569         }
<a name="l01570"></a>01570         <span class="keywordflow">else</span> {
<a name="l01571"></a>01571             dst_str = <a class="code" href="../../d8/db0/defines_8h.html#a40740062faf2d95d4935112447c464ef">xrealloc</a>(dst_str, dst_bufsize);
<a name="l01572"></a>01572         }
<a name="l01573"></a>01573         dp = dst_str+dst_len;
<a name="l01574"></a>01574         res = <a class="code" href="../../d5/de3/encoding_8h.html#a346451a419b3ce73da0d2323eb3238ee">rb_econv_convert</a>(ec, &amp;sp, str+len, &amp;dp, dst_str+dst_bufsize, 0);
<a name="l01575"></a>01575         dst_len = dp - dst_str;
<a name="l01576"></a>01576     }
<a name="l01577"></a>01577     <span class="keywordflow">if</span> (res != <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa50dc17a7e8399ca9dcd98a7b6e652764">econv_finished</a>) {
<a name="l01578"></a>01578         <span class="keywordflow">goto</span> <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>;
<a name="l01579"></a>01579     }
<a name="l01580"></a>01580     <a class="code" href="../../d5/de3/encoding_8h.html#adaf53306799f8796d7e6437bc98d0b0e">rb_econv_close</a>(ec);
<a name="l01581"></a>01581     *dst_len_ptr = dst_len;
<a name="l01582"></a>01582     <span class="keywordflow">return</span> dst_str;
<a name="l01583"></a>01583 
<a name="l01584"></a>01584   <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>:
<a name="l01585"></a>01585     <span class="keywordflow">if</span> (dst_str != caller_dst_buf)
<a name="l01586"></a>01586         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(dst_str);
<a name="l01587"></a>01587     <a class="code" href="../../d5/de3/encoding_8h.html#adaf53306799f8796d7e6437bc98d0b0e">rb_econv_close</a>(ec);
<a name="l01588"></a>01588     <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01589"></a>01589 }
<a name="l01590"></a>01590 
<a name="l01591"></a>01591 <span class="comment">/* result: 0:success -1:failure */</span>
<a name="l01592"></a>01592 <span class="keywordtype">int</span>
<a name="l01593"></a><a class="code" href="../../d3/d26/transcode_8c.html#a7c02ec315df0f70b167a76155cc97f1c">01593</a> <a class="code" href="../../d5/de3/encoding_8h.html#a7c02ec315df0f70b167a76155cc97f1c">rb_econv_insert_output</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec,
<a name="l01594"></a>01594     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *str, <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *str_encoding)
<a name="l01595"></a>01595 {
<a name="l01596"></a>01596     <span class="keyword">const</span> <span class="keywordtype">char</span> *insert_encoding = <a class="code" href="../../d5/de3/encoding_8h.html#afed8d708b68f78b68ca62c51b56f0cf0">rb_econv_encoding_to_insert_output</a>(ec);
<a name="l01597"></a>01597     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> insert_buf[4096];
<a name="l01598"></a>01598     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *insert_str = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01599"></a>01599     <span class="keywordtype">size_t</span> insert_len;
<a name="l01600"></a>01600 
<a name="l01601"></a>01601     <span class="keywordtype">int</span> last_trans_index;
<a name="l01602"></a>01602     <a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *tc;
<a name="l01603"></a>01603 
<a name="l01604"></a>01604     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **buf_start_p;
<a name="l01605"></a>01605     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **data_start_p;
<a name="l01606"></a>01606     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **data_end_p;
<a name="l01607"></a>01607     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **buf_end_p;
<a name="l01608"></a>01608 
<a name="l01609"></a>01609     <span class="keywordtype">size_t</span> need;
<a name="l01610"></a>01610 
<a name="l01611"></a>01611     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7e2bbe100caa442ca786b221a06a3e7b">started</a> = 1;
<a name="l01612"></a>01612 
<a name="l01613"></a>01613     <span class="keywordflow">if</span> (len == 0)
<a name="l01614"></a>01614         <span class="keywordflow">return</span> 0;
<a name="l01615"></a>01615 
<a name="l01616"></a>01616     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#adc12ab3195f23d65f243fe172370e950">encoding_equal</a>(insert_encoding, str_encoding)) {
<a name="l01617"></a>01617         insert_str = str;
<a name="l01618"></a>01618         insert_len = len;
<a name="l01619"></a>01619     }
<a name="l01620"></a>01620     <span class="keywordflow">else</span> {
<a name="l01621"></a>01621         insert_str = <a class="code" href="../../d3/d26/transcode_8c.html#a0fc07e0e3b60bf263ead254b4245a56b">allocate_converted_string</a>(str_encoding, insert_encoding,
<a name="l01622"></a>01622                 str, len, insert_buf, <span class="keyword">sizeof</span>(insert_buf), &amp;insert_len);
<a name="l01623"></a>01623         <span class="keywordflow">if</span> (insert_str == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l01624"></a>01624             <span class="keywordflow">return</span> -1;
<a name="l01625"></a>01625     }
<a name="l01626"></a>01626 
<a name="l01627"></a>01627     need = insert_len;
<a name="l01628"></a>01628 
<a name="l01629"></a>01629     last_trans_index = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1;
<a name="l01630"></a>01630     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a> == 0) {
<a name="l01631"></a>01631         tc = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01632"></a>01632         buf_start_p = &amp;ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a0604b16d6b3c882135b53011c762d1a2">in_buf_start</a>;
<a name="l01633"></a>01633         data_start_p = &amp;ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a79204dbf92e8b20a7e7fd3513667a6fb">in_data_start</a>;
<a name="l01634"></a>01634         data_end_p = &amp;ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ade30d9cec3597c3d2d44df9e312760d9">in_data_end</a>;
<a name="l01635"></a>01635         buf_end_p = &amp;ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a40505b1017d6d6c00a616509e42d50f0">in_buf_end</a>;
<a name="l01636"></a>01636     }
<a name="l01637"></a>01637     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[last_trans_index].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#abe099f27f11c75c44025c06a2facdd74">asciicompat_type</a> == <a class="code" href="../../d1/daa/transcode__data_8h.html#adb434037dc10de8e7522f906cd7a8198ad010137686b51916bbf36c9595e89d61">asciicompat_encoder</a>) {
<a name="l01638"></a>01638         tc = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[last_trans_index].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>;
<a name="l01639"></a>01639         need += tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a>;
<a name="l01640"></a>01640         <span class="keywordflow">if</span> (need &lt; insert_len)
<a name="l01641"></a>01641             <span class="keywordflow">goto</span> <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>;
<a name="l01642"></a>01642         <span class="keywordflow">if</span> (last_trans_index == 0) {
<a name="l01643"></a>01643             buf_start_p = &amp;ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a0604b16d6b3c882135b53011c762d1a2">in_buf_start</a>;
<a name="l01644"></a>01644             data_start_p = &amp;ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a79204dbf92e8b20a7e7fd3513667a6fb">in_data_start</a>;
<a name="l01645"></a>01645             data_end_p = &amp;ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ade30d9cec3597c3d2d44df9e312760d9">in_data_end</a>;
<a name="l01646"></a>01646             buf_end_p = &amp;ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a40505b1017d6d6c00a616509e42d50f0">in_buf_end</a>;
<a name="l01647"></a>01647         }
<a name="l01648"></a>01648         <span class="keywordflow">else</span> {
<a name="l01649"></a>01649             <a class="code" href="../../d5/d6c/structrb__econv__elem__t.html">rb_econv_elem_t</a> *ee = &amp;ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[last_trans_index-1];
<a name="l01650"></a>01650             buf_start_p = &amp;ee-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a854388ef0bc7a190f14bc1ff6c99494a">out_buf_start</a>;
<a name="l01651"></a>01651             data_start_p = &amp;ee-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a4022fc650a937371403f1b17ebd1d24d">out_data_start</a>;
<a name="l01652"></a>01652             data_end_p = &amp;ee-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#af6319607c08232cd7c528a5e0f18c408">out_data_end</a>;
<a name="l01653"></a>01653             buf_end_p = &amp;ee-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#aeb112d51d22fbc31883328b8855a7ee4">out_buf_end</a>;
<a name="l01654"></a>01654         }
<a name="l01655"></a>01655     }
<a name="l01656"></a>01656     <span class="keywordflow">else</span> {
<a name="l01657"></a>01657         <a class="code" href="../../d5/d6c/structrb__econv__elem__t.html">rb_econv_elem_t</a> *ee = &amp;ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[last_trans_index];
<a name="l01658"></a>01658         buf_start_p = &amp;ee-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a854388ef0bc7a190f14bc1ff6c99494a">out_buf_start</a>;
<a name="l01659"></a>01659         data_start_p = &amp;ee-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a4022fc650a937371403f1b17ebd1d24d">out_data_start</a>;
<a name="l01660"></a>01660         data_end_p = &amp;ee-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#af6319607c08232cd7c528a5e0f18c408">out_data_end</a>;
<a name="l01661"></a>01661         buf_end_p = &amp;ee-&gt;<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#aeb112d51d22fbc31883328b8855a7ee4">out_buf_end</a>;
<a name="l01662"></a>01662         tc = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[last_trans_index].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>;
<a name="l01663"></a>01663     }
<a name="l01664"></a>01664 
<a name="l01665"></a>01665     <span class="keywordflow">if</span> (*buf_start_p == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01666"></a>01666         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a> = <a class="code" href="../../d8/db0/defines_8h.html#a6af5faec3f9662b20ffc9903f923dec0">xmalloc</a>(need);
<a name="l01667"></a>01667         *buf_start_p = buf;
<a name="l01668"></a>01668         *data_start_p = buf;
<a name="l01669"></a>01669         *data_end_p = buf;
<a name="l01670"></a>01670         *buf_end_p = buf+need;
<a name="l01671"></a>01671     }
<a name="l01672"></a>01672     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="keywordtype">size_t</span>)(*buf_end_p - *data_end_p) &lt; need) {
<a name="l01673"></a>01673         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aad09de334c9b8c7f717d314b14679e62">MEMMOVE</a>(*buf_start_p, *data_start_p, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, *data_end_p - *data_start_p);
<a name="l01674"></a>01674         *data_end_p = *buf_start_p + (*data_end_p - *data_start_p);
<a name="l01675"></a>01675         *data_start_p = *buf_start_p;
<a name="l01676"></a>01676         <span class="keywordflow">if</span> ((<span class="keywordtype">size_t</span>)(*buf_end_p - *data_end_p) &lt; need) {
<a name="l01677"></a>01677             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>;
<a name="l01678"></a>01678             <span class="keywordtype">size_t</span> s = (*data_end_p - *buf_start_p) + need;
<a name="l01679"></a>01679             <span class="keywordflow">if</span> (s &lt; need)
<a name="l01680"></a>01680                 <span class="keywordflow">goto</span> <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>;
<a name="l01681"></a>01681             buf = <a class="code" href="../../d8/db0/defines_8h.html#a40740062faf2d95d4935112447c464ef">xrealloc</a>(*buf_start_p, s);
<a name="l01682"></a>01682             *data_start_p = buf;
<a name="l01683"></a>01683             *data_end_p = buf + (*data_end_p - *buf_start_p);
<a name="l01684"></a>01684             *buf_start_p = buf;
<a name="l01685"></a>01685             *buf_end_p = buf + s;
<a name="l01686"></a>01686         }
<a name="l01687"></a>01687     }
<a name="l01688"></a>01688 
<a name="l01689"></a>01689     memcpy(*data_end_p, insert_str, insert_len);
<a name="l01690"></a>01690     *data_end_p += insert_len;
<a name="l01691"></a>01691     <span class="keywordflow">if</span> (tc &amp;&amp; tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#abe099f27f11c75c44025c06a2facdd74">asciicompat_type</a> == <a class="code" href="../../d1/daa/transcode__data_8h.html#adb434037dc10de8e7522f906cd7a8198ad010137686b51916bbf36c9595e89d61">asciicompat_encoder</a>) {
<a name="l01692"></a>01692         memcpy(*data_end_p, <a class="code" href="../../d3/d26/transcode_8c.html#ac3dbd4c95ffc9795e96366aa0aa0301a">TRANSCODING_READBUF</a>(tc)+tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a>, tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a>);
<a name="l01693"></a>01693         *data_end_p += tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a>;
<a name="l01694"></a>01694         tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a> = 0;
<a name="l01695"></a>01695     }
<a name="l01696"></a>01696 
<a name="l01697"></a>01697     <span class="keywordflow">if</span> (insert_str != str &amp;&amp; insert_str != insert_buf)
<a name="l01698"></a>01698         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>((<span class="keywordtype">void</span>*)insert_str);
<a name="l01699"></a>01699     <span class="keywordflow">return</span> 0;
<a name="l01700"></a>01700 
<a name="l01701"></a>01701   <a class="code" href="../../d9/df5/date__strptime_8c.html#a73a3b169ac8c3419cbe15327e75ffcfd">fail</a>:
<a name="l01702"></a>01702     <span class="keywordflow">if</span> (insert_str != str &amp;&amp; insert_str != insert_buf)
<a name="l01703"></a>01703         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>((<span class="keywordtype">void</span>*)insert_str);
<a name="l01704"></a>01704     <span class="keywordflow">return</span> -1;
<a name="l01705"></a>01705 }
<a name="l01706"></a>01706 
<a name="l01707"></a>01707 <span class="keywordtype">void</span>
<a name="l01708"></a><a class="code" href="../../d3/d26/transcode_8c.html#adaf53306799f8796d7e6437bc98d0b0e">01708</a> <a class="code" href="../../d5/de3/encoding_8h.html#adaf53306799f8796d7e6437bc98d0b0e">rb_econv_close</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec)
<a name="l01709"></a>01709 {
<a name="l01710"></a>01710     <span class="keywordtype">int</span> i;
<a name="l01711"></a>01711 
<a name="l01712"></a>01712     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab257a4ed6f3ca457a32ee1304af2c038">replacement_allocated</a>) {
<a name="l01713"></a>01713         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>((<span class="keywordtype">void</span> *)ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9ef89b6cd3baa02b8ec83f49a2d3a2b">replacement_str</a>);
<a name="l01714"></a>01714     }
<a name="l01715"></a>01715     <span class="keywordflow">for</span> (i = 0; i &lt; ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>; i++) {
<a name="l01716"></a>01716         <a class="code" href="../../d3/d26/transcode_8c.html#accae10f454b739a2de1515e9fd70f25e">rb_transcoding_close</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>);
<a name="l01717"></a>01717         <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a854388ef0bc7a190f14bc1ff6c99494a">out_buf_start</a>)
<a name="l01718"></a>01718             <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a854388ef0bc7a190f14bc1ff6c99494a">out_buf_start</a>);
<a name="l01719"></a>01719     }
<a name="l01720"></a>01720     <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a0604b16d6b3c882135b53011c762d1a2">in_buf_start</a>);
<a name="l01721"></a>01721     <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>);
<a name="l01722"></a>01722     <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(ec);
<a name="l01723"></a>01723 }
<a name="l01724"></a>01724 
<a name="l01725"></a>01725 <span class="keywordtype">size_t</span>
<a name="l01726"></a><a class="code" href="../../d3/d26/transcode_8c.html#a784ace349f11e9b07694c3c5c4d1a726">01726</a> <a class="code" href="../../df/d0a/io_8c.html#a5230515101f3719ac5f9b4c16f5204fa">rb_econv_memsize</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec)
<a name="l01727"></a>01727 {
<a name="l01728"></a>01728     <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a>);
<a name="l01729"></a>01729     <span class="keywordtype">int</span> i;
<a name="l01730"></a>01730 
<a name="l01731"></a>01731     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab257a4ed6f3ca457a32ee1304af2c038">replacement_allocated</a>) {
<a name="l01732"></a>01732         size += ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a40e67fdbe80e48a19ecfeaa9358fd4c2">replacement_len</a>;
<a name="l01733"></a>01733     }
<a name="l01734"></a>01734     <span class="keywordflow">for</span> (i = 0; i &lt; ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>; i++) {
<a name="l01735"></a>01735         size += <a class="code" href="../../d3/d26/transcode_8c.html#a125dfbb2bee556ee97181ff53f107200">rb_transcoding_memsize</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>);
<a name="l01736"></a>01736 
<a name="l01737"></a>01737         <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a854388ef0bc7a190f14bc1ff6c99494a">out_buf_start</a>) {
<a name="l01738"></a>01738             size += ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#aeb112d51d22fbc31883328b8855a7ee4">out_buf_end</a> - ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a854388ef0bc7a190f14bc1ff6c99494a">out_buf_start</a>;
<a name="l01739"></a>01739         }
<a name="l01740"></a>01740     }
<a name="l01741"></a>01741     size += ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a40505b1017d6d6c00a616509e42d50f0">in_buf_end</a> - ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a0604b16d6b3c882135b53011c762d1a2">in_buf_start</a>;
<a name="l01742"></a>01742     size += <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html">rb_econv_elem_t</a>) * ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#aec32851f840def8d195bcaa7de1ea4ad">num_allocated</a>;
<a name="l01743"></a>01743 
<a name="l01744"></a>01744     <span class="keywordflow">return</span> size;
<a name="l01745"></a>01745 }
<a name="l01746"></a>01746 
<a name="l01747"></a>01747 <span class="keywordtype">int</span>
<a name="l01748"></a><a class="code" href="../../d3/d26/transcode_8c.html#a3c4c5466e476fb10e4fe3c63ce08a97d">01748</a> <a class="code" href="../../d5/de3/encoding_8h.html#a3c4c5466e476fb10e4fe3c63ce08a97d">rb_econv_putbackable</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec)
<a name="l01749"></a>01749 {
<a name="l01750"></a>01750     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a> == 0)
<a name="l01751"></a>01751         <span class="keywordflow">return</span> 0;
<a name="l01752"></a>01752 <span class="preprocessor">#if SIZEOF_SIZE_T &gt; SIZEOF_INT</span>
<a name="l01753"></a>01753 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[0].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a> &gt; INT_MAX) <span class="keywordflow">return</span> INT_MAX;
<a name="l01754"></a>01754 <span class="preprocessor">#endif</span>
<a name="l01755"></a>01755 <span class="preprocessor"></span>    <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[0].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a>;
<a name="l01756"></a>01756 }
<a name="l01757"></a>01757 
<a name="l01758"></a>01758 <span class="keywordtype">void</span>
<a name="l01759"></a><a class="code" href="../../d3/d26/transcode_8c.html#af225eb5773352c9eeddb42209047d591">01759</a> <a class="code" href="../../d5/de3/encoding_8h.html#af225eb5773352c9eeddb42209047d591">rb_econv_putback</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p, <span class="keywordtype">int</span> n)
<a name="l01760"></a>01760 {
<a name="l01761"></a>01761     <a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *tc;
<a name="l01762"></a>01762     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a> == 0 || n == 0)
<a name="l01763"></a>01763         <span class="keywordflow">return</span>;
<a name="l01764"></a>01764     tc = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[0].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>;
<a name="l01765"></a>01765     memcpy(p, <a class="code" href="../../d3/d26/transcode_8c.html#ac3dbd4c95ffc9795e96366aa0aa0301a">TRANSCODING_READBUF</a>(tc) + tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a37d7b26437075391b5466dc4de23e37a">recognized_len</a> + tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a> - n, n);
<a name="l01766"></a>01766     tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#adadf53197471713efae4f12dac927dfc">readagain_len</a> -= n;
<a name="l01767"></a>01767 }
<a name="l01768"></a>01768 
<a name="l01769"></a><a class="code" href="../../d0/d17/structasciicompat__encoding__t.html">01769</a> <span class="keyword">struct </span><a class="code" href="../../d0/d17/structasciicompat__encoding__t.html">asciicompat_encoding_t</a> {
<a name="l01770"></a><a class="code" href="../../d0/d17/structasciicompat__encoding__t.html#ac629deb74d3f39d0fee142c636c25e19">01770</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/d17/structasciicompat__encoding__t.html#ac629deb74d3f39d0fee142c636c25e19">ascii_compat_name</a>;
<a name="l01771"></a><a class="code" href="../../d0/d17/structasciicompat__encoding__t.html#ae94fccbdef246ceed974fe2725a5bee8">01771</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/d17/structasciicompat__encoding__t.html#ae94fccbdef246ceed974fe2725a5bee8">ascii_incompat_name</a>;
<a name="l01772"></a>01772 };
<a name="l01773"></a>01773 
<a name="l01774"></a>01774 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01775"></a><a class="code" href="../../d3/d26/transcode_8c.html#a7c4697861f8027b09e13991ad6a195a2">01775</a> <a class="code" href="../../d3/d26/transcode_8c.html#a7c4697861f8027b09e13991ad6a195a2">asciicompat_encoding_i</a>(<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> val, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> arg)
<a name="l01776"></a>01776 {
<a name="l01777"></a>01777     <span class="keyword">struct </span><a class="code" href="../../d0/d17/structasciicompat__encoding__t.html">asciicompat_encoding_t</a> *data = (<span class="keyword">struct </span><a class="code" href="../../d0/d17/structasciicompat__encoding__t.html">asciicompat_encoding_t</a> *)arg;
<a name="l01778"></a>01778     <a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> *entry = (<a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> *)val;
<a name="l01779"></a>01779     <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a>;
<a name="l01780"></a>01780 
<a name="l01781"></a>01781     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#a7a9d71f951b9b292988b798f4f6bc29b">DECORATOR_P</a>(entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a132676776d5c8c4ed6e70c15bbba323c">sname</a>, entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a601b28ba13d193332a7233804e3342d8">dname</a>))
<a name="l01782"></a>01782         <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>;
<a name="l01783"></a>01783     tr = <a class="code" href="../../d3/d26/transcode_8c.html#adb7762bdd8e4e7e429d3aea08468d936">load_transcoder_entry</a>(entry);
<a name="l01784"></a>01784     <span class="keywordflow">if</span> (tr &amp;&amp; tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#abe099f27f11c75c44025c06a2facdd74">asciicompat_type</a> == <a class="code" href="../../d1/daa/transcode__data_8h.html#adb434037dc10de8e7522f906cd7a8198ad27471093fe256e11c3923b6c43bb8c4">asciicompat_decoder</a>) {
<a name="l01785"></a>01785         data-&gt;<a class="code" href="../../d0/d17/structasciicompat__encoding__t.html#ac629deb74d3f39d0fee142c636c25e19">ascii_compat_name</a> = tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a06f17fbc59c9055646b1a147d05f33eb">dst_encoding</a>;
<a name="l01786"></a>01786         <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fa04b939c166d4baa471909eb224d5fed3">ST_STOP</a>;
<a name="l01787"></a>01787     }
<a name="l01788"></a>01788     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>;
<a name="l01789"></a>01789 }
<a name="l01790"></a>01790 
<a name="l01791"></a>01791 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l01792"></a><a class="code" href="../../d3/d26/transcode_8c.html#a9eb4b29a9300576b3fe41a1d28f5cc5f">01792</a> <a class="code" href="../../d5/de3/encoding_8h.html#aa74ee304630f931586c6da5bbf3ee810">rb_econv_asciicompat_encoding</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d0/d17/structasciicompat__encoding__t.html#ae94fccbdef246ceed974fe2725a5bee8">ascii_incompat_name</a>)
<a name="l01793"></a>01793 {
<a name="l01794"></a>01794     <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> v;
<a name="l01795"></a>01795     <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *table2;
<a name="l01796"></a>01796     <span class="keyword">struct </span><a class="code" href="../../d0/d17/structasciicompat__encoding__t.html">asciicompat_encoding_t</a> data;
<a name="l01797"></a>01797 
<a name="l01798"></a>01798     <span class="keywordflow">if</span> (!<a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(transcoder_table, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)ascii_incompat_name, &amp;v))
<a name="l01799"></a>01799         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01800"></a>01800     table2 = (<a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *)v;
<a name="l01801"></a>01801 
<a name="l01802"></a>01802     <span class="comment">/*</span>
<a name="l01803"></a>01803 <span class="comment">     * Assumption:</span>
<a name="l01804"></a>01804 <span class="comment">     * There is at most one transcoder for</span>
<a name="l01805"></a>01805 <span class="comment">     * converting from ASCII incompatible encoding.</span>
<a name="l01806"></a>01806 <span class="comment">     *</span>
<a name="l01807"></a>01807 <span class="comment">     * For ISO-2022-JP, there is ISO-2022-JP -&gt; stateless-ISO-2022-JP and no others.</span>
<a name="l01808"></a>01808 <span class="comment">     */</span>
<a name="l01809"></a>01809     <span class="keywordflow">if</span> (table2-&gt;<a class="code" href="../../d0/ddd/structst__table.html#aa593a5229fc7d02d628a4518f56f71b6">num_entries</a> != 1)
<a name="l01810"></a>01810         <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01811"></a>01811 
<a name="l01812"></a>01812     data.<a class="code" href="../../d0/d17/structasciicompat__encoding__t.html#ae94fccbdef246ceed974fe2725a5bee8">ascii_incompat_name</a> = ascii_incompat_name;
<a name="l01813"></a>01813     data.<a class="code" href="../../d0/d17/structasciicompat__encoding__t.html#ac629deb74d3f39d0fee142c636c25e19">ascii_compat_name</a> = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01814"></a>01814     <a class="code" href="../../dd/d24/st_8h.html#ace5a79870d2800659a653fceeca55262">st_foreach</a>(table2, <a class="code" href="../../d3/d26/transcode_8c.html#a7c4697861f8027b09e13991ad6a195a2">asciicompat_encoding_i</a>, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)&amp;data);
<a name="l01815"></a>01815     <span class="keywordflow">return</span> data.ascii_compat_name;
<a name="l01816"></a>01816 }
<a name="l01817"></a>01817 
<a name="l01818"></a>01818 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01819"></a><a class="code" href="../../d3/d26/transcode_8c.html#a83d305fda48b13b45f6c5141593a1415">01819</a> <a class="code" href="../../d5/de3/encoding_8h.html#a631ef8f427c80fd4706b5d0b567ebd03">rb_econv_substr_append</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> src, <span class="keywordtype">long</span> off, <span class="keywordtype">long</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> dst, <span class="keywordtype">int</span> flags)
<a name="l01820"></a>01820 {
<a name="l01821"></a>01821     <span class="keywordtype">unsigned</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *ss, *sp, *se;
<a name="l01822"></a>01822     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ds, *<a class="code" href="../../db/d16/debug_8h.html#a08a47aff6867e5ae146382e66d2cc26b">dp</a>, *de;
<a name="l01823"></a>01823     <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a> res;
<a name="l01824"></a>01824     <span class="keywordtype">int</span> max_output;
<a name="l01825"></a>01825 
<a name="l01826"></a>01826     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(dst)) {
<a name="l01827"></a>01827         dst = <a class="code" href="../../db/d2e/intern_8h.html#a65dee742ae2daaab92ac8974cb2fbff2">rb_str_buf_new</a>(len);
<a name="l01828"></a>01828         <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a>)
<a name="l01829"></a>01829             <a class="code" href="../../d5/db5/encoding_8c.html#a150a6e3ac22ac3be8f8c2ccc74a28e7b">rb_enc_associate</a>(dst, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a>);
<a name="l01830"></a>01830     }
<a name="l01831"></a>01831 
<a name="l01832"></a>01832     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#acb260f341ee3fbd97d43a8b5f2c067bd">last_tc</a>)
<a name="l01833"></a>01833         max_output = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#acb260f341ee3fbd97d43a8b5f2c067bd">last_tc</a>-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a85dad54f3fff0861b37d422e69ebb8ab">max_output</a>;
<a name="l01834"></a>01834     <span class="keywordflow">else</span>
<a name="l01835"></a>01835         max_output = 1;
<a name="l01836"></a>01836 
<a name="l01837"></a>01837     res = <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a>;
<a name="l01838"></a>01838     <span class="keywordflow">while</span> (res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a>) {
<a name="l01839"></a>01839         <span class="keywordtype">long</span> dlen = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(dst);
<a name="l01840"></a>01840         <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#ae3485fb3fdd9b960dc803374b044c567">rb_str_capacity</a>(dst) - dlen &lt; (<span class="keywordtype">size_t</span>)len + max_output) {
<a name="l01841"></a>01841             <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> new_capa = (<span class="keywordtype">unsigned</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a>)dlen + len + max_output;
<a name="l01842"></a>01842             <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a50fece4db74f09568b2938db583c5655">LONG_MAX</a> &lt; new_capa)
<a name="l01843"></a>01843                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;too long string&quot;</span>);
<a name="l01844"></a>01844             <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(dst, new_capa);
<a name="l01845"></a>01845             <a class="code" href="../../d8/d81/ruby__missing_8h.html#a89ed8cb86ca6dd49d2db67adae809057">rb_str_set_len</a>(dst, dlen);
<a name="l01846"></a>01846         }
<a name="l01847"></a>01847         ss = sp = (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(src) + off;
<a name="l01848"></a>01848         se = ss + len;
<a name="l01849"></a>01849         ds = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(dst);
<a name="l01850"></a>01850         de = ds + <a class="code" href="../../db/d2e/intern_8h.html#ae3485fb3fdd9b960dc803374b044c567">rb_str_capacity</a>(dst);
<a name="l01851"></a>01851         dp = ds += dlen;
<a name="l01852"></a>01852         res = <a class="code" href="../../d5/de3/encoding_8h.html#a346451a419b3ce73da0d2323eb3238ee">rb_econv_convert</a>(ec, &amp;sp, se, &amp;dp, de, flags);
<a name="l01853"></a>01853         off += sp - ss;
<a name="l01854"></a>01854         len -= sp - ss;
<a name="l01855"></a>01855         <a class="code" href="../../d8/d81/ruby__missing_8h.html#a89ed8cb86ca6dd49d2db67adae809057">rb_str_set_len</a>(dst, dlen + (dp - ds));
<a name="l01856"></a>01856         <a class="code" href="../../d5/de3/encoding_8h.html#aa4320e0c296f0bce29ad2d28044dbf62">rb_econv_check_error</a>(ec);
<a name="l01857"></a>01857     }
<a name="l01858"></a>01858 
<a name="l01859"></a>01859     <span class="keywordflow">return</span> dst;
<a name="l01860"></a>01860 }
<a name="l01861"></a>01861 
<a name="l01862"></a>01862 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01863"></a><a class="code" href="../../d3/d26/transcode_8c.html#a5312a3665d95cf319536968b4291cc37">01863</a> <a class="code" href="../../d5/de3/encoding_8h.html#a5312a3665d95cf319536968b4291cc37">rb_econv_str_append</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> src, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> dst, <span class="keywordtype">int</span> flags)
<a name="l01864"></a>01864 {
<a name="l01865"></a>01865     <span class="keywordflow">return</span> <a class="code" href="../../d5/de3/encoding_8h.html#a631ef8f427c80fd4706b5d0b567ebd03">rb_econv_substr_append</a>(ec, src, 0, <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(src), dst, flags);
<a name="l01866"></a>01866 }
<a name="l01867"></a>01867 
<a name="l01868"></a>01868 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01869"></a><a class="code" href="../../d3/d26/transcode_8c.html#ab0e6105ccbb4955656bb9997b997313f">01869</a> <a class="code" href="../../d5/de3/encoding_8h.html#ab0e6105ccbb4955656bb9997b997313f">rb_econv_substr_convert</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> src, <span class="keywordtype">long</span> byteoff, <span class="keywordtype">long</span> bytesize, <span class="keywordtype">int</span> flags)
<a name="l01870"></a>01870 {
<a name="l01871"></a>01871     <span class="keywordflow">return</span> <a class="code" href="../../d5/de3/encoding_8h.html#a631ef8f427c80fd4706b5d0b567ebd03">rb_econv_substr_append</a>(ec, src, byteoff, bytesize, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>, flags);
<a name="l01872"></a>01872 }
<a name="l01873"></a>01873 
<a name="l01874"></a>01874 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01875"></a><a class="code" href="../../d3/d26/transcode_8c.html#a7e5ee7da8d856b9c500ae2b50b584627">01875</a> <a class="code" href="../../d5/de3/encoding_8h.html#a7e5ee7da8d856b9c500ae2b50b584627">rb_econv_str_convert</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> src, <span class="keywordtype">int</span> flags)
<a name="l01876"></a>01876 {
<a name="l01877"></a>01877     <span class="keywordflow">return</span> <a class="code" href="../../d5/de3/encoding_8h.html#a631ef8f427c80fd4706b5d0b567ebd03">rb_econv_substr_append</a>(ec, src, 0, <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(src), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>, flags);
<a name="l01878"></a>01878 }
<a name="l01879"></a>01879 
<a name="l01880"></a>01880 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01881"></a><a class="code" href="../../d3/d26/transcode_8c.html#ad5afa704b6216a89daab4c8dd0357f52">01881</a> <a class="code" href="../../d3/d26/transcode_8c.html#ad5afa704b6216a89daab4c8dd0357f52">rb_econv_add_converter</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec, <span class="keyword">const</span> <span class="keywordtype">char</span> *sname, <span class="keyword">const</span> <span class="keywordtype">char</span> *dname, <span class="keywordtype">int</span> n)
<a name="l01882"></a>01882 {
<a name="l01883"></a>01883     <a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> *entry;
<a name="l01884"></a>01884     <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a>;
<a name="l01885"></a>01885 
<a name="l01886"></a>01886     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7e2bbe100caa442ca786b221a06a3e7b">started</a> != 0)
<a name="l01887"></a>01887         <span class="keywordflow">return</span> -1;
<a name="l01888"></a>01888 
<a name="l01889"></a>01889     entry = <a class="code" href="../../d3/d26/transcode_8c.html#a0d3a31f80907a117b9c8b3170e3f8bbd">get_transcoder_entry</a>(sname, dname);
<a name="l01890"></a>01890     <span class="keywordflow">if</span> (!entry)
<a name="l01891"></a>01891         <span class="keywordflow">return</span> -1;
<a name="l01892"></a>01892 
<a name="l01893"></a>01893     tr = <a class="code" href="../../d3/d26/transcode_8c.html#adb7762bdd8e4e7e429d3aea08468d936">load_transcoder_entry</a>(entry);
<a name="l01894"></a>01894     <span class="keywordflow">if</span> (!tr) <span class="keywordflow">return</span> -1;
<a name="l01895"></a>01895 
<a name="l01896"></a>01896     <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a587a6cc35b2fdd295151cdde5c4d56fb">rb_econv_add_transcoder_at</a>(ec, tr, n);
<a name="l01897"></a>01897 }
<a name="l01898"></a>01898 
<a name="l01899"></a>01899 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01900"></a><a class="code" href="../../d3/d26/transcode_8c.html#a2a8c3f3bb207ce039c61339274950aad">01900</a> <a class="code" href="../../d3/d26/transcode_8c.html#a2a8c3f3bb207ce039c61339274950aad">rb_econv_decorate_at</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec, <span class="keyword">const</span> <span class="keywordtype">char</span> *decorator_name, <span class="keywordtype">int</span> n)
<a name="l01901"></a>01901 {
<a name="l01902"></a>01902     <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#ad5afa704b6216a89daab4c8dd0357f52">rb_econv_add_converter</a>(ec, <span class="stringliteral">&quot;&quot;</span>, decorator_name, n);
<a name="l01903"></a>01903 }
<a name="l01904"></a>01904 
<a name="l01905"></a>01905 <span class="keywordtype">int</span>
<a name="l01906"></a><a class="code" href="../../d3/d26/transcode_8c.html#a904130156b28f5876fdf586328c78cec">01906</a> <a class="code" href="../../d5/de3/encoding_8h.html#a904130156b28f5876fdf586328c78cec">rb_econv_decorate_at_first</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec, <span class="keyword">const</span> <span class="keywordtype">char</span> *decorator_name)
<a name="l01907"></a>01907 {
<a name="l01908"></a>01908     <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a>;
<a name="l01909"></a>01909 
<a name="l01910"></a>01910     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a> == 0)
<a name="l01911"></a>01911         <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a2a8c3f3bb207ce039c61339274950aad">rb_econv_decorate_at</a>(ec, decorator_name, 0);
<a name="l01912"></a>01912 
<a name="l01913"></a>01913     tr = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[0].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>;
<a name="l01914"></a>01914 
<a name="l01915"></a>01915     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d26/transcode_8c.html#a7a9d71f951b9b292988b798f4f6bc29b">DECORATOR_P</a>(tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a6f79077ecbd8da45cc181b53dc280a90">src_encoding</a>, tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a06f17fbc59c9055646b1a147d05f33eb">dst_encoding</a>) &amp;&amp;
<a name="l01916"></a>01916         tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#abe099f27f11c75c44025c06a2facdd74">asciicompat_type</a> == <a class="code" href="../../d1/daa/transcode__data_8h.html#adb434037dc10de8e7522f906cd7a8198ad27471093fe256e11c3923b6c43bb8c4">asciicompat_decoder</a>)
<a name="l01917"></a>01917         <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a2a8c3f3bb207ce039c61339274950aad">rb_econv_decorate_at</a>(ec, decorator_name, 1);
<a name="l01918"></a>01918 
<a name="l01919"></a>01919     <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a2a8c3f3bb207ce039c61339274950aad">rb_econv_decorate_at</a>(ec, decorator_name, 0);
<a name="l01920"></a>01920 }
<a name="l01921"></a>01921 
<a name="l01922"></a>01922 <span class="keywordtype">int</span>
<a name="l01923"></a><a class="code" href="../../d3/d26/transcode_8c.html#a8bde6e4cc6a48be6ee512559223f3b85">01923</a> <a class="code" href="../../d5/de3/encoding_8h.html#a8bde6e4cc6a48be6ee512559223f3b85">rb_econv_decorate_at_last</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec, <span class="keyword">const</span> <span class="keywordtype">char</span> *decorator_name)
<a name="l01924"></a>01924 {
<a name="l01925"></a>01925     <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a>;
<a name="l01926"></a>01926 
<a name="l01927"></a>01927     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a> == 0)
<a name="l01928"></a>01928         <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a2a8c3f3bb207ce039c61339274950aad">rb_econv_decorate_at</a>(ec, decorator_name, 0);
<a name="l01929"></a>01929 
<a name="l01930"></a>01930     tr = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>;
<a name="l01931"></a>01931 
<a name="l01932"></a>01932     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d26/transcode_8c.html#a7a9d71f951b9b292988b798f4f6bc29b">DECORATOR_P</a>(tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a6f79077ecbd8da45cc181b53dc280a90">src_encoding</a>, tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a06f17fbc59c9055646b1a147d05f33eb">dst_encoding</a>) &amp;&amp;
<a name="l01933"></a>01933         tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#abe099f27f11c75c44025c06a2facdd74">asciicompat_type</a> == <a class="code" href="../../d1/daa/transcode__data_8h.html#adb434037dc10de8e7522f906cd7a8198ad010137686b51916bbf36c9595e89d61">asciicompat_encoder</a>)
<a name="l01934"></a>01934         <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a2a8c3f3bb207ce039c61339274950aad">rb_econv_decorate_at</a>(ec, decorator_name, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1);
<a name="l01935"></a>01935 
<a name="l01936"></a>01936     <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a2a8c3f3bb207ce039c61339274950aad">rb_econv_decorate_at</a>(ec, decorator_name, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>);
<a name="l01937"></a>01937 }
<a name="l01938"></a>01938 
<a name="l01939"></a>01939 <span class="keywordtype">void</span>
<a name="l01940"></a><a class="code" href="../../d3/d26/transcode_8c.html#a8fb16d08bf53acc8c7a85fe469d3ec95">01940</a> <a class="code" href="../../d5/de3/encoding_8h.html#a8fb16d08bf53acc8c7a85fe469d3ec95">rb_econv_binmode</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec)
<a name="l01941"></a>01941 {
<a name="l01942"></a>01942     <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *trs[3];
<a name="l01943"></a>01943     <span class="keywordtype">int</span> n, i, j;
<a name="l01944"></a>01944     <a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> *entry;
<a name="l01945"></a>01945     <span class="keywordtype">int</span> num_trans;
<a name="l01946"></a>01946 
<a name="l01947"></a>01947     n = 0;
<a name="l01948"></a>01948     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afe610e62515fe51de0398ca90a6a891b">flags</a> &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a122d5f3118774ae1a01a3262c73141eb">ECONV_UNIVERSAL_NEWLINE_DECORATOR</a>) {
<a name="l01949"></a>01949         entry = <a class="code" href="../../d3/d26/transcode_8c.html#a0d3a31f80907a117b9c8b3170e3f8bbd">get_transcoder_entry</a>(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;universal_newline&quot;</span>);
<a name="l01950"></a>01950         <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a5bfe980db45acff299fe669432518b8b">transcoder</a>)
<a name="l01951"></a>01951             trs[n++] = entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a5bfe980db45acff299fe669432518b8b">transcoder</a>;
<a name="l01952"></a>01952     }
<a name="l01953"></a>01953     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afe610e62515fe51de0398ca90a6a891b">flags</a> &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a38b80a28fd1ac8423761193a71d7752c">ECONV_CRLF_NEWLINE_DECORATOR</a>) {
<a name="l01954"></a>01954         entry = <a class="code" href="../../d3/d26/transcode_8c.html#a0d3a31f80907a117b9c8b3170e3f8bbd">get_transcoder_entry</a>(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;crlf_newline&quot;</span>);
<a name="l01955"></a>01955         <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a5bfe980db45acff299fe669432518b8b">transcoder</a>)
<a name="l01956"></a>01956             trs[n++] = entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a5bfe980db45acff299fe669432518b8b">transcoder</a>;
<a name="l01957"></a>01957     }
<a name="l01958"></a>01958     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afe610e62515fe51de0398ca90a6a891b">flags</a> &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a64019d94f530b33a149a2016278cc940">ECONV_CR_NEWLINE_DECORATOR</a>) {
<a name="l01959"></a>01959         entry = <a class="code" href="../../d3/d26/transcode_8c.html#a0d3a31f80907a117b9c8b3170e3f8bbd">get_transcoder_entry</a>(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;cr_newline&quot;</span>);
<a name="l01960"></a>01960         <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a5bfe980db45acff299fe669432518b8b">transcoder</a>)
<a name="l01961"></a>01961             trs[n++] = entry-&gt;<a class="code" href="../../d0/dce/structtranscoder__entry__t.html#a5bfe980db45acff299fe669432518b8b">transcoder</a>;
<a name="l01962"></a>01962     }
<a name="l01963"></a>01963 
<a name="l01964"></a>01964     num_trans = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>;
<a name="l01965"></a>01965     j = 0;
<a name="l01966"></a>01966     <span class="keywordflow">for</span> (i = 0; i &lt; num_trans; i++) {
<a name="l01967"></a>01967         <span class="keywordtype">int</span> k;
<a name="l01968"></a>01968         <span class="keywordflow">for</span> (k = 0; k &lt; n; k++)
<a name="l01969"></a>01969             <span class="keywordflow">if</span> (trs[k] == ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>)
<a name="l01970"></a>01970                 <span class="keywordflow">break</span>;
<a name="l01971"></a>01971         <span class="keywordflow">if</span> (k == n) {
<a name="l01972"></a>01972             ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[j] = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i];
<a name="l01973"></a>01973             j++;
<a name="l01974"></a>01974         }
<a name="l01975"></a>01975         <span class="keywordflow">else</span> {
<a name="l01976"></a>01976             <a class="code" href="../../d3/d26/transcode_8c.html#accae10f454b739a2de1515e9fd70f25e">rb_transcoding_close</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>);
<a name="l01977"></a>01977             <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a854388ef0bc7a190f14bc1ff6c99494a">out_buf_start</a>);
<a name="l01978"></a>01978             ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>--;
<a name="l01979"></a>01979         }
<a name="l01980"></a>01980     }
<a name="l01981"></a>01981 
<a name="l01982"></a>01982     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afe610e62515fe51de0398ca90a6a891b">flags</a> &amp;= ~<a class="code" href="../../d5/de3/encoding_8h.html#aea188e77ea841e2c7741a9ef8c4c33a5">ECONV_NEWLINE_DECORATOR_MASK</a>;
<a name="l01983"></a>01983 
<a name="l01984"></a>01984 }
<a name="l01985"></a>01985 
<a name="l01986"></a>01986 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01987"></a><a class="code" href="../../d3/d26/transcode_8c.html#a436d11a6e0b079d3b976298fde60d85d">01987</a> <a class="code" href="../../d3/d26/transcode_8c.html#a436d11a6e0b079d3b976298fde60d85d">econv_description</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sname, <span class="keyword">const</span> <span class="keywordtype">char</span> *dname, <span class="keywordtype">int</span> ecflags, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> mesg)
<a name="l01988"></a>01988 {
<a name="l01989"></a>01989     <span class="keywordtype">int</span> has_description = 0;
<a name="l01990"></a>01990 
<a name="l01991"></a>01991     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(mesg))
<a name="l01992"></a>01992         mesg = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l01993"></a>01993 
<a name="l01994"></a>01994     <span class="keywordflow">if</span> (*sname != <span class="charliteral">&apos;\0&apos;</span> || *dname != <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l01995"></a>01995         <span class="keywordflow">if</span> (*sname == <span class="charliteral">&apos;\0&apos;</span>)
<a name="l01996"></a>01996             <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, dname);
<a name="l01997"></a>01997         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*dname == <span class="charliteral">&apos;\0&apos;</span>)
<a name="l01998"></a>01998             <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, sname);
<a name="l01999"></a>01999         <span class="keywordflow">else</span>
<a name="l02000"></a>02000             <a class="code" href="../../d9/d2d/sprintf_8c.html#a01a3022a41f713613342bbaba9ac9359">rb_str_catf</a>(mesg, <span class="stringliteral">&quot;%s to %s&quot;</span>, sname, dname);
<a name="l02001"></a>02001         has_description = 1;
<a name="l02002"></a>02002     }
<a name="l02003"></a>02003 
<a name="l02004"></a>02004     <span class="keywordflow">if</span> (ecflags &amp; (<a class="code" href="../../d5/de3/encoding_8h.html#aea188e77ea841e2c7741a9ef8c4c33a5">ECONV_NEWLINE_DECORATOR_MASK</a>|
<a name="l02005"></a>02005                    <a class="code" href="../../d5/de3/encoding_8h.html#a5477824dfc0b7b9f38411f309610fe69">ECONV_XML_TEXT_DECORATOR</a>|
<a name="l02006"></a>02006                    <a class="code" href="../../d5/de3/encoding_8h.html#a30366abfd546975d8e5c945289afb9a2">ECONV_XML_ATTR_CONTENT_DECORATOR</a>|
<a name="l02007"></a>02007                    <a class="code" href="../../d5/de3/encoding_8h.html#a01a2578ca9179596c418d8ad3ce946d5">ECONV_XML_ATTR_QUOTE_DECORATOR</a>)) {
<a name="l02008"></a>02008         <span class="keyword">const</span> <span class="keywordtype">char</span> *pre = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02009"></a>02009         <span class="keywordflow">if</span> (has_description)
<a name="l02010"></a>02010             <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, <span class="stringliteral">&quot; with &quot;</span>);
<a name="l02011"></a>02011         <span class="keywordflow">if</span> (ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a122d5f3118774ae1a01a3262c73141eb">ECONV_UNIVERSAL_NEWLINE_DECORATOR</a>)  {
<a name="l02012"></a>02012             <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, pre); pre = <span class="stringliteral">&quot;,&quot;</span>;
<a name="l02013"></a>02013             <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, <span class="stringliteral">&quot;universal_newline&quot;</span>);
<a name="l02014"></a>02014         }
<a name="l02015"></a>02015         <span class="keywordflow">if</span> (ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a38b80a28fd1ac8423761193a71d7752c">ECONV_CRLF_NEWLINE_DECORATOR</a>) {
<a name="l02016"></a>02016             <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, pre); pre = <span class="stringliteral">&quot;,&quot;</span>;
<a name="l02017"></a>02017             <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, <span class="stringliteral">&quot;crlf_newline&quot;</span>);
<a name="l02018"></a>02018         }
<a name="l02019"></a>02019         <span class="keywordflow">if</span> (ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a64019d94f530b33a149a2016278cc940">ECONV_CR_NEWLINE_DECORATOR</a>) {
<a name="l02020"></a>02020             <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, pre); pre = <span class="stringliteral">&quot;,&quot;</span>;
<a name="l02021"></a>02021             <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, <span class="stringliteral">&quot;cr_newline&quot;</span>);
<a name="l02022"></a>02022         }
<a name="l02023"></a>02023         <span class="keywordflow">if</span> (ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a5477824dfc0b7b9f38411f309610fe69">ECONV_XML_TEXT_DECORATOR</a>) {
<a name="l02024"></a>02024             <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, pre); pre = <span class="stringliteral">&quot;,&quot;</span>;
<a name="l02025"></a>02025             <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, <span class="stringliteral">&quot;xml_text&quot;</span>);
<a name="l02026"></a>02026         }
<a name="l02027"></a>02027         <span class="keywordflow">if</span> (ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a30366abfd546975d8e5c945289afb9a2">ECONV_XML_ATTR_CONTENT_DECORATOR</a>) {
<a name="l02028"></a>02028             <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, pre); pre = <span class="stringliteral">&quot;,&quot;</span>;
<a name="l02029"></a>02029             <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, <span class="stringliteral">&quot;xml_attr_content&quot;</span>);
<a name="l02030"></a>02030         }
<a name="l02031"></a>02031         <span class="keywordflow">if</span> (ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a01a2578ca9179596c418d8ad3ce946d5">ECONV_XML_ATTR_QUOTE_DECORATOR</a>) {
<a name="l02032"></a>02032             <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, pre); pre = <span class="stringliteral">&quot;,&quot;</span>;
<a name="l02033"></a>02033             <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, <span class="stringliteral">&quot;xml_attr_quote&quot;</span>);
<a name="l02034"></a>02034         }
<a name="l02035"></a>02035         has_description = 1;
<a name="l02036"></a>02036     }
<a name="l02037"></a>02037     <span class="keywordflow">if</span> (!has_description) {
<a name="l02038"></a>02038         <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, <span class="stringliteral">&quot;no-conversion&quot;</span>);
<a name="l02039"></a>02039     }
<a name="l02040"></a>02040 
<a name="l02041"></a>02041     <span class="keywordflow">return</span> mesg;
<a name="l02042"></a>02042 }
<a name="l02043"></a>02043 
<a name="l02044"></a>02044 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02045"></a><a class="code" href="../../d3/d26/transcode_8c.html#a188439436c212750af4e6bb99b6598ff">02045</a> <a class="code" href="../../d5/de3/encoding_8h.html#a0dbeff3af14fde49b20f00fde25057d0">rb_econv_open_exc</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sname, <span class="keyword">const</span> <span class="keywordtype">char</span> *dname, <span class="keywordtype">int</span> ecflags)
<a name="l02046"></a>02046 {
<a name="l02047"></a>02047     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> mesg, exc;
<a name="l02048"></a>02048     mesg = <a class="code" href="../../db/d2e/intern_8h.html#a2b9cc485b0aa1dc270744b8b9eb47569">rb_str_new_cstr</a>(<span class="stringliteral">&quot;code converter not found (&quot;</span>);
<a name="l02049"></a>02049     <a class="code" href="../../d3/d26/transcode_8c.html#a436d11a6e0b079d3b976298fde60d85d">econv_description</a>(sname, dname, ecflags, mesg);
<a name="l02050"></a>02050     <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(mesg, <span class="stringliteral">&quot;)&quot;</span>);
<a name="l02051"></a>02051     exc = <a class="code" href="../../db/dcc/error_8c.html#a4989eeb5742cad6359a2ed77859674de">rb_exc_new3</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a17f7c97579ac483f021702f0a8f190ec">rb_eConverterNotFoundError</a>, mesg);
<a name="l02052"></a>02052     <span class="keywordflow">return</span> exc;
<a name="l02053"></a>02053 }
<a name="l02054"></a>02054 
<a name="l02055"></a>02055 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02056"></a><a class="code" href="../../d3/d26/transcode_8c.html#a7d3e537e8db90f4bf761b0c7f04f6ce4">02056</a> <a class="code" href="../../d3/d26/transcode_8c.html#a7d3e537e8db90f4bf761b0c7f04f6ce4">make_econv_exception</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec)
<a name="l02057"></a>02057 {
<a name="l02058"></a>02058     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> mesg, exc;
<a name="l02059"></a>02059     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9db5877b884b6345adb4bd2a0b65b70">result</a> == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad43244977ecc5d0f0cda6d003b1e37d1">econv_invalid_byte_sequence</a> ||
<a name="l02060"></a>02060         ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9db5877b884b6345adb4bd2a0b65b70">result</a> == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa42fe600023b5129588324a787ade662d">econv_incomplete_input</a>) {
<a name="l02061"></a>02061         <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a> = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#afa032001f9163782b3ffd3f7719c01b2">error_bytes_start</a>;
<a name="l02062"></a>02062         <span class="keywordtype">size_t</span> error_len = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a18f4b226842af7c0c379bf21646409af">error_bytes_len</a>;
<a name="l02063"></a>02063         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> bytes = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(err, error_len);
<a name="l02064"></a>02064         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> dumped = <a class="code" href="../../db/d2e/intern_8h.html#ab4fa4ec084128c2a79a73d1989210ea4">rb_str_dump</a>(bytes);
<a name="l02065"></a>02065         <span class="keywordtype">size_t</span> readagain_len = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a2eb533677cfc48e764a7940f034b1634">readagain_len</a>;
<a name="l02066"></a>02066         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> bytes2 = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02067"></a>02067         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> dumped2;
<a name="l02068"></a>02068         <span class="keywordtype">int</span> idx;
<a name="l02069"></a>02069         <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9db5877b884b6345adb4bd2a0b65b70">result</a> == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa42fe600023b5129588324a787ade662d">econv_incomplete_input</a>) {
<a name="l02070"></a>02070             mesg = <a class="code" href="../../d9/d2d/sprintf_8c.html#a05c34a91ab36c6a463c861df47808fae">rb_sprintf</a>(<span class="stringliteral">&quot;incomplete %s on %s&quot;</span>,
<a name="l02071"></a>02071                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(dumped),
<a name="l02072"></a>02072                     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>);
<a name="l02073"></a>02073         }
<a name="l02074"></a>02074         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (readagain_len) {
<a name="l02075"></a>02075             bytes2 = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(err+error_len, readagain_len);
<a name="l02076"></a>02076             dumped2 = <a class="code" href="../../db/d2e/intern_8h.html#ab4fa4ec084128c2a79a73d1989210ea4">rb_str_dump</a>(bytes2);
<a name="l02077"></a>02077             mesg = <a class="code" href="../../d9/d2d/sprintf_8c.html#a05c34a91ab36c6a463c861df47808fae">rb_sprintf</a>(<span class="stringliteral">&quot;%s followed by %s on %s&quot;</span>,
<a name="l02078"></a>02078                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(dumped),
<a name="l02079"></a>02079                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(dumped2),
<a name="l02080"></a>02080                     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>);
<a name="l02081"></a>02081         }
<a name="l02082"></a>02082         <span class="keywordflow">else</span> {
<a name="l02083"></a>02083             mesg = <a class="code" href="../../d9/d2d/sprintf_8c.html#a05c34a91ab36c6a463c861df47808fae">rb_sprintf</a>(<span class="stringliteral">&quot;%s on %s&quot;</span>,
<a name="l02084"></a>02084                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(dumped),
<a name="l02085"></a>02085                     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>);
<a name="l02086"></a>02086         }
<a name="l02087"></a>02087 
<a name="l02088"></a>02088         exc = <a class="code" href="../../db/dcc/error_8c.html#a4989eeb5742cad6359a2ed77859674de">rb_exc_new3</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a03c8ae0d4551172220b5981e68539795">rb_eInvalidByteSequenceError</a>, mesg);
<a name="l02089"></a>02089         <a class="code" href="../../db/d2e/intern_8h.html#acee88ad0375c8a9080e2283db494d257">rb_ivar_set</a>(exc, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;error_bytes&quot;</span>), bytes);
<a name="l02090"></a>02090         <a class="code" href="../../db/d2e/intern_8h.html#acee88ad0375c8a9080e2283db494d257">rb_ivar_set</a>(exc, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;readagain_bytes&quot;</span>), bytes2);
<a name="l02091"></a>02091         <a class="code" href="../../db/d2e/intern_8h.html#acee88ad0375c8a9080e2283db494d257">rb_ivar_set</a>(exc, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;incomplete_input&quot;</span>), ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9db5877b884b6345adb4bd2a0b65b70">result</a> == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa42fe600023b5129588324a787ade662d">econv_incomplete_input</a> ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a> : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>);
<a name="l02092"></a>02092 
<a name="l02093"></a>02093       set_encs:
<a name="l02094"></a>02094         <a class="code" href="../../db/d2e/intern_8h.html#acee88ad0375c8a9080e2283db494d257">rb_ivar_set</a>(exc, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;source_encoding_name&quot;</span>), <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>));
<a name="l02095"></a>02095         <a class="code" href="../../db/d2e/intern_8h.html#acee88ad0375c8a9080e2283db494d257">rb_ivar_set</a>(exc, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;destination_encoding_name&quot;</span>), <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a>));
<a name="l02096"></a>02096         idx = <a class="code" href="../../d5/db5/encoding_8c.html#adeb5f5b97ea43528a55d717add8f64c5">rb_enc_find_index</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>);
<a name="l02097"></a>02097         <span class="keywordflow">if</span> (0 &lt;= idx)
<a name="l02098"></a>02098             <a class="code" href="../../db/d2e/intern_8h.html#acee88ad0375c8a9080e2283db494d257">rb_ivar_set</a>(exc, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;source_encoding&quot;</span>), <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(<a class="code" href="../../d5/db5/encoding_8c.html#aef9c377b2d9d78b9f88e890b77593109">rb_enc_from_index</a>(idx)));
<a name="l02099"></a>02099         idx = <a class="code" href="../../d5/db5/encoding_8c.html#adeb5f5b97ea43528a55d717add8f64c5">rb_enc_find_index</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a>);
<a name="l02100"></a>02100         <span class="keywordflow">if</span> (0 &lt;= idx)
<a name="l02101"></a>02101             <a class="code" href="../../db/d2e/intern_8h.html#acee88ad0375c8a9080e2283db494d257">rb_ivar_set</a>(exc, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;destination_encoding&quot;</span>), <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(<a class="code" href="../../d5/db5/encoding_8c.html#aef9c377b2d9d78b9f88e890b77593109">rb_enc_from_index</a>(idx)));
<a name="l02102"></a>02102         <span class="keywordflow">return</span> exc;
<a name="l02103"></a>02103     }
<a name="l02104"></a>02104     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9db5877b884b6345adb4bd2a0b65b70">result</a> == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7e59e5dc4cb8b9db559a803ee88aec57">econv_undefined_conversion</a>) {
<a name="l02105"></a>02105         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> bytes = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *)ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#afa032001f9163782b3ffd3f7719c01b2">error_bytes_start</a>,
<a name="l02106"></a>02106                                  ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a18f4b226842af7c0c379bf21646409af">error_bytes_len</a>);
<a name="l02107"></a>02107         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> dumped = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02108"></a>02108         <span class="keywordtype">int</span> idx;
<a name="l02109"></a>02109         <span class="keywordflow">if</span> (strcmp(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>, <span class="stringliteral">&quot;UTF-8&quot;</span>) == 0) {
<a name="l02110"></a>02110             <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *utf8 = <a class="code" href="../../d5/db5/encoding_8c.html#a893004271cf8c790ca40c4712261aa8c">rb_utf8_encoding</a>();
<a name="l02111"></a>02111             <span class="keyword">const</span> <span class="keywordtype">char</span> *start, *end;
<a name="l02112"></a>02112             <span class="keywordtype">int</span> n;
<a name="l02113"></a>02113             start = (<span class="keyword">const</span> <span class="keywordtype">char</span> *)ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#afa032001f9163782b3ffd3f7719c01b2">error_bytes_start</a>;
<a name="l02114"></a>02114             end = start + ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a18f4b226842af7c0c379bf21646409af">error_bytes_len</a>;
<a name="l02115"></a>02115             n = <a class="code" href="../../d5/db5/encoding_8c.html#a0c6003b6aeaed218d841974b00c95870">rb_enc_precise_mbclen</a>(start, end, utf8);
<a name="l02116"></a>02116             <span class="keywordflow">if</span> (<a class="code" href="../../d5/de3/encoding_8h.html#ac3dcc15c5ed42d6590e1c1f91b74165c">MBCLEN_CHARFOUND_P</a>(n) &amp;&amp;
<a name="l02117"></a>02117                 (size_t)<a class="code" href="../../d5/de3/encoding_8h.html#a877f84ae22293dae2a8cf1e26ea5b1a6">MBCLEN_CHARFOUND_LEN</a>(n) == ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a18f4b226842af7c0c379bf21646409af">error_bytes_len</a>) {
<a name="l02118"></a>02118                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cc = <a class="code" href="../../d5/de3/encoding_8h.html#a7f8372dd0ada95131f8a22a4d8759d39">rb_enc_mbc_to_codepoint</a>(start, end, utf8);
<a name="l02119"></a>02119                 dumped = <a class="code" href="../../d9/d2d/sprintf_8c.html#a05c34a91ab36c6a463c861df47808fae">rb_sprintf</a>(<span class="stringliteral">&quot;U+%04X&quot;</span>, cc);
<a name="l02120"></a>02120             }
<a name="l02121"></a>02121         }
<a name="l02122"></a>02122         <span class="keywordflow">if</span> (dumped == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>)
<a name="l02123"></a>02123             dumped = <a class="code" href="../../db/d2e/intern_8h.html#ab4fa4ec084128c2a79a73d1989210ea4">rb_str_dump</a>(bytes);
<a name="l02124"></a>02124         <span class="keywordflow">if</span> (strcmp(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>,
<a name="l02125"></a>02125                    ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a22bbe71170a0fbfce6b1ac29c7677f4c">source_encoding_name</a>) == 0 &amp;&amp;
<a name="l02126"></a>02126             strcmp(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a>,
<a name="l02127"></a>02127                    ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afd32fa6d348fa4997c2ec5dde2001c79">destination_encoding_name</a>) == 0) {
<a name="l02128"></a>02128             mesg = <a class="code" href="../../d9/d2d/sprintf_8c.html#a05c34a91ab36c6a463c861df47808fae">rb_sprintf</a>(<span class="stringliteral">&quot;%s from %s to %s&quot;</span>,
<a name="l02129"></a>02129                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(dumped),
<a name="l02130"></a>02130                     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>,
<a name="l02131"></a>02131                     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a>);
<a name="l02132"></a>02132         }
<a name="l02133"></a>02133         <span class="keywordflow">else</span> {
<a name="l02134"></a>02134             <span class="keywordtype">int</span> i;
<a name="l02135"></a>02135             mesg = <a class="code" href="../../d9/d2d/sprintf_8c.html#a05c34a91ab36c6a463c861df47808fae">rb_sprintf</a>(<span class="stringliteral">&quot;%s to %s in conversion from %s&quot;</span>,
<a name="l02136"></a>02136                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(dumped),
<a name="l02137"></a>02137                     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a>,
<a name="l02138"></a>02138                     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a22bbe71170a0fbfce6b1ac29c7677f4c">source_encoding_name</a>);
<a name="l02139"></a>02139             <span class="keywordflow">for</span> (i = 0; i &lt; ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>; i++) {
<a name="l02140"></a>02140                 <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a> = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>;
<a name="l02141"></a>02141                 <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d26/transcode_8c.html#a7a9d71f951b9b292988b798f4f6bc29b">DECORATOR_P</a>(tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a6f79077ecbd8da45cc181b53dc280a90">src_encoding</a>, tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a06f17fbc59c9055646b1a147d05f33eb">dst_encoding</a>))
<a name="l02142"></a>02142                     <a class="code" href="../../d9/d2d/sprintf_8c.html#a01a3022a41f713613342bbaba9ac9359">rb_str_catf</a>(mesg, <span class="stringliteral">&quot; to %s&quot;</span>,
<a name="l02143"></a>02143                                 ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a06f17fbc59c9055646b1a147d05f33eb">dst_encoding</a>);
<a name="l02144"></a>02144             }
<a name="l02145"></a>02145         }
<a name="l02146"></a>02146         exc = <a class="code" href="../../db/dcc/error_8c.html#a4989eeb5742cad6359a2ed77859674de">rb_exc_new3</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a7e3c5b7bbf0d72e13a75254e8ab972ee">rb_eUndefinedConversionError</a>, mesg);
<a name="l02147"></a>02147         idx = <a class="code" href="../../d5/db5/encoding_8c.html#adeb5f5b97ea43528a55d717add8f64c5">rb_enc_find_index</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>);
<a name="l02148"></a>02148         <span class="keywordflow">if</span> (0 &lt;= idx)
<a name="l02149"></a>02149             <a class="code" href="../../d5/db5/encoding_8c.html#ad5df62bd02b6d06037baef7ad68bcae3">rb_enc_associate_index</a>(bytes, idx);
<a name="l02150"></a>02150         <a class="code" href="../../db/d2e/intern_8h.html#acee88ad0375c8a9080e2283db494d257">rb_ivar_set</a>(exc, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;error_char&quot;</span>), bytes);
<a name="l02151"></a>02151         <span class="keywordflow">goto</span> set_encs;
<a name="l02152"></a>02152     }
<a name="l02153"></a>02153     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02154"></a>02154 }
<a name="l02155"></a>02155 
<a name="l02156"></a>02156 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02157"></a><a class="code" href="../../d3/d26/transcode_8c.html#af31fc9596c4ae387e99fd08786ddff4c">02157</a> <a class="code" href="../../d3/d26/transcode_8c.html#af31fc9596c4ae387e99fd08786ddff4c">more_output_buffer</a>(
<a name="l02158"></a>02158         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> destination,
<a name="l02159"></a>02159         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *(*resize_destination)(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>, <span class="keywordtype">size_t</span>, <span class="keywordtype">size_t</span>),
<a name="l02160"></a>02160         <span class="keywordtype">int</span> max_output,
<a name="l02161"></a>02161         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **out_start_ptr,
<a name="l02162"></a>02162         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **out_pos,
<a name="l02163"></a>02163         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **out_stop_ptr)
<a name="l02164"></a>02164 {
<a name="l02165"></a>02165     <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a> = (*out_pos - *out_start_ptr);
<a name="l02166"></a>02166     <span class="keywordtype">size_t</span> new_len = (len + max_output) * 2;
<a name="l02167"></a>02167     *out_start_ptr = resize_destination(destination, len, new_len);
<a name="l02168"></a>02168     *out_pos = *out_start_ptr + len;
<a name="l02169"></a>02169     *out_stop_ptr = *out_start_ptr + new_len;
<a name="l02170"></a>02170 }
<a name="l02171"></a>02171 
<a name="l02172"></a>02172 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02173"></a><a class="code" href="../../d3/d26/transcode_8c.html#a5412744bd0af6ca95571989d436dc76d">02173</a> <a class="code" href="../../d3/d26/transcode_8c.html#a5412744bd0af6ca95571989d436dc76d">make_replacement</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec)
<a name="l02174"></a>02174 {
<a name="l02175"></a>02175     <a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *tc;
<a name="l02176"></a>02176     <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a>;
<a name="l02177"></a>02177     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc;
<a name="l02178"></a>02178     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *replacement;
<a name="l02179"></a>02179     <span class="keyword">const</span> <span class="keywordtype">char</span> *repl_enc;
<a name="l02180"></a>02180     <span class="keyword">const</span> <span class="keywordtype">char</span> *ins_enc;
<a name="l02181"></a>02181     <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l02182"></a>02182 
<a name="l02183"></a>02183     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9ef89b6cd3baa02b8ec83f49a2d3a2b">replacement_str</a>)
<a name="l02184"></a>02184         <span class="keywordflow">return</span> 0;
<a name="l02185"></a>02185 
<a name="l02186"></a>02186     ins_enc = <a class="code" href="../../d5/de3/encoding_8h.html#afed8d708b68f78b68ca62c51b56f0cf0">rb_econv_encoding_to_insert_output</a>(ec);
<a name="l02187"></a>02187 
<a name="l02188"></a>02188     tc = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#acb260f341ee3fbd97d43a8b5f2c067bd">last_tc</a>;
<a name="l02189"></a>02189     <span class="keywordflow">if</span> (*ins_enc) {
<a name="l02190"></a>02190         tr = tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>;
<a name="l02191"></a>02191         enc = <a class="code" href="../../d5/db5/encoding_8c.html#a67638c695b4079ca5f4b6b4cc22ab27a">rb_enc_find</a>(tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a06f17fbc59c9055646b1a147d05f33eb">dst_encoding</a>);
<a name="l02192"></a>02192         replacement = (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d3/d26/transcode_8c.html#aebe9fe767e9e0f22d52acc50b080a444">get_replacement_character</a>(ins_enc, &amp;len, &amp;repl_enc);
<a name="l02193"></a>02193     }
<a name="l02194"></a>02194     <span class="keywordflow">else</span> {
<a name="l02195"></a>02195         replacement = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<span class="stringliteral">&quot;?&quot;</span>;
<a name="l02196"></a>02196         len = 1;
<a name="l02197"></a>02197         repl_enc = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02198"></a>02198     }
<a name="l02199"></a>02199 
<a name="l02200"></a>02200     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9ef89b6cd3baa02b8ec83f49a2d3a2b">replacement_str</a> = replacement;
<a name="l02201"></a>02201     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a40e67fdbe80e48a19ecfeaa9358fd4c2">replacement_len</a> = len;
<a name="l02202"></a>02202     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a875d42c5055651a75e9172e89a53c7c8">replacement_enc</a> = repl_enc;
<a name="l02203"></a>02203     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab257a4ed6f3ca457a32ee1304af2c038">replacement_allocated</a> = 0;
<a name="l02204"></a>02204     <span class="keywordflow">return</span> 0;
<a name="l02205"></a>02205 }
<a name="l02206"></a>02206 
<a name="l02207"></a>02207 <span class="keywordtype">int</span>
<a name="l02208"></a><a class="code" href="../../d3/d26/transcode_8c.html#af50df105139f4ecc899dea17f3a4bb1b">02208</a> <a class="code" href="../../d5/de3/encoding_8h.html#af50df105139f4ecc899dea17f3a4bb1b">rb_econv_set_replacement</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec,
<a name="l02209"></a>02209     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *str, <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *encname)
<a name="l02210"></a>02210 {
<a name="l02211"></a>02211     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *str2;
<a name="l02212"></a>02212     <span class="keywordtype">size_t</span> len2;
<a name="l02213"></a>02213     <span class="keyword">const</span> <span class="keywordtype">char</span> *encname2;
<a name="l02214"></a>02214 
<a name="l02215"></a>02215     encname2 = <a class="code" href="../../d5/de3/encoding_8h.html#afed8d708b68f78b68ca62c51b56f0cf0">rb_econv_encoding_to_insert_output</a>(ec);
<a name="l02216"></a>02216 
<a name="l02217"></a>02217     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#adc12ab3195f23d65f243fe172370e950">encoding_equal</a>(encname, encname2)) {
<a name="l02218"></a>02218         str2 = <a class="code" href="../../d8/db0/defines_8h.html#a6af5faec3f9662b20ffc9903f923dec0">xmalloc</a>(len);
<a name="l02219"></a>02219         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a04ab67335215e8362c63ed27ae2d1c40">MEMCPY</a>(str2, str, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>, len); <span class="comment">/* xxx: str may be invalid */</span>
<a name="l02220"></a>02220         len2 = len;
<a name="l02221"></a>02221         encname2 = encname;
<a name="l02222"></a>02222     }
<a name="l02223"></a>02223     <span class="keywordflow">else</span> {
<a name="l02224"></a>02224         str2 = <a class="code" href="../../d3/d26/transcode_8c.html#a0fc07e0e3b60bf263ead254b4245a56b">allocate_converted_string</a>(encname, encname2, str, len, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0, &amp;len2);
<a name="l02225"></a>02225         <span class="keywordflow">if</span> (!str2)
<a name="l02226"></a>02226             <span class="keywordflow">return</span> -1;
<a name="l02227"></a>02227     }
<a name="l02228"></a>02228 
<a name="l02229"></a>02229     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab257a4ed6f3ca457a32ee1304af2c038">replacement_allocated</a>) {
<a name="l02230"></a>02230         <a class="code" href="../../d8/db0/defines_8h.html#a2c3897f7c46ca54a2e0dd7b24a40c7cb">xfree</a>((<span class="keywordtype">void</span> *)ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9ef89b6cd3baa02b8ec83f49a2d3a2b">replacement_str</a>);
<a name="l02231"></a>02231     }
<a name="l02232"></a>02232     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab257a4ed6f3ca457a32ee1304af2c038">replacement_allocated</a> = 1;
<a name="l02233"></a>02233     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9ef89b6cd3baa02b8ec83f49a2d3a2b">replacement_str</a> = str2;
<a name="l02234"></a>02234     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a40e67fdbe80e48a19ecfeaa9358fd4c2">replacement_len</a> = len2;
<a name="l02235"></a>02235     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a875d42c5055651a75e9172e89a53c7c8">replacement_enc</a> = encname2;
<a name="l02236"></a>02236     <span class="keywordflow">return</span> 0;
<a name="l02237"></a>02237 }
<a name="l02238"></a>02238 
<a name="l02239"></a>02239 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02240"></a><a class="code" href="../../d3/d26/transcode_8c.html#a3e3f66ef2f6f9ea42db516d420825690">02240</a> <a class="code" href="../../d3/d26/transcode_8c.html#a3e3f66ef2f6f9ea42db516d420825690">output_replacement_character</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec)
<a name="l02241"></a>02241 {
<a name="l02242"></a>02242     <span class="keywordtype">int</span> ret;
<a name="l02243"></a>02243 
<a name="l02244"></a>02244     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#a5412744bd0af6ca95571989d436dc76d">make_replacement</a>(ec) == -1)
<a name="l02245"></a>02245         <span class="keywordflow">return</span> -1;
<a name="l02246"></a>02246 
<a name="l02247"></a>02247     ret = <a class="code" href="../../d5/de3/encoding_8h.html#a7c02ec315df0f70b167a76155cc97f1c">rb_econv_insert_output</a>(ec, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9ef89b6cd3baa02b8ec83f49a2d3a2b">replacement_str</a>, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a40e67fdbe80e48a19ecfeaa9358fd4c2">replacement_len</a>, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a875d42c5055651a75e9172e89a53c7c8">replacement_enc</a>);
<a name="l02248"></a>02248     <span class="keywordflow">if</span> (ret == -1)
<a name="l02249"></a>02249         <span class="keywordflow">return</span> -1;
<a name="l02250"></a>02250 
<a name="l02251"></a>02251     <span class="keywordflow">return</span> 0;
<a name="l02252"></a>02252 }
<a name="l02253"></a>02253 
<a name="l02254"></a>02254 <span class="preprocessor">#if 1</span>
<a name="l02255"></a><a class="code" href="../../d3/d26/transcode_8c.html#a0d9ac37f77e508cccf6ef460a6ed1a2c">02255</a> <span class="preprocessor"></span><span class="preprocessor">#define hash_fallback rb_hash_aref</span>
<a name="l02256"></a>02256 <span class="preprocessor"></span>
<a name="l02257"></a>02257 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02258"></a><a class="code" href="../../d3/d26/transcode_8c.html#a02af10a8d19188c8bbcb0cb46f712f9e">02258</a> <a class="code" href="../../d3/d26/transcode_8c.html#a02af10a8d19188c8bbcb0cb46f712f9e">proc_fallback</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> fallback, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> c)
<a name="l02259"></a>02259 {
<a name="l02260"></a>02260     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#ac83215f3f701e797bb43ac8cbaae1aae">rb_proc_call</a>(fallback, <a class="code" href="../../dc/dcc/array_8c.html#a575a99eebf6ce65893ed83c2b6783d2d">rb_ary_new4</a>(1, &amp;c));
<a name="l02261"></a>02261 }
<a name="l02262"></a>02262 
<a name="l02263"></a>02263 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02264"></a><a class="code" href="../../d3/d26/transcode_8c.html#a96b8a768e28f44e7588659329023f3f1">02264</a> <a class="code" href="../../d3/d26/transcode_8c.html#a96b8a768e28f44e7588659329023f3f1">method_fallback</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> fallback, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> c)
<a name="l02265"></a>02265 {
<a name="l02266"></a>02266     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a0c43557c40369d54f475f26fb34678fb">rb_method_call</a>(1, &amp;c, fallback);
<a name="l02267"></a>02267 }
<a name="l02268"></a>02268 
<a name="l02269"></a>02269 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02270"></a><a class="code" href="../../d3/d26/transcode_8c.html#a63c87c3922b1337ea7ff3bce7289bd65">02270</a> <a class="code" href="../../d3/d26/transcode_8c.html#a63c87c3922b1337ea7ff3bce7289bd65">aref_fallback</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> fallback, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> c)
<a name="l02271"></a>02271 {
<a name="l02272"></a>02272     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ae3d965c850380a1945152e5d1afa6d3c" title="Calls a method.">rb_funcall3</a>(fallback, <a class="code" href="../../d3/d26/transcode_8c.html#a000881fcf4572b2a9a3216b3aeae05dc">sym_aref</a>, 1, &amp;c);
<a name="l02273"></a>02273 }
<a name="l02274"></a>02274 
<a name="l02275"></a>02275 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02276"></a><a class="code" href="../../d3/d26/transcode_8c.html#a88ec34ea3ca349bdc405a42e036822bf">02276</a> <a class="code" href="../../d3/d26/transcode_8c.html#a88ec34ea3ca349bdc405a42e036822bf">transcode_loop</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **in_pos, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **out_pos,
<a name="l02277"></a>02277                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in_stop, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out_stop,
<a name="l02278"></a>02278                <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> destination,
<a name="l02279"></a>02279                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *(*resize_destination)(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>, <span class="keywordtype">size_t</span>, <span class="keywordtype">size_t</span>),
<a name="l02280"></a>02280                <span class="keyword">const</span> <span class="keywordtype">char</span> *src_encoding,
<a name="l02281"></a>02281                <span class="keyword">const</span> <span class="keywordtype">char</span> *dst_encoding,
<a name="l02282"></a>02282                <span class="keywordtype">int</span> ecflags,
<a name="l02283"></a>02283                <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ecopts)
<a name="l02284"></a>02284 {
<a name="l02285"></a>02285     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec;
<a name="l02286"></a>02286     <a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *last_tc;
<a name="l02287"></a>02287     <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a> ret;
<a name="l02288"></a>02288     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out_start = *out_pos;
<a name="l02289"></a>02289     <span class="keywordtype">int</span> max_output;
<a name="l02290"></a>02290     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> exc;
<a name="l02291"></a>02291     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> fallback = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02292"></a>02292     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> (*fallback_func)(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>) = 0;
<a name="l02293"></a>02293 
<a name="l02294"></a>02294     ec = <a class="code" href="../../d5/de3/encoding_8h.html#ac48226d977525efbbf4ed18ff36fce23">rb_econv_open_opts</a>(src_encoding, dst_encoding, ecflags, ecopts);
<a name="l02295"></a>02295     <span class="keywordflow">if</span> (!ec)
<a name="l02296"></a>02296         <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a0dbeff3af14fde49b20f00fde25057d0">rb_econv_open_exc</a>(src_encoding, dst_encoding, ecflags));
<a name="l02297"></a>02297 
<a name="l02298"></a>02298     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(ecopts) &amp;&amp; <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(ecopts) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8357e81bbb60cb41b0a292a90653a5e5">T_HASH</a>) {
<a name="l02299"></a>02299         fallback = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(ecopts, <a class="code" href="../../d3/d26/transcode_8c.html#a338cb4cb4bd7d8994da411e0b1bfbb21">sym_fallback</a>);
<a name="l02300"></a>02300         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac4f895997656c2abd27a29a8b8e982ca">RB_TYPE_P</a>(fallback, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8357e81bbb60cb41b0a292a90653a5e5">T_HASH</a>)) {
<a name="l02301"></a>02301             fallback_func = <a class="code" href="../../d3/d26/transcode_8c.html#a0d9ac37f77e508cccf6ef460a6ed1a2c">hash_fallback</a>;
<a name="l02302"></a>02302         }
<a name="l02303"></a>02303         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#a465568c66f9f2f257916e3a2f7f14aae">rb_obj_is_proc</a>(fallback)) {
<a name="l02304"></a>02304             fallback_func = <a class="code" href="../../d3/d26/transcode_8c.html#a02af10a8d19188c8bbcb0cb46f712f9e">proc_fallback</a>;
<a name="l02305"></a>02305         }
<a name="l02306"></a>02306         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#a42d20e898f60dacf8c07fac18922a0de">rb_obj_is_method</a>(fallback)) {
<a name="l02307"></a>02307             fallback_func = <a class="code" href="../../d3/d26/transcode_8c.html#a96b8a768e28f44e7588659329023f3f1">method_fallback</a>;
<a name="l02308"></a>02308         }
<a name="l02309"></a>02309         <span class="keywordflow">else</span> {
<a name="l02310"></a>02310             fallback_func = <a class="code" href="../../d3/d26/transcode_8c.html#a63c87c3922b1337ea7ff3bce7289bd65">aref_fallback</a>;
<a name="l02311"></a>02311         }
<a name="l02312"></a>02312     }
<a name="l02313"></a>02313     last_tc = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#acb260f341ee3fbd97d43a8b5f2c067bd">last_tc</a>;
<a name="l02314"></a>02314     max_output = last_tc ? last_tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a85dad54f3fff0861b37d422e69ebb8ab">max_output</a> : 1;
<a name="l02315"></a>02315 
<a name="l02316"></a>02316   resume:
<a name="l02317"></a>02317     ret = <a class="code" href="../../d5/de3/encoding_8h.html#a346451a419b3ce73da0d2323eb3238ee">rb_econv_convert</a>(ec, in_pos, in_stop, out_pos, out_stop, 0);
<a name="l02318"></a>02318 
<a name="l02319"></a>02319     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(fallback) &amp;&amp; ret == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7e59e5dc4cb8b9db559a803ee88aec57">econv_undefined_conversion</a>) {
<a name="l02320"></a>02320         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> rep = <a class="code" href="../../d5/de3/encoding_8h.html#a6707b730597e0e614213beb11670aca2">rb_enc_str_new</a>(
<a name="l02321"></a>02321                 (<span class="keyword">const</span> <span class="keywordtype">char</span> *)ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#afa032001f9163782b3ffd3f7719c01b2">error_bytes_start</a>,
<a name="l02322"></a>02322                 ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a18f4b226842af7c0c379bf21646409af">error_bytes_len</a>,
<a name="l02323"></a>02323                 <a class="code" href="../../d5/db5/encoding_8c.html#a67638c695b4079ca5f4b6b4cc22ab27a">rb_enc_find</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>));
<a name="l02324"></a>02324         rep = (*fallback_func)(fallback, rep);
<a name="l02325"></a>02325         <span class="keywordflow">if</span> (rep != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a> &amp;&amp; !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(rep)) {
<a name="l02326"></a>02326             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(rep);
<a name="l02327"></a>02327             ret = <a class="code" href="../../d5/de3/encoding_8h.html#a7c02ec315df0f70b167a76155cc97f1c">rb_econv_insert_output</a>(ec, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(rep),
<a name="l02328"></a>02328                     <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(rep), <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(<a class="code" href="../../d5/db5/encoding_8c.html#ac21ed764f3b39453b6a848dd64a19585">rb_enc_get</a>(rep)));
<a name="l02329"></a>02329             <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)ret == -1) {
<a name="l02330"></a>02330                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;too big fallback string&quot;</span>);
<a name="l02331"></a>02331             }
<a name="l02332"></a>02332             <span class="keywordflow">goto</span> resume;
<a name="l02333"></a>02333         }
<a name="l02334"></a>02334     }
<a name="l02335"></a>02335 
<a name="l02336"></a>02336     <span class="keywordflow">if</span> (ret == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad43244977ecc5d0f0cda6d003b1e37d1">econv_invalid_byte_sequence</a> ||
<a name="l02337"></a>02337         ret == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa42fe600023b5129588324a787ade662d">econv_incomplete_input</a> ||
<a name="l02338"></a>02338         ret == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7e59e5dc4cb8b9db559a803ee88aec57">econv_undefined_conversion</a>) {
<a name="l02339"></a>02339         exc = <a class="code" href="../../d3/d26/transcode_8c.html#a7d3e537e8db90f4bf761b0c7f04f6ce4">make_econv_exception</a>(ec);
<a name="l02340"></a>02340         <a class="code" href="../../d5/de3/encoding_8h.html#adaf53306799f8796d7e6437bc98d0b0e">rb_econv_close</a>(ec);
<a name="l02341"></a>02341         <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(exc);
<a name="l02342"></a>02342     }
<a name="l02343"></a>02343 
<a name="l02344"></a>02344     <span class="keywordflow">if</span> (ret == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a>) {
<a name="l02345"></a>02345         <a class="code" href="../../d3/d26/transcode_8c.html#af31fc9596c4ae387e99fd08786ddff4c">more_output_buffer</a>(destination, resize_destination, max_output, &amp;out_start, out_pos, &amp;out_stop);
<a name="l02346"></a>02346         <span class="keywordflow">goto</span> resume;
<a name="l02347"></a>02347     }
<a name="l02348"></a>02348 
<a name="l02349"></a>02349     <a class="code" href="../../d5/de3/encoding_8h.html#adaf53306799f8796d7e6437bc98d0b0e">rb_econv_close</a>(ec);
<a name="l02350"></a>02350     <span class="keywordflow">return</span>;
<a name="l02351"></a>02351 }
<a name="l02352"></a>02352 <span class="preprocessor">#else</span>
<a name="l02353"></a>02353 <span class="preprocessor"></span><span class="comment">/* sample transcode_loop implementation in byte-by-byte stream style */</span>
<a name="l02354"></a>02354 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02355"></a>02355 <a class="code" href="../../d3/d26/transcode_8c.html#a88ec34ea3ca349bdc405a42e036822bf">transcode_loop</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **in_pos, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **out_pos,
<a name="l02356"></a>02356                <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *in_stop, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out_stop,
<a name="l02357"></a>02357                <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> destination,
<a name="l02358"></a>02358                <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *(*resize_destination)(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>, <span class="keywordtype">size_t</span>, <span class="keywordtype">size_t</span>),
<a name="l02359"></a>02359                <span class="keyword">const</span> <span class="keywordtype">char</span> *src_encoding,
<a name="l02360"></a>02360                <span class="keyword">const</span> <span class="keywordtype">char</span> *dst_encoding,
<a name="l02361"></a>02361                <span class="keywordtype">int</span> ecflags,
<a name="l02362"></a>02362                <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ecopts)
<a name="l02363"></a>02363 {
<a name="l02364"></a>02364     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec;
<a name="l02365"></a>02365     <a class="code" href="../../de/d43/structrb__transcoding.html">rb_transcoding</a> *last_tc;
<a name="l02366"></a>02366     <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a> ret;
<a name="l02367"></a>02367     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *out_start = *out_pos;
<a name="l02368"></a>02368     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ptr;
<a name="l02369"></a>02369     <span class="keywordtype">int</span> max_output;
<a name="l02370"></a>02370     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> exc;
<a name="l02371"></a>02371 
<a name="l02372"></a>02372     ec = <a class="code" href="../../d5/de3/encoding_8h.html#ac48226d977525efbbf4ed18ff36fce23">rb_econv_open_opts</a>(src_encoding, dst_encoding, ecflags, ecopts);
<a name="l02373"></a>02373     <span class="keywordflow">if</span> (!ec)
<a name="l02374"></a>02374         <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a0dbeff3af14fde49b20f00fde25057d0">rb_econv_open_exc</a>(src_encoding, dst_encoding, ecflags));
<a name="l02375"></a>02375 
<a name="l02376"></a>02376     last_tc = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#acb260f341ee3fbd97d43a8b5f2c067bd">last_tc</a>;
<a name="l02377"></a>02377     max_output = last_tc ? last_tc-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a85dad54f3fff0861b37d422e69ebb8ab">max_output</a> : 1;
<a name="l02378"></a>02378 
<a name="l02379"></a>02379     ret = <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>;
<a name="l02380"></a>02380     ptr = *in_pos;
<a name="l02381"></a>02381     <span class="keywordflow">while</span> (ret != <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa50dc17a7e8399ca9dcd98a7b6e652764">econv_finished</a>) {
<a name="l02382"></a>02382         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> input_byte;
<a name="l02383"></a>02383         <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *p = &amp;input_byte;
<a name="l02384"></a>02384 
<a name="l02385"></a>02385         <span class="keywordflow">if</span> (ret == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>) {
<a name="l02386"></a>02386             <span class="keywordflow">if</span> (ptr &lt; in_stop) {
<a name="l02387"></a>02387                 input_byte = *ptr;
<a name="l02388"></a>02388                 ret = <a class="code" href="../../d5/de3/encoding_8h.html#a346451a419b3ce73da0d2323eb3238ee">rb_econv_convert</a>(ec, &amp;p, p+1, out_pos, out_stop, <a class="code" href="../../d5/de3/encoding_8h.html#ab1eeed22e1b00841e21fa4715df0029e">ECONV_PARTIAL_INPUT</a>);
<a name="l02389"></a>02389             }
<a name="l02390"></a>02390             <span class="keywordflow">else</span> {
<a name="l02391"></a>02391                 ret = <a class="code" href="../../d5/de3/encoding_8h.html#a346451a419b3ce73da0d2323eb3238ee">rb_econv_convert</a>(ec, NULL, NULL, out_pos, out_stop, 0);
<a name="l02392"></a>02392             }
<a name="l02393"></a>02393         }
<a name="l02394"></a>02394         <span class="keywordflow">else</span> {
<a name="l02395"></a>02395             ret = <a class="code" href="../../d5/de3/encoding_8h.html#a346451a419b3ce73da0d2323eb3238ee">rb_econv_convert</a>(ec, NULL, NULL, out_pos, out_stop, <a class="code" href="../../d5/de3/encoding_8h.html#ab1eeed22e1b00841e21fa4715df0029e">ECONV_PARTIAL_INPUT</a>);
<a name="l02396"></a>02396         }
<a name="l02397"></a>02397         <span class="keywordflow">if</span> (&amp;input_byte != p)
<a name="l02398"></a>02398             ptr += p - &amp;input_byte;
<a name="l02399"></a>02399         <span class="keywordflow">switch</span> (ret) {
<a name="l02400"></a>02400           <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad43244977ecc5d0f0cda6d003b1e37d1">econv_invalid_byte_sequence</a>:
<a name="l02401"></a>02401           <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa42fe600023b5129588324a787ade662d">econv_incomplete_input</a>:
<a name="l02402"></a>02402           <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7e59e5dc4cb8b9db559a803ee88aec57">econv_undefined_conversion</a>:
<a name="l02403"></a>02403             exc = <a class="code" href="../../d3/d26/transcode_8c.html#a7d3e537e8db90f4bf761b0c7f04f6ce4">make_econv_exception</a>(ec);
<a name="l02404"></a>02404             <a class="code" href="../../d5/de3/encoding_8h.html#adaf53306799f8796d7e6437bc98d0b0e">rb_econv_close</a>(ec);
<a name="l02405"></a>02405             <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(exc);
<a name="l02406"></a>02406             <span class="keywordflow">break</span>;
<a name="l02407"></a>02407 
<a name="l02408"></a>02408           <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a>:
<a name="l02409"></a>02409             <a class="code" href="../../d3/d26/transcode_8c.html#af31fc9596c4ae387e99fd08786ddff4c">more_output_buffer</a>(destination, resize_destination, max_output, &amp;out_start, out_pos, &amp;out_stop);
<a name="l02410"></a>02410             <span class="keywordflow">break</span>;
<a name="l02411"></a>02411 
<a name="l02412"></a>02412           <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>:
<a name="l02413"></a>02413             <span class="keywordflow">break</span>;
<a name="l02414"></a>02414 
<a name="l02415"></a>02415           <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa50dc17a7e8399ca9dcd98a7b6e652764">econv_finished</a>:
<a name="l02416"></a>02416             <span class="keywordflow">break</span>;
<a name="l02417"></a>02417         }
<a name="l02418"></a>02418     }
<a name="l02419"></a>02419     <a class="code" href="../../d5/de3/encoding_8h.html#adaf53306799f8796d7e6437bc98d0b0e">rb_econv_close</a>(ec);
<a name="l02420"></a>02420     *in_pos = in_stop;
<a name="l02421"></a>02421     <span class="keywordflow">return</span>;
<a name="l02422"></a>02422 }
<a name="l02423"></a>02423 <span class="preprocessor">#endif</span>
<a name="l02424"></a>02424 <span class="preprocessor"></span>
<a name="l02425"></a>02425 
<a name="l02426"></a>02426 <span class="comment">/*</span>
<a name="l02427"></a>02427 <span class="comment"> *  String-specific code</span>
<a name="l02428"></a>02428 <span class="comment"> */</span>
<a name="l02429"></a>02429 
<a name="l02430"></a>02430 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *
<a name="l02431"></a><a class="code" href="../../d3/d26/transcode_8c.html#aaf47cc68cab7e9411ee95758e5a7101c">02431</a> <a class="code" href="../../d3/d26/transcode_8c.html#aaf47cc68cab7e9411ee95758e5a7101c">str_transcoding_resize</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> destination, <span class="keywordtype">size_t</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>, <span class="keywordtype">size_t</span> new_len)
<a name="l02432"></a>02432 {
<a name="l02433"></a>02433     <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(destination, new_len);
<a name="l02434"></a>02434     <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(destination);
<a name="l02435"></a>02435 }
<a name="l02436"></a>02436 
<a name="l02437"></a>02437 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02438"></a><a class="code" href="../../d3/d26/transcode_8c.html#abf10bc9c136130b2dbf5d229e8aacaee">02438</a> <a class="code" href="../../d3/d26/transcode_8c.html#abf10bc9c136130b2dbf5d229e8aacaee">econv_opts</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opt, <span class="keywordtype">int</span> ecflags)
<a name="l02439"></a>02439 {
<a name="l02440"></a>02440     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v;
<a name="l02441"></a>02441 
<a name="l02442"></a>02442     v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opt, <a class="code" href="../../d3/d26/transcode_8c.html#a386d27e7ebcb09b9e3beb9c1be41aabe">sym_invalid</a>);
<a name="l02443"></a>02443     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v)) {
<a name="l02444"></a>02444     }
<a name="l02445"></a>02445     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v==<a class="code" href="../../d3/d26/transcode_8c.html#ab15aaca5bc3b3652d2c7b243bec3c342">sym_replace</a>) {
<a name="l02446"></a>02446         ecflags |= <a class="code" href="../../d5/de3/encoding_8h.html#a6ebf7f037784cbfd05d0d7930532f796">ECONV_INVALID_REPLACE</a>;
<a name="l02447"></a>02447     }
<a name="l02448"></a>02448     <span class="keywordflow">else</span> {
<a name="l02449"></a>02449         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;unknown value for invalid character option&quot;</span>);
<a name="l02450"></a>02450     }
<a name="l02451"></a>02451 
<a name="l02452"></a>02452     v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opt, <a class="code" href="../../d3/d26/transcode_8c.html#ade065fa49e1a8a7c21017d79d31da9a7">sym_undef</a>);
<a name="l02453"></a>02453     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v)) {
<a name="l02454"></a>02454     }
<a name="l02455"></a>02455     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v==<a class="code" href="../../d3/d26/transcode_8c.html#ab15aaca5bc3b3652d2c7b243bec3c342">sym_replace</a>) {
<a name="l02456"></a>02456         ecflags |= <a class="code" href="../../d5/de3/encoding_8h.html#a4f8674ffeb3e7e562628f54ff0a10f4e">ECONV_UNDEF_REPLACE</a>;
<a name="l02457"></a>02457     }
<a name="l02458"></a>02458     <span class="keywordflow">else</span> {
<a name="l02459"></a>02459         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;unknown value for undefined character option&quot;</span>);
<a name="l02460"></a>02460     }
<a name="l02461"></a>02461 
<a name="l02462"></a>02462     v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opt, <a class="code" href="../../d3/d26/transcode_8c.html#ab15aaca5bc3b3652d2c7b243bec3c342">sym_replace</a>);
<a name="l02463"></a>02463     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v) &amp;&amp; !(ecflags &amp; <a class="code" href="../../d5/de3/encoding_8h.html#a6ebf7f037784cbfd05d0d7930532f796">ECONV_INVALID_REPLACE</a>)) {
<a name="l02464"></a>02464         ecflags |= <a class="code" href="../../d5/de3/encoding_8h.html#a4f8674ffeb3e7e562628f54ff0a10f4e">ECONV_UNDEF_REPLACE</a>;
<a name="l02465"></a>02465     }
<a name="l02466"></a>02466 
<a name="l02467"></a>02467     v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opt, <a class="code" href="../../d3/d26/transcode_8c.html#a6280c8826ff0dd1c47767aab5d17452b">sym_xml</a>);
<a name="l02468"></a>02468     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v)) {
<a name="l02469"></a>02469         <span class="keywordflow">if</span> (v==<a class="code" href="../../d3/d26/transcode_8c.html#a7a02b57ce7a33ad046278fbee16b0224">sym_text</a>) {
<a name="l02470"></a>02470             ecflags |= <a class="code" href="../../d5/de3/encoding_8h.html#a5477824dfc0b7b9f38411f309610fe69">ECONV_XML_TEXT_DECORATOR</a>|<a class="code" href="../../d5/de3/encoding_8h.html#acc5cca239974f158070f17e09202fb69">ECONV_UNDEF_HEX_CHARREF</a>;
<a name="l02471"></a>02471         }
<a name="l02472"></a>02472         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v==<a class="code" href="../../d3/d26/transcode_8c.html#a131583b160da3ae2c6ba8c0686037596">sym_attr</a>) {
<a name="l02473"></a>02473             ecflags |= <a class="code" href="../../d5/de3/encoding_8h.html#a30366abfd546975d8e5c945289afb9a2">ECONV_XML_ATTR_CONTENT_DECORATOR</a>|<a class="code" href="../../d5/de3/encoding_8h.html#a01a2578ca9179596c418d8ad3ce946d5">ECONV_XML_ATTR_QUOTE_DECORATOR</a>|<a class="code" href="../../d5/de3/encoding_8h.html#acc5cca239974f158070f17e09202fb69">ECONV_UNDEF_HEX_CHARREF</a>;
<a name="l02474"></a>02474         }
<a name="l02475"></a>02475         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(v) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac9aadbc1e9c456506a4d7eef5cdc787e">T_SYMBOL</a>) {
<a name="l02476"></a>02476             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;unexpected value for xml option: %s&quot;</span>, <a class="code" href="../../d5/d11/ripper_8c.html#a877bc58c495643fcf49dc64c44631e72">rb_id2name</a>(<a class="code" href="../../dc/d0c/cparse_8c.html#a73ce5202e6172d3ad0bab7d1e0df9dae">SYM2ID</a>(v)));
<a name="l02477"></a>02477         }
<a name="l02478"></a>02478         <span class="keywordflow">else</span> {
<a name="l02479"></a>02479             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;unexpected value for xml option&quot;</span>);
<a name="l02480"></a>02480         }
<a name="l02481"></a>02481     }
<a name="l02482"></a>02482 
<a name="l02483"></a>02483 <span class="preprocessor">#ifdef ENABLE_ECONV_NEWLINE_OPTION</span>
<a name="l02484"></a>02484 <span class="preprocessor"></span>    v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opt, <a class="code" href="../../d3/d26/transcode_8c.html#a2e8f88ddab931a79be2bb4dabf52e5f3">sym_newline</a>);
<a name="l02485"></a>02485     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v)) {
<a name="l02486"></a>02486         ecflags &amp;= ~<a class="code" href="../../d5/de3/encoding_8h.html#aea188e77ea841e2c7741a9ef8c4c33a5">ECONV_NEWLINE_DECORATOR_MASK</a>;
<a name="l02487"></a>02487         <span class="keywordflow">if</span> (v == <a class="code" href="../../d3/d26/transcode_8c.html#a865013f3f9a72c761d4f62c492bdac32">sym_universal</a>) {
<a name="l02488"></a>02488             ecflags |= <a class="code" href="../../d5/de3/encoding_8h.html#a122d5f3118774ae1a01a3262c73141eb">ECONV_UNIVERSAL_NEWLINE_DECORATOR</a>;
<a name="l02489"></a>02489         }
<a name="l02490"></a>02490         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v == <a class="code" href="../../d3/d26/transcode_8c.html#a9e00c2b0789779dc6c482d37301c11e2">sym_crlf</a>) {
<a name="l02491"></a>02491             ecflags |= <a class="code" href="../../d5/de3/encoding_8h.html#a38b80a28fd1ac8423761193a71d7752c">ECONV_CRLF_NEWLINE_DECORATOR</a>;
<a name="l02492"></a>02492         }
<a name="l02493"></a>02493         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v == <a class="code" href="../../d3/d26/transcode_8c.html#ab80c9d144cbc45017e4a43a1edfa6839">sym_cr</a>) {
<a name="l02494"></a>02494             ecflags |= <a class="code" href="../../d5/de3/encoding_8h.html#a64019d94f530b33a149a2016278cc940">ECONV_CR_NEWLINE_DECORATOR</a>;
<a name="l02495"></a>02495         }
<a name="l02496"></a>02496         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (v == <a class="code" href="../../d3/d26/transcode_8c.html#ac7906406a2eed9ca677be5ee09187c36">sym_lf</a>) {
<a name="l02497"></a>02497             <span class="comment">/* ecflags |= ECONV_LF_NEWLINE_DECORATOR; */</span>
<a name="l02498"></a>02498         }
<a name="l02499"></a>02499         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../dc/d0c/cparse_8c.html#a637bc5a232034ee3fd411f8bef091566">SYMBOL_P</a>(v)) {
<a name="l02500"></a>02500             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;unexpected value for newline option: %s&quot;</span>,
<a name="l02501"></a>02501                      <a class="code" href="../../d5/d11/ripper_8c.html#a877bc58c495643fcf49dc64c44631e72">rb_id2name</a>(<a class="code" href="../../dc/d0c/cparse_8c.html#a73ce5202e6172d3ad0bab7d1e0df9dae">SYM2ID</a>(v)));
<a name="l02502"></a>02502         }
<a name="l02503"></a>02503         <span class="keywordflow">else</span> {
<a name="l02504"></a>02504             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;unexpected value for newline option&quot;</span>);
<a name="l02505"></a>02505         }
<a name="l02506"></a>02506     }
<a name="l02507"></a>02507     <span class="keywordflow">else</span>
<a name="l02508"></a>02508 <span class="preprocessor">#endif</span>
<a name="l02509"></a>02509 <span class="preprocessor"></span>    {
<a name="l02510"></a>02510         <span class="keywordtype">int</span> setflags = 0, newlineflag = 0;
<a name="l02511"></a>02511 
<a name="l02512"></a>02512         v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opt, <a class="code" href="../../d3/d26/transcode_8c.html#a544876157eb56fdee18d20866275045d">sym_universal_newline</a>);
<a name="l02513"></a>02513         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(v))
<a name="l02514"></a>02514             setflags |= <a class="code" href="../../d5/de3/encoding_8h.html#a122d5f3118774ae1a01a3262c73141eb">ECONV_UNIVERSAL_NEWLINE_DECORATOR</a>;
<a name="l02515"></a>02515         newlineflag |= !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v);
<a name="l02516"></a>02516 
<a name="l02517"></a>02517         v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opt, <a class="code" href="../../d3/d26/transcode_8c.html#a4eb4af234eff2e556aaff8d5583a182e">sym_crlf_newline</a>);
<a name="l02518"></a>02518         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(v))
<a name="l02519"></a>02519             setflags |= <a class="code" href="../../d5/de3/encoding_8h.html#a38b80a28fd1ac8423761193a71d7752c">ECONV_CRLF_NEWLINE_DECORATOR</a>;
<a name="l02520"></a>02520         newlineflag |= !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v);
<a name="l02521"></a>02521 
<a name="l02522"></a>02522         v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opt, <a class="code" href="../../d3/d26/transcode_8c.html#ad2b9d4c5055c29b3f5ead8fe8218d74c">sym_cr_newline</a>);
<a name="l02523"></a>02523         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(v))
<a name="l02524"></a>02524             setflags |= <a class="code" href="../../d5/de3/encoding_8h.html#a64019d94f530b33a149a2016278cc940">ECONV_CR_NEWLINE_DECORATOR</a>;
<a name="l02525"></a>02525         newlineflag |= !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v);
<a name="l02526"></a>02526 
<a name="l02527"></a>02527         <span class="keywordflow">if</span> (newlineflag) {
<a name="l02528"></a>02528             ecflags &amp;= ~<a class="code" href="../../d5/de3/encoding_8h.html#aea188e77ea841e2c7741a9ef8c4c33a5">ECONV_NEWLINE_DECORATOR_MASK</a>;
<a name="l02529"></a>02529             ecflags |= setflags;
<a name="l02530"></a>02530         }
<a name="l02531"></a>02531     }
<a name="l02532"></a>02532 
<a name="l02533"></a>02533     <span class="keywordflow">return</span> ecflags;
<a name="l02534"></a>02534 }
<a name="l02535"></a>02535 
<a name="l02536"></a>02536 <span class="keywordtype">int</span>
<a name="l02537"></a><a class="code" href="../../d3/d26/transcode_8c.html#ad1e0ed511325a6738e9b12022920c426">02537</a> <a class="code" href="../../d5/de3/encoding_8h.html#a044a268a72d78b9e549136b55745af1d">rb_econv_prepare_options</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opthash, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *opts, <span class="keywordtype">int</span> ecflags)
<a name="l02538"></a>02538 {
<a name="l02539"></a>02539     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> newhash = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02540"></a>02540     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v;
<a name="l02541"></a>02541 
<a name="l02542"></a>02542     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(opthash)) {
<a name="l02543"></a>02543         *opts = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02544"></a>02544         <span class="keywordflow">return</span> ecflags;
<a name="l02545"></a>02545     }
<a name="l02546"></a>02546     ecflags = <a class="code" href="../../d3/d26/transcode_8c.html#abf10bc9c136130b2dbf5d229e8aacaee">econv_opts</a>(opthash, ecflags);
<a name="l02547"></a>02547 
<a name="l02548"></a>02548     v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opthash, <a class="code" href="../../d3/d26/transcode_8c.html#ab15aaca5bc3b3652d2c7b243bec3c342">sym_replace</a>);
<a name="l02549"></a>02549     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v)) {
<a name="l02550"></a>02550         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(v);
<a name="l02551"></a>02551         <span class="keywordflow">if</span> (<a class="code" href="../../d5/de3/encoding_8h.html#a5282c41e11a68fe310f45c9a326ae2b8">rb_enc_str_coderange</a>(v) == <a class="code" href="../../d5/de3/encoding_8h.html#abb86fbc02fc2b78d928825ea6d6922f9">ENC_CODERANGE_BROKEN</a>) {
<a name="l02552"></a>02552             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> dumped = <a class="code" href="../../db/d2e/intern_8h.html#ab4fa4ec084128c2a79a73d1989210ea4">rb_str_dump</a>(v);
<a name="l02553"></a>02553             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;replacement string is broken: %s as %s&quot;</span>,
<a name="l02554"></a>02554                      <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(dumped),
<a name="l02555"></a>02555                      <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(<a class="code" href="../../d5/db5/encoding_8c.html#ac21ed764f3b39453b6a848dd64a19585">rb_enc_get</a>(v)));
<a name="l02556"></a>02556         }
<a name="l02557"></a>02557         v = <a class="code" href="../../db/d2e/intern_8h.html#ab771cea1c6187da7a08e9f0bc309a0a6">rb_str_new_frozen</a>(v);
<a name="l02558"></a>02558         newhash = <a class="code" href="../../d1/d04/hash_8c.html#af1da586524a3a1739fd5b91272037815">rb_hash_new</a>();
<a name="l02559"></a>02559         <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(newhash, <a class="code" href="../../d3/d26/transcode_8c.html#ab15aaca5bc3b3652d2c7b243bec3c342">sym_replace</a>, v);
<a name="l02560"></a>02560     }
<a name="l02561"></a>02561 
<a name="l02562"></a>02562     v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opthash, <a class="code" href="../../d3/d26/transcode_8c.html#a338cb4cb4bd7d8994da411e0b1bfbb21">sym_fallback</a>);
<a name="l02563"></a>02563     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(v)) {
<a name="l02564"></a>02564         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> h = <a class="code" href="../../d1/d04/hash_8c.html#a28fa36f398d6cc2037a44517ccc9650b">rb_check_hash_type</a>(v);
<a name="l02565"></a>02565         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(h)
<a name="l02566"></a>02566             ? (<a class="code" href="../../db/d2e/intern_8h.html#a465568c66f9f2f257916e3a2f7f14aae">rb_obj_is_proc</a>(v) || <a class="code" href="../../db/d2e/intern_8h.html#a42d20e898f60dacf8c07fac18922a0de">rb_obj_is_method</a>(v) || <a class="code" href="../../db/d2e/intern_8h.html#a5c6c63c2619b8c03df2e173ef1e73846">rb_respond_to</a>(v, <a class="code" href="../../d3/d26/transcode_8c.html#a000881fcf4572b2a9a3216b3aeae05dc">sym_aref</a>))
<a name="l02567"></a>02567             : (v = h, 1)) {
<a name="l02568"></a>02568             <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(newhash))
<a name="l02569"></a>02569                 newhash = <a class="code" href="../../d1/d04/hash_8c.html#af1da586524a3a1739fd5b91272037815">rb_hash_new</a>();
<a name="l02570"></a>02570             <a class="code" href="../../d1/d04/hash_8c.html#ac477edf136d86a33bc06d1fbea67bb9a">rb_hash_aset</a>(newhash, <a class="code" href="../../d3/d26/transcode_8c.html#a338cb4cb4bd7d8994da411e0b1bfbb21">sym_fallback</a>, v);
<a name="l02571"></a>02571         }
<a name="l02572"></a>02572     }
<a name="l02573"></a>02573 
<a name="l02574"></a>02574     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(newhash))
<a name="l02575"></a>02575         <a class="code" href="../../d1/d04/hash_8c.html#abe1cee7cdc357044f2aacf3c4bd1c4c6">rb_hash_freeze</a>(newhash);
<a name="l02576"></a>02576     *opts = newhash;
<a name="l02577"></a>02577 
<a name="l02578"></a>02578     <span class="keywordflow">return</span> ecflags;
<a name="l02579"></a>02579 }
<a name="l02580"></a>02580 
<a name="l02581"></a>02581 <span class="keywordtype">int</span>
<a name="l02582"></a><a class="code" href="../../d3/d26/transcode_8c.html#aa6d5af565435f7f65126fc8ea5ebd622">02582</a> <a class="code" href="../../d5/de3/encoding_8h.html#a1eba00da8f7d32896009a279a9edca25">rb_econv_prepare_opts</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opthash, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *opts)
<a name="l02583"></a>02583 {
<a name="l02584"></a>02584     <span class="keywordflow">return</span> <a class="code" href="../../d5/de3/encoding_8h.html#a044a268a72d78b9e549136b55745af1d">rb_econv_prepare_options</a>(opthash, opts, 0);
<a name="l02585"></a>02585 }
<a name="l02586"></a>02586 
<a name="l02587"></a>02587 <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *
<a name="l02588"></a><a class="code" href="../../d3/d26/transcode_8c.html#a7de72e9dcfcd666483b87b3bcecfa3e8">02588</a> <a class="code" href="../../d5/de3/encoding_8h.html#ac48226d977525efbbf4ed18ff36fce23">rb_econv_open_opts</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *source_encoding, <span class="keyword">const</span> <span class="keywordtype">char</span> *destination_encoding, <span class="keywordtype">int</span> ecflags, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opthash)
<a name="l02589"></a>02589 {
<a name="l02590"></a>02590     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec;
<a name="l02591"></a>02591     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> replacement;
<a name="l02592"></a>02592 
<a name="l02593"></a>02593     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(opthash)) {
<a name="l02594"></a>02594         replacement = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02595"></a>02595     }
<a name="l02596"></a>02596     <span class="keywordflow">else</span> {
<a name="l02597"></a>02597         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(opthash) != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8357e81bbb60cb41b0a292a90653a5e5">T_HASH</a> || !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a73db79f74bad2fb5258a2ae7ee6ef117">OBJ_FROZEN</a>(opthash))
<a name="l02598"></a>02598             <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;rb_econv_open_opts called with invalid opthash&quot;</span>);
<a name="l02599"></a>02599         replacement = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opthash, <a class="code" href="../../d3/d26/transcode_8c.html#ab15aaca5bc3b3652d2c7b243bec3c342">sym_replace</a>);
<a name="l02600"></a>02600     }
<a name="l02601"></a>02601 
<a name="l02602"></a>02602     ec = <a class="code" href="../../d5/de3/encoding_8h.html#af532021ea48e3846a419d3b8263a9311">rb_econv_open</a>(source_encoding, destination_encoding, ecflags);
<a name="l02603"></a>02603     <span class="keywordflow">if</span> (!ec)
<a name="l02604"></a>02604         <span class="keywordflow">return</span> ec;
<a name="l02605"></a>02605 
<a name="l02606"></a>02606     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(replacement)) {
<a name="l02607"></a>02607         <span class="keywordtype">int</span> ret;
<a name="l02608"></a>02608         <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc = <a class="code" href="../../d5/db5/encoding_8c.html#ac21ed764f3b39453b6a848dd64a19585">rb_enc_get</a>(replacement);
<a name="l02609"></a>02609 
<a name="l02610"></a>02610         ret = <a class="code" href="../../d5/de3/encoding_8h.html#af50df105139f4ecc899dea17f3a4bb1b">rb_econv_set_replacement</a>(ec,
<a name="l02611"></a>02611                 (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(replacement),
<a name="l02612"></a>02612                 <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(replacement),
<a name="l02613"></a>02613                 <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(enc));
<a name="l02614"></a>02614         <span class="keywordflow">if</span> (ret == -1) {
<a name="l02615"></a>02615             <a class="code" href="../../d5/de3/encoding_8h.html#adaf53306799f8796d7e6437bc98d0b0e">rb_econv_close</a>(ec);
<a name="l02616"></a>02616             <span class="keywordflow">return</span> <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02617"></a>02617         }
<a name="l02618"></a>02618     }
<a name="l02619"></a>02619     <span class="keywordflow">return</span> ec;
<a name="l02620"></a>02620 }
<a name="l02621"></a>02621 
<a name="l02622"></a>02622 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02623"></a><a class="code" href="../../d3/d26/transcode_8c.html#a87f3c41a3f6c759a2a71313985efa202">02623</a> <a class="code" href="../../d3/d26/transcode_8c.html#a87f3c41a3f6c759a2a71313985efa202">enc_arg</a>(<span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *arg, <span class="keyword">const</span> <span class="keywordtype">char</span> **name_p, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> **enc_p)
<a name="l02624"></a>02624 {
<a name="l02625"></a>02625     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc;
<a name="l02626"></a>02626     <span class="keyword">const</span> <span class="keywordtype">char</span> *n;
<a name="l02627"></a>02627     <span class="keywordtype">int</span> encidx;
<a name="l02628"></a>02628     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> encval;
<a name="l02629"></a>02629 
<a name="l02630"></a>02630     <span class="keywordflow">if</span> (((encidx = <a class="code" href="../../d5/db5/encoding_8c.html#a13a97a6605eca1509135ff473bf346b6">rb_to_encoding_index</a>(encval = *arg)) &lt; 0) ||
<a name="l02631"></a>02631         !(enc = <a class="code" href="../../d5/db5/encoding_8c.html#aef9c377b2d9d78b9f88e890b77593109">rb_enc_from_index</a>(encidx))) {
<a name="l02632"></a>02632         enc = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l02633"></a>02633         encidx = 0;
<a name="l02634"></a>02634         n = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(*arg);
<a name="l02635"></a>02635     }
<a name="l02636"></a>02636     <span class="keywordflow">else</span> {
<a name="l02637"></a>02637         n = <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(enc);
<a name="l02638"></a>02638     }
<a name="l02639"></a>02639 
<a name="l02640"></a>02640     *name_p = n;
<a name="l02641"></a>02641     *enc_p = enc;
<a name="l02642"></a>02642 
<a name="l02643"></a>02643     <span class="keywordflow">return</span> encidx;
<a name="l02644"></a>02644 }
<a name="l02645"></a>02645 
<a name="l02646"></a>02646 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02647"></a><a class="code" href="../../d3/d26/transcode_8c.html#a93f8689519cc0fd013947463856d876c">02647</a> <a class="code" href="../../d3/d26/transcode_8c.html#a93f8689519cc0fd013947463856d876c">str_transcode_enc_args</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *arg1, <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *arg2,
<a name="l02648"></a>02648         <span class="keyword">const</span> <span class="keywordtype">char</span> **sname_p, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> **senc_p,
<a name="l02649"></a>02649         <span class="keyword">const</span> <span class="keywordtype">char</span> **dname_p, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> **denc_p)
<a name="l02650"></a>02650 {
<a name="l02651"></a>02651     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *senc, *denc;
<a name="l02652"></a>02652     <span class="keyword">const</span> <span class="keywordtype">char</span> *sname, *dname;
<a name="l02653"></a>02653     <span class="keywordtype">int</span> sencidx, dencidx;
<a name="l02654"></a>02654 
<a name="l02655"></a>02655     dencidx = <a class="code" href="../../d3/d26/transcode_8c.html#a87f3c41a3f6c759a2a71313985efa202">enc_arg</a>(arg1, &amp;dname, &amp;denc);
<a name="l02656"></a>02656 
<a name="l02657"></a>02657     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(*arg2)) {
<a name="l02658"></a>02658         sencidx = <a class="code" href="../../d5/db5/encoding_8c.html#a0ee8da2e6cc01567488e318854a3d9c0">rb_enc_get_index</a>(str);
<a name="l02659"></a>02659         senc = <a class="code" href="../../d5/db5/encoding_8c.html#aef9c377b2d9d78b9f88e890b77593109">rb_enc_from_index</a>(sencidx);
<a name="l02660"></a>02660         sname = <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(senc);
<a name="l02661"></a>02661     }
<a name="l02662"></a>02662     <span class="keywordflow">else</span> {
<a name="l02663"></a>02663         sencidx = <a class="code" href="../../d3/d26/transcode_8c.html#a87f3c41a3f6c759a2a71313985efa202">enc_arg</a>(arg2, &amp;sname, &amp;senc);
<a name="l02664"></a>02664     }
<a name="l02665"></a>02665 
<a name="l02666"></a>02666     *sname_p = sname;
<a name="l02667"></a>02667     *senc_p = senc;
<a name="l02668"></a>02668     *dname_p = dname;
<a name="l02669"></a>02669     *denc_p = denc;
<a name="l02670"></a>02670     <span class="keywordflow">return</span> dencidx;
<a name="l02671"></a>02671 }
<a name="l02672"></a>02672 
<a name="l02673"></a>02673 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02674"></a><a class="code" href="../../d3/d26/transcode_8c.html#a40793efc243ce9a8e34531413dbdc1b6">02674</a> <a class="code" href="../../d3/d26/transcode_8c.html#a40793efc243ce9a8e34531413dbdc1b6">str_transcode0</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<span class="keyword">self</span>, <span class="keywordtype">int</span> ecflags, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ecopts)
<a name="l02675"></a>02675 {
<a name="l02676"></a>02676     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> dest;
<a name="l02677"></a>02677     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str = *<span class="keyword">self</span>;
<a name="l02678"></a>02678     <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg1, arg2;
<a name="l02679"></a>02679     <span class="keywordtype">long</span> blen, slen;
<a name="l02680"></a>02680     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#ac37f17a60c8b5533aac4840c681f62b8">buf</a>, *<a class="code" href="../../db/d16/debug_8h.html#a1baecad7f27ccf1689612054ecf6a397">bp</a>, *sp;
<a name="l02681"></a>02681     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *fromp;
<a name="l02682"></a>02682     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *senc, *denc;
<a name="l02683"></a>02683     <span class="keyword">const</span> <span class="keywordtype">char</span> *sname, *dname;
<a name="l02684"></a>02684     <span class="keywordtype">int</span> dencidx;
<a name="l02685"></a>02685 
<a name="l02686"></a>02686     <span class="keywordflow">if</span> (argc &lt;0 || argc &gt; 2) {
<a name="l02687"></a>02687         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;wrong number of arguments (%d for 0..2)&quot;</span>, argc);
<a name="l02688"></a>02688     }
<a name="l02689"></a>02689 
<a name="l02690"></a>02690     <span class="keywordflow">if</span> (argc == 0) {
<a name="l02691"></a>02691         arg1 = <a class="code" href="../../d5/db5/encoding_8c.html#ab349505ca2fad4f5b219b2acf2dae38d">rb_enc_default_internal</a>();
<a name="l02692"></a>02692         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(arg1)) {
<a name="l02693"></a>02693             <span class="keywordflow">if</span> (!ecflags) <span class="keywordflow">return</span> -1;
<a name="l02694"></a>02694             arg1 = <a class="code" href="../../d5/db5/encoding_8c.html#aca4947a16b0f9c7ae2db67a72e52b6ca">rb_obj_encoding</a>(str);
<a name="l02695"></a>02695         }
<a name="l02696"></a>02696         ecflags |= <a class="code" href="../../d5/de3/encoding_8h.html#a6ebf7f037784cbfd05d0d7930532f796">ECONV_INVALID_REPLACE</a> | <a class="code" href="../../d5/de3/encoding_8h.html#a4f8674ffeb3e7e562628f54ff0a10f4e">ECONV_UNDEF_REPLACE</a>;
<a name="l02697"></a>02697     }
<a name="l02698"></a>02698     <span class="keywordflow">else</span> {
<a name="l02699"></a>02699         arg1 = argv[0];
<a name="l02700"></a>02700     }
<a name="l02701"></a>02701     arg2 = argc&lt;=1 ? <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a> : argv[1];
<a name="l02702"></a>02702     dencidx = <a class="code" href="../../d3/d26/transcode_8c.html#a93f8689519cc0fd013947463856d876c">str_transcode_enc_args</a>(str, &amp;arg1, &amp;arg2, &amp;sname, &amp;senc, &amp;dname, &amp;denc);
<a name="l02703"></a>02703 
<a name="l02704"></a>02704     <span class="keywordflow">if</span> ((ecflags &amp; (<a class="code" href="../../d5/de3/encoding_8h.html#aea188e77ea841e2c7741a9ef8c4c33a5">ECONV_NEWLINE_DECORATOR_MASK</a>|
<a name="l02705"></a>02705                     <a class="code" href="../../d5/de3/encoding_8h.html#a5477824dfc0b7b9f38411f309610fe69">ECONV_XML_TEXT_DECORATOR</a>|
<a name="l02706"></a>02706                     <a class="code" href="../../d5/de3/encoding_8h.html#a30366abfd546975d8e5c945289afb9a2">ECONV_XML_ATTR_CONTENT_DECORATOR</a>|
<a name="l02707"></a>02707                     <a class="code" href="../../d5/de3/encoding_8h.html#a01a2578ca9179596c418d8ad3ce946d5">ECONV_XML_ATTR_QUOTE_DECORATOR</a>)) == 0) {
<a name="l02708"></a>02708         <span class="keywordflow">if</span> (senc &amp;&amp; senc == denc) {
<a name="l02709"></a>02709             <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(arg2) ? -1 : dencidx;
<a name="l02710"></a>02710         }
<a name="l02711"></a>02711         <span class="keywordflow">if</span> (senc &amp;&amp; denc &amp;&amp; <a class="code" href="../../d5/de3/encoding_8h.html#a8b18a09a3055d3006c6d5baeaa6e7c72">rb_enc_asciicompat</a>(senc) &amp;&amp; <a class="code" href="../../d5/de3/encoding_8h.html#a8b18a09a3055d3006c6d5baeaa6e7c72">rb_enc_asciicompat</a>(denc)) {
<a name="l02712"></a>02712             <span class="keywordflow">if</span> (<a class="code" href="../../d5/de3/encoding_8h.html#a5282c41e11a68fe310f45c9a326ae2b8">rb_enc_str_coderange</a>(str) == <a class="code" href="../../d5/de3/encoding_8h.html#a0a0e73a2d98205044e1ad19432502c5b">ENC_CODERANGE_7BIT</a>) {
<a name="l02713"></a>02713                 <span class="keywordflow">return</span> dencidx;
<a name="l02714"></a>02714             }
<a name="l02715"></a>02715         }
<a name="l02716"></a>02716         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#adc12ab3195f23d65f243fe172370e950">encoding_equal</a>(sname, dname)) {
<a name="l02717"></a>02717             <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(arg2) ? -1 : dencidx;
<a name="l02718"></a>02718         }
<a name="l02719"></a>02719     }
<a name="l02720"></a>02720     <span class="keywordflow">else</span> {
<a name="l02721"></a>02721         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#adc12ab3195f23d65f243fe172370e950">encoding_equal</a>(sname, dname)) {
<a name="l02722"></a>02722             sname = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02723"></a>02723             dname = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02724"></a>02724         }
<a name="l02725"></a>02725     }
<a name="l02726"></a>02726 
<a name="l02727"></a>02727     fromp = sp = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str);
<a name="l02728"></a>02728     slen = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(str);
<a name="l02729"></a>02729     blen = slen + 30; <span class="comment">/* len + margin */</span>
<a name="l02730"></a>02730     dest = <a class="code" href="../../db/d2e/intern_8h.html#a9c93a5402138185ceff87cb1f483c4f5">rb_str_tmp_new</a>(blen);
<a name="l02731"></a>02731     bp = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(dest);
<a name="l02732"></a>02732 
<a name="l02733"></a>02733     <a class="code" href="../../d3/d26/transcode_8c.html#a88ec34ea3ca349bdc405a42e036822bf">transcode_loop</a>(&amp;fromp, &amp;bp, (sp+slen), (bp+blen), dest, <a class="code" href="../../d3/d26/transcode_8c.html#aaf47cc68cab7e9411ee95758e5a7101c">str_transcoding_resize</a>, sname, dname, ecflags, ecopts);
<a name="l02734"></a>02734     <span class="keywordflow">if</span> (fromp != sp+slen) {
<a name="l02735"></a>02735         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;not fully converted, %&quot;</span><a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca444ec27cdd86e8456e34dfc4aed830">PRIdPTRDIFF</a><span class="stringliteral">&quot; bytes left&quot;</span>, sp+slen-fromp);
<a name="l02736"></a>02736     }
<a name="l02737"></a>02737     buf = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(dest);
<a name="l02738"></a>02738     *bp = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02739"></a>02739     <a class="code" href="../../d8/d81/ruby__missing_8h.html#a89ed8cb86ca6dd49d2db67adae809057">rb_str_set_len</a>(dest, bp - buf);
<a name="l02740"></a>02740 
<a name="l02741"></a>02741     <span class="comment">/* set encoding */</span>
<a name="l02742"></a>02742     <span class="keywordflow">if</span> (!denc) {
<a name="l02743"></a>02743         dencidx = <a class="code" href="../../d5/db5/encoding_8c.html#a873f1c2ba114f13f45b84990a5a595b7">rb_define_dummy_encoding</a>(dname);
<a name="l02744"></a>02744     }
<a name="l02745"></a>02745     *<span class="keyword">self</span> = dest;
<a name="l02746"></a>02746 
<a name="l02747"></a>02747     <span class="keywordflow">return</span> dencidx;
<a name="l02748"></a>02748 }
<a name="l02749"></a>02749 
<a name="l02750"></a>02750 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l02751"></a><a class="code" href="../../d3/d26/transcode_8c.html#a95ae7b7fadaf5cc9e67b9a03975a8496">02751</a> <a class="code" href="../../d3/d26/transcode_8c.html#a95ae7b7fadaf5cc9e67b9a03975a8496">str_transcode</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<span class="keyword">self</span>)
<a name="l02752"></a>02752 {
<a name="l02753"></a>02753     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opt;
<a name="l02754"></a>02754     <span class="keywordtype">int</span> ecflags = 0;
<a name="l02755"></a>02755     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ecopts = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02756"></a>02756 
<a name="l02757"></a>02757     argc = <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;02:&quot;</span>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, &amp;opt);
<a name="l02758"></a>02758     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(opt)) {
<a name="l02759"></a>02759         ecflags = <a class="code" href="../../d5/de3/encoding_8h.html#a1eba00da8f7d32896009a279a9edca25">rb_econv_prepare_opts</a>(opt, &amp;ecopts);
<a name="l02760"></a>02760     }
<a name="l02761"></a>02761     <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a40793efc243ce9a8e34531413dbdc1b6">str_transcode0</a>(argc, argv, <span class="keyword">self</span>, ecflags, ecopts);
<a name="l02762"></a>02762 }
<a name="l02763"></a>02763 
<a name="l02764"></a>02764 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02765"></a><a class="code" href="../../d3/d26/transcode_8c.html#a0d9a8b092b441da2ff1b4dbe8d2d5cd2">02765</a> <a class="code" href="../../d3/d26/transcode_8c.html#a0d9a8b092b441da2ff1b4dbe8d2d5cd2">str_encode_associate</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, <span class="keywordtype">int</span> encidx)
<a name="l02766"></a>02766 {
<a name="l02767"></a>02767     <span class="keywordtype">int</span> cr = 0;
<a name="l02768"></a>02768 
<a name="l02769"></a>02769     <a class="code" href="../../d5/db5/encoding_8c.html#ad5df62bd02b6d06037baef7ad68bcae3">rb_enc_associate_index</a>(str, encidx);
<a name="l02770"></a>02770 
<a name="l02771"></a>02771     <span class="comment">/* transcoded string never be broken. */</span>
<a name="l02772"></a>02772     <span class="keywordflow">if</span> (<a class="code" href="../../d5/de3/encoding_8h.html#a8b18a09a3055d3006c6d5baeaa6e7c72">rb_enc_asciicompat</a>(<a class="code" href="../../d5/db5/encoding_8c.html#aef9c377b2d9d78b9f88e890b77593109">rb_enc_from_index</a>(encidx))) {
<a name="l02773"></a>02773         <a class="code" href="../../d5/de3/encoding_8h.html#ac1fbec2516e7dbaafbdf8933c5ad7946">rb_str_coderange_scan_restartable</a>(<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a35bfa2635774977edad0a16b9fdebbaf">RSTRING_END</a>(str), 0, &amp;cr);
<a name="l02774"></a>02774     }
<a name="l02775"></a>02775     <span class="keywordflow">else</span> {
<a name="l02776"></a>02776         cr = <a class="code" href="../../d5/de3/encoding_8h.html#a0c81a12daaa1e57009d46b9d906957dc">ENC_CODERANGE_VALID</a>;
<a name="l02777"></a>02777     }
<a name="l02778"></a>02778     <a class="code" href="../../d5/de3/encoding_8h.html#aefe5772c0116cf7131a5227de7243dbc">ENC_CODERANGE_SET</a>(str, cr);
<a name="l02779"></a>02779     <span class="keywordflow">return</span> str;
<a name="l02780"></a>02780 }
<a name="l02781"></a>02781 
<a name="l02782"></a>02782 <span class="comment">/*</span>
<a name="l02783"></a>02783 <span class="comment"> *  call-seq:</span>
<a name="l02784"></a>02784 <span class="comment"> *     str.encode!(encoding [, options] )   -&gt; str</span>
<a name="l02785"></a>02785 <span class="comment"> *     str.encode!(dst_encoding, src_encoding [, options] )   -&gt; str</span>
<a name="l02786"></a>02786 <span class="comment"> *</span>
<a name="l02787"></a>02787 <span class="comment"> *  The first form transcodes the contents of &lt;i&gt;str&lt;/i&gt; from</span>
<a name="l02788"></a>02788 <span class="comment"> *  str.encoding to +encoding+.</span>
<a name="l02789"></a>02789 <span class="comment"> *  The second form transcodes the contents of &lt;i&gt;str&lt;/i&gt; from</span>
<a name="l02790"></a>02790 <span class="comment"> *  src_encoding to dst_encoding.</span>
<a name="l02791"></a>02791 <span class="comment"> *  The options Hash gives details for conversion. See String#encode</span>
<a name="l02792"></a>02792 <span class="comment"> *  for details.</span>
<a name="l02793"></a>02793 <span class="comment"> *  Returns the string even if no changes were made.</span>
<a name="l02794"></a>02794 <span class="comment"> */</span>
<a name="l02795"></a>02795 
<a name="l02796"></a>02796 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02797"></a><a class="code" href="../../d3/d26/transcode_8c.html#a30b2307d43145ce1d948d9f329912586">02797</a> <a class="code" href="../../d3/d26/transcode_8c.html#a30b2307d43145ce1d948d9f329912586">str_encode_bang</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str)
<a name="l02798"></a>02798 {
<a name="l02799"></a>02799     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> newstr;
<a name="l02800"></a>02800     <span class="keywordtype">int</span> encidx;
<a name="l02801"></a>02801 
<a name="l02802"></a>02802     <a class="code" href="../../db/d2e/intern_8h.html#a372d6acb27d271ee4fc2e88c7022c485">rb_check_frozen</a>(str);
<a name="l02803"></a>02803 
<a name="l02804"></a>02804     newstr = str;
<a name="l02805"></a>02805     encidx = <a class="code" href="../../d3/d26/transcode_8c.html#a95ae7b7fadaf5cc9e67b9a03975a8496">str_transcode</a>(argc, argv, &amp;newstr);
<a name="l02806"></a>02806 
<a name="l02807"></a>02807     <span class="keywordflow">if</span> (encidx &lt; 0) <span class="keywordflow">return</span> str;
<a name="l02808"></a>02808     <a class="code" href="../../db/d2e/intern_8h.html#a284132f9d055bd8adef45b71f26ee6ae">rb_str_shared_replace</a>(str, newstr);
<a name="l02809"></a>02809     <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a0d9a8b092b441da2ff1b4dbe8d2d5cd2">str_encode_associate</a>(str, encidx);
<a name="l02810"></a>02810 }
<a name="l02811"></a>02811 
<a name="l02812"></a>02812 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d26/transcode_8c.html#a97454b08a20769bc3a670889f613c71d">encoded_dup</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> newstr, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, <span class="keywordtype">int</span> encidx);
<a name="l02813"></a>02813 
<a name="l02814"></a>02814 <span class="comment">/*</span>
<a name="l02815"></a>02815 <span class="comment"> *  call-seq:</span>
<a name="l02816"></a>02816 <span class="comment"> *     str.encode(encoding [, options] )   -&gt; str</span>
<a name="l02817"></a>02817 <span class="comment"> *     str.encode(dst_encoding, src_encoding [, options] )   -&gt; str</span>
<a name="l02818"></a>02818 <span class="comment"> *     str.encode([options])   -&gt; str</span>
<a name="l02819"></a>02819 <span class="comment"> *</span>
<a name="l02820"></a>02820 <span class="comment"> *  The first form returns a copy of +str+ transcoded</span>
<a name="l02821"></a>02821 <span class="comment"> *  to encoding +encoding+.</span>
<a name="l02822"></a>02822 <span class="comment"> *  The second form returns a copy of +str+ transcoded</span>
<a name="l02823"></a>02823 <span class="comment"> *  from src_encoding to dst_encoding.</span>
<a name="l02824"></a>02824 <span class="comment"> *  The last form returns a copy of +str+ transcoded to</span>
<a name="l02825"></a>02825 <span class="comment"> *  &lt;tt&gt;Encoding.default_internal&lt;/tt&gt;.</span>
<a name="l02826"></a>02826 <span class="comment"> *</span>
<a name="l02827"></a>02827 <span class="comment"> *  By default, the first and second form raise</span>
<a name="l02828"></a>02828 <span class="comment"> *  Encoding::UndefinedConversionError for characters that are</span>
<a name="l02829"></a>02829 <span class="comment"> *  undefined in the destination encoding, and</span>
<a name="l02830"></a>02830 <span class="comment"> *  Encoding::InvalidByteSequenceError for invalid byte sequences</span>
<a name="l02831"></a>02831 <span class="comment"> *  in the source encoding. The last form by default does not raise</span>
<a name="l02832"></a>02832 <span class="comment"> *  exceptions but uses replacement strings.</span>
<a name="l02833"></a>02833 <span class="comment"> *</span>
<a name="l02834"></a>02834 <span class="comment"> *  The +options+ Hash gives details for conversion and can have the following</span>
<a name="l02835"></a>02835 <span class="comment"> *  keys:</span>
<a name="l02836"></a>02836 <span class="comment"> *</span>
<a name="l02837"></a>02837 <span class="comment"> *  :invalid ::</span>
<a name="l02838"></a>02838 <span class="comment"> *    If the value is +:replace+, #encode replaces invalid byte sequences in</span>
<a name="l02839"></a>02839 <span class="comment"> *    +str+ with the replacement character.  The default is to raise the</span>
<a name="l02840"></a>02840 <span class="comment"> *    Encoding::InvalidByteSequenceError exception</span>
<a name="l02841"></a>02841 <span class="comment"> *  :undef ::</span>
<a name="l02842"></a>02842 <span class="comment"> *    If the value is +:replace+, #encode replaces characters which are</span>
<a name="l02843"></a>02843 <span class="comment"> *    undefined in the destination encoding with the replacement character.</span>
<a name="l02844"></a>02844 <span class="comment"> *    The default is to raise the Encoding::UndefinedConversionError.</span>
<a name="l02845"></a>02845 <span class="comment"> *  :replace ::</span>
<a name="l02846"></a>02846 <span class="comment"> *    Sets the replacement string to the given value. The default replacement</span>
<a name="l02847"></a>02847 <span class="comment"> *    string is &quot;\uFFFD&quot; for Unicode encoding forms, and &quot;?&quot; otherwise.</span>
<a name="l02848"></a>02848 <span class="comment"> *  :fallback ::</span>
<a name="l02849"></a>02849 <span class="comment"> *    Sets the replacement string by the given object for undefined</span>
<a name="l02850"></a>02850 <span class="comment"> *    character.  The object should be a Hash, a Proc, a Method, or an</span>
<a name="l02851"></a>02851 <span class="comment"> *    object which has [] method.</span>
<a name="l02852"></a>02852 <span class="comment"> *    Its key is an undefined character encoded in the source encoding</span>
<a name="l02853"></a>02853 <span class="comment"> *    of current transcoder. Its value can be any encoding until it</span>
<a name="l02854"></a>02854 <span class="comment"> *    can be converted into the destination encoding of the transcoder.</span>
<a name="l02855"></a>02855 <span class="comment"> *  :xml ::</span>
<a name="l02856"></a>02856 <span class="comment"> *    The value must be +:text+ or +:attr+.</span>
<a name="l02857"></a>02857 <span class="comment"> *    If the value is +:text+ #encode replaces undefined characters with their</span>
<a name="l02858"></a>02858 <span class="comment"> *    (upper-case hexadecimal) numeric character references. &apos;&amp;&apos;, &apos;&lt;&apos;, and &apos;&gt;&apos;</span>
<a name="l02859"></a>02859 <span class="comment"> *    are converted to &quot;&amp;amp;&quot;, &quot;&amp;lt;&quot;, and &quot;&amp;gt;&quot;, respectively.</span>
<a name="l02860"></a>02860 <span class="comment"> *    If the value is +:attr+, #encode also quotes the replacement result</span>
<a name="l02861"></a>02861 <span class="comment"> *    (using &apos;&quot;&apos;), and replaces &apos;&quot;&apos; with &quot;&amp;quot;&quot;.</span>
<a name="l02862"></a>02862 <span class="comment"> *  :cr_newline ::</span>
<a name="l02863"></a>02863 <span class="comment"> *    Replaces LF (&quot;\n&quot;) with CR (&quot;\r&quot;) if value is true.</span>
<a name="l02864"></a>02864 <span class="comment"> *  :crlf_newline ::</span>
<a name="l02865"></a>02865 <span class="comment"> *    Replaces LF (&quot;\n&quot;) with CRLF (&quot;\r\n&quot;) if value is true.</span>
<a name="l02866"></a>02866 <span class="comment"> *  :universal_newline ::</span>
<a name="l02867"></a>02867 <span class="comment"> *    Replaces CRLF (&quot;\r\n&quot;) and CR (&quot;\r&quot;) with LF (&quot;\n&quot;) if value is true.</span>
<a name="l02868"></a>02868 <span class="comment"> */</span>
<a name="l02869"></a>02869 
<a name="l02870"></a>02870 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02871"></a><a class="code" href="../../d3/d26/transcode_8c.html#a11b921a25d3b0d83e743dd40547eedf8">02871</a> <a class="code" href="../../d3/d26/transcode_8c.html#a11b921a25d3b0d83e743dd40547eedf8">str_encode</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str)
<a name="l02872"></a>02872 {
<a name="l02873"></a>02873     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> newstr = str;
<a name="l02874"></a>02874     <span class="keywordtype">int</span> encidx = <a class="code" href="../../d3/d26/transcode_8c.html#a95ae7b7fadaf5cc9e67b9a03975a8496">str_transcode</a>(argc, argv, &amp;newstr);
<a name="l02875"></a>02875     <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a97454b08a20769bc3a670889f613c71d">encoded_dup</a>(newstr, str, encidx);
<a name="l02876"></a>02876 }
<a name="l02877"></a>02877 
<a name="l02878"></a>02878 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02879"></a><a class="code" href="../../d3/d26/transcode_8c.html#a92c4c79471eb00ba915287505a118401">02879</a> <a class="code" href="../../d5/de3/encoding_8h.html#a92c4c79471eb00ba915287505a118401">rb_str_encode</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> to, <span class="keywordtype">int</span> ecflags, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ecopts)
<a name="l02880"></a>02880 {
<a name="l02881"></a>02881     <span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a> = 1;
<a name="l02882"></a>02882     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a> = &amp;to;
<a name="l02883"></a>02883     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> newstr = str;
<a name="l02884"></a>02884     <span class="keywordtype">int</span> encidx = <a class="code" href="../../d3/d26/transcode_8c.html#a40793efc243ce9a8e34531413dbdc1b6">str_transcode0</a>(argc, argv, &amp;newstr, ecflags, ecopts);
<a name="l02885"></a>02885     <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a97454b08a20769bc3a670889f613c71d">encoded_dup</a>(newstr, str, encidx);
<a name="l02886"></a>02886 }
<a name="l02887"></a>02887 
<a name="l02888"></a>02888 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02889"></a><a class="code" href="../../d3/d26/transcode_8c.html#a97454b08a20769bc3a670889f613c71d">02889</a> <a class="code" href="../../d3/d26/transcode_8c.html#a97454b08a20769bc3a670889f613c71d">encoded_dup</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> newstr, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, <span class="keywordtype">int</span> encidx)
<a name="l02890"></a>02890 {
<a name="l02891"></a>02891     <span class="keywordflow">if</span> (encidx &lt; 0) <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#ae2843c766c24b80116bb127ebf22d5bf">rb_str_dup</a>(str);
<a name="l02892"></a>02892     <span class="keywordflow">if</span> (newstr == str) {
<a name="l02893"></a>02893         newstr = <a class="code" href="../../db/d2e/intern_8h.html#ae2843c766c24b80116bb127ebf22d5bf">rb_str_dup</a>(str);
<a name="l02894"></a>02894     }
<a name="l02895"></a>02895     <span class="keywordflow">else</span> {
<a name="l02896"></a>02896         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1d4c05021aacd8cab989ff60f95ebe2d">RBASIC</a>(newstr)-&gt;klass = <a class="code" href="../../db/d2e/intern_8h.html#ac2be7243e739fa8f5dce6be0c8ee5f6d">rb_obj_class</a>(str);
<a name="l02897"></a>02897     }
<a name="l02898"></a>02898     <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a0d9a8b092b441da2ff1b4dbe8d2d5cd2">str_encode_associate</a>(newstr, encidx);
<a name="l02899"></a>02899 }
<a name="l02900"></a>02900 
<a name="l02901"></a>02901 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02902"></a><a class="code" href="../../d3/d26/transcode_8c.html#a1fddce1431e6cd2273a93cb857d009de">02902</a> <a class="code" href="../../d3/d26/transcode_8c.html#a1fddce1431e6cd2273a93cb857d009de">econv_free</a>(<span class="keywordtype">void</span> *ptr)
<a name="l02903"></a>02903 {
<a name="l02904"></a>02904     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec = ptr;
<a name="l02905"></a>02905     <a class="code" href="../../d5/de3/encoding_8h.html#adaf53306799f8796d7e6437bc98d0b0e">rb_econv_close</a>(ec);
<a name="l02906"></a>02906 }
<a name="l02907"></a>02907 
<a name="l02908"></a>02908 <span class="keyword">static</span> <span class="keywordtype">size_t</span>
<a name="l02909"></a><a class="code" href="../../d3/d26/transcode_8c.html#a55de930c80b42ba164a7b2f971f31c7e">02909</a> <a class="code" href="../../d3/d26/transcode_8c.html#a55de930c80b42ba164a7b2f971f31c7e">econv_memsize</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *ptr)
<a name="l02910"></a>02910 {
<a name="l02911"></a>02911     <span class="keywordflow">return</span> ptr ? <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a>) : 0;
<a name="l02912"></a>02912 }
<a name="l02913"></a>02913 
<a name="l02914"></a><a class="code" href="../../d3/d26/transcode_8c.html#a9a8f281af720ed975bf9bdf36a44d6ce">02914</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="../../d7/de2/structrb__data__type__struct.html">rb_data_type_t</a> <a class="code" href="../../d3/d26/transcode_8c.html#a9a8f281af720ed975bf9bdf36a44d6ce">econv_data_type</a> = {
<a name="l02915"></a>02915     <span class="stringliteral">&quot;econv&quot;</span>,
<a name="l02916"></a>02916     {<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, <a class="code" href="../../d3/d26/transcode_8c.html#a1fddce1431e6cd2273a93cb857d009de">econv_free</a>, <a class="code" href="../../d3/d26/transcode_8c.html#a55de930c80b42ba164a7b2f971f31c7e">econv_memsize</a>,},
<a name="l02917"></a>02917 };
<a name="l02918"></a>02918 
<a name="l02919"></a>02919 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02920"></a><a class="code" href="../../d3/d26/transcode_8c.html#a0a347fc203d4703ec5c9b35d039adbf2">02920</a> <a class="code" href="../../d3/d26/transcode_8c.html#a0a347fc203d4703ec5c9b35d039adbf2">econv_s_allocate</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass)
<a name="l02921"></a>02921 {
<a name="l02922"></a>02922     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa3094c0054b80ec2a7e50f9fe1e5f4b2">TypedData_Wrap_Struct</a>(klass, &amp;econv_data_type, <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);
<a name="l02923"></a>02923 }
<a name="l02924"></a>02924 
<a name="l02925"></a>02925 <span class="keyword">static</span> <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *
<a name="l02926"></a><a class="code" href="../../d3/d26/transcode_8c.html#a1ca76b51d88a29b92635d44aa1f0f2d0">02926</a> <a class="code" href="../../d3/d26/transcode_8c.html#a1ca76b51d88a29b92635d44aa1f0f2d0">make_dummy_encoding</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)
<a name="l02927"></a>02927 {
<a name="l02928"></a>02928     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc;
<a name="l02929"></a>02929     <span class="keywordtype">int</span> idx;
<a name="l02930"></a>02930     idx = <a class="code" href="../../d5/db5/encoding_8c.html#a873f1c2ba114f13f45b84990a5a595b7">rb_define_dummy_encoding</a>(name);
<a name="l02931"></a>02931     enc = <a class="code" href="../../d5/db5/encoding_8c.html#aef9c377b2d9d78b9f88e890b77593109">rb_enc_from_index</a>(idx);
<a name="l02932"></a>02932     <span class="keywordflow">return</span> enc;
<a name="l02933"></a>02933 }
<a name="l02934"></a>02934 
<a name="l02935"></a>02935 <span class="keyword">static</span> <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *
<a name="l02936"></a><a class="code" href="../../d3/d26/transcode_8c.html#a815d8d7fbb499f44235c5435b685bdec">02936</a> <a class="code" href="../../d3/d26/transcode_8c.html#a815d8d7fbb499f44235c5435b685bdec">make_encoding</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)
<a name="l02937"></a>02937 {
<a name="l02938"></a>02938     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc;
<a name="l02939"></a>02939     enc = <a class="code" href="../../d5/db5/encoding_8c.html#a67638c695b4079ca5f4b6b4cc22ab27a">rb_enc_find</a>(name);
<a name="l02940"></a>02940     <span class="keywordflow">if</span> (!enc)
<a name="l02941"></a>02941         enc = <a class="code" href="../../d3/d26/transcode_8c.html#a1ca76b51d88a29b92635d44aa1f0f2d0">make_dummy_encoding</a>(name);
<a name="l02942"></a>02942     <span class="keywordflow">return</span> enc;
<a name="l02943"></a>02943 }
<a name="l02944"></a>02944 
<a name="l02945"></a>02945 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02946"></a><a class="code" href="../../d3/d26/transcode_8c.html#a8b7f627a139e8ebf1095c2ad647eac96">02946</a> <a class="code" href="../../d3/d26/transcode_8c.html#a8b7f627a139e8ebf1095c2ad647eac96">make_encobj</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)
<a name="l02947"></a>02947 {
<a name="l02948"></a>02948     <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a815d8d7fbb499f44235c5435b685bdec">make_encoding</a>(name));
<a name="l02949"></a>02949 }
<a name="l02950"></a>02950 
<a name="l02951"></a>02951 <span class="comment">/*</span>
<a name="l02952"></a>02952 <span class="comment"> * call-seq:</span>
<a name="l02953"></a>02953 <span class="comment"> *   Encoding::Converter.asciicompat_encoding(string) -&gt; encoding or nil</span>
<a name="l02954"></a>02954 <span class="comment"> *   Encoding::Converter.asciicompat_encoding(encoding) -&gt; encoding or nil</span>
<a name="l02955"></a>02955 <span class="comment"> *</span>
<a name="l02956"></a>02956 <span class="comment"> * Returns the corresponding ASCII compatible encoding.</span>
<a name="l02957"></a>02957 <span class="comment"> *</span>
<a name="l02958"></a>02958 <span class="comment"> * Returns nil if the argument is an ASCII compatible encoding.</span>
<a name="l02959"></a>02959 <span class="comment"> *</span>
<a name="l02960"></a>02960 <span class="comment"> * &quot;corresponding ASCII compatible encoding&quot; is a ASCII compatible encoding which</span>
<a name="l02961"></a>02961 <span class="comment"> * can represents exactly the same characters as the given ASCII incompatible encoding.</span>
<a name="l02962"></a>02962 <span class="comment"> * So, no conversion undefined error occurs when converting between the two encodings.</span>
<a name="l02963"></a>02963 <span class="comment"> *</span>
<a name="l02964"></a>02964 <span class="comment"> *   Encoding::Converter.asciicompat_encoding(&quot;ISO-2022-JP&quot;) #=&gt; #&lt;Encoding:stateless-ISO-2022-JP&gt;</span>
<a name="l02965"></a>02965 <span class="comment"> *   Encoding::Converter.asciicompat_encoding(&quot;UTF-16BE&quot;) #=&gt; #&lt;Encoding:UTF-8&gt;</span>
<a name="l02966"></a>02966 <span class="comment"> *   Encoding::Converter.asciicompat_encoding(&quot;UTF-8&quot;) #=&gt; nil</span>
<a name="l02967"></a>02967 <span class="comment"> *</span>
<a name="l02968"></a>02968 <span class="comment"> */</span>
<a name="l02969"></a>02969 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02970"></a><a class="code" href="../../d3/d26/transcode_8c.html#a6cd6cfcca75c2ca0e7a809a3c6e37a4b">02970</a> <a class="code" href="../../d3/d26/transcode_8c.html#a6cd6cfcca75c2ca0e7a809a3c6e37a4b">econv_s_asciicompat_encoding</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l02971"></a>02971 {
<a name="l02972"></a>02972     <span class="keyword">const</span> <span class="keywordtype">char</span> *arg_name, *result_name;
<a name="l02973"></a>02973     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *arg_enc, *result_enc;
<a name="l02974"></a>02974 
<a name="l02975"></a>02975     <a class="code" href="../../d3/d26/transcode_8c.html#a87f3c41a3f6c759a2a71313985efa202">enc_arg</a>(&amp;arg, &amp;arg_name, &amp;arg_enc);
<a name="l02976"></a>02976 
<a name="l02977"></a>02977     result_name = <a class="code" href="../../d5/de3/encoding_8h.html#aa74ee304630f931586c6da5bbf3ee810">rb_econv_asciicompat_encoding</a>(arg_name);
<a name="l02978"></a>02978 
<a name="l02979"></a>02979     <span class="keywordflow">if</span> (result_name == <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>)
<a name="l02980"></a>02980         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02981"></a>02981 
<a name="l02982"></a>02982     result_enc = <a class="code" href="../../d3/d26/transcode_8c.html#a815d8d7fbb499f44235c5435b685bdec">make_encoding</a>(result_name);
<a name="l02983"></a>02983 
<a name="l02984"></a>02984     <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(result_enc);
<a name="l02985"></a>02985 }
<a name="l02986"></a>02986 
<a name="l02987"></a>02987 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l02988"></a><a class="code" href="../../d3/d26/transcode_8c.html#a27694dd414bf9d3175f2f45bbfb7cc3f">02988</a> <a class="code" href="../../d3/d26/transcode_8c.html#a27694dd414bf9d3175f2f45bbfb7cc3f">econv_args</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>,
<a name="l02989"></a>02989     <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *snamev_p, <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *dnamev_p,
<a name="l02990"></a>02990     <span class="keyword">const</span> <span class="keywordtype">char</span> **sname_p, <span class="keyword">const</span> <span class="keywordtype">char</span> **dname_p,
<a name="l02991"></a>02991     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> **senc_p, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> **denc_p,
<a name="l02992"></a>02992     <span class="keywordtype">int</span> *ecflags_p,
<a name="l02993"></a>02993     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *ecopts_p)
<a name="l02994"></a>02994 {
<a name="l02995"></a>02995     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opt, flags_v, ecopts;
<a name="l02996"></a>02996     <span class="keywordtype">int</span> sidx, didx;
<a name="l02997"></a>02997     <span class="keyword">const</span> <span class="keywordtype">char</span> *sname, *dname;
<a name="l02998"></a>02998     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *senc, *denc;
<a name="l02999"></a>02999     <span class="keywordtype">int</span> ecflags;
<a name="l03000"></a>03000 
<a name="l03001"></a>03001     argc = <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;21:&quot;</span>, snamev_p, dnamev_p, &amp;flags_v, &amp;opt);
<a name="l03002"></a>03002 
<a name="l03003"></a>03003     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(flags_v)) {
<a name="l03004"></a>03004         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(opt)) {
<a name="l03005"></a>03005             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;wrong number of arguments (%d for 2..3)&quot;</span>,
<a name="l03006"></a>03006                 argc + 1);
<a name="l03007"></a>03007         }
<a name="l03008"></a>03008         ecflags = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(<a class="code" href="../../db/d2e/intern_8h.html#ae98f9e6c1a4b5181ca48e36d06b3157b">rb_to_int</a>(flags_v));
<a name="l03009"></a>03009         ecopts = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03010"></a>03010     }
<a name="l03011"></a>03011     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(opt)) {
<a name="l03012"></a>03012         ecflags = <a class="code" href="../../d5/de3/encoding_8h.html#a1eba00da8f7d32896009a279a9edca25">rb_econv_prepare_opts</a>(opt, &amp;ecopts);
<a name="l03013"></a>03013     }
<a name="l03014"></a>03014     <span class="keywordflow">else</span> {
<a name="l03015"></a>03015         ecflags = 0;
<a name="l03016"></a>03016         ecopts = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03017"></a>03017     }
<a name="l03018"></a>03018 
<a name="l03019"></a>03019     senc = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03020"></a>03020     sidx = <a class="code" href="../../d5/db5/encoding_8c.html#a13a97a6605eca1509135ff473bf346b6">rb_to_encoding_index</a>(*snamev_p);
<a name="l03021"></a>03021     <span class="keywordflow">if</span> (0 &lt;= sidx) {
<a name="l03022"></a>03022         senc = <a class="code" href="../../d5/db5/encoding_8c.html#aef9c377b2d9d78b9f88e890b77593109">rb_enc_from_index</a>(sidx);
<a name="l03023"></a>03023     }
<a name="l03024"></a>03024     <span class="keywordflow">else</span> {
<a name="l03025"></a>03025         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(*snamev_p);
<a name="l03026"></a>03026     }
<a name="l03027"></a>03027 
<a name="l03028"></a>03028     denc = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03029"></a>03029     didx = <a class="code" href="../../d5/db5/encoding_8c.html#a13a97a6605eca1509135ff473bf346b6">rb_to_encoding_index</a>(*dnamev_p);
<a name="l03030"></a>03030     <span class="keywordflow">if</span> (0 &lt;= didx) {
<a name="l03031"></a>03031         denc = <a class="code" href="../../d5/db5/encoding_8c.html#aef9c377b2d9d78b9f88e890b77593109">rb_enc_from_index</a>(didx);
<a name="l03032"></a>03032     }
<a name="l03033"></a>03033     <span class="keywordflow">else</span> {
<a name="l03034"></a>03034         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(*dnamev_p);
<a name="l03035"></a>03035     }
<a name="l03036"></a>03036 
<a name="l03037"></a>03037     sname = senc ? <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(senc) : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(*snamev_p);
<a name="l03038"></a>03038     dname = denc ? <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(denc) : <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(*dnamev_p);
<a name="l03039"></a>03039 
<a name="l03040"></a>03040     *sname_p = sname;
<a name="l03041"></a>03041     *dname_p = dname;
<a name="l03042"></a>03042     *senc_p = senc;
<a name="l03043"></a>03043     *denc_p = denc;
<a name="l03044"></a>03044     *ecflags_p = ecflags;
<a name="l03045"></a>03045     *ecopts_p = ecopts;
<a name="l03046"></a>03046 }
<a name="l03047"></a>03047 
<a name="l03048"></a>03048 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l03049"></a><a class="code" href="../../d3/d26/transcode_8c.html#a9fe8789e97a669b8c0a5f43b1071a3cb">03049</a> <a class="code" href="../../d3/d26/transcode_8c.html#a9fe8789e97a669b8c0a5f43b1071a3cb">decorate_convpath</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> convpath, <span class="keywordtype">int</span> ecflags)
<a name="l03050"></a>03050 {
<a name="l03051"></a>03051     <span class="keywordtype">int</span> num_decorators;
<a name="l03052"></a>03052     <span class="keyword">const</span> <span class="keywordtype">char</span> *decorators[<a class="code" href="../../d3/d26/transcode_8c.html#acd3ef07bd13c8bb9dd12a7aaff4fd0a1">MAX_ECFLAGS_DECORATORS</a>];
<a name="l03053"></a>03053     <span class="keywordtype">int</span> i;
<a name="l03054"></a>03054     <span class="keywordtype">int</span> n, <a class="code" href="../../d3/d15/name2ctype_8h.html#aed1cc4dca5d94cb452f79691f54f7423">len</a>;
<a name="l03055"></a>03055 
<a name="l03056"></a>03056     num_decorators = <a class="code" href="../../d3/d26/transcode_8c.html#a20f5177a1affe9471f536f9ace54b42e">decorator_names</a>(ecflags, decorators);
<a name="l03057"></a>03057     <span class="keywordflow">if</span> (num_decorators == -1)
<a name="l03058"></a>03058         <span class="keywordflow">return</span> -1;
<a name="l03059"></a>03059 
<a name="l03060"></a>03060     len = n = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a28084c7ad47ec550165c87e447e8356e">RARRAY_LENINT</a>(convpath);
<a name="l03061"></a>03061     <span class="keywordflow">if</span> (n != 0) {
<a name="l03062"></a>03062         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> pair = <a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(convpath)[n-1];
<a name="l03063"></a>03063         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a394faf7191f18552a20cb17ce14226f0">TYPE</a>(pair) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a>) {
<a name="l03064"></a>03064             <span class="keyword">const</span> <span class="keywordtype">char</span> *sname = <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(<a class="code" href="../../d5/db5/encoding_8c.html#a73a17b842b857bdaf2062107fe898304">rb_to_encoding</a>(<a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(pair)[0]));
<a name="l03065"></a>03065             <span class="keyword">const</span> <span class="keywordtype">char</span> *dname = <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(<a class="code" href="../../d5/db5/encoding_8c.html#a73a17b842b857bdaf2062107fe898304">rb_to_encoding</a>(<a class="code" href="../../d8/df4/generator_8h.html#abb794fe2d7c73eea87e7ba2273939a8e">RARRAY_PTR</a>(pair)[1]));
<a name="l03066"></a>03066             <a class="code" href="../../d0/dce/structtranscoder__entry__t.html">transcoder_entry_t</a> *entry = <a class="code" href="../../d3/d26/transcode_8c.html#a0d3a31f80907a117b9c8b3170e3f8bbd">get_transcoder_entry</a>(sname, dname);
<a name="l03067"></a>03067             <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a> = <a class="code" href="../../d3/d26/transcode_8c.html#adb7762bdd8e4e7e429d3aea08468d936">load_transcoder_entry</a>(entry);
<a name="l03068"></a>03068             <span class="keywordflow">if</span> (!tr)
<a name="l03069"></a>03069                 <span class="keywordflow">return</span> -1;
<a name="l03070"></a>03070             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d26/transcode_8c.html#a7a9d71f951b9b292988b798f4f6bc29b">DECORATOR_P</a>(tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a6f79077ecbd8da45cc181b53dc280a90">src_encoding</a>, tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a06f17fbc59c9055646b1a147d05f33eb">dst_encoding</a>) &amp;&amp;
<a name="l03071"></a>03071                     tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#abe099f27f11c75c44025c06a2facdd74">asciicompat_type</a> == <a class="code" href="../../d1/daa/transcode__data_8h.html#adb434037dc10de8e7522f906cd7a8198ad010137686b51916bbf36c9595e89d61">asciicompat_encoder</a>) {
<a name="l03072"></a>03072                 n--;
<a name="l03073"></a>03073                 <a class="code" href="../../dc/dcc/array_8c.html#a1d7683de2cd34217808092d90ffd0869">rb_ary_store</a>(convpath, len + num_decorators - 1, pair);
<a name="l03074"></a>03074             }
<a name="l03075"></a>03075         }
<a name="l03076"></a>03076         <span class="keywordflow">else</span> {
<a name="l03077"></a>03077             <a class="code" href="../../dc/dcc/array_8c.html#a1d7683de2cd34217808092d90ffd0869">rb_ary_store</a>(convpath, len + num_decorators - 1, pair);
<a name="l03078"></a>03078         }
<a name="l03079"></a>03079     }
<a name="l03080"></a>03080 
<a name="l03081"></a>03081     <span class="keywordflow">for</span> (i = 0; i &lt; num_decorators; i++)
<a name="l03082"></a>03082         <a class="code" href="../../dc/dcc/array_8c.html#a1d7683de2cd34217808092d90ffd0869">rb_ary_store</a>(convpath, n + i, <a class="code" href="../../db/d2e/intern_8h.html#a2b9cc485b0aa1dc270744b8b9eb47569">rb_str_new_cstr</a>(decorators[i]));
<a name="l03083"></a>03083 
<a name="l03084"></a>03084     <span class="keywordflow">return</span> 0;
<a name="l03085"></a>03085 }
<a name="l03086"></a>03086 
<a name="l03087"></a>03087 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l03088"></a><a class="code" href="../../d3/d26/transcode_8c.html#ae634b8bb2e698a756685354cf02b0c38">03088</a> <a class="code" href="../../d3/d26/transcode_8c.html#ae634b8bb2e698a756685354cf02b0c38">search_convpath_i</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sname, <span class="keyword">const</span> <span class="keywordtype">char</span> *dname, <span class="keywordtype">int</span> depth, <span class="keywordtype">void</span> *arg)
<a name="l03089"></a>03089 {
<a name="l03090"></a>03090     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *ary_p = arg;
<a name="l03091"></a>03091     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v;
<a name="l03092"></a>03092 
<a name="l03093"></a>03093     <span class="keywordflow">if</span> (*ary_p == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>) {
<a name="l03094"></a>03094         *ary_p = <a class="code" href="../../dc/dcc/array_8c.html#a9518114fd36cb4ef4656ec1dc63348c9">rb_ary_new</a>();
<a name="l03095"></a>03095     }
<a name="l03096"></a>03096 
<a name="l03097"></a>03097     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#a7a9d71f951b9b292988b798f4f6bc29b">DECORATOR_P</a>(sname, dname)) {
<a name="l03098"></a>03098         v = <a class="code" href="../../db/d2e/intern_8h.html#a2b9cc485b0aa1dc270744b8b9eb47569">rb_str_new_cstr</a>(dname);
<a name="l03099"></a>03099     }
<a name="l03100"></a>03100     <span class="keywordflow">else</span> {
<a name="l03101"></a>03101         v = <a class="code" href="../../dc/dcc/array_8c.html#af3085ceab406e3f4f4b90f383c440d6a">rb_assoc_new</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a8b7f627a139e8ebf1095c2ad647eac96">make_encobj</a>(sname), <a class="code" href="../../d3/d26/transcode_8c.html#a8b7f627a139e8ebf1095c2ad647eac96">make_encobj</a>(dname));
<a name="l03102"></a>03102     }
<a name="l03103"></a>03103     <a class="code" href="../../dc/dcc/array_8c.html#a1d7683de2cd34217808092d90ffd0869">rb_ary_store</a>(*ary_p, depth, v);
<a name="l03104"></a>03104 }
<a name="l03105"></a>03105 
<a name="l03106"></a>03106 <span class="comment">/*</span>
<a name="l03107"></a>03107 <span class="comment"> * call-seq:</span>
<a name="l03108"></a>03108 <span class="comment"> *   Encoding::Converter.search_convpath(source_encoding, destination_encoding)         -&gt; ary</span>
<a name="l03109"></a>03109 <span class="comment"> *   Encoding::Converter.search_convpath(source_encoding, destination_encoding, opt)    -&gt; ary</span>
<a name="l03110"></a>03110 <span class="comment"> *</span>
<a name="l03111"></a>03111 <span class="comment"> *  Returns a conversion path.</span>
<a name="l03112"></a>03112 <span class="comment"> *</span>
<a name="l03113"></a>03113 <span class="comment"> *   p Encoding::Converter.search_convpath(&quot;ISO-8859-1&quot;, &quot;EUC-JP&quot;)</span>
<a name="l03114"></a>03114 <span class="comment"> *   #=&gt; [[#&lt;Encoding:ISO-8859-1&gt;, #&lt;Encoding:UTF-8&gt;],</span>
<a name="l03115"></a>03115 <span class="comment"> *   #    [#&lt;Encoding:UTF-8&gt;, #&lt;Encoding:EUC-JP&gt;]]</span>
<a name="l03116"></a>03116 <span class="comment"> *</span>
<a name="l03117"></a>03117 <span class="comment"> *   p Encoding::Converter.search_convpath(&quot;ISO-8859-1&quot;, &quot;EUC-JP&quot;, universal_newline: true)</span>
<a name="l03118"></a>03118 <span class="comment"> *   or</span>
<a name="l03119"></a>03119 <span class="comment"> *   p Encoding::Converter.search_convpath(&quot;ISO-8859-1&quot;, &quot;EUC-JP&quot;, newline: :universal)</span>
<a name="l03120"></a>03120 <span class="comment"> *   #=&gt; [[#&lt;Encoding:ISO-8859-1&gt;, #&lt;Encoding:UTF-8&gt;],</span>
<a name="l03121"></a>03121 <span class="comment"> *   #    [#&lt;Encoding:UTF-8&gt;, #&lt;Encoding:EUC-JP&gt;],</span>
<a name="l03122"></a>03122 <span class="comment"> *   #    &quot;universal_newline&quot;]</span>
<a name="l03123"></a>03123 <span class="comment"> *</span>
<a name="l03124"></a>03124 <span class="comment"> *   p Encoding::Converter.search_convpath(&quot;ISO-8859-1&quot;, &quot;UTF-32BE&quot;, universal_newline: true)</span>
<a name="l03125"></a>03125 <span class="comment"> *   or</span>
<a name="l03126"></a>03126 <span class="comment"> *   p Encoding::Converter.search_convpath(&quot;ISO-8859-1&quot;, &quot;UTF-32BE&quot;, newline: :universal)</span>
<a name="l03127"></a>03127 <span class="comment"> *   #=&gt; [[#&lt;Encoding:ISO-8859-1&gt;, #&lt;Encoding:UTF-8&gt;],</span>
<a name="l03128"></a>03128 <span class="comment"> *   #    &quot;universal_newline&quot;,</span>
<a name="l03129"></a>03129 <span class="comment"> *   #    [#&lt;Encoding:UTF-8&gt;, #&lt;Encoding:UTF-32BE&gt;]]</span>
<a name="l03130"></a>03130 <span class="comment"> */</span>
<a name="l03131"></a>03131 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03132"></a><a class="code" href="../../d3/d26/transcode_8c.html#ab1e1d65c8eab3b2c54159d45fe60027d">03132</a> <a class="code" href="../../d3/d26/transcode_8c.html#ab1e1d65c8eab3b2c54159d45fe60027d">econv_s_search_convpath</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass)
<a name="l03133"></a>03133 {
<a name="l03134"></a>03134     <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> snamev, dnamev;
<a name="l03135"></a>03135     <span class="keyword">const</span> <span class="keywordtype">char</span> *sname, *dname;
<a name="l03136"></a>03136     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *senc, *denc;
<a name="l03137"></a>03137     <span class="keywordtype">int</span> ecflags;
<a name="l03138"></a>03138     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ecopts;
<a name="l03139"></a>03139     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> convpath;
<a name="l03140"></a>03140 
<a name="l03141"></a>03141     <a class="code" href="../../d3/d26/transcode_8c.html#a27694dd414bf9d3175f2f45bbfb7cc3f">econv_args</a>(argc, argv, &amp;snamev, &amp;dnamev, &amp;sname, &amp;dname, &amp;senc, &amp;denc, &amp;ecflags, &amp;ecopts);
<a name="l03142"></a>03142 
<a name="l03143"></a>03143     convpath = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03144"></a>03144     <a class="code" href="../../d3/d26/transcode_8c.html#afc49640284e9c9fdda17cea6952a4026">transcode_search_path</a>(sname, dname, <a class="code" href="../../d3/d26/transcode_8c.html#ae634b8bb2e698a756685354cf02b0c38">search_convpath_i</a>, &amp;convpath);
<a name="l03145"></a>03145 
<a name="l03146"></a>03146     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(convpath))
<a name="l03147"></a>03147         <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a0dbeff3af14fde49b20f00fde25057d0">rb_econv_open_exc</a>(sname, dname, ecflags));
<a name="l03148"></a>03148 
<a name="l03149"></a>03149     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#a9fe8789e97a669b8c0a5f43b1071a3cb">decorate_convpath</a>(convpath, ecflags) == -1)
<a name="l03150"></a>03150         <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a0dbeff3af14fde49b20f00fde25057d0">rb_econv_open_exc</a>(sname, dname, ecflags));
<a name="l03151"></a>03151 
<a name="l03152"></a>03152     <span class="keywordflow">return</span> convpath;
<a name="l03153"></a>03153 }
<a name="l03154"></a>03154 
<a name="l03155"></a>03155 <span class="comment">/*</span>
<a name="l03156"></a>03156 <span class="comment"> * Check the existence of a conversion path.</span>
<a name="l03157"></a>03157 <span class="comment"> * Returns the number of converters in the conversion path.</span>
<a name="l03158"></a>03158 <span class="comment"> * result: &gt;=0:success -1:failure</span>
<a name="l03159"></a>03159 <span class="comment"> */</span>
<a name="l03160"></a>03160 <span class="keywordtype">int</span>
<a name="l03161"></a><a class="code" href="../../d3/d26/transcode_8c.html#a3e28fc72b6e64a4ace21bace4a1bf040">03161</a> <a class="code" href="../../d5/de3/encoding_8h.html#a3e28fc72b6e64a4ace21bace4a1bf040">rb_econv_has_convpath_p</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* from_encoding, <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="../../d5/db5/encoding_8c.html#a4bc9d2651623d5c9fe7d7353a57e0be4">to_encoding</a>)
<a name="l03162"></a>03162 {
<a name="l03163"></a>03163     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> convpath = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03164"></a>03164     <a class="code" href="../../d3/d26/transcode_8c.html#afc49640284e9c9fdda17cea6952a4026">transcode_search_path</a>(from_encoding, to_encoding, <a class="code" href="../../d3/d26/transcode_8c.html#ae634b8bb2e698a756685354cf02b0c38">search_convpath_i</a>,
<a name="l03165"></a>03165                           &amp;convpath);
<a name="l03166"></a>03166     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(convpath);
<a name="l03167"></a>03167 }
<a name="l03168"></a>03168 
<a name="l03169"></a><a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html">03169</a> <span class="keyword">struct </span><a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html">rb_econv_init_by_convpath_t</a> {
<a name="l03170"></a><a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html#a6aadae4552a424e03595a97fe605a2ce">03170</a>     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec;
<a name="l03171"></a><a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html#a6ea790bce2accb73f7f92b097401b90f">03171</a>     <span class="keywordtype">int</span> <a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html#a6ea790bce2accb73f7f92b097401b90f">index</a>;
<a name="l03172"></a><a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html#a557858d66ff617f7f7ab8ea38a0eb2c8">03172</a>     <span class="keywordtype">int</span> ret;
<a name="l03173"></a>03173 };
<a name="l03174"></a>03174 
<a name="l03175"></a>03175 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l03176"></a><a class="code" href="../../d3/d26/transcode_8c.html#a3f7759c2f6a6b2afcc467d85e39c2f3d">03176</a> <a class="code" href="../../d3/d26/transcode_8c.html#a3f7759c2f6a6b2afcc467d85e39c2f3d">rb_econv_init_by_convpath_i</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sname, <span class="keyword">const</span> <span class="keywordtype">char</span> *dname, <span class="keywordtype">int</span> depth, <span class="keywordtype">void</span> *arg)
<a name="l03177"></a>03177 {
<a name="l03178"></a>03178     <span class="keyword">struct </span><a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html">rb_econv_init_by_convpath_t</a> *a = (<span class="keyword">struct </span><a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html">rb_econv_init_by_convpath_t</a> *)arg;
<a name="l03179"></a>03179     <span class="keywordtype">int</span> ret;
<a name="l03180"></a>03180 
<a name="l03181"></a>03181     <span class="keywordflow">if</span> (a-&gt;<a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html#a557858d66ff617f7f7ab8ea38a0eb2c8">ret</a> == -1)
<a name="l03182"></a>03182         <span class="keywordflow">return</span>;
<a name="l03183"></a>03183 
<a name="l03184"></a>03184     ret = <a class="code" href="../../d3/d26/transcode_8c.html#ad5afa704b6216a89daab4c8dd0357f52">rb_econv_add_converter</a>(a-&gt;<a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html#a6aadae4552a424e03595a97fe605a2ce">ec</a>, sname, dname, a-&gt;<a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html#a6ea790bce2accb73f7f92b097401b90f">index</a>);
<a name="l03185"></a>03185 
<a name="l03186"></a>03186     a-&gt;<a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html#a557858d66ff617f7f7ab8ea38a0eb2c8">ret</a> = ret;
<a name="l03187"></a>03187     <span class="keywordflow">return</span>;
<a name="l03188"></a>03188 }
<a name="l03189"></a>03189 
<a name="l03190"></a>03190 <span class="keyword">static</span> <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *
<a name="l03191"></a><a class="code" href="../../d3/d26/transcode_8c.html#aed19af9394a75c64ddca4e14fa83db12">03191</a> <a class="code" href="../../d3/d26/transcode_8c.html#aed19af9394a75c64ddca4e14fa83db12">rb_econv_init_by_convpath</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> convpath,
<a name="l03192"></a>03192     <span class="keyword">const</span> <span class="keywordtype">char</span> **sname_p, <span class="keyword">const</span> <span class="keywordtype">char</span> **dname_p,
<a name="l03193"></a>03193     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> **senc_p, <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a>**denc_p)
<a name="l03194"></a>03194 {
<a name="l03195"></a>03195     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec;
<a name="l03196"></a>03196     <span class="keywordtype">long</span> i;
<a name="l03197"></a>03197     <span class="keywordtype">int</span> ret, first=1;
<a name="l03198"></a>03198     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> elt;
<a name="l03199"></a>03199     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *senc = 0, *denc = 0;
<a name="l03200"></a>03200     <span class="keyword">const</span> <span class="keywordtype">char</span> *sname, *dname;
<a name="l03201"></a>03201 
<a name="l03202"></a>03202     ec = <a class="code" href="../../d3/d26/transcode_8c.html#a0f64078d94078a76b5e3756471b95fa7">rb_econv_alloc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a28084c7ad47ec550165c87e447e8356e">RARRAY_LENINT</a>(convpath));
<a name="l03203"></a>03203     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abb509cfdf6560a9f795b1f6932d93691">DATA_PTR</a>(<span class="keyword">self</span>) = ec;
<a name="l03204"></a>03204 
<a name="l03205"></a>03205     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(convpath); i++) {
<a name="l03206"></a>03206         <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> snamev, dnamev;
<a name="l03207"></a>03207         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> pair;
<a name="l03208"></a>03208         elt = <a class="code" href="../../dc/dcc/array_8c.html#ae3c2ac6c88e666d5418855114eb8bcf8">rb_ary_entry</a>(convpath, i);
<a name="l03209"></a>03209         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(pair = <a class="code" href="../../dc/dcc/array_8c.html#aaa66361aff757dd7ef869f5b84b3793e">rb_check_array_type</a>(elt))) {
<a name="l03210"></a>03210             <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(pair) != 2)
<a name="l03211"></a>03211                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;not a 2-element array in convpath&quot;</span>);
<a name="l03212"></a>03212             snamev = <a class="code" href="../../dc/dcc/array_8c.html#ae3c2ac6c88e666d5418855114eb8bcf8">rb_ary_entry</a>(pair, 0);
<a name="l03213"></a>03213             <a class="code" href="../../d3/d26/transcode_8c.html#a87f3c41a3f6c759a2a71313985efa202">enc_arg</a>(&amp;snamev, &amp;sname, &amp;senc);
<a name="l03214"></a>03214             dnamev = <a class="code" href="../../dc/dcc/array_8c.html#ae3c2ac6c88e666d5418855114eb8bcf8">rb_ary_entry</a>(pair, 1);
<a name="l03215"></a>03215             <a class="code" href="../../d3/d26/transcode_8c.html#a87f3c41a3f6c759a2a71313985efa202">enc_arg</a>(&amp;dnamev, &amp;dname, &amp;denc);
<a name="l03216"></a>03216         }
<a name="l03217"></a>03217         <span class="keywordflow">else</span> {
<a name="l03218"></a>03218             sname = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03219"></a>03219             dname = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afc32c1526ac6cb40ec33cad8782c0bae">StringValueCStr</a>(elt);
<a name="l03220"></a>03220         }
<a name="l03221"></a>03221         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#a7a9d71f951b9b292988b798f4f6bc29b">DECORATOR_P</a>(sname, dname)) {
<a name="l03222"></a>03222             ret = <a class="code" href="../../d3/d26/transcode_8c.html#ad5afa704b6216a89daab4c8dd0357f52">rb_econv_add_converter</a>(ec, sname, dname, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>);
<a name="l03223"></a>03223             <span class="keywordflow">if</span> (ret == -1)
<a name="l03224"></a>03224                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;decoration failed: %s&quot;</span>, dname);
<a name="l03225"></a>03225         }
<a name="l03226"></a>03226         <span class="keywordflow">else</span> {
<a name="l03227"></a>03227             <span class="keywordtype">int</span> j = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>;
<a name="l03228"></a>03228             <span class="keyword">struct </span><a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html">rb_econv_init_by_convpath_t</a> arg;
<a name="l03229"></a>03229             arg.<a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html#a6aadae4552a424e03595a97fe605a2ce">ec</a> = ec;
<a name="l03230"></a>03230             arg.<a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html#a6ea790bce2accb73f7f92b097401b90f">index</a> = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>;
<a name="l03231"></a>03231             arg.<a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html#a557858d66ff617f7f7ab8ea38a0eb2c8">ret</a> = 0;
<a name="l03232"></a>03232             ret = <a class="code" href="../../d3/d26/transcode_8c.html#afc49640284e9c9fdda17cea6952a4026">transcode_search_path</a>(sname, dname, <a class="code" href="../../d3/d26/transcode_8c.html#a3f7759c2f6a6b2afcc467d85e39c2f3d">rb_econv_init_by_convpath_i</a>, &amp;arg);
<a name="l03233"></a>03233             <span class="keywordflow">if</span> (ret == -1 || arg.<a class="code" href="../../da/d66/structrb__econv__init__by__convpath__t.html#a557858d66ff617f7f7ab8ea38a0eb2c8">ret</a> == -1)
<a name="l03234"></a>03234                 <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;adding conversion failed: %s to %s&quot;</span>, sname, dname);
<a name="l03235"></a>03235             <span class="keywordflow">if</span> (first) {
<a name="l03236"></a>03236                 first = 0;
<a name="l03237"></a>03237                 *senc_p = senc;
<a name="l03238"></a>03238                 *sname_p = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[j].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a6f79077ecbd8da45cc181b53dc280a90">src_encoding</a>;
<a name="l03239"></a>03239             }
<a name="l03240"></a>03240             *denc_p = denc;
<a name="l03241"></a>03241             *dname_p = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>-1].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a06f17fbc59c9055646b1a147d05f33eb">dst_encoding</a>;
<a name="l03242"></a>03242         }
<a name="l03243"></a>03243     }
<a name="l03244"></a>03244 
<a name="l03245"></a>03245     <span class="keywordflow">if</span> (first) {
<a name="l03246"></a>03246       *senc_p = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03247"></a>03247       *denc_p = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03248"></a>03248       *sname_p = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03249"></a>03249       *dname_p = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03250"></a>03250     }
<a name="l03251"></a>03251 
<a name="l03252"></a>03252     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a22bbe71170a0fbfce6b1ac29c7677f4c">source_encoding_name</a> = *sname_p;
<a name="l03253"></a>03253     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afd32fa6d348fa4997c2ec5dde2001c79">destination_encoding_name</a> = *dname_p;
<a name="l03254"></a>03254 
<a name="l03255"></a>03255     <span class="keywordflow">return</span> ec;
<a name="l03256"></a>03256 }
<a name="l03257"></a>03257 
<a name="l03258"></a>03258 <span class="comment">/*</span>
<a name="l03259"></a>03259 <span class="comment"> * call-seq:</span>
<a name="l03260"></a>03260 <span class="comment"> *   Encoding::Converter.new(source_encoding, destination_encoding)</span>
<a name="l03261"></a>03261 <span class="comment"> *   Encoding::Converter.new(source_encoding, destination_encoding, opt)</span>
<a name="l03262"></a>03262 <span class="comment"> *   Encoding::Converter.new(convpath)</span>
<a name="l03263"></a>03263 <span class="comment"> *</span>
<a name="l03264"></a>03264 <span class="comment"> * possible options elements:</span>
<a name="l03265"></a>03265 <span class="comment"> *   hash form:</span>
<a name="l03266"></a>03266 <span class="comment"> *     :invalid =&gt; nil            # raise error on invalid byte sequence (default)</span>
<a name="l03267"></a>03267 <span class="comment"> *     :invalid =&gt; :replace       # replace invalid byte sequence</span>
<a name="l03268"></a>03268 <span class="comment"> *     :undef =&gt; nil              # raise error on undefined conversion (default)</span>
<a name="l03269"></a>03269 <span class="comment"> *     :undef =&gt; :replace         # replace undefined conversion</span>
<a name="l03270"></a>03270 <span class="comment"> *     :replace =&gt; string         # replacement string (&quot;?&quot; or &quot;\uFFFD&quot; if not specified)</span>
<a name="l03271"></a>03271 <span class="comment"> *     :newline =&gt; :universal     # decorator for converting CRLF and CR to LF</span>
<a name="l03272"></a>03272 <span class="comment"> *     :newline =&gt; :crlf          # decorator for converting LF to CRLF</span>
<a name="l03273"></a>03273 <span class="comment"> *     :newline =&gt; :cr            # decorator for converting LF to CR</span>
<a name="l03274"></a>03274 <span class="comment"> *     :universal_newline =&gt; true # decorator for converting CRLF and CR to LF</span>
<a name="l03275"></a>03275 <span class="comment"> *     :crlf_newline =&gt; true      # decorator for converting LF to CRLF</span>
<a name="l03276"></a>03276 <span class="comment"> *     :cr_newline =&gt; true        # decorator for converting LF to CR</span>
<a name="l03277"></a>03277 <span class="comment"> *     :xml =&gt; :text              # escape as XML CharData.</span>
<a name="l03278"></a>03278 <span class="comment"> *     :xml =&gt; :attr              # escape as XML AttValue</span>
<a name="l03279"></a>03279 <span class="comment"> *   integer form:</span>
<a name="l03280"></a>03280 <span class="comment"> *     Encoding::Converter::INVALID_REPLACE</span>
<a name="l03281"></a>03281 <span class="comment"> *     Encoding::Converter::UNDEF_REPLACE</span>
<a name="l03282"></a>03282 <span class="comment"> *     Encoding::Converter::UNDEF_HEX_CHARREF</span>
<a name="l03283"></a>03283 <span class="comment"> *     Encoding::Converter::UNIVERSAL_NEWLINE_DECORATOR</span>
<a name="l03284"></a>03284 <span class="comment"> *     Encoding::Converter::CRLF_NEWLINE_DECORATOR</span>
<a name="l03285"></a>03285 <span class="comment"> *     Encoding::Converter::CR_NEWLINE_DECORATOR</span>
<a name="l03286"></a>03286 <span class="comment"> *     Encoding::Converter::XML_TEXT_DECORATOR</span>
<a name="l03287"></a>03287 <span class="comment"> *     Encoding::Converter::XML_ATTR_CONTENT_DECORATOR</span>
<a name="l03288"></a>03288 <span class="comment"> *     Encoding::Converter::XML_ATTR_QUOTE_DECORATOR</span>
<a name="l03289"></a>03289 <span class="comment"> *</span>
<a name="l03290"></a>03290 <span class="comment"> * Encoding::Converter.new creates an instance of Encoding::Converter.</span>
<a name="l03291"></a>03291 <span class="comment"> *</span>
<a name="l03292"></a>03292 <span class="comment"> * Source_encoding and destination_encoding should be a string or</span>
<a name="l03293"></a>03293 <span class="comment"> * Encoding object.</span>
<a name="l03294"></a>03294 <span class="comment"> *</span>
<a name="l03295"></a>03295 <span class="comment"> * opt should be nil, a hash or an integer.</span>
<a name="l03296"></a>03296 <span class="comment"> *</span>
<a name="l03297"></a>03297 <span class="comment"> * convpath should be an array.</span>
<a name="l03298"></a>03298 <span class="comment"> * convpath may contain</span>
<a name="l03299"></a>03299 <span class="comment"> * - two-element arrays which contain encodings or encoding names, or</span>
<a name="l03300"></a>03300 <span class="comment"> * - strings representing decorator names.</span>
<a name="l03301"></a>03301 <span class="comment"> *</span>
<a name="l03302"></a>03302 <span class="comment"> * Encoding::Converter.new optionally takes an option.</span>
<a name="l03303"></a>03303 <span class="comment"> * The option should be a hash or an integer.</span>
<a name="l03304"></a>03304 <span class="comment"> * The option hash can contain :invalid =&gt; nil, etc.</span>
<a name="l03305"></a>03305 <span class="comment"> * The option integer should be logical-or of constants such as</span>
<a name="l03306"></a>03306 <span class="comment"> * Encoding::Converter::INVALID_REPLACE, etc.</span>
<a name="l03307"></a>03307 <span class="comment"> *</span>
<a name="l03308"></a>03308 <span class="comment"> * [:invalid =&gt; nil]</span>
<a name="l03309"></a>03309 <span class="comment"> *   Raise error on invalid byte sequence.  This is a default behavior.</span>
<a name="l03310"></a>03310 <span class="comment"> * [:invalid =&gt; :replace]</span>
<a name="l03311"></a>03311 <span class="comment"> *   Replace invalid byte sequence by replacement string.</span>
<a name="l03312"></a>03312 <span class="comment"> * [:undef =&gt; nil]</span>
<a name="l03313"></a>03313 <span class="comment"> *   Raise an error if a character in source_encoding is not defined in destination_encoding.</span>
<a name="l03314"></a>03314 <span class="comment"> *   This is a default behavior.</span>
<a name="l03315"></a>03315 <span class="comment"> * [:undef =&gt; :replace]</span>
<a name="l03316"></a>03316 <span class="comment"> *   Replace undefined character in destination_encoding with replacement string.</span>
<a name="l03317"></a>03317 <span class="comment"> * [:replace =&gt; string]</span>
<a name="l03318"></a>03318 <span class="comment"> *   Specify the replacement string.</span>
<a name="l03319"></a>03319 <span class="comment"> *   If not specified, &quot;\uFFFD&quot; is used for Unicode encodings and &quot;?&quot; for others.</span>
<a name="l03320"></a>03320 <span class="comment"> * [:universal_newline =&gt; true]</span>
<a name="l03321"></a>03321 <span class="comment"> *   Convert CRLF and CR to LF.</span>
<a name="l03322"></a>03322 <span class="comment"> * [:crlf_newline =&gt; true]</span>
<a name="l03323"></a>03323 <span class="comment"> *   Convert LF to CRLF.</span>
<a name="l03324"></a>03324 <span class="comment"> * [:cr_newline =&gt; true]</span>
<a name="l03325"></a>03325 <span class="comment"> *   Convert LF to CR.</span>
<a name="l03326"></a>03326 <span class="comment"> * [:xml =&gt; :text]</span>
<a name="l03327"></a>03327 <span class="comment"> *   Escape as XML CharData.</span>
<a name="l03328"></a>03328 <span class="comment"> *   This form can be used as a HTML 4.0 #PCDATA.</span>
<a name="l03329"></a>03329 <span class="comment"> *   - &apos;&amp;&apos; -&gt; &apos;&amp;amp;&apos;</span>
<a name="l03330"></a>03330 <span class="comment"> *   - &apos;&lt;&apos; -&gt; &apos;&amp;lt;&apos;</span>
<a name="l03331"></a>03331 <span class="comment"> *   - &apos;&gt;&apos; -&gt; &apos;&amp;gt;&apos;</span>
<a name="l03332"></a>03332 <span class="comment"> *   - undefined characters in destination_encoding -&gt; hexadecimal CharRef such as &amp;#xHH;</span>
<a name="l03333"></a>03333 <span class="comment"> * [:xml =&gt; :attr]</span>
<a name="l03334"></a>03334 <span class="comment"> *   Escape as XML AttValue.</span>
<a name="l03335"></a>03335 <span class="comment"> *   The converted result is quoted as &quot;...&quot;.</span>
<a name="l03336"></a>03336 <span class="comment"> *   This form can be used as a HTML 4.0 attribute value.</span>
<a name="l03337"></a>03337 <span class="comment"> *   - &apos;&amp;&apos; -&gt; &apos;&amp;amp;&apos;</span>
<a name="l03338"></a>03338 <span class="comment"> *   - &apos;&lt;&apos; -&gt; &apos;&amp;lt;&apos;</span>
<a name="l03339"></a>03339 <span class="comment"> *   - &apos;&gt;&apos; -&gt; &apos;&amp;gt;&apos;</span>
<a name="l03340"></a>03340 <span class="comment"> *   - &apos;&quot;&apos; -&gt; &apos;&amp;quot;&apos;</span>
<a name="l03341"></a>03341 <span class="comment"> *   - undefined characters in destination_encoding -&gt; hexadecimal CharRef such as &amp;#xHH;</span>
<a name="l03342"></a>03342 <span class="comment"> *</span>
<a name="l03343"></a>03343 <span class="comment"> * Examples:</span>
<a name="l03344"></a>03344 <span class="comment"> *   # UTF-16BE to UTF-8</span>
<a name="l03345"></a>03345 <span class="comment"> *   ec = Encoding::Converter.new(&quot;UTF-16BE&quot;, &quot;UTF-8&quot;)</span>
<a name="l03346"></a>03346 <span class="comment"> *</span>
<a name="l03347"></a>03347 <span class="comment"> *   # Usually, decorators such as newline conversion are inserted last.</span>
<a name="l03348"></a>03348 <span class="comment"> *   ec = Encoding::Converter.new(&quot;UTF-16BE&quot;, &quot;UTF-8&quot;, :universal_newline =&gt; true)</span>
<a name="l03349"></a>03349 <span class="comment"> *   p ec.convpath #=&gt; [[#&lt;Encoding:UTF-16BE&gt;, #&lt;Encoding:UTF-8&gt;],</span>
<a name="l03350"></a>03350 <span class="comment"> *                 #    &quot;universal_newline&quot;]</span>
<a name="l03351"></a>03351 <span class="comment"> *</span>
<a name="l03352"></a>03352 <span class="comment"> *   # But, if the last encoding is ASCII incompatible,</span>
<a name="l03353"></a>03353 <span class="comment"> *   # decorators are inserted before the last conversion.</span>
<a name="l03354"></a>03354 <span class="comment"> *   ec = Encoding::Converter.new(&quot;UTF-8&quot;, &quot;UTF-16BE&quot;, :crlf_newline =&gt; true)</span>
<a name="l03355"></a>03355 <span class="comment"> *   p ec.convpath #=&gt; [&quot;crlf_newline&quot;,</span>
<a name="l03356"></a>03356 <span class="comment"> *                 #    [#&lt;Encoding:UTF-8&gt;, #&lt;Encoding:UTF-16BE&gt;]]</span>
<a name="l03357"></a>03357 <span class="comment"> *</span>
<a name="l03358"></a>03358 <span class="comment"> *   # Conversion path can be specified directly.</span>
<a name="l03359"></a>03359 <span class="comment"> *   ec = Encoding::Converter.new([&quot;universal_newline&quot;, [&quot;EUC-JP&quot;, &quot;UTF-8&quot;], [&quot;UTF-8&quot;, &quot;UTF-16BE&quot;]])</span>
<a name="l03360"></a>03360 <span class="comment"> *   p ec.convpath #=&gt; [&quot;universal_newline&quot;,</span>
<a name="l03361"></a>03361 <span class="comment"> *                 #    [#&lt;Encoding:EUC-JP&gt;, #&lt;Encoding:UTF-8&gt;],</span>
<a name="l03362"></a>03362 <span class="comment"> *                 #    [#&lt;Encoding:UTF-8&gt;, #&lt;Encoding:UTF-16BE&gt;]]</span>
<a name="l03363"></a>03363 <span class="comment"> */</span>
<a name="l03364"></a>03364 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03365"></a><a class="code" href="../../d3/d26/transcode_8c.html#a7d3a4a7f5d16e9e896d0b1ca4b94031d">03365</a> <a class="code" href="../../d3/d26/transcode_8c.html#a7d3a4a7f5d16e9e896d0b1ca4b94031d">econv_init</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l03366"></a>03366 {
<a name="l03367"></a>03367     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ecopts;
<a name="l03368"></a>03368     <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> snamev, dnamev;
<a name="l03369"></a>03369     <span class="keyword">const</span> <span class="keywordtype">char</span> *sname, *dname;
<a name="l03370"></a>03370     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *senc, *denc;
<a name="l03371"></a>03371     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec;
<a name="l03372"></a>03372     <span class="keywordtype">int</span> ecflags;
<a name="l03373"></a>03373     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> convpath;
<a name="l03374"></a>03374 
<a name="l03375"></a>03375     <span class="keywordflow">if</span> (<a class="code" href="../../db/dcc/error_8c.html#a01f11924b05ac5d4df94383f39a14d6c">rb_check_typeddata</a>(<span class="keyword">self</span>, &amp;econv_data_type)) {
<a name="l03376"></a>03376         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a565ed9d70f4089e1b4a36e9b3381b8c6">rb_eTypeError</a>, <span class="stringliteral">&quot;already initialized&quot;</span>);
<a name="l03377"></a>03377     }
<a name="l03378"></a>03378 
<a name="l03379"></a>03379     <span class="keywordflow">if</span> (argc == 1 &amp;&amp; !<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(convpath = <a class="code" href="../../dc/dcc/array_8c.html#aaa66361aff757dd7ef869f5b84b3793e">rb_check_array_type</a>(argv[0]))) {
<a name="l03380"></a>03380         ec = <a class="code" href="../../d3/d26/transcode_8c.html#aed19af9394a75c64ddca4e14fa83db12">rb_econv_init_by_convpath</a>(<span class="keyword">self</span>, convpath, &amp;sname, &amp;dname, &amp;senc, &amp;denc);
<a name="l03381"></a>03381         ecflags = 0;
<a name="l03382"></a>03382         ecopts = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03383"></a>03383     }
<a name="l03384"></a>03384     <span class="keywordflow">else</span> {
<a name="l03385"></a>03385         <a class="code" href="../../d3/d26/transcode_8c.html#a27694dd414bf9d3175f2f45bbfb7cc3f">econv_args</a>(argc, argv, &amp;snamev, &amp;dnamev, &amp;sname, &amp;dname, &amp;senc, &amp;denc, &amp;ecflags, &amp;ecopts);
<a name="l03386"></a>03386         ec = <a class="code" href="../../d5/de3/encoding_8h.html#ac48226d977525efbbf4ed18ff36fce23">rb_econv_open_opts</a>(sname, dname, ecflags, ecopts);
<a name="l03387"></a>03387     }
<a name="l03388"></a>03388 
<a name="l03389"></a>03389     <span class="keywordflow">if</span> (!ec) {
<a name="l03390"></a>03390         <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a0dbeff3af14fde49b20f00fde25057d0">rb_econv_open_exc</a>(sname, dname, ecflags));
<a name="l03391"></a>03391     }
<a name="l03392"></a>03392 
<a name="l03393"></a>03393     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d26/transcode_8c.html#a7a9d71f951b9b292988b798f4f6bc29b">DECORATOR_P</a>(sname, dname)) {
<a name="l03394"></a>03394         <span class="keywordflow">if</span> (!senc)
<a name="l03395"></a>03395             senc = <a class="code" href="../../d3/d26/transcode_8c.html#a1ca76b51d88a29b92635d44aa1f0f2d0">make_dummy_encoding</a>(sname);
<a name="l03396"></a>03396         <span class="keywordflow">if</span> (!denc)
<a name="l03397"></a>03397             denc = <a class="code" href="../../d3/d26/transcode_8c.html#a1ca76b51d88a29b92635d44aa1f0f2d0">make_dummy_encoding</a>(dname);
<a name="l03398"></a>03398     }
<a name="l03399"></a>03399 
<a name="l03400"></a>03400     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a> = senc;
<a name="l03401"></a>03401     ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a> = denc;
<a name="l03402"></a>03402 
<a name="l03403"></a>03403     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abb509cfdf6560a9f795b1f6932d93691">DATA_PTR</a>(<span class="keyword">self</span>) = ec;
<a name="l03404"></a>03404 
<a name="l03405"></a>03405     <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l03406"></a>03406 }
<a name="l03407"></a>03407 
<a name="l03408"></a>03408 <span class="comment">/*</span>
<a name="l03409"></a>03409 <span class="comment"> * call-seq:</span>
<a name="l03410"></a>03410 <span class="comment"> *   ec.inspect         -&gt; string</span>
<a name="l03411"></a>03411 <span class="comment"> *</span>
<a name="l03412"></a>03412 <span class="comment"> * Returns a printable version of &lt;i&gt;ec&lt;/i&gt;</span>
<a name="l03413"></a>03413 <span class="comment"> *</span>
<a name="l03414"></a>03414 <span class="comment"> *   ec = Encoding::Converter.new(&quot;iso-8859-1&quot;, &quot;utf-8&quot;)</span>
<a name="l03415"></a>03415 <span class="comment"> *   puts ec.inspect    #=&gt; #&lt;Encoding::Converter: ISO-8859-1 to UTF-8&gt;</span>
<a name="l03416"></a>03416 <span class="comment"> *</span>
<a name="l03417"></a>03417 <span class="comment"> */</span>
<a name="l03418"></a>03418 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03419"></a><a class="code" href="../../d3/d26/transcode_8c.html#a63a1ab211bacaea5113954f95b2ed867">03419</a> <a class="code" href="../../d3/d26/transcode_8c.html#a63a1ab211bacaea5113954f95b2ed867">econv_inspect</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l03420"></a>03420 {
<a name="l03421"></a>03421     <span class="keyword">const</span> <span class="keywordtype">char</span> *cname = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9b4f42ada717bfbe7a78830639476aed">rb_obj_classname</a>(<span class="keyword">self</span>);
<a name="l03422"></a>03422     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec;
<a name="l03423"></a>03423 
<a name="l03424"></a>03424     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8dce6624396c492cdd1af3a4c5871556">TypedData_Get_Struct</a>(<span class="keyword">self</span>, <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a>, &amp;econv_data_type, ec);
<a name="l03425"></a>03425     <span class="keywordflow">if</span> (!ec)
<a name="l03426"></a>03426         <span class="keywordflow">return</span> <a class="code" href="../../d9/d2d/sprintf_8c.html#a05c34a91ab36c6a463c861df47808fae">rb_sprintf</a>(<span class="stringliteral">&quot;#&lt;%s: uninitialized&gt;&quot;</span>, cname);
<a name="l03427"></a>03427     <span class="keywordflow">else</span> {
<a name="l03428"></a>03428         <span class="keyword">const</span> <span class="keywordtype">char</span> *sname = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a22bbe71170a0fbfce6b1ac29c7677f4c">source_encoding_name</a>;
<a name="l03429"></a>03429         <span class="keyword">const</span> <span class="keywordtype">char</span> *dname = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afd32fa6d348fa4997c2ec5dde2001c79">destination_encoding_name</a>;
<a name="l03430"></a>03430         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str;
<a name="l03431"></a>03431         str = <a class="code" href="../../d9/d2d/sprintf_8c.html#a05c34a91ab36c6a463c861df47808fae">rb_sprintf</a>(<span class="stringliteral">&quot;#&lt;%s: &quot;</span>, cname);
<a name="l03432"></a>03432         <a class="code" href="../../d3/d26/transcode_8c.html#a436d11a6e0b079d3b976298fde60d85d">econv_description</a>(sname, dname, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afe610e62515fe51de0398ca90a6a891b">flags</a>, str);
<a name="l03433"></a>03433         <a class="code" href="../../db/d2e/intern_8h.html#a5bd27db3e38af6131db24321c7cf9ec6">rb_str_cat2</a>(str, <span class="stringliteral">&quot;&gt;&quot;</span>);
<a name="l03434"></a>03434         <span class="keywordflow">return</span> str;
<a name="l03435"></a>03435     }
<a name="l03436"></a>03436 }
<a name="l03437"></a>03437 
<a name="l03438"></a>03438 <span class="keyword">static</span> <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *
<a name="l03439"></a><a class="code" href="../../d3/d26/transcode_8c.html#ade028be95d807054a17d3d3d152f8235">03439</a> <a class="code" href="../../d3/d26/transcode_8c.html#ade028be95d807054a17d3d3d152f8235">check_econv</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l03440"></a>03440 {
<a name="l03441"></a>03441     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec;
<a name="l03442"></a>03442 
<a name="l03443"></a>03443     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a8dce6624396c492cdd1af3a4c5871556">TypedData_Get_Struct</a>(<span class="keyword">self</span>, <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a>, &amp;econv_data_type, ec);
<a name="l03444"></a>03444     <span class="keywordflow">if</span> (!ec) {
<a name="l03445"></a>03445         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a565ed9d70f4089e1b4a36e9b3381b8c6">rb_eTypeError</a>, <span class="stringliteral">&quot;uninitialized encoding converter&quot;</span>);
<a name="l03446"></a>03446     }
<a name="l03447"></a>03447     <span class="keywordflow">return</span> ec;
<a name="l03448"></a>03448 }
<a name="l03449"></a>03449 
<a name="l03450"></a>03450 <span class="comment">/*</span>
<a name="l03451"></a>03451 <span class="comment"> * call-seq:</span>
<a name="l03452"></a>03452 <span class="comment"> *   ec.source_encoding -&gt; encoding</span>
<a name="l03453"></a>03453 <span class="comment"> *</span>
<a name="l03454"></a>03454 <span class="comment"> * Returns the source encoding as an Encoding object.</span>
<a name="l03455"></a>03455 <span class="comment"> */</span>
<a name="l03456"></a>03456 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03457"></a><a class="code" href="../../d3/d26/transcode_8c.html#aae68615a40e4ab509f6863a941498527">03457</a> <a class="code" href="../../d3/d26/transcode_8c.html#aae68615a40e4ab509f6863a941498527">econv_source_encoding</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l03458"></a>03458 {
<a name="l03459"></a>03459     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec = <a class="code" href="../../d3/d26/transcode_8c.html#ade028be95d807054a17d3d3d152f8235">check_econv</a>(<span class="keyword">self</span>);
<a name="l03460"></a>03460     <span class="keywordflow">if</span> (!ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>)
<a name="l03461"></a>03461         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03462"></a>03462     <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>);
<a name="l03463"></a>03463 }
<a name="l03464"></a>03464 
<a name="l03465"></a>03465 <span class="comment">/*</span>
<a name="l03466"></a>03466 <span class="comment"> * call-seq:</span>
<a name="l03467"></a>03467 <span class="comment"> *   ec.destination_encoding -&gt; encoding</span>
<a name="l03468"></a>03468 <span class="comment"> *</span>
<a name="l03469"></a>03469 <span class="comment"> * Returns the destination encoding as an Encoding object.</span>
<a name="l03470"></a>03470 <span class="comment"> */</span>
<a name="l03471"></a>03471 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03472"></a><a class="code" href="../../d3/d26/transcode_8c.html#a12af29e0ad7153fc744b5f39ada979ec">03472</a> <a class="code" href="../../d3/d26/transcode_8c.html#a12af29e0ad7153fc744b5f39ada979ec">econv_destination_encoding</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l03473"></a>03473 {
<a name="l03474"></a>03474     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec = <a class="code" href="../../d3/d26/transcode_8c.html#ade028be95d807054a17d3d3d152f8235">check_econv</a>(<span class="keyword">self</span>);
<a name="l03475"></a>03475     <span class="keywordflow">if</span> (!ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a>)
<a name="l03476"></a>03476         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03477"></a>03477     <span class="keywordflow">return</span> <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a>);
<a name="l03478"></a>03478 }
<a name="l03479"></a>03479 
<a name="l03480"></a>03480 <span class="comment">/*</span>
<a name="l03481"></a>03481 <span class="comment"> * call-seq:</span>
<a name="l03482"></a>03482 <span class="comment"> *   ec.convpath        -&gt; ary</span>
<a name="l03483"></a>03483 <span class="comment"> *</span>
<a name="l03484"></a>03484 <span class="comment"> * Returns the conversion path of ec.</span>
<a name="l03485"></a>03485 <span class="comment"> *</span>
<a name="l03486"></a>03486 <span class="comment"> * The result is an array of conversions.</span>
<a name="l03487"></a>03487 <span class="comment"> *</span>
<a name="l03488"></a>03488 <span class="comment"> *   ec = Encoding::Converter.new(&quot;ISO-8859-1&quot;, &quot;EUC-JP&quot;, crlf_newline: true)</span>
<a name="l03489"></a>03489 <span class="comment"> *   p ec.convpath</span>
<a name="l03490"></a>03490 <span class="comment"> *   #=&gt; [[#&lt;Encoding:ISO-8859-1&gt;, #&lt;Encoding:UTF-8&gt;],</span>
<a name="l03491"></a>03491 <span class="comment"> *   #    [#&lt;Encoding:UTF-8&gt;, #&lt;Encoding:EUC-JP&gt;],</span>
<a name="l03492"></a>03492 <span class="comment"> *   #    &quot;crlf_newline&quot;]</span>
<a name="l03493"></a>03493 <span class="comment"> *</span>
<a name="l03494"></a>03494 <span class="comment"> * Each element of the array is a pair of encodings or a string.</span>
<a name="l03495"></a>03495 <span class="comment"> * A pair means an encoding conversion.</span>
<a name="l03496"></a>03496 <span class="comment"> * A string means a decorator.</span>
<a name="l03497"></a>03497 <span class="comment"> *</span>
<a name="l03498"></a>03498 <span class="comment"> * In the above example, [#&lt;Encoding:ISO-8859-1&gt;, #&lt;Encoding:UTF-8&gt;] means</span>
<a name="l03499"></a>03499 <span class="comment"> * a converter from ISO-8859-1 to UTF-8.</span>
<a name="l03500"></a>03500 <span class="comment"> * &quot;crlf_newline&quot; means newline converter from LF to CRLF.</span>
<a name="l03501"></a>03501 <span class="comment"> */</span>
<a name="l03502"></a>03502 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03503"></a><a class="code" href="../../d3/d26/transcode_8c.html#a18688b107b29265dbb50b0a13ca5d1f9">03503</a> <a class="code" href="../../d3/d26/transcode_8c.html#a18688b107b29265dbb50b0a13ca5d1f9">econv_convpath</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l03504"></a>03504 {
<a name="l03505"></a>03505     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec = <a class="code" href="../../d3/d26/transcode_8c.html#ade028be95d807054a17d3d3d152f8235">check_econv</a>(<span class="keyword">self</span>);
<a name="l03506"></a>03506     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d8/d90/nkf_8c.html#a5ea5ac7abf5cce39283e422add1067d5">result</a>;
<a name="l03507"></a>03507     <span class="keywordtype">int</span> i;
<a name="l03508"></a>03508 
<a name="l03509"></a>03509     result = <a class="code" href="../../dc/dcc/array_8c.html#a9518114fd36cb4ef4656ec1dc63348c9">rb_ary_new</a>();
<a name="l03510"></a>03510     <span class="keywordflow">for</span> (i = 0; i &lt; ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>; i++) {
<a name="l03511"></a>03511         <span class="keyword">const</span> <a class="code" href="../../d5/d10/structrb__transcoder.html">rb_transcoder</a> *<a class="code" href="../../d0/d5c/structtr.html">tr</a> = ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>;
<a name="l03512"></a>03512         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v;
<a name="l03513"></a>03513         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d26/transcode_8c.html#a7a9d71f951b9b292988b798f4f6bc29b">DECORATOR_P</a>(tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a6f79077ecbd8da45cc181b53dc280a90">src_encoding</a>, tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a06f17fbc59c9055646b1a147d05f33eb">dst_encoding</a>))
<a name="l03514"></a>03514             v = <a class="code" href="../../db/d2e/intern_8h.html#a2b9cc485b0aa1dc270744b8b9eb47569">rb_str_new_cstr</a>(tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a06f17fbc59c9055646b1a147d05f33eb">dst_encoding</a>);
<a name="l03515"></a>03515         <span class="keywordflow">else</span>
<a name="l03516"></a>03516             v = <a class="code" href="../../dc/dcc/array_8c.html#af3085ceab406e3f4f4b90f383c440d6a">rb_assoc_new</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a8b7f627a139e8ebf1095c2ad647eac96">make_encobj</a>(tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a6f79077ecbd8da45cc181b53dc280a90">src_encoding</a>), <a class="code" href="../../d3/d26/transcode_8c.html#a8b7f627a139e8ebf1095c2ad647eac96">make_encobj</a>(tr-&gt;<a class="code" href="../../d5/d10/structrb__transcoder.html#a06f17fbc59c9055646b1a147d05f33eb">dst_encoding</a>));
<a name="l03517"></a>03517         <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(result, v);
<a name="l03518"></a>03518     }
<a name="l03519"></a>03519     <span class="keywordflow">return</span> result;
<a name="l03520"></a>03520 }
<a name="l03521"></a>03521 
<a name="l03522"></a>03522 <span class="comment">/*</span>
<a name="l03523"></a>03523 <span class="comment"> * call-seq:</span>
<a name="l03524"></a>03524 <span class="comment"> *   ec == other        -&gt; true or false</span>
<a name="l03525"></a>03525 <span class="comment"> */</span>
<a name="l03526"></a>03526 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03527"></a><a class="code" href="../../d3/d26/transcode_8c.html#a1f44c4c06fe2491bed5041a7d45563fc">03527</a> <a class="code" href="../../d3/d26/transcode_8c.html#a1f44c4c06fe2491bed5041a7d45563fc">econv_equal</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> other)
<a name="l03528"></a>03528 {
<a name="l03529"></a>03529     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec1 = <a class="code" href="../../d3/d26/transcode_8c.html#ade028be95d807054a17d3d3d152f8235">check_econv</a>(<span class="keyword">self</span>);
<a name="l03530"></a>03530     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec2;
<a name="l03531"></a>03531     <span class="keywordtype">int</span> i;
<a name="l03532"></a>03532 
<a name="l03533"></a>03533     <span class="keywordflow">if</span> (!<a class="code" href="../../db/dcc/error_8c.html#a2a5803d0e60feb0ed8f37e7a38e8df47">rb_typeddata_is_kind_of</a>(other, &amp;econv_data_type)) {
<a name="l03534"></a>03534         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03535"></a>03535     }
<a name="l03536"></a>03536     ec2 = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abb509cfdf6560a9f795b1f6932d93691">DATA_PTR</a>(other);
<a name="l03537"></a>03537     <span class="keywordflow">if</span> (!ec2) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l03538"></a>03538     <span class="keywordflow">if</span> (ec1-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a22bbe71170a0fbfce6b1ac29c7677f4c">source_encoding_name</a> != ec2-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a22bbe71170a0fbfce6b1ac29c7677f4c">source_encoding_name</a> &amp;&amp;
<a name="l03539"></a>03539         strcmp(ec1-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a22bbe71170a0fbfce6b1ac29c7677f4c">source_encoding_name</a>, ec2-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a22bbe71170a0fbfce6b1ac29c7677f4c">source_encoding_name</a>))
<a name="l03540"></a>03540         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l03541"></a>03541     <span class="keywordflow">if</span> (ec1-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afd32fa6d348fa4997c2ec5dde2001c79">destination_encoding_name</a> != ec2-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afd32fa6d348fa4997c2ec5dde2001c79">destination_encoding_name</a> &amp;&amp;
<a name="l03542"></a>03542         strcmp(ec1-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afd32fa6d348fa4997c2ec5dde2001c79">destination_encoding_name</a>, ec2-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afd32fa6d348fa4997c2ec5dde2001c79">destination_encoding_name</a>))
<a name="l03543"></a>03543         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l03544"></a>03544     <span class="keywordflow">if</span> (ec1-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afe610e62515fe51de0398ca90a6a891b">flags</a> != ec2-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#afe610e62515fe51de0398ca90a6a891b">flags</a>) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l03545"></a>03545     <span class="keywordflow">if</span> (ec1-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a875d42c5055651a75e9172e89a53c7c8">replacement_enc</a> != ec2-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a875d42c5055651a75e9172e89a53c7c8">replacement_enc</a> &amp;&amp;
<a name="l03546"></a>03546         strcmp(ec1-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a875d42c5055651a75e9172e89a53c7c8">replacement_enc</a>, ec2-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a875d42c5055651a75e9172e89a53c7c8">replacement_enc</a>))
<a name="l03547"></a>03547         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l03548"></a>03548     <span class="keywordflow">if</span> (ec1-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a40e67fdbe80e48a19ecfeaa9358fd4c2">replacement_len</a> != ec2-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a40e67fdbe80e48a19ecfeaa9358fd4c2">replacement_len</a>) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l03549"></a>03549     <span class="keywordflow">if</span> (ec1-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9ef89b6cd3baa02b8ec83f49a2d3a2b">replacement_str</a> != ec2-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9ef89b6cd3baa02b8ec83f49a2d3a2b">replacement_str</a> &amp;&amp;
<a name="l03550"></a>03550         <a class="code" href="../../d5/d21/memcmp_8c.html#a1499ab2d0a3da86cbc3e688294f60a48">memcmp</a>(ec1-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9ef89b6cd3baa02b8ec83f49a2d3a2b">replacement_str</a>, ec2-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9ef89b6cd3baa02b8ec83f49a2d3a2b">replacement_str</a>, ec2-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a40e67fdbe80e48a19ecfeaa9358fd4c2">replacement_len</a>))
<a name="l03551"></a>03551         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l03552"></a>03552 
<a name="l03553"></a>03553     <span class="keywordflow">if</span> (ec1-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a> != ec2-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l03554"></a>03554     <span class="keywordflow">for</span> (i = 0; i &lt; ec1-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a5c8cd446fd09795c44b5eb5da1880ba2">num_trans</a>; i++) {
<a name="l03555"></a>03555         <span class="keywordflow">if</span> (ec1-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a> != ec2-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a7de6e55e94818e8d0b76016739d777fe">elems</a>[i].<a class="code" href="../../d5/d6c/structrb__econv__elem__t.html#a7965af66d25bdcf7b3c7f0a8ccad0b54">tc</a>-&gt;<a class="code" href="../../de/d43/structrb__transcoding.html#a9632c65eba2778e4ee8e2a079dbd024e">transcoder</a>)
<a name="l03556"></a>03556             <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l03557"></a>03557     }
<a name="l03558"></a>03558     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l03559"></a>03559 }
<a name="l03560"></a>03560 
<a name="l03561"></a>03561 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03562"></a><a class="code" href="../../d3/d26/transcode_8c.html#a04d9f1519e6d95f29fae24c4db25060a">03562</a> <a class="code" href="../../d3/d26/transcode_8c.html#a04d9f1519e6d95f29fae24c4db25060a">econv_result_to_symbol</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a> res)
<a name="l03563"></a>03563 {
<a name="l03564"></a>03564     <span class="keywordflow">switch</span> (res) {
<a name="l03565"></a>03565       <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad43244977ecc5d0f0cda6d003b1e37d1">econv_invalid_byte_sequence</a>: <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a030b203c7ef931bd8f26d07580e6bdd2">sym_invalid_byte_sequence</a>;
<a name="l03566"></a>03566       <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa42fe600023b5129588324a787ade662d">econv_incomplete_input</a>: <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#aaabae663ba3655668c5f4a2149091a12">sym_incomplete_input</a>;
<a name="l03567"></a>03567       <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7e59e5dc4cb8b9db559a803ee88aec57">econv_undefined_conversion</a>: <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#ad2faaaa9fca9c44a031ef9b9dbee67c9">sym_undefined_conversion</a>;
<a name="l03568"></a>03568       <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a>: <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#ad1e9bae611dd45dfca6a189c14a332dc">sym_destination_buffer_full</a>;
<a name="l03569"></a>03569       <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efaa6fbf23eab35b0c2483c4adab36612de">econv_source_buffer_empty</a>: <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#afb60cd128cc303ec90f2f093e90c6784">sym_source_buffer_empty</a>;
<a name="l03570"></a>03570       <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa50dc17a7e8399ca9dcd98a7b6e652764">econv_finished</a>: <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#ac483d0155fcd9b9db482928ebd1ef465">sym_finished</a>;
<a name="l03571"></a>03571       <span class="keywordflow">case</span> <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efa7fc541cded41d5957480dcf17859e782">econv_after_output</a>: <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a4eefe22a7d2bf258488987a25134318c">sym_after_output</a>;
<a name="l03572"></a>03572       <span class="keywordflow">default</span>: <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(res); <span class="comment">/* should not be reached */</span>
<a name="l03573"></a>03573     }
<a name="l03574"></a>03574 }
<a name="l03575"></a>03575 
<a name="l03576"></a>03576 <span class="comment">/*</span>
<a name="l03577"></a>03577 <span class="comment"> * call-seq:</span>
<a name="l03578"></a>03578 <span class="comment"> *   ec.primitive_convert(source_buffer, destination_buffer) -&gt; symbol</span>
<a name="l03579"></a>03579 <span class="comment"> *   ec.primitive_convert(source_buffer, destination_buffer, destination_byteoffset) -&gt; symbol</span>
<a name="l03580"></a>03580 <span class="comment"> *   ec.primitive_convert(source_buffer, destination_buffer, destination_byteoffset, destination_bytesize) -&gt; symbol</span>
<a name="l03581"></a>03581 <span class="comment"> *   ec.primitive_convert(source_buffer, destination_buffer, destination_byteoffset, destination_bytesize, opt) -&gt; symbol</span>
<a name="l03582"></a>03582 <span class="comment"> *</span>
<a name="l03583"></a>03583 <span class="comment"> * possible opt elements:</span>
<a name="l03584"></a>03584 <span class="comment"> *   hash form:</span>
<a name="l03585"></a>03585 <span class="comment"> *     :partial_input =&gt; true           # source buffer may be part of larger source</span>
<a name="l03586"></a>03586 <span class="comment"> *     :after_output =&gt; true            # stop conversion after output before input</span>
<a name="l03587"></a>03587 <span class="comment"> *   integer form:</span>
<a name="l03588"></a>03588 <span class="comment"> *     Encoding::Converter::PARTIAL_INPUT</span>
<a name="l03589"></a>03589 <span class="comment"> *     Encoding::Converter::AFTER_OUTPUT</span>
<a name="l03590"></a>03590 <span class="comment"> *</span>
<a name="l03591"></a>03591 <span class="comment"> * possible results:</span>
<a name="l03592"></a>03592 <span class="comment"> *    :invalid_byte_sequence</span>
<a name="l03593"></a>03593 <span class="comment"> *    :incomplete_input</span>
<a name="l03594"></a>03594 <span class="comment"> *    :undefined_conversion</span>
<a name="l03595"></a>03595 <span class="comment"> *    :after_output</span>
<a name="l03596"></a>03596 <span class="comment"> *    :destination_buffer_full</span>
<a name="l03597"></a>03597 <span class="comment"> *    :source_buffer_empty</span>
<a name="l03598"></a>03598 <span class="comment"> *    :finished</span>
<a name="l03599"></a>03599 <span class="comment"> *</span>
<a name="l03600"></a>03600 <span class="comment"> * primitive_convert converts source_buffer into destination_buffer.</span>
<a name="l03601"></a>03601 <span class="comment"> *</span>
<a name="l03602"></a>03602 <span class="comment"> * source_buffer should be a string or nil.</span>
<a name="l03603"></a>03603 <span class="comment"> * nil means a empty string.</span>
<a name="l03604"></a>03604 <span class="comment"> *</span>
<a name="l03605"></a>03605 <span class="comment"> * destination_buffer should be a string.</span>
<a name="l03606"></a>03606 <span class="comment"> *</span>
<a name="l03607"></a>03607 <span class="comment"> * destination_byteoffset should be an integer or nil.</span>
<a name="l03608"></a>03608 <span class="comment"> * nil means the end of destination_buffer.</span>
<a name="l03609"></a>03609 <span class="comment"> * If it is omitted, nil is assumed.</span>
<a name="l03610"></a>03610 <span class="comment"> *</span>
<a name="l03611"></a>03611 <span class="comment"> * destination_bytesize should be an integer or nil.</span>
<a name="l03612"></a>03612 <span class="comment"> * nil means unlimited.</span>
<a name="l03613"></a>03613 <span class="comment"> * If it is omitted, nil is assumed.</span>
<a name="l03614"></a>03614 <span class="comment"> *</span>
<a name="l03615"></a>03615 <span class="comment"> * opt should be nil, a hash or an integer.</span>
<a name="l03616"></a>03616 <span class="comment"> * nil means no flags.</span>
<a name="l03617"></a>03617 <span class="comment"> * If it is omitted, nil is assumed.</span>
<a name="l03618"></a>03618 <span class="comment"> *</span>
<a name="l03619"></a>03619 <span class="comment"> * primitive_convert converts the content of source_buffer from beginning</span>
<a name="l03620"></a>03620 <span class="comment"> * and store the result into destination_buffer.</span>
<a name="l03621"></a>03621 <span class="comment"> *</span>
<a name="l03622"></a>03622 <span class="comment"> * destination_byteoffset and destination_bytesize specify the region which</span>
<a name="l03623"></a>03623 <span class="comment"> * the converted result is stored.</span>
<a name="l03624"></a>03624 <span class="comment"> * destination_byteoffset specifies the start position in destination_buffer in bytes.</span>
<a name="l03625"></a>03625 <span class="comment"> * If destination_byteoffset is nil,</span>
<a name="l03626"></a>03626 <span class="comment"> * destination_buffer.bytesize is used for appending the result.</span>
<a name="l03627"></a>03627 <span class="comment"> * destination_bytesize specifies maximum number of bytes.</span>
<a name="l03628"></a>03628 <span class="comment"> * If destination_bytesize is nil,</span>
<a name="l03629"></a>03629 <span class="comment"> * destination size is unlimited.</span>
<a name="l03630"></a>03630 <span class="comment"> * After conversion, destination_buffer is resized to</span>
<a name="l03631"></a>03631 <span class="comment"> * destination_byteoffset + actually produced number of bytes.</span>
<a name="l03632"></a>03632 <span class="comment"> * Also destination_buffer&apos;s encoding is set to destination_encoding.</span>
<a name="l03633"></a>03633 <span class="comment"> *</span>
<a name="l03634"></a>03634 <span class="comment"> * primitive_convert drops the converted part of source_buffer.</span>
<a name="l03635"></a>03635 <span class="comment"> * the dropped part is converted in destination_buffer or</span>
<a name="l03636"></a>03636 <span class="comment"> * buffered in Encoding::Converter object.</span>
<a name="l03637"></a>03637 <span class="comment"> *</span>
<a name="l03638"></a>03638 <span class="comment"> * primitive_convert stops conversion when one of following condition met.</span>
<a name="l03639"></a>03639 <span class="comment"> * - invalid byte sequence found in source buffer (:invalid_byte_sequence)</span>
<a name="l03640"></a>03640 <span class="comment"> * - unexpected end of source buffer (:incomplete_input)</span>
<a name="l03641"></a>03641 <span class="comment"> *   this occur only when :partial_input is not specified.</span>
<a name="l03642"></a>03642 <span class="comment"> * - character not representable in output encoding (:undefined_conversion)</span>
<a name="l03643"></a>03643 <span class="comment"> * - after some output is generated, before input is done (:after_output)</span>
<a name="l03644"></a>03644 <span class="comment"> *   this occur only when :after_output is specified.</span>
<a name="l03645"></a>03645 <span class="comment"> * - destination buffer is full (:destination_buffer_full)</span>
<a name="l03646"></a>03646 <span class="comment"> *   this occur only when destination_bytesize is non-nil.</span>
<a name="l03647"></a>03647 <span class="comment"> * - source buffer is empty (:source_buffer_empty)</span>
<a name="l03648"></a>03648 <span class="comment"> *   this occur only when :partial_input is specified.</span>
<a name="l03649"></a>03649 <span class="comment"> * - conversion is finished (:finished)</span>
<a name="l03650"></a>03650 <span class="comment"> *</span>
<a name="l03651"></a>03651 <span class="comment"> * example:</span>
<a name="l03652"></a>03652 <span class="comment"> *   ec = Encoding::Converter.new(&quot;UTF-8&quot;, &quot;UTF-16BE&quot;)</span>
<a name="l03653"></a>03653 <span class="comment"> *   ret = ec.primitive_convert(src=&quot;pi&quot;, dst=&quot;&quot;, nil, 100)</span>
<a name="l03654"></a>03654 <span class="comment"> *   p [ret, src, dst] #=&gt; [:finished, &quot;&quot;, &quot;\x00p\x00i&quot;]</span>
<a name="l03655"></a>03655 <span class="comment"> *</span>
<a name="l03656"></a>03656 <span class="comment"> *   ec = Encoding::Converter.new(&quot;UTF-8&quot;, &quot;UTF-16BE&quot;)</span>
<a name="l03657"></a>03657 <span class="comment"> *   ret = ec.primitive_convert(src=&quot;pi&quot;, dst=&quot;&quot;, nil, 1)</span>
<a name="l03658"></a>03658 <span class="comment"> *   p [ret, src, dst] #=&gt; [:destination_buffer_full, &quot;i&quot;, &quot;\x00&quot;]</span>
<a name="l03659"></a>03659 <span class="comment"> *   ret = ec.primitive_convert(src, dst=&quot;&quot;, nil, 1)</span>
<a name="l03660"></a>03660 <span class="comment"> *   p [ret, src, dst] #=&gt; [:destination_buffer_full, &quot;&quot;, &quot;p&quot;]</span>
<a name="l03661"></a>03661 <span class="comment"> *   ret = ec.primitive_convert(src, dst=&quot;&quot;, nil, 1)</span>
<a name="l03662"></a>03662 <span class="comment"> *   p [ret, src, dst] #=&gt; [:destination_buffer_full, &quot;&quot;, &quot;\x00&quot;]</span>
<a name="l03663"></a>03663 <span class="comment"> *   ret = ec.primitive_convert(src, dst=&quot;&quot;, nil, 1)</span>
<a name="l03664"></a>03664 <span class="comment"> *   p [ret, src, dst] #=&gt; [:finished, &quot;&quot;, &quot;i&quot;]</span>
<a name="l03665"></a>03665 <span class="comment"> *</span>
<a name="l03666"></a>03666 <span class="comment"> */</span>
<a name="l03667"></a>03667 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03668"></a><a class="code" href="../../d3/d26/transcode_8c.html#a1c11ab12e2e44160e69623b1049ec540">03668</a> <a class="code" href="../../d3/d26/transcode_8c.html#a1c11ab12e2e44160e69623b1049ec540">econv_primitive_convert</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l03669"></a>03669 {
<a name="l03670"></a>03670     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a5a3887dd3455e820d89b736f9b4de18b">input</a>, <a class="code" href="../../d8/d90/nkf_8c.html#a1b7ce3eca891b24170a721e000ec30c7">output</a>, output_byteoffset_v, output_bytesize_v, opt, flags_v;
<a name="l03671"></a>03671     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec = <a class="code" href="../../d3/d26/transcode_8c.html#ade028be95d807054a17d3d3d152f8235">check_econv</a>(<span class="keyword">self</span>);
<a name="l03672"></a>03672     <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831ef">rb_econv_result_t</a> res;
<a name="l03673"></a>03673     <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *ip, *is;
<a name="l03674"></a>03674     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *op, *os;
<a name="l03675"></a>03675     <span class="keywordtype">long</span> output_byteoffset, output_bytesize;
<a name="l03676"></a>03676     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> output_byteend;
<a name="l03677"></a>03677     <span class="keywordtype">int</span> flags;
<a name="l03678"></a>03678 
<a name="l03679"></a>03679     argc = <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;23:&quot;</span>, &amp;input, &amp;output, &amp;output_byteoffset_v, &amp;output_bytesize_v, &amp;flags_v, &amp;opt);
<a name="l03680"></a>03680 
<a name="l03681"></a>03681     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(output_byteoffset_v))
<a name="l03682"></a>03682         output_byteoffset = 0; <span class="comment">/* dummy */</span>
<a name="l03683"></a>03683     <span class="keywordflow">else</span>
<a name="l03684"></a>03684         output_byteoffset = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(output_byteoffset_v);
<a name="l03685"></a>03685 
<a name="l03686"></a>03686     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(output_bytesize_v))
<a name="l03687"></a>03687         output_bytesize = 0; <span class="comment">/* dummy */</span>
<a name="l03688"></a>03688     <span class="keywordflow">else</span>
<a name="l03689"></a>03689         output_bytesize = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a93f154f3dcc08027f475bf0c3cc287bd">NUM2LONG</a>(output_bytesize_v);
<a name="l03690"></a>03690 
<a name="l03691"></a>03691     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(flags_v)) {
<a name="l03692"></a>03692         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(opt)) {
<a name="l03693"></a>03693             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;wrong number of arguments (%d for 2..5)&quot;</span>,
<a name="l03694"></a>03694                 argc + 1);
<a name="l03695"></a>03695         }
<a name="l03696"></a>03696         flags = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(<a class="code" href="../../db/d2e/intern_8h.html#ae98f9e6c1a4b5181ca48e36d06b3157b">rb_to_int</a>(flags_v));
<a name="l03697"></a>03697     }
<a name="l03698"></a>03698     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(opt)) {
<a name="l03699"></a>03699         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> v;
<a name="l03700"></a>03700         flags = 0;
<a name="l03701"></a>03701         v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opt, <a class="code" href="../../d3/d26/transcode_8c.html#a1bcb1cddad7f1faa7bcac7e136592a7f">sym_partial_input</a>);
<a name="l03702"></a>03702         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(v))
<a name="l03703"></a>03703             flags |= <a class="code" href="../../d5/de3/encoding_8h.html#ab1eeed22e1b00841e21fa4715df0029e">ECONV_PARTIAL_INPUT</a>;
<a name="l03704"></a>03704         v = <a class="code" href="../../d1/d04/hash_8c.html#ab7063832c7ed02351e87922a78e35c32">rb_hash_aref</a>(opt, <a class="code" href="../../d3/d26/transcode_8c.html#a4eefe22a7d2bf258488987a25134318c">sym_after_output</a>);
<a name="l03705"></a>03705         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a117741045763c090b26e30a85bd0e0a6">RTEST</a>(v))
<a name="l03706"></a>03706             flags |= <a class="code" href="../../d5/de3/encoding_8h.html#a0311828d8ad5d3ba4bdce5fd9244301b">ECONV_AFTER_OUTPUT</a>;
<a name="l03707"></a>03707     }
<a name="l03708"></a>03708     <span class="keywordflow">else</span> {
<a name="l03709"></a>03709         flags = 0;
<a name="l03710"></a>03710     }
<a name="l03711"></a>03711 
<a name="l03712"></a>03712     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(output);
<a name="l03713"></a>03713     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(input))
<a name="l03714"></a>03714         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(input);
<a name="l03715"></a>03715     <a class="code" href="../../db/d2e/intern_8h.html#a63a6d05687cf812131dce11743581b9d">rb_str_modify</a>(output);
<a name="l03716"></a>03716 
<a name="l03717"></a>03717     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(output_bytesize_v)) {
<a name="l03718"></a>03718         output_bytesize = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a92657ad1be8a8a323df19648e33b47b5">RSTRING_EMBED_LEN_MAX</a>;
<a name="l03719"></a>03719         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(input) &amp;&amp; output_bytesize &lt; <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(input))
<a name="l03720"></a>03720             output_bytesize = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(input);
<a name="l03721"></a>03721     }
<a name="l03722"></a>03722 
<a name="l03723"></a>03723   retry:
<a name="l03724"></a>03724 
<a name="l03725"></a>03725     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(output_byteoffset_v))
<a name="l03726"></a>03726         output_byteoffset = <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(output);
<a name="l03727"></a>03727 
<a name="l03728"></a>03728     <span class="keywordflow">if</span> (output_byteoffset &lt; 0)
<a name="l03729"></a>03729         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;negative output_byteoffset&quot;</span>);
<a name="l03730"></a>03730 
<a name="l03731"></a>03731     <span class="keywordflow">if</span> (<a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(output) &lt; output_byteoffset)
<a name="l03732"></a>03732         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;output_byteoffset too big&quot;</span>);
<a name="l03733"></a>03733 
<a name="l03734"></a>03734     <span class="keywordflow">if</span> (output_bytesize &lt; 0)
<a name="l03735"></a>03735         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;negative output_bytesize&quot;</span>);
<a name="l03736"></a>03736 
<a name="l03737"></a>03737     output_byteend = (<span class="keywordtype">unsigned</span> <a class="code" href="../../d3/d15/name2ctype_8h.html#a86f2415763322050063a5502f87c9422">long</a>)output_byteoffset +
<a name="l03738"></a>03738                      (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)output_bytesize;
<a name="l03739"></a>03739 
<a name="l03740"></a>03740     <span class="keywordflow">if</span> (output_byteend &lt; (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)output_byteoffset ||
<a name="l03741"></a>03741         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a50fece4db74f09568b2938db583c5655">LONG_MAX</a> &lt; output_byteend)
<a name="l03742"></a>03742         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;output_byteoffset+output_bytesize too big&quot;</span>);
<a name="l03743"></a>03743 
<a name="l03744"></a>03744     <span class="keywordflow">if</span> (<a class="code" href="../../db/d2e/intern_8h.html#ae3485fb3fdd9b960dc803374b044c567">rb_str_capacity</a>(output) &lt; output_byteend)
<a name="l03745"></a>03745         <a class="code" href="../../db/d2e/intern_8h.html#a0a133856edb99f69eae3cb5a9e275ac9">rb_str_resize</a>(output, output_byteend);
<a name="l03746"></a>03746 
<a name="l03747"></a>03747     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(input)) {
<a name="l03748"></a>03748         ip = is = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l03749"></a>03749     }
<a name="l03750"></a>03750     <span class="keywordflow">else</span> {
<a name="l03751"></a>03751         ip = (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(input);
<a name="l03752"></a>03752         is = ip + <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(input);
<a name="l03753"></a>03753     }
<a name="l03754"></a>03754 
<a name="l03755"></a>03755     op = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(output) + output_byteoffset;
<a name="l03756"></a>03756     os = op + output_bytesize;
<a name="l03757"></a>03757 
<a name="l03758"></a>03758     res = <a class="code" href="../../d5/de3/encoding_8h.html#a346451a419b3ce73da0d2323eb3238ee">rb_econv_convert</a>(ec, &amp;ip, is, &amp;op, os, flags);
<a name="l03759"></a>03759     <a class="code" href="../../d8/d81/ruby__missing_8h.html#a89ed8cb86ca6dd49d2db67adae809057">rb_str_set_len</a>(output, op-(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(output));
<a name="l03760"></a>03760     <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(input))
<a name="l03761"></a>03761         <a class="code" href="../../db/d2e/intern_8h.html#abf3be2f0a5fdf9ab341a748201c9ffd9">rb_str_drop_bytes</a>(input, ip - (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(input));
<a name="l03762"></a>03762 
<a name="l03763"></a>03763     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(output_bytesize_v) &amp;&amp; res == <a class="code" href="../../d5/de3/encoding_8h.html#a3b568992ff8d28593f9386fd70c831efad0abfbc72141011421aafa70c9763666">econv_destination_buffer_full</a>) {
<a name="l03764"></a>03764         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a50fece4db74f09568b2938db583c5655">LONG_MAX</a> / 2 &lt; output_bytesize)
<a name="l03765"></a>03765             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;too long conversion result&quot;</span>);
<a name="l03766"></a>03766         output_bytesize *= 2;
<a name="l03767"></a>03767         output_byteoffset_v = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03768"></a>03768         <span class="keywordflow">goto</span> retry;
<a name="l03769"></a>03769     }
<a name="l03770"></a>03770 
<a name="l03771"></a>03771     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a>) {
<a name="l03772"></a>03772         <a class="code" href="../../d5/db5/encoding_8c.html#a150a6e3ac22ac3be8f8c2ccc74a28e7b">rb_enc_associate</a>(output, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a>);
<a name="l03773"></a>03773     }
<a name="l03774"></a>03774 
<a name="l03775"></a>03775     <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a04d9f1519e6d95f29fae24c4db25060a">econv_result_to_symbol</a>(res);
<a name="l03776"></a>03776 }
<a name="l03777"></a>03777 
<a name="l03778"></a>03778 <span class="comment">/*</span>
<a name="l03779"></a>03779 <span class="comment"> * call-seq:</span>
<a name="l03780"></a>03780 <span class="comment"> *   ec.convert(source_string) -&gt; destination_string</span>
<a name="l03781"></a>03781 <span class="comment"> *</span>
<a name="l03782"></a>03782 <span class="comment"> * Convert source_string and return destination_string.</span>
<a name="l03783"></a>03783 <span class="comment"> *</span>
<a name="l03784"></a>03784 <span class="comment"> * source_string is assumed as a part of source.</span>
<a name="l03785"></a>03785 <span class="comment"> * i.e.  :partial_input=&gt;true is specified internally.</span>
<a name="l03786"></a>03786 <span class="comment"> * finish method should be used last.</span>
<a name="l03787"></a>03787 <span class="comment"> *</span>
<a name="l03788"></a>03788 <span class="comment"> *   ec = Encoding::Converter.new(&quot;utf-8&quot;, &quot;euc-jp&quot;)</span>
<a name="l03789"></a>03789 <span class="comment"> *   puts ec.convert(&quot;\u3042&quot;).dump     #=&gt; &quot;\xA4\xA2&quot;</span>
<a name="l03790"></a>03790 <span class="comment"> *   puts ec.finish.dump                #=&gt; &quot;&quot;</span>
<a name="l03791"></a>03791 <span class="comment"> *</span>
<a name="l03792"></a>03792 <span class="comment"> *   ec = Encoding::Converter.new(&quot;euc-jp&quot;, &quot;utf-8&quot;)</span>
<a name="l03793"></a>03793 <span class="comment"> *   puts ec.convert(&quot;\xA4&quot;).dump       #=&gt; &quot;&quot;</span>
<a name="l03794"></a>03794 <span class="comment"> *   puts ec.convert(&quot;\xA2&quot;).dump       #=&gt; &quot;\xE3\x81\x82&quot;</span>
<a name="l03795"></a>03795 <span class="comment"> *   puts ec.finish.dump                #=&gt; &quot;&quot;</span>
<a name="l03796"></a>03796 <span class="comment"> *</span>
<a name="l03797"></a>03797 <span class="comment"> *   ec = Encoding::Converter.new(&quot;utf-8&quot;, &quot;iso-2022-jp&quot;)</span>
<a name="l03798"></a>03798 <span class="comment"> *   puts ec.convert(&quot;\xE3&quot;).dump       #=&gt; &quot;&quot;.force_encoding(&quot;ISO-2022-JP&quot;)</span>
<a name="l03799"></a>03799 <span class="comment"> *   puts ec.convert(&quot;\x81&quot;).dump       #=&gt; &quot;&quot;.force_encoding(&quot;ISO-2022-JP&quot;)</span>
<a name="l03800"></a>03800 <span class="comment"> *   puts ec.convert(&quot;\x82&quot;).dump       #=&gt; &quot;\e$B$\&quot;&quot;.force_encoding(&quot;ISO-2022-JP&quot;)</span>
<a name="l03801"></a>03801 <span class="comment"> *   puts ec.finish.dump                #=&gt; &quot;\e(B&quot;.force_encoding(&quot;ISO-2022-JP&quot;)</span>
<a name="l03802"></a>03802 <span class="comment"> *</span>
<a name="l03803"></a>03803 <span class="comment"> * If a conversion error occur,</span>
<a name="l03804"></a>03804 <span class="comment"> * Encoding::UndefinedConversionError or</span>
<a name="l03805"></a>03805 <span class="comment"> * Encoding::InvalidByteSequenceError is raised.</span>
<a name="l03806"></a>03806 <span class="comment"> * Encoding::Converter#convert doesn&apos;t supply methods to recover or restart</span>
<a name="l03807"></a>03807 <span class="comment"> * from these exceptions.</span>
<a name="l03808"></a>03808 <span class="comment"> * When you want to handle these conversion errors,</span>
<a name="l03809"></a>03809 <span class="comment"> * use Encoding::Converter#primitive_convert.</span>
<a name="l03810"></a>03810 <span class="comment"> *</span>
<a name="l03811"></a>03811 <span class="comment"> */</span>
<a name="l03812"></a>03812 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03813"></a><a class="code" href="../../d3/d26/transcode_8c.html#a83450dce3d1044fd3a54ea27b71b3c50">03813</a> <a class="code" href="../../d3/d26/transcode_8c.html#a83450dce3d1044fd3a54ea27b71b3c50">econv_convert</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> source_string)
<a name="l03814"></a>03814 {
<a name="l03815"></a>03815     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ret, dst;
<a name="l03816"></a>03816     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> av[5];
<a name="l03817"></a>03817     <span class="keywordtype">int</span> ac;
<a name="l03818"></a>03818     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec = <a class="code" href="../../d3/d26/transcode_8c.html#ade028be95d807054a17d3d3d152f8235">check_econv</a>(<span class="keyword">self</span>);
<a name="l03819"></a>03819 
<a name="l03820"></a>03820     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(source_string);
<a name="l03821"></a>03821 
<a name="l03822"></a>03822     dst = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l03823"></a>03823 
<a name="l03824"></a>03824     av[0] = <a class="code" href="../../db/d2e/intern_8h.html#ae2843c766c24b80116bb127ebf22d5bf">rb_str_dup</a>(source_string);
<a name="l03825"></a>03825     av[1] = dst;
<a name="l03826"></a>03826     av[2] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03827"></a>03827     av[3] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03828"></a>03828     av[4] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(<a class="code" href="../../d5/de3/encoding_8h.html#ab1eeed22e1b00841e21fa4715df0029e">ECONV_PARTIAL_INPUT</a>);
<a name="l03829"></a>03829     ac = 5;
<a name="l03830"></a>03830 
<a name="l03831"></a>03831     ret = <a class="code" href="../../d3/d26/transcode_8c.html#a1c11ab12e2e44160e69623b1049ec540">econv_primitive_convert</a>(ac, av, <span class="keyword">self</span>);
<a name="l03832"></a>03832 
<a name="l03833"></a>03833     <span class="keywordflow">if</span> (ret == <a class="code" href="../../d3/d26/transcode_8c.html#a030b203c7ef931bd8f26d07580e6bdd2">sym_invalid_byte_sequence</a> ||
<a name="l03834"></a>03834         ret == <a class="code" href="../../d3/d26/transcode_8c.html#ad2faaaa9fca9c44a031ef9b9dbee67c9">sym_undefined_conversion</a> ||
<a name="l03835"></a>03835         ret == <a class="code" href="../../d3/d26/transcode_8c.html#aaabae663ba3655668c5f4a2149091a12">sym_incomplete_input</a>) {
<a name="l03836"></a>03836         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> exc = <a class="code" href="../../d3/d26/transcode_8c.html#a7d3e537e8db90f4bf761b0c7f04f6ce4">make_econv_exception</a>(ec);
<a name="l03837"></a>03837         <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(exc);
<a name="l03838"></a>03838     }
<a name="l03839"></a>03839 
<a name="l03840"></a>03840     <span class="keywordflow">if</span> (ret == <a class="code" href="../../d3/d26/transcode_8c.html#ac483d0155fcd9b9db482928ebd1ef465">sym_finished</a>) {
<a name="l03841"></a>03841         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;converter already finished&quot;</span>);
<a name="l03842"></a>03842     }
<a name="l03843"></a>03843 
<a name="l03844"></a>03844     <span class="keywordflow">if</span> (ret != <a class="code" href="../../d3/d26/transcode_8c.html#afb60cd128cc303ec90f2f093e90c6784">sym_source_buffer_empty</a>) {
<a name="l03845"></a>03845         <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;unexpected result of econv_primitive_convert&quot;</span>);
<a name="l03846"></a>03846     }
<a name="l03847"></a>03847 
<a name="l03848"></a>03848     <span class="keywordflow">return</span> dst;
<a name="l03849"></a>03849 }
<a name="l03850"></a>03850 
<a name="l03851"></a>03851 <span class="comment">/*</span>
<a name="l03852"></a>03852 <span class="comment"> * call-seq:</span>
<a name="l03853"></a>03853 <span class="comment"> *   ec.finish -&gt; string</span>
<a name="l03854"></a>03854 <span class="comment"> *</span>
<a name="l03855"></a>03855 <span class="comment"> * Finishes the converter.</span>
<a name="l03856"></a>03856 <span class="comment"> * It returns the last part of the converted string.</span>
<a name="l03857"></a>03857 <span class="comment"> *</span>
<a name="l03858"></a>03858 <span class="comment"> *   ec = Encoding::Converter.new(&quot;utf-8&quot;, &quot;iso-2022-jp&quot;)</span>
<a name="l03859"></a>03859 <span class="comment"> *   p ec.convert(&quot;\u3042&quot;)     #=&gt; &quot;\e$B$\&quot;&quot;</span>
<a name="l03860"></a>03860 <span class="comment"> *   p ec.finish                #=&gt; &quot;\e(B&quot;</span>
<a name="l03861"></a>03861 <span class="comment"> */</span>
<a name="l03862"></a>03862 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03863"></a><a class="code" href="../../d3/d26/transcode_8c.html#a1f2a865f11c06415cb35a9ba2fd7d7c0">03863</a> <a class="code" href="../../d3/d26/transcode_8c.html#a1f2a865f11c06415cb35a9ba2fd7d7c0">econv_finish</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l03864"></a>03864 {
<a name="l03865"></a>03865     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ret, dst;
<a name="l03866"></a>03866     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> av[5];
<a name="l03867"></a>03867     <span class="keywordtype">int</span> ac;
<a name="l03868"></a>03868     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec = <a class="code" href="../../d3/d26/transcode_8c.html#ade028be95d807054a17d3d3d152f8235">check_econv</a>(<span class="keyword">self</span>);
<a name="l03869"></a>03869 
<a name="l03870"></a>03870     dst = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, 0);
<a name="l03871"></a>03871 
<a name="l03872"></a>03872     av[0] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03873"></a>03873     av[1] = dst;
<a name="l03874"></a>03874     av[2] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03875"></a>03875     av[3] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l03876"></a>03876     av[4] = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aca9f83a35416ed9d6e0b860afa5eaf0f">INT2NUM</a>(0);
<a name="l03877"></a>03877     ac = 5;
<a name="l03878"></a>03878 
<a name="l03879"></a>03879     ret = <a class="code" href="../../d3/d26/transcode_8c.html#a1c11ab12e2e44160e69623b1049ec540">econv_primitive_convert</a>(ac, av, <span class="keyword">self</span>);
<a name="l03880"></a>03880 
<a name="l03881"></a>03881     <span class="keywordflow">if</span> (ret == <a class="code" href="../../d3/d26/transcode_8c.html#a030b203c7ef931bd8f26d07580e6bdd2">sym_invalid_byte_sequence</a> ||
<a name="l03882"></a>03882         ret == <a class="code" href="../../d3/d26/transcode_8c.html#ad2faaaa9fca9c44a031ef9b9dbee67c9">sym_undefined_conversion</a> ||
<a name="l03883"></a>03883         ret == <a class="code" href="../../d3/d26/transcode_8c.html#aaabae663ba3655668c5f4a2149091a12">sym_incomplete_input</a>) {
<a name="l03884"></a>03884         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> exc = <a class="code" href="../../d3/d26/transcode_8c.html#a7d3e537e8db90f4bf761b0c7f04f6ce4">make_econv_exception</a>(ec);
<a name="l03885"></a>03885         <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(exc);
<a name="l03886"></a>03886     }
<a name="l03887"></a>03887 
<a name="l03888"></a>03888     <span class="keywordflow">if</span> (ret != <a class="code" href="../../d3/d26/transcode_8c.html#ac483d0155fcd9b9db482928ebd1ef465">sym_finished</a>) {
<a name="l03889"></a>03889         <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;unexpected result of econv_primitive_convert&quot;</span>);
<a name="l03890"></a>03890     }
<a name="l03891"></a>03891 
<a name="l03892"></a>03892     <span class="keywordflow">return</span> dst;
<a name="l03893"></a>03893 }
<a name="l03894"></a>03894 
<a name="l03895"></a>03895 <span class="comment">/*</span>
<a name="l03896"></a>03896 <span class="comment"> * call-seq:</span>
<a name="l03897"></a>03897 <span class="comment"> *   ec.primitive_errinfo -&gt; array</span>
<a name="l03898"></a>03898 <span class="comment"> *</span>
<a name="l03899"></a>03899 <span class="comment"> * primitive_errinfo returns important information regarding the last error</span>
<a name="l03900"></a>03900 <span class="comment"> * as a 5-element array:</span>
<a name="l03901"></a>03901 <span class="comment"> *</span>
<a name="l03902"></a>03902 <span class="comment"> *   [result, enc1, enc2, error_bytes, readagain_bytes]</span>
<a name="l03903"></a>03903 <span class="comment"> *</span>
<a name="l03904"></a>03904 <span class="comment"> * result is the last result of primitive_convert.</span>
<a name="l03905"></a>03905 <span class="comment"> *</span>
<a name="l03906"></a>03906 <span class="comment"> * Other elements are only meaningful when result is</span>
<a name="l03907"></a>03907 <span class="comment"> * :invalid_byte_sequence, :incomplete_input or :undefined_conversion.</span>
<a name="l03908"></a>03908 <span class="comment"> *</span>
<a name="l03909"></a>03909 <span class="comment"> * enc1 and enc2 indicate a conversion step as a pair of strings.</span>
<a name="l03910"></a>03910 <span class="comment"> * For example, a converter from EUC-JP to ISO-8859-1 converts</span>
<a name="l03911"></a>03911 <span class="comment"> * a string as follows: EUC-JP -&gt; UTF-8 -&gt; ISO-8859-1.</span>
<a name="l03912"></a>03912 <span class="comment"> * So [enc1, enc2] is either [&quot;EUC-JP&quot;, &quot;UTF-8&quot;] or [&quot;UTF-8&quot;, &quot;ISO-8859-1&quot;].</span>
<a name="l03913"></a>03913 <span class="comment"> *</span>
<a name="l03914"></a>03914 <span class="comment"> * error_bytes and readagain_bytes indicate the byte sequences which caused the error.</span>
<a name="l03915"></a>03915 <span class="comment"> * error_bytes is discarded portion.</span>
<a name="l03916"></a>03916 <span class="comment"> * readagain_bytes is buffered portion which is read again on next conversion.</span>
<a name="l03917"></a>03917 <span class="comment"> *</span>
<a name="l03918"></a>03918 <span class="comment"> * Example:</span>
<a name="l03919"></a>03919 <span class="comment"> *</span>
<a name="l03920"></a>03920 <span class="comment"> *   # \xff is invalid as EUC-JP.</span>
<a name="l03921"></a>03921 <span class="comment"> *   ec = Encoding::Converter.new(&quot;EUC-JP&quot;, &quot;Shift_JIS&quot;)</span>
<a name="l03922"></a>03922 <span class="comment"> *   ec.primitive_convert(src=&quot;\xff&quot;, dst=&quot;&quot;, nil, 10)</span>
<a name="l03923"></a>03923 <span class="comment"> *   p ec.primitive_errinfo</span>
<a name="l03924"></a>03924 <span class="comment"> *   #=&gt; [:invalid_byte_sequence, &quot;EUC-JP&quot;, &quot;UTF-8&quot;, &quot;\xFF&quot;, &quot;&quot;]</span>
<a name="l03925"></a>03925 <span class="comment"> *</span>
<a name="l03926"></a>03926 <span class="comment"> *   # HIRAGANA LETTER A (\xa4\xa2 in EUC-JP) is not representable in ISO-8859-1.</span>
<a name="l03927"></a>03927 <span class="comment"> *   # Since this error is occur in UTF-8 to ISO-8859-1 conversion,</span>
<a name="l03928"></a>03928 <span class="comment"> *   # error_bytes is HIRAGANA LETTER A in UTF-8 (\xE3\x81\x82).</span>
<a name="l03929"></a>03929 <span class="comment"> *   ec = Encoding::Converter.new(&quot;EUC-JP&quot;, &quot;ISO-8859-1&quot;)</span>
<a name="l03930"></a>03930 <span class="comment"> *   ec.primitive_convert(src=&quot;\xa4\xa2&quot;, dst=&quot;&quot;, nil, 10)</span>
<a name="l03931"></a>03931 <span class="comment"> *   p ec.primitive_errinfo</span>
<a name="l03932"></a>03932 <span class="comment"> *   #=&gt; [:undefined_conversion, &quot;UTF-8&quot;, &quot;ISO-8859-1&quot;, &quot;\xE3\x81\x82&quot;, &quot;&quot;]</span>
<a name="l03933"></a>03933 <span class="comment"> *</span>
<a name="l03934"></a>03934 <span class="comment"> *   # partial character is invalid</span>
<a name="l03935"></a>03935 <span class="comment"> *   ec = Encoding::Converter.new(&quot;EUC-JP&quot;, &quot;ISO-8859-1&quot;)</span>
<a name="l03936"></a>03936 <span class="comment"> *   ec.primitive_convert(src=&quot;\xa4&quot;, dst=&quot;&quot;, nil, 10)</span>
<a name="l03937"></a>03937 <span class="comment"> *   p ec.primitive_errinfo</span>
<a name="l03938"></a>03938 <span class="comment"> *   #=&gt; [:incomplete_input, &quot;EUC-JP&quot;, &quot;UTF-8&quot;, &quot;\xA4&quot;, &quot;&quot;]</span>
<a name="l03939"></a>03939 <span class="comment"> *</span>
<a name="l03940"></a>03940 <span class="comment"> *   # Encoding::Converter::PARTIAL_INPUT prevents invalid errors by</span>
<a name="l03941"></a>03941 <span class="comment"> *   # partial characters.</span>
<a name="l03942"></a>03942 <span class="comment"> *   ec = Encoding::Converter.new(&quot;EUC-JP&quot;, &quot;ISO-8859-1&quot;)</span>
<a name="l03943"></a>03943 <span class="comment"> *   ec.primitive_convert(src=&quot;\xa4&quot;, dst=&quot;&quot;, nil, 10, Encoding::Converter::PARTIAL_INPUT)</span>
<a name="l03944"></a>03944 <span class="comment"> *   p ec.primitive_errinfo</span>
<a name="l03945"></a>03945 <span class="comment"> *   #=&gt; [:source_buffer_empty, nil, nil, nil, nil]</span>
<a name="l03946"></a>03946 <span class="comment"> *</span>
<a name="l03947"></a>03947 <span class="comment"> *   # \xd8\x00\x00@ is invalid as UTF-16BE because</span>
<a name="l03948"></a>03948 <span class="comment"> *   # no low surrogate after high surrogate (\xd8\x00).</span>
<a name="l03949"></a>03949 <span class="comment"> *   # It is detected by 3rd byte (\00) which is part of next character.</span>
<a name="l03950"></a>03950 <span class="comment"> *   # So the high surrogate (\xd8\x00) is discarded and</span>
<a name="l03951"></a>03951 <span class="comment"> *   # the 3rd byte is read again later.</span>
<a name="l03952"></a>03952 <span class="comment"> *   # Since the byte is buffered in ec, it is dropped from src.</span>
<a name="l03953"></a>03953 <span class="comment"> *   ec = Encoding::Converter.new(&quot;UTF-16BE&quot;, &quot;UTF-8&quot;)</span>
<a name="l03954"></a>03954 <span class="comment"> *   ec.primitive_convert(src=&quot;\xd8\x00\x00@&quot;, dst=&quot;&quot;, nil, 10)</span>
<a name="l03955"></a>03955 <span class="comment"> *   p ec.primitive_errinfo</span>
<a name="l03956"></a>03956 <span class="comment"> *   #=&gt; [:invalid_byte_sequence, &quot;UTF-16BE&quot;, &quot;UTF-8&quot;, &quot;\xD8\x00&quot;, &quot;\x00&quot;]</span>
<a name="l03957"></a>03957 <span class="comment"> *   p src</span>
<a name="l03958"></a>03958 <span class="comment"> *   #=&gt; &quot;@&quot;</span>
<a name="l03959"></a>03959 <span class="comment"> *</span>
<a name="l03960"></a>03960 <span class="comment"> *   # Similar to UTF-16BE, \x00\xd8@\x00 is invalid as UTF-16LE.</span>
<a name="l03961"></a>03961 <span class="comment"> *   # The problem is detected by 4th byte.</span>
<a name="l03962"></a>03962 <span class="comment"> *   ec = Encoding::Converter.new(&quot;UTF-16LE&quot;, &quot;UTF-8&quot;)</span>
<a name="l03963"></a>03963 <span class="comment"> *   ec.primitive_convert(src=&quot;\x00\xd8@\x00&quot;, dst=&quot;&quot;, nil, 10)</span>
<a name="l03964"></a>03964 <span class="comment"> *   p ec.primitive_errinfo</span>
<a name="l03965"></a>03965 <span class="comment"> *   #=&gt; [:invalid_byte_sequence, &quot;UTF-16LE&quot;, &quot;UTF-8&quot;, &quot;\x00\xD8&quot;, &quot;@\x00&quot;]</span>
<a name="l03966"></a>03966 <span class="comment"> *   p src</span>
<a name="l03967"></a>03967 <span class="comment"> *   #=&gt; &quot;&quot;</span>
<a name="l03968"></a>03968 <span class="comment"> *</span>
<a name="l03969"></a>03969 <span class="comment"> */</span>
<a name="l03970"></a>03970 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l03971"></a><a class="code" href="../../d3/d26/transcode_8c.html#adc7a6203ad68d85a0c9c96119b9a4575">03971</a> <a class="code" href="../../d3/d26/transcode_8c.html#adc7a6203ad68d85a0c9c96119b9a4575">econv_primitive_errinfo</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l03972"></a>03972 {
<a name="l03973"></a>03973     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec = <a class="code" href="../../d3/d26/transcode_8c.html#ade028be95d807054a17d3d3d152f8235">check_econv</a>(<span class="keyword">self</span>);
<a name="l03974"></a>03974 
<a name="l03975"></a>03975     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary;
<a name="l03976"></a>03976 
<a name="l03977"></a>03977     ary = <a class="code" href="../../dc/dcc/array_8c.html#a43a7bd246935ab63c233b4ae34d61d75">rb_ary_new2</a>(5);
<a name="l03978"></a>03978 
<a name="l03979"></a>03979     <a class="code" href="../../dc/dcc/array_8c.html#a1d7683de2cd34217808092d90ffd0869">rb_ary_store</a>(ary, 0, <a class="code" href="../../d3/d26/transcode_8c.html#a04d9f1519e6d95f29fae24c4db25060a">econv_result_to_symbol</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9db5877b884b6345adb4bd2a0b65b70">result</a>));
<a name="l03980"></a>03980     <a class="code" href="../../dc/dcc/array_8c.html#a1d7683de2cd34217808092d90ffd0869">rb_ary_store</a>(ary, 4, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l03981"></a>03981 
<a name="l03982"></a>03982     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>)
<a name="l03983"></a>03983         <a class="code" href="../../dc/dcc/array_8c.html#a1d7683de2cd34217808092d90ffd0869">rb_ary_store</a>(ary, 1, <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>));
<a name="l03984"></a>03984 
<a name="l03985"></a>03985     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a>)
<a name="l03986"></a>03986         <a class="code" href="../../dc/dcc/array_8c.html#a1d7683de2cd34217808092d90ffd0869">rb_ary_store</a>(ary, 2, <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#ac82ef8d0a6ad3808aa2ddd0a8b22932b">destination_encoding</a>));
<a name="l03987"></a>03987 
<a name="l03988"></a>03988     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#afa032001f9163782b3ffd3f7719c01b2">error_bytes_start</a>) {
<a name="l03989"></a>03989         <a class="code" href="../../dc/dcc/array_8c.html#a1d7683de2cd34217808092d90ffd0869">rb_ary_store</a>(ary, 3, <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *)ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#afa032001f9163782b3ffd3f7719c01b2">error_bytes_start</a>, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a18f4b226842af7c0c379bf21646409af">error_bytes_len</a>));
<a name="l03990"></a>03990         <a class="code" href="../../dc/dcc/array_8c.html#a1d7683de2cd34217808092d90ffd0869">rb_ary_store</a>(ary, 4, <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *)ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#afa032001f9163782b3ffd3f7719c01b2">error_bytes_start</a> + ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a18f4b226842af7c0c379bf21646409af">error_bytes_len</a>, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ab4bd96b93da936d01ad7d052529ac34f">last_error</a>.<a class="code" href="../../d3/d06/structrb__econv__t.html#a2eb533677cfc48e764a7940f034b1634">readagain_len</a>));
<a name="l03991"></a>03991     }
<a name="l03992"></a>03992 
<a name="l03993"></a>03993     <span class="keywordflow">return</span> ary;
<a name="l03994"></a>03994 }
<a name="l03995"></a>03995 
<a name="l03996"></a>03996 <span class="comment">/*</span>
<a name="l03997"></a>03997 <span class="comment"> * call-seq:</span>
<a name="l03998"></a>03998 <span class="comment"> *   ec.insert_output(string) -&gt; nil</span>
<a name="l03999"></a>03999 <span class="comment"> *</span>
<a name="l04000"></a>04000 <span class="comment"> * Inserts string into the encoding converter.</span>
<a name="l04001"></a>04001 <span class="comment"> * The string will be converted to the destination encoding and</span>
<a name="l04002"></a>04002 <span class="comment"> * output on later conversions.</span>
<a name="l04003"></a>04003 <span class="comment"> *</span>
<a name="l04004"></a>04004 <span class="comment"> * If the destination encoding is stateful,</span>
<a name="l04005"></a>04005 <span class="comment"> * string is converted according to the state and the state is updated.</span>
<a name="l04006"></a>04006 <span class="comment"> *</span>
<a name="l04007"></a>04007 <span class="comment"> * This method should be used only when a conversion error occurs.</span>
<a name="l04008"></a>04008 <span class="comment"> *</span>
<a name="l04009"></a>04009 <span class="comment"> *  ec = Encoding::Converter.new(&quot;utf-8&quot;, &quot;iso-8859-1&quot;)</span>
<a name="l04010"></a>04010 <span class="comment"> *  src = &quot;HIRAGANA LETTER A is \u{3042}.&quot;</span>
<a name="l04011"></a>04011 <span class="comment"> *  dst = &quot;&quot;</span>
<a name="l04012"></a>04012 <span class="comment"> *  p ec.primitive_convert(src, dst)    #=&gt; :undefined_conversion</span>
<a name="l04013"></a>04013 <span class="comment"> *  puts &quot;[#{dst.dump}, #{src.dump}]&quot;   #=&gt; [&quot;HIRAGANA LETTER A is &quot;, &quot;.&quot;]</span>
<a name="l04014"></a>04014 <span class="comment"> *  ec.insert_output(&quot;&lt;err&gt;&quot;)</span>
<a name="l04015"></a>04015 <span class="comment"> *  p ec.primitive_convert(src, dst)    #=&gt; :finished</span>
<a name="l04016"></a>04016 <span class="comment"> *  puts &quot;[#{dst.dump}, #{src.dump}]&quot;   #=&gt; [&quot;HIRAGANA LETTER A is &lt;err&gt;.&quot;, &quot;&quot;]</span>
<a name="l04017"></a>04017 <span class="comment"> *</span>
<a name="l04018"></a>04018 <span class="comment"> *  ec = Encoding::Converter.new(&quot;utf-8&quot;, &quot;iso-2022-jp&quot;)</span>
<a name="l04019"></a>04019 <span class="comment"> *  src = &quot;\u{306F 3041 3068 2661 3002}&quot; # U+2661 is not representable in iso-2022-jp</span>
<a name="l04020"></a>04020 <span class="comment"> *  dst = &quot;&quot;</span>
<a name="l04021"></a>04021 <span class="comment"> *  p ec.primitive_convert(src, dst)    #=&gt; :undefined_conversion</span>
<a name="l04022"></a>04022 <span class="comment"> *  puts &quot;[#{dst.dump}, #{src.dump}]&quot;   #=&gt; [&quot;\e$B$O$!$H&quot;.force_encoding(&quot;ISO-2022-JP&quot;), &quot;\xE3\x80\x82&quot;]</span>
<a name="l04023"></a>04023 <span class="comment"> *  ec.insert_output &quot;?&quot;                # state change required to output &quot;?&quot;.</span>
<a name="l04024"></a>04024 <span class="comment"> *  p ec.primitive_convert(src, dst)    #=&gt; :finished</span>
<a name="l04025"></a>04025 <span class="comment"> *  puts &quot;[#{dst.dump}, #{src.dump}]&quot;   #=&gt; [&quot;\e$B$O$!$H\e(B?\e$B!#\e(B&quot;.force_encoding(&quot;ISO-2022-JP&quot;), &quot;&quot;]</span>
<a name="l04026"></a>04026 <span class="comment"> *</span>
<a name="l04027"></a>04027 <span class="comment"> */</span>
<a name="l04028"></a>04028 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04029"></a><a class="code" href="../../d3/d26/transcode_8c.html#aa71ffb801f6cddc4b6691198418c6dc4">04029</a> <a class="code" href="../../d3/d26/transcode_8c.html#aa71ffb801f6cddc4b6691198418c6dc4">econv_insert_output</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keywordtype">string</span>)
<a name="l04030"></a>04030 {
<a name="l04031"></a>04031     <span class="keyword">const</span> <span class="keywordtype">char</span> *insert_enc;
<a name="l04032"></a>04032 
<a name="l04033"></a>04033     <span class="keywordtype">int</span> ret;
<a name="l04034"></a>04034 
<a name="l04035"></a>04035     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec = <a class="code" href="../../d3/d26/transcode_8c.html#ade028be95d807054a17d3d3d152f8235">check_econv</a>(<span class="keyword">self</span>);
<a name="l04036"></a>04036 
<a name="l04037"></a>04037     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(<span class="keywordtype">string</span>);
<a name="l04038"></a>04038     insert_enc = <a class="code" href="../../d5/de3/encoding_8h.html#afed8d708b68f78b68ca62c51b56f0cf0">rb_econv_encoding_to_insert_output</a>(ec);
<a name="l04039"></a>04039     <span class="keywordtype">string</span> = <a class="code" href="../../d5/de3/encoding_8h.html#a92c4c79471eb00ba915287505a118401">rb_str_encode</a>(<span class="keywordtype">string</span>, <a class="code" href="../../d5/db5/encoding_8c.html#ad4918664be7424ab9f961165eecb6c18">rb_enc_from_encoding</a>(<a class="code" href="../../d5/db5/encoding_8c.html#a67638c695b4079ca5f4b6b4cc22ab27a">rb_enc_find</a>(insert_enc)), 0, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>);
<a name="l04040"></a>04040 
<a name="l04041"></a>04041     ret = <a class="code" href="../../d5/de3/encoding_8h.html#a7c02ec315df0f70b167a76155cc97f1c">rb_econv_insert_output</a>(ec, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(<span class="keywordtype">string</span>), <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(<span class="keywordtype">string</span>), insert_enc);
<a name="l04042"></a>04042     <span class="keywordflow">if</span> (ret == -1) {
<a name="l04043"></a>04043         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#ab5e2a9fec766c75176fbb262bfe6a596">rb_eArgError</a>, <span class="stringliteral">&quot;too big string&quot;</span>);
<a name="l04044"></a>04044     }
<a name="l04045"></a>04045 
<a name="l04046"></a>04046     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l04047"></a>04047 }
<a name="l04048"></a>04048 
<a name="l04049"></a>04049 <span class="comment">/*</span>
<a name="l04050"></a>04050 <span class="comment"> * call-seq</span>
<a name="l04051"></a>04051 <span class="comment"> *   ec.putback                    -&gt; string</span>
<a name="l04052"></a>04052 <span class="comment"> *   ec.putback(max_numbytes)      -&gt; string</span>
<a name="l04053"></a>04053 <span class="comment"> *</span>
<a name="l04054"></a>04054 <span class="comment"> * Put back the bytes which will be converted.</span>
<a name="l04055"></a>04055 <span class="comment"> *</span>
<a name="l04056"></a>04056 <span class="comment"> * The bytes are caused by invalid_byte_sequence error.</span>
<a name="l04057"></a>04057 <span class="comment"> * When invalid_byte_sequence error, some bytes are discarded and</span>
<a name="l04058"></a>04058 <span class="comment"> * some bytes are buffered to be converted later.</span>
<a name="l04059"></a>04059 <span class="comment"> * The latter bytes can be put back.</span>
<a name="l04060"></a>04060 <span class="comment"> * It can be observed by</span>
<a name="l04061"></a>04061 <span class="comment"> * Encoding::InvalidByteSequenceError#readagain_bytes and</span>
<a name="l04062"></a>04062 <span class="comment"> * Encoding::Converter#primitive_errinfo.</span>
<a name="l04063"></a>04063 <span class="comment"> *</span>
<a name="l04064"></a>04064 <span class="comment"> *   ec = Encoding::Converter.new(&quot;utf-16le&quot;, &quot;iso-8859-1&quot;)</span>
<a name="l04065"></a>04065 <span class="comment"> *   src = &quot;\x00\xd8\x61\x00&quot;</span>
<a name="l04066"></a>04066 <span class="comment"> *   dst = &quot;&quot;</span>
<a name="l04067"></a>04067 <span class="comment"> *   p ec.primitive_convert(src, dst)   #=&gt; :invalid_byte_sequence</span>
<a name="l04068"></a>04068 <span class="comment"> *   p ec.primitive_errinfo     #=&gt; [:invalid_byte_sequence, &quot;UTF-16LE&quot;, &quot;UTF-8&quot;, &quot;\x00\xD8&quot;, &quot;a\x00&quot;]</span>
<a name="l04069"></a>04069 <span class="comment"> *   p ec.putback               #=&gt; &quot;a\x00&quot;</span>
<a name="l04070"></a>04070 <span class="comment"> *   p ec.putback               #=&gt; &quot;&quot;          # no more bytes to put back</span>
<a name="l04071"></a>04071 <span class="comment"> *</span>
<a name="l04072"></a>04072 <span class="comment"> */</span>
<a name="l04073"></a>04073 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04074"></a><a class="code" href="../../d3/d26/transcode_8c.html#a5079ccad7d7d24f21603e21d857661b1">04074</a> <a class="code" href="../../d3/d26/transcode_8c.html#a5079ccad7d7d24f21603e21d857661b1">econv_putback</a>(<span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l04075"></a>04075 {
<a name="l04076"></a>04076     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec = <a class="code" href="../../d3/d26/transcode_8c.html#ade028be95d807054a17d3d3d152f8235">check_econv</a>(<span class="keyword">self</span>);
<a name="l04077"></a>04077     <span class="keywordtype">int</span> n;
<a name="l04078"></a>04078     <span class="keywordtype">int</span> putbackable;
<a name="l04079"></a>04079     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str, <a class="code" href="../../d1/d6f/date__strftime_8c.html#aa5d960354774dc177393b360c0f90aa9">max</a>;
<a name="l04080"></a>04080 
<a name="l04081"></a>04081     <a class="code" href="../../d7/d19/group__defmethod.html#gaa7bed88640f01bee619f85fda09d28d7">rb_scan_args</a>(argc, argv, <span class="stringliteral">&quot;01&quot;</span>, &amp;max);
<a name="l04082"></a>04082 
<a name="l04083"></a>04083     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(max))
<a name="l04084"></a>04084         n = <a class="code" href="../../d5/de3/encoding_8h.html#a3c4c5466e476fb10e4fe3c63ce08a97d">rb_econv_putbackable</a>(ec);
<a name="l04085"></a>04085     <span class="keywordflow">else</span> {
<a name="l04086"></a>04086         n = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a877c38180d23c5447d976c70dda89d69">NUM2INT</a>(max);
<a name="l04087"></a>04087         putbackable = <a class="code" href="../../d5/de3/encoding_8h.html#a3c4c5466e476fb10e4fe3c63ce08a97d">rb_econv_putbackable</a>(ec);
<a name="l04088"></a>04088         <span class="keywordflow">if</span> (putbackable &lt; n)
<a name="l04089"></a>04089             n = putbackable;
<a name="l04090"></a>04090     }
<a name="l04091"></a>04091 
<a name="l04092"></a>04092     str = <a class="code" href="../../db/d2e/intern_8h.html#a48b2b873adb8b6a04254bd631c4b03c5">rb_str_new</a>(<a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>, n);
<a name="l04093"></a>04093     <a class="code" href="../../d5/de3/encoding_8h.html#af225eb5773352c9eeddb42209047d591">rb_econv_putback</a>(ec, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(str), n);
<a name="l04094"></a>04094 
<a name="l04095"></a>04095     <span class="keywordflow">if</span> (ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>) {
<a name="l04096"></a>04096         <a class="code" href="../../d5/db5/encoding_8c.html#a150a6e3ac22ac3be8f8c2ccc74a28e7b">rb_enc_associate</a>(str, ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a9cc9ad42a580b4015d8d4d85527f87fb">source_encoding</a>);
<a name="l04097"></a>04097     }
<a name="l04098"></a>04098 
<a name="l04099"></a>04099     <span class="keywordflow">return</span> str;
<a name="l04100"></a>04100 }
<a name="l04101"></a>04101 
<a name="l04102"></a>04102 <span class="comment">/*</span>
<a name="l04103"></a>04103 <span class="comment"> * call-seq:</span>
<a name="l04104"></a>04104 <span class="comment"> *   ec.last_error -&gt; exception or nil</span>
<a name="l04105"></a>04105 <span class="comment"> *</span>
<a name="l04106"></a>04106 <span class="comment"> * Returns an exception object for the last conversion.</span>
<a name="l04107"></a>04107 <span class="comment"> * Returns nil if the last conversion did not produce an error.</span>
<a name="l04108"></a>04108 <span class="comment"> *</span>
<a name="l04109"></a>04109 <span class="comment"> * &quot;error&quot; means that</span>
<a name="l04110"></a>04110 <span class="comment"> * Encoding::InvalidByteSequenceError and Encoding::UndefinedConversionError for</span>
<a name="l04111"></a>04111 <span class="comment"> * Encoding::Converter#convert and</span>
<a name="l04112"></a>04112 <span class="comment"> * :invalid_byte_sequence, :incomplete_input and :undefined_conversion for</span>
<a name="l04113"></a>04113 <span class="comment"> * Encoding::Converter#primitive_convert.</span>
<a name="l04114"></a>04114 <span class="comment"> *</span>
<a name="l04115"></a>04115 <span class="comment"> *  ec = Encoding::Converter.new(&quot;utf-8&quot;, &quot;iso-8859-1&quot;)</span>
<a name="l04116"></a>04116 <span class="comment"> *  p ec.primitive_convert(src=&quot;\xf1abcd&quot;, dst=&quot;&quot;)       #=&gt; :invalid_byte_sequence</span>
<a name="l04117"></a>04117 <span class="comment"> *  p ec.last_error      #=&gt; #&lt;Encoding::InvalidByteSequenceError: &quot;\xF1&quot; followed by &quot;a&quot; on UTF-8&gt;</span>
<a name="l04118"></a>04118 <span class="comment"> *  p ec.primitive_convert(src, dst, nil, 1)             #=&gt; :destination_buffer_full</span>
<a name="l04119"></a>04119 <span class="comment"> *  p ec.last_error      #=&gt; nil</span>
<a name="l04120"></a>04120 <span class="comment"> *</span>
<a name="l04121"></a>04121 <span class="comment"> */</span>
<a name="l04122"></a>04122 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04123"></a><a class="code" href="../../d3/d26/transcode_8c.html#ab0def20e8447f7d0626b04c6855aafcd">04123</a> <a class="code" href="../../d3/d26/transcode_8c.html#ab0def20e8447f7d0626b04c6855aafcd">econv_last_error</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l04124"></a>04124 {
<a name="l04125"></a>04125     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec = <a class="code" href="../../d3/d26/transcode_8c.html#ade028be95d807054a17d3d3d152f8235">check_econv</a>(<span class="keyword">self</span>);
<a name="l04126"></a>04126     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> exc;
<a name="l04127"></a>04127 
<a name="l04128"></a>04128     exc = <a class="code" href="../../d3/d26/transcode_8c.html#a7d3e537e8db90f4bf761b0c7f04f6ce4">make_econv_exception</a>(ec);
<a name="l04129"></a>04129     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(exc))
<a name="l04130"></a>04130         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l04131"></a>04131     <span class="keywordflow">return</span> exc;
<a name="l04132"></a>04132 }
<a name="l04133"></a>04133 
<a name="l04134"></a>04134 <span class="comment">/*</span>
<a name="l04135"></a>04135 <span class="comment"> * call-seq:</span>
<a name="l04136"></a>04136 <span class="comment"> *   ec.replacement -&gt; string</span>
<a name="l04137"></a>04137 <span class="comment"> *</span>
<a name="l04138"></a>04138 <span class="comment"> * Returns the replacement string.</span>
<a name="l04139"></a>04139 <span class="comment"> *</span>
<a name="l04140"></a>04140 <span class="comment"> *  ec = Encoding::Converter.new(&quot;euc-jp&quot;, &quot;us-ascii&quot;)</span>
<a name="l04141"></a>04141 <span class="comment"> *  p ec.replacement    #=&gt; &quot;?&quot;</span>
<a name="l04142"></a>04142 <span class="comment"> *</span>
<a name="l04143"></a>04143 <span class="comment"> *  ec = Encoding::Converter.new(&quot;euc-jp&quot;, &quot;utf-8&quot;)</span>
<a name="l04144"></a>04144 <span class="comment"> *  p ec.replacement    #=&gt; &quot;\uFFFD&quot;</span>
<a name="l04145"></a>04145 <span class="comment"> */</span>
<a name="l04146"></a>04146 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04147"></a><a class="code" href="../../d3/d26/transcode_8c.html#a7b13562a057054fd2336c7694fc644f2">04147</a> <a class="code" href="../../d3/d26/transcode_8c.html#a7b13562a057054fd2336c7694fc644f2">econv_get_replacement</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l04148"></a>04148 {
<a name="l04149"></a>04149     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec = <a class="code" href="../../d3/d26/transcode_8c.html#ade028be95d807054a17d3d3d152f8235">check_econv</a>(<span class="keyword">self</span>);
<a name="l04150"></a>04150     <span class="keywordtype">int</span> ret;
<a name="l04151"></a>04151     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc;
<a name="l04152"></a>04152 
<a name="l04153"></a>04153     ret = <a class="code" href="../../d3/d26/transcode_8c.html#a5412744bd0af6ca95571989d436dc76d">make_replacement</a>(ec);
<a name="l04154"></a>04154     <span class="keywordflow">if</span> (ret == -1) {
<a name="l04155"></a>04155         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a7e3c5b7bbf0d72e13a75254e8ab972ee">rb_eUndefinedConversionError</a>, <span class="stringliteral">&quot;replacement character setup failed&quot;</span>);
<a name="l04156"></a>04156     }
<a name="l04157"></a>04157 
<a name="l04158"></a>04158     enc = <a class="code" href="../../d5/db5/encoding_8c.html#a67638c695b4079ca5f4b6b4cc22ab27a">rb_enc_find</a>(ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a875d42c5055651a75e9172e89a53c7c8">replacement_enc</a>);
<a name="l04159"></a>04159     <span class="keywordflow">return</span> <a class="code" href="../../d5/de3/encoding_8h.html#a6707b730597e0e614213beb11670aca2">rb_enc_str_new</a>((<span class="keyword">const</span> <span class="keywordtype">char</span> *)ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#ac9ef89b6cd3baa02b8ec83f49a2d3a2b">replacement_str</a>, (<span class="keywordtype">long</span>)ec-&gt;<a class="code" href="../../d3/d06/structrb__econv__t.html#a40e67fdbe80e48a19ecfeaa9358fd4c2">replacement_len</a>, enc);
<a name="l04160"></a>04160 }
<a name="l04161"></a>04161 
<a name="l04162"></a>04162 <span class="comment">/*</span>
<a name="l04163"></a>04163 <span class="comment"> * call-seq:</span>
<a name="l04164"></a>04164 <span class="comment"> *   ec.replacement = string</span>
<a name="l04165"></a>04165 <span class="comment"> *</span>
<a name="l04166"></a>04166 <span class="comment"> * Sets the replacement string.</span>
<a name="l04167"></a>04167 <span class="comment"> *</span>
<a name="l04168"></a>04168 <span class="comment"> *  ec = Encoding::Converter.new(&quot;utf-8&quot;, &quot;us-ascii&quot;, :undef =&gt; :replace)</span>
<a name="l04169"></a>04169 <span class="comment"> *  ec.replacement = &quot;&lt;undef&gt;&quot;</span>
<a name="l04170"></a>04170 <span class="comment"> *  p ec.convert(&quot;a \u3042 b&quot;)      #=&gt; &quot;a &lt;undef&gt; b&quot;</span>
<a name="l04171"></a>04171 <span class="comment"> */</span>
<a name="l04172"></a>04172 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04173"></a><a class="code" href="../../d3/d26/transcode_8c.html#a5591587c90aaa038ac2aa88ae3c21c45">04173</a> <a class="code" href="../../d3/d26/transcode_8c.html#a5591587c90aaa038ac2aa88ae3c21c45">econv_set_replacement</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg)
<a name="l04174"></a>04174 {
<a name="l04175"></a>04175     <a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec = <a class="code" href="../../d3/d26/transcode_8c.html#ade028be95d807054a17d3d3d152f8235">check_econv</a>(<span class="keyword">self</span>);
<a name="l04176"></a>04176     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keywordtype">string</span> = arg;
<a name="l04177"></a>04177     <span class="keywordtype">int</span> ret;
<a name="l04178"></a>04178     <a class="code" href="../../d1/d7b/struct_onig_encoding_type_s_t.html">rb_encoding</a> *enc;
<a name="l04179"></a>04179 
<a name="l04180"></a>04180     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0e80f207eb41e9010ec9f0f5f9419fea">StringValue</a>(<span class="keywordtype">string</span>);
<a name="l04181"></a>04181     enc = <a class="code" href="../../d5/db5/encoding_8c.html#ac21ed764f3b39453b6a848dd64a19585">rb_enc_get</a>(<span class="keywordtype">string</span>);
<a name="l04182"></a>04182 
<a name="l04183"></a>04183     ret = <a class="code" href="../../d5/de3/encoding_8h.html#af50df105139f4ecc899dea17f3a4bb1b">rb_econv_set_replacement</a>(ec,
<a name="l04184"></a>04184             (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(<span class="keywordtype">string</span>),
<a name="l04185"></a>04185             <a class="code" href="../../d8/df4/generator_8h.html#a1661e63c26c5cbeef7217d05b0f33942">RSTRING_LEN</a>(<span class="keywordtype">string</span>),
<a name="l04186"></a>04186             <a class="code" href="../../d5/de3/encoding_8h.html#a69d59d898802726787a168ef2e0dc92c">rb_enc_name</a>(enc));
<a name="l04187"></a>04187 
<a name="l04188"></a>04188     <span class="keywordflow">if</span> (ret == -1) {
<a name="l04189"></a>04189         <span class="comment">/* xxx: rb_eInvalidByteSequenceError? */</span>
<a name="l04190"></a>04190         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a7e3c5b7bbf0d72e13a75254e8ab972ee">rb_eUndefinedConversionError</a>, <span class="stringliteral">&quot;replacement character setup failed&quot;</span>);
<a name="l04191"></a>04191     }
<a name="l04192"></a>04192 
<a name="l04193"></a>04193     <span class="keywordflow">return</span> arg;
<a name="l04194"></a>04194 }
<a name="l04195"></a>04195 
<a name="l04196"></a>04196 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04197"></a><a class="code" href="../../d3/d26/transcode_8c.html#a97f7e97de80001465896aae6ae28731b">04197</a> <a class="code" href="../../d5/de3/encoding_8h.html#a97f7e97de80001465896aae6ae28731b">rb_econv_make_exception</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec)
<a name="l04198"></a>04198 {
<a name="l04199"></a>04199     <span class="keywordflow">return</span> <a class="code" href="../../d3/d26/transcode_8c.html#a7d3e537e8db90f4bf761b0c7f04f6ce4">make_econv_exception</a>(ec);
<a name="l04200"></a>04200 }
<a name="l04201"></a>04201 
<a name="l04202"></a>04202 <span class="keywordtype">void</span>
<a name="l04203"></a><a class="code" href="../../d3/d26/transcode_8c.html#aa4320e0c296f0bce29ad2d28044dbf62">04203</a> <a class="code" href="../../d5/de3/encoding_8h.html#aa4320e0c296f0bce29ad2d28044dbf62">rb_econv_check_error</a>(<a class="code" href="../../d3/d06/structrb__econv__t.html">rb_econv_t</a> *ec)
<a name="l04204"></a>04204 {
<a name="l04205"></a>04205     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> exc;
<a name="l04206"></a>04206 
<a name="l04207"></a>04207     exc = <a class="code" href="../../d3/d26/transcode_8c.html#a7d3e537e8db90f4bf761b0c7f04f6ce4">make_econv_exception</a>(ec);
<a name="l04208"></a>04208     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(exc))
<a name="l04209"></a>04209         <span class="keywordflow">return</span>;
<a name="l04210"></a>04210     <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(exc);
<a name="l04211"></a>04211 }
<a name="l04212"></a>04212 
<a name="l04213"></a>04213 <span class="comment">/*</span>
<a name="l04214"></a>04214 <span class="comment"> * call-seq:</span>
<a name="l04215"></a>04215 <span class="comment"> *   ecerr.source_encoding_name         -&gt; string</span>
<a name="l04216"></a>04216 <span class="comment"> *</span>
<a name="l04217"></a>04217 <span class="comment"> * Returns the source encoding name as a string.</span>
<a name="l04218"></a>04218 <span class="comment"> */</span>
<a name="l04219"></a>04219 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04220"></a><a class="code" href="../../d3/d26/transcode_8c.html#a6bf74c16a39f3b9ed80feb7cefdd40ab">04220</a> <a class="code" href="../../d3/d26/transcode_8c.html#a6bf74c16a39f3b9ed80feb7cefdd40ab">ecerr_source_encoding_name</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l04221"></a>04221 {
<a name="l04222"></a>04222     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#ab8a448eec4dc767e47f5f9bd35974734">rb_attr_get</a>(<span class="keyword">self</span>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;source_encoding_name&quot;</span>));
<a name="l04223"></a>04223 }
<a name="l04224"></a>04224 
<a name="l04225"></a>04225 <span class="comment">/*</span>
<a name="l04226"></a>04226 <span class="comment"> * call-seq:</span>
<a name="l04227"></a>04227 <span class="comment"> *   ecerr.source_encoding              -&gt; encoding</span>
<a name="l04228"></a>04228 <span class="comment"> *</span>
<a name="l04229"></a>04229 <span class="comment"> * Returns the source encoding as an encoding object.</span>
<a name="l04230"></a>04230 <span class="comment"> *</span>
<a name="l04231"></a>04231 <span class="comment"> * Note that the result may not be equal to the source encoding of</span>
<a name="l04232"></a>04232 <span class="comment"> * the encoding converter if the conversion has multiple steps.</span>
<a name="l04233"></a>04233 <span class="comment"> *</span>
<a name="l04234"></a>04234 <span class="comment"> *  ec = Encoding::Converter.new(&quot;ISO-8859-1&quot;, &quot;EUC-JP&quot;) # ISO-8859-1 -&gt; UTF-8 -&gt; EUC-JP</span>
<a name="l04235"></a>04235 <span class="comment"> *  begin</span>
<a name="l04236"></a>04236 <span class="comment"> *    ec.convert(&quot;\xa0&quot;) # NO-BREAK SPACE, which is available in UTF-8 but not in EUC-JP.</span>
<a name="l04237"></a>04237 <span class="comment"> *  rescue Encoding::UndefinedConversionError</span>
<a name="l04238"></a>04238 <span class="comment"> *    p $!.source_encoding              #=&gt; #&lt;Encoding:UTF-8&gt;</span>
<a name="l04239"></a>04239 <span class="comment"> *    p $!.destination_encoding         #=&gt; #&lt;Encoding:EUC-JP&gt;</span>
<a name="l04240"></a>04240 <span class="comment"> *    p $!.source_encoding_name         #=&gt; &quot;UTF-8&quot;</span>
<a name="l04241"></a>04241 <span class="comment"> *    p $!.destination_encoding_name    #=&gt; &quot;EUC-JP&quot;</span>
<a name="l04242"></a>04242 <span class="comment"> *  end</span>
<a name="l04243"></a>04243 <span class="comment"> *</span>
<a name="l04244"></a>04244 <span class="comment"> */</span>
<a name="l04245"></a>04245 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04246"></a><a class="code" href="../../d3/d26/transcode_8c.html#a4b20ae20b8d17f993154713310d29bb1">04246</a> <a class="code" href="../../d3/d26/transcode_8c.html#a4b20ae20b8d17f993154713310d29bb1">ecerr_source_encoding</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l04247"></a>04247 {
<a name="l04248"></a>04248     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#ab8a448eec4dc767e47f5f9bd35974734">rb_attr_get</a>(<span class="keyword">self</span>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;source_encoding&quot;</span>));
<a name="l04249"></a>04249 }
<a name="l04250"></a>04250 
<a name="l04251"></a>04251 <span class="comment">/*</span>
<a name="l04252"></a>04252 <span class="comment"> * call-seq:</span>
<a name="l04253"></a>04253 <span class="comment"> *   ecerr.destination_encoding_name         -&gt; string</span>
<a name="l04254"></a>04254 <span class="comment"> *</span>
<a name="l04255"></a>04255 <span class="comment"> * Returns the destination encoding name as a string.</span>
<a name="l04256"></a>04256 <span class="comment"> */</span>
<a name="l04257"></a>04257 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04258"></a><a class="code" href="../../d3/d26/transcode_8c.html#a9090a5dee4ea6603c760465b33eef9a8">04258</a> <a class="code" href="../../d3/d26/transcode_8c.html#a9090a5dee4ea6603c760465b33eef9a8">ecerr_destination_encoding_name</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l04259"></a>04259 {
<a name="l04260"></a>04260     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#ab8a448eec4dc767e47f5f9bd35974734">rb_attr_get</a>(<span class="keyword">self</span>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;destination_encoding_name&quot;</span>));
<a name="l04261"></a>04261 }
<a name="l04262"></a>04262 
<a name="l04263"></a>04263 <span class="comment">/*</span>
<a name="l04264"></a>04264 <span class="comment"> * call-seq:</span>
<a name="l04265"></a>04265 <span class="comment"> *   ecerr.destination_encoding         -&gt; string</span>
<a name="l04266"></a>04266 <span class="comment"> *</span>
<a name="l04267"></a>04267 <span class="comment"> * Returns the destination encoding as an encoding object.</span>
<a name="l04268"></a>04268 <span class="comment"> */</span>
<a name="l04269"></a>04269 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04270"></a><a class="code" href="../../d3/d26/transcode_8c.html#abfc9bf8ed21378e4c443f76a299cd7c1">04270</a> <a class="code" href="../../d3/d26/transcode_8c.html#abfc9bf8ed21378e4c443f76a299cd7c1">ecerr_destination_encoding</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l04271"></a>04271 {
<a name="l04272"></a>04272     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#ab8a448eec4dc767e47f5f9bd35974734">rb_attr_get</a>(<span class="keyword">self</span>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;destination_encoding&quot;</span>));
<a name="l04273"></a>04273 }
<a name="l04274"></a>04274 
<a name="l04275"></a>04275 <span class="comment">/*</span>
<a name="l04276"></a>04276 <span class="comment"> * call-seq:</span>
<a name="l04277"></a>04277 <span class="comment"> *   ecerr.error_char         -&gt; string</span>
<a name="l04278"></a>04278 <span class="comment"> *</span>
<a name="l04279"></a>04279 <span class="comment"> * Returns the one-character string which cause Encoding::UndefinedConversionError.</span>
<a name="l04280"></a>04280 <span class="comment"> *</span>
<a name="l04281"></a>04281 <span class="comment"> *  ec = Encoding::Converter.new(&quot;ISO-8859-1&quot;, &quot;EUC-JP&quot;)</span>
<a name="l04282"></a>04282 <span class="comment"> *  begin</span>
<a name="l04283"></a>04283 <span class="comment"> *    ec.convert(&quot;\xa0&quot;)</span>
<a name="l04284"></a>04284 <span class="comment"> *  rescue Encoding::UndefinedConversionError</span>
<a name="l04285"></a>04285 <span class="comment"> *    puts $!.error_char.dump   #=&gt; &quot;\xC2\xA0&quot;</span>
<a name="l04286"></a>04286 <span class="comment"> *    p $!.error_char.encoding  #=&gt; #&lt;Encoding:UTF-8&gt;</span>
<a name="l04287"></a>04287 <span class="comment"> *  end</span>
<a name="l04288"></a>04288 <span class="comment"> *</span>
<a name="l04289"></a>04289 <span class="comment"> */</span>
<a name="l04290"></a>04290 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04291"></a><a class="code" href="../../d3/d26/transcode_8c.html#a8a4c5a74a33983f97b5d9253c18bfecb">04291</a> <a class="code" href="../../d3/d26/transcode_8c.html#a8a4c5a74a33983f97b5d9253c18bfecb">ecerr_error_char</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l04292"></a>04292 {
<a name="l04293"></a>04293     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#ab8a448eec4dc767e47f5f9bd35974734">rb_attr_get</a>(<span class="keyword">self</span>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;error_char&quot;</span>));
<a name="l04294"></a>04294 }
<a name="l04295"></a>04295 
<a name="l04296"></a>04296 <span class="comment">/*</span>
<a name="l04297"></a>04297 <span class="comment"> * call-seq:</span>
<a name="l04298"></a>04298 <span class="comment"> *   ecerr.error_bytes         -&gt; string</span>
<a name="l04299"></a>04299 <span class="comment"> *</span>
<a name="l04300"></a>04300 <span class="comment"> * Returns the discarded bytes when Encoding::InvalidByteSequenceError occurs.</span>
<a name="l04301"></a>04301 <span class="comment"> *</span>
<a name="l04302"></a>04302 <span class="comment"> *  ec = Encoding::Converter.new(&quot;EUC-JP&quot;, &quot;ISO-8859-1&quot;)</span>
<a name="l04303"></a>04303 <span class="comment"> *  begin</span>
<a name="l04304"></a>04304 <span class="comment"> *    ec.convert(&quot;abc\xA1\xFFdef&quot;)</span>
<a name="l04305"></a>04305 <span class="comment"> *  rescue Encoding::InvalidByteSequenceError</span>
<a name="l04306"></a>04306 <span class="comment"> *    p $!      #=&gt; #&lt;Encoding::InvalidByteSequenceError: &quot;\xA1&quot; followed by &quot;\xFF&quot; on EUC-JP&gt;</span>
<a name="l04307"></a>04307 <span class="comment"> *    puts $!.error_bytes.dump          #=&gt; &quot;\xA1&quot;</span>
<a name="l04308"></a>04308 <span class="comment"> *    puts $!.readagain_bytes.dump      #=&gt; &quot;\xFF&quot;</span>
<a name="l04309"></a>04309 <span class="comment"> *  end</span>
<a name="l04310"></a>04310 <span class="comment"> */</span>
<a name="l04311"></a>04311 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04312"></a><a class="code" href="../../d3/d26/transcode_8c.html#af3a4d2797b603fc7b448fcb8849a265a">04312</a> <a class="code" href="../../d3/d26/transcode_8c.html#af3a4d2797b603fc7b448fcb8849a265a">ecerr_error_bytes</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l04313"></a>04313 {
<a name="l04314"></a>04314     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#ab8a448eec4dc767e47f5f9bd35974734">rb_attr_get</a>(<span class="keyword">self</span>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;error_bytes&quot;</span>));
<a name="l04315"></a>04315 }
<a name="l04316"></a>04316 
<a name="l04317"></a>04317 <span class="comment">/*</span>
<a name="l04318"></a>04318 <span class="comment"> * call-seq:</span>
<a name="l04319"></a>04319 <span class="comment"> *   ecerr.readagain_bytes         -&gt; string</span>
<a name="l04320"></a>04320 <span class="comment"> *</span>
<a name="l04321"></a>04321 <span class="comment"> * Returns the bytes to be read again when Encoding::InvalidByteSequenceError occurs.</span>
<a name="l04322"></a>04322 <span class="comment"> */</span>
<a name="l04323"></a>04323 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04324"></a><a class="code" href="../../d3/d26/transcode_8c.html#affa59de8901bc51b34d8422670e7e447">04324</a> <a class="code" href="../../d3/d26/transcode_8c.html#affa59de8901bc51b34d8422670e7e447">ecerr_readagain_bytes</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l04325"></a>04325 {
<a name="l04326"></a>04326     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#ab8a448eec4dc767e47f5f9bd35974734">rb_attr_get</a>(<span class="keyword">self</span>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;readagain_bytes&quot;</span>));
<a name="l04327"></a>04327 }
<a name="l04328"></a>04328 
<a name="l04329"></a>04329 <span class="comment">/*</span>
<a name="l04330"></a>04330 <span class="comment"> * call-seq:</span>
<a name="l04331"></a>04331 <span class="comment"> *   ecerr.incomplete_input?         -&gt; true or false</span>
<a name="l04332"></a>04332 <span class="comment"> *</span>
<a name="l04333"></a>04333 <span class="comment"> * Returns true if the invalid byte sequence error is caused by</span>
<a name="l04334"></a>04334 <span class="comment"> * premature end of string.</span>
<a name="l04335"></a>04335 <span class="comment"> *</span>
<a name="l04336"></a>04336 <span class="comment"> *  ec = Encoding::Converter.new(&quot;EUC-JP&quot;, &quot;ISO-8859-1&quot;)</span>
<a name="l04337"></a>04337 <span class="comment"> *</span>
<a name="l04338"></a>04338 <span class="comment"> *  begin</span>
<a name="l04339"></a>04339 <span class="comment"> *    ec.convert(&quot;abc\xA1z&quot;)</span>
<a name="l04340"></a>04340 <span class="comment"> *  rescue Encoding::InvalidByteSequenceError</span>
<a name="l04341"></a>04341 <span class="comment"> *    p $!      #=&gt; #&lt;Encoding::InvalidByteSequenceError: &quot;\xA1&quot; followed by &quot;z&quot; on EUC-JP&gt;</span>
<a name="l04342"></a>04342 <span class="comment"> *    p $!.incomplete_input?    #=&gt; false</span>
<a name="l04343"></a>04343 <span class="comment"> *  end</span>
<a name="l04344"></a>04344 <span class="comment"> *</span>
<a name="l04345"></a>04345 <span class="comment"> *  begin</span>
<a name="l04346"></a>04346 <span class="comment"> *    ec.convert(&quot;abc\xA1&quot;)</span>
<a name="l04347"></a>04347 <span class="comment"> *    ec.finish</span>
<a name="l04348"></a>04348 <span class="comment"> *  rescue Encoding::InvalidByteSequenceError</span>
<a name="l04349"></a>04349 <span class="comment"> *    p $!      #=&gt; #&lt;Encoding::InvalidByteSequenceError: incomplete &quot;\xA1&quot; on EUC-JP&gt;</span>
<a name="l04350"></a>04350 <span class="comment"> *    p $!.incomplete_input?    #=&gt; true</span>
<a name="l04351"></a>04351 <span class="comment"> *  end</span>
<a name="l04352"></a>04352 <span class="comment"> */</span>
<a name="l04353"></a>04353 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l04354"></a><a class="code" href="../../d3/d26/transcode_8c.html#a8163d727a17d45e85155241e48b23213">04354</a> <a class="code" href="../../d3/d26/transcode_8c.html#a8163d727a17d45e85155241e48b23213">ecerr_incomplete_input</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l04355"></a>04355 {
<a name="l04356"></a>04356     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#ab8a448eec4dc767e47f5f9bd35974734">rb_attr_get</a>(<span class="keyword">self</span>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;incomplete_input&quot;</span>));
<a name="l04357"></a>04357 }
<a name="l04358"></a>04358 
<a name="l04359"></a>04359 <span class="comment">/*</span>
<a name="l04360"></a>04360 <span class="comment"> *  Document-class: Encoding::UndefinedConversionError</span>
<a name="l04361"></a>04361 <span class="comment"> *</span>
<a name="l04362"></a>04362 <span class="comment"> *  Raised by Encoding and String methods when a transcoding operation</span>
<a name="l04363"></a>04363 <span class="comment"> *  fails.</span>
<a name="l04364"></a>04364 <span class="comment"> */</span>
<a name="l04365"></a>04365 
<a name="l04366"></a>04366 <span class="comment">/*</span>
<a name="l04367"></a>04367 <span class="comment"> *  Document-class: Encoding::InvalidByteSequenceError</span>
<a name="l04368"></a>04368 <span class="comment"> *</span>
<a name="l04369"></a>04369 <span class="comment"> *  Raised by Encoding and String methods when the string being</span>
<a name="l04370"></a>04370 <span class="comment"> *  transcoded contains a byte invalid for the either the source or</span>
<a name="l04371"></a>04371 <span class="comment"> *  target encoding.</span>
<a name="l04372"></a>04372 <span class="comment"> */</span>
<a name="l04373"></a>04373 
<a name="l04374"></a>04374 <span class="comment">/*</span>
<a name="l04375"></a>04375 <span class="comment"> *  Document-class: Encoding::ConverterNotFoundError</span>
<a name="l04376"></a>04376 <span class="comment"> *</span>
<a name="l04377"></a>04377 <span class="comment"> *  Raised by transcoding methods when a named encoding does not</span>
<a name="l04378"></a>04378 <span class="comment"> *  correspond with a known converter.</span>
<a name="l04379"></a>04379 <span class="comment"> */</span>
<a name="l04380"></a>04380 
<a name="l04381"></a>04381 <span class="keywordtype">void</span>
<a name="l04382"></a><a class="code" href="../../d3/d26/transcode_8c.html#ac43c7d014daef185f26cdf1d6135e31d">04382</a> <a class="code" href="../../d3/d26/transcode_8c.html#ac43c7d014daef185f26cdf1d6135e31d">Init_transcode</a>(<span class="keywordtype">void</span>)
<a name="l04383"></a>04383 {
<a name="l04384"></a>04384     <a class="code" href="../../d3/d26/transcode_8c.html#a7e3c5b7bbf0d72e13a75254e8ab972ee">rb_eUndefinedConversionError</a> = <a class="code" href="../../de/ddf/group__class.html#ga5266deadce0318d830a1e63c0933b898" title="Defines a class under the namespace of outer.">rb_define_class_under</a>(<a class="code" href="../../d5/db5/encoding_8c.html#a9a2af36eb4187c33c7e8ff329c440966">rb_cEncoding</a>, <span class="stringliteral">&quot;UndefinedConversionError&quot;</span>, <a class="code" href="../../db/dcc/error_8c.html#ada7f59638e6bef5993dc6402ddab1d8a">rb_eEncodingError</a>);
<a name="l04385"></a>04385     <a class="code" href="../../d3/d26/transcode_8c.html#a03c8ae0d4551172220b5981e68539795">rb_eInvalidByteSequenceError</a> = <a class="code" href="../../de/ddf/group__class.html#ga5266deadce0318d830a1e63c0933b898" title="Defines a class under the namespace of outer.">rb_define_class_under</a>(<a class="code" href="../../d5/db5/encoding_8c.html#a9a2af36eb4187c33c7e8ff329c440966">rb_cEncoding</a>, <span class="stringliteral">&quot;InvalidByteSequenceError&quot;</span>, <a class="code" href="../../db/dcc/error_8c.html#ada7f59638e6bef5993dc6402ddab1d8a">rb_eEncodingError</a>);
<a name="l04386"></a>04386     <a class="code" href="../../d3/d26/transcode_8c.html#a17f7c97579ac483f021702f0a8f190ec">rb_eConverterNotFoundError</a> = <a class="code" href="../../de/ddf/group__class.html#ga5266deadce0318d830a1e63c0933b898" title="Defines a class under the namespace of outer.">rb_define_class_under</a>(<a class="code" href="../../d5/db5/encoding_8c.html#a9a2af36eb4187c33c7e8ff329c440966">rb_cEncoding</a>, <span class="stringliteral">&quot;ConverterNotFoundError&quot;</span>, <a class="code" href="../../db/dcc/error_8c.html#ada7f59638e6bef5993dc6402ddab1d8a">rb_eEncodingError</a>);
<a name="l04387"></a>04387 
<a name="l04388"></a>04388     transcoder_table = <a class="code" href="../../dd/d24/st_8h.html#a60f14cceadd837db51e110881258944a">st_init_strcasetable</a>();
<a name="l04389"></a>04389 
<a name="l04390"></a>04390     <a class="code" href="../../d3/d26/transcode_8c.html#a386d27e7ebcb09b9e3beb9c1be41aabe">sym_invalid</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;invalid&quot;</span>));
<a name="l04391"></a>04391     <a class="code" href="../../d3/d26/transcode_8c.html#ade065fa49e1a8a7c21017d79d31da9a7">sym_undef</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;undef&quot;</span>));
<a name="l04392"></a>04392     <a class="code" href="../../d3/d26/transcode_8c.html#ab15aaca5bc3b3652d2c7b243bec3c342">sym_replace</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;replace&quot;</span>));
<a name="l04393"></a>04393     <a class="code" href="../../d3/d26/transcode_8c.html#a338cb4cb4bd7d8994da411e0b1bfbb21">sym_fallback</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;fallback&quot;</span>));
<a name="l04394"></a>04394     <a class="code" href="../../d3/d26/transcode_8c.html#a000881fcf4572b2a9a3216b3aeae05dc">sym_aref</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;[]&quot;</span>));
<a name="l04395"></a>04395     <a class="code" href="../../d3/d26/transcode_8c.html#a6280c8826ff0dd1c47767aab5d17452b">sym_xml</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;xml&quot;</span>));
<a name="l04396"></a>04396     <a class="code" href="../../d3/d26/transcode_8c.html#a7a02b57ce7a33ad046278fbee16b0224">sym_text</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;text&quot;</span>));
<a name="l04397"></a>04397     <a class="code" href="../../d3/d26/transcode_8c.html#a131583b160da3ae2c6ba8c0686037596">sym_attr</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;attr&quot;</span>));
<a name="l04398"></a>04398 
<a name="l04399"></a>04399     <a class="code" href="../../d3/d26/transcode_8c.html#a030b203c7ef931bd8f26d07580e6bdd2">sym_invalid_byte_sequence</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;invalid_byte_sequence&quot;</span>));
<a name="l04400"></a>04400     <a class="code" href="../../d3/d26/transcode_8c.html#ad2faaaa9fca9c44a031ef9b9dbee67c9">sym_undefined_conversion</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;undefined_conversion&quot;</span>));
<a name="l04401"></a>04401     <a class="code" href="../../d3/d26/transcode_8c.html#ad1e9bae611dd45dfca6a189c14a332dc">sym_destination_buffer_full</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;destination_buffer_full&quot;</span>));
<a name="l04402"></a>04402     <a class="code" href="../../d3/d26/transcode_8c.html#afb60cd128cc303ec90f2f093e90c6784">sym_source_buffer_empty</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;source_buffer_empty&quot;</span>));
<a name="l04403"></a>04403     <a class="code" href="../../d3/d26/transcode_8c.html#ac483d0155fcd9b9db482928ebd1ef465">sym_finished</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;finished&quot;</span>));
<a name="l04404"></a>04404     <a class="code" href="../../d3/d26/transcode_8c.html#a4eefe22a7d2bf258488987a25134318c">sym_after_output</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;after_output&quot;</span>));
<a name="l04405"></a>04405     <a class="code" href="../../d3/d26/transcode_8c.html#aaabae663ba3655668c5f4a2149091a12">sym_incomplete_input</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;incomplete_input&quot;</span>));
<a name="l04406"></a>04406     <a class="code" href="../../d3/d26/transcode_8c.html#a544876157eb56fdee18d20866275045d">sym_universal_newline</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;universal_newline&quot;</span>));
<a name="l04407"></a>04407     <a class="code" href="../../d3/d26/transcode_8c.html#a4eb4af234eff2e556aaff8d5583a182e">sym_crlf_newline</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;crlf_newline&quot;</span>));
<a name="l04408"></a>04408     <a class="code" href="../../d3/d26/transcode_8c.html#ad2b9d4c5055c29b3f5ead8fe8218d74c">sym_cr_newline</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;cr_newline&quot;</span>));
<a name="l04409"></a>04409     <a class="code" href="../../d3/d26/transcode_8c.html#a1bcb1cddad7f1faa7bcac7e136592a7f">sym_partial_input</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;partial_input&quot;</span>));
<a name="l04410"></a>04410 
<a name="l04411"></a>04411 <span class="preprocessor">#ifdef ENABLE_ECONV_NEWLINE_OPTION</span>
<a name="l04412"></a>04412 <span class="preprocessor"></span>    <a class="code" href="../../d3/d26/transcode_8c.html#a2e8f88ddab931a79be2bb4dabf52e5f3">sym_newline</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;newline&quot;</span>));
<a name="l04413"></a>04413     <a class="code" href="../../d3/d26/transcode_8c.html#a865013f3f9a72c761d4f62c492bdac32">sym_universal</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;universal&quot;</span>));
<a name="l04414"></a>04414     <a class="code" href="../../d3/d26/transcode_8c.html#a9e00c2b0789779dc6c482d37301c11e2">sym_crlf</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;crlf&quot;</span>));
<a name="l04415"></a>04415     <a class="code" href="../../d3/d26/transcode_8c.html#ab80c9d144cbc45017e4a43a1edfa6839">sym_cr</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;cr&quot;</span>));
<a name="l04416"></a>04416     <a class="code" href="../../d3/d26/transcode_8c.html#ac7906406a2eed9ca677be5ee09187c36">sym_lf</a> = <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;lf&quot;</span>));
<a name="l04417"></a>04417 <span class="preprocessor">#endif</span>
<a name="l04418"></a>04418 <span class="preprocessor"></span>
<a name="l04419"></a>04419     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7d36c9c3e9faa34c27eb7f2eb9c874a8">rb_cString</a>, <span class="stringliteral">&quot;encode&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a11b921a25d3b0d83e743dd40547eedf8">str_encode</a>, -1);
<a name="l04420"></a>04420     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7d36c9c3e9faa34c27eb7f2eb9c874a8">rb_cString</a>, <span class="stringliteral">&quot;encode!&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a30b2307d43145ce1d948d9f329912586">str_encode_bang</a>, -1);
<a name="l04421"></a>04421 
<a name="l04422"></a>04422     <a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a> = <a class="code" href="../../de/ddf/group__class.html#ga5266deadce0318d830a1e63c0933b898" title="Defines a class under the namespace of outer.">rb_define_class_under</a>(<a class="code" href="../../d5/db5/encoding_8c.html#a9a2af36eb4187c33c7e8ff329c440966">rb_cEncoding</a>, <span class="stringliteral">&quot;Converter&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a39cf94183e6d744167ae5f6a7bde0363">rb_cData</a>);
<a name="l04423"></a>04423     <a class="code" href="../../db/d2e/intern_8h.html#a6c99ed7f070458b961026d43d27d0642">rb_define_alloc_func</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <a class="code" href="../../d3/d26/transcode_8c.html#a0a347fc203d4703ec5c9b35d039adbf2">econv_s_allocate</a>);
<a name="l04424"></a>04424     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;asciicompat_encoding&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a6cd6cfcca75c2ca0e7a809a3c6e37a4b">econv_s_asciicompat_encoding</a>, 1);
<a name="l04425"></a>04425     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;search_convpath&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#ab1e1d65c8eab3b2c54159d45fe60027d">econv_s_search_convpath</a>, -1);
<a name="l04426"></a>04426     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;initialize&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a7d3a4a7f5d16e9e896d0b1ca4b94031d">econv_init</a>, -1);
<a name="l04427"></a>04427     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;inspect&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a63a1ab211bacaea5113954f95b2ed867">econv_inspect</a>, 0);
<a name="l04428"></a>04428     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;convpath&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a18688b107b29265dbb50b0a13ca5d1f9">econv_convpath</a>, 0);
<a name="l04429"></a>04429     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;source_encoding&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#aae68615a40e4ab509f6863a941498527">econv_source_encoding</a>, 0);
<a name="l04430"></a>04430     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;destination_encoding&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a12af29e0ad7153fc744b5f39ada979ec">econv_destination_encoding</a>, 0);
<a name="l04431"></a>04431     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;primitive_convert&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a1c11ab12e2e44160e69623b1049ec540">econv_primitive_convert</a>, -1);
<a name="l04432"></a>04432     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;convert&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a83450dce3d1044fd3a54ea27b71b3c50">econv_convert</a>, 1);
<a name="l04433"></a>04433     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;finish&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a1f2a865f11c06415cb35a9ba2fd7d7c0">econv_finish</a>, 0);
<a name="l04434"></a>04434     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;primitive_errinfo&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#adc7a6203ad68d85a0c9c96119b9a4575">econv_primitive_errinfo</a>, 0);
<a name="l04435"></a>04435     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;insert_output&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#aa71ffb801f6cddc4b6691198418c6dc4">econv_insert_output</a>, 1);
<a name="l04436"></a>04436     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;putback&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a5079ccad7d7d24f21603e21d857661b1">econv_putback</a>, -1);
<a name="l04437"></a>04437     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;last_error&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#ab0def20e8447f7d0626b04c6855aafcd">econv_last_error</a>, 0);
<a name="l04438"></a>04438     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;replacement&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a7b13562a057054fd2336c7694fc644f2">econv_get_replacement</a>, 0);
<a name="l04439"></a>04439     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;replacement=&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a5591587c90aaa038ac2aa88ae3c21c45">econv_set_replacement</a>, 1);
<a name="l04440"></a>04440     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;==&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a1f44c4c06fe2491bed5041a7d45563fc">econv_equal</a>, 1);
<a name="l04441"></a>04441 
<a name="l04442"></a>04442     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;INVALID_MASK&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a35362ab9dd9238808cc988ec66fd686b">ECONV_INVALID_MASK</a>));
<a name="l04443"></a>04443     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;INVALID_REPLACE&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a6ebf7f037784cbfd05d0d7930532f796">ECONV_INVALID_REPLACE</a>));
<a name="l04444"></a>04444     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;UNDEF_MASK&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a9ed00f64e0c2ec41df7747700fb17f24">ECONV_UNDEF_MASK</a>));
<a name="l04445"></a>04445     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;UNDEF_REPLACE&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a4f8674ffeb3e7e562628f54ff0a10f4e">ECONV_UNDEF_REPLACE</a>));
<a name="l04446"></a>04446     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;UNDEF_HEX_CHARREF&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../d5/de3/encoding_8h.html#acc5cca239974f158070f17e09202fb69">ECONV_UNDEF_HEX_CHARREF</a>));
<a name="l04447"></a>04447     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;PARTIAL_INPUT&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../d5/de3/encoding_8h.html#ab1eeed22e1b00841e21fa4715df0029e">ECONV_PARTIAL_INPUT</a>));
<a name="l04448"></a>04448     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;AFTER_OUTPUT&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a0311828d8ad5d3ba4bdce5fd9244301b">ECONV_AFTER_OUTPUT</a>));
<a name="l04449"></a>04449     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;UNIVERSAL_NEWLINE_DECORATOR&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a122d5f3118774ae1a01a3262c73141eb">ECONV_UNIVERSAL_NEWLINE_DECORATOR</a>));
<a name="l04450"></a>04450     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;CRLF_NEWLINE_DECORATOR&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a38b80a28fd1ac8423761193a71d7752c">ECONV_CRLF_NEWLINE_DECORATOR</a>));
<a name="l04451"></a>04451     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;CR_NEWLINE_DECORATOR&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a64019d94f530b33a149a2016278cc940">ECONV_CR_NEWLINE_DECORATOR</a>));
<a name="l04452"></a>04452     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;XML_TEXT_DECORATOR&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a5477824dfc0b7b9f38411f309610fe69">ECONV_XML_TEXT_DECORATOR</a>));
<a name="l04453"></a>04453     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;XML_ATTR_CONTENT_DECORATOR&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a30366abfd546975d8e5c945289afb9a2">ECONV_XML_ATTR_CONTENT_DECORATOR</a>));
<a name="l04454"></a>04454     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a53070fb3db5f377c704a6ac63b3eda2b">rb_cEncodingConverter</a>, <span class="stringliteral">&quot;XML_ATTR_QUOTE_DECORATOR&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac55fae7f748afd3fc2533d0d7d06cf5a">INT2FIX</a>(<a class="code" href="../../d5/de3/encoding_8h.html#a01a2578ca9179596c418d8ad3ce946d5">ECONV_XML_ATTR_QUOTE_DECORATOR</a>));
<a name="l04455"></a>04455 
<a name="l04456"></a>04456     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a7e3c5b7bbf0d72e13a75254e8ab972ee">rb_eUndefinedConversionError</a>, <span class="stringliteral">&quot;source_encoding_name&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a6bf74c16a39f3b9ed80feb7cefdd40ab">ecerr_source_encoding_name</a>, 0);
<a name="l04457"></a>04457     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a7e3c5b7bbf0d72e13a75254e8ab972ee">rb_eUndefinedConversionError</a>, <span class="stringliteral">&quot;destination_encoding_name&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a9090a5dee4ea6603c760465b33eef9a8">ecerr_destination_encoding_name</a>, 0);
<a name="l04458"></a>04458     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a7e3c5b7bbf0d72e13a75254e8ab972ee">rb_eUndefinedConversionError</a>, <span class="stringliteral">&quot;source_encoding&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a4b20ae20b8d17f993154713310d29bb1">ecerr_source_encoding</a>, 0);
<a name="l04459"></a>04459     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a7e3c5b7bbf0d72e13a75254e8ab972ee">rb_eUndefinedConversionError</a>, <span class="stringliteral">&quot;destination_encoding&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#abfc9bf8ed21378e4c443f76a299cd7c1">ecerr_destination_encoding</a>, 0);
<a name="l04460"></a>04460     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a7e3c5b7bbf0d72e13a75254e8ab972ee">rb_eUndefinedConversionError</a>, <span class="stringliteral">&quot;error_char&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a8a4c5a74a33983f97b5d9253c18bfecb">ecerr_error_char</a>, 0);
<a name="l04461"></a>04461 
<a name="l04462"></a>04462     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a03c8ae0d4551172220b5981e68539795">rb_eInvalidByteSequenceError</a>, <span class="stringliteral">&quot;source_encoding_name&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a6bf74c16a39f3b9ed80feb7cefdd40ab">ecerr_source_encoding_name</a>, 0);
<a name="l04463"></a>04463     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a03c8ae0d4551172220b5981e68539795">rb_eInvalidByteSequenceError</a>, <span class="stringliteral">&quot;destination_encoding_name&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a9090a5dee4ea6603c760465b33eef9a8">ecerr_destination_encoding_name</a>, 0);
<a name="l04464"></a>04464     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a03c8ae0d4551172220b5981e68539795">rb_eInvalidByteSequenceError</a>, <span class="stringliteral">&quot;source_encoding&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a4b20ae20b8d17f993154713310d29bb1">ecerr_source_encoding</a>, 0);
<a name="l04465"></a>04465     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a03c8ae0d4551172220b5981e68539795">rb_eInvalidByteSequenceError</a>, <span class="stringliteral">&quot;destination_encoding&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#abfc9bf8ed21378e4c443f76a299cd7c1">ecerr_destination_encoding</a>, 0);
<a name="l04466"></a>04466     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a03c8ae0d4551172220b5981e68539795">rb_eInvalidByteSequenceError</a>, <span class="stringliteral">&quot;error_bytes&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#af3a4d2797b603fc7b448fcb8849a265a">ecerr_error_bytes</a>, 0);
<a name="l04467"></a>04467     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a03c8ae0d4551172220b5981e68539795">rb_eInvalidByteSequenceError</a>, <span class="stringliteral">&quot;readagain_bytes&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#affa59de8901bc51b34d8422670e7e447">ecerr_readagain_bytes</a>, 0);
<a name="l04468"></a>04468     <a class="code" href="../../d7/d19/group__defmethod.html#ga118dc7abcdb97f56fe35727ac0ff6eb8">rb_define_method</a>(<a class="code" href="../../d3/d26/transcode_8c.html#a03c8ae0d4551172220b5981e68539795">rb_eInvalidByteSequenceError</a>, <span class="stringliteral">&quot;incomplete_input?&quot;</span>, <a class="code" href="../../d3/d26/transcode_8c.html#a8163d727a17d45e85155241e48b23213">ecerr_incomplete_input</a>, 0);
<a name="l04469"></a>04469 
<a name="l04470"></a>04470     <a class="code" href="../../db/d51/enc_2trans_2newline_8c.html#a06a661d74d7bbf188dcc66237c113e3d">Init_newline</a>();
<a name="l04471"></a>04471 }
<a name="l04472"></a>04472 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Mar 2013 for Ruby by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
