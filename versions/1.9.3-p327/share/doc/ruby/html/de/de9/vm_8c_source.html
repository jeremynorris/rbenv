<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Ruby: vm.c Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<link href="../../doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="../../index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="../../modules.html"><span>Modules</span></a></li>
      <li><a href="../../annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="../../files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="../../files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="../../globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>vm.c</h1><a href="../../de/de9/vm_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/**********************************************************************</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">  vm.c -</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">  $Author: usa $</span>
<a name="l00006"></a>00006 <span class="comment"></span>
<a name="l00007"></a>00007 <span class="comment">  Copyright (C) 2004-2007 Koichi Sasada</span>
<a name="l00008"></a>00008 <span class="comment"></span>
<a name="l00009"></a>00009 <span class="comment">**********************************************************************/</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="preprocessor">#include &quot;<a class="code" href="../../de/de6/ruby_2ruby_8h.html">ruby/ruby.h</a>&quot;</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include &quot;<a class="code" href="../../da/d0a/vm_8h.html">ruby/vm.h</a>&quot;</span>
<a name="l00013"></a>00013 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/d24/st_8h.html">ruby/st.h</a>&quot;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/de3/encoding_8h.html">ruby/encoding.h</a>&quot;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &quot;<a class="code" href="../../db/dde/internal_8h.html">internal.h</a>&quot;</span>
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/daa/gc_8h.html">gc.h</a>&quot;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &quot;<a class="code" href="../../d8/d32/vm__core_8h.html">vm_core.h</a>&quot;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &quot;<a class="code" href="../../d7/dc8/iseq_8h.html">iseq.h</a>&quot;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="../../dd/dd0/eval__intern_8h.html">eval_intern.h</a>&quot;</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="../../d2/d5f/vm__insnhelper_8h.html">vm_insnhelper.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="../../d0/db2/vm__insnhelper_8c.html">vm_insnhelper.c</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="../../d5/d4b/vm__exec_8h.html">vm_exec.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="../../df/d38/vm__exec_8c.html">vm_exec.c</a>&quot;</span>
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="../../de/d63/vm__method_8c.html">vm_method.c</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="../../d3/d80/vm__eval_8c.html">vm_eval.c</a>&quot;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a><a class="code" href="../../de/de9/vm_8c.html#aeca034f67218340ecb2261a22c2f3dcd">00032</a> <span class="preprocessor">#define BUFSIZE 0x100</span>
<a name="l00033"></a><a class="code" href="../../de/de9/vm_8c.html#a750084962ee12011b63dd0b901058f71">00033</a> <span class="preprocessor"></span><span class="preprocessor">#define PROCDEBUG 0</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span>
<a name="l00035"></a><a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">00035</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a>;
<a name="l00036"></a><a class="code" href="../../de/de9/vm_8c.html#aade475ee7a5ceb8e727ec38287af0e95">00036</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0d59a418d5956d62076394536ee21dc6">rb_cThread</a>;
<a name="l00037"></a><a class="code" href="../../de/de9/vm_8c.html#ad55204994fe946dcd317061047845c3a">00037</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/de9/vm_8c.html#ad55204994fe946dcd317061047845c3a">rb_cEnv</a>;
<a name="l00038"></a><a class="code" href="../../de/de9/vm_8c.html#a15744aab342112335b9189c8911ba625">00038</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/de9/vm_8c.html#a15744aab342112335b9189c8911ba625">rb_mRubyVMFrozenCore</a>;
<a name="l00039"></a>00039 
<a name="l00040"></a><a class="code" href="../../d2/d5f/vm__insnhelper_8h.html#a29d64659d230fbf7dc7326585cdaa8e5">00040</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/de9/vm_8c.html#a29d64659d230fbf7dc7326585cdaa8e5">ruby_vm_const_missing_count</a> = 0;
<a name="l00041"></a>00041 
<a name="l00042"></a><a class="code" href="../../d2/d5f/vm__insnhelper_8h.html#ae7ebc888013290c4c514a63794167a87">00042</a> <span class="keywordtype">char</span> <a class="code" href="../../de/de9/vm_8c.html#ae7ebc888013290c4c514a63794167a87">ruby_vm_redefined_flag</a>[<a class="code" href="../../d2/d5f/vm__insnhelper_8h.html#a7859c0a3efa8b1c360f5c2376baf051ea234b86bd36a499b3fde775c6f4034108">BOP_LAST_</a>];
<a name="l00043"></a>00043 
<a name="l00044"></a><a class="code" href="../../de/de9/vm_8c.html#a21823fe13ba76a2161c1b35286853e32">00044</a> <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *<a class="code" href="../../de/de9/vm_8c.html#a21823fe13ba76a2161c1b35286853e32">ruby_current_thread</a> = 0;
<a name="l00045"></a><a class="code" href="../../d8/d32/vm__core_8h.html#a9be24d2deecfd3c43942e8c7cc4770a1">00045</a> <a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *<a class="code" href="../../de/de9/vm_8c.html#a9be24d2deecfd3c43942e8c7cc4770a1">ruby_current_vm</a> = 0;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/de9/vm_8c.html#afa313ee08837bb9545102cd3f28d91a7">thread_free</a>(<span class="keywordtype">void</span> *ptr);
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="keywordtype">void</span> <a class="code" href="../../de/de9/vm_8c.html#a70b2fd040eae21f04d68a7a6f7ee1a05">vm_analysis_operand</a>(<span class="keywordtype">int</span> insn, <span class="keywordtype">int</span> n, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> op);
<a name="l00050"></a>00050 <span class="keywordtype">void</span> <a class="code" href="../../de/de9/vm_8c.html#a22af4689a1b73006b14a25502191cde5">vm_analysis_register</a>(<span class="keywordtype">int</span> reg, <span class="keywordtype">int</span> isset);
<a name="l00051"></a>00051 <span class="keywordtype">void</span> <a class="code" href="../../de/de9/vm_8c.html#aadc79f2891643166c13ed45e187396f2">vm_analysis_insn</a>(<span class="keywordtype">int</span> insn);
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="comment">/*</span>
<a name="l00054"></a>00054 <span class="comment"> * TODO: replace with better interface at the next release.</span>
<a name="l00055"></a>00055 <span class="comment"> *</span>
<a name="l00056"></a>00056 <span class="comment"> * these functions are exported just as a workaround for ruby-debug</span>
<a name="l00057"></a>00057 <span class="comment"> * for the time being.</span>
<a name="l00058"></a>00058 <span class="comment"> */</span>
<a name="l00059"></a>00059 RUBY_FUNC_EXPORTED <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/de9/vm_8c.html#a38087978d8bc36f8cd48b62b70b15000">rb_vm_make_env_object</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp);
<a name="l00060"></a>00060 RUBY_FUNC_EXPORTED <span class="keywordtype">int</span> <a class="code" href="../../de/de9/vm_8c.html#a70289cbb34babceed6243d9471e70e5f">rb_vm_get_sourceline</a>(<span class="keyword">const</span> <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp);
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="keywordtype">void</span>
<a name="l00063"></a><a class="code" href="../../d8/d32/vm__core_8h.html#a6fc04023a326c5129423edebf52894fd">00063</a> <a class="code" href="../../de/de9/vm_8c.html#a6fc04023a326c5129423edebf52894fd">rb_vm_change_state</a>(<span class="keywordtype">void</span>)
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065     <a class="code" href="../../d2/d5f/vm__insnhelper_8h.html#a8e91da0eaddd34a78c8f9c5207df8979">INC_VM_STATE_VERSION</a>();
<a name="l00066"></a>00066 }
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/de9/vm_8c.html#a6ac679a303e8be8dffedf08bc252a624">vm_clear_global_method_cache</a>(<span class="keywordtype">void</span>);
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00071"></a><a class="code" href="../../de/de9/vm_8c.html#a7387e7f9d917b598fbda1ce48f6122c5">00071</a> <a class="code" href="../../de/de9/vm_8c.html#a7387e7f9d917b598fbda1ce48f6122c5">vm_clear_all_inline_method_cache</a>(<span class="keywordtype">void</span>)
<a name="l00072"></a>00072 {
<a name="l00073"></a>00073     <span class="comment">/* TODO: Clear all inline cache entries in all iseqs.</span>
<a name="l00074"></a>00074 <span class="comment">             How to iterate all iseqs in sweep phase?</span>
<a name="l00075"></a>00075 <span class="comment">             rb_objspace_each_objects() doesn&apos;t work at sweep phase.</span>
<a name="l00076"></a>00076 <span class="comment">     */</span>
<a name="l00077"></a>00077 }
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00080"></a><a class="code" href="../../de/de9/vm_8c.html#a2fa957ea281fa0f0ea74f4070cf04724">00080</a> <a class="code" href="../../de/de9/vm_8c.html#a2fa957ea281fa0f0ea74f4070cf04724">vm_clear_all_cache</a>()
<a name="l00081"></a>00081 {
<a name="l00082"></a>00082     <a class="code" href="../../de/de9/vm_8c.html#a6ac679a303e8be8dffedf08bc252a624">vm_clear_global_method_cache</a>();
<a name="l00083"></a>00083     <a class="code" href="../../de/de9/vm_8c.html#a7387e7f9d917b598fbda1ce48f6122c5">vm_clear_all_inline_method_cache</a>();
<a name="l00084"></a>00084     <a class="code" href="../../d2/d5f/vm__insnhelper_8h.html#ac14920989929283916448dfe53244cec">ruby_vm_global_state_version</a> = 1;
<a name="l00085"></a>00085 }
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="keywordtype">void</span>
<a name="l00088"></a><a class="code" href="../../d8/d32/vm__core_8h.html#aff09679bd9e7c102ed3e3c3c6c04e182">00088</a> <a class="code" href="../../de/de9/vm_8c.html#aff09679bd9e7c102ed3e3c3c6c04e182">rb_vm_inc_const_missing_count</a>(<span class="keywordtype">void</span>)
<a name="l00089"></a>00089 {
<a name="l00090"></a>00090     <a class="code" href="../../de/de9/vm_8c.html#a29d64659d230fbf7dc7326585cdaa8e5">ruby_vm_const_missing_count</a> +=1;
<a name="l00091"></a>00091 }
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="comment">/* control stack frame */</span>
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00096"></a><a class="code" href="../../de/de9/vm_8c.html#aa8deb4813e5d237bb18713ddb5d98b74">00096</a> <a class="code" href="../../de/de9/vm_8c.html#aa8deb4813e5d237bb18713ddb5d98b74">rb_vm_set_finish_env</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> * th)
<a name="l00097"></a>00097 {
<a name="l00098"></a>00098     <a class="code" href="../../d0/db2/vm__insnhelper_8c.html#a30340566da5743c4d660c8931dffd86e">vm_push_frame</a>(th, 0, <a class="code" href="../../d8/d32/vm__core_8h.html#a885c6468caef6c3de80b0ad6c50ae38d">VM_FRAME_MAGIC_FINISH</a>,
<a name="l00099"></a>00099                   <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a>[0], 0,
<a name="l00100"></a>00100                   th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a>, 0, 1);
<a name="l00101"></a>00101     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a28b0b301811a891225ba9a58c412482d">pc</a> = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *)&amp;<a class="code" href="../../df/d38/vm__exec_8c.html#a6f84f6d4b822e9b021a1e64cacf21847">finish_insn_seq</a>[0];
<a name="l00102"></a>00102     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00106"></a><a class="code" href="../../de/de9/vm_8c.html#a835b4cd0571894b624a302e8d2b736de">00106</a> <a class="code" href="../../de/de9/vm_8c.html#a835b4cd0571894b624a302e8d2b736de">vm_set_top_stack</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> * th, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> iseqval)
<a name="l00107"></a>00107 {
<a name="l00108"></a>00108     <a class="code" href="../../d6/de3/structrb__iseq__struct.html">rb_iseq_t</a> *iseq;
<a name="l00109"></a>00109     <a class="code" href="../../d8/d32/vm__core_8h.html#a5e6a3515e0ad9b9d6a4c0ab577dc50b6">GetISeqPtr</a>(iseqval, iseq);
<a name="l00110"></a>00110 
<a name="l00111"></a>00111     <span class="keywordflow">if</span> (iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#af8bc7dbae6f61d836b5bb9fb50b6cfb8">type</a> != ISEQ_TYPE_TOP) {
<a name="l00112"></a>00112         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a565ed9d70f4089e1b4a36e9b3381b8c6">rb_eTypeError</a>, <span class="stringliteral">&quot;Not a toplevel InstructionSequence&quot;</span>);
<a name="l00113"></a>00113     }
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     <span class="comment">/* for return */</span>
<a name="l00116"></a>00116     <a class="code" href="../../de/de9/vm_8c.html#aa8deb4813e5d237bb18713ddb5d98b74">rb_vm_set_finish_env</a>(th);
<a name="l00117"></a>00117 
<a name="l00118"></a>00118     <a class="code" href="../../d0/db2/vm__insnhelper_8c.html#a30340566da5743c4d660c8931dffd86e">vm_push_frame</a>(th, iseq, <a class="code" href="../../d8/d32/vm__core_8h.html#ac9390ef02c17a0bc7e3bd359264562c7">VM_FRAME_MAGIC_TOP</a>,
<a name="l00119"></a>00119                   th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#ac0ba34f711c43f831fe95e9a9434353f">top_self</a>, 0, iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aa70f3e195a4350acbbc130f8a95c9958">iseq_encoded</a>,
<a name="l00120"></a>00120                   th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a>, 0, iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#afbae994355f91f3ea547570debb757c0">local_size</a>);
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     <a class="code" href="../../dd/dd0/eval__intern_8h.html#a03427c07c33d15b934d5f9f4bcfb1c95">CHECK_STACK_OVERFLOW</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>, iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a00494b6f5b1aa350819cad777e19eee8">stack_max</a>);
<a name="l00123"></a>00123 }
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00126"></a><a class="code" href="../../de/de9/vm_8c.html#aceae2e37af21e2228489afc5d0233103">00126</a> <a class="code" href="../../de/de9/vm_8c.html#aceae2e37af21e2228489afc5d0233103">vm_set_eval_stack</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> * th, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> iseqval, <span class="keyword">const</span> NODE *cref)
<a name="l00127"></a>00127 {
<a name="l00128"></a>00128     <a class="code" href="../../d6/de3/structrb__iseq__struct.html">rb_iseq_t</a> *iseq;
<a name="l00129"></a>00129     <a class="code" href="../../da/dc0/structrb__block__struct.html">rb_block_t</a> * <span class="keyword">const</span> block = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#aad6cc8c9d9f511c12cca5af8c8aa6e77">base_block</a>;
<a name="l00130"></a>00130     <a class="code" href="../../d8/d32/vm__core_8h.html#a5e6a3515e0ad9b9d6a4c0ab577dc50b6">GetISeqPtr</a>(iseqval, iseq);
<a name="l00131"></a>00131 
<a name="l00132"></a>00132     <span class="comment">/* for return */</span>
<a name="l00133"></a>00133     <a class="code" href="../../de/de9/vm_8c.html#aa8deb4813e5d237bb18713ddb5d98b74">rb_vm_set_finish_env</a>(th);
<a name="l00134"></a>00134     <a class="code" href="../../d0/db2/vm__insnhelper_8c.html#a30340566da5743c4d660c8931dffd86e">vm_push_frame</a>(th, iseq, <a class="code" href="../../d8/d32/vm__core_8h.html#ac7b8d797cce488d08572c273f49f28fe">VM_FRAME_MAGIC_EVAL</a>, block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#ad54e1ec45ab21ef384fe9e4346570397">self</a>,
<a name="l00135"></a>00135                   <a class="code" href="../../d8/d32/vm__core_8h.html#a4bc9fa804787db9db7ea5d698da9db9e">GC_GUARDED_PTR</a>(block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a>), iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aa70f3e195a4350acbbc130f8a95c9958">iseq_encoded</a>,
<a name="l00136"></a>00136                   th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a>, block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#a834e1c9b35a06714deeb62097636564f">lfp</a>, iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#afbae994355f91f3ea547570debb757c0">local_size</a>);
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     <span class="keywordflow">if</span> (cref) {
<a name="l00139"></a>00139         th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a>[-1] = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)cref;
<a name="l00140"></a>00140     }
<a name="l00141"></a>00141 
<a name="l00142"></a>00142     <a class="code" href="../../dd/dd0/eval__intern_8h.html#a03427c07c33d15b934d5f9f4bcfb1c95">CHECK_STACK_OVERFLOW</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>, iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a00494b6f5b1aa350819cad777e19eee8">stack_max</a>);
<a name="l00143"></a>00143 }
<a name="l00144"></a>00144 
<a name="l00145"></a>00145 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00146"></a><a class="code" href="../../de/de9/vm_8c.html#aa938e139dcf9509037140019da6f4a47">00146</a> <a class="code" href="../../de/de9/vm_8c.html#aa938e139dcf9509037140019da6f4a47">vm_set_main_stack</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> iseqval)
<a name="l00147"></a>00147 {
<a name="l00148"></a>00148     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> toplevel_binding = <a class="code" href="../../db/d2e/intern_8h.html#a17a81c1a7d754e5ab49fc4b4369b6c8c">rb_const_get</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a57c96ead3ef230b4838e65fe037c346e">rb_cObject</a>, <a class="code" href="../../dc/dcc/array_8c.html#a9cfa42d4b79c89d68c53be8b2150a503">rb_intern</a>(<span class="stringliteral">&quot;TOPLEVEL_BINDING&quot;</span>));
<a name="l00149"></a>00149     <a class="code" href="../../d3/d76/structrb__binding__t.html">rb_binding_t</a> *bind;
<a name="l00150"></a>00150     <a class="code" href="../../d6/de3/structrb__iseq__struct.html">rb_iseq_t</a> *iseq;
<a name="l00151"></a>00151     <a class="code" href="../../d0/d73/structrb__env__t.html">rb_env_t</a> *<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153     <a class="code" href="../../d8/d32/vm__core_8h.html#a491d77ec5480e1530e447dbb42481f5b">GetBindingPtr</a>(toplevel_binding, bind);
<a name="l00154"></a>00154     <a class="code" href="../../d8/d32/vm__core_8h.html#aaa39b3177aba775195d515b937ef78ff">GetEnvPtr</a>(bind-&gt;<a class="code" href="../../d3/d76/structrb__binding__t.html#a65f58a22eb376363f727c34b7fde7400">env</a>, env);
<a name="l00155"></a>00155     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#aad6cc8c9d9f511c12cca5af8c8aa6e77">base_block</a> = &amp;env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>;
<a name="l00156"></a>00156     <a class="code" href="../../de/de9/vm_8c.html#aceae2e37af21e2228489afc5d0233103">vm_set_eval_stack</a>(th, iseqval, 0);
<a name="l00157"></a>00157     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#aad6cc8c9d9f511c12cca5af8c8aa6e77">base_block</a> = 0;
<a name="l00158"></a>00158 
<a name="l00159"></a>00159     <span class="comment">/* save binding */</span>
<a name="l00160"></a>00160     <a class="code" href="../../d8/d32/vm__core_8h.html#a5e6a3515e0ad9b9d6a4c0ab577dc50b6">GetISeqPtr</a>(iseqval, iseq);
<a name="l00161"></a>00161     <span class="keywordflow">if</span> (bind &amp;&amp; iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#afbae994355f91f3ea547570debb757c0">local_size</a> &gt; 0) {
<a name="l00162"></a>00162         bind-&gt;<a class="code" href="../../d3/d76/structrb__binding__t.html#a65f58a22eb376363f727c34b7fde7400">env</a> = <a class="code" href="../../de/de9/vm_8c.html#a38087978d8bc36f8cd48b62b70b15000">rb_vm_make_env_object</a>(th, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>);
<a name="l00163"></a>00163     }
<a name="l00164"></a>00164 
<a name="l00165"></a>00165     <a class="code" href="../../dd/dd0/eval__intern_8h.html#a03427c07c33d15b934d5f9f4bcfb1c95">CHECK_STACK_OVERFLOW</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>, iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a00494b6f5b1aa350819cad777e19eee8">stack_max</a>);
<a name="l00166"></a>00166 }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *
<a name="l00169"></a><a class="code" href="../../d8/d32/vm__core_8h.html#a2709ccd7eeff81c0f749a7678223857e">00169</a> <a class="code" href="../../de/de9/vm_8c.html#a2709ccd7eeff81c0f749a7678223857e">rb_vm_get_ruby_level_next_cfp</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp)
<a name="l00170"></a>00170 {
<a name="l00171"></a>00171     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d32/vm__core_8h.html#ac3cef3df2cc03d3090ad49220cb453d5">RUBY_VM_CONTROL_FRAME_STACK_OVERFLOW_P</a>(th, cfp)) {
<a name="l00172"></a>00172         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a79d03ad9b9cf8b7a8ca2b849e495a74f">RUBY_VM_NORMAL_ISEQ_P</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>)) {
<a name="l00173"></a>00173             <span class="keywordflow">return</span> cfp;
<a name="l00174"></a>00174         }
<a name="l00175"></a>00175         cfp = <a class="code" href="../../d8/d32/vm__core_8h.html#af087c881c3c493e3a4e326852e8ed2a9">RUBY_VM_PREVIOUS_CONTROL_FRAME</a>(cfp);
<a name="l00176"></a>00176     }
<a name="l00177"></a>00177     <span class="keywordflow">return</span> 0;
<a name="l00178"></a>00178 }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 <span class="keyword">static</span> <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *
<a name="l00181"></a><a class="code" href="../../de/de9/vm_8c.html#a198b8bdfa01414239809443f0a7b2625">00181</a> <a class="code" href="../../de/de9/vm_8c.html#a198b8bdfa01414239809443f0a7b2625">vm_get_ruby_level_caller_cfp</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp)
<a name="l00182"></a>00182 {
<a name="l00183"></a>00183     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a79d03ad9b9cf8b7a8ca2b849e495a74f">RUBY_VM_NORMAL_ISEQ_P</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>)) {
<a name="l00184"></a>00184         <span class="keywordflow">return</span> cfp;
<a name="l00185"></a>00185     }
<a name="l00186"></a>00186 
<a name="l00187"></a>00187     cfp = <a class="code" href="../../d8/d32/vm__core_8h.html#af087c881c3c493e3a4e326852e8ed2a9">RUBY_VM_PREVIOUS_CONTROL_FRAME</a>(cfp);
<a name="l00188"></a>00188 
<a name="l00189"></a>00189     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d32/vm__core_8h.html#ac3cef3df2cc03d3090ad49220cb453d5">RUBY_VM_CONTROL_FRAME_STACK_OVERFLOW_P</a>(th, cfp)) {
<a name="l00190"></a>00190         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a79d03ad9b9cf8b7a8ca2b849e495a74f">RUBY_VM_NORMAL_ISEQ_P</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>)) {
<a name="l00191"></a>00191             <span class="keywordflow">return</span> cfp;
<a name="l00192"></a>00192         }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194         <span class="keywordflow">if</span> ((cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a88144f455e4e42ff4379ab971f22cffc">flag</a> &amp; <a class="code" href="../../d8/d32/vm__core_8h.html#a15218fe6d89c7897abd5a8ad8c9bc52f">VM_FRAME_FLAG_PASSED</a>) == 0) {
<a name="l00195"></a>00195             <span class="keywordflow">break</span>;
<a name="l00196"></a>00196         }
<a name="l00197"></a>00197         cfp = <a class="code" href="../../d8/d32/vm__core_8h.html#af087c881c3c493e3a4e326852e8ed2a9">RUBY_VM_PREVIOUS_CONTROL_FRAME</a>(cfp);
<a name="l00198"></a>00198     }
<a name="l00199"></a>00199     <span class="keywordflow">return</span> 0;
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 <span class="comment">/* at exit */</span>
<a name="l00203"></a>00203 
<a name="l00204"></a>00204 <span class="keywordtype">void</span>
<a name="l00205"></a><a class="code" href="../../de/de9/vm_8c.html#ae7ad8c359f6d89380dceca5a63bc2c48">00205</a> <a class="code" href="../../da/d0a/vm_8h.html#a450d06a010ca9e1139e5ba87c5cb9e38" title="ruby_vm_at_exit registers a function _func_ to be invoked when a VM passed away.">ruby_vm_at_exit</a>(<span class="keywordtype">void</span> (*<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a>)(<a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *))
<a name="l00206"></a>00206 {
<a name="l00207"></a>00207     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;<a class="code" href="../../d8/d32/vm__core_8h.html#a6cfcd3997994924c8cd13c3b5c099ec6">GET_VM</a>()-&gt;<a class="code" href="../../d5/d9d/tcltklib_8c.html#a0964f0f2c4ef2a9554392a5aaf13b032">at_exit</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a>);
<a name="l00208"></a>00208 }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00211"></a><a class="code" href="../../de/de9/vm_8c.html#af41ce3aa993b8eb956d96a10060fdcca">00211</a> <a class="code" href="../../de/de9/vm_8c.html#af41ce3aa993b8eb956d96a10060fdcca">ruby_vm_run_at_exit_hooks</a>(<a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vm)
<a name="l00212"></a>00212 {
<a name="l00213"></a>00213     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> hook = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)&amp;vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a328959223626113a5ceeb5638b5d9f8d">at_exit</a>;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     while (<a class="code" href="../../d8/df4/generator_8h.html#ae988773ed219452578f881fc7189c486">RARRAY_LEN</a>(hook) &gt; 0) {
<a name="l00216"></a>00216         <span class="keyword">typedef</span> <span class="keywordtype">void</span> rb_vm_at_exit_func(<a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a>*);
<a name="l00217"></a>00217         rb_vm_at_exit_func *<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a> = (rb_vm_at_exit_func*)<a class="code" href="../../dc/dcc/array_8c.html#aacb1ec2239256ca2e537588fc534e7b8">rb_ary_pop</a>(hook);
<a name="l00218"></a>00218         (*func)(vm);
<a name="l00219"></a>00219     }
<a name="l00220"></a>00220     <a class="code" href="../../dc/dcc/array_8c.html#a5c6b248d971f78b215844c60cdb00020">rb_ary_free</a>(hook);
<a name="l00221"></a>00221 }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223 <span class="comment">/* Env */</span>
<a name="l00224"></a>00224 
<a name="l00225"></a>00225 <span class="comment">/*</span>
<a name="l00226"></a>00226 <span class="comment">  env{</span>
<a name="l00227"></a>00227 <span class="comment">    env[0] // special (block or prev env)</span>
<a name="l00228"></a>00228 <span class="comment">    env[1] // env object</span>
<a name="l00229"></a>00229 <span class="comment">    env[2] // prev env val</span>
<a name="l00230"></a>00230 <span class="comment">  };</span>
<a name="l00231"></a>00231 <span class="comment"> */</span>
<a name="l00232"></a>00232 
<a name="l00233"></a><a class="code" href="../../de/de9/vm_8c.html#a763a6b9c07ba29acc33611df4297f321">00233</a> <span class="preprocessor">#define ENV_IN_HEAP_P(th, env)  \</span>
<a name="l00234"></a>00234 <span class="preprocessor">  (!((th)-&gt;stack &lt; (env) &amp;&amp; (env) &lt; ((th)-&gt;stack + (th)-&gt;stack_size)))</span>
<a name="l00235"></a><a class="code" href="../../de/de9/vm_8c.html#a518d3ecb1212b2eea58b409fd4ace787">00235</a> <span class="preprocessor"></span><span class="preprocessor">#define ENV_VAL(env)        ((env)[1])</span>
<a name="l00236"></a>00236 <span class="preprocessor"></span>
<a name="l00237"></a>00237 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00238"></a><a class="code" href="../../de/de9/vm_8c.html#ae7481a42efe3169d09a302d1c6ffd38c">00238</a> <a class="code" href="../../de/de9/vm_8c.html#ae7481a42efe3169d09a302d1c6ffd38c">env_mark</a>(<span class="keywordtype">void</span> * <span class="keyword">const</span> ptr)
<a name="l00239"></a>00239 {
<a name="l00240"></a>00240     <a class="code" href="../../d0/daa/gc_8h.html#a2aa4d10eb84bae94811007f68c795fb7">RUBY_MARK_ENTER</a>(<span class="stringliteral">&quot;env&quot;</span>);
<a name="l00241"></a>00241     <span class="keywordflow">if</span> (ptr) {
<a name="l00242"></a>00242         <span class="keyword">const</span> <a class="code" href="../../d0/d73/structrb__env__t.html">rb_env_t</a> * <span class="keyword">const</span> <a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a> = ptr;
<a name="l00243"></a>00243 
<a name="l00244"></a>00244         <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a1c42d4847422b6ffd0fb340fdd0cfa8b">env</a>) {
<a name="l00245"></a>00245             <span class="comment">/* TODO: should mark more restricted range */</span>
<a name="l00246"></a>00246             <a class="code" href="../../d0/daa/gc_8h.html#a634fb573223a0ffb428332fc45916fc6">RUBY_GC_INFO</a>(<span class="stringliteral">&quot;env-&gt;env\n&quot;</span>);
<a name="l00247"></a>00247             <a class="code" href="../../d8/d16/gc_8c.html#a90e176b7e9d24053977f64a611c1d8bb">rb_gc_mark_locations</a>(env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a1c42d4847422b6ffd0fb340fdd0cfa8b">env</a>, env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a1c42d4847422b6ffd0fb340fdd0cfa8b">env</a> + env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a2a6f73bb292a79e0beed588fa6fabe6a">env_size</a>);
<a name="l00248"></a>00248         }
<a name="l00249"></a>00249 
<a name="l00250"></a>00250         <a class="code" href="../../d0/daa/gc_8h.html#a634fb573223a0ffb428332fc45916fc6">RUBY_GC_INFO</a>(<span class="stringliteral">&quot;env-&gt;prev_envval\n&quot;</span>);
<a name="l00251"></a>00251         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#aa0a172915cc02522f2c6a2fe88a18bad">prev_envval</a>);
<a name="l00252"></a>00252         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ad54e1ec45ab21ef384fe9e4346570397">self</a>);
<a name="l00253"></a>00253         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#a305ea0fcc6d1233de416bd8e7edab218">proc</a>);
<a name="l00254"></a>00254 
<a name="l00255"></a>00255         <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#a8e2b3b9218b4a184f198872404e81605">iseq</a>) {
<a name="l00256"></a>00256             <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#a8e2b3b9218b4a184f198872404e81605">iseq</a>) == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5f1cc49c4da51d5bdffa64be79ff6fb0">T_NODE</a>) {
<a name="l00257"></a>00257                 <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#a8e2b3b9218b4a184f198872404e81605">iseq</a>);
<a name="l00258"></a>00258             }
<a name="l00259"></a>00259             <span class="keywordflow">else</span> {
<a name="l00260"></a>00260                 <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#a8e2b3b9218b4a184f198872404e81605">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a46d5fb5c3de970a9540ab85d4b060957">self</a>);
<a name="l00261"></a>00261             }
<a name="l00262"></a>00262         }
<a name="l00263"></a>00263     }
<a name="l00264"></a>00264     <a class="code" href="../../d0/daa/gc_8h.html#a036115d8c044f5c847e760c57b08e5a9">RUBY_MARK_LEAVE</a>(<span class="stringliteral">&quot;env&quot;</span>);
<a name="l00265"></a>00265 }
<a name="l00266"></a>00266 
<a name="l00267"></a>00267 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00268"></a><a class="code" href="../../de/de9/vm_8c.html#acb7274747d1f091bee63b471c7a81654">00268</a> <a class="code" href="../../de/de9/vm_8c.html#acb7274747d1f091bee63b471c7a81654">env_free</a>(<span class="keywordtype">void</span> * <span class="keyword">const</span> ptr)
<a name="l00269"></a>00269 {
<a name="l00270"></a>00270     <a class="code" href="../../d0/daa/gc_8h.html#a5d959738efb454623a7dad84d728262a">RUBY_FREE_ENTER</a>(<span class="stringliteral">&quot;env&quot;</span>);
<a name="l00271"></a>00271     <span class="keywordflow">if</span> (ptr) {
<a name="l00272"></a>00272         <a class="code" href="../../d0/d73/structrb__env__t.html">rb_env_t</a> *<span class="keyword">const</span> <a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a> = ptr;
<a name="l00273"></a>00273         <a class="code" href="../../d0/daa/gc_8h.html#a904b1cd50d09d6c8ae915c78e425420a">RUBY_FREE_UNLESS_NULL</a>(env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a1c42d4847422b6ffd0fb340fdd0cfa8b">env</a>);
<a name="l00274"></a>00274         <a class="code" href="../../d8/d16/gc_8c.html#a0bffec5b2cc004adcebb6802e7620387">ruby_xfree</a>(ptr);
<a name="l00275"></a>00275     }
<a name="l00276"></a>00276     <a class="code" href="../../d0/daa/gc_8h.html#af304d34de3474d75064e0cba170b7bf5">RUBY_FREE_LEAVE</a>(<span class="stringliteral">&quot;env&quot;</span>);
<a name="l00277"></a>00277 }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279 <span class="keyword">static</span> <span class="keywordtype">size_t</span>
<a name="l00280"></a><a class="code" href="../../de/de9/vm_8c.html#a5e1259c3fa1d188528af5b535e3a7f00">00280</a> <a class="code" href="../../de/de9/vm_8c.html#a5e1259c3fa1d188528af5b535e3a7f00">env_memsize</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *ptr)
<a name="l00281"></a>00281 {
<a name="l00282"></a>00282     <span class="keywordflow">if</span> (ptr) {
<a name="l00283"></a>00283         <span class="keyword">const</span> <a class="code" href="../../d0/d73/structrb__env__t.html">rb_env_t</a> * <span class="keyword">const</span> <a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a> = ptr;
<a name="l00284"></a>00284         <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d73/structrb__env__t.html">rb_env_t</a>);
<a name="l00285"></a>00285         <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a1c42d4847422b6ffd0fb340fdd0cfa8b">env</a>) {
<a name="l00286"></a>00286             size += env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a2a6f73bb292a79e0beed588fa6fabe6a">env_size</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>);
<a name="l00287"></a>00287         }
<a name="l00288"></a>00288         <span class="keywordflow">return</span> size;
<a name="l00289"></a>00289     }
<a name="l00290"></a>00290     <span class="keywordflow">return</span> 0;
<a name="l00291"></a>00291 }
<a name="l00292"></a>00292 
<a name="l00293"></a><a class="code" href="../../de/de9/vm_8c.html#ac09fe4b7c739818891e16b9b06110d87">00293</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="../../d7/de2/structrb__data__type__struct.html">rb_data_type_t</a> <a class="code" href="../../de/de9/vm_8c.html#ac09fe4b7c739818891e16b9b06110d87">env_data_type</a> = {
<a name="l00294"></a>00294     <span class="stringliteral">&quot;VM/env&quot;</span>,
<a name="l00295"></a>00295     {<a class="code" href="../../de/de9/vm_8c.html#ae7481a42efe3169d09a302d1c6ffd38c">env_mark</a>, <a class="code" href="../../de/de9/vm_8c.html#acb7274747d1f091bee63b471c7a81654">env_free</a>, <a class="code" href="../../de/de9/vm_8c.html#a5e1259c3fa1d188528af5b535e3a7f00">env_memsize</a>,},
<a name="l00296"></a>00296 };
<a name="l00297"></a>00297 
<a name="l00298"></a>00298 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00299"></a><a class="code" href="../../de/de9/vm_8c.html#a9f77b7ff2a4e6e64a9a1590f9b7219a7">00299</a> <a class="code" href="../../de/de9/vm_8c.html#a9f77b7ff2a4e6e64a9a1590f9b7219a7">env_alloc</a>(<span class="keywordtype">void</span>)
<a name="l00300"></a>00300 {
<a name="l00301"></a>00301     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj;
<a name="l00302"></a>00302     <a class="code" href="../../d0/d73/structrb__env__t.html">rb_env_t</a> *<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>;
<a name="l00303"></a>00303     obj = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#acb14aa93d3dc60a9d16570270154e6fa">TypedData_Make_Struct</a>(<a class="code" href="../../de/de9/vm_8c.html#ad55204994fe946dcd317061047845c3a">rb_cEnv</a>, <a class="code" href="../../d0/d73/structrb__env__t.html">rb_env_t</a>, &amp;env_data_type, env);
<a name="l00304"></a>00304     env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a1c42d4847422b6ffd0fb340fdd0cfa8b">env</a> = 0;
<a name="l00305"></a>00305     env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#aa0a172915cc02522f2c6a2fe88a18bad">prev_envval</a> = 0;
<a name="l00306"></a>00306     env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#a8e2b3b9218b4a184f198872404e81605">iseq</a> = 0;
<a name="l00307"></a>00307     <span class="keywordflow">return</span> obj;
<a name="l00308"></a>00308 }
<a name="l00309"></a>00309 
<a name="l00310"></a>00310 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../de/de9/vm_8c.html#ad686a96329c814869e6200edfac5107a">check_env_value</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> envval);
<a name="l00311"></a>00311 
<a name="l00312"></a>00312 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00313"></a><a class="code" href="../../de/de9/vm_8c.html#a32e6bd476abfda4d5fcca42de87ff4e2">00313</a> <a class="code" href="../../de/de9/vm_8c.html#a32e6bd476abfda4d5fcca42de87ff4e2">check_env</a>(<a class="code" href="../../d0/d73/structrb__env__t.html">rb_env_t</a> * <span class="keyword">const</span> env)
<a name="l00314"></a>00314 {
<a name="l00315"></a>00315     printf(<span class="stringliteral">&quot;---\n&quot;</span>);
<a name="l00316"></a>00316     printf(<span class="stringliteral">&quot;envptr: %p\n&quot;</span>, (<span class="keywordtype">void</span> *)&amp;env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a>[0]);
<a name="l00317"></a>00317     printf(<span class="stringliteral">&quot;orphan: %p\n&quot;</span>, (<span class="keywordtype">void</span> *)env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a>[1]);
<a name="l00318"></a>00318     printf(<span class="stringliteral">&quot;inheap: %p\n&quot;</span>, (<span class="keywordtype">void</span> *)env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a>[2]);
<a name="l00319"></a>00319     printf(<span class="stringliteral">&quot;envval: %10p &quot;</span>, (<span class="keywordtype">void</span> *)env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a>[3]);
<a name="l00320"></a>00320     <a class="code" href="../../db/d16/debug_8h.html#a08a47aff6867e5ae146382e66d2cc26b">dp</a>(env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a>[3]);
<a name="l00321"></a>00321     printf(<span class="stringliteral">&quot;penvv : %10p &quot;</span>, (<span class="keywordtype">void</span> *)env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a>[4]);
<a name="l00322"></a>00322     <a class="code" href="../../db/d16/debug_8h.html#a08a47aff6867e5ae146382e66d2cc26b">dp</a>(env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a>[4]);
<a name="l00323"></a>00323     printf(<span class="stringliteral">&quot;lfp:    %10p\n&quot;</span>, (<span class="keywordtype">void</span> *)env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#a834e1c9b35a06714deeb62097636564f">lfp</a>);
<a name="l00324"></a>00324     printf(<span class="stringliteral">&quot;dfp:    %10p\n&quot;</span>, (<span class="keywordtype">void</span> *)env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a>);
<a name="l00325"></a>00325     <span class="keywordflow">if</span> (env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a>[4]) {
<a name="l00326"></a>00326         printf(<span class="stringliteral">&quot;&gt;&gt;\n&quot;</span>);
<a name="l00327"></a>00327         <a class="code" href="../../de/de9/vm_8c.html#ad686a96329c814869e6200edfac5107a">check_env_value</a>(env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a>[4]);
<a name="l00328"></a>00328         printf(<span class="stringliteral">&quot;&lt;&lt;\n&quot;</span>);
<a name="l00329"></a>00329     }
<a name="l00330"></a>00330     <span class="keywordflow">return</span> 1;
<a name="l00331"></a>00331 }
<a name="l00332"></a>00332 
<a name="l00333"></a>00333 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00334"></a><a class="code" href="../../de/de9/vm_8c.html#ad686a96329c814869e6200edfac5107a">00334</a> <a class="code" href="../../de/de9/vm_8c.html#ad686a96329c814869e6200edfac5107a">check_env_value</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> envval)
<a name="l00335"></a>00335 {
<a name="l00336"></a>00336     <a class="code" href="../../d0/d73/structrb__env__t.html">rb_env_t</a> *<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>;
<a name="l00337"></a>00337     <a class="code" href="../../d8/d32/vm__core_8h.html#aaa39b3177aba775195d515b937ef78ff">GetEnvPtr</a>(envval, env);
<a name="l00338"></a>00338 
<a name="l00339"></a>00339     <span class="keywordflow">if</span> (<a class="code" href="../../de/de9/vm_8c.html#a32e6bd476abfda4d5fcca42de87ff4e2">check_env</a>(env)) {
<a name="l00340"></a>00340         <span class="keywordflow">return</span> envval;
<a name="l00341"></a>00341     }
<a name="l00342"></a>00342     <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;invalid env&quot;</span>);
<a name="l00343"></a>00343     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;                <span class="comment">/* unreachable */</span>
<a name="l00344"></a>00344 }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00347"></a><a class="code" href="../../de/de9/vm_8c.html#a7920e56cee3ddd3b387cbe2d69b69544">00347</a> <a class="code" href="../../de/de9/vm_8c.html#a7920e56cee3ddd3b387cbe2d69b69544">vm_make_env_each</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> * <span class="keyword">const</span> th, <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> * <span class="keyword">const</span> cfp,
<a name="l00348"></a>00348                  <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *envptr, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> * <span class="keyword">const</span> endptr)
<a name="l00349"></a>00349 {
<a name="l00350"></a>00350     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> envval, penvval = 0;
<a name="l00351"></a>00351     <a class="code" href="../../d0/d73/structrb__env__t.html">rb_env_t</a> *<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>;
<a name="l00352"></a>00352     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *nenvptr;
<a name="l00353"></a>00353     <span class="keywordtype">int</span> i, local_size;
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     <span class="keywordflow">if</span> (<a class="code" href="../../de/de9/vm_8c.html#a763a6b9c07ba29acc33611df4297f321">ENV_IN_HEAP_P</a>(th, envptr)) {
<a name="l00356"></a>00356         <span class="keywordflow">return</span> <a class="code" href="../../de/de9/vm_8c.html#a518d3ecb1212b2eea58b409fd4ace787">ENV_VAL</a>(envptr);
<a name="l00357"></a>00357     }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359     <span class="keywordflow">if</span> (envptr != endptr) {
<a name="l00360"></a>00360         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *penvptr = <a class="code" href="../../d8/d32/vm__core_8h.html#a373f1cafd944ff9e99986582d0fd695b">GC_GUARDED_PTR_REF</a>(*envptr);
<a name="l00361"></a>00361         <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *pcfp = cfp;
<a name="l00362"></a>00362 
<a name="l00363"></a>00363         <span class="keywordflow">if</span> (<a class="code" href="../../de/de9/vm_8c.html#a763a6b9c07ba29acc33611df4297f321">ENV_IN_HEAP_P</a>(th, penvptr)) {
<a name="l00364"></a>00364             penvval = <a class="code" href="../../de/de9/vm_8c.html#a518d3ecb1212b2eea58b409fd4ace787">ENV_VAL</a>(penvptr);
<a name="l00365"></a>00365         }
<a name="l00366"></a>00366         <span class="keywordflow">else</span> {
<a name="l00367"></a>00367             <span class="keywordflow">while</span> (pcfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a> != penvptr) {
<a name="l00368"></a>00368                 pcfp++;
<a name="l00369"></a>00369                 <span class="keywordflow">if</span> (pcfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a> == 0) {
<a name="l00370"></a>00370                     <a class="code" href="../../d8/d32/vm__core_8h.html#ac33c371d81972685538097cb4f49181f">SDR</a>();
<a name="l00371"></a>00371                     <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;invalid dfp&quot;</span>);
<a name="l00372"></a>00372                 }
<a name="l00373"></a>00373             }
<a name="l00374"></a>00374             penvval = <a class="code" href="../../de/de9/vm_8c.html#a7920e56cee3ddd3b387cbe2d69b69544">vm_make_env_each</a>(th, pcfp, penvptr, endptr);
<a name="l00375"></a>00375             cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a> = pcfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a>;
<a name="l00376"></a>00376             *envptr = <a class="code" href="../../d8/d32/vm__core_8h.html#a4bc9fa804787db9db7ea5d698da9db9e">GC_GUARDED_PTR</a>(pcfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a>);
<a name="l00377"></a>00377         }
<a name="l00378"></a>00378     }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380     <span class="comment">/* allocate env */</span>
<a name="l00381"></a>00381     envval = <a class="code" href="../../de/de9/vm_8c.html#a9f77b7ff2a4e6e64a9a1590f9b7219a7">env_alloc</a>();
<a name="l00382"></a>00382     <a class="code" href="../../d8/d32/vm__core_8h.html#aaa39b3177aba775195d515b937ef78ff">GetEnvPtr</a>(envval, env);
<a name="l00383"></a>00383 
<a name="l00384"></a>00384     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d32/vm__core_8h.html#a79d03ad9b9cf8b7a8ca2b849e495a74f">RUBY_VM_NORMAL_ISEQ_P</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>)) {
<a name="l00385"></a>00385         local_size = 2;
<a name="l00386"></a>00386     }
<a name="l00387"></a>00387     <span class="keywordflow">else</span> {
<a name="l00388"></a>00388         local_size = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#afbae994355f91f3ea547570debb757c0">local_size</a>;
<a name="l00389"></a>00389     }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391     env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a2a6f73bb292a79e0beed588fa6fabe6a">env_size</a> = local_size + 1 + 2;
<a name="l00392"></a>00392     env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5babbdd0740bbdc371ae7d2f225e8b64">local_size</a> = local_size;
<a name="l00393"></a>00393     env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a1c42d4847422b6ffd0fb340fdd0cfa8b">env</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a79041aa2bc7439c11906a86f82a52eb6">ALLOC_N</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>, env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a2a6f73bb292a79e0beed588fa6fabe6a">env_size</a>);
<a name="l00394"></a>00394     env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#aa0a172915cc02522f2c6a2fe88a18bad">prev_envval</a> = penvval;
<a name="l00395"></a>00395 
<a name="l00396"></a>00396     <span class="keywordflow">for</span> (i = 0; i &lt;= local_size; i++) {
<a name="l00397"></a>00397         env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a1c42d4847422b6ffd0fb340fdd0cfa8b">env</a>[i] = envptr[-local_size + i];
<a name="l00398"></a>00398 <span class="preprocessor">#if 0</span>
<a name="l00399"></a>00399 <span class="preprocessor"></span>        fprintf(stderr, <span class="stringliteral">&quot;%2d &quot;</span>, &amp;envptr[-local_size + i] - th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a>); <a class="code" href="../../db/d16/debug_8h.html#a08a47aff6867e5ae146382e66d2cc26b">dp</a>(env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a1c42d4847422b6ffd0fb340fdd0cfa8b">env</a>[i]);
<a name="l00400"></a>00400         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a79d03ad9b9cf8b7a8ca2b849e495a74f">RUBY_VM_NORMAL_ISEQ_P</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>)) {
<a name="l00401"></a>00401             <span class="comment">/* clear value stack for GC */</span>
<a name="l00402"></a>00402             envptr[-local_size + i] = 0;
<a name="l00403"></a>00403         }
<a name="l00404"></a>00404 <span class="preprocessor">#endif</span>
<a name="l00405"></a>00405 <span class="preprocessor"></span>    }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407     *envptr = envval;           <span class="comment">/* GC mark */</span>
<a name="l00408"></a>00408     nenvptr = &amp;env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a1c42d4847422b6ffd0fb340fdd0cfa8b">env</a>[i - 1];
<a name="l00409"></a>00409     nenvptr[1] = envval;        <span class="comment">/* frame self */</span>
<a name="l00410"></a>00410     nenvptr[2] = penvval;       <span class="comment">/* frame prev env object */</span>
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     <span class="comment">/* reset lfp/dfp in cfp */</span>
<a name="l00413"></a>00413     cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a> = nenvptr;
<a name="l00414"></a>00414     <span class="keywordflow">if</span> (envptr == endptr) {
<a name="l00415"></a>00415         cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a> = nenvptr;
<a name="l00416"></a>00416     }
<a name="l00417"></a>00417 
<a name="l00418"></a>00418     <span class="comment">/* as Binding */</span>
<a name="l00419"></a>00419     env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ad54e1ec45ab21ef384fe9e4346570397">self</a> = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4c11a50358317e1207affd6d7b4ad576">self</a>;
<a name="l00420"></a>00420     env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#a834e1c9b35a06714deeb62097636564f">lfp</a> = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a>;
<a name="l00421"></a>00421     env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a> = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a>;
<a name="l00422"></a>00422     env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#a8e2b3b9218b4a184f198872404e81605">iseq</a> = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>;
<a name="l00423"></a>00423 
<a name="l00424"></a>00424     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d32/vm__core_8h.html#a79d03ad9b9cf8b7a8ca2b849e495a74f">RUBY_VM_NORMAL_ISEQ_P</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>)) {
<a name="l00425"></a>00425         <span class="comment">/* TODO */</span>
<a name="l00426"></a>00426         env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#a8e2b3b9218b4a184f198872404e81605">iseq</a> = 0;
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428     <span class="keywordflow">return</span> envval;
<a name="l00429"></a>00429 }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00432"></a><a class="code" href="../../de/de9/vm_8c.html#a16e2c046b4cf83df26232c0869ce7643">00432</a> <a class="code" href="../../de/de9/vm_8c.html#a16e2c046b4cf83df26232c0869ce7643">collect_local_variables_in_iseq</a>(<a class="code" href="../../d6/de3/structrb__iseq__struct.html">rb_iseq_t</a> *iseq, <span class="keyword">const</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary)
<a name="l00433"></a>00433 {
<a name="l00434"></a>00434     <span class="keywordtype">int</span> i;
<a name="l00435"></a>00435     <span class="keywordflow">if</span> (!iseq) <span class="keywordflow">return</span> 0;
<a name="l00436"></a>00436     <span class="keywordflow">for</span> (i = 0; i &lt; iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a22ff1695f19e63e6540bc574949c55b0">local_table_size</a>; i++) {
<a name="l00437"></a>00437         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> lid = iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a667787a2e393a8e2a203bf1c2442276d">local_table</a>[i];
<a name="l00438"></a>00438         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d11/ripper_8c.html#aed0d62fc21ec2baa9ae344fe3ff30668">rb_is_local_id</a>(lid)) {
<a name="l00439"></a>00439             <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(lid));
<a name="l00440"></a>00440         }
<a name="l00441"></a>00441     }
<a name="l00442"></a>00442     <span class="keywordflow">return</span> 1;
<a name="l00443"></a>00443 }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00446"></a><a class="code" href="../../de/de9/vm_8c.html#a2290ee4bcece4d937e5e04cf65c1771c">00446</a> <a class="code" href="../../de/de9/vm_8c.html#a2290ee4bcece4d937e5e04cf65c1771c">collect_local_variables_in_env</a>(<a class="code" href="../../d0/d73/structrb__env__t.html">rb_env_t</a> * env, <span class="keyword">const</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary)
<a name="l00447"></a>00447 {
<a name="l00448"></a>00448 
<a name="l00449"></a>00449     <span class="keywordflow">while</span> (<a class="code" href="../../de/de9/vm_8c.html#a16e2c046b4cf83df26232c0869ce7643">collect_local_variables_in_iseq</a>(env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5799d3841d32ff495d213f2c423c87df">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#a8e2b3b9218b4a184f198872404e81605">iseq</a>, ary),
<a name="l00450"></a>00450            env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#aa0a172915cc02522f2c6a2fe88a18bad">prev_envval</a>) {
<a name="l00451"></a>00451         <a class="code" href="../../d8/d32/vm__core_8h.html#aaa39b3177aba775195d515b937ef78ff">GetEnvPtr</a>(env-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#aa0a172915cc02522f2c6a2fe88a18bad">prev_envval</a>, env);
<a name="l00452"></a>00452     }
<a name="l00453"></a>00453     <span class="keywordflow">return</span> 0;
<a name="l00454"></a>00454 }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00457"></a><a class="code" href="../../de/de9/vm_8c.html#af324cc69c6f1c3c72fa2b816615c6c80">00457</a> <a class="code" href="../../de/de9/vm_8c.html#af324cc69c6f1c3c72fa2b816615c6c80">vm_collect_local_variables_in_heap</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *dfp, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary)
<a name="l00458"></a>00458 {
<a name="l00459"></a>00459     <span class="keywordflow">if</span> (<a class="code" href="../../de/de9/vm_8c.html#a763a6b9c07ba29acc33611df4297f321">ENV_IN_HEAP_P</a>(th, dfp)) {
<a name="l00460"></a>00460         <a class="code" href="../../d0/d73/structrb__env__t.html">rb_env_t</a> *<a class="code" href="../../d5/df2/win32_8c.html#af973ca20f6594ad664c03daa83867128">env</a>;
<a name="l00461"></a>00461         <a class="code" href="../../d8/d32/vm__core_8h.html#aaa39b3177aba775195d515b937ef78ff">GetEnvPtr</a>(<a class="code" href="../../de/de9/vm_8c.html#a518d3ecb1212b2eea58b409fd4ace787">ENV_VAL</a>(dfp), env);
<a name="l00462"></a>00462         <a class="code" href="../../de/de9/vm_8c.html#a2290ee4bcece4d937e5e04cf65c1771c">collect_local_variables_in_env</a>(env, ary);
<a name="l00463"></a>00463         <span class="keywordflow">return</span> 1;
<a name="l00464"></a>00464     }
<a name="l00465"></a>00465     <span class="keywordflow">else</span> {
<a name="l00466"></a>00466         <span class="keywordflow">return</span> 0;
<a name="l00467"></a>00467     }
<a name="l00468"></a>00468 }
<a name="l00469"></a>00469 
<a name="l00470"></a>00470 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00471"></a><a class="code" href="../../d8/d32/vm__core_8h.html#a38087978d8bc36f8cd48b62b70b15000">00471</a> <a class="code" href="../../de/de9/vm_8c.html#a38087978d8bc36f8cd48b62b70b15000">rb_vm_make_env_object</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> * th, <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp)
<a name="l00472"></a>00472 {
<a name="l00473"></a>00473     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> envval;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(cfp) == <a class="code" href="../../d8/d32/vm__core_8h.html#a885c6468caef6c3de80b0ad6c50ae38d">VM_FRAME_MAGIC_FINISH</a>) {
<a name="l00476"></a>00476         <span class="comment">/* for method_missing */</span>
<a name="l00477"></a>00477         cfp = <a class="code" href="../../d8/d32/vm__core_8h.html#af087c881c3c493e3a4e326852e8ed2a9">RUBY_VM_PREVIOUS_CONTROL_FRAME</a>(cfp);
<a name="l00478"></a>00478     }
<a name="l00479"></a>00479 
<a name="l00480"></a>00480     envval = <a class="code" href="../../de/de9/vm_8c.html#a7920e56cee3ddd3b387cbe2d69b69544">vm_make_env_each</a>(th, cfp, cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a>, cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a>);
<a name="l00481"></a>00481     <a class="code" href="../../de/de9/vm_8c.html#a193faf68e941a3c79d23e310ed1d424c">rb_vm_rewrite_dfp_in_errinfo</a>(th);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     <span class="keywordflow">if</span> (<a class="code" href="../../de/de9/vm_8c.html#a750084962ee12011b63dd0b901058f71">PROCDEBUG</a>) {
<a name="l00484"></a>00484         <a class="code" href="../../de/de9/vm_8c.html#ad686a96329c814869e6200edfac5107a">check_env_value</a>(envval);
<a name="l00485"></a>00485     }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487     <span class="keywordflow">return</span> envval;
<a name="l00488"></a>00488 }
<a name="l00489"></a>00489 
<a name="l00490"></a>00490 <span class="keywordtype">void</span>
<a name="l00491"></a><a class="code" href="../../d8/d32/vm__core_8h.html#a193faf68e941a3c79d23e310ed1d424c">00491</a> <a class="code" href="../../de/de9/vm_8c.html#a193faf68e941a3c79d23e310ed1d424c">rb_vm_rewrite_dfp_in_errinfo</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l00492"></a>00492 {
<a name="l00493"></a>00493     <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>;
<a name="l00494"></a>00494     <span class="keywordflow">while</span> (!<a class="code" href="../../d8/d32/vm__core_8h.html#ac3cef3df2cc03d3090ad49220cb453d5">RUBY_VM_CONTROL_FRAME_STACK_OVERFLOW_P</a>(th, cfp)) {
<a name="l00495"></a>00495         <span class="comment">/* rewrite dfp in errinfo to point to heap */</span>
<a name="l00496"></a>00496         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a79d03ad9b9cf8b7a8ca2b849e495a74f">RUBY_VM_NORMAL_ISEQ_P</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>) &amp;&amp;
<a name="l00497"></a>00497             (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#af8bc7dbae6f61d836b5bb9fb50b6cfb8">type</a> == ISEQ_TYPE_RESCUE ||
<a name="l00498"></a>00498              cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#af8bc7dbae6f61d836b5bb9fb50b6cfb8">type</a> == ISEQ_TYPE_ENSURE)) {
<a name="l00499"></a>00499             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> errinfo = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a>[-2]; <span class="comment">/* #$! */</span>
<a name="l00500"></a>00500             <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac4f895997656c2abd27a29a8b8e982ca">RB_TYPE_P</a>(errinfo, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5f1cc49c4da51d5bdffa64be79ff6fb0">T_NODE</a>)) {
<a name="l00501"></a>00501                 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *escape_dfp = <a class="code" href="../../dd/dd0/eval__intern_8h.html#aeeda78ded67b3dc359c8911e679f0f15">GET_THROWOBJ_CATCH_POINT</a>(errinfo);
<a name="l00502"></a>00502                 <span class="keywordflow">if</span> (! <a class="code" href="../../de/de9/vm_8c.html#a763a6b9c07ba29acc33611df4297f321">ENV_IN_HEAP_P</a>(th, escape_dfp)) {
<a name="l00503"></a>00503                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> dfpval = *escape_dfp;
<a name="l00504"></a>00504                     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad07df58de9895cbc33c10f02540d2d4d">CLASS_OF</a>(dfpval) == <a class="code" href="../../de/de9/vm_8c.html#ad55204994fe946dcd317061047845c3a">rb_cEnv</a>) {
<a name="l00505"></a>00505                         <a class="code" href="../../d0/d73/structrb__env__t.html">rb_env_t</a> *dfpenv;
<a name="l00506"></a>00506                         <a class="code" href="../../d8/d32/vm__core_8h.html#aaa39b3177aba775195d515b937ef78ff">GetEnvPtr</a>(dfpval, dfpenv);
<a name="l00507"></a>00507                         <a class="code" href="../../dd/dd0/eval__intern_8h.html#aa893e1d4238c9135f318ddaff6b1c679">SET_THROWOBJ_CATCH_POINT</a>(errinfo, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)(dfpenv-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a1c42d4847422b6ffd0fb340fdd0cfa8b">env</a> + dfpenv-&gt;<a class="code" href="../../d0/d73/structrb__env__t.html#a5babbdd0740bbdc371ae7d2f225e8b64">local_size</a>));
<a name="l00508"></a>00508                     }
<a name="l00509"></a>00509                 }
<a name="l00510"></a>00510             }
<a name="l00511"></a>00511         }
<a name="l00512"></a>00512         cfp = <a class="code" href="../../d8/d32/vm__core_8h.html#af087c881c3c493e3a4e326852e8ed2a9">RUBY_VM_PREVIOUS_CONTROL_FRAME</a>(cfp);
<a name="l00513"></a>00513     }
<a name="l00514"></a>00514 }
<a name="l00515"></a>00515 
<a name="l00516"></a>00516 <span class="keywordtype">void</span>
<a name="l00517"></a><a class="code" href="../../d8/d32/vm__core_8h.html#af0a6e7c3e77f3c6c8e7738b79dfbde2f">00517</a> <a class="code" href="../../de/de9/vm_8c.html#af0a6e7c3e77f3c6c8e7738b79dfbde2f">rb_vm_stack_to_heap</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l00518"></a>00518 {
<a name="l00519"></a>00519     <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>;
<a name="l00520"></a>00520     <span class="keywordflow">while</span> ((cfp = <a class="code" href="../../de/de9/vm_8c.html#a2709ccd7eeff81c0f749a7678223857e">rb_vm_get_ruby_level_next_cfp</a>(th, cfp)) != 0) {
<a name="l00521"></a>00521         <a class="code" href="../../de/de9/vm_8c.html#a38087978d8bc36f8cd48b62b70b15000">rb_vm_make_env_object</a>(th, cfp);
<a name="l00522"></a>00522         cfp = <a class="code" href="../../d8/d32/vm__core_8h.html#af087c881c3c493e3a4e326852e8ed2a9">RUBY_VM_PREVIOUS_CONTROL_FRAME</a>(cfp);
<a name="l00523"></a>00523     }
<a name="l00524"></a>00524 }
<a name="l00525"></a>00525 
<a name="l00526"></a>00526 <span class="comment">/* Proc */</span>
<a name="l00527"></a>00527 
<a name="l00528"></a>00528 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00529"></a><a class="code" href="../../de/de9/vm_8c.html#afbd004fdeff5b9e93c1a3792114f0be0">00529</a> <a class="code" href="../../de/de9/vm_8c.html#afbd004fdeff5b9e93c1a3792114f0be0">vm_make_proc_from_block</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../da/dc0/structrb__block__struct.html">rb_block_t</a> *block)
<a name="l00530"></a>00530 {
<a name="l00531"></a>00531     <span class="keywordflow">if</span> (!block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#a305ea0fcc6d1233de416bd8e7edab218">proc</a>) {
<a name="l00532"></a>00532         block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#a305ea0fcc6d1233de416bd8e7edab218">proc</a> = <a class="code" href="../../de/de9/vm_8c.html#a7e8d71dee905abc403d671561b12f4e8">rb_vm_make_proc</a>(th, block, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abd0d5fa9d171dbf020e85958391437f9">rb_cProc</a>);
<a name="l00533"></a>00533     }
<a name="l00534"></a>00534     <span class="keywordflow">return</span> block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#a305ea0fcc6d1233de416bd8e7edab218">proc</a>;
<a name="l00535"></a>00535 }
<a name="l00536"></a>00536 
<a name="l00537"></a>00537 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00538"></a><a class="code" href="../../d8/d32/vm__core_8h.html#a7e8d71dee905abc403d671561b12f4e8">00538</a> <a class="code" href="../../de/de9/vm_8c.html#a7e8d71dee905abc403d671561b12f4e8">rb_vm_make_proc</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <span class="keyword">const</span> <a class="code" href="../../da/dc0/structrb__block__struct.html">rb_block_t</a> *block, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass)
<a name="l00539"></a>00539 {
<a name="l00540"></a>00540     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> procval, envval, blockprocval = 0;
<a name="l00541"></a>00541     <a class="code" href="../../d5/d77/structrb__proc__t.html">rb_proc_t</a> *proc;
<a name="l00542"></a>00542     <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp = <a class="code" href="../../d8/d32/vm__core_8h.html#a2cc1c838fecda2400fa9f2fb5fad3618">RUBY_VM_GET_CFP_FROM_BLOCK_PTR</a>(block);
<a name="l00543"></a>00543 
<a name="l00544"></a>00544     <span class="keywordflow">if</span> (block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#a305ea0fcc6d1233de416bd8e7edab218">proc</a>) {
<a name="l00545"></a>00545         <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;rb_vm_make_proc: Proc value is already created.&quot;</span>);
<a name="l00546"></a>00546     }
<a name="l00547"></a>00547 
<a name="l00548"></a>00548     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a373f1cafd944ff9e99986582d0fd695b">GC_GUARDED_PTR_REF</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a>[0])) {
<a name="l00549"></a>00549         <a class="code" href="../../d5/d77/structrb__proc__t.html">rb_proc_t</a> *p;
<a name="l00550"></a>00550 
<a name="l00551"></a>00551         blockprocval = <a class="code" href="../../de/de9/vm_8c.html#afbd004fdeff5b9e93c1a3792114f0be0">vm_make_proc_from_block</a>(
<a name="l00552"></a>00552             th, (<a class="code" href="../../da/dc0/structrb__block__struct.html">rb_block_t</a> *)<a class="code" href="../../d8/d32/vm__core_8h.html#a373f1cafd944ff9e99986582d0fd695b">GC_GUARDED_PTR_REF</a>(*cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a>));
<a name="l00553"></a>00553 
<a name="l00554"></a>00554         <a class="code" href="../../d8/d32/vm__core_8h.html#ad9cb04a311c21bdbbd936d8f8b7237db">GetProcPtr</a>(blockprocval, p);
<a name="l00555"></a>00555         *cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a> = <a class="code" href="../../d8/d32/vm__core_8h.html#a4bc9fa804787db9db7ea5d698da9db9e">GC_GUARDED_PTR</a>(&amp;p-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#acf80b0e350012548c28cba1ea64a7a6e">block</a>);
<a name="l00556"></a>00556     }
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     envval = <a class="code" href="../../de/de9/vm_8c.html#a38087978d8bc36f8cd48b62b70b15000">rb_vm_make_env_object</a>(th, cfp);
<a name="l00559"></a>00559 
<a name="l00560"></a>00560     <span class="keywordflow">if</span> (<a class="code" href="../../de/de9/vm_8c.html#a750084962ee12011b63dd0b901058f71">PROCDEBUG</a>) {
<a name="l00561"></a>00561         <a class="code" href="../../de/de9/vm_8c.html#ad686a96329c814869e6200edfac5107a">check_env_value</a>(envval);
<a name="l00562"></a>00562     }
<a name="l00563"></a>00563     procval = <a class="code" href="../../d3/dda/proc_8c.html#afdfd5397f25a751a5bf34dbfeb0968ba">rb_proc_alloc</a>(klass);
<a name="l00564"></a>00564     <a class="code" href="../../d8/d32/vm__core_8h.html#ad9cb04a311c21bdbbd936d8f8b7237db">GetProcPtr</a>(procval, proc);
<a name="l00565"></a>00565     proc-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#a6541c1e61b0734aef20b7c2af3b4de5e">blockprocval</a> = blockprocval;
<a name="l00566"></a>00566     proc-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#acf80b0e350012548c28cba1ea64a7a6e">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ad54e1ec45ab21ef384fe9e4346570397">self</a> = block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#ad54e1ec45ab21ef384fe9e4346570397">self</a>;
<a name="l00567"></a>00567     proc-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#acf80b0e350012548c28cba1ea64a7a6e">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#a834e1c9b35a06714deeb62097636564f">lfp</a> = block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#a834e1c9b35a06714deeb62097636564f">lfp</a>;
<a name="l00568"></a>00568     proc-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#acf80b0e350012548c28cba1ea64a7a6e">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a> = block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a>;
<a name="l00569"></a>00569     proc-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#acf80b0e350012548c28cba1ea64a7a6e">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#a8e2b3b9218b4a184f198872404e81605">iseq</a> = block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#a8e2b3b9218b4a184f198872404e81605">iseq</a>;
<a name="l00570"></a>00570     proc-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#acf80b0e350012548c28cba1ea64a7a6e">block</a>.<a class="code" href="../../da/dc0/structrb__block__struct.html#a305ea0fcc6d1233de416bd8e7edab218">proc</a> = procval;
<a name="l00571"></a>00571     proc-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#acdb9a8c85422bf299615f7942ffbc916">envval</a> = envval;
<a name="l00572"></a>00572     proc-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#aceef0bead8eaa17dd1217f6078e9cd75">safe_level</a> = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#adc5048ddde96e3ea2e6b22c3e58ce696">safe_level</a>;
<a name="l00573"></a>00573 
<a name="l00574"></a>00574     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d5f/vm__insnhelper_8h.html#a5e6b7f865cae591e5e27b0e36b0d357f" title="VM Debug Level.">VMDEBUG</a>) {
<a name="l00575"></a>00575         <span class="keywordflow">if</span> (th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a> &lt; block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a> &amp;&amp; block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a> &lt; th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a> + th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1587dec1a575fb9f8d6a689ef4fdb6b5">stack_size</a>) {
<a name="l00576"></a>00576             <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;invalid ptr: block-&gt;dfp&quot;</span>);
<a name="l00577"></a>00577         }
<a name="l00578"></a>00578         <span class="keywordflow">if</span> (th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a> &lt; block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#a834e1c9b35a06714deeb62097636564f">lfp</a> &amp;&amp; block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#a834e1c9b35a06714deeb62097636564f">lfp</a> &lt; th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a> + th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1587dec1a575fb9f8d6a689ef4fdb6b5">stack_size</a>) {
<a name="l00579"></a>00579             <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;invalid ptr: block-&gt;lfp&quot;</span>);
<a name="l00580"></a>00580         }
<a name="l00581"></a>00581     }
<a name="l00582"></a>00582 
<a name="l00583"></a>00583     <span class="keywordflow">return</span> procval;
<a name="l00584"></a>00584 }
<a name="l00585"></a>00585 
<a name="l00586"></a>00586 <span class="comment">/* C -&gt; Ruby: block */</span>
<a name="l00587"></a>00587 
<a name="l00588"></a>00588 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00589"></a><a class="code" href="../../de/de9/vm_8c.html#a9ccac59de15bb257e3b0243b4c5ef43c">00589</a> <a class="code" href="../../de/de9/vm_8c.html#a9ccac59de15bb257e3b0243b4c5ef43c">invoke_block_from_c</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <span class="keyword">const</span> <a class="code" href="../../da/dc0/structrb__block__struct.html">rb_block_t</a> *block,
<a name="l00590"></a>00590                     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <span class="keyword">const</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>,
<a name="l00591"></a>00591                     <span class="keyword">const</span> <a class="code" href="../../da/dc0/structrb__block__struct.html">rb_block_t</a> *blockptr, <span class="keyword">const</span> NODE *cref)
<a name="l00592"></a>00592 {
<a name="l00593"></a>00593     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ac59489a7ed093e29019047d13e79c009">SPECIAL_CONST_P</a>(block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#a8e2b3b9218b4a184f198872404e81605">iseq</a>))
<a name="l00594"></a>00594         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00595"></a>00595     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#aee74f540353cd2d77d1cb37a3714bd7d">BUILTIN_TYPE</a>(block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#a8e2b3b9218b4a184f198872404e81605">iseq</a>) != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5f1cc49c4da51d5bdffa64be79ff6fb0">T_NODE</a>) {
<a name="l00596"></a>00596         <span class="keyword">const</span> <a class="code" href="../../d6/de3/structrb__iseq__struct.html">rb_iseq_t</a> *iseq = block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#a8e2b3b9218b4a184f198872404e81605">iseq</a>;
<a name="l00597"></a>00597         <span class="keyword">const</span> <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp;
<a name="l00598"></a>00598         <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *ncfp;
<a name="l00599"></a>00599         <span class="keywordtype">int</span> i, opt_pc, arg_size = iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#abd2b67e0dffb2262ab272a67bbe747d6">arg_size</a>;
<a name="l00600"></a>00600         <span class="keywordtype">int</span> <a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a> = <a class="code" href="../../d0/db2/vm__insnhelper_8c.html#a12e2a36d6e51eedb258d07ee68314671">block_proc_is_lambda</a>(block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#a305ea0fcc6d1233de416bd8e7edab218">proc</a>) ?
<a name="l00601"></a>00601           <a class="code" href="../../d8/d32/vm__core_8h.html#a57840803108748406429fb1cb3b10530">VM_FRAME_MAGIC_LAMBDA</a> : <a class="code" href="../../d8/d32/vm__core_8h.html#a83eeedff3dde6d2d1ffce5d84c2ba2f1">VM_FRAME_MAGIC_BLOCK</a>;
<a name="l00602"></a>00602 
<a name="l00603"></a>00603         <a class="code" href="../../de/de9/vm_8c.html#aa8deb4813e5d237bb18713ddb5d98b74">rb_vm_set_finish_env</a>(th);
<a name="l00604"></a>00604 
<a name="l00605"></a>00605         cfp = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>;
<a name="l00606"></a>00606         <a class="code" href="../../dd/dd0/eval__intern_8h.html#a03427c07c33d15b934d5f9f4bcfb1c95">CHECK_STACK_OVERFLOW</a>(cfp, argc + iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a00494b6f5b1aa350819cad777e19eee8">stack_max</a>);
<a name="l00607"></a>00607 
<a name="l00608"></a>00608         <span class="keywordflow">for</span> (i=0; i&lt;argc; i++) {
<a name="l00609"></a>00609             cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a>[i] = argv[i];
<a name="l00610"></a>00610         }
<a name="l00611"></a>00611 
<a name="l00612"></a>00612         opt_pc = <a class="code" href="../../d0/db2/vm__insnhelper_8c.html#a738cd1c8e659fcea3cc75f1f97169878">vm_yield_setup_args</a>(th, iseq, argc, cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a>, blockptr,
<a name="l00613"></a>00613                                      type == <a class="code" href="../../d8/d32/vm__core_8h.html#a57840803108748406429fb1cb3b10530">VM_FRAME_MAGIC_LAMBDA</a>);
<a name="l00614"></a>00614 
<a name="l00615"></a>00615         ncfp = <a class="code" href="../../d0/db2/vm__insnhelper_8c.html#a30340566da5743c4d660c8931dffd86e">vm_push_frame</a>(th, iseq, type,
<a name="l00616"></a>00616                              <span class="keyword">self</span>, <a class="code" href="../../d8/d32/vm__core_8h.html#a4bc9fa804787db9db7ea5d698da9db9e">GC_GUARDED_PTR</a>(block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#ac3696ee534a836d6ccc55cdeb2181ac5">dfp</a>),
<a name="l00617"></a>00617                              iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aa70f3e195a4350acbbc130f8a95c9958">iseq_encoded</a> + opt_pc, cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a> + arg_size, block-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#a834e1c9b35a06714deeb62097636564f">lfp</a>,
<a name="l00618"></a>00618                              iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#afbae994355f91f3ea547570debb757c0">local_size</a> - arg_size);
<a name="l00619"></a>00619         ncfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aa0ec76f80ebaf0668b688c4e4e5e3e3f">me</a> = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a42b995c9fe5e654442129c060c1a8219">passed_me</a>;
<a name="l00620"></a>00620         th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a42b995c9fe5e654442129c060c1a8219">passed_me</a> = 0;
<a name="l00621"></a>00621         th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#ae680ba33fe514b2b0031d77ad1527e1a">passed_block</a> = blockptr;
<a name="l00622"></a>00622 
<a name="l00623"></a>00623         <span class="keywordflow">if</span> (cref) {
<a name="l00624"></a>00624             th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a>[-1] = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)cref;
<a name="l00625"></a>00625         }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627         <span class="keywordflow">return</span> <a class="code" href="../../de/de9/vm_8c.html#a6fca4e13002f037d2e15bc1c77ab18ed">vm_exec</a>(th);
<a name="l00628"></a>00628     }
<a name="l00629"></a>00629     <span class="keywordflow">else</span> {
<a name="l00630"></a>00630         <span class="keywordflow">return</span> <a class="code" href="../../d0/db2/vm__insnhelper_8c.html#abdbae6f122fc653110b2893cece182df">vm_yield_with_cfunc</a>(th, block, <span class="keyword">self</span>, argc, argv, blockptr);
<a name="l00631"></a>00631     }
<a name="l00632"></a>00632 }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> <a class="code" href="../../da/dc0/structrb__block__struct.html">rb_block_t</a> *
<a name="l00635"></a><a class="code" href="../../de/de9/vm_8c.html#ad3546781259eb3e30b64580b1f35e6fb">00635</a> <a class="code" href="../../de/de9/vm_8c.html#ad3546781259eb3e30b64580b1f35e6fb">check_block</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l00636"></a>00636 {
<a name="l00637"></a>00637     <span class="keyword">const</span> <a class="code" href="../../da/dc0/structrb__block__struct.html">rb_block_t</a> *blockptr = <a class="code" href="../../d8/d32/vm__core_8h.html#a373f1cafd944ff9e99986582d0fd695b">GC_GUARDED_PTR_REF</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a>[0]);
<a name="l00638"></a>00638 
<a name="l00639"></a>00639     <span class="keywordflow">if</span> (blockptr == 0) {
<a name="l00640"></a>00640         <a class="code" href="../../de/de9/vm_8c.html#a0402672d92f48e0018ab5f8aeda270e6">rb_vm_localjump_error</a>(<span class="stringliteral">&quot;no block given&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>, 0);
<a name="l00641"></a>00641     }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643     <span class="keywordflow">return</span> blockptr;
<a name="l00644"></a>00644 }
<a name="l00645"></a>00645 
<a name="l00646"></a>00646 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00647"></a><a class="code" href="../../de/de9/vm_8c.html#a2525811685e5b25a1d89a966f862fbea">00647</a> <a class="code" href="../../de/de9/vm_8c.html#a2525811685e5b25a1d89a966f862fbea">vm_yield_with_cref</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <span class="keyword">const</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <span class="keyword">const</span> NODE *cref)
<a name="l00648"></a>00648 {
<a name="l00649"></a>00649     <span class="keyword">const</span> <a class="code" href="../../da/dc0/structrb__block__struct.html">rb_block_t</a> *blockptr = <a class="code" href="../../de/de9/vm_8c.html#ad3546781259eb3e30b64580b1f35e6fb">check_block</a>(th);
<a name="l00650"></a>00650     <span class="keywordflow">return</span> <a class="code" href="../../de/de9/vm_8c.html#a9ccac59de15bb257e3b0243b4c5ef43c">invoke_block_from_c</a>(th, blockptr, blockptr-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#ad54e1ec45ab21ef384fe9e4346570397">self</a>, argc, argv, 0, cref);
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00654"></a><a class="code" href="../../de/de9/vm_8c.html#a60a89de76b17391f34b5905586c9651f">00654</a> <a class="code" href="../../de/de9/vm_8c.html#a60a89de76b17391f34b5905586c9651f">vm_yield</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <span class="keyword">const</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>)
<a name="l00655"></a>00655 {
<a name="l00656"></a>00656     <span class="keyword">const</span> <a class="code" href="../../da/dc0/structrb__block__struct.html">rb_block_t</a> *blockptr = <a class="code" href="../../de/de9/vm_8c.html#ad3546781259eb3e30b64580b1f35e6fb">check_block</a>(th);
<a name="l00657"></a>00657     <span class="keywordflow">return</span> <a class="code" href="../../de/de9/vm_8c.html#a9ccac59de15bb257e3b0243b4c5ef43c">invoke_block_from_c</a>(th, blockptr, blockptr-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#ad54e1ec45ab21ef384fe9e4346570397">self</a>, argc, argv, 0, 0);
<a name="l00658"></a>00658 }
<a name="l00659"></a>00659 
<a name="l00660"></a>00660 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00661"></a><a class="code" href="../../d8/d32/vm__core_8h.html#a87fd97e34aa2d7399db658edb02ea083">00661</a> <a class="code" href="../../de/de9/vm_8c.html#a87fd97e34aa2d7399db658edb02ea083">rb_vm_invoke_proc</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../d5/d77/structrb__proc__t.html">rb_proc_t</a> *proc, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>,
<a name="l00662"></a>00662                   <span class="keywordtype">int</span> <a class="code" href="../../df/d77/ruby_8c.html#ad1447518f4372828b8435ae82e48499e">argc</a>, <span class="keyword">const</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../df/d77/ruby_8c.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>, <span class="keyword">const</span> <a class="code" href="../../da/dc0/structrb__block__struct.html">rb_block_t</a> * blockptr)
<a name="l00663"></a>00663 {
<a name="l00664"></a>00664     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a>;
<a name="l00665"></a>00665     <span class="keywordtype">int</span> <a class="code" href="../../d5/d1d/gb18030_8c.html#adc6e5733fc3c22f0a7b2914188c49c90">state</a>;
<a name="l00666"></a>00666     <span class="keyword">volatile</span> <span class="keywordtype">int</span> stored_safe = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#adc5048ddde96e3ea2e6b22c3e58ce696">safe_level</a>;
<a name="l00667"></a>00667 
<a name="l00668"></a>00668     <a class="code" href="../../dd/dd0/eval__intern_8h.html#a4410e4208d7ae0de8dae7c5b61f9d55c">TH_PUSH_TAG</a>(th);
<a name="l00669"></a>00669     <span class="keywordflow">if</span> ((state = <a class="code" href="../../dd/dd0/eval__intern_8h.html#a3441e3967c633da99c3dcd025494053e">EXEC_TAG</a>()) == 0) {
<a name="l00670"></a>00670         <span class="keywordflow">if</span> (!proc-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#ab758491302d7ae34dba60f7c39b97c95">is_from_method</a>) {
<a name="l00671"></a>00671             th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#adc5048ddde96e3ea2e6b22c3e58ce696">safe_level</a> = proc-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#aceef0bead8eaa17dd1217f6078e9cd75">safe_level</a>;
<a name="l00672"></a>00672         }
<a name="l00673"></a>00673         val = <a class="code" href="../../de/de9/vm_8c.html#a9ccac59de15bb257e3b0243b4c5ef43c">invoke_block_from_c</a>(th, &amp;proc-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#acf80b0e350012548c28cba1ea64a7a6e">block</a>, <span class="keyword">self</span>, argc, argv, blockptr, 0);
<a name="l00674"></a>00674     }
<a name="l00675"></a>00675     <a class="code" href="../../dd/dd0/eval__intern_8h.html#a4d06135dea1a72a3ab73b20cc1a9fc55">TH_POP_TAG</a>();
<a name="l00676"></a>00676 
<a name="l00677"></a>00677     <span class="keywordflow">if</span> (!proc-&gt;<a class="code" href="../../d5/d77/structrb__proc__t.html#ab758491302d7ae34dba60f7c39b97c95">is_from_method</a>) {
<a name="l00678"></a>00678         th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#adc5048ddde96e3ea2e6b22c3e58ce696">safe_level</a> = stored_safe;
<a name="l00679"></a>00679     }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     <span class="keywordflow">if</span> (state) {
<a name="l00682"></a>00682         <a class="code" href="../../dd/dd0/eval__intern_8h.html#a24884166ae699029ade34fd36bedd688">JUMP_TAG</a>(state);
<a name="l00683"></a>00683     }
<a name="l00684"></a>00684     <span class="keywordflow">return</span> val;
<a name="l00685"></a>00685 }
<a name="l00686"></a>00686 
<a name="l00687"></a>00687 <span class="comment">/* special variable */</span>
<a name="l00688"></a>00688 
<a name="l00689"></a>00689 <span class="keyword">static</span> <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *
<a name="l00690"></a><a class="code" href="../../de/de9/vm_8c.html#aa10e58958709037c9e4bba549b0d4755">00690</a> <a class="code" href="../../de/de9/vm_8c.html#aa10e58958709037c9e4bba549b0d4755">vm_normal_frame</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp)
<a name="l00691"></a>00691 {
<a name="l00692"></a>00692     <span class="keywordflow">while</span> (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a28b0b301811a891225ba9a58c412482d">pc</a> == 0) {
<a name="l00693"></a>00693         cfp = <a class="code" href="../../d8/d32/vm__core_8h.html#af087c881c3c493e3a4e326852e8ed2a9">RUBY_VM_PREVIOUS_CONTROL_FRAME</a>(cfp);
<a name="l00694"></a>00694         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#ac3cef3df2cc03d3090ad49220cb453d5">RUBY_VM_CONTROL_FRAME_STACK_OVERFLOW_P</a>(th, cfp)) {
<a name="l00695"></a>00695             <span class="keywordflow">return</span> 0;
<a name="l00696"></a>00696         }
<a name="l00697"></a>00697     }
<a name="l00698"></a>00698     <span class="keywordflow">return</span> cfp;
<a name="l00699"></a>00699 }
<a name="l00700"></a>00700 
<a name="l00701"></a>00701 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00702"></a><a class="code" href="../../de/de9/vm_8c.html#a5077c2fe5c10efbf02a0ee287b84c809">00702</a> <a class="code" href="../../de/de9/vm_8c.html#a5077c2fe5c10efbf02a0ee287b84c809">vm_cfp_svar_get</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>)
<a name="l00703"></a>00703 {
<a name="l00704"></a>00704     cfp = <a class="code" href="../../de/de9/vm_8c.html#aa10e58958709037c9e4bba549b0d4755">vm_normal_frame</a>(th, cfp);
<a name="l00705"></a>00705     <span class="keywordflow">return</span> <a class="code" href="../../d0/db2/vm__insnhelper_8c.html#a21cd7ff26c1eae715ea2001c0ba5e9f1">lfp_svar_get</a>(th, cfp ? cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a> : 0, key);
<a name="l00706"></a>00706 }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00709"></a><a class="code" href="../../de/de9/vm_8c.html#aa873ebca03e88966c9fd8710cff0a429">00709</a> <a class="code" href="../../de/de9/vm_8c.html#aa873ebca03e88966c9fd8710cff0a429">vm_cfp_svar_set</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <span class="keyword">const</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val)
<a name="l00710"></a>00710 {
<a name="l00711"></a>00711     cfp = <a class="code" href="../../de/de9/vm_8c.html#aa10e58958709037c9e4bba549b0d4755">vm_normal_frame</a>(th, cfp);
<a name="l00712"></a>00712     <a class="code" href="../../d0/db2/vm__insnhelper_8c.html#a8e110b1f026687389b58711769b9f272">lfp_svar_set</a>(th, cfp ? cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a> : 0, key, val);
<a name="l00713"></a>00713 }
<a name="l00714"></a>00714 
<a name="l00715"></a>00715 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00716"></a><a class="code" href="../../de/de9/vm_8c.html#a9ae786ebda2b26b25d2fc8212420e665">00716</a> <a class="code" href="../../de/de9/vm_8c.html#a9ae786ebda2b26b25d2fc8212420e665">vm_svar_get</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>)
<a name="l00717"></a>00717 {
<a name="l00718"></a>00718     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l00719"></a>00719     <span class="keywordflow">return</span> <a class="code" href="../../de/de9/vm_8c.html#a5077c2fe5c10efbf02a0ee287b84c809">vm_cfp_svar_get</a>(th, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>, key);
<a name="l00720"></a>00720 }
<a name="l00721"></a>00721 
<a name="l00722"></a>00722 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00723"></a><a class="code" href="../../de/de9/vm_8c.html#ab3cf4160fd472c04e48e7569c2ed34fe">00723</a> <a class="code" href="../../de/de9/vm_8c.html#ab3cf4160fd472c04e48e7569c2ed34fe">vm_svar_set</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val)
<a name="l00724"></a>00724 {
<a name="l00725"></a>00725     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l00726"></a>00726     <a class="code" href="../../de/de9/vm_8c.html#aa873ebca03e88966c9fd8710cff0a429">vm_cfp_svar_set</a>(th, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>, key, val);
<a name="l00727"></a>00727 }
<a name="l00728"></a>00728 
<a name="l00729"></a>00729 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00730"></a><a class="code" href="../../de/de9/vm_8c.html#a2590f9272c0599ff0d1922bd0fb6efce">00730</a> <a class="code" href="../../db/d2e/intern_8h.html#a2590f9272c0599ff0d1922bd0fb6efce">rb_backref_get</a>(<span class="keywordtype">void</span>)
<a name="l00731"></a>00731 {
<a name="l00732"></a>00732     <span class="keywordflow">return</span> <a class="code" href="../../de/de9/vm_8c.html#a9ae786ebda2b26b25d2fc8212420e665">vm_svar_get</a>(1);
<a name="l00733"></a>00733 }
<a name="l00734"></a>00734 
<a name="l00735"></a>00735 <span class="keywordtype">void</span>
<a name="l00736"></a><a class="code" href="../../de/de9/vm_8c.html#a96a10fbdd9c8c5718f51516c714da0b1">00736</a> <a class="code" href="../../db/d2e/intern_8h.html#af108344435c1d0ea151c99dc859cccb4">rb_backref_set</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val)
<a name="l00737"></a>00737 {
<a name="l00738"></a>00738     <a class="code" href="../../de/de9/vm_8c.html#ab3cf4160fd472c04e48e7569c2ed34fe">vm_svar_set</a>(1, val);
<a name="l00739"></a>00739 }
<a name="l00740"></a>00740 
<a name="l00741"></a>00741 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00742"></a><a class="code" href="../../de/de9/vm_8c.html#ac185acdaeb1aadf3f4297609e05fd083">00742</a> <a class="code" href="../../db/d2e/intern_8h.html#ac185acdaeb1aadf3f4297609e05fd083">rb_lastline_get</a>(<span class="keywordtype">void</span>)
<a name="l00743"></a>00743 {
<a name="l00744"></a>00744     <span class="keywordflow">return</span> <a class="code" href="../../de/de9/vm_8c.html#a9ae786ebda2b26b25d2fc8212420e665">vm_svar_get</a>(0);
<a name="l00745"></a>00745 }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747 <span class="keywordtype">void</span>
<a name="l00748"></a><a class="code" href="../../de/de9/vm_8c.html#a1afa8b88ecd32dd5f8fecdc8c31568e7">00748</a> <a class="code" href="../../db/d2e/intern_8h.html#ada36b7e0e23335fa38937f0b5328601d">rb_lastline_set</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val)
<a name="l00749"></a>00749 {
<a name="l00750"></a>00750     <a class="code" href="../../de/de9/vm_8c.html#ab3cf4160fd472c04e48e7569c2ed34fe">vm_svar_set</a>(0, val);
<a name="l00751"></a>00751 }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753 <span class="comment">/* backtrace */</span>
<a name="l00754"></a>00754 
<a name="l00755"></a>00755 <span class="keywordtype">int</span>
<a name="l00756"></a><a class="code" href="../../d8/d32/vm__core_8h.html#a645bbb43d2f118e9fa17817082c47a79">00756</a> <a class="code" href="../../de/de9/vm_8c.html#a70289cbb34babceed6243d9471e70e5f">rb_vm_get_sourceline</a>(<span class="keyword">const</span> <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp)
<a name="l00757"></a>00757 {
<a name="l00758"></a>00758     <span class="keywordtype">int</span> line_no = 0;
<a name="l00759"></a>00759     <span class="keyword">const</span> <a class="code" href="../../d6/de3/structrb__iseq__struct.html">rb_iseq_t</a> *iseq = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a79d03ad9b9cf8b7a8ca2b849e495a74f">RUBY_VM_NORMAL_ISEQ_P</a>(iseq) &amp;&amp; iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a4f2f75b5dd56c2069139710fc684bb67">insn_info_size</a> &gt; 0) {
<a name="l00762"></a>00762         <a class="code" href="../../d8/d32/vm__core_8h.html#afa3629f5cb977b24532d09e1aa055e4a">rb_num_t</a> i;
<a name="l00763"></a>00763         <span class="keywordtype">size_t</span> pos = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a28b0b301811a891225ba9a58c412482d">pc</a> - cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aa70f3e195a4350acbbc130f8a95c9958">iseq_encoded</a>;
<a name="l00764"></a>00764 
<a name="l00765"></a>00765         <span class="keywordflow">if</span> (iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a7d6b0dd003b6703454061024b11481ad">insn_info_table</a>[0].<a class="code" href="../../db/ded/structiseq__insn__info__entry.html#ad42ccac526cf4800ca5262006d35ee26">position</a> == pos) <span class="keywordflow">goto</span> found;
<a name="l00766"></a>00766         <span class="keywordflow">for</span> (i = 1; i &lt; iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a4f2f75b5dd56c2069139710fc684bb67">insn_info_size</a>; i++) {
<a name="l00767"></a>00767             <span class="keywordflow">if</span> (iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a7d6b0dd003b6703454061024b11481ad">insn_info_table</a>[i].<a class="code" href="../../db/ded/structiseq__insn__info__entry.html#ad42ccac526cf4800ca5262006d35ee26">position</a> == pos) {
<a name="l00768"></a>00768                 line_no = iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a7d6b0dd003b6703454061024b11481ad">insn_info_table</a>[i - 1].<a class="code" href="../../db/ded/structiseq__insn__info__entry.html#a6d449a8f403d3452777aca050b5c97fb">line_no</a>;
<a name="l00769"></a>00769                 <span class="keywordflow">goto</span> found;
<a name="l00770"></a>00770             }
<a name="l00771"></a>00771         }
<a name="l00772"></a>00772         line_no = iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a7d6b0dd003b6703454061024b11481ad">insn_info_table</a>[i - 1].<a class="code" href="../../db/ded/structiseq__insn__info__entry.html#a6d449a8f403d3452777aca050b5c97fb">line_no</a>;
<a name="l00773"></a>00773     }
<a name="l00774"></a>00774   found:
<a name="l00775"></a>00775     <span class="keywordflow">return</span> line_no;
<a name="l00776"></a>00776 }
<a name="l00777"></a>00777 
<a name="l00778"></a>00778 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00779"></a><a class="code" href="../../de/de9/vm_8c.html#a9c233b8f4d2f77f12089fc293705ddea">00779</a> <a class="code" href="../../de/de9/vm_8c.html#a9c233b8f4d2f77f12089fc293705ddea">vm_backtrace_each</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <span class="keywordtype">int</span> lev, <span class="keywordtype">void</span> (*<a class="code" href="../../df/d43/-test-_2string_2init_8c.html#a7c6f1d2e32298f69b4ea18be4aa62129">init</a>)(<span class="keywordtype">void</span> *), <a class="code" href="../../d8/d32/vm__core_8h.html#af17ad00cbac9b23ea267784b2547acbe">rb_backtrace_iter_func</a> *iter, <span class="keywordtype">void</span> *arg)
<a name="l00780"></a>00780 {
<a name="l00781"></a>00781     <span class="keyword">const</span> <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *limit_cfp = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>;
<a name="l00782"></a>00782     <span class="keyword">const</span> <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp = (<span class="keywordtype">void</span> *)(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a> + th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1587dec1a575fb9f8d6a689ef4fdb6b5">stack_size</a>);
<a name="l00783"></a>00783     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> file = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00784"></a>00784     <span class="keywordtype">int</span> line_no = 0;
<a name="l00785"></a>00785 
<a name="l00786"></a>00786     cfp -= 2;
<a name="l00787"></a>00787     <span class="keywordflow">while</span> (lev-- &gt;= 0) {
<a name="l00788"></a>00788         <span class="keywordflow">if</span> (++limit_cfp &gt; cfp) {
<a name="l00789"></a>00789             <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00790"></a>00790         }
<a name="l00791"></a>00791     }
<a name="l00792"></a>00792     <span class="keywordflow">if</span> (<a class="code" href="../../df/d43/-test-_2string_2init_8c.html#a7c6f1d2e32298f69b4ea18be4aa62129">init</a>) (*init)(arg);
<a name="l00793"></a>00793     limit_cfp = <a class="code" href="../../d8/d32/vm__core_8h.html#a456e0e30a5829a029128bcb785ff6933">RUBY_VM_NEXT_CONTROL_FRAME</a>(limit_cfp);
<a name="l00794"></a>00794     <span class="keywordflow">if</span> (th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3e7d0b05e2d73f324e70c735ba50739e">vm</a>-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a0fabbe8c44aac34d9538388955e2b461">progname</a>) file = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3e7d0b05e2d73f324e70c735ba50739e">vm</a>-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a0fabbe8c44aac34d9538388955e2b461">progname</a>;
<a name="l00795"></a>00795     <span class="keywordflow">while</span> (cfp &gt; limit_cfp) {
<a name="l00796"></a>00796         <span class="keywordflow">if</span> (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a> != 0) {
<a name="l00797"></a>00797             <span class="keywordflow">if</span> (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a28b0b301811a891225ba9a58c412482d">pc</a> != 0) {
<a name="l00798"></a>00798                 <a class="code" href="../../d6/de3/structrb__iseq__struct.html">rb_iseq_t</a> *iseq = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>;
<a name="l00799"></a>00799 
<a name="l00800"></a>00800                 line_no = <a class="code" href="../../de/de9/vm_8c.html#a70289cbb34babceed6243d9471e70e5f">rb_vm_get_sourceline</a>(cfp);
<a name="l00801"></a>00801                 file = iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a06859fa5de56f2ede3cb692f1d9215e2">filename</a>;
<a name="l00802"></a>00802                 <span class="keywordflow">if</span> ((*iter)(arg, file, line_no, iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a35596da255ce28a5d1da94c2cc508c7d">name</a>)) <span class="keywordflow">break</span>;
<a name="l00803"></a>00803             }
<a name="l00804"></a>00804         }
<a name="l00805"></a>00805         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#ae154762699bf1f722bdf05c22026d678">RUBYVM_CFUNC_FRAME_P</a>(cfp)) {
<a name="l00806"></a>00806             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a64ae40793ade89d800a8c5646d2980fc">id</a>;
<a name="l00807"></a>00807             <span class="keyword">extern</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d2/d0b/version_8c.html#aca7df2b4c101d2d9bc946de586de224c">ruby_engine_name</a>;
<a name="l00808"></a>00808 
<a name="l00809"></a>00809             <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(file)) file = ruby_engine_name;
<a name="l00810"></a>00810             <span class="keywordflow">if</span> (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aa0ec76f80ebaf0668b688c4e4e5e3e3f">me</a>-&gt;<a class="code" href="../../d7/db7/structrb__method__entry__struct.html#a6c868c50e67b757c6324dfef0f3184dc">def</a>)
<a name="l00811"></a>00811                 <span class="keywordtype">id</span> = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aa0ec76f80ebaf0668b688c4e4e5e3e3f">me</a>-&gt;<a class="code" href="../../d7/db7/structrb__method__entry__struct.html#a6c868c50e67b757c6324dfef0f3184dc">def</a>-&gt;<a class="code" href="../../d6/dab/structrb__method__definition__struct.html#a7fc0edb8505a61f8ae8bf2544fa7f676">original_id</a>;
<a name="l00812"></a>00812             <span class="keywordflow">else</span>
<a name="l00813"></a>00813                 <span class="keywordtype">id</span> = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aa0ec76f80ebaf0668b688c4e4e5e3e3f">me</a>-&gt;<a class="code" href="../../d7/db7/structrb__method__entry__struct.html#a31439bd620e98940410ba59244a85eae">called_id</a>;
<a name="l00814"></a>00814             <span class="keywordflow">if</span> (<span class="keywordtype">id</span> != <a class="code" href="../../db/d2e/intern_8h.html#aae711a904c63bacc1664e9ee240fc9b3">ID_ALLOCATOR</a> &amp;&amp; (*iter)(arg, file, line_no, <a class="code" href="../../d5/d11/ripper_8c.html#aec42ef320e57234e789bdda6d655716f">rb_id2str</a>(<span class="keywordtype">id</span>)))
<a name="l00815"></a>00815                 <span class="keywordflow">break</span>;
<a name="l00816"></a>00816         }
<a name="l00817"></a>00817         cfp = <a class="code" href="../../d8/d32/vm__core_8h.html#a456e0e30a5829a029128bcb785ff6933">RUBY_VM_NEXT_CONTROL_FRAME</a>(cfp);
<a name="l00818"></a>00818     }
<a name="l00819"></a>00819     <span class="keywordflow">return</span> <a class="code" href="../../d1/d5c/nkf_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00820"></a>00820 }
<a name="l00821"></a>00821 
<a name="l00822"></a>00822 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00823"></a><a class="code" href="../../de/de9/vm_8c.html#a0bfc83f8e81743a8e2267f285fc687e0">00823</a> <a class="code" href="../../de/de9/vm_8c.html#a0bfc83f8e81743a8e2267f285fc687e0">vm_backtrace_alloc</a>(<span class="keywordtype">void</span> *arg)
<a name="l00824"></a>00824 {
<a name="l00825"></a>00825     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *aryp = arg;
<a name="l00826"></a>00826     *aryp = <a class="code" href="../../dc/dcc/array_8c.html#a9518114fd36cb4ef4656ec1dc63348c9">rb_ary_new</a>();
<a name="l00827"></a>00827 }
<a name="l00828"></a>00828 
<a name="l00829"></a>00829 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00830"></a><a class="code" href="../../de/de9/vm_8c.html#ac10c02440395b95b8b6fbc79d2e1e127">00830</a> <a class="code" href="../../de/de9/vm_8c.html#ac10c02440395b95b8b6fbc79d2e1e127">vm_backtrace_push</a>(<span class="keywordtype">void</span> *arg, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> file, <span class="keywordtype">int</span> line_no, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)
<a name="l00831"></a>00831 {
<a name="l00832"></a>00832     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *aryp = arg;
<a name="l00833"></a>00833     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> bt;
<a name="l00834"></a>00834 
<a name="l00835"></a>00835     <span class="keywordflow">if</span> (line_no) {
<a name="l00836"></a>00836         bt = <a class="code" href="../../d9/d2d/sprintf_8c.html#a216ef515f4c79ee337820c5f637b802c">rb_enc_sprintf</a>(<a class="code" href="../../d5/db5/encoding_8c.html#a533ed45f02a3f72987b0f6f5ce04c996">rb_enc_compatible</a>(file, name), <span class="stringliteral">&quot;%s:%d:in `%s&apos;&quot;</span>,
<a name="l00837"></a>00837                             <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(file), line_no, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(name));
<a name="l00838"></a>00838     }
<a name="l00839"></a>00839     <span class="keywordflow">else</span> {
<a name="l00840"></a>00840         bt = <a class="code" href="../../d9/d2d/sprintf_8c.html#a216ef515f4c79ee337820c5f637b802c">rb_enc_sprintf</a>(<a class="code" href="../../d5/db5/encoding_8c.html#a533ed45f02a3f72987b0f6f5ce04c996">rb_enc_compatible</a>(file, name), <span class="stringliteral">&quot;%s:in `%s&apos;&quot;</span>,
<a name="l00841"></a>00841                             <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(file), <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(name));
<a name="l00842"></a>00842     }
<a name="l00843"></a>00843     <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(*aryp, bt);
<a name="l00844"></a>00844     <span class="keywordflow">return</span> 0;
<a name="l00845"></a>00845 }
<a name="l00846"></a>00846 
<a name="l00847"></a>00847 <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00848"></a><a class="code" href="../../de/de9/vm_8c.html#a1a2da1f8e6027c3088ccde6bc397b34d">00848</a> <a class="code" href="../../de/de9/vm_8c.html#a1a2da1f8e6027c3088ccde6bc397b34d">vm_backtrace</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <span class="keywordtype">int</span> lev)
<a name="l00849"></a>00849 {
<a name="l00850"></a>00850     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary = 0;
<a name="l00851"></a>00851 
<a name="l00852"></a>00852     <span class="keywordflow">if</span> (lev &lt; 0) {
<a name="l00853"></a>00853         ary = <a class="code" href="../../dc/dcc/array_8c.html#a9518114fd36cb4ef4656ec1dc63348c9">rb_ary_new</a>();
<a name="l00854"></a>00854     }
<a name="l00855"></a>00855     <a class="code" href="../../de/de9/vm_8c.html#a9c233b8f4d2f77f12089fc293705ddea">vm_backtrace_each</a>(th, lev, <a class="code" href="../../de/de9/vm_8c.html#a0bfc83f8e81743a8e2267f285fc687e0">vm_backtrace_alloc</a>, <a class="code" href="../../de/de9/vm_8c.html#ac10c02440395b95b8b6fbc79d2e1e127">vm_backtrace_push</a>, &amp;ary);
<a name="l00856"></a>00856     <span class="keywordflow">if</span> (!ary) <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00857"></a>00857     <span class="keywordflow">return</span> <a class="code" href="../../dc/dcc/array_8c.html#a28b218710cccc0bf0ca8467e9bbfa60f">rb_ary_reverse</a>(ary);
<a name="l00858"></a>00858 }
<a name="l00859"></a>00859 
<a name="l00860"></a>00860 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00861"></a><a class="code" href="../../de/de9/vm_8c.html#a452b5b1b1a54238cd749112eb9e9d688">00861</a> <a class="code" href="../../d5/d9d/tcltklib_8c.html#aaa4f8c9b566fd7fb6873866c423c2016">rb_sourcefile</a>(<span class="keywordtype">void</span>)
<a name="l00862"></a>00862 {
<a name="l00863"></a>00863     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l00864"></a>00864     <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp = <a class="code" href="../../de/de9/vm_8c.html#a2709ccd7eeff81c0f749a7678223857e">rb_vm_get_ruby_level_next_cfp</a>(th, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>);
<a name="l00865"></a>00865 
<a name="l00866"></a>00866     <span class="keywordflow">if</span> (cfp) {
<a name="l00867"></a>00867         <span class="keywordflow">return</span> <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a06859fa5de56f2ede3cb692f1d9215e2">filename</a>);
<a name="l00868"></a>00868     }
<a name="l00869"></a>00869     <span class="keywordflow">else</span> {
<a name="l00870"></a>00870         <span class="keywordflow">return</span> 0;
<a name="l00871"></a>00871     }
<a name="l00872"></a>00872 }
<a name="l00873"></a>00873 
<a name="l00874"></a>00874 <span class="keywordtype">int</span>
<a name="l00875"></a><a class="code" href="../../de/de9/vm_8c.html#af5f87f9d39ea7433dc0de2f655bd6359">00875</a> <a class="code" href="../../db/d2e/intern_8h.html#af5f87f9d39ea7433dc0de2f655bd6359">rb_sourceline</a>(<span class="keywordtype">void</span>)
<a name="l00876"></a>00876 {
<a name="l00877"></a>00877     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l00878"></a>00878     <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp = <a class="code" href="../../de/de9/vm_8c.html#a2709ccd7eeff81c0f749a7678223857e">rb_vm_get_ruby_level_next_cfp</a>(th, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>);
<a name="l00879"></a>00879 
<a name="l00880"></a>00880     <span class="keywordflow">if</span> (cfp) {
<a name="l00881"></a>00881         <span class="keywordflow">return</span> <a class="code" href="../../de/de9/vm_8c.html#a70289cbb34babceed6243d9471e70e5f">rb_vm_get_sourceline</a>(cfp);
<a name="l00882"></a>00882     }
<a name="l00883"></a>00883     <span class="keywordflow">else</span> {
<a name="l00884"></a>00884         <span class="keywordflow">return</span> 0;
<a name="l00885"></a>00885     }
<a name="l00886"></a>00886 }
<a name="l00887"></a>00887 
<a name="l00888"></a>00888 NODE *
<a name="l00889"></a><a class="code" href="../../de/de9/vm_8c.html#a148afe59d50d9a0f3bde4d9968d8a2f5">00889</a> <a class="code" href="../../dd/dd0/eval__intern_8h.html#a148afe59d50d9a0f3bde4d9968d8a2f5">rb_vm_cref</a>(<span class="keywordtype">void</span>)
<a name="l00890"></a>00890 {
<a name="l00891"></a>00891     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l00892"></a>00892     <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp = <a class="code" href="../../de/de9/vm_8c.html#a2709ccd7eeff81c0f749a7678223857e">rb_vm_get_ruby_level_next_cfp</a>(th, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>);
<a name="l00893"></a>00893 
<a name="l00894"></a>00894     <span class="keywordflow">if</span> (cfp == 0) {
<a name="l00895"></a>00895         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a95ad3953d535707e2cf2b1d837f5e253">rb_eRuntimeError</a>, <span class="stringliteral">&quot;Can&apos;t call on top of Fiber or Thread&quot;</span>);
<a name="l00896"></a>00896     }
<a name="l00897"></a>00897     <span class="keywordflow">return</span> <a class="code" href="../../d0/db2/vm__insnhelper_8c.html#aa231905b7ab6df0352fe4332ff5f5deb">vm_get_cref</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>, cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a>, cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a>);
<a name="l00898"></a>00898 }
<a name="l00899"></a>00899 
<a name="l00900"></a>00900 <span class="preprocessor">#if 0</span>
<a name="l00901"></a>00901 <span class="preprocessor"></span><span class="keywordtype">void</span>
<a name="l00902"></a>00902 debug_cref(NODE *cref)
<a name="l00903"></a>00903 {
<a name="l00904"></a>00904     <span class="keywordflow">while</span> (cref) {
<a name="l00905"></a>00905         <a class="code" href="../../db/d16/debug_8h.html#a08a47aff6867e5ae146382e66d2cc26b">dp</a>(cref-&gt;nd_clss);
<a name="l00906"></a>00906         printf(<span class="stringliteral">&quot;%ld\n&quot;</span>, cref-&gt;nd_visi);
<a name="l00907"></a>00907         cref = cref-&gt;nd_next;
<a name="l00908"></a>00908     }
<a name="l00909"></a>00909 }
<a name="l00910"></a>00910 <span class="preprocessor">#endif</span>
<a name="l00911"></a>00911 <span class="preprocessor"></span>
<a name="l00912"></a>00912 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00913"></a><a class="code" href="../../de/de9/vm_8c.html#ab942ba41eb7429c6a2059edcf7403233">00913</a> <a class="code" href="../../dd/dd0/eval__intern_8h.html#ab942ba41eb7429c6a2059edcf7403233">rb_vm_cbase</a>(<span class="keywordtype">void</span>)
<a name="l00914"></a>00914 {
<a name="l00915"></a>00915     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l00916"></a>00916     <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp = <a class="code" href="../../de/de9/vm_8c.html#a2709ccd7eeff81c0f749a7678223857e">rb_vm_get_ruby_level_next_cfp</a>(th, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>);
<a name="l00917"></a>00917 
<a name="l00918"></a>00918     <span class="keywordflow">if</span> (cfp == 0) {
<a name="l00919"></a>00919         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a95ad3953d535707e2cf2b1d837f5e253">rb_eRuntimeError</a>, <span class="stringliteral">&quot;Can&apos;t call on top of Fiber or Thread&quot;</span>);
<a name="l00920"></a>00920     }
<a name="l00921"></a>00921     <span class="keywordflow">return</span> <a class="code" href="../../d0/db2/vm__insnhelper_8c.html#ac06f2b083c5e0eb199111f9d31fee829">vm_get_cbase</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>, cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a>, cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a>);
<a name="l00922"></a>00922 }
<a name="l00923"></a>00923 
<a name="l00924"></a>00924 <span class="comment">/* jump */</span>
<a name="l00925"></a>00925 
<a name="l00926"></a>00926 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00927"></a><a class="code" href="../../de/de9/vm_8c.html#aee005debbaae740dafe23261682f80d2">00927</a> <a class="code" href="../../de/de9/vm_8c.html#aee005debbaae740dafe23261682f80d2">make_localjump_error</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mesg, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> value, <span class="keywordtype">int</span> reason)
<a name="l00928"></a>00928 {
<a name="l00929"></a>00929     <span class="keyword">extern</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d3/d57/eval_8c.html#a0d9f0f9371f3273e30d146f54767da6f">rb_eLocalJumpError</a>;
<a name="l00930"></a>00930     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> exc = <a class="code" href="../../db/dcc/error_8c.html#ab629d2b031e852bf387e32c836417061">rb_exc_new2</a>(rb_eLocalJumpError, mesg);
<a name="l00931"></a>00931     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <a class="code" href="../../d6/da0/nkf-utf8_2nkf_8c.html#a64ae40793ade89d800a8c5646d2980fc">id</a>;
<a name="l00932"></a>00932 
<a name="l00933"></a>00933     <span class="keywordflow">switch</span> (reason) {
<a name="l00934"></a>00934       <span class="keywordflow">case</span> <a class="code" href="../../dd/dd0/eval__intern_8h.html#aa69d9fa25afdc01237612a6047b96189">TAG_BREAK</a>:
<a name="l00935"></a>00935         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa50b9d5bc665eb5545f6857c89232161">CONST_ID</a>(<span class="keywordtype">id</span>, <span class="stringliteral">&quot;break&quot;</span>);
<a name="l00936"></a>00936         <span class="keywordflow">break</span>;
<a name="l00937"></a>00937       <span class="keywordflow">case</span> <a class="code" href="../../dd/dd0/eval__intern_8h.html#a82e8bb282a1d35fcc453335b090bd4a7">TAG_REDO</a>:
<a name="l00938"></a>00938         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa50b9d5bc665eb5545f6857c89232161">CONST_ID</a>(<span class="keywordtype">id</span>, <span class="stringliteral">&quot;redo&quot;</span>);
<a name="l00939"></a>00939         <span class="keywordflow">break</span>;
<a name="l00940"></a>00940       <span class="keywordflow">case</span> <a class="code" href="../../dd/dd0/eval__intern_8h.html#a277f73abdf66e83f4fc75b93d6e87b72">TAG_RETRY</a>:
<a name="l00941"></a>00941         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa50b9d5bc665eb5545f6857c89232161">CONST_ID</a>(<span class="keywordtype">id</span>, <span class="stringliteral">&quot;retry&quot;</span>);
<a name="l00942"></a>00942         <span class="keywordflow">break</span>;
<a name="l00943"></a>00943       <span class="keywordflow">case</span> <a class="code" href="../../dd/dd0/eval__intern_8h.html#ac5d3e11622cde853addb87cfae24021e">TAG_NEXT</a>:
<a name="l00944"></a>00944         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa50b9d5bc665eb5545f6857c89232161">CONST_ID</a>(<span class="keywordtype">id</span>, <span class="stringliteral">&quot;next&quot;</span>);
<a name="l00945"></a>00945         <span class="keywordflow">break</span>;
<a name="l00946"></a>00946       <span class="keywordflow">case</span> <a class="code" href="../../dd/dd0/eval__intern_8h.html#abfe39758eac9658dbce9750e4bfddbc6">TAG_RETURN</a>:
<a name="l00947"></a>00947         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa50b9d5bc665eb5545f6857c89232161">CONST_ID</a>(<span class="keywordtype">id</span>, <span class="stringliteral">&quot;return&quot;</span>);
<a name="l00948"></a>00948         <span class="keywordflow">break</span>;
<a name="l00949"></a>00949       <span class="keywordflow">default</span>:
<a name="l00950"></a>00950         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa50b9d5bc665eb5545f6857c89232161">CONST_ID</a>(<span class="keywordtype">id</span>, <span class="stringliteral">&quot;noreason&quot;</span>);
<a name="l00951"></a>00951         <span class="keywordflow">break</span>;
<a name="l00952"></a>00952     }
<a name="l00953"></a>00953     <a class="code" href="../../db/d2e/intern_8h.html#a7e5b0d4c40fecb26c1ac946f674a690e">rb_iv_set</a>(exc, <span class="stringliteral">&quot;@exit_value&quot;</span>, value);
<a name="l00954"></a>00954     <a class="code" href="../../db/d2e/intern_8h.html#a7e5b0d4c40fecb26c1ac946f674a690e">rb_iv_set</a>(exc, <span class="stringliteral">&quot;@reason&quot;</span>, <a class="code" href="../../dc/d0c/cparse_8c.html#a48bfb6519a45249fb2ec0193ea3b6e1c">ID2SYM</a>(<span class="keywordtype">id</span>));
<a name="l00955"></a>00955     <span class="keywordflow">return</span> exc;
<a name="l00956"></a>00956 }
<a name="l00957"></a>00957 
<a name="l00958"></a>00958 <span class="keywordtype">void</span>
<a name="l00959"></a><a class="code" href="../../de/de9/vm_8c.html#a0402672d92f48e0018ab5f8aeda270e6">00959</a> <a class="code" href="../../de/de9/vm_8c.html#a0402672d92f48e0018ab5f8aeda270e6">rb_vm_localjump_error</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mesg, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> value, <span class="keywordtype">int</span> reason)
<a name="l00960"></a>00960 {
<a name="l00961"></a>00961     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> exc = <a class="code" href="../../de/de9/vm_8c.html#aee005debbaae740dafe23261682f80d2">make_localjump_error</a>(mesg, value, reason);
<a name="l00962"></a>00962     <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(exc);
<a name="l00963"></a>00963 }
<a name="l00964"></a>00964 
<a name="l00965"></a>00965 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l00966"></a><a class="code" href="../../de/de9/vm_8c.html#aa81384e9111765fdcf967b201efb2e6b">00966</a> <a class="code" href="../../dd/dd0/eval__intern_8h.html#aa81384e9111765fdcf967b201efb2e6b">rb_vm_make_jump_tag_but_local_jump</a>(<span class="keywordtype">int</span> <a class="code" href="../../d5/d1d/gb18030_8c.html#adc6e5733fc3c22f0a7b2914188c49c90">state</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val)
<a name="l00967"></a>00967 {
<a name="l00968"></a>00968     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d8/d90/nkf_8c.html#a5ea5ac7abf5cce39283e422add1067d5">result</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l00969"></a>00969 
<a name="l00970"></a>00970     <span class="keywordflow">if</span> (val == <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a2edf6990280eb2637623ccd421dee4f0">Qundef</a>) {
<a name="l00971"></a>00971         val = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>()-&gt;tag-&gt;retval;
<a name="l00972"></a>00972     }
<a name="l00973"></a>00973     <span class="keywordflow">switch</span> (state) {
<a name="l00974"></a>00974       <span class="keywordflow">case</span> 0:
<a name="l00975"></a>00975         <span class="keywordflow">break</span>;
<a name="l00976"></a>00976       <span class="keywordflow">case</span> <a class="code" href="../../dd/dd0/eval__intern_8h.html#abfe39758eac9658dbce9750e4bfddbc6">TAG_RETURN</a>:
<a name="l00977"></a>00977         result = <a class="code" href="../../de/de9/vm_8c.html#aee005debbaae740dafe23261682f80d2">make_localjump_error</a>(<span class="stringliteral">&quot;unexpected return&quot;</span>, val, state);
<a name="l00978"></a>00978         <span class="keywordflow">break</span>;
<a name="l00979"></a>00979       <span class="keywordflow">case</span> <a class="code" href="../../dd/dd0/eval__intern_8h.html#aa69d9fa25afdc01237612a6047b96189">TAG_BREAK</a>:
<a name="l00980"></a>00980         result = <a class="code" href="../../de/de9/vm_8c.html#aee005debbaae740dafe23261682f80d2">make_localjump_error</a>(<span class="stringliteral">&quot;unexpected break&quot;</span>, val, state);
<a name="l00981"></a>00981         <span class="keywordflow">break</span>;
<a name="l00982"></a>00982       <span class="keywordflow">case</span> <a class="code" href="../../dd/dd0/eval__intern_8h.html#ac5d3e11622cde853addb87cfae24021e">TAG_NEXT</a>:
<a name="l00983"></a>00983         result = <a class="code" href="../../de/de9/vm_8c.html#aee005debbaae740dafe23261682f80d2">make_localjump_error</a>(<span class="stringliteral">&quot;unexpected next&quot;</span>, val, state);
<a name="l00984"></a>00984         <span class="keywordflow">break</span>;
<a name="l00985"></a>00985       <span class="keywordflow">case</span> <a class="code" href="../../dd/dd0/eval__intern_8h.html#a82e8bb282a1d35fcc453335b090bd4a7">TAG_REDO</a>:
<a name="l00986"></a>00986         result = <a class="code" href="../../de/de9/vm_8c.html#aee005debbaae740dafe23261682f80d2">make_localjump_error</a>(<span class="stringliteral">&quot;unexpected redo&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>, state);
<a name="l00987"></a>00987         <span class="keywordflow">break</span>;
<a name="l00988"></a>00988       <span class="keywordflow">case</span> <a class="code" href="../../dd/dd0/eval__intern_8h.html#a277f73abdf66e83f4fc75b93d6e87b72">TAG_RETRY</a>:
<a name="l00989"></a>00989         result = <a class="code" href="../../de/de9/vm_8c.html#aee005debbaae740dafe23261682f80d2">make_localjump_error</a>(<span class="stringliteral">&quot;retry outside of rescue clause&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>, state);
<a name="l00990"></a>00990         <span class="keywordflow">break</span>;
<a name="l00991"></a>00991       <span class="keywordflow">default</span>:
<a name="l00992"></a>00992         <span class="keywordflow">break</span>;
<a name="l00993"></a>00993     }
<a name="l00994"></a>00994     <span class="keywordflow">return</span> result;
<a name="l00995"></a>00995 }
<a name="l00996"></a>00996 
<a name="l00997"></a>00997 <span class="keywordtype">void</span>
<a name="l00998"></a><a class="code" href="../../de/de9/vm_8c.html#a976657030590c458cdb538951138a823">00998</a> <a class="code" href="../../de/de9/vm_8c.html#a976657030590c458cdb538951138a823">rb_vm_jump_tag_but_local_jump</a>(<span class="keywordtype">int</span> <a class="code" href="../../d5/d1d/gb18030_8c.html#adc6e5733fc3c22f0a7b2914188c49c90">state</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val)
<a name="l00999"></a>00999 {
<a name="l01000"></a>01000     <span class="keywordflow">if</span> (val != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>) {
<a name="l01001"></a>01001         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> exc = <a class="code" href="../../dd/dd0/eval__intern_8h.html#aa81384e9111765fdcf967b201efb2e6b">rb_vm_make_jump_tag_but_local_jump</a>(state, val);
<a name="l01002"></a>01002         <span class="keywordflow">if</span> (!<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(exc)) <a class="code" href="../../d3/d57/eval_8c.html#a237939d28c83950b84fb6a45ccca53a0">rb_exc_raise</a>(exc);
<a name="l01003"></a>01003     }
<a name="l01004"></a>01004     <a class="code" href="../../dd/dd0/eval__intern_8h.html#a24884166ae699029ade34fd36bedd688">JUMP_TAG</a>(state);
<a name="l01005"></a>01005 }
<a name="l01006"></a>01006 
<a name="l01007"></a>01007 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a7a711d5127a34da8c3ed48f401579289">NORETURN</a>(<span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="../../de/de9/vm_8c.html#a558682fa4d3466e2877e03310d2d98d9">vm_iter_break</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th));
<a name="l01008"></a>01008 
<a name="l01009"></a>01009 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01010"></a><a class="code" href="../../de/de9/vm_8c.html#a558682fa4d3466e2877e03310d2d98d9">01010</a> <a class="code" href="../../de/de9/vm_8c.html#a558682fa4d3466e2877e03310d2d98d9">vm_iter_break</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l01011"></a>01011 {
<a name="l01012"></a>01012     <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>;
<a name="l01013"></a>01013     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *dfp = <a class="code" href="../../d8/d32/vm__core_8h.html#a373f1cafd944ff9e99986582d0fd695b">GC_GUARDED_PTR_REF</a>(*cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a>);
<a name="l01014"></a>01014 
<a name="l01015"></a>01015     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a25bbafcd0a1e0f6f79b42cc29baf3eb8">state</a> = <a class="code" href="../../dd/dd0/eval__intern_8h.html#aa69d9fa25afdc01237612a6047b96189">TAG_BREAK</a>;
<a name="l01016"></a>01016     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a173e2da61fa57c7044fd7874a8c7a924">errinfo</a> = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)<a class="code" href="../../dd/dd0/eval__intern_8h.html#a73e5172525e734da0d617c532cef0c6d">NEW_THROW_OBJECT</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)dfp, <a class="code" href="../../dd/dd0/eval__intern_8h.html#aa69d9fa25afdc01237612a6047b96189">TAG_BREAK</a>);
<a name="l01017"></a>01017     <a class="code" href="../../dd/dd0/eval__intern_8h.html#a94d7b62a0538b4dc8a1d0c7c1308bfe7">TH_JUMP_TAG</a>(th, <a class="code" href="../../dd/dd0/eval__intern_8h.html#aa69d9fa25afdc01237612a6047b96189">TAG_BREAK</a>);
<a name="l01018"></a>01018 }
<a name="l01019"></a>01019 
<a name="l01020"></a>01020 <span class="keywordtype">void</span>
<a name="l01021"></a><a class="code" href="../../de/de9/vm_8c.html#a2d68db6481cad1995cbdb77a8ddd5291">01021</a> <a class="code" href="../../de/de9/vm_8c.html#a2d68db6481cad1995cbdb77a8ddd5291">rb_iter_break</a>(<span class="keywordtype">void</span>)
<a name="l01022"></a>01022 {
<a name="l01023"></a>01023     <a class="code" href="../../de/de9/vm_8c.html#a558682fa4d3466e2877e03310d2d98d9">vm_iter_break</a>(<a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>());
<a name="l01024"></a>01024 }
<a name="l01025"></a>01025 
<a name="l01026"></a>01026 <span class="comment">/* optimization: redefine management */</span>
<a name="l01027"></a>01027 
<a name="l01028"></a><a class="code" href="../../de/de9/vm_8c.html#ac6493695633068f17f9c245d529698d9">01028</a> <span class="keyword">static</span> <a class="code" href="../../d0/ddd/structst__table.html">st_table</a> *<a class="code" href="../../de/de9/vm_8c.html#ac6493695633068f17f9c245d529698d9">vm_opt_method_table</a> = 0;
<a name="l01029"></a>01029 
<a name="l01030"></a>01030 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01031"></a><a class="code" href="../../de/de9/vm_8c.html#a810304f38337326e623456a52492584f">01031</a> <a class="code" href="../../de/de9/vm_8c.html#a810304f38337326e623456a52492584f">rb_vm_check_redefinition_opt_method</a>(<span class="keyword">const</span> <a class="code" href="../../d7/db7/structrb__method__entry__struct.html">rb_method_entry_t</a> *me)
<a name="l01032"></a>01032 {
<a name="l01033"></a>01033     <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> bop;
<a name="l01034"></a>01034     <span class="keywordflow">if</span> (!me-&gt;<a class="code" href="../../d7/db7/structrb__method__entry__struct.html#a6c868c50e67b757c6324dfef0f3184dc">def</a> || me-&gt;<a class="code" href="../../d7/db7/structrb__method__entry__struct.html#a6c868c50e67b757c6324dfef0f3184dc">def</a>-&gt;<a class="code" href="../../d6/dab/structrb__method__definition__struct.html#a60ad63aa9037403df6e773853973c41b">type</a> == <a class="code" href="../../db/d0a/method_8h.html#a88a981f6cc69187ed9c2de2630a1687aa1691810af54507b018d2639b60e8057d">VM_METHOD_TYPE_CFUNC</a>) {
<a name="l01035"></a>01035         <span class="keywordflow">if</span> (<a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(vm_opt_method_table, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)me, &amp;bop)) {
<a name="l01036"></a>01036             <a class="code" href="../../de/de9/vm_8c.html#ae7ebc888013290c4c514a63794167a87">ruby_vm_redefined_flag</a>[bop] = 1;
<a name="l01037"></a>01037         }
<a name="l01038"></a>01038     }
<a name="l01039"></a>01039 }
<a name="l01040"></a>01040 
<a name="l01041"></a>01041 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01042"></a><a class="code" href="../../de/de9/vm_8c.html#a19074acfc80b03239ef6b07b13a4b460">01042</a> <a class="code" href="../../de/de9/vm_8c.html#a19074acfc80b03239ef6b07b13a4b460">add_opt_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> mid, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> bop)
<a name="l01043"></a>01043 {
<a name="l01044"></a>01044     <a class="code" href="../../d7/db7/structrb__method__entry__struct.html">rb_method_entry_t</a> *me;
<a name="l01045"></a>01045     <span class="keywordflow">if</span> (<a class="code" href="../../dd/d24/st_8h.html#a2d85287fbdaf7dcbc22d45e925c29fea">st_lookup</a>(<a class="code" href="../../d3/d09/ripper_8y.html#ab59ea80cdf15f3f19bbae0346314c9ad">RCLASS_M_TBL</a>(klass), mid, (<span class="keywordtype">void</span> *)&amp;me) &amp;&amp; me-&gt;def &amp;&amp;
<a name="l01046"></a>01046         me-&gt;def-&gt;type == <a class="code" href="../../db/d0a/method_8h.html#a88a981f6cc69187ed9c2de2630a1687aa1691810af54507b018d2639b60e8057d">VM_METHOD_TYPE_CFUNC</a>) {
<a name="l01047"></a>01047         <a class="code" href="../../dd/d24/st_8h.html#acdc42c01229b7537ea5a4c6965c7e47a">st_insert</a>(vm_opt_method_table, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)me, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>)bop);
<a name="l01048"></a>01048     }
<a name="l01049"></a>01049     <span class="keywordflow">else</span> {
<a name="l01050"></a>01050         <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;undefined optimized method: %s&quot;</span>, <a class="code" href="../../d5/d11/ripper_8c.html#a877bc58c495643fcf49dc64c44631e72">rb_id2name</a>(mid));
<a name="l01051"></a>01051     }
<a name="l01052"></a>01052 }
<a name="l01053"></a>01053 
<a name="l01054"></a>01054 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01055"></a><a class="code" href="../../de/de9/vm_8c.html#a891ada54116b1442538ca6fc0e2861b1">01055</a> <a class="code" href="../../de/de9/vm_8c.html#a891ada54116b1442538ca6fc0e2861b1">vm_init_redefined_flag</a>(<span class="keywordtype">void</span>)
<a name="l01056"></a>01056 {
<a name="l01057"></a>01057     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> mid;
<a name="l01058"></a>01058     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> bop;
<a name="l01059"></a>01059 
<a name="l01060"></a>01060     vm_opt_method_table = <a class="code" href="../../dd/d24/st_8h.html#a955c6e936b9681649ab9ffa4aa741949">st_init_numtable</a>();
<a name="l01061"></a>01061 
<a name="l01062"></a>01062 <span class="preprocessor">#define OP(mid_, bop_) (mid = id##mid_, bop = BOP_##bop_, ruby_vm_redefined_flag[bop] = 0)</span>
<a name="l01063"></a>01063 <span class="preprocessor"></span><span class="preprocessor">#define C(k) add_opt_method(rb_c##k, mid, bop)</span>
<a name="l01064"></a>01064 <span class="preprocessor"></span>    <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(PLUS, PLUS), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Fixnum), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Float), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(String), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Array));
<a name="l01065"></a>01065     <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(MINUS, MINUS), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Fixnum));
<a name="l01066"></a>01066     <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(MULT, MULT), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Fixnum), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Float));
<a name="l01067"></a>01067     <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(<a class="code" href="../../dd/dc0/date__core_8c.html#a49becf5019eb7d2fa43fea31b977b203">DIV</a>, <a class="code" href="../../dd/dc0/date__core_8c.html#a49becf5019eb7d2fa43fea31b977b203">DIV</a>), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Fixnum), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Float));
<a name="l01068"></a>01068     <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(<a class="code" href="../../dd/dc0/date__core_8c.html#aedafc0dc710c634ecec3900b66547a36">MOD</a>, <a class="code" href="../../dd/dc0/date__core_8c.html#aedafc0dc710c634ecec3900b66547a36">MOD</a>), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Fixnum), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Float));
<a name="l01069"></a>01069     <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(Eq, EQ), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Fixnum), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Float), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(String));
<a name="l01070"></a>01070     <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(Eqq, EQQ), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Fixnum), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Bignum), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Float), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Symbol), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(String));
<a name="l01071"></a>01071     <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(LT, LT), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Fixnum));
<a name="l01072"></a>01072     <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(<a class="code" href="../../d5/d2d/utf__16__32_8c.html#aa4d6abc7b58eb11e517993df83b7f0f7">LE</a>, <a class="code" href="../../d5/d2d/utf__16__32_8c.html#aa4d6abc7b58eb11e517993df83b7f0f7">LE</a>), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Fixnum));
<a name="l01073"></a>01073     <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(LTLT, LTLT), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(String), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Array));
<a name="l01074"></a>01074     <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(<a class="code" href="../../dc/d0c/cparse_8c.html#a2c5302305d878024276c413652549eb9">AREF</a>, <a class="code" href="../../dc/d0c/cparse_8c.html#a2c5302305d878024276c413652549eb9">AREF</a>), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Array), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Hash));
<a name="l01075"></a>01075     <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(ASET, ASET), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Array), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Hash));
<a name="l01076"></a>01076     <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(Length, LENGTH), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Array), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(String), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Hash));
<a name="l01077"></a>01077     <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(Size, SIZE), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Array), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(String), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Hash));
<a name="l01078"></a>01078     <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(Succ, SUCC), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Fixnum), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(String), <a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Time));
<a name="l01079"></a>01079     <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(GT, GT), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Fixnum));
<a name="l01080"></a>01080     <a class="code" href="../../de/de9/vm_8c.html#a73a24c093ebc1906a9831819833fc1f7">OP</a>(GE, GE), (<a class="code" href="../../de/df1/util_8c.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a>(Fixnum));
<a name="l01081"></a>01081 <span class="preprocessor">#undef C</span>
<a name="l01082"></a>01082 <span class="preprocessor"></span><span class="preprocessor">#undef OP</span>
<a name="l01083"></a>01083 <span class="preprocessor"></span>}
<a name="l01084"></a>01084 
<a name="l01085"></a>01085 <span class="comment">/* for vm development */</span>
<a name="l01086"></a>01086 
<a name="l01087"></a>01087 <span class="preprocessor">#if VMDEBUG</span>
<a name="l01088"></a>01088 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l01089"></a>01089 vm_frametype_name(<span class="keyword">const</span> <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp)
<a name="l01090"></a>01090 {
<a name="l01091"></a>01091     <span class="keywordflow">switch</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(cfp)) {
<a name="l01092"></a>01092       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#abc8be29d36c6252fce6bc61621f81b71">VM_FRAME_MAGIC_METHOD</a>: <span class="keywordflow">return</span> <span class="stringliteral">&quot;method&quot;</span>;
<a name="l01093"></a>01093       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#a83eeedff3dde6d2d1ffce5d84c2ba2f1">VM_FRAME_MAGIC_BLOCK</a>:  <span class="keywordflow">return</span> <span class="stringliteral">&quot;block&quot;</span>;
<a name="l01094"></a>01094       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#a2524f590c07fceb689b2b7d53114ff5f">VM_FRAME_MAGIC_CLASS</a>:  <span class="keywordflow">return</span> <span class="stringliteral">&quot;class&quot;</span>;
<a name="l01095"></a>01095       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#ac9390ef02c17a0bc7e3bd359264562c7">VM_FRAME_MAGIC_TOP</a>:    <span class="keywordflow">return</span> <span class="stringliteral">&quot;top&quot;</span>;
<a name="l01096"></a>01096       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#a885c6468caef6c3de80b0ad6c50ae38d">VM_FRAME_MAGIC_FINISH</a>: <span class="keywordflow">return</span> <span class="stringliteral">&quot;finish&quot;</span>;
<a name="l01097"></a>01097       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#a26308f33317bb5b96ff89924822e8eab">VM_FRAME_MAGIC_CFUNC</a>:  <span class="keywordflow">return</span> <span class="stringliteral">&quot;cfunc&quot;</span>;
<a name="l01098"></a>01098       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#ac1f5b7efa57bccbeb4ff5e7ae6ff18c2">VM_FRAME_MAGIC_PROC</a>:   <span class="keywordflow">return</span> <span class="stringliteral">&quot;proc&quot;</span>;
<a name="l01099"></a>01099       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#a795522d157a66fe8f0cdd335b28099c9">VM_FRAME_MAGIC_IFUNC</a>:  <span class="keywordflow">return</span> <span class="stringliteral">&quot;ifunc&quot;</span>;
<a name="l01100"></a>01100       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#ac7b8d797cce488d08572c273f49f28fe">VM_FRAME_MAGIC_EVAL</a>:   <span class="keywordflow">return</span> <span class="stringliteral">&quot;eval&quot;</span>;
<a name="l01101"></a>01101       <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#a57840803108748406429fb1cb3b10530">VM_FRAME_MAGIC_LAMBDA</a>: <span class="keywordflow">return</span> <span class="stringliteral">&quot;lambda&quot;</span>;
<a name="l01102"></a>01102       <span class="keywordflow">default</span>:
<a name="l01103"></a>01103         <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;unknown frame&quot;</span>);
<a name="l01104"></a>01104     }
<a name="l01105"></a>01105 }
<a name="l01106"></a>01106 <span class="preprocessor">#endif</span>
<a name="l01107"></a>01107 <span class="preprocessor"></span>
<a name="l01108"></a>01108 <span class="comment">/* evaluator body */</span>
<a name="l01109"></a>01109 
<a name="l01110"></a>01110 <span class="comment">/*                  finish</span>
<a name="l01111"></a>01111 <span class="comment">  VMe (h1)          finish</span>
<a name="l01112"></a>01112 <span class="comment">    VM              finish F1 F2</span>
<a name="l01113"></a>01113 <span class="comment">      cfunc         finish F1 F2 C1</span>
<a name="l01114"></a>01114 <span class="comment">        rb_funcall  finish F1 F2 C1</span>
<a name="l01115"></a>01115 <span class="comment">          VMe       finish F1 F2 C1</span>
<a name="l01116"></a>01116 <span class="comment">            VM      finish F1 F2 C1 F3</span>
<a name="l01117"></a>01117 <span class="comment"></span>
<a name="l01118"></a>01118 <span class="comment">  F1 - F3 : pushed by VM</span>
<a name="l01119"></a>01119 <span class="comment">  C1      : pushed by send insn (CFUNC)</span>
<a name="l01120"></a>01120 <span class="comment"></span>
<a name="l01121"></a>01121 <span class="comment">  struct CONTROL_FRAME {</span>
<a name="l01122"></a>01122 <span class="comment">    VALUE *pc;                  // cfp[0], program counter</span>
<a name="l01123"></a>01123 <span class="comment">    VALUE *sp;                  // cfp[1], stack pointer</span>
<a name="l01124"></a>01124 <span class="comment">    VALUE *bp;                  // cfp[2], base pointer</span>
<a name="l01125"></a>01125 <span class="comment">    rb_iseq_t *iseq;            // cfp[3], iseq</span>
<a name="l01126"></a>01126 <span class="comment">    VALUE flag;                 // cfp[4], magic</span>
<a name="l01127"></a>01127 <span class="comment">    VALUE self;                 // cfp[5], self</span>
<a name="l01128"></a>01128 <span class="comment">    VALUE *lfp;                 // cfp[6], local frame pointer</span>
<a name="l01129"></a>01129 <span class="comment">    VALUE *dfp;                 // cfp[7], dynamic frame pointer</span>
<a name="l01130"></a>01130 <span class="comment">    rb_iseq_t * block_iseq;     // cfp[8], block iseq</span>
<a name="l01131"></a>01131 <span class="comment">    VALUE proc;                 // cfp[9], always 0</span>
<a name="l01132"></a>01132 <span class="comment">  };</span>
<a name="l01133"></a>01133 <span class="comment"></span>
<a name="l01134"></a>01134 <span class="comment">  struct BLOCK {</span>
<a name="l01135"></a>01135 <span class="comment">    VALUE self;</span>
<a name="l01136"></a>01136 <span class="comment">    VALUE *lfp;</span>
<a name="l01137"></a>01137 <span class="comment">    VALUE *dfp;</span>
<a name="l01138"></a>01138 <span class="comment">    rb_iseq_t *block_iseq;</span>
<a name="l01139"></a>01139 <span class="comment">    VALUE proc;</span>
<a name="l01140"></a>01140 <span class="comment">  };</span>
<a name="l01141"></a>01141 <span class="comment"></span>
<a name="l01142"></a>01142 <span class="comment">  struct METHOD_CONTROL_FRAME {</span>
<a name="l01143"></a>01143 <span class="comment">    rb_control_frame_t frame;</span>
<a name="l01144"></a>01144 <span class="comment">  };</span>
<a name="l01145"></a>01145 <span class="comment"></span>
<a name="l01146"></a>01146 <span class="comment">  struct METHOD_FRAME {</span>
<a name="l01147"></a>01147 <span class="comment">    VALUE arg0;</span>
<a name="l01148"></a>01148 <span class="comment">    ...</span>
<a name="l01149"></a>01149 <span class="comment">    VALUE argM;</span>
<a name="l01150"></a>01150 <span class="comment">    VALUE param0;</span>
<a name="l01151"></a>01151 <span class="comment">    ...</span>
<a name="l01152"></a>01152 <span class="comment">    VALUE paramN;</span>
<a name="l01153"></a>01153 <span class="comment">    VALUE cref;</span>
<a name="l01154"></a>01154 <span class="comment">    VALUE special;                         // lfp [1]</span>
<a name="l01155"></a>01155 <span class="comment">    struct block_object *block_ptr | 0x01; // lfp [0]</span>
<a name="l01156"></a>01156 <span class="comment">  };</span>
<a name="l01157"></a>01157 <span class="comment"></span>
<a name="l01158"></a>01158 <span class="comment">  struct BLOCK_CONTROL_FRAME {</span>
<a name="l01159"></a>01159 <span class="comment">    rb_control_frame_t frame;</span>
<a name="l01160"></a>01160 <span class="comment">  };</span>
<a name="l01161"></a>01161 <span class="comment"></span>
<a name="l01162"></a>01162 <span class="comment">  struct BLOCK_FRAME {</span>
<a name="l01163"></a>01163 <span class="comment">    VALUE arg0;</span>
<a name="l01164"></a>01164 <span class="comment">    ...</span>
<a name="l01165"></a>01165 <span class="comment">    VALUE argM;</span>
<a name="l01166"></a>01166 <span class="comment">    VALUE param0;</span>
<a name="l01167"></a>01167 <span class="comment">    ...</span>
<a name="l01168"></a>01168 <span class="comment">    VALUE paramN;</span>
<a name="l01169"></a>01169 <span class="comment">    VALUE cref;</span>
<a name="l01170"></a>01170 <span class="comment">    VALUE *(prev_ptr | 0x01); // DFP[0]</span>
<a name="l01171"></a>01171 <span class="comment">  };</span>
<a name="l01172"></a>01172 <span class="comment"></span>
<a name="l01173"></a>01173 <span class="comment">  struct CLASS_CONTROL_FRAME {</span>
<a name="l01174"></a>01174 <span class="comment">    rb_control_frame_t frame;</span>
<a name="l01175"></a>01175 <span class="comment">  };</span>
<a name="l01176"></a>01176 <span class="comment"></span>
<a name="l01177"></a>01177 <span class="comment">  struct CLASS_FRAME {</span>
<a name="l01178"></a>01178 <span class="comment">    VALUE param0;</span>
<a name="l01179"></a>01179 <span class="comment">    ...</span>
<a name="l01180"></a>01180 <span class="comment">    VALUE paramN;</span>
<a name="l01181"></a>01181 <span class="comment">    VALUE cref;</span>
<a name="l01182"></a>01182 <span class="comment">    VALUE prev_dfp; // for frame jump</span>
<a name="l01183"></a>01183 <span class="comment">  };</span>
<a name="l01184"></a>01184 <span class="comment"></span>
<a name="l01185"></a>01185 <span class="comment">  struct C_METHOD_CONTROL_FRAME {</span>
<a name="l01186"></a>01186 <span class="comment">    VALUE *pc;                       // 0</span>
<a name="l01187"></a>01187 <span class="comment">    VALUE *sp;                       // stack pointer</span>
<a name="l01188"></a>01188 <span class="comment">    VALUE *bp;                       // base pointer (used in exception)</span>
<a name="l01189"></a>01189 <span class="comment">    rb_iseq_t *iseq;               // cmi</span>
<a name="l01190"></a>01190 <span class="comment">    VALUE magic;                     // C_METHOD_FRAME</span>
<a name="l01191"></a>01191 <span class="comment">    VALUE self;                      // ?</span>
<a name="l01192"></a>01192 <span class="comment">    VALUE *lfp;                      // lfp</span>
<a name="l01193"></a>01193 <span class="comment">    VALUE *dfp;                      // == lfp</span>
<a name="l01194"></a>01194 <span class="comment">    rb_iseq_t * block_iseq;        //</span>
<a name="l01195"></a>01195 <span class="comment">    VALUE proc;                      // always 0</span>
<a name="l01196"></a>01196 <span class="comment">  };</span>
<a name="l01197"></a>01197 <span class="comment"></span>
<a name="l01198"></a>01198 <span class="comment">  struct C_BLOCK_CONTROL_FRAME {</span>
<a name="l01199"></a>01199 <span class="comment">    VALUE *pc;                       // point only &quot;finish&quot; insn</span>
<a name="l01200"></a>01200 <span class="comment">    VALUE *sp;                       // sp</span>
<a name="l01201"></a>01201 <span class="comment">    rb_iseq_t *iseq;               // ?</span>
<a name="l01202"></a>01202 <span class="comment">    VALUE magic;                     // C_METHOD_FRAME</span>
<a name="l01203"></a>01203 <span class="comment">    VALUE self;                      // needed?</span>
<a name="l01204"></a>01204 <span class="comment">    VALUE *lfp;                      // lfp</span>
<a name="l01205"></a>01205 <span class="comment">    VALUE *dfp;                      // lfp</span>
<a name="l01206"></a>01206 <span class="comment">    rb_iseq_t * block_iseq; // 0</span>
<a name="l01207"></a>01207 <span class="comment">  };</span>
<a name="l01208"></a>01208 <span class="comment"> */</span>
<a name="l01209"></a>01209 
<a name="l01210"></a>01210 
<a name="l01211"></a>01211 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01212"></a><a class="code" href="../../de/de9/vm_8c.html#a6fca4e13002f037d2e15bc1c77ab18ed">01212</a> <a class="code" href="../../de/de9/vm_8c.html#a6fca4e13002f037d2e15bc1c77ab18ed">vm_exec</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l01213"></a>01213 {
<a name="l01214"></a>01214     <span class="keywordtype">int</span> <a class="code" href="../../d5/d1d/gb18030_8c.html#adc6e5733fc3c22f0a7b2914188c49c90">state</a>;
<a name="l01215"></a>01215     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d8/d90/nkf_8c.html#a5ea5ac7abf5cce39283e422add1067d5">result</a>, <a class="code" href="../../d5/df2/win32_8c.html#a6ce68847c12434f60d1b2654a3dc3409">err</a>;
<a name="l01216"></a>01216     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> initial = 0;
<a name="l01217"></a>01217     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *escape_dfp = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01218"></a>01218 
<a name="l01219"></a>01219     <a class="code" href="../../dd/dd0/eval__intern_8h.html#a4410e4208d7ae0de8dae7c5b61f9d55c">TH_PUSH_TAG</a>(th);
<a name="l01220"></a>01220     _tag.retval = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01221"></a>01221     <span class="keywordflow">if</span> ((state = <a class="code" href="../../dd/dd0/eval__intern_8h.html#a3441e3967c633da99c3dcd025494053e">EXEC_TAG</a>()) == 0) {
<a name="l01222"></a>01222       vm_loop_start:
<a name="l01223"></a>01223         result = <a class="code" href="../../df/d38/vm__exec_8c.html#a5f6167faed281f68dfb092bc052afacf">vm_exec_core</a>(th, initial);
<a name="l01224"></a>01224         <span class="keywordflow">if</span> ((state = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a25bbafcd0a1e0f6f79b42cc29baf3eb8">state</a>) != 0) {
<a name="l01225"></a>01225             err = result;
<a name="l01226"></a>01226             th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a25bbafcd0a1e0f6f79b42cc29baf3eb8">state</a> = 0;
<a name="l01227"></a>01227             <span class="keywordflow">goto</span> exception_handler;
<a name="l01228"></a>01228         }
<a name="l01229"></a>01229     }
<a name="l01230"></a>01230     <span class="keywordflow">else</span> {
<a name="l01231"></a>01231         <span class="keywordtype">int</span> i;
<a name="l01232"></a>01232         <span class="keyword">struct </span><a class="code" href="../../dc/d07/structiseq__catch__table__entry.html">iseq_catch_table_entry</a> *entry;
<a name="l01233"></a>01233         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> epc, cont_pc, cont_sp;
<a name="l01234"></a>01234         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> catch_iseqval;
<a name="l01235"></a>01235         <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp;
<a name="l01236"></a>01236         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../d5/d9d/tcltklib_8c.html#ac765329451135abec74c45e1897abf26">type</a>;
<a name="l01237"></a>01237 
<a name="l01238"></a>01238         err = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a173e2da61fa57c7044fd7874a8c7a924">errinfo</a>;
<a name="l01239"></a>01239 
<a name="l01240"></a>01240       exception_handler:
<a name="l01241"></a>01241         cont_pc = cont_sp = catch_iseqval = 0;
<a name="l01242"></a>01242 
<a name="l01243"></a>01243         <span class="keywordflow">while</span> (th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a28b0b301811a891225ba9a58c412482d">pc</a> == 0 || th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a> == 0) {
<a name="l01244"></a>01244             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#ab10d0a221f4d7a706701b806c8135fd7">UNLIKELY</a>(<a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>) == <a class="code" href="../../d8/d32/vm__core_8h.html#a26308f33317bb5b96ff89924822e8eab">VM_FRAME_MAGIC_CFUNC</a>)) {
<a name="l01245"></a>01245                 <span class="keyword">const</span> <a class="code" href="../../d7/db7/structrb__method__entry__struct.html">rb_method_entry_t</a> *me = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aa0ec76f80ebaf0668b688c4e4e5e3e3f">me</a>;
<a name="l01246"></a>01246                 <a class="code" href="../../d8/d32/vm__core_8h.html#a724eed84e4b041ec1867e198ee129192">EXEC_EVENT_HOOK</a>(th, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa8f8ed837ea1ef257ef6575f6785ca34">RUBY_EVENT_C_RETURN</a>, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4c11a50358317e1207affd6d7b4ad576">self</a>, me-&gt;<a class="code" href="../../d7/db7/structrb__method__entry__struct.html#a31439bd620e98940410ba59244a85eae">called_id</a>, me-&gt;<a class="code" href="../../d7/db7/structrb__method__entry__struct.html#a9ce0871480ac405b00673b25234738de">klass</a>);
<a name="l01247"></a>01247             }
<a name="l01248"></a>01248             th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a> = <a class="code" href="../../d8/d32/vm__core_8h.html#af087c881c3c493e3a4e326852e8ed2a9">RUBY_VM_PREVIOUS_CONTROL_FRAME</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>);
<a name="l01249"></a>01249         }
<a name="l01250"></a>01250 
<a name="l01251"></a>01251         cfp = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>;
<a name="l01252"></a>01252         epc = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a28b0b301811a891225ba9a58c412482d">pc</a> - cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aa70f3e195a4350acbbc130f8a95c9958">iseq_encoded</a>;
<a name="l01253"></a>01253 
<a name="l01254"></a>01254         <span class="keywordflow">if</span> (state == <a class="code" href="../../dd/dd0/eval__intern_8h.html#aa69d9fa25afdc01237612a6047b96189">TAG_BREAK</a> || state == <a class="code" href="../../dd/dd0/eval__intern_8h.html#abfe39758eac9658dbce9750e4bfddbc6">TAG_RETURN</a>) {
<a name="l01255"></a>01255             escape_dfp = <a class="code" href="../../dd/dd0/eval__intern_8h.html#aeeda78ded67b3dc359c8911e679f0f15">GET_THROWOBJ_CATCH_POINT</a>(err);
<a name="l01256"></a>01256 
<a name="l01257"></a>01257             <span class="keywordflow">if</span> (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a> == escape_dfp) {
<a name="l01258"></a>01258                 <span class="keywordflow">if</span> (state == <a class="code" href="../../dd/dd0/eval__intern_8h.html#abfe39758eac9658dbce9750e4bfddbc6">TAG_RETURN</a>) {
<a name="l01259"></a>01259                     <span class="keywordflow">if</span> ((cfp + 1)-&gt;pc != &amp;<a class="code" href="../../df/d38/vm__exec_8c.html#a6f84f6d4b822e9b021a1e64cacf21847">finish_insn_seq</a>[0]) {
<a name="l01260"></a>01260                         <a class="code" href="../../dd/dd0/eval__intern_8h.html#aa893e1d4238c9135f318ddaff6b1c679">SET_THROWOBJ_CATCH_POINT</a>(err, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)(cfp + 1)-&gt;dfp);
<a name="l01261"></a>01261                         <a class="code" href="../../dd/dd0/eval__intern_8h.html#a017f76c5f9b6ec0ceac2244ac80ab5cf">SET_THROWOBJ_STATE</a>(err, state = <a class="code" href="../../dd/dd0/eval__intern_8h.html#aa69d9fa25afdc01237612a6047b96189">TAG_BREAK</a>);
<a name="l01262"></a>01262                     }
<a name="l01263"></a>01263                     <span class="keywordflow">else</span> {
<a name="l01264"></a>01264                         <span class="keywordflow">for</span> (i = 0; i &lt; cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#ae1d2b9b5e2ae668e100d814f2da38ac0">catch_table_size</a>; i++) {
<a name="l01265"></a>01265                             entry = &amp;cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aaf3c6629a41865ab662884b7481fb394">catch_table</a>[i];
<a name="l01266"></a>01266                             <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a9427499a8613b4046de7b20d3153c5ab">start</a> &lt; epc &amp;&amp; entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#af2d9fb3c5142c7e037d1405e0b7c59ae">end</a> &gt;= epc) {
<a name="l01267"></a>01267                                 <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#ac2b2471bbfb0ada41e777d8e1919ba00">type</a> == <a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a1c2635a230708dfba8857a6d6509b6a1af40d37f8dee0a7d299cf107101dd588b">CATCH_TYPE_ENSURE</a>) {
<a name="l01268"></a>01268                                     catch_iseqval = entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a919aa1dbe534777ff38a07a17b956524">iseq</a>;
<a name="l01269"></a>01269                                     cont_pc = entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a948846a98f14e75301964e17a95afcea">cont</a>;
<a name="l01270"></a>01270                                     cont_sp = entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a0b7ff23536c8be69a62188be1a84c1d5">sp</a>;
<a name="l01271"></a>01271                                     <span class="keywordflow">break</span>;
<a name="l01272"></a>01272                                 }
<a name="l01273"></a>01273                             }
<a name="l01274"></a>01274                         }
<a name="l01275"></a>01275                         <span class="keywordflow">if</span> (!catch_iseqval) {
<a name="l01276"></a>01276                             result = <a class="code" href="../../dd/dd0/eval__intern_8h.html#a3cc03eefb2b828e688368c647698e1b7">GET_THROWOBJ_VAL</a>(err);
<a name="l01277"></a>01277                             th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a173e2da61fa57c7044fd7874a8c7a924">errinfo</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01278"></a>01278                             th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a> += 2;
<a name="l01279"></a>01279                             <span class="keywordflow">goto</span> finish_vme;
<a name="l01280"></a>01280                         }
<a name="l01281"></a>01281                     }
<a name="l01282"></a>01282                     <span class="comment">/* through */</span>
<a name="l01283"></a>01283                 }
<a name="l01284"></a>01284                 <span class="keywordflow">else</span> {
<a name="l01285"></a>01285                     <span class="comment">/* TAG_BREAK */</span>
<a name="l01286"></a>01286 <span class="preprocessor">#if OPT_STACK_CACHING</span>
<a name="l01287"></a>01287 <span class="preprocessor"></span>                    initial = (<a class="code" href="../../dd/dd0/eval__intern_8h.html#a3cc03eefb2b828e688368c647698e1b7">GET_THROWOBJ_VAL</a>(err));
<a name="l01288"></a>01288 <span class="preprocessor">#else</span>
<a name="l01289"></a>01289 <span class="preprocessor"></span>                    *th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a>++ = (<a class="code" href="../../dd/dd0/eval__intern_8h.html#a3cc03eefb2b828e688368c647698e1b7">GET_THROWOBJ_VAL</a>(err));
<a name="l01290"></a>01290 <span class="preprocessor">#endif</span>
<a name="l01291"></a>01291 <span class="preprocessor"></span>                    th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a173e2da61fa57c7044fd7874a8c7a924">errinfo</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01292"></a>01292                     <span class="keywordflow">goto</span> vm_loop_start;
<a name="l01293"></a>01293                 }
<a name="l01294"></a>01294             }
<a name="l01295"></a>01295         }
<a name="l01296"></a>01296 
<a name="l01297"></a>01297         <span class="keywordflow">if</span> (state == <a class="code" href="../../dd/dd0/eval__intern_8h.html#a0b034bce069147e233776bc1dcc74c01">TAG_RAISE</a>) {
<a name="l01298"></a>01298             <span class="keywordflow">for</span> (i = 0; i &lt; cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#ae1d2b9b5e2ae668e100d814f2da38ac0">catch_table_size</a>; i++) {
<a name="l01299"></a>01299                 entry = &amp;cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aaf3c6629a41865ab662884b7481fb394">catch_table</a>[i];
<a name="l01300"></a>01300                 <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a9427499a8613b4046de7b20d3153c5ab">start</a> &lt; epc &amp;&amp; entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#af2d9fb3c5142c7e037d1405e0b7c59ae">end</a> &gt;= epc) {
<a name="l01301"></a>01301 
<a name="l01302"></a>01302                     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#ac2b2471bbfb0ada41e777d8e1919ba00">type</a> == <a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a1c2635a230708dfba8857a6d6509b6a1ab0479ba418aae875e074a9d1d32f77e4">CATCH_TYPE_RESCUE</a> ||
<a name="l01303"></a>01303                         entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#ac2b2471bbfb0ada41e777d8e1919ba00">type</a> == <a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a1c2635a230708dfba8857a6d6509b6a1af40d37f8dee0a7d299cf107101dd588b">CATCH_TYPE_ENSURE</a>) {
<a name="l01304"></a>01304                         catch_iseqval = entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a919aa1dbe534777ff38a07a17b956524">iseq</a>;
<a name="l01305"></a>01305                         cont_pc = entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a948846a98f14e75301964e17a95afcea">cont</a>;
<a name="l01306"></a>01306                         cont_sp = entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a0b7ff23536c8be69a62188be1a84c1d5">sp</a>;
<a name="l01307"></a>01307                         <span class="keywordflow">break</span>;
<a name="l01308"></a>01308                     }
<a name="l01309"></a>01309                 }
<a name="l01310"></a>01310             }
<a name="l01311"></a>01311         }
<a name="l01312"></a>01312         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == <a class="code" href="../../dd/dd0/eval__intern_8h.html#a277f73abdf66e83f4fc75b93d6e87b72">TAG_RETRY</a>) {
<a name="l01313"></a>01313             <span class="keywordflow">for</span> (i = 0; i &lt; cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#ae1d2b9b5e2ae668e100d814f2da38ac0">catch_table_size</a>; i++) {
<a name="l01314"></a>01314                 entry = &amp;cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aaf3c6629a41865ab662884b7481fb394">catch_table</a>[i];
<a name="l01315"></a>01315                 <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a9427499a8613b4046de7b20d3153c5ab">start</a> &lt; epc &amp;&amp; entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#af2d9fb3c5142c7e037d1405e0b7c59ae">end</a> &gt;= epc) {
<a name="l01316"></a>01316 
<a name="l01317"></a>01317                     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#ac2b2471bbfb0ada41e777d8e1919ba00">type</a> == <a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a1c2635a230708dfba8857a6d6509b6a1af40d37f8dee0a7d299cf107101dd588b">CATCH_TYPE_ENSURE</a>) {
<a name="l01318"></a>01318                         catch_iseqval = entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a919aa1dbe534777ff38a07a17b956524">iseq</a>;
<a name="l01319"></a>01319                         cont_pc = entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a948846a98f14e75301964e17a95afcea">cont</a>;
<a name="l01320"></a>01320                         cont_sp = entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a0b7ff23536c8be69a62188be1a84c1d5">sp</a>;
<a name="l01321"></a>01321                         <span class="keywordflow">break</span>;
<a name="l01322"></a>01322                     }
<a name="l01323"></a>01323                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#ac2b2471bbfb0ada41e777d8e1919ba00">type</a> == <a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a1c2635a230708dfba8857a6d6509b6a1a47795bf670cf0e9b6d3c2f4b01f4f9e7">CATCH_TYPE_RETRY</a>) {
<a name="l01324"></a>01324                         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *escape_dfp;
<a name="l01325"></a>01325                         escape_dfp = <a class="code" href="../../dd/dd0/eval__intern_8h.html#aeeda78ded67b3dc359c8911e679f0f15">GET_THROWOBJ_CATCH_POINT</a>(err);
<a name="l01326"></a>01326                         <span class="keywordflow">if</span> (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a> == escape_dfp) {
<a name="l01327"></a>01327                             cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a28b0b301811a891225ba9a58c412482d">pc</a> = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aa70f3e195a4350acbbc130f8a95c9958">iseq_encoded</a> + entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a948846a98f14e75301964e17a95afcea">cont</a>;
<a name="l01328"></a>01328                             th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a173e2da61fa57c7044fd7874a8c7a924">errinfo</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01329"></a>01329                             <span class="keywordflow">goto</span> vm_loop_start;
<a name="l01330"></a>01330                         }
<a name="l01331"></a>01331                     }
<a name="l01332"></a>01332                 }
<a name="l01333"></a>01333             }
<a name="l01334"></a>01334         }
<a name="l01335"></a>01335         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == <a class="code" href="../../dd/dd0/eval__intern_8h.html#aa69d9fa25afdc01237612a6047b96189">TAG_BREAK</a> &amp;&amp; ((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)escape_dfp &amp; ~0x03) == 0) {
<a name="l01336"></a>01336             type = <a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a1c2635a230708dfba8857a6d6509b6a1ae556eed8cf5ae82c6e44b2ee9f5bc3d7">CATCH_TYPE_BREAK</a>;
<a name="l01337"></a>01337 
<a name="l01338"></a>01338           search_restart_point:
<a name="l01339"></a>01339             <span class="keywordflow">for</span> (i = 0; i &lt; cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#ae1d2b9b5e2ae668e100d814f2da38ac0">catch_table_size</a>; i++) {
<a name="l01340"></a>01340                 entry = &amp;cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aaf3c6629a41865ab662884b7481fb394">catch_table</a>[i];
<a name="l01341"></a>01341 
<a name="l01342"></a>01342                 <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a9427499a8613b4046de7b20d3153c5ab">start</a> &lt; epc &amp;&amp; entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#af2d9fb3c5142c7e037d1405e0b7c59ae">end</a> &gt;= epc) {
<a name="l01343"></a>01343                     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#ac2b2471bbfb0ada41e777d8e1919ba00">type</a> == <a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a1c2635a230708dfba8857a6d6509b6a1af40d37f8dee0a7d299cf107101dd588b">CATCH_TYPE_ENSURE</a>) {
<a name="l01344"></a>01344                         catch_iseqval = entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a919aa1dbe534777ff38a07a17b956524">iseq</a>;
<a name="l01345"></a>01345                         cont_pc = entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a948846a98f14e75301964e17a95afcea">cont</a>;
<a name="l01346"></a>01346                         cont_sp = entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a0b7ff23536c8be69a62188be1a84c1d5">sp</a>;
<a name="l01347"></a>01347                         <span class="keywordflow">break</span>;
<a name="l01348"></a>01348                     }
<a name="l01349"></a>01349                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#ac2b2471bbfb0ada41e777d8e1919ba00">type</a> == type) {
<a name="l01350"></a>01350                         cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a28b0b301811a891225ba9a58c412482d">pc</a> = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aa70f3e195a4350acbbc130f8a95c9958">iseq_encoded</a> + entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a948846a98f14e75301964e17a95afcea">cont</a>;
<a name="l01351"></a>01351                         cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a> = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a8e19fd7af779b623f1e9477f271358e6">bp</a> + entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a0b7ff23536c8be69a62188be1a84c1d5">sp</a>;
<a name="l01352"></a>01352 
<a name="l01353"></a>01353                         <span class="keywordflow">if</span> (state != <a class="code" href="../../dd/dd0/eval__intern_8h.html#a82e8bb282a1d35fcc453335b090bd4a7">TAG_REDO</a>) {
<a name="l01354"></a>01354 <span class="preprocessor">#if OPT_STACK_CACHING</span>
<a name="l01355"></a>01355 <span class="preprocessor"></span>                            initial = (<a class="code" href="../../dd/dd0/eval__intern_8h.html#a3cc03eefb2b828e688368c647698e1b7">GET_THROWOBJ_VAL</a>(err));
<a name="l01356"></a>01356 <span class="preprocessor">#else</span>
<a name="l01357"></a>01357 <span class="preprocessor"></span>                            *th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a>++ = (<a class="code" href="../../dd/dd0/eval__intern_8h.html#a3cc03eefb2b828e688368c647698e1b7">GET_THROWOBJ_VAL</a>(err));
<a name="l01358"></a>01358 <span class="preprocessor">#endif</span>
<a name="l01359"></a>01359 <span class="preprocessor"></span>                        }
<a name="l01360"></a>01360                         th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a173e2da61fa57c7044fd7874a8c7a924">errinfo</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01361"></a>01361                         <span class="keywordflow">goto</span> vm_loop_start;
<a name="l01362"></a>01362                     }
<a name="l01363"></a>01363                 }
<a name="l01364"></a>01364             }
<a name="l01365"></a>01365         }
<a name="l01366"></a>01366         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == <a class="code" href="../../dd/dd0/eval__intern_8h.html#a82e8bb282a1d35fcc453335b090bd4a7">TAG_REDO</a>) {
<a name="l01367"></a>01367             type = <a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a1c2635a230708dfba8857a6d6509b6a1aa4e94b0ce1178f40ead4772fba48178d">CATCH_TYPE_REDO</a>;
<a name="l01368"></a>01368             <span class="keywordflow">goto</span> search_restart_point;
<a name="l01369"></a>01369         }
<a name="l01370"></a>01370         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == <a class="code" href="../../dd/dd0/eval__intern_8h.html#ac5d3e11622cde853addb87cfae24021e">TAG_NEXT</a>) {
<a name="l01371"></a>01371             type = <a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a1c2635a230708dfba8857a6d6509b6a1a98ba159a92bfd8eabf0edb7381b8dcac">CATCH_TYPE_NEXT</a>;
<a name="l01372"></a>01372             <span class="keywordflow">goto</span> search_restart_point;
<a name="l01373"></a>01373         }
<a name="l01374"></a>01374         <span class="keywordflow">else</span> {
<a name="l01375"></a>01375             <span class="keywordflow">for</span> (i = 0; i &lt; cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#ae1d2b9b5e2ae668e100d814f2da38ac0">catch_table_size</a>; i++) {
<a name="l01376"></a>01376                 entry = &amp;cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aaf3c6629a41865ab662884b7481fb394">catch_table</a>[i];
<a name="l01377"></a>01377                 <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a9427499a8613b4046de7b20d3153c5ab">start</a> &lt; epc &amp;&amp; entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#af2d9fb3c5142c7e037d1405e0b7c59ae">end</a> &gt;= epc) {
<a name="l01378"></a>01378 
<a name="l01379"></a>01379                     <span class="keywordflow">if</span> (entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#ac2b2471bbfb0ada41e777d8e1919ba00">type</a> == <a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a1c2635a230708dfba8857a6d6509b6a1af40d37f8dee0a7d299cf107101dd588b">CATCH_TYPE_ENSURE</a>) {
<a name="l01380"></a>01380                         catch_iseqval = entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a919aa1dbe534777ff38a07a17b956524">iseq</a>;
<a name="l01381"></a>01381                         cont_pc = entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a948846a98f14e75301964e17a95afcea">cont</a>;
<a name="l01382"></a>01382                         cont_sp = entry-&gt;<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a0b7ff23536c8be69a62188be1a84c1d5">sp</a>;
<a name="l01383"></a>01383                         <span class="keywordflow">break</span>;
<a name="l01384"></a>01384                     }
<a name="l01385"></a>01385                 }
<a name="l01386"></a>01386             }
<a name="l01387"></a>01387         }
<a name="l01388"></a>01388 
<a name="l01389"></a>01389         <span class="keywordflow">if</span> (catch_iseqval != 0) {
<a name="l01390"></a>01390             <span class="comment">/* found catch table */</span>
<a name="l01391"></a>01391             <a class="code" href="../../d6/de3/structrb__iseq__struct.html">rb_iseq_t</a> *catch_iseq;
<a name="l01392"></a>01392 
<a name="l01393"></a>01393             <span class="comment">/* enter catch scope */</span>
<a name="l01394"></a>01394             <a class="code" href="../../d8/d32/vm__core_8h.html#a5e6a3515e0ad9b9d6a4c0ab577dc50b6">GetISeqPtr</a>(catch_iseqval, catch_iseq);
<a name="l01395"></a>01395             cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a> = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a8e19fd7af779b623f1e9477f271358e6">bp</a> + cont_sp;
<a name="l01396"></a>01396             cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a28b0b301811a891225ba9a58c412482d">pc</a> = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aa70f3e195a4350acbbc130f8a95c9958">iseq_encoded</a> + cont_pc;
<a name="l01397"></a>01397 
<a name="l01398"></a>01398             <span class="comment">/* push block frame */</span>
<a name="l01399"></a>01399             cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a>[0] = err;
<a name="l01400"></a>01400             <a class="code" href="../../d0/db2/vm__insnhelper_8c.html#a30340566da5743c4d660c8931dffd86e">vm_push_frame</a>(th, catch_iseq, <a class="code" href="../../d8/d32/vm__core_8h.html#a83eeedff3dde6d2d1ffce5d84c2ba2f1">VM_FRAME_MAGIC_BLOCK</a>,
<a name="l01401"></a>01401                           cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4c11a50358317e1207affd6d7b4ad576">self</a>, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#ac1cafd093e114d3ec99ebeca0ffeb048">dfp</a>, catch_iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aa70f3e195a4350acbbc130f8a95c9958">iseq_encoded</a>,
<a name="l01402"></a>01402                           cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a> + 1 <span class="comment">/* push value */</span>, cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#af3314cb37c8a27353101bf6f35574946">lfp</a>, catch_iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#afbae994355f91f3ea547570debb757c0">local_size</a> - 1);
<a name="l01403"></a>01403 
<a name="l01404"></a>01404             state = 0;
<a name="l01405"></a>01405             th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a25bbafcd0a1e0f6f79b42cc29baf3eb8">state</a> = 0;
<a name="l01406"></a>01406             th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a173e2da61fa57c7044fd7874a8c7a924">errinfo</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01407"></a>01407             <span class="keywordflow">goto</span> vm_loop_start;
<a name="l01408"></a>01408         }
<a name="l01409"></a>01409         <span class="keywordflow">else</span> {
<a name="l01410"></a>01410             <span class="comment">/* skip frame */</span>
<a name="l01411"></a>01411 
<a name="l01412"></a>01412             <span class="keywordflow">switch</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>)) {
<a name="l01413"></a>01413               <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#abc8be29d36c6252fce6bc61621f81b71">VM_FRAME_MAGIC_METHOD</a>:
<a name="l01414"></a>01414                 <a class="code" href="../../d8/d32/vm__core_8h.html#a724eed84e4b041ec1867e198ee129192">EXEC_EVENT_HOOK</a>(th, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa6ebd81993faad84c09b5080e1fde73d">RUBY_EVENT_RETURN</a>, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4c11a50358317e1207affd6d7b4ad576">self</a>, 0, 0);
<a name="l01415"></a>01415                 <span class="keywordflow">break</span>;
<a name="l01416"></a>01416               <span class="keywordflow">case</span> <a class="code" href="../../d8/d32/vm__core_8h.html#a2524f590c07fceb689b2b7d53114ff5f">VM_FRAME_MAGIC_CLASS</a>:
<a name="l01417"></a>01417                 <a class="code" href="../../d8/d32/vm__core_8h.html#a724eed84e4b041ec1867e198ee129192">EXEC_EVENT_HOOK</a>(th, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a008ad47ad1b6add87c9dc674e976380c">RUBY_EVENT_END</a>, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4c11a50358317e1207affd6d7b4ad576">self</a>, 0, 0);
<a name="l01418"></a>01418                 <span class="keywordflow">break</span>;
<a name="l01419"></a>01419             }
<a name="l01420"></a>01420 
<a name="l01421"></a>01421             th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a> = <a class="code" href="../../d8/d32/vm__core_8h.html#af087c881c3c493e3a4e326852e8ed2a9">RUBY_VM_PREVIOUS_CONTROL_FRAME</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>);
<a name="l01422"></a>01422 
<a name="l01423"></a>01423             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a423bad734fe427f4d5deeb4fe71fff65">VM_FRAME_TYPE</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>) != <a class="code" href="../../d8/d32/vm__core_8h.html#a885c6468caef6c3de80b0ad6c50ae38d">VM_FRAME_MAGIC_FINISH</a>) {
<a name="l01424"></a>01424                 <span class="keywordflow">goto</span> exception_handler;
<a name="l01425"></a>01425             }
<a name="l01426"></a>01426             <span class="keywordflow">else</span> {
<a name="l01427"></a>01427                 <a class="code" href="../../d0/db2/vm__insnhelper_8c.html#a0aeeee637bf9706f9d240bac4ae359c3">vm_pop_frame</a>(th);
<a name="l01428"></a>01428                 th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a173e2da61fa57c7044fd7874a8c7a924">errinfo</a> = err;
<a name="l01429"></a>01429                 <a class="code" href="../../dd/dd0/eval__intern_8h.html#a4bb909636fd43ab591291ffb47b83d3f">TH_POP_TAG2</a>();
<a name="l01430"></a>01430                 <a class="code" href="../../dd/dd0/eval__intern_8h.html#a24884166ae699029ade34fd36bedd688">JUMP_TAG</a>(state);
<a name="l01431"></a>01431             }
<a name="l01432"></a>01432         }
<a name="l01433"></a>01433     }
<a name="l01434"></a>01434   finish_vme:
<a name="l01435"></a>01435     <a class="code" href="../../dd/dd0/eval__intern_8h.html#a4d06135dea1a72a3ab73b20cc1a9fc55">TH_POP_TAG</a>();
<a name="l01436"></a>01436     <span class="keywordflow">return</span> result;
<a name="l01437"></a>01437 }
<a name="l01438"></a>01438 
<a name="l01439"></a>01439 <span class="comment">/* misc */</span>
<a name="l01440"></a>01440 
<a name="l01441"></a>01441 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01442"></a><a class="code" href="../../d8/d32/vm__core_8h.html#a6e6ce66eb03fe0ce260cc4556b62e129">01442</a> <a class="code" href="../../de/de9/vm_8c.html#a6e6ce66eb03fe0ce260cc4556b62e129">rb_iseq_eval</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> iseqval)
<a name="l01443"></a>01443 {
<a name="l01444"></a>01444     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l01445"></a>01445     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val;
<a name="l01446"></a>01446     <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> tmp;
<a name="l01447"></a>01447 
<a name="l01448"></a>01448     <a class="code" href="../../de/de9/vm_8c.html#a835b4cd0571894b624a302e8d2b736de">vm_set_top_stack</a>(th, iseqval);
<a name="l01449"></a>01449 
<a name="l01450"></a>01450     val = <a class="code" href="../../de/de9/vm_8c.html#a6fca4e13002f037d2e15bc1c77ab18ed">vm_exec</a>(th);
<a name="l01451"></a>01451     tmp = iseqval; <span class="comment">/* prohibit tail call optimization */</span>
<a name="l01452"></a>01452     <span class="keywordflow">return</span> val;
<a name="l01453"></a>01453 }
<a name="l01454"></a>01454 
<a name="l01455"></a>01455 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01456"></a><a class="code" href="../../d8/d32/vm__core_8h.html#a1561358bc5896c1fd390837e6faeb45f">01456</a> <a class="code" href="../../de/de9/vm_8c.html#a1561358bc5896c1fd390837e6faeb45f">rb_iseq_eval_main</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> iseqval)
<a name="l01457"></a>01457 {
<a name="l01458"></a>01458     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l01459"></a>01459     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val;
<a name="l01460"></a>01460     <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> tmp;
<a name="l01461"></a>01461 
<a name="l01462"></a>01462     <a class="code" href="../../de/de9/vm_8c.html#aa938e139dcf9509037140019da6f4a47">vm_set_main_stack</a>(th, iseqval);
<a name="l01463"></a>01463 
<a name="l01464"></a>01464     val = <a class="code" href="../../de/de9/vm_8c.html#a6fca4e13002f037d2e15bc1c77ab18ed">vm_exec</a>(th);
<a name="l01465"></a>01465     tmp = iseqval; <span class="comment">/* prohibit tail call optimization */</span>
<a name="l01466"></a>01466     <span class="keywordflow">return</span> val;
<a name="l01467"></a>01467 }
<a name="l01468"></a>01468 
<a name="l01469"></a>01469 <span class="keywordtype">int</span>
<a name="l01470"></a><a class="code" href="../../d8/d32/vm__core_8h.html#a7417e683ea286195e2514eca8cfbf601">01470</a> <a class="code" href="../../de/de9/vm_8c.html#a7417e683ea286195e2514eca8cfbf601">rb_thread_method_id_and_class</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th,
<a name="l01471"></a>01471                               <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> *idp, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *klassp)
<a name="l01472"></a>01472 {
<a name="l01473"></a>01473     <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>;
<a name="l01474"></a>01474     <a class="code" href="../../d6/de3/structrb__iseq__struct.html">rb_iseq_t</a> *<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a919aa1dbe534777ff38a07a17b956524">iseq</a> = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>;
<a name="l01475"></a>01475     <span class="keywordflow">if</span> (!iseq &amp;&amp; cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aa0ec76f80ebaf0668b688c4e4e5e3e3f">me</a>) {
<a name="l01476"></a>01476         <span class="keywordflow">if</span> (idp) *idp = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aa0ec76f80ebaf0668b688c4e4e5e3e3f">me</a>-&gt;<a class="code" href="../../d7/db7/structrb__method__entry__struct.html#a6c868c50e67b757c6324dfef0f3184dc">def</a>-&gt;<a class="code" href="../../d6/dab/structrb__method__definition__struct.html#a7fc0edb8505a61f8ae8bf2544fa7f676">original_id</a>;
<a name="l01477"></a>01477         <span class="keywordflow">if</span> (klassp) *klassp = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aa0ec76f80ebaf0668b688c4e4e5e3e3f">me</a>-&gt;<a class="code" href="../../d7/db7/structrb__method__entry__struct.html#a9ce0871480ac405b00673b25234738de">klass</a>;
<a name="l01478"></a>01478         <span class="keywordflow">return</span> 1;
<a name="l01479"></a>01479     }
<a name="l01480"></a>01480     <span class="keywordflow">while</span> (iseq) {
<a name="l01481"></a>01481         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#aa933aeb7a703c7cc2d136492acbbef22">RUBY_VM_IFUNC_P</a>(iseq)) {
<a name="l01482"></a>01482             <span class="keywordflow">if</span> (idp) <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa50b9d5bc665eb5545f6857c89232161">CONST_ID</a>(*idp, <span class="stringliteral">&quot;&lt;ifunc&gt;&quot;</span>);
<a name="l01483"></a>01483             <span class="keywordflow">if</span> (klassp) *klassp = 0;
<a name="l01484"></a>01484             <span class="keywordflow">return</span> 1;
<a name="l01485"></a>01485         }
<a name="l01486"></a>01486         <span class="keywordflow">if</span> (iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a0f4b700a7d7866d0c5bcabf6d2a1be0b">defined_method_id</a>) {
<a name="l01487"></a>01487             <span class="keywordflow">if</span> (idp) *idp = iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a0f4b700a7d7866d0c5bcabf6d2a1be0b">defined_method_id</a>;
<a name="l01488"></a>01488             <span class="keywordflow">if</span> (klassp) *klassp = iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a8817d34a572e6fd1c75da386036f7d7d">klass</a>;
<a name="l01489"></a>01489             <span class="keywordflow">return</span> 1;
<a name="l01490"></a>01490         }
<a name="l01491"></a>01491         <span class="keywordflow">if</span> (iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a0f5705507c4c80bc69c3f031dd0daae9">local_iseq</a> == iseq) {
<a name="l01492"></a>01492             <span class="keywordflow">break</span>;
<a name="l01493"></a>01493         }
<a name="l01494"></a>01494         iseq = iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#afce02da209c0bf9a09ef4ea0af68e623">parent_iseq</a>;
<a name="l01495"></a>01495     }
<a name="l01496"></a>01496     <span class="keywordflow">return</span> 0;
<a name="l01497"></a>01497 }
<a name="l01498"></a>01498 
<a name="l01499"></a>01499 <span class="keywordtype">int</span>
<a name="l01500"></a><a class="code" href="../../de/de9/vm_8c.html#a6570f238bce65b6594917b796b285edc">01500</a> <a class="code" href="../../db/d2e/intern_8h.html#a6570f238bce65b6594917b796b285edc">rb_frame_method_id_and_class</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> *idp, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *klassp)
<a name="l01501"></a>01501 {
<a name="l01502"></a>01502     <span class="keywordflow">return</span> <a class="code" href="../../de/de9/vm_8c.html#a7417e683ea286195e2514eca8cfbf601">rb_thread_method_id_and_class</a>(<a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>(), idp, klassp);
<a name="l01503"></a>01503 }
<a name="l01504"></a>01504 
<a name="l01505"></a>01505 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01506"></a><a class="code" href="../../de/de9/vm_8c.html#af3ce515dfb6ce5b335b9e2074c7572d2">01506</a> <a class="code" href="../../de/de9/vm_8c.html#af3ce515dfb6ce5b335b9e2074c7572d2">rb_thread_current_status</a>(<span class="keyword">const</span> <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th)
<a name="l01507"></a>01507 {
<a name="l01508"></a>01508     <span class="keyword">const</span> <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>;
<a name="l01509"></a>01509     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> str = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01510"></a>01510 
<a name="l01511"></a>01511     <span class="keywordflow">if</span> (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a> != 0) {
<a name="l01512"></a>01512         <span class="keywordflow">if</span> (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a28b0b301811a891225ba9a58c412482d">pc</a> != 0) {
<a name="l01513"></a>01513             <a class="code" href="../../d6/de3/structrb__iseq__struct.html">rb_iseq_t</a> *<a class="code" href="../../dc/d07/structiseq__catch__table__entry.html#a919aa1dbe534777ff38a07a17b956524">iseq</a> = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>;
<a name="l01514"></a>01514             <span class="keywordtype">int</span> line_no = <a class="code" href="../../de/de9/vm_8c.html#a70289cbb34babceed6243d9471e70e5f">rb_vm_get_sourceline</a>(cfp);
<a name="l01515"></a>01515             <span class="keywordtype">char</span> *file = <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a06859fa5de56f2ede3cb692f1d9215e2">filename</a>);
<a name="l01516"></a>01516             str = <a class="code" href="../../d9/d2d/sprintf_8c.html#a05c34a91ab36c6a463c861df47808fae">rb_sprintf</a>(<span class="stringliteral">&quot;%s:%d:in `%s&apos;&quot;</span>,
<a name="l01517"></a>01517                              file, line_no, <a class="code" href="../../d8/df4/generator_8h.html#aa0c7097c0d82c8372072fbab5a604e39">RSTRING_PTR</a>(iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a35596da255ce28a5d1da94c2cc508c7d">name</a>));
<a name="l01518"></a>01518         }
<a name="l01519"></a>01519     }
<a name="l01520"></a>01520     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aa0ec76f80ebaf0668b688c4e4e5e3e3f">me</a>-&gt;<a class="code" href="../../d7/db7/structrb__method__entry__struct.html#a6c868c50e67b757c6324dfef0f3184dc">def</a>-&gt;<a class="code" href="../../d6/dab/structrb__method__definition__struct.html#a7fc0edb8505a61f8ae8bf2544fa7f676">original_id</a>) {
<a name="l01521"></a>01521         str = <a class="code" href="../../d9/d2d/sprintf_8c.html#a05c34a91ab36c6a463c861df47808fae">rb_sprintf</a>(<span class="stringliteral">&quot;`%s#%s&apos; (cfunc)&quot;</span>,
<a name="l01522"></a>01522                          <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afd98e957d0d96017f7a07dd83772fadc">rb_class2name</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aa0ec76f80ebaf0668b688c4e4e5e3e3f">me</a>-&gt;<a class="code" href="../../d7/db7/structrb__method__entry__struct.html#a9ce0871480ac405b00673b25234738de">klass</a>),
<a name="l01523"></a>01523                          <a class="code" href="../../d5/d11/ripper_8c.html#a877bc58c495643fcf49dc64c44631e72">rb_id2name</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aa0ec76f80ebaf0668b688c4e4e5e3e3f">me</a>-&gt;<a class="code" href="../../d7/db7/structrb__method__entry__struct.html#a6c868c50e67b757c6324dfef0f3184dc">def</a>-&gt;<a class="code" href="../../d6/dab/structrb__method__definition__struct.html#a7fc0edb8505a61f8ae8bf2544fa7f676">original_id</a>));
<a name="l01524"></a>01524     }
<a name="l01525"></a>01525 
<a name="l01526"></a>01526     <span class="keywordflow">return</span> str;
<a name="l01527"></a>01527 }
<a name="l01528"></a>01528 
<a name="l01529"></a>01529 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01530"></a><a class="code" href="../../de/de9/vm_8c.html#aff1db7f3bad76fa89acbb4097e1ff12f">01530</a> <a class="code" href="../../dd/dd0/eval__intern_8h.html#aff1db7f3bad76fa89acbb4097e1ff12f">rb_vm_call_cfunc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> recv, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> (*<a class="code" href="../../dc/dd1/ossl__ssl_8c.html#a131c09b7f9c9a0b52e6f79f651cfd574">func</a>)(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> arg,
<a name="l01531"></a>01531                  <span class="keyword">const</span> <a class="code" href="../../da/dc0/structrb__block__struct.html">rb_block_t</a> *blockptr, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> filename)
<a name="l01532"></a>01532 {
<a name="l01533"></a>01533     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l01534"></a>01534     <span class="keyword">const</span> <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *reg_cfp = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>;
<a name="l01535"></a>01535     <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> iseqval = <a class="code" href="../../dd/d74/iseq_8c.html#a356d85dc4610b2e4f8fdd2c9cede6780">rb_iseq_new</a>(0, filename, filename, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>, 0, ISEQ_TYPE_TOP);
<a name="l01536"></a>01536     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> val;
<a name="l01537"></a>01537 
<a name="l01538"></a>01538     <a class="code" href="../../d0/db2/vm__insnhelper_8c.html#a30340566da5743c4d660c8931dffd86e">vm_push_frame</a>(th, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abb509cfdf6560a9f795b1f6932d93691">DATA_PTR</a>(iseqval), <a class="code" href="../../d8/d32/vm__core_8h.html#ac9390ef02c17a0bc7e3bd359264562c7">VM_FRAME_MAGIC_TOP</a>,
<a name="l01539"></a>01539                   recv, (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)blockptr, 0, reg_cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a>, 0, 1);
<a name="l01540"></a>01540 
<a name="l01541"></a>01541     val = (*func)(arg);
<a name="l01542"></a>01542 
<a name="l01543"></a>01543     <a class="code" href="../../d0/db2/vm__insnhelper_8c.html#a0aeeee637bf9706f9d240bac4ae359c3">vm_pop_frame</a>(th);
<a name="l01544"></a>01544     <span class="keywordflow">return</span> val;
<a name="l01545"></a>01545 }
<a name="l01546"></a>01546 
<a name="l01547"></a>01547 <span class="comment">/* vm */</span>
<a name="l01548"></a>01548 
<a name="l01549"></a>01549 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01550"></a><a class="code" href="../../de/de9/vm_8c.html#a89c3d926a61cd7ceb032a9cc999bdb5e">01550</a> <a class="code" href="../../de/de9/vm_8c.html#a89c3d926a61cd7ceb032a9cc999bdb5e">vm_mark_each_thread_func</a>(<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> <a class="code" href="../../dc/de5/random_8c.html#a742229490b6759a90ece7ba82ba129d5">key</a>, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> value, <a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a> dummy)
<a name="l01551"></a>01551 {
<a name="l01552"></a>01552     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> thval = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)key;
<a name="l01553"></a>01553     <a class="code" href="../../d8/d16/gc_8c.html#a98250264e6adf4924cf2becf80122325">rb_gc_mark</a>(thval);
<a name="l01554"></a>01554     <span class="keywordflow">return</span> <a class="code" href="../../dd/d24/st_8h.html#a0c6a172fd99de7928916e65034ed8b1fac99fc55c7f355bf9071739a4bc2ea139">ST_CONTINUE</a>;
<a name="l01555"></a>01555 }
<a name="l01556"></a>01556 
<a name="l01557"></a>01557 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01558"></a><a class="code" href="../../de/de9/vm_8c.html#a24b81b57763993a6328a2451562e5995">01558</a> <a class="code" href="../../de/de9/vm_8c.html#a24b81b57763993a6328a2451562e5995">mark_event_hooks</a>(<a class="code" href="../../d8/d86/structrb__event__hook__struct.html">rb_event_hook_t</a> *hook)
<a name="l01559"></a>01559 {
<a name="l01560"></a>01560     <span class="keywordflow">while</span> (hook) {
<a name="l01561"></a>01561         <a class="code" href="../../d8/d16/gc_8c.html#a98250264e6adf4924cf2becf80122325">rb_gc_mark</a>(hook-&gt;<a class="code" href="../../d8/d86/structrb__event__hook__struct.html#aa6137e2130d9fd79d3efe46bdfce89ec">data</a>);
<a name="l01562"></a>01562         hook = hook-&gt;<a class="code" href="../../d8/d86/structrb__event__hook__struct.html#aa184927c156193e1506cf6649c036e67">next</a>;
<a name="l01563"></a>01563     }
<a name="l01564"></a>01564 }
<a name="l01565"></a>01565 
<a name="l01566"></a>01566 <span class="keywordtype">void</span>
<a name="l01567"></a><a class="code" href="../../de/de9/vm_8c.html#a8002db40fa68e94f40fec02f6d7d6ea6">01567</a> <a class="code" href="../../de/de9/vm_8c.html#a8002db40fa68e94f40fec02f6d7d6ea6">rb_vm_mark</a>(<span class="keywordtype">void</span> *ptr)
<a name="l01568"></a>01568 {
<a name="l01569"></a>01569     <span class="keywordtype">int</span> i;
<a name="l01570"></a>01570 
<a name="l01571"></a>01571     <a class="code" href="../../d0/daa/gc_8h.html#a2aa4d10eb84bae94811007f68c795fb7">RUBY_MARK_ENTER</a>(<span class="stringliteral">&quot;vm&quot;</span>);
<a name="l01572"></a>01572     <a class="code" href="../../d0/daa/gc_8h.html#a634fb573223a0ffb428332fc45916fc6">RUBY_GC_INFO</a>(<span class="stringliteral">&quot;-------------------------------------------------\n&quot;</span>);
<a name="l01573"></a>01573     <span class="keywordflow">if</span> (ptr) {
<a name="l01574"></a>01574         <a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vm = ptr;
<a name="l01575"></a>01575         <span class="keywordflow">if</span> (vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a09bd6675a9fe3f1b19e36284e91a0e31">living_threads</a>) {
<a name="l01576"></a>01576             <a class="code" href="../../dd/d24/st_8h.html#ace5a79870d2800659a653fceeca55262">st_foreach</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a09bd6675a9fe3f1b19e36284e91a0e31">living_threads</a>, <a class="code" href="../../de/de9/vm_8c.html#a89c3d926a61cd7ceb032a9cc999bdb5e">vm_mark_each_thread_func</a>, 0);
<a name="l01577"></a>01577         }
<a name="l01578"></a>01578         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a81c2ebf1074cb61040daa9389f5bed80">thgroup_default</a>);
<a name="l01579"></a>01579         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#af4e77414ac91c895a15ae89dad71f143">mark_object_ary</a>);
<a name="l01580"></a>01580         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a3f2af823747e05c39f7ebd9113e18d3a">load_path</a>);
<a name="l01581"></a>01581         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#adc9a2f20cba11e9a872bbe603b7db593">loaded_features</a>);
<a name="l01582"></a>01582         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a75e7f2d63af5fc368e6a1de951190f22">top_self</a>);
<a name="l01583"></a>01583         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a21b034468dbe39d33b06fff964a45e9e">coverages</a>);
<a name="l01584"></a>01584         <a class="code" href="../../d8/d16/gc_8c.html#a90e176b7e9d24053977f64a611c1d8bb">rb_gc_mark_locations</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a0878bef1918bcb59dbd39fe53ba3a9a1">special_exceptions</a>, vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a0878bef1918bcb59dbd39fe53ba3a9a1">special_exceptions</a> + <a class="code" href="../../d8/d32/vm__core_8h.html#a58590982dd240cfd7473cc798636c05aa6d18d1c50b79b691e7b8f979b3ff4f0e">ruby_special_error_count</a>);
<a name="l01585"></a>01585 
<a name="l01586"></a>01586         <span class="keywordflow">if</span> (vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a545233706d1cdd425f64edda8fc67dc7">loading_table</a>) {
<a name="l01587"></a>01587             <a class="code" href="../../d8/d16/gc_8c.html#a6b9a51387748f1a94f4d77092163aa3a">rb_mark_tbl</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a545233706d1cdd425f64edda8fc67dc7">loading_table</a>);
<a name="l01588"></a>01588         }
<a name="l01589"></a>01589 
<a name="l01590"></a>01590         <a class="code" href="../../de/de9/vm_8c.html#a24b81b57763993a6328a2451562e5995">mark_event_hooks</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a97f5b4a0de8b22b5b2215e311bd51eac">event_hooks</a>);
<a name="l01591"></a>01591 
<a name="l01592"></a>01592         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d32/vm__core_8h.html#ae435941bb169c44f47dbc7f93a93f3db">RUBY_NSIG</a>; i++) {
<a name="l01593"></a>01593             <span class="keywordflow">if</span> (vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a0f0e732caa8418f018fa0f257c783051">trap_list</a>[i].<a class="code" href="../../db/d74/structrb__vm__struct.html#ab84e4878eb81247cddd6b409f5a694a4">cmd</a>)
<a name="l01594"></a>01594                 <a class="code" href="../../d8/d16/gc_8c.html#a98250264e6adf4924cf2becf80122325">rb_gc_mark</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a0f0e732caa8418f018fa0f257c783051">trap_list</a>[i].<a class="code" href="../../db/d74/structrb__vm__struct.html#ab84e4878eb81247cddd6b409f5a694a4">cmd</a>);
<a name="l01595"></a>01595         }
<a name="l01596"></a>01596     }
<a name="l01597"></a>01597 
<a name="l01598"></a>01598     <a class="code" href="../../d0/daa/gc_8h.html#a036115d8c044f5c847e760c57b08e5a9">RUBY_MARK_LEAVE</a>(<span class="stringliteral">&quot;vm&quot;</span>);
<a name="l01599"></a>01599 }
<a name="l01600"></a>01600 
<a name="l01601"></a><a class="code" href="../../de/de9/vm_8c.html#ae4b1c6a8b7a127fbd91c24d4198c9964">01601</a> <span class="preprocessor">#define vm_free 0</span>
<a name="l01602"></a>01602 <span class="preprocessor"></span>
<a name="l01603"></a>01603 <span class="keywordtype">int</span>
<a name="l01604"></a><a class="code" href="../../de/de9/vm_8c.html#a3a1a8ed8ecbbf3bd74854ef802cb910d">01604</a> <a class="code" href="../../da/d0a/vm_8h.html#a64b7830f0ac2f5c4e03c3659051b3e4b">ruby_vm_destruct</a>(<a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vm)
<a name="l01605"></a>01605 {
<a name="l01606"></a>01606     <a class="code" href="../../d0/daa/gc_8h.html#a5d959738efb454623a7dad84d728262a">RUBY_FREE_ENTER</a>(<span class="stringliteral">&quot;vm&quot;</span>);
<a name="l01607"></a>01607     <span class="keywordflow">if</span> (vm) {
<a name="l01608"></a>01608         <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a55af19560794b67c09c608a8464e47c9">main_thread</a>;
<a name="l01609"></a>01609 <span class="preprocessor">#if defined(ENABLE_VM_OBJSPACE) &amp;&amp; ENABLE_VM_OBJSPACE</span>
<a name="l01610"></a>01610 <span class="preprocessor"></span>        <span class="keyword">struct </span><a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace</a> *objspace = vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a9eedda91413032dce6a7053a8f0a449d">objspace</a>;
<a name="l01611"></a>01611 <span class="preprocessor">#endif</span>
<a name="l01612"></a>01612 <span class="preprocessor"></span>        <a class="code" href="../../d8/d16/gc_8c.html#a53016811c87ff4c3ea839c9e85a9a9a4">rb_gc_force_recycle</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a60a372cceaf16011b6c3d3b6861df36b">self</a>);
<a name="l01613"></a>01613         vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a55af19560794b67c09c608a8464e47c9">main_thread</a> = 0;
<a name="l01614"></a>01614         <span class="keywordflow">if</span> (th) {
<a name="l01615"></a>01615             <a class="code" href="../../d5/d75/cont_8c.html#ab5703bedcf05b1ec2af16142f292c5fb">rb_fiber_reset_root_local_storage</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a6e712e6c5295a4173188139f1d6b7462">self</a>);
<a name="l01616"></a>01616             <a class="code" href="../../de/de9/vm_8c.html#afa313ee08837bb9545102cd3f28d91a7">thread_free</a>(th);
<a name="l01617"></a>01617         }
<a name="l01618"></a>01618         <span class="keywordflow">if</span> (vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a09bd6675a9fe3f1b19e36284e91a0e31">living_threads</a>) {
<a name="l01619"></a>01619             <a class="code" href="../../dd/d24/st_8h.html#acb004847ef312373d65bfb0d1a21c5b3">st_free_table</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a09bd6675a9fe3f1b19e36284e91a0e31">living_threads</a>);
<a name="l01620"></a>01620             vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a09bd6675a9fe3f1b19e36284e91a0e31">living_threads</a> = 0;
<a name="l01621"></a>01621         }
<a name="l01622"></a>01622 <span class="preprocessor">#if defined(ENABLE_VM_OBJSPACE) &amp;&amp; ENABLE_VM_OBJSPACE</span>
<a name="l01623"></a>01623 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (objspace) {
<a name="l01624"></a>01624             <a class="code" href="../../d8/d32/vm__core_8h.html#aea0806876fcecf60de5af807dd054ab0">rb_objspace_free</a>(objspace);
<a name="l01625"></a>01625         }
<a name="l01626"></a>01626 <span class="preprocessor">#endif</span>
<a name="l01627"></a>01627 <span class="preprocessor"></span>        <a class="code" href="../../de/de9/vm_8c.html#af41ce3aa993b8eb956d96a10060fdcca">ruby_vm_run_at_exit_hooks</a>(vm);
<a name="l01628"></a>01628         <a class="code" href="../../d3/de7/thread_8c.html#a152e345de139a53b412409fe441067a0">rb_vm_gvl_destroy</a>(vm);
<a name="l01629"></a>01629         <a class="code" href="../../d8/d16/gc_8c.html#a0bffec5b2cc004adcebb6802e7620387">ruby_xfree</a>(vm);
<a name="l01630"></a>01630         ruby_current_vm = 0;
<a name="l01631"></a>01631     }
<a name="l01632"></a>01632     <a class="code" href="../../d0/daa/gc_8h.html#af304d34de3474d75064e0cba170b7bf5">RUBY_FREE_LEAVE</a>(<span class="stringliteral">&quot;vm&quot;</span>);
<a name="l01633"></a>01633     <span class="keywordflow">return</span> 0;
<a name="l01634"></a>01634 }
<a name="l01635"></a>01635 
<a name="l01636"></a>01636 <span class="keyword">static</span> <span class="keywordtype">size_t</span>
<a name="l01637"></a><a class="code" href="../../de/de9/vm_8c.html#adae7bcf1d59e017fabade78224b55f4e">01637</a> <a class="code" href="../../de/de9/vm_8c.html#adae7bcf1d59e017fabade78224b55f4e">vm_memsize</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="../../d7/dc0/structrb__objspace.html#a450c55a247ef7b5948507a181a5c43d1">ptr</a>)
<a name="l01638"></a>01638 {
<a name="l01639"></a>01639     <span class="keywordflow">if</span> (ptr) {
<a name="l01640"></a>01640         <span class="keyword">const</span> <a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vmobj = ptr;
<a name="l01641"></a>01641         <span class="keywordflow">return</span> <span class="keyword">sizeof</span>(<a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a>) + <a class="code" href="../../dd/d24/st_8h.html#a1d0d955fb1f39486c18162f222deb82b">st_memsize</a>(vmobj-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a09bd6675a9fe3f1b19e36284e91a0e31">living_threads</a>);
<a name="l01642"></a>01642     }
<a name="l01643"></a>01643     <span class="keywordflow">else</span> {
<a name="l01644"></a>01644         <span class="keywordflow">return</span> 0;
<a name="l01645"></a>01645     }
<a name="l01646"></a>01646 }
<a name="l01647"></a>01647 
<a name="l01648"></a><a class="code" href="../../de/de9/vm_8c.html#a118ab0087779e3d649f8db8fac1dfc4d">01648</a> <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="../../d7/de2/structrb__data__type__struct.html">rb_data_type_t</a> <a class="code" href="../../de/de9/vm_8c.html#a118ab0087779e3d649f8db8fac1dfc4d">vm_data_type</a> = {
<a name="l01649"></a>01649     <span class="stringliteral">&quot;VM&quot;</span>,
<a name="l01650"></a>01650     {<a class="code" href="../../de/de9/vm_8c.html#a8002db40fa68e94f40fec02f6d7d6ea6">rb_vm_mark</a>, <a class="code" href="../../de/de9/vm_8c.html#ae4b1c6a8b7a127fbd91c24d4198c9964">vm_free</a>, <a class="code" href="../../de/de9/vm_8c.html#adae7bcf1d59e017fabade78224b55f4e">vm_memsize</a>,},
<a name="l01651"></a>01651 };
<a name="l01652"></a>01652 
<a name="l01653"></a>01653 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01654"></a><a class="code" href="../../de/de9/vm_8c.html#a08ccea748ec0076636c2b4abada44ff0">01654</a> <a class="code" href="../../de/de9/vm_8c.html#a08ccea748ec0076636c2b4abada44ff0">vm_init2</a>(<a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vm)
<a name="l01655"></a>01655 {
<a name="l01656"></a>01656     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a56d620b94b668ed7665d1616b2c54e48">MEMZERO</a>(vm, <a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a>, 1);
<a name="l01657"></a>01657     vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a3ee23d493b793fc91dd61376593e8f17">src_encoding_index</a> = -1;
<a name="l01658"></a>01658     vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a328959223626113a5ceeb5638b5d9f8d">at_exit</a>.<a class="code" href="../../dd/d8b/struct_r_array.html#a302033453988193e8f7b18774fb68df9">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a8ba5a9a18f9e80fc8b8531d5894f5f38">flags</a> = (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#abbd332f6f94d77e0a369c7720128639e">T_ARRAY</a> | <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a01daa4561ae2e5d904a4df3c200a951c">RARRAY_EMBED_FLAG</a>) &amp; ~<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad838455402de0089eb6b18bf094d54ad">RARRAY_EMBED_LEN_MASK</a>; <span class="comment">/* len set 0 */</span>
<a name="l01659"></a>01659     vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a328959223626113a5ceeb5638b5d9f8d">at_exit</a>.<a class="code" href="../../dd/d8b/struct_r_array.html#a302033453988193e8f7b18774fb68df9">basic</a>.<a class="code" href="../../d2/d22/struct_r_basic.html#a31e86dc428e998786b528fef067424a4">klass</a> = 0;
<a name="l01660"></a>01660 }
<a name="l01661"></a>01661 
<a name="l01662"></a>01662 <span class="comment">/* Thread */</span>
<a name="l01663"></a>01663 
<a name="l01664"></a><a class="code" href="../../de/de9/vm_8c.html#a585ef3f19d4b31a72834f87218c91ec7">01664</a> <span class="preprocessor">#define USE_THREAD_DATA_RECYCLE 1</span>
<a name="l01665"></a>01665 <span class="preprocessor"></span>
<a name="l01666"></a>01666 <span class="preprocessor">#if USE_THREAD_DATA_RECYCLE</span>
<a name="l01667"></a><a class="code" href="../../de/de9/vm_8c.html#ac482343a3f810e935739993994e26b22">01667</a> <span class="preprocessor"></span><span class="preprocessor">#define RECYCLE_MAX 64</span>
<a name="l01668"></a><a class="code" href="../../de/de9/vm_8c.html#aebec1af86784db52769846dfc3b4cfaa">01668</a> <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../de/de9/vm_8c.html#aebec1af86784db52769846dfc3b4cfaa">thread_recycle_stack_slot</a>[<a class="code" href="../../de/de9/vm_8c.html#ac482343a3f810e935739993994e26b22">RECYCLE_MAX</a>];
<a name="l01669"></a><a class="code" href="../../de/de9/vm_8c.html#a088895c356d92de8dff1afee377c58c4">01669</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../de/de9/vm_8c.html#a088895c356d92de8dff1afee377c58c4">thread_recycle_stack_count</a> = 0;
<a name="l01670"></a>01670 
<a name="l01671"></a>01671 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *
<a name="l01672"></a><a class="code" href="../../de/de9/vm_8c.html#a2abade868818c379135d2eb27c104f85">01672</a> <a class="code" href="../../de/de9/vm_8c.html#a2abade868818c379135d2eb27c104f85">thread_recycle_stack</a>(<span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a>)
<a name="l01673"></a>01673 {
<a name="l01674"></a>01674     <span class="keywordflow">if</span> (thread_recycle_stack_count) {
<a name="l01675"></a>01675         <span class="keywordflow">return</span> thread_recycle_stack_slot[--thread_recycle_stack_count];
<a name="l01676"></a>01676     }
<a name="l01677"></a>01677     <span class="keywordflow">else</span> {
<a name="l01678"></a>01678         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a79041aa2bc7439c11906a86f82a52eb6">ALLOC_N</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>, size);
<a name="l01679"></a>01679     }
<a name="l01680"></a>01680 }
<a name="l01681"></a>01681 
<a name="l01682"></a>01682 <span class="preprocessor">#else</span>
<a name="l01683"></a>01683 <span class="preprocessor"></span><span class="preprocessor">#define thread_recycle_stack(size) ALLOC_N(VALUE, (size))</span>
<a name="l01684"></a>01684 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01685"></a>01685 <span class="preprocessor"></span>
<a name="l01686"></a>01686 <span class="keywordtype">void</span>
<a name="l01687"></a><a class="code" href="../../de/de9/vm_8c.html#a76e16c1e36ad91c284cc727c3b3eccf1">01687</a> <a class="code" href="../../de/de9/vm_8c.html#a76e16c1e36ad91c284cc727c3b3eccf1">rb_thread_recycle_stack_release</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *stack)
<a name="l01688"></a>01688 {
<a name="l01689"></a>01689 <span class="preprocessor">#if USE_THREAD_DATA_RECYCLE</span>
<a name="l01690"></a>01690 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (thread_recycle_stack_count &lt; <a class="code" href="../../de/de9/vm_8c.html#ac482343a3f810e935739993994e26b22">RECYCLE_MAX</a>) {
<a name="l01691"></a>01691         thread_recycle_stack_slot[thread_recycle_stack_count++] = stack;
<a name="l01692"></a>01692         <span class="keywordflow">return</span>;
<a name="l01693"></a>01693     }
<a name="l01694"></a>01694 <span class="preprocessor">#endif</span>
<a name="l01695"></a>01695 <span class="preprocessor"></span>    <a class="code" href="../../d8/d16/gc_8c.html#a0bffec5b2cc004adcebb6802e7620387">ruby_xfree</a>(stack);
<a name="l01696"></a>01696 }
<a name="l01697"></a>01697 
<a name="l01698"></a>01698 <span class="preprocessor">#ifdef USE_THREAD_RECYCLE</span>
<a name="l01699"></a>01699 <span class="preprocessor"></span><span class="keyword">static</span> <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *
<a name="l01700"></a>01700 thread_recycle_struct(<span class="keywordtype">void</span>)
<a name="l01701"></a>01701 {
<a name="l01702"></a>01702     <span class="keywordtype">void</span> *p = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a79041aa2bc7439c11906a86f82a52eb6">ALLOC_N</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a>, 1);
<a name="l01703"></a>01703     memset(p, 0, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a>));
<a name="l01704"></a>01704     <span class="keywordflow">return</span> p;
<a name="l01705"></a>01705 }
<a name="l01706"></a>01706 <span class="preprocessor">#endif</span>
<a name="l01707"></a>01707 <span class="preprocessor"></span>
<a name="l01708"></a>01708 <span class="keywordtype">void</span>
<a name="l01709"></a><a class="code" href="../../de/de9/vm_8c.html#a7c957fc69c5c69c03b72c2723d973c3c">01709</a> <a class="code" href="../../de/de9/vm_8c.html#a7c957fc69c5c69c03b72c2723d973c3c">rb_thread_mark</a>(<span class="keywordtype">void</span> *<a class="code" href="../../d7/dc0/structrb__objspace.html#a450c55a247ef7b5948507a181a5c43d1">ptr</a>)
<a name="l01710"></a>01710 {
<a name="l01711"></a>01711     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01712"></a>01712     <a class="code" href="../../d0/daa/gc_8h.html#a2aa4d10eb84bae94811007f68c795fb7">RUBY_MARK_ENTER</a>(<span class="stringliteral">&quot;thread&quot;</span>);
<a name="l01713"></a>01713     <span class="keywordflow">if</span> (ptr) {
<a name="l01714"></a>01714         th = ptr;
<a name="l01715"></a>01715         <span class="keywordflow">if</span> (th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a>) {
<a name="l01716"></a>01716             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *p = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a>;
<a name="l01717"></a>01717             <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *sp = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a29b331b150e5cae1e206cd87f892bad8">sp</a>;
<a name="l01718"></a>01718             <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>;
<a name="l01719"></a>01719             <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *limit_cfp = (<span class="keywordtype">void</span> *)(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a> + th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1587dec1a575fb9f8d6a689ef4fdb6b5">stack_size</a>);
<a name="l01720"></a>01720 
<a name="l01721"></a>01721             <span class="keywordflow">while</span> (p &lt; sp) {
<a name="l01722"></a>01722                 <a class="code" href="../../d8/d16/gc_8c.html#a98250264e6adf4924cf2becf80122325">rb_gc_mark</a>(*p++);
<a name="l01723"></a>01723             }
<a name="l01724"></a>01724             <a class="code" href="../../d8/d16/gc_8c.html#a90e176b7e9d24053977f64a611c1d8bb">rb_gc_mark_locations</a>(p, p + th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#ae17b699504a6c4780843eac4971b2e98">mark_stack_len</a>);
<a name="l01725"></a>01725 
<a name="l01726"></a>01726             <span class="keywordflow">while</span> (cfp != limit_cfp) {
<a name="l01727"></a>01727                 <a class="code" href="../../d6/de3/structrb__iseq__struct.html">rb_iseq_t</a> *iseq = cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>;
<a name="l01728"></a>01728                 <a class="code" href="../../d8/d16/gc_8c.html#a98250264e6adf4924cf2becf80122325">rb_gc_mark</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aad61bbd9da30e861bfb5fb9669d974cb">proc</a>);
<a name="l01729"></a>01729                 <a class="code" href="../../d8/d16/gc_8c.html#a98250264e6adf4924cf2becf80122325">rb_gc_mark</a>(cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4c11a50358317e1207affd6d7b4ad576">self</a>);
<a name="l01730"></a>01730                 <span class="keywordflow">if</span> (iseq) {
<a name="l01731"></a>01731                     <a class="code" href="../../d8/d16/gc_8c.html#a98250264e6adf4924cf2becf80122325">rb_gc_mark</a>(<a class="code" href="../../d8/d32/vm__core_8h.html#a79d03ad9b9cf8b7a8ca2b849e495a74f">RUBY_VM_NORMAL_ISEQ_P</a>(iseq) ? iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a46d5fb5c3de970a9540ab85d4b060957">self</a> : (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>)iseq);
<a name="l01732"></a>01732                 }
<a name="l01733"></a>01733                 <span class="keywordflow">if</span> (cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aa0ec76f80ebaf0668b688c4e4e5e3e3f">me</a>) ((<a class="code" href="../../d7/db7/structrb__method__entry__struct.html">rb_method_entry_t</a> *)cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#aa0ec76f80ebaf0668b688c4e4e5e3e3f">me</a>)-&gt;mark = 1;
<a name="l01734"></a>01734                 cfp = <a class="code" href="../../d8/d32/vm__core_8h.html#af087c881c3c493e3a4e326852e8ed2a9">RUBY_VM_PREVIOUS_CONTROL_FRAME</a>(cfp);
<a name="l01735"></a>01735             }
<a name="l01736"></a>01736         }
<a name="l01737"></a>01737 
<a name="l01738"></a>01738         <span class="comment">/* mark ruby objects */</span>
<a name="l01739"></a>01739         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#aefaadd717ae62c44343b7bc767db6c5b">first_proc</a>);
<a name="l01740"></a>01740         <span class="keywordflow">if</span> (th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#aefaadd717ae62c44343b7bc767db6c5b">first_proc</a>) <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#ac0efa5cb7f18b285cc3415f47930c4e6">first_args</a>);
<a name="l01741"></a>01741 
<a name="l01742"></a>01742         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fa7c7d516fe265dbbd215eed5da5a20">thgroup</a>);
<a name="l01743"></a>01743         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1b297be9273cc68bd7ec30eb99aada0f">value</a>);
<a name="l01744"></a>01744         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a173e2da61fa57c7044fd7874a8c7a924">errinfo</a>);
<a name="l01745"></a>01745         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a29db283fbadbbc6cbc16533803820cb2">thrown_errinfo</a>);
<a name="l01746"></a>01746         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a4a62159d10487cfda82e358280f10625">local_svar</a>);
<a name="l01747"></a>01747         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#ac0ba34f711c43f831fe95e9a9434353f">top_self</a>);
<a name="l01748"></a>01748         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a63addaa5b39a83e287f7b8747398ab57">top_wrapper</a>);
<a name="l01749"></a>01749         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#ad4f0d497c78f3ab7f172d67c6b202b18">fiber</a>);
<a name="l01750"></a>01750         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#aabd5971200cda279bd826c2bd00f870f">root_fiber</a>);
<a name="l01751"></a>01751         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3c9e667590cfe18b655cbe812e04d643">stat_insn_usage</a>);
<a name="l01752"></a>01752         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a02e6343202cb5994463c33da7ed38c4f">last_status</a>);
<a name="l01753"></a>01753 
<a name="l01754"></a>01754         <a class="code" href="../../d0/daa/gc_8h.html#afad3c58fae104a867be4305d1f96414a">RUBY_MARK_UNLESS_NULL</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#ab0435aec1daf59ef6caceee7004a7cfb">locking_mutex</a>);
<a name="l01755"></a>01755 
<a name="l01756"></a>01756         <a class="code" href="../../d8/d16/gc_8c.html#a6b9a51387748f1a94f4d77092163aa3a">rb_mark_tbl</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#af1ef1ecd85eec7b4809f81151ade5248">local_storage</a>);
<a name="l01757"></a>01757 
<a name="l01758"></a>01758         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>() != th &amp;&amp; th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a004e79191ba26ebbdc62ea9f77039f1b">machine_stack_start</a> &amp;&amp; th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a510cac166812798b8548fe541020667f">machine_stack_end</a>) {
<a name="l01759"></a>01759             <a class="code" href="../../d8/d16/gc_8c.html#a4c2152009e465bf40a157fa23dfcc92e">rb_gc_mark_machine_stack</a>(th);
<a name="l01760"></a>01760             <a class="code" href="../../d8/d16/gc_8c.html#a90e176b7e9d24053977f64a611c1d8bb">rb_gc_mark_locations</a>((<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *)&amp;th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a7863ca61434f5835cbe70aa14b0273c1">machine_regs</a>,
<a name="l01761"></a>01761                                  (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *)(&amp;th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a7863ca61434f5835cbe70aa14b0273c1">machine_regs</a>) +
<a name="l01762"></a>01762                                  <span class="keyword">sizeof</span>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a7863ca61434f5835cbe70aa14b0273c1">machine_regs</a>) / <span class="keyword">sizeof</span>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>));
<a name="l01763"></a>01763         }
<a name="l01764"></a>01764 
<a name="l01765"></a>01765         <a class="code" href="../../de/de9/vm_8c.html#a24b81b57763993a6328a2451562e5995">mark_event_hooks</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#aa368906b4d6c4d26dc7f649b7c8fb6ab">event_hooks</a>);
<a name="l01766"></a>01766     }
<a name="l01767"></a>01767 
<a name="l01768"></a>01768     <a class="code" href="../../d0/daa/gc_8h.html#a036115d8c044f5c847e760c57b08e5a9">RUBY_MARK_LEAVE</a>(<span class="stringliteral">&quot;thread&quot;</span>);
<a name="l01769"></a>01769 }
<a name="l01770"></a>01770 
<a name="l01771"></a>01771 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01772"></a><a class="code" href="../../de/de9/vm_8c.html#afa313ee08837bb9545102cd3f28d91a7">01772</a> <a class="code" href="../../de/de9/vm_8c.html#afa313ee08837bb9545102cd3f28d91a7">thread_free</a>(<span class="keywordtype">void</span> *<a class="code" href="../../d7/dc0/structrb__objspace.html#a450c55a247ef7b5948507a181a5c43d1">ptr</a>)
<a name="l01773"></a>01773 {
<a name="l01774"></a>01774     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th;
<a name="l01775"></a>01775     <a class="code" href="../../d0/daa/gc_8h.html#a5d959738efb454623a7dad84d728262a">RUBY_FREE_ENTER</a>(<span class="stringliteral">&quot;thread&quot;</span>);
<a name="l01776"></a>01776 
<a name="l01777"></a>01777     <span class="keywordflow">if</span> (ptr) {
<a name="l01778"></a>01778         th = ptr;
<a name="l01779"></a>01779 
<a name="l01780"></a>01780         <span class="keywordflow">if</span> (!th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#aabd5971200cda279bd826c2bd00f870f">root_fiber</a>) {
<a name="l01781"></a>01781             <a class="code" href="../../d0/daa/gc_8h.html#a904b1cd50d09d6c8ae915c78e425420a">RUBY_FREE_UNLESS_NULL</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a>);
<a name="l01782"></a>01782         }
<a name="l01783"></a>01783 
<a name="l01784"></a>01784         <span class="keywordflow">if</span> (th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#ab0435aec1daf59ef6caceee7004a7cfb">locking_mutex</a> != <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>) {
<a name="l01785"></a>01785             <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;thread_free: locking_mutex must be NULL (%p:%p)&quot;</span>, (<span class="keywordtype">void</span> *)th, (<span class="keywordtype">void</span> *)th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#ab0435aec1daf59ef6caceee7004a7cfb">locking_mutex</a>);
<a name="l01786"></a>01786         }
<a name="l01787"></a>01787         <span class="keywordflow">if</span> (th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#adb11d95769dc97f821331399fd45a586">keeping_mutexes</a> != <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>) {
<a name="l01788"></a>01788             <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;thread_free: keeping_mutexes must be NULL (%p:%p)&quot;</span>, (<span class="keywordtype">void</span> *)th, (<span class="keywordtype">void</span> *)th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#adb11d95769dc97f821331399fd45a586">keeping_mutexes</a>);
<a name="l01789"></a>01789         }
<a name="l01790"></a>01790 
<a name="l01791"></a>01791         <span class="keywordflow">if</span> (th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#af1ef1ecd85eec7b4809f81151ade5248">local_storage</a>) {
<a name="l01792"></a>01792             <a class="code" href="../../dd/d24/st_8h.html#acb004847ef312373d65bfb0d1a21c5b3">st_free_table</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#af1ef1ecd85eec7b4809f81151ade5248">local_storage</a>);
<a name="l01793"></a>01793         }
<a name="l01794"></a>01794 
<a name="l01795"></a>01795         <span class="keywordflow">if</span> (th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3e7d0b05e2d73f324e70c735ba50739e">vm</a> &amp;&amp; th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3e7d0b05e2d73f324e70c735ba50739e">vm</a>-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a55af19560794b67c09c608a8464e47c9">main_thread</a> == th) {
<a name="l01796"></a>01796             <a class="code" href="../../d0/daa/gc_8h.html#a634fb573223a0ffb428332fc45916fc6">RUBY_GC_INFO</a>(<span class="stringliteral">&quot;main thread\n&quot;</span>);
<a name="l01797"></a>01797         }
<a name="l01798"></a>01798         <span class="keywordflow">else</span> {
<a name="l01799"></a>01799 <span class="preprocessor">#ifdef USE_SIGALTSTACK</span>
<a name="l01800"></a>01800 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (th-&gt;altstack) {
<a name="l01801"></a>01801                 <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(th-&gt;altstack);
<a name="l01802"></a>01802             }
<a name="l01803"></a>01803 <span class="preprocessor">#endif</span>
<a name="l01804"></a>01804 <span class="preprocessor"></span>            <a class="code" href="../../d8/d16/gc_8c.html#a0bffec5b2cc004adcebb6802e7620387">ruby_xfree</a>(ptr);
<a name="l01805"></a>01805         }
<a name="l01806"></a>01806         <span class="keywordflow">if</span> (ruby_current_thread == th)
<a name="l01807"></a>01807             ruby_current_thread = <a class="code" href="../../d3/d09/ripper_8y.html#a070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>;
<a name="l01808"></a>01808     }
<a name="l01809"></a>01809     <a class="code" href="../../d0/daa/gc_8h.html#af304d34de3474d75064e0cba170b7bf5">RUBY_FREE_LEAVE</a>(<span class="stringliteral">&quot;thread&quot;</span>);
<a name="l01810"></a>01810 }
<a name="l01811"></a>01811 
<a name="l01812"></a>01812 <span class="keyword">static</span> <span class="keywordtype">size_t</span>
<a name="l01813"></a><a class="code" href="../../de/de9/vm_8c.html#ae13ac094cd9fdca07b8abed66a9fd5c1">01813</a> <a class="code" href="../../de/de9/vm_8c.html#ae13ac094cd9fdca07b8abed66a9fd5c1">thread_memsize</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="../../d7/dc0/structrb__objspace.html#a450c55a247ef7b5948507a181a5c43d1">ptr</a>)
<a name="l01814"></a>01814 {
<a name="l01815"></a>01815     <span class="keywordflow">if</span> (ptr) {
<a name="l01816"></a>01816         <span class="keyword">const</span> <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = ptr;
<a name="l01817"></a>01817         <span class="keywordtype">size_t</span> <a class="code" href="../../d5/db5/encoding_8c.html#a439227feff9d7f55384e8780cfc2eb82">size</a> = <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a>);
<a name="l01818"></a>01818 
<a name="l01819"></a>01819         <span class="keywordflow">if</span> (!th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#aabd5971200cda279bd826c2bd00f870f">root_fiber</a>) {
<a name="l01820"></a>01820             size += th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1587dec1a575fb9f8d6a689ef4fdb6b5">stack_size</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>);
<a name="l01821"></a>01821         }
<a name="l01822"></a>01822         <span class="keywordflow">if</span> (th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#af1ef1ecd85eec7b4809f81151ade5248">local_storage</a>) {
<a name="l01823"></a>01823             size += <a class="code" href="../../dd/d24/st_8h.html#a1d0d955fb1f39486c18162f222deb82b">st_memsize</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#af1ef1ecd85eec7b4809f81151ade5248">local_storage</a>);
<a name="l01824"></a>01824         }
<a name="l01825"></a>01825         <span class="keywordflow">return</span> size;
<a name="l01826"></a>01826     }
<a name="l01827"></a>01827     <span class="keywordflow">else</span> {
<a name="l01828"></a>01828         <span class="keywordflow">return</span> 0;
<a name="l01829"></a>01829     }
<a name="l01830"></a>01830 }
<a name="l01831"></a>01831 
<a name="l01832"></a><a class="code" href="../../de/de9/vm_8c.html#a27ed80c29d1a854ccaa4ae2aa3ef6769">01832</a> <span class="preprocessor">#define thread_data_type ruby_threadptr_data_type</span>
<a name="l01833"></a><a class="code" href="../../d8/d32/vm__core_8h.html#a0310d690f45eb1cba3a726e36c65385b">01833</a> <span class="preprocessor"></span><span class="keyword">const</span> <a class="code" href="../../d7/de2/structrb__data__type__struct.html">rb_data_type_t</a> <a class="code" href="../../de/de9/vm_8c.html#a0310d690f45eb1cba3a726e36c65385b">ruby_threadptr_data_type</a> = {
<a name="l01834"></a>01834     <span class="stringliteral">&quot;VM/thread&quot;</span>,
<a name="l01835"></a>01835     {
<a name="l01836"></a>01836         <a class="code" href="../../de/de9/vm_8c.html#a7c957fc69c5c69c03b72c2723d973c3c">rb_thread_mark</a>,
<a name="l01837"></a>01837         <a class="code" href="../../de/de9/vm_8c.html#afa313ee08837bb9545102cd3f28d91a7">thread_free</a>,
<a name="l01838"></a>01838         <a class="code" href="../../de/de9/vm_8c.html#ae13ac094cd9fdca07b8abed66a9fd5c1">thread_memsize</a>,
<a name="l01839"></a>01839     },
<a name="l01840"></a>01840 };
<a name="l01841"></a>01841 
<a name="l01842"></a>01842 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01843"></a><a class="code" href="../../de/de9/vm_8c.html#a7eda924b79844f890f5ba44800c1c520">01843</a> <a class="code" href="../../de/de9/vm_8c.html#a7eda924b79844f890f5ba44800c1c520">rb_obj_is_thread</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj)
<a name="l01844"></a>01844 {
<a name="l01845"></a>01845     <span class="keywordflow">if</span> (<a class="code" href="../../db/dcc/error_8c.html#a2a5803d0e60feb0ed8f37e7a38e8df47">rb_typeddata_is_kind_of</a>(obj, &amp;<a class="code" href="../../de/de9/vm_8c.html#a27ed80c29d1a854ccaa4ae2aa3ef6769">thread_data_type</a>)) {
<a name="l01846"></a>01846         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aacea3516b33941ce8149098e223a7466">Qtrue</a>;
<a name="l01847"></a>01847     }
<a name="l01848"></a>01848     <span class="keywordflow">else</span> {
<a name="l01849"></a>01849         <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aba0717d2689eb68797421a02ab9295c6">Qfalse</a>;
<a name="l01850"></a>01850     }
<a name="l01851"></a>01851 }
<a name="l01852"></a>01852 
<a name="l01853"></a>01853 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01854"></a><a class="code" href="../../de/de9/vm_8c.html#ab4e70e1584b736c0698101beabd2a2bd">01854</a> <a class="code" href="../../de/de9/vm_8c.html#ab4e70e1584b736c0698101beabd2a2bd">thread_alloc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass)
<a name="l01855"></a>01855 {
<a name="l01856"></a>01856     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">volatile</span> obj;
<a name="l01857"></a>01857 <span class="preprocessor">#ifdef USE_THREAD_RECYCLE</span>
<a name="l01858"></a>01858 <span class="preprocessor"></span>    <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = thread_recycle_struct();
<a name="l01859"></a>01859     obj = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa3094c0054b80ec2a7e50f9fe1e5f4b2">TypedData_Wrap_Struct</a>(klass, &amp;<a class="code" href="../../de/de9/vm_8c.html#a27ed80c29d1a854ccaa4ae2aa3ef6769">thread_data_type</a>, th);
<a name="l01860"></a>01860 <span class="preprocessor">#else</span>
<a name="l01861"></a>01861 <span class="preprocessor"></span>    <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th;
<a name="l01862"></a>01862     obj = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#acb14aa93d3dc60a9d16570270154e6fa">TypedData_Make_Struct</a>(klass, <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a>, &amp;<a class="code" href="../../de/de9/vm_8c.html#a27ed80c29d1a854ccaa4ae2aa3ef6769">thread_data_type</a>, th);
<a name="l01863"></a>01863 <span class="preprocessor">#endif</span>
<a name="l01864"></a>01864 <span class="preprocessor"></span>    <span class="keywordflow">return</span> obj;
<a name="l01865"></a>01865 }
<a name="l01866"></a>01866 
<a name="l01867"></a>01867 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01868"></a><a class="code" href="../../de/de9/vm_8c.html#a8254b2c9550e30be25c3115308865c28">01868</a> <a class="code" href="../../de/de9/vm_8c.html#a8254b2c9550e30be25c3115308865c28">th_init</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01869"></a>01869 {
<a name="l01870"></a>01870     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a6e712e6c5295a4173188139f1d6b7462">self</a> = <span class="keyword">self</span>;
<a name="l01871"></a>01871 
<a name="l01872"></a>01872     <span class="comment">/* allocate thread stack */</span>
<a name="l01873"></a>01873 <span class="preprocessor">#ifdef USE_SIGALTSTACK</span>
<a name="l01874"></a>01874 <span class="preprocessor"></span>    <span class="comment">/* altstack of main thread is reallocated in another place */</span>
<a name="l01875"></a>01875     th-&gt;altstack = <a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(<a class="code" href="../../d8/d32/vm__core_8h.html#aca50bfb7be201e098951bf4ec357f5c2">ALT_STACK_SIZE</a>);
<a name="l01876"></a>01876 <span class="preprocessor">#endif</span>
<a name="l01877"></a>01877 <span class="preprocessor"></span>    th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1587dec1a575fb9f8d6a689ef4fdb6b5">stack_size</a> = <a class="code" href="../../d8/d32/vm__core_8h.html#a018f55ffc774044f51407f692f07c0d3">RUBY_VM_THREAD_STACK_SIZE</a>;
<a name="l01878"></a>01878     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a> = <a class="code" href="../../de/de9/vm_8c.html#a2abade868818c379135d2eb27c104f85">thread_recycle_stack</a>(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1587dec1a575fb9f8d6a689ef4fdb6b5">stack_size</a>);
<a name="l01879"></a>01879 
<a name="l01880"></a>01880     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a> = (<span class="keywordtype">void</span> *)(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a> + th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1587dec1a575fb9f8d6a689ef4fdb6b5">stack_size</a>);
<a name="l01881"></a>01881 
<a name="l01882"></a>01882     <a class="code" href="../../d0/db2/vm__insnhelper_8c.html#a30340566da5743c4d660c8931dffd86e">vm_push_frame</a>(th, 0, <a class="code" href="../../d8/d32/vm__core_8h.html#ac9390ef02c17a0bc7e3bd359264562c7">VM_FRAME_MAGIC_TOP</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>, 0, 0,
<a name="l01883"></a>01883                   th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a>, 0, 1);
<a name="l01884"></a>01884 
<a name="l01885"></a>01885     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a647ed2a802789fff9e511bea4ada1239">status</a> = <a class="code" href="../../d8/d32/vm__core_8h.html#a027718c64d1aa742ccdb9c1a68afaa75a7b74b43e0bf953520175df870c5aef3c">THREAD_RUNNABLE</a>;
<a name="l01886"></a>01886     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a173e2da61fa57c7044fd7874a8c7a924">errinfo</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01887"></a>01887     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a02e6343202cb5994463c33da7ed38c4f">last_status</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01888"></a>01888     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a8ddade0070cf5af8034e1549e30839fb">waiting_fd</a> = -1;
<a name="l01889"></a>01889 }
<a name="l01890"></a>01890 
<a name="l01891"></a>01891 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01892"></a><a class="code" href="../../de/de9/vm_8c.html#aaa1408f30b8f6129882c3f99355e63cf">01892</a> <a class="code" href="../../de/de9/vm_8c.html#aaa1408f30b8f6129882c3f99355e63cf">ruby_thread_init</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>)
<a name="l01893"></a>01893 {
<a name="l01894"></a>01894     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th;
<a name="l01895"></a>01895     <a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vm = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>()-&gt;vm;
<a name="l01896"></a>01896     <a class="code" href="../../d8/d32/vm__core_8h.html#a36e942386b2b43383c44e769bffe5808">GetThreadPtr</a>(<span class="keyword">self</span>, th);
<a name="l01897"></a>01897 
<a name="l01898"></a>01898     <a class="code" href="../../de/de9/vm_8c.html#a8254b2c9550e30be25c3115308865c28">th_init</a>(th, <span class="keyword">self</span>);
<a name="l01899"></a>01899     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3e7d0b05e2d73f324e70c735ba50739e">vm</a> = vm;
<a name="l01900"></a>01900 
<a name="l01901"></a>01901     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a63addaa5b39a83e287f7b8747398ab57">top_wrapper</a> = 0;
<a name="l01902"></a>01902     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#ac0ba34f711c43f831fe95e9a9434353f">top_self</a> = <a class="code" href="../../dd/dd0/eval__intern_8h.html#aa1fe1e87b9459fc45f42b15a0600611a">rb_vm_top_self</a>();
<a name="l01903"></a>01903     <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l01904"></a>01904 }
<a name="l01905"></a>01905 
<a name="l01906"></a>01906 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01907"></a><a class="code" href="../../d8/d32/vm__core_8h.html#a914b7151a013f7fc163b7024cb00ac87">01907</a> <a class="code" href="../../de/de9/vm_8c.html#a914b7151a013f7fc163b7024cb00ac87">rb_thread_alloc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass)
<a name="l01908"></a>01908 {
<a name="l01909"></a>01909     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span> = <a class="code" href="../../de/de9/vm_8c.html#ab4e70e1584b736c0698101beabd2a2bd">thread_alloc</a>(klass);
<a name="l01910"></a>01910     <a class="code" href="../../de/de9/vm_8c.html#aaa1408f30b8f6129882c3f99355e63cf">ruby_thread_init</a>(<span class="keyword">self</span>);
<a name="l01911"></a>01911     <span class="keywordflow">return</span> <span class="keyword">self</span>;
<a name="l01912"></a>01912 }
<a name="l01913"></a>01913 
<a name="l01914"></a>01914 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01915"></a><a class="code" href="../../de/de9/vm_8c.html#a469ecc9b7152b6bb8e3589ca48141f5e">01915</a> <a class="code" href="../../de/de9/vm_8c.html#a469ecc9b7152b6bb8e3589ca48141f5e">vm_define_method</a>(<a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#afa5b9137f051ac26d7ccc8824f178233">ID</a> <span class="keywordtype">id</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> iseqval,
<a name="l01916"></a>01916                  <a class="code" href="../../d8/d32/vm__core_8h.html#afa3629f5cb977b24532d09e1aa055e4a">rb_num_t</a> is_singleton, NODE *cref)
<a name="l01917"></a>01917 {
<a name="l01918"></a>01918     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass = cref-&gt;nd_clss;
<a name="l01919"></a>01919     <span class="keywordtype">int</span> noex = (int)cref-&gt;nd_visi;
<a name="l01920"></a>01920     <a class="code" href="../../d6/de3/structrb__iseq__struct.html">rb_iseq_t</a> *miseq;
<a name="l01921"></a>01921     <a class="code" href="../../d8/d32/vm__core_8h.html#a5e6a3515e0ad9b9d6a4c0ab577dc50b6">GetISeqPtr</a>(iseqval, miseq);
<a name="l01922"></a>01922 
<a name="l01923"></a>01923     <span class="keywordflow">if</span> (miseq-&gt;klass) {
<a name="l01924"></a>01924         iseqval = <a class="code" href="../../de/ddf/group__class.html#gad44e50d3f03c58fa8d5e4e50558df898">rb_iseq_clone</a>(iseqval, 0);
<a name="l01925"></a>01925         <a class="code" href="../../d8/df4/generator_8h.html#ad2bf389f3fddea7bd3befa162c70561a">RB_GC_GUARD</a>(iseqval);
<a name="l01926"></a>01926         <a class="code" href="../../d8/d32/vm__core_8h.html#a5e6a3515e0ad9b9d6a4c0ab577dc50b6">GetISeqPtr</a>(iseqval, miseq);
<a name="l01927"></a>01927     }
<a name="l01928"></a>01928 
<a name="l01929"></a>01929     <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a4832bad8845a35fc50f7a160901854a1">NIL_P</a>(klass)) {
<a name="l01930"></a>01930         <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a565ed9d70f4089e1b4a36e9b3381b8c6">rb_eTypeError</a>, <span class="stringliteral">&quot;no class/module to add method&quot;</span>);
<a name="l01931"></a>01931     }
<a name="l01932"></a>01932 
<a name="l01933"></a>01933     <span class="keywordflow">if</span> (is_singleton) {
<a name="l01934"></a>01934         <span class="keywordflow">if</span> (<a class="code" href="../../de/de6/ruby_2ruby_8h.html#acf2fcf97dcf9c7c35452730eb3e2aeb2">FIXNUM_P</a>(obj) || <a class="code" href="../../dc/d0c/cparse_8c.html#a637bc5a232034ee3fd411f8bef091566">SYMBOL_P</a>(obj)) {
<a name="l01935"></a>01935             <a class="code" href="../../db/dcc/error_8c.html#a0f771a2840561f1838169b3d7d4616f3">rb_raise</a>(<a class="code" href="../../db/dcc/error_8c.html#a565ed9d70f4089e1b4a36e9b3381b8c6">rb_eTypeError</a>,
<a name="l01936"></a>01936                      <span class="stringliteral">&quot;can&apos;t define singleton method \&quot;%s\&quot; for %s&quot;</span>,
<a name="l01937"></a>01937                      <a class="code" href="../../d5/d11/ripper_8c.html#a877bc58c495643fcf49dc64c44631e72">rb_id2name</a>(<span class="keywordtype">id</span>), <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a9b4f42ada717bfbe7a78830639476aed">rb_obj_classname</a>(obj));
<a name="l01938"></a>01938         }
<a name="l01939"></a>01939 
<a name="l01940"></a>01940         <a class="code" href="../../db/d2e/intern_8h.html#a372d6acb27d271ee4fc2e88c7022c485">rb_check_frozen</a>(obj);
<a name="l01941"></a>01941         klass = <a class="code" href="../../de/ddf/group__class.html#ga3778543a2798adab7bc12ed325c0b5d0" title="Returns the singleton class of obj.">rb_singleton_class</a>(obj);
<a name="l01942"></a>01942         noex = <a class="code" href="../../db/d0a/method_8h.html#a1e54ff32a6191e40451e1523c61ca439acbaffd02a49dab8af6ca3bcde9336f30">NOEX_PUBLIC</a>;
<a name="l01943"></a>01943     }
<a name="l01944"></a>01944 
<a name="l01945"></a>01945     <span class="comment">/* dup */</span>
<a name="l01946"></a>01946     <a class="code" href="../../d2/d5f/vm__insnhelper_8h.html#adc65dee2ab1f2e022731b16355888ecb">COPY_CREF</a>(miseq-&gt;cref_stack, cref);
<a name="l01947"></a>01947     miseq-&gt;cref_stack-&gt;nd_visi = <a class="code" href="../../db/d0a/method_8h.html#a1e54ff32a6191e40451e1523c61ca439acbaffd02a49dab8af6ca3bcde9336f30">NOEX_PUBLIC</a>;
<a name="l01948"></a>01948     miseq-&gt;klass = klass;
<a name="l01949"></a>01949     miseq-&gt;defined_method_id = id;
<a name="l01950"></a>01950     <a class="code" href="../../db/d0a/method_8h.html#af24b4bc2104eeb955b312d41bb492c5c">rb_add_method</a>(klass, <span class="keywordtype">id</span>, <a class="code" href="../../db/d0a/method_8h.html#a88a981f6cc69187ed9c2de2630a1687aa09fd70c8c3426502348b7df7c121e505">VM_METHOD_TYPE_ISEQ</a>, miseq, noex);
<a name="l01951"></a>01951 
<a name="l01952"></a>01952     <span class="keywordflow">if</span> (!is_singleton &amp;&amp; noex == <a class="code" href="../../db/d0a/method_8h.html#a1e54ff32a6191e40451e1523c61ca439a50775b7233e9bb462c3703a6511e02d1">NOEX_MODFUNC</a>) {
<a name="l01953"></a>01953         <a class="code" href="../../db/d0a/method_8h.html#af24b4bc2104eeb955b312d41bb492c5c">rb_add_method</a>(<a class="code" href="../../de/ddf/group__class.html#ga3778543a2798adab7bc12ed325c0b5d0" title="Returns the singleton class of obj.">rb_singleton_class</a>(klass), <span class="keywordtype">id</span>, <a class="code" href="../../db/d0a/method_8h.html#a88a981f6cc69187ed9c2de2630a1687aa09fd70c8c3426502348b7df7c121e505">VM_METHOD_TYPE_ISEQ</a>, miseq, <a class="code" href="../../db/d0a/method_8h.html#a1e54ff32a6191e40451e1523c61ca439acbaffd02a49dab8af6ca3bcde9336f30">NOEX_PUBLIC</a>);
<a name="l01954"></a>01954     }
<a name="l01955"></a>01955     <a class="code" href="../../d2/d5f/vm__insnhelper_8h.html#a8e91da0eaddd34a78c8f9c5207df8979">INC_VM_STATE_VERSION</a>();
<a name="l01956"></a>01956 }
<a name="l01957"></a>01957 
<a name="l01958"></a><a class="code" href="../../de/de9/vm_8c.html#aa41b42017c8091c664dea5ed30fe9c5c">01958</a> <span class="preprocessor">#define REWIND_CFP(expr) do { \</span>
<a name="l01959"></a>01959 <span class="preprocessor">    rb_thread_t *th__ = GET_THREAD(); \</span>
<a name="l01960"></a>01960 <span class="preprocessor">    th__-&gt;cfp++; expr; th__-&gt;cfp--; \</span>
<a name="l01961"></a>01961 <span class="preprocessor">} while (0)</span>
<a name="l01962"></a>01962 <span class="preprocessor"></span>
<a name="l01963"></a>01963 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01964"></a><a class="code" href="../../de/de9/vm_8c.html#a31455d8d3483e811bf2dfe55220e0a2d">01964</a> <a class="code" href="../../de/de9/vm_8c.html#a31455d8d3483e811bf2dfe55220e0a2d">m_core_define_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> cbase, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dd/dc0/date__core_8c.html#a8157485e687f56a6ae2f3ee0a8cb1580">sym</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> iseqval)
<a name="l01965"></a>01965 {
<a name="l01966"></a>01966     <a class="code" href="../../de/de9/vm_8c.html#aa41b42017c8091c664dea5ed30fe9c5c">REWIND_CFP</a>({
<a name="l01967"></a>01967         <a class="code" href="../../de/de9/vm_8c.html#a469ecc9b7152b6bb8e3589ca48141f5e">vm_define_method</a>(<a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>(), cbase, <a class="code" href="../../dc/d0c/cparse_8c.html#a73ce5202e6172d3ad0bab7d1e0df9dae">SYM2ID</a>(sym), iseqval, 0, <a class="code" href="../../dd/dd0/eval__intern_8h.html#a148afe59d50d9a0f3bde4d9968d8a2f5">rb_vm_cref</a>());
<a name="l01968"></a>01968     });
<a name="l01969"></a>01969     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01970"></a>01970 }
<a name="l01971"></a>01971 
<a name="l01972"></a>01972 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01973"></a><a class="code" href="../../de/de9/vm_8c.html#af6daaa3b312cda0a07c1c06b2608d4dc">01973</a> <a class="code" href="../../de/de9/vm_8c.html#af6daaa3b312cda0a07c1c06b2608d4dc">m_core_define_singleton_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> cbase, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dd/dc0/date__core_8c.html#a8157485e687f56a6ae2f3ee0a8cb1580">sym</a>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> iseqval)
<a name="l01974"></a>01974 {
<a name="l01975"></a>01975     <a class="code" href="../../de/de9/vm_8c.html#aa41b42017c8091c664dea5ed30fe9c5c">REWIND_CFP</a>({
<a name="l01976"></a>01976         <a class="code" href="../../de/de9/vm_8c.html#a469ecc9b7152b6bb8e3589ca48141f5e">vm_define_method</a>(<a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>(), cbase, <a class="code" href="../../dc/d0c/cparse_8c.html#a73ce5202e6172d3ad0bab7d1e0df9dae">SYM2ID</a>(sym), iseqval, 1, <a class="code" href="../../dd/dd0/eval__intern_8h.html#a148afe59d50d9a0f3bde4d9968d8a2f5">rb_vm_cref</a>());
<a name="l01977"></a>01977     });
<a name="l01978"></a>01978     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01979"></a>01979 }
<a name="l01980"></a>01980 
<a name="l01981"></a>01981 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01982"></a><a class="code" href="../../de/de9/vm_8c.html#ab5b731afdd8e86459bd5ddbc587c8a1c">01982</a> <a class="code" href="../../de/de9/vm_8c.html#ab5b731afdd8e86459bd5ddbc587c8a1c">m_core_set_method_alias</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> cbase, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> sym1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> sym2)
<a name="l01983"></a>01983 {
<a name="l01984"></a>01984     <a class="code" href="../../de/de9/vm_8c.html#aa41b42017c8091c664dea5ed30fe9c5c">REWIND_CFP</a>({
<a name="l01985"></a>01985         <a class="code" href="../../db/d2e/intern_8h.html#a875565385e4542e217883aa78ede3a67">rb_alias</a>(cbase, <a class="code" href="../../dc/d0c/cparse_8c.html#a73ce5202e6172d3ad0bab7d1e0df9dae">SYM2ID</a>(sym1), <a class="code" href="../../dc/d0c/cparse_8c.html#a73ce5202e6172d3ad0bab7d1e0df9dae">SYM2ID</a>(sym2));
<a name="l01986"></a>01986     });
<a name="l01987"></a>01987     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01988"></a>01988 }
<a name="l01989"></a>01989 
<a name="l01990"></a>01990 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l01991"></a><a class="code" href="../../de/de9/vm_8c.html#aa775eb74347f7cde2375d8c694ff47aa">01991</a> <a class="code" href="../../de/de9/vm_8c.html#aa775eb74347f7cde2375d8c694ff47aa">m_core_set_variable_alias</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> sym1, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> sym2)
<a name="l01992"></a>01992 {
<a name="l01993"></a>01993     <a class="code" href="../../de/de9/vm_8c.html#aa41b42017c8091c664dea5ed30fe9c5c">REWIND_CFP</a>({
<a name="l01994"></a>01994         <a class="code" href="../../db/d2e/intern_8h.html#ab8ed493136ffbe39cfc3fca62eced570">rb_alias_variable</a>(<a class="code" href="../../dc/d0c/cparse_8c.html#a73ce5202e6172d3ad0bab7d1e0df9dae">SYM2ID</a>(sym1), <a class="code" href="../../dc/d0c/cparse_8c.html#a73ce5202e6172d3ad0bab7d1e0df9dae">SYM2ID</a>(sym2));
<a name="l01995"></a>01995     });
<a name="l01996"></a>01996     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l01997"></a>01997 }
<a name="l01998"></a>01998 
<a name="l01999"></a>01999 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02000"></a><a class="code" href="../../de/de9/vm_8c.html#a8a84999770916c4cc41113421fee2233">02000</a> <a class="code" href="../../de/de9/vm_8c.html#a8a84999770916c4cc41113421fee2233">m_core_undef_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> cbase, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <a class="code" href="../../dd/dc0/date__core_8c.html#a8157485e687f56a6ae2f3ee0a8cb1580">sym</a>)
<a name="l02001"></a>02001 {
<a name="l02002"></a>02002     <a class="code" href="../../de/de9/vm_8c.html#aa41b42017c8091c664dea5ed30fe9c5c">REWIND_CFP</a>({
<a name="l02003"></a>02003         <a class="code" href="../../db/d2e/intern_8h.html#a05cac3059504774696c1a748ba6085d3">rb_undef</a>(cbase, <a class="code" href="../../dc/d0c/cparse_8c.html#a73ce5202e6172d3ad0bab7d1e0df9dae">SYM2ID</a>(sym));
<a name="l02004"></a>02004         <a class="code" href="../../d2/d5f/vm__insnhelper_8h.html#a8e91da0eaddd34a78c8f9c5207df8979">INC_VM_STATE_VERSION</a>();
<a name="l02005"></a>02005     });
<a name="l02006"></a>02006     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02007"></a>02007 }
<a name="l02008"></a>02008 
<a name="l02009"></a>02009 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02010"></a><a class="code" href="../../de/de9/vm_8c.html#aba01cea003dce480ff70e17597990208">02010</a> <a class="code" href="../../de/de9/vm_8c.html#aba01cea003dce480ff70e17597990208">m_core_set_postexe</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> <span class="keyword">self</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> iseqval)
<a name="l02011"></a>02011 {
<a name="l02012"></a>02012     <a class="code" href="../../de/de9/vm_8c.html#aa41b42017c8091c664dea5ed30fe9c5c">REWIND_CFP</a>({
<a name="l02013"></a>02013         <a class="code" href="../../d6/de3/structrb__iseq__struct.html">rb_iseq_t</a> *blockiseq;
<a name="l02014"></a>02014         <a class="code" href="../../da/dc0/structrb__block__struct.html">rb_block_t</a> *blockptr;
<a name="l02015"></a>02015         <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l02016"></a>02016         <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp = <a class="code" href="../../de/de9/vm_8c.html#a2709ccd7eeff81c0f749a7678223857e">rb_vm_get_ruby_level_next_cfp</a>(th, th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>);
<a name="l02017"></a>02017         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> proc;
<a name="l02018"></a>02018 
<a name="l02019"></a>02019         <span class="keywordflow">if</span> (cfp == 0) {
<a name="l02020"></a>02020             <a class="code" href="../../db/dcc/error_8c.html#a2d5fb28e54f792e7341b2c45f52f3860">rb_bug</a>(<span class="stringliteral">&quot;m_core_set_postexe: unreachable&quot;</span>);
<a name="l02021"></a>02021         }
<a name="l02022"></a>02022 
<a name="l02023"></a>02023         <a class="code" href="../../d8/d32/vm__core_8h.html#a5e6a3515e0ad9b9d6a4c0ab577dc50b6">GetISeqPtr</a>(iseqval, blockiseq);
<a name="l02024"></a>02024 
<a name="l02025"></a>02025         blockptr = <a class="code" href="../../d8/d32/vm__core_8h.html#acfa2a173f2b08fdbe1045d2c990200d3">RUBY_VM_GET_BLOCK_PTR_IN_CFP</a>(cfp);
<a name="l02026"></a>02026         blockptr-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#a8e2b3b9218b4a184f198872404e81605">iseq</a> = blockiseq;
<a name="l02027"></a>02027         blockptr-&gt;<a class="code" href="../../da/dc0/structrb__block__struct.html#a305ea0fcc6d1233de416bd8e7edab218">proc</a> = 0;
<a name="l02028"></a>02028 
<a name="l02029"></a>02029         proc = <a class="code" href="../../de/de9/vm_8c.html#a7e8d71dee905abc403d671561b12f4e8">rb_vm_make_proc</a>(th, blockptr, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#abd0d5fa9d171dbf020e85958391437f9">rb_cProc</a>);
<a name="l02030"></a>02030         <a class="code" href="../../d6/d9b/eval__jump_8c.html#a59c976d93f8b1b2766e4fe7e01ac1ee7">rb_set_end_proc</a>(<a class="code" href="../../d6/d9b/eval__jump_8c.html#aa4edbe2aeb4e47e6bd22bd2b3f6d8ba8">rb_call_end_proc</a>, proc);
<a name="l02031"></a>02031     });
<a name="l02032"></a>02032     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02033"></a>02033 }
<a name="l02034"></a>02034 
<a name="l02035"></a>02035 <span class="keyword">extern</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *<a class="code" href="../../de/de9/vm_8c.html#aa1a13d72336a9859fa7c70bcde97b4f9">rb_gc_stack_start</a>;
<a name="l02036"></a>02036 <span class="keyword">extern</span> <span class="keywordtype">size_t</span> <a class="code" href="../../de/de9/vm_8c.html#ad53ef65d4a92f8337548b752d4b44b9e">rb_gc_stack_maxsize</a>;
<a name="l02037"></a>02037 <span class="preprocessor">#ifdef __ia64</span>
<a name="l02038"></a>02038 <span class="preprocessor"></span><span class="keyword">extern</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *rb_gc_register_stack_start;
<a name="l02039"></a>02039 <span class="preprocessor">#endif</span>
<a name="l02040"></a>02040 <span class="preprocessor"></span>
<a name="l02041"></a>02041 <span class="comment">/* debug functions */</span>
<a name="l02042"></a>02042 
<a name="l02043"></a>02043 <span class="comment">/* :nodoc: */</span>
<a name="l02044"></a>02044 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02045"></a><a class="code" href="../../de/de9/vm_8c.html#abd4857d42a372434a12d8a62404e4fa2">02045</a> <a class="code" href="../../de/de9/vm_8c.html#abd4857d42a372434a12d8a62404e4fa2">sdr</a>(<span class="keywordtype">void</span>)
<a name="l02046"></a>02046 {
<a name="l02047"></a>02047     <a class="code" href="../../d8/d32/vm__core_8h.html#af1b67bbf4b72295a772178d0bd939dd0">rb_vm_bugreport</a>();
<a name="l02048"></a>02048     <span class="keywordflow">return</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>;
<a name="l02049"></a>02049 }
<a name="l02050"></a>02050 
<a name="l02051"></a>02051 <span class="comment">/* :nodoc: */</span>
<a name="l02052"></a>02052 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02053"></a><a class="code" href="../../de/de9/vm_8c.html#ac35785c3423751b6c5095da2a99c61f4">02053</a> <a class="code" href="../../de/de9/vm_8c.html#ac35785c3423751b6c5095da2a99c61f4">nsdr</a>(<span class="keywordtype">void</span>)
<a name="l02054"></a>02054 {
<a name="l02055"></a>02055     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> ary = <a class="code" href="../../dc/dcc/array_8c.html#a9518114fd36cb4ef4656ec1dc63348c9">rb_ary_new</a>();
<a name="l02056"></a>02056 <span class="preprocessor">#if HAVE_BACKTRACE</span>
<a name="l02057"></a>02057 <span class="preprocessor"></span><span class="preprocessor">#include &lt;execinfo.h&gt;</span>
<a name="l02058"></a>02058 <span class="preprocessor">#define MAX_NATIVE_TRACE 1024</span>
<a name="l02059"></a>02059 <span class="preprocessor"></span>    <span class="keyword">static</span> <span class="keywordtype">void</span> *trace[MAX_NATIVE_TRACE];
<a name="l02060"></a>02060     <span class="keywordtype">int</span> n = backtrace(trace, MAX_NATIVE_TRACE);
<a name="l02061"></a>02061     <span class="keywordtype">char</span> **syms = backtrace_symbols(trace, n);
<a name="l02062"></a>02062     <span class="keywordtype">int</span> i;
<a name="l02063"></a>02063 
<a name="l02064"></a>02064     <span class="keywordflow">if</span> (syms == 0) {
<a name="l02065"></a>02065         <a class="code" href="../../d8/d16/gc_8c.html#a14b9fe6e6bba3f2279b95af407c546f8">rb_memerror</a>();
<a name="l02066"></a>02066     }
<a name="l02067"></a>02067 
<a name="l02068"></a>02068     <span class="keywordflow">for</span> (i=0; i&lt;n; i++) {
<a name="l02069"></a>02069         <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(ary, <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(syms[i]));
<a name="l02070"></a>02070     }
<a name="l02071"></a>02071     <a class="code" href="../../d1/ddc/dln_8c.html#affb9fc32698fab7f7b36e0cf8e64c83e">free</a>(syms); <span class="comment">/* OK */</span>
<a name="l02072"></a>02072 <span class="preprocessor">#endif</span>
<a name="l02073"></a>02073 <span class="preprocessor"></span>    <span class="keywordflow">return</span> ary;
<a name="l02074"></a>02074 }
<a name="l02075"></a>02075 
<a name="l02076"></a>02076 <span class="keywordtype">void</span>
<a name="l02077"></a><a class="code" href="../../de/de9/vm_8c.html#adab716402e3bca5b8c6664aa102045d8">02077</a> <a class="code" href="../../de/de9/vm_8c.html#adab716402e3bca5b8c6664aa102045d8">Init_VM</a>(<span class="keywordtype">void</span>)
<a name="l02078"></a>02078 {
<a name="l02079"></a>02079     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> opts;
<a name="l02080"></a>02080     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> klass;
<a name="l02081"></a>02081     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> fcore;
<a name="l02082"></a>02082 
<a name="l02083"></a>02083     <span class="comment">/* ::VM */</span>
<a name="l02084"></a>02084     <a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a> = <a class="code" href="../../de/ddf/group__class.html#ga15d068dbe88a3bab3700b03bebb7fbac" title="Defines a top-level class.">rb_define_class</a>(<span class="stringliteral">&quot;RubyVM&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a57c96ead3ef230b4838e65fe037c346e">rb_cObject</a>);
<a name="l02085"></a>02085     <a class="code" href="../../db/d2e/intern_8h.html#ad38ee02dc6ba34e3d05a60bac4a900f8">rb_undef_alloc_func</a>(<a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a>);
<a name="l02086"></a>02086     <a class="code" href="../../d7/d19/group__defmethod.html#ga879be4a71b806afb2854833fc1c45981">rb_undef_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad07df58de9895cbc33c10f02540d2d4d">CLASS_OF</a>(<a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a>), <span class="stringliteral">&quot;new&quot;</span>);
<a name="l02087"></a>02087 
<a name="l02088"></a>02088     <span class="comment">/* ::VM::FrozenCore */</span>
<a name="l02089"></a>02089     fcore = <a class="code" href="../../de/ddf/group__class.html#ga164285b5b5225740d582d4c3773f9179" title="Creates a new class.">rb_class_new</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a56629236cdaf6ddac6d05cd5ae21a2b4">rb_cBasicObject</a>);
<a name="l02090"></a>02090     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a1d4c05021aacd8cab989ff60f95ebe2d">RBASIC</a>(fcore)-&gt;flags = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a82c8c4569748b9645c958b9eaeaabb81">T_ICLASS</a>;
<a name="l02091"></a>02091     klass = <a class="code" href="../../de/ddf/group__class.html#ga3778543a2798adab7bc12ed325c0b5d0" title="Returns the singleton class of obj.">rb_singleton_class</a>(fcore);
<a name="l02092"></a>02092     <a class="code" href="../../d7/d19/group__defmethod.html#gaef65cd1b731ec5c27eedd0e7ea73b6ca">rb_define_method_id</a>(klass, <a class="code" href="../../d5/d11/ripper_8c.html#a91996e87fe152b3c23ada91901134524">id_core_set_method_alias</a>, <a class="code" href="../../de/de9/vm_8c.html#ab5b731afdd8e86459bd5ddbc587c8a1c">m_core_set_method_alias</a>, 3);
<a name="l02093"></a>02093     <a class="code" href="../../d7/d19/group__defmethod.html#gaef65cd1b731ec5c27eedd0e7ea73b6ca">rb_define_method_id</a>(klass, <a class="code" href="../../d5/d11/ripper_8c.html#a6a184f6f82c9e05dd16116cc18d1f8b9">id_core_set_variable_alias</a>, <a class="code" href="../../de/de9/vm_8c.html#aa775eb74347f7cde2375d8c694ff47aa">m_core_set_variable_alias</a>, 2);
<a name="l02094"></a>02094     <a class="code" href="../../d7/d19/group__defmethod.html#gaef65cd1b731ec5c27eedd0e7ea73b6ca">rb_define_method_id</a>(klass, <a class="code" href="../../d5/d11/ripper_8c.html#ab9fb1a3c08f08c168d1512a170d0484c">id_core_undef_method</a>, <a class="code" href="../../de/de9/vm_8c.html#a8a84999770916c4cc41113421fee2233">m_core_undef_method</a>, 2);
<a name="l02095"></a>02095     <a class="code" href="../../d7/d19/group__defmethod.html#gaef65cd1b731ec5c27eedd0e7ea73b6ca">rb_define_method_id</a>(klass, <a class="code" href="../../d5/d11/ripper_8c.html#ac8053973c51f98505f40d32af7b95f5a">id_core_define_method</a>, <a class="code" href="../../de/de9/vm_8c.html#a31455d8d3483e811bf2dfe55220e0a2d">m_core_define_method</a>, 3);
<a name="l02096"></a>02096     <a class="code" href="../../d7/d19/group__defmethod.html#gaef65cd1b731ec5c27eedd0e7ea73b6ca">rb_define_method_id</a>(klass, <a class="code" href="../../d5/d11/ripper_8c.html#ab948c9eee8902650fc1c9e93e45ce936">id_core_define_singleton_method</a>, <a class="code" href="../../de/de9/vm_8c.html#af6daaa3b312cda0a07c1c06b2608d4dc">m_core_define_singleton_method</a>, 3);
<a name="l02097"></a>02097     <a class="code" href="../../d7/d19/group__defmethod.html#gaef65cd1b731ec5c27eedd0e7ea73b6ca">rb_define_method_id</a>(klass, <a class="code" href="../../d5/d11/ripper_8c.html#abb0693b6ab8e95a8e1280ecbb8b9360b">id_core_set_postexe</a>, <a class="code" href="../../de/de9/vm_8c.html#aba01cea003dce480ff70e17597990208">m_core_set_postexe</a>, 1);
<a name="l02098"></a>02098     <a class="code" href="../../db/d2e/intern_8h.html#a8ea3742679211f408cb5769de6cf0d46">rb_obj_freeze</a>(fcore);
<a name="l02099"></a>02099     <a class="code" href="../../d8/d16/gc_8c.html#adc7efe8997f04b5c275d7e7aed9169e3">rb_gc_register_mark_object</a>(fcore);
<a name="l02100"></a>02100     <a class="code" href="../../de/de9/vm_8c.html#a15744aab342112335b9189c8911ba625">rb_mRubyVMFrozenCore</a> = fcore;
<a name="l02101"></a>02101 
<a name="l02102"></a>02102     <span class="comment">/* ::VM::Env */</span>
<a name="l02103"></a>02103     <a class="code" href="../../de/de9/vm_8c.html#ad55204994fe946dcd317061047845c3a">rb_cEnv</a> = <a class="code" href="../../de/ddf/group__class.html#ga5266deadce0318d830a1e63c0933b898" title="Defines a class under the namespace of outer.">rb_define_class_under</a>(<a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a>, <span class="stringliteral">&quot;Env&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a57c96ead3ef230b4838e65fe037c346e">rb_cObject</a>);
<a name="l02104"></a>02104     <a class="code" href="../../db/d2e/intern_8h.html#ad38ee02dc6ba34e3d05a60bac4a900f8">rb_undef_alloc_func</a>(<a class="code" href="../../de/de9/vm_8c.html#ad55204994fe946dcd317061047845c3a">rb_cEnv</a>);
<a name="l02105"></a>02105     <a class="code" href="../../d7/d19/group__defmethod.html#ga879be4a71b806afb2854833fc1c45981">rb_undef_method</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#ad07df58de9895cbc33c10f02540d2d4d">CLASS_OF</a>(<a class="code" href="../../de/de9/vm_8c.html#ad55204994fe946dcd317061047845c3a">rb_cEnv</a>), <span class="stringliteral">&quot;new&quot;</span>);
<a name="l02106"></a>02106 
<a name="l02107"></a>02107     <span class="comment">/* ::Thread */</span>
<a name="l02108"></a>02108     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0d59a418d5956d62076394536ee21dc6">rb_cThread</a> = <a class="code" href="../../de/ddf/group__class.html#ga15d068dbe88a3bab3700b03bebb7fbac" title="Defines a top-level class.">rb_define_class</a>(<span class="stringliteral">&quot;Thread&quot;</span>, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a57c96ead3ef230b4838e65fe037c346e">rb_cObject</a>);
<a name="l02109"></a>02109     <a class="code" href="../../db/d2e/intern_8h.html#ad38ee02dc6ba34e3d05a60bac4a900f8">rb_undef_alloc_func</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0d59a418d5956d62076394536ee21dc6">rb_cThread</a>);
<a name="l02110"></a>02110 
<a name="l02111"></a>02111     <span class="comment">/* ::VM::USAGE_ANALYSIS_* */</span>
<a name="l02112"></a>02112     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a>, <span class="stringliteral">&quot;USAGE_ANALYSIS_INSN&quot;</span>, <a class="code" href="../../d1/d04/hash_8c.html#af1da586524a3a1739fd5b91272037815">rb_hash_new</a>());
<a name="l02113"></a>02113     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a>, <span class="stringliteral">&quot;USAGE_ANALYSIS_REGS&quot;</span>, <a class="code" href="../../d1/d04/hash_8c.html#af1da586524a3a1739fd5b91272037815">rb_hash_new</a>());
<a name="l02114"></a>02114     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a>, <span class="stringliteral">&quot;USAGE_ANALYSIS_INSN_BIGRAM&quot;</span>, <a class="code" href="../../d1/d04/hash_8c.html#af1da586524a3a1739fd5b91272037815">rb_hash_new</a>());
<a name="l02115"></a>02115     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a>, <span class="stringliteral">&quot;OPTS&quot;</span>, opts = <a class="code" href="../../dc/dcc/array_8c.html#a9518114fd36cb4ef4656ec1dc63348c9">rb_ary_new</a>());
<a name="l02116"></a>02116 
<a name="l02117"></a>02117 <span class="preprocessor">#if   OPT_DIRECT_THREADED_CODE</span>
<a name="l02118"></a>02118 <span class="preprocessor"></span>    <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(opts, <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;direct threaded code&quot;</span>));
<a name="l02119"></a>02119 <span class="preprocessor">#elif OPT_TOKEN_THREADED_CODE</span>
<a name="l02120"></a>02120 <span class="preprocessor"></span>    <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(opts, <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;token threaded code&quot;</span>));
<a name="l02121"></a>02121 <span class="preprocessor">#elif OPT_CALL_THREADED_CODE</span>
<a name="l02122"></a>02122 <span class="preprocessor"></span>    <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(opts, <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;call threaded code&quot;</span>));
<a name="l02123"></a>02123 <span class="preprocessor">#endif</span>
<a name="l02124"></a>02124 <span class="preprocessor"></span>
<a name="l02125"></a>02125 <span class="preprocessor">#if OPT_STACK_CACHING</span>
<a name="l02126"></a>02126 <span class="preprocessor"></span>    <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(opts, <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;stack caching&quot;</span>));
<a name="l02127"></a>02127 <span class="preprocessor">#endif</span>
<a name="l02128"></a>02128 <span class="preprocessor"></span><span class="preprocessor">#if OPT_OPERANDS_UNIFICATION</span>
<a name="l02129"></a>02129 <span class="preprocessor"></span>    <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(opts, <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;operands unification]&quot;</span>));
<a name="l02130"></a>02130 <span class="preprocessor">#endif</span>
<a name="l02131"></a>02131 <span class="preprocessor"></span><span class="preprocessor">#if OPT_INSTRUCTIONS_UNIFICATION</span>
<a name="l02132"></a>02132 <span class="preprocessor"></span>    <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(opts, <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;instructions unification&quot;</span>));
<a name="l02133"></a>02133 <span class="preprocessor">#endif</span>
<a name="l02134"></a>02134 <span class="preprocessor"></span><span class="preprocessor">#if OPT_INLINE_METHOD_CACHE</span>
<a name="l02135"></a>02135 <span class="preprocessor"></span>    <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(opts, <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;inline method cache&quot;</span>));
<a name="l02136"></a>02136 <span class="preprocessor">#endif</span>
<a name="l02137"></a>02137 <span class="preprocessor"></span><span class="preprocessor">#if OPT_BLOCKINLINING</span>
<a name="l02138"></a>02138 <span class="preprocessor"></span>    <a class="code" href="../../dc/dcc/array_8c.html#a59d553a8cd781364b8bcb0deae25cca2">rb_ary_push</a>(opts, <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;block inlining&quot;</span>));
<a name="l02139"></a>02139 <span class="preprocessor">#endif</span>
<a name="l02140"></a>02140 <span class="preprocessor"></span>
<a name="l02141"></a>02141     <span class="comment">/* ::VM::InsnNameArray */</span>
<a name="l02142"></a>02142     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a861b20872f7d24f1c5f2da5261037322">rb_define_const</a>(<a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a>, <span class="stringliteral">&quot;INSTRUCTION_NAMES&quot;</span>, <a class="code" href="../../d2/d47/compile_8c.html#a6fbae85d86b443ae82def50a5d3e7254">rb_insns_name_array</a>());
<a name="l02143"></a>02143 
<a name="l02144"></a>02144     <span class="comment">/* debug functions ::VM::SDR(), ::VM::NSDR() */</span>
<a name="l02145"></a>02145 <span class="preprocessor">#if VMDEBUG</span>
<a name="l02146"></a>02146 <span class="preprocessor"></span>    <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a>, <span class="stringliteral">&quot;SDR&quot;</span>, <a class="code" href="../../de/de9/vm_8c.html#abd4857d42a372434a12d8a62404e4fa2">sdr</a>, 0);
<a name="l02147"></a>02147     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a>, <span class="stringliteral">&quot;NSDR&quot;</span>, <a class="code" href="../../de/de9/vm_8c.html#ac35785c3423751b6c5095da2a99c61f4">nsdr</a>, 0);
<a name="l02148"></a>02148 <span class="preprocessor">#else</span>
<a name="l02149"></a>02149 <span class="preprocessor"></span>    (void)<a class="code" href="../../de/de9/vm_8c.html#abd4857d42a372434a12d8a62404e4fa2">sdr</a>;
<a name="l02150"></a>02150     (void)<a class="code" href="../../de/de9/vm_8c.html#ac35785c3423751b6c5095da2a99c61f4">nsdr</a>;
<a name="l02151"></a>02151 <span class="preprocessor">#endif</span>
<a name="l02152"></a>02152 <span class="preprocessor"></span>
<a name="l02153"></a>02153     <span class="comment">/* VM bootstrap: phase 2 */</span>
<a name="l02154"></a>02154     {
<a name="l02155"></a>02155         <a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vm = ruby_current_vm;
<a name="l02156"></a>02156         <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a8deb84ec6023e3229db88ac2c9da6138">GET_THREAD</a>();
<a name="l02157"></a>02157         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> filename = <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;&lt;main&gt;&quot;</span>);
<a name="l02158"></a>02158         <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> iseqval = <a class="code" href="../../dd/d74/iseq_8c.html#a356d85dc4610b2e4f8fdd2c9cede6780">rb_iseq_new</a>(0, filename, filename, <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a320970f989dc8294c8203154e3db40c1">Qnil</a>, 0, ISEQ_TYPE_TOP);
<a name="l02159"></a>02159         <span class="keyword">volatile</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> th_self;
<a name="l02160"></a>02160         <a class="code" href="../../d6/de3/structrb__iseq__struct.html">rb_iseq_t</a> *iseq;
<a name="l02161"></a>02161 
<a name="l02162"></a>02162         <span class="comment">/* create vm object */</span>
<a name="l02163"></a>02163         vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a60a372cceaf16011b6c3d3b6861df36b">self</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa3094c0054b80ec2a7e50f9fe1e5f4b2">TypedData_Wrap_Struct</a>(<a class="code" href="../../de/de9/vm_8c.html#a600dc9ffdba414e21dacfe809c4a9ec8">rb_cRubyVM</a>, &amp;vm_data_type, vm);
<a name="l02164"></a>02164 
<a name="l02165"></a>02165         <span class="comment">/* create main thread */</span>
<a name="l02166"></a>02166         th_self = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a6e712e6c5295a4173188139f1d6b7462">self</a> = <a class="code" href="../../de/de6/ruby_2ruby_8h.html#aa3094c0054b80ec2a7e50f9fe1e5f4b2">TypedData_Wrap_Struct</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a0d59a418d5956d62076394536ee21dc6">rb_cThread</a>, &amp;<a class="code" href="../../de/de9/vm_8c.html#a27ed80c29d1a854ccaa4ae2aa3ef6769">thread_data_type</a>, th);
<a name="l02167"></a>02167         vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a55af19560794b67c09c608a8464e47c9">main_thread</a> = th;
<a name="l02168"></a>02168         vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a469ec56bec5fad54fa6336d5fde24a03">running_thread</a> = th;
<a name="l02169"></a>02169         th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3e7d0b05e2d73f324e70c735ba50739e">vm</a> = vm;
<a name="l02170"></a>02170         th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a63addaa5b39a83e287f7b8747398ab57">top_wrapper</a> = 0;
<a name="l02171"></a>02171         th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#ac0ba34f711c43f831fe95e9a9434353f">top_self</a> = <a class="code" href="../../dd/dd0/eval__intern_8h.html#aa1fe1e87b9459fc45f42b15a0600611a">rb_vm_top_self</a>();
<a name="l02172"></a>02172         <a class="code" href="../../d8/d32/vm__core_8h.html#addad24839d7483095151e91b3b83aed6">rb_thread_set_current</a>(th);
<a name="l02173"></a>02173 
<a name="l02174"></a>02174         vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a09bd6675a9fe3f1b19e36284e91a0e31">living_threads</a> = <a class="code" href="../../dd/d24/st_8h.html#a955c6e936b9681649ab9ffa4aa741949">st_init_numtable</a>();
<a name="l02175"></a>02175         <a class="code" href="../../dd/d24/st_8h.html#acdc42c01229b7537ea5a4c6965c7e47a">st_insert</a>(vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a09bd6675a9fe3f1b19e36284e91a0e31">living_threads</a>, th_self, (<a class="code" href="../../de/dce/syck_8h.html#a8a45dfe133c1fd041e1b902bda9e43e8">st_data_t</a>) th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#acbd5b841dcb2158ed2111abd6b876251">thread_id</a>);
<a name="l02176"></a>02176 
<a name="l02177"></a>02177         <a class="code" href="../../d8/d16/gc_8c.html#adc7efe8997f04b5c275d7e7aed9169e3">rb_gc_register_mark_object</a>(iseqval);
<a name="l02178"></a>02178         <a class="code" href="../../d8/d32/vm__core_8h.html#a5e6a3515e0ad9b9d6a4c0ab577dc50b6">GetISeqPtr</a>(iseqval, iseq);
<a name="l02179"></a>02179         th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a> = iseq;
<a name="l02180"></a>02180         th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a28b0b301811a891225ba9a58c412482d">pc</a> = iseq-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#aa70f3e195a4350acbbc130f8a95c9958">iseq_encoded</a>;
<a name="l02181"></a>02181         th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a2ed7f694d58d876aa6f0fae6986bc921">cfp</a>-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4c11a50358317e1207affd6d7b4ad576">self</a> = th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#ac0ba34f711c43f831fe95e9a9434353f">top_self</a>;
<a name="l02182"></a>02182 
<a name="l02183"></a>02183         <span class="comment">/*</span>
<a name="l02184"></a>02184 <span class="comment">         * The Binding of the top level scope</span>
<a name="l02185"></a>02185 <span class="comment">         */</span>
<a name="l02186"></a>02186         <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a5a25f6effbffe412ebda3391132e7129">rb_define_global_const</a>(<span class="stringliteral">&quot;TOPLEVEL_BINDING&quot;</span>, <a class="code" href="../../db/d2e/intern_8h.html#ae311913aafd9469008cdf681aeae9ed6">rb_binding_new</a>());
<a name="l02187"></a>02187     }
<a name="l02188"></a>02188     <a class="code" href="../../de/de9/vm_8c.html#a891ada54116b1442538ca6fc0e2861b1">vm_init_redefined_flag</a>();
<a name="l02189"></a>02189 }
<a name="l02190"></a>02190 
<a name="l02191"></a>02191 <span class="keywordtype">void</span>
<a name="l02192"></a><a class="code" href="../../de/de9/vm_8c.html#a83ac3f8bc164313d7a1b451f2d2cdabf">02192</a> <a class="code" href="../../dd/dd0/eval__intern_8h.html#a83ac3f8bc164313d7a1b451f2d2cdabf">rb_vm_set_progname</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> filename)
<a name="l02193"></a>02193 {
<a name="l02194"></a>02194     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> *th = <a class="code" href="../../d8/d32/vm__core_8h.html#a6cfcd3997994924c8cd13c3b5c099ec6">GET_VM</a>()-&gt;main_thread;
<a name="l02195"></a>02195     <a class="code" href="../../dd/d84/structrb__control__frame__t.html">rb_control_frame_t</a> *cfp = (<span class="keywordtype">void</span> *)(th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3fd7aab45a1c539bc9ca022acfc1ad51">stack</a> + th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a1587dec1a575fb9f8d6a689ef4fdb6b5">stack_size</a>);
<a name="l02196"></a>02196     --cfp;
<a name="l02197"></a>02197     cfp-&gt;<a class="code" href="../../dd/d84/structrb__control__frame__t.html#a4b25ca925a9f60481173632b9c09d4e0">iseq</a>-&gt;<a class="code" href="../../d6/de3/structrb__iseq__struct.html#a06859fa5de56f2ede3cb692f1d9215e2">filename</a> = filename;
<a name="l02198"></a>02198 }
<a name="l02199"></a>02199 
<a name="l02200"></a>02200 <span class="preprocessor">#if defined(ENABLE_VM_OBJSPACE) &amp;&amp; ENABLE_VM_OBJSPACE</span>
<a name="l02201"></a>02201 <span class="preprocessor"></span><span class="keyword">struct </span><a class="code" href="../../d7/dc0/structrb__objspace.html">rb_objspace</a> *rb_objspace_alloc(<span class="keywordtype">void</span>);
<a name="l02202"></a>02202 <span class="preprocessor">#endif</span>
<a name="l02203"></a>02203 <span class="preprocessor"></span>
<a name="l02204"></a>02204 <span class="keywordtype">void</span>
<a name="l02205"></a><a class="code" href="../../de/de9/vm_8c.html#aebe8178dca87b6a8883017e6921029c2">02205</a> <a class="code" href="../../de/de9/vm_8c.html#aebe8178dca87b6a8883017e6921029c2">Init_BareVM</a>(<span class="keywordtype">void</span>)
<a name="l02206"></a>02206 {
<a name="l02207"></a>02207     <span class="comment">/* VM bootstrap: phase 1 */</span>
<a name="l02208"></a>02208     <a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> * vm = <a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(*vm));
<a name="l02209"></a>02209     <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a> * th = <a class="code" href="../../d5/d11/ripper_8c.html#acf143577800376dd931c059ecc61ba06">malloc</a>(<span class="keyword">sizeof</span>(*th));
<a name="l02210"></a>02210     <span class="keywordflow">if</span> (!vm || !th) {
<a name="l02211"></a>02211         fprintf(stderr, <span class="stringliteral">&quot;[FATAL] failed to allocate memory\n&quot;</span>);
<a name="l02212"></a>02212         exit(<a class="code" href="../../dd/dd0/eval__intern_8h.html#a73efe787c131b385070f25d18b7c9aa4">EXIT_FAILURE</a>);
<a name="l02213"></a>02213     }
<a name="l02214"></a>02214     <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a56d620b94b668ed7665d1616b2c54e48">MEMZERO</a>(th, <a class="code" href="../../d2/d66/structrb__thread__struct.html">rb_thread_t</a>, 1);
<a name="l02215"></a>02215 
<a name="l02216"></a>02216     <a class="code" href="../../d8/d32/vm__core_8h.html#a189286b1d291cc780c5205d00e1b47e6">rb_thread_set_current_raw</a>(th);
<a name="l02217"></a>02217 
<a name="l02218"></a>02218     <a class="code" href="../../de/de9/vm_8c.html#a08ccea748ec0076636c2b4abada44ff0">vm_init2</a>(vm);
<a name="l02219"></a>02219 <span class="preprocessor">#if defined(ENABLE_VM_OBJSPACE) &amp;&amp; ENABLE_VM_OBJSPACE</span>
<a name="l02220"></a>02220 <span class="preprocessor"></span>    vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a9eedda91413032dce6a7053a8f0a449d">objspace</a> = rb_objspace_alloc();
<a name="l02221"></a>02221 <span class="preprocessor">#endif</span>
<a name="l02222"></a>02222 <span class="preprocessor"></span>    ruby_current_vm = vm;
<a name="l02223"></a>02223 
<a name="l02224"></a>02224     <a class="code" href="../../d1/d1c/thread__pthread_8c.html#a1261ad828419468df5d4e92bb75ff6f3">Init_native_thread</a>();
<a name="l02225"></a>02225     <a class="code" href="../../de/de9/vm_8c.html#a8254b2c9550e30be25c3115308865c28">th_init</a>(th, 0);
<a name="l02226"></a>02226     th-&gt;<a class="code" href="../../d2/d66/structrb__thread__struct.html#a3e7d0b05e2d73f324e70c735ba50739e">vm</a> = vm;
<a name="l02227"></a>02227     <a class="code" href="../../d3/de7/thread_8c.html#a20d8df830e19c1e62520540c66aaf3bb">ruby_thread_init_stack</a>(th);
<a name="l02228"></a>02228 }
<a name="l02229"></a>02229 
<a name="l02230"></a>02230 <span class="comment">/* top self */</span>
<a name="l02231"></a>02231 
<a name="l02232"></a>02232 <span class="keyword">static</span> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02233"></a><a class="code" href="../../de/de9/vm_8c.html#a6a5620261a411c4eb4bb08ab9509f706">02233</a> <a class="code" href="../../de/de9/vm_8c.html#a6a5620261a411c4eb4bb08ab9509f706">main_to_s</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> obj)
<a name="l02234"></a>02234 {
<a name="l02235"></a>02235     <span class="keywordflow">return</span> <a class="code" href="../../db/d2e/intern_8h.html#a03acd62c0b1edebbe1d61f957c19b7ac">rb_str_new2</a>(<span class="stringliteral">&quot;main&quot;</span>);
<a name="l02236"></a>02236 }
<a name="l02237"></a>02237 
<a name="l02238"></a>02238 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a>
<a name="l02239"></a><a class="code" href="../../de/de9/vm_8c.html#a5293371c1050a118f49ccf3c073bcfbe">02239</a> <a class="code" href="../../dd/dd0/eval__intern_8h.html#aa1fe1e87b9459fc45f42b15a0600611a">rb_vm_top_self</a>(<span class="keywordtype">void</span>)
<a name="l02240"></a>02240 {
<a name="l02241"></a>02241     <span class="keywordflow">return</span> <a class="code" href="../../d8/d32/vm__core_8h.html#a6cfcd3997994924c8cd13c3b5c099ec6">GET_VM</a>()-&gt;top_self;
<a name="l02242"></a>02242 }
<a name="l02243"></a>02243 
<a name="l02244"></a>02244 <span class="keywordtype">void</span>
<a name="l02245"></a><a class="code" href="../../de/de9/vm_8c.html#a50c13f51eaa186494807612609f95a97">02245</a> <a class="code" href="../../de/de9/vm_8c.html#a50c13f51eaa186494807612609f95a97">Init_top_self</a>(<span class="keywordtype">void</span>)
<a name="l02246"></a>02246 {
<a name="l02247"></a>02247     <a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vm = <a class="code" href="../../d8/d32/vm__core_8h.html#a6cfcd3997994924c8cd13c3b5c099ec6">GET_VM</a>();
<a name="l02248"></a>02248 
<a name="l02249"></a>02249     vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a75e7f2d63af5fc368e6a1de951190f22">top_self</a> = <a class="code" href="../../db/d2e/intern_8h.html#a4419d9ed52af0d0dbdcb02f491b1d88d">rb_obj_alloc</a>(<a class="code" href="../../de/de6/ruby_2ruby_8h.html#a57c96ead3ef230b4838e65fe037c346e">rb_cObject</a>);
<a name="l02250"></a>02250     <a class="code" href="../../d7/d19/group__defmethod.html#gaacfe6a2ec444bdc7f573afb75ea251fe" title="Defines a singleton method for obj.">rb_define_singleton_method</a>(<a class="code" href="../../dd/dd0/eval__intern_8h.html#aa1fe1e87b9459fc45f42b15a0600611a">rb_vm_top_self</a>(), <span class="stringliteral">&quot;to_s&quot;</span>, <a class="code" href="../../de/de9/vm_8c.html#a6a5620261a411c4eb4bb08ab9509f706">main_to_s</a>, 0);
<a name="l02251"></a>02251 
<a name="l02252"></a>02252     <span class="comment">/* initialize mark object array */</span>
<a name="l02253"></a>02253     vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#af4e77414ac91c895a15ae89dad71f143">mark_object_ary</a> = <a class="code" href="../../dc/dcc/array_8c.html#aaf7e3ca42191580b60f398d5ec466766">rb_ary_tmp_new</a>(1);
<a name="l02254"></a>02254 }
<a name="l02255"></a>02255 
<a name="l02256"></a>02256 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *
<a name="l02257"></a><a class="code" href="../../de/de9/vm_8c.html#a5628587c50e8c4ba85eb1f3df1fa19e2">02257</a> <a class="code" href="../../de/de9/vm_8c.html#a5628587c50e8c4ba85eb1f3df1fa19e2">ruby_vm_verbose_ptr</a>(<a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vm)
<a name="l02258"></a>02258 {
<a name="l02259"></a>02259     <span class="keywordflow">return</span> &amp;vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#a4cc71b049515a53a03926b2bfba329e6">verbose</a>;
<a name="l02260"></a>02260 }
<a name="l02261"></a>02261 
<a name="l02262"></a>02262 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *
<a name="l02263"></a><a class="code" href="../../de/de9/vm_8c.html#afbca5a98d211dac56fd4fbad2a382716">02263</a> <a class="code" href="../../de/de9/vm_8c.html#afbca5a98d211dac56fd4fbad2a382716">ruby_vm_debug_ptr</a>(<a class="code" href="../../db/d74/structrb__vm__struct.html">rb_vm_t</a> *vm)
<a name="l02264"></a>02264 {
<a name="l02265"></a>02265     <span class="keywordflow">return</span> &amp;vm-&gt;<a class="code" href="../../db/d74/structrb__vm__struct.html#aa4d70f7ac782e2587683d28c1a99d6ea">debug</a>;
<a name="l02266"></a>02266 }
<a name="l02267"></a>02267 
<a name="l02268"></a>02268 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *
<a name="l02269"></a><a class="code" href="../../de/de9/vm_8c.html#adcdfac9f41b5eac1f4f89a647d2ff5b8">02269</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#adcdfac9f41b5eac1f4f89a647d2ff5b8">rb_ruby_verbose_ptr</a>(<span class="keywordtype">void</span>)
<a name="l02270"></a>02270 {
<a name="l02271"></a>02271     <span class="keywordflow">return</span> <a class="code" href="../../de/de9/vm_8c.html#a5628587c50e8c4ba85eb1f3df1fa19e2">ruby_vm_verbose_ptr</a>(<a class="code" href="../../d8/d32/vm__core_8h.html#a6cfcd3997994924c8cd13c3b5c099ec6">GET_VM</a>());
<a name="l02272"></a>02272 }
<a name="l02273"></a>02273 
<a name="l02274"></a>02274 <a class="code" href="../../de/de6/ruby_2ruby_8h.html#a3c1d4bfc6a81af60bdcb48744c35f760">VALUE</a> *
<a name="l02275"></a><a class="code" href="../../de/de9/vm_8c.html#ab9b0b6052e278894c13547d5eae29553">02275</a> <a class="code" href="../../de/de6/ruby_2ruby_8h.html#ab9b0b6052e278894c13547d5eae29553">rb_ruby_debug_ptr</a>(<span class="keywordtype">void</span>)
<a name="l02276"></a>02276 {
<a name="l02277"></a>02277     <span class="keywordflow">return</span> <a class="code" href="../../de/de9/vm_8c.html#afbca5a98d211dac56fd4fbad2a382716">ruby_vm_debug_ptr</a>(<a class="code" href="../../d8/d32/vm__core_8h.html#a6cfcd3997994924c8cd13c3b5c099ec6">GET_VM</a>());
<a name="l02278"></a>02278 }
<a name="l02279"></a>02279 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 1 Mar 2013 for Ruby by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
